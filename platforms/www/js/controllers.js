angular.module('citymobi.controllers', [])

  .controller('deptComponentCtrl',function($scope, $rootScope,  $ionicHistory, $compile, $stateParams, $timeout, $location, $ionicPlatform, $deptComponentSer, $ionicScrollDelegate){
    $scope.isShow = false;
    $scope.iIndex = null;

    $scope.search_control = {
      search_val : ''
    };

    var routerPageConfig = {
      'default' : 'deptComponentCtrlDefault',
      'message' : 'deptComponentCtrlMessage',
      'at' : 'deptComponentCtrlAt',
      'sign' : 'deptComponentCtrlSign',
      'person' : 'deptComponentCtrlPerson'
    }


    $scope.historyBar = $deptComponentSer.getHistoryBar();
    $scope.opt = $deptComponentSer.getOpt();


    $scope.ii = new Date().getTime();

    $scope.opt.isAllSelect = true;


    $scope.iconX_nav = null;

    $scope.iconX_nav_style = {
      width : "1000px",
      height : "50px"
    }

    $scope.resizeIonContent = function() {
                    if ($scope.iconX_nav) {
                        $scope.iconX_nav.resize();
                    } else {
                        for (var i in $ionicScrollDelegate._instances) {
                            if ($ionicScrollDelegate._instances[i].$$delegateHandle == "x_nav") {
                                $scope.iconX_nav = $ionicScrollDelegate._instances[i];
                            }
                        }

                        if ($scope.iconX_nav) {

                            $scope.iconX_nav.resize();
                        }
                    }
    };


    $scope.$on("$ionicView.afterEnter", function(event, data){

      $scope.activeObj = $deptComponentSer.getActiveNumber();
      $rootScope.showLoading();

      //控制navbar
      $timeout(function () {
        $("[nav-bar='active'] .title.title-center.header-item").css({
          left : '35px',
          right : '35px'
        })
      },50);

      var mtWdith = 0;

      var addNum = 30;

      $timeout(function(){
        var el_List = $('ion-content[i="'+$scope.ii+'"] .mobile_tree_title_x div');
        el_List.each(function(i,e){
          mtWdith+=$(e).width();
        })
        $('ion-content[i="'+$scope.ii+'"] .mobile_tree_title_x').css({
          width : mtWdith+addNum,
          height : 50
        });

        // $$delegateHandle
         $scope.resizeIonContent();

        if((mtWdith+addNum)>$(document.body).width()){
            var l = (mtWdith+addNum)-$(document.body).width();
            $ionicScrollDelegate.$getByHandle('x_nav').scrollTo(l,0,true);
          }
      },0);



      if(!$scope.opt.isLoadDataSucceed){
      //是否已经把数据完全加载回来：未加载

      var promise = $deptComponentSer.postData();

      promise.then(function(greeting) {
        $scope.isShow = true;
        //获取数据
        $scope.iIndex = $stateParams.pid;
        $scope.sd = $deptComponentSer.getData();



        $timeout(function () {
          $rootScope.hideLoading();
          $ionicScrollDelegate.resize();

          $scope.opt.isLoadDataSucceed = true;
        },800);
      }, function(reason) {
        $rootScope.hideLoading();
      });
    }else{
      //已加载


      $timeout(function(){
        $scope.isShow = true;
        $scope.iIndex = $stateParams.pid;
        $scope.sd = $deptComponentSer.getData();

        $timeout(function () {
          $rootScope.hideLoading();
          $ionicScrollDelegate.resize();
        },800);

      },700);


    }
    });

    $scope.allSelect = function(){

      if($scope.search_control.search_val && $scope.search_control.search_val.length){

        if($scope.opt.isAllSelect){
          $scope.opt.isAllSelect = !$scope.opt.isAllSelect;
          var i_arr = [];
          for(var i = 0,len = $scope.sd[$scope.iIndex].length;i < len;i++){
            if($scope.sd[$scope.iIndex][i].name.indexOf($scope.search_control.search_val) >= 0){
              i_arr[i_arr.length] = $scope.sd[$scope.iIndex][i];
            }
          }

          for(var i = 0,len = i_arr.length;i<len;i++){
            if(!i_arr[i].checked){
              i_arr[i].checked = true;
              $deptComponentSer.updateActive(i_arr[i].id, true, i_arr[i]);
            }

            if($scope.opt.isInherit && i_arr[i].children && i_arr[i].children.length){
              $scope.selectRecursion(i_arr[i].children)
            }
          }

          // //全选过滤
          // if($scope.opt.isInherit){
          //     $scope.selectRecursion(i_arr);
          // }
        }else{
          $scope.opt.isAllSelect = !$scope.opt.isAllSelect;
          var i_arr = [];
          for(var i = 0,len = $scope.sd[$scope.iIndex].length;i < len;i++){
            if($scope.sd[$scope.iIndex][i].name.indexOf($scope.search_control.search_val) >= 0){
              i_arr[i_arr.length] = $scope.sd[$scope.iIndex][i];
            }
          }

          for(var i = 0,len = i_arr.length;i<len;i++){
            if(i_arr[i].checked){
              i_arr[i].checked = false;
              $deptComponentSer.updateActive(i_arr[i].id, false, i_arr[i]);
            }

            if($scope.opt.isInherit && i_arr[i].children && i_arr[i].children.length){
              $scope.cancelRecursion(i_arr[i].children)
            }
          }
        }


      }else{

        if($scope.opt.isAllSelect){
          $scope.opt.isAllSelect = !$scope.opt.isAllSelect;
          for(var i = 0,len = $scope.sd[$scope.iIndex].length;i < len;i++){
            if(!$scope.sd[$scope.iIndex][i].checked){
              $scope.sd[$scope.iIndex][i].checked = true;
              $deptComponentSer.updateActive($scope.sd[$scope.iIndex][i].id, true, $scope.sd[$scope.iIndex][i]);
            }

            if($scope.opt.isInherit && $scope.sd[$scope.iIndex][i].children && $scope.sd[$scope.iIndex][i].children.length){

              $scope.selectRecursion($scope.sd[$scope.iIndex][i].children);
            }
          }
        }else{
          $scope.opt.isAllSelect = !$scope.opt.isAllSelect;
          for(var i = 0,len = $scope.sd[$scope.iIndex].length;i < len;i++){
            if($scope.sd[$scope.iIndex][i].checked){
              $scope.sd[$scope.iIndex][i].checked = false;
              $deptComponentSer.updateActive($scope.sd[$scope.iIndex][i].id, false, $scope.sd[$scope.iIndex][i]);
            }

            if($scope.opt.isInherit && $scope.sd[$scope.iIndex][i].children && $scope.sd[$scope.iIndex][i].children.length){

              $scope.cancelRecursion($scope.sd[$scope.iIndex][i].children);
            }
          }

        }

      }
    };

    $scope.selectRecursion = function(d){
      for(var i = 0,len = d.length;i<len;i++){
        if(!d[i].checked){
          d[i].checked = true;
          $deptComponentSer.updateActive(d[i].id, true, d[i]);
        }
        if(d[i].children && d[i].children.length){
          $scope.selectRecursion(d[i].children)
        }
      }
    }

    $scope.cancelRecursion = function(d){
      for(var i = 0,len = d.length;i<len;i++){
        if(d[i].checked){
          d[i].checked = false;
          $deptComponentSer.updateActive(d[i].id, false, d[i]);
        }
        if(d[i].children && d[i].children.length){
          $scope.cancelRecursion(d[i].children)
        }
      }
    }

     $scope.back = function () {

      if($scope.historyBar.length == 1){
        //如果在rootView 即需要清楚数据
        $deptComponentSer.clearActivePersonnel();
      }

      $deptComponentSer.popBar();
      $ionicHistory.goBack();
    };

    $scope.goBack = function (i) {

      if(($scope.historyBar.length - 1) == i){
        console.log('当前位置');
        return;
      }


      $timeout(function () {
        var stepNum = $scope.historyBar.length - 1 - i;
        $deptComponentSer.goBackBar(i+1);
        var backStepNum = 0-stepNum;
        $ionicHistory.goBack(backStepNum);
      },0)

    };

    $scope.sure = function () {

      //回调返回数据
      $deptComponentSer.callback();

      //是否保存常用联系人
      if($scope.opt.isShowContact && $scope.opt.isNeedSaveContact){

      }else{
        // console.log('不保存常用联系人');
      }

      //返回到入口,清除数据
      $deptComponentSer.goBackBar(0);
      $ionicHistory.goBack(-$scope.historyBar.length);

    };

    $ionicPlatform.onHardwareBackButton($scope.back);


    $scope.$on("$ionicView.beforeLeave", function(event, data){

        $ionicPlatform.offHardwareBackButton($scope.back);

    });


    $scope.selectOption = function (item) {

      if($scope.opt.isSingleSelect){
        //单选
        if(item.checked){
          $deptComponentSer.callback(item);
          $deptComponentSer.goBackBar(0);
          $ionicHistory.goBack(-$scope.historyBar.length);
        }


      }else{
        //多选

        var id = item.id,
          state = item.checked;

        $deptComponentSer.updateActive(id, state, item);

        if(item.children && item.children.length && $scope.opt.isInherit){
          if(item.checked){
            $scope.selectRecursion(item.children);
          }else{
            $scope.cancelRecursion(item.children);
          }
        }
      }

    };

    $scope.isTriggerJump = false;



    $scope.openSubClass = function (item, i) {

      if(item.children && item.children.length){

      	if(!$scope.isTriggerJump){
	        $scope.isTriggerJump = true;

	        var num = parseInt($stateParams.pid) + 1;
	        //    /emplComponentCtrl/1
	        // $deptComponentSer.pushBar(name, id);
	        $scope.sd[num] = $scope.sd[$stateParams.pid][item.iIndex].children;
	        $deptComponentSer.pushBar(item.name, item.id);
          $timeout(function(){
	         $location.path('home_page/'+ routerPageConfig[$scope.opt.routerName] +'/'+num);
          },150);
	        $timeout(function(){
	          $scope.isTriggerJump = false;
	        },350);
	      }


      }else{
        if($scope.opt.isSingleSelect){
          //单选
          item.checked = !item.checked;

          if(item.checked){
            $deptComponentSer.callback(item);
            $deptComponentSer.goBackBar(0);
            $ionicHistory.goBack(-$scope.historyBar.length);
          }


        }else{
          //多选
          item.checked = !item.checked;

          var id = item.id,
            state = item.checked;

          $deptComponentSer.updateActive(id, state, item);

          if(item.children && item.children.length && $scope.opt.isInherit){
            if(item.checked){
              $scope.selectRecursion(item.children);
            }else{
              $scope.cancelRecursion(item.children);
            }
          }

          // $timeout(function(){
          //   console.log($deptComponentSer.getOData());
          //     debugger;

          // },3000);
        }
      }

    };

    if($('body').hasClass('searchInputState')){
      $('body').removeClass('searchInputState');
    }

    $scope.toggleSearch = function () {
      $scope.searchState = !$scope.searchState;
      if($scope.searchState){
        $('body').addClass('searchInputState');

      }else{
        $('body').removeClass('searchInputState');
      }
    }

    if($stateParams.isSearch == 'true'){
      if($('body').hasClass('hideSearchBtn')){
        $('body').removeClass('hideSearchBtn');
      }
      $scope.searchState = false;
    }else{

      if(!$('body').hasClass('hideSearchBtn')){
        $('body').addClass('hideSearchBtn');
      }
    }
  })
  .controller('emplComponentCtrl',function($scope, $rootScope,  $ionicHistory, $compile, $stateParams, $timeout, $location, $ionicPlatform, $emplComponentService, $ionicScrollDelegate, $emplSearchComponent){
    $scope.isShow = false;
    $scope.icon_src = local_resource+'img/emp_section_icon.png';
    $scope.search_control = {
      search_val : ''
    };
    // console.log($stateParams); 获取pid

    var routerPageConfig = {
      'default' : 'emplComponentCtrlDefault',
      'message' : 'emplComponentCtrlMessage',
      'at' : 'emplComponentCtrlAt',
      'sign' : 'emplComponentCtrlSign',
      'person' : 'emplComponentCtrlPerson'
    }


    $scope.opt = $emplComponentService.getOpt();
    $scope.historyBar = $emplComponentService.getHistoryBar();

    $scope.ii = new Date().getTime();

    // $scope.renderFinish = function(){

    // };

    $scope.$on("$ionicView.afterEnter", function(event, data){

      $scope.activeObj = $emplComponentService.getActiveNumber();
      $rootScope.showLoading();

      //控制navbar
      $timeout(function () {
        $("[nav-bar='active'] .title.title-center.header-item").css({
          left : '35px',
          right : '35px'
        })
      },50);
      // console.log($('ion-content[i="'+$scope.ii+'"] .mobile_tree_title_x div'));

      var mtWdith = 0;
      var el_List = $('ion-content[i="'+$scope.ii+'"] .mobile_tree_title_x div');
      var el_width_arr = [];
      // el_List.each(function(i,e){
      //   el_width_arr.push($(e).width());
      // })

      // el_List = el_List.slice(el_List.length-$scope.historyBar.length,el_List.length);
      // el_width_arr = el_width_arr.slice(el_List.length-$scope.historyBar.length,el_List.length);

      // el_List.each(function(i,e){
      //   // alert($(e).width());
      //   mtWdith+=$(e).width();
      // });

      $timeout(function(){
        el_List.each(function(i,e){
          mtWdith+=$(e).width();
        });
        $('ion-content[i="'+$scope.ii+'"] .mobile_tree_title_x').width(mtWdith+12+'px');

        if((mtWdith+12)>$(document.body).width()){
          var l = (mtWdith+12)-$(document.body).width();
          $ionicScrollDelegate.$getByHandle('x_nav').scrollTo(l,0,true);
        }

      },0);
      // $(el_width_arr).each(function(i, e) {
      //        mtWdith+=e;
      //   });



      //加载数据
      var promise = $emplComponentService.postData();

      promise.then(function(greeting) {
        $scope.isShow = true;
        //获取数据
        $scope.sd = $emplComponentService.getData();


        var outTime = 0;

        if($scope.historyBar.length == 1){
  			outTime = 1200;
        }else{
        	outTime = 700;
        }

        $timeout(function () {
          $rootScope.hideLoading();
          $ionicScrollDelegate.resize();

        },outTime);
      }, function(reason) {
        $rootScope.hideLoading();
      });
    });

    $scope.del_contact = function(i,empl_no){
      $scope.sd.contact_list.splice(i,1);
      $.ajax({
        type: "GET",
        url: window.localStorage['_remote_server_addr'] + '?event=ionicAction.ionicAction.deleteEmplCompContact&_dc='+new Date().getTime(),
        timeout: _var_timeout,
        data:{
          delete_employee_no:empl_no
        },
        success: function(_data) {
        },
        error: function(data) {
        }
      });
      $ionicScrollDelegate.resize();
    }

    $scope.back = function () {

      if($scope.historyBar.length == 1){
        //如果在rootView 即需要清楚数据
        $emplComponentService.clearActivePersonnel();
      }

      $emplComponentService.popBar();
      $ionicHistory.goBack();
    };

    $scope.goBack = function (i) {

      if(($scope.historyBar.length - 1) == i){
        console.log('当前位置');
        return;
      }


      $timeout(function () {
        var stepNum = $scope.historyBar.length - 1 - i;
        $emplComponentService.goBackBar(i+1);
        var backStepNum = 0-stepNum;
        $ionicHistory.goBack(backStepNum);
      },0)

    };

    $scope.sure = function () {

      //回调返回数据
      $emplComponentService.callback();

      //是否保存常用联系人
      if($scope.opt.isShowContact && $scope.opt.isNeedSaveContact){

      }else{
        // console.log('不保存常用联系人');
      }

      //返回到入口,清除数据
      $emplComponentService.goBackBar(0);
      $ionicHistory.goBack(-$scope.historyBar.length);

    };



    $ionicPlatform.onHardwareBackButton($scope.back);


    $scope.$on("$ionicView.beforeLeave", function(event, data){

        $ionicPlatform.offHardwareBackButton($scope.back);

    });


    $scope.selectOption = function (item, isContact, isA) {
      if(isA){
        item.checked = !item.checked;
      }

      if($scope.opt.isSingleSelect){
        //单选

        if(item.checked){
          $emplComponentService.callback(item);
          $emplComponentService.goBackBar(0);
          $ionicHistory.goBack(-$scope.historyBar.length);
        }

      }else{
        //多选

        var id = item.empl_no,
          state = item.checked;

        if(isContact){
          if($scope.sd.empl_list && $scope.sd.empl_list.length){
            for(var i = 0,len = $scope.sd.empl_list.length;i<len;i++){
              if($scope.sd.empl_list[i].empl_no == id && $scope.sd.empl_list[i].checked != state){
                $scope.sd.empl_list[i].checked = state;
                break;
              }
            }
          }
        }else{
          if($scope.sd.contact_list && $scope.sd.contact_list.length){
            for(var i = 0,len = $scope.sd.contact_list.length;i<len;i++){
              if($scope.sd.contact_list[i].empl_no == id && $scope.sd.contact_list[i].checked != state){
                $scope.sd.contact_list[i].checked = state;
                break;
              }
            }
          }
        }

        $emplComponentService.updateActive(id, state, item);
      }

    };

    $scope.stopPropagation = function (ev) {
      ev.stopPropagation();
    }

    $scope.isTriggerJump = false;

    $scope.openSubClass = function (id, name) {

      // $ionicHistory.clearCache().then(function(){
      //     $emplComponentService.pushBar(name, id);
      //     $location.path('home_page/'+ routerPageConfig[$scope.opt.routerName] +'/'+id);
      // });

      if(!$scope.isTriggerJump){
        $scope.isTriggerJump = true;
        //    /emplComponentCtrl/1
        $emplComponentService.pushBar(name, id);
        // $emplComponentService.addBar(name, id);
        $location.path('home_page/'+ routerPageConfig[$scope.opt.routerName] +'/'+id);
        $timeout(function(){
          $scope.isTriggerJump = false;
        },200);
      }
    };

    if($('body').hasClass('searchInputState')){
      $('body').removeClass('searchInputState');
    }

    $scope.openSearch = function () {
      if($scope.opt.isSearch){


        emplSearchModal = $emplSearchComponent.init({
          isSingleSelect:$scope.opt.isSingleSelect, //单选模式
          extName:$scope.opt.extName, //选中tips
          hideCallback : function(){

          		$ionicPlatform.onHardwareBackButton($scope.back);
          },
          sure : function (selectData) {


            $timeout(function () {



              if($scope.sd.empl_list && $scope.sd.empl_list.length){
                angular.forEach($scope.sd.empl_list, function(data,index,array){
                  if($scope.activeObj[data.empl_no]){

                    data.checked = true;
                  }else{
                    data.checked = false;
                  }

                });
              }

              if($scope.sd.empl_list && $scope.sd.contact_list.length){
                angular.forEach($scope.sd.contact_list, function(data,index,array){
                  if($scope.activeObj[data.empl_no]){

                    data.checked = true;
                  }else{
                    data.checked = false;
                  }
                });
              }
            },0);
          }
        });

        $ionicPlatform.offHardwareBackButton($scope.back);
        emplSearchModal.show();
      }
    }

    $scope.toggleSearch = function () {
      // $scope.searchState = !$scope.searchState;
      // if($scope.searchState){
      //   $('body').addClass('searchInputState');
      //
      // }else{
      //   $('body').removeClass('searchInputState');
      // }
    }

    // if($stateParams.isSearch == 'true'){
    //   if($('body').hasClass('hideSearchBtn')){
    //     $('body').removeClass('hideSearchBtn');
    //   }
    //   $scope.searchState = false;
    // }else{
    //
    //   if(!$('body').hasClass('hideSearchBtn')){
    //     $('body').addClass('hideSearchBtn');
    //   }
    // }


  })

  .controller('homePageCtrl',function($scope,homemessageSev,regIdxService,$ionicHistory,$location){
	  $scope.img_home = local_resource + 'img/menus/home.png';
	  $scope.img_home_active = local_resource + 'img/menus/home-active.png';
	  $scope.img_at = local_resource + 'img/menus/at.png';
	  $scope.img_at_active = local_resource + 'img/menus/at-active.png';
	  $scope.img_salary = local_resource + 'img/menus/salary.png';
	  $scope.img_salary_active = local_resource + 'img/menus/salary-active.png';
	  $scope.img_personal = local_resource + 'img/menus/personal.png';
	  $scope.img_personal_active = local_resource + 'img/menus/personal-active.png';
	  $scope.img_at_sign_in_active = local_resource + 'img/menus/at_sign_in_active.png';
	  $scope.img_at_sign_in_normal = local_resource + 'img/menus/at_sign_in_normal.png';
    $scope.img_message_on= local_resource + 'img/menus/message_on.png';
    $scope.img_message_off=local_resource + 'img/menus/message_off.png';
    //homemessageSev.loadMessageCount();
    $scope.home_message_count = homemessageSev.getMessageCount();

	$scope.redirect_tab = function(tab){

		/*
		$location.path(tab);
		*/

		$ionicHistory.clearCache().then(function(){
			$location.path(tab);
		});


	}
  })

  .controller('registerIndex',function($scope,regIdxService){
        regIdxService.loadData();
        $scope.reg_index_ck = regIdxService.regIndexAll();
        $scope.saveIndex = function(){
        regIdxService.saveIndex();
        }
  })
  .controller('registerAl',function($scope,regAlService){
        regAlService.loadData();
        $scope.al_setting_data = regAlService.getAlSettingData();
        $scope.saveRegAl = function(){
          regAlService.saveRegAl();
        }
        $scope.addAlRuleItem = function(){
            var al_rule_setting =  $scope.al_setting_data['al_rule_setting'];
            var length =al_rule_setting.length;
            var _val;
            if(length==0){_val=1}else{_val = al_rule_setting[length-1].to};
            $scope.al_setting_data['al_rule_setting'].push({
                'from':_val,
                'to':'',
                'days':''
            })
        }
        $scope.deleteAlRuleItem = function(item){
            var idx = $scope.al_setting_data['al_rule_setting'].indexOf(item);
            $scope.al_setting_data['al_rule_setting'].splice(idx,1);
        }
  })
  .controller('registerAt1',function($scope,regAt1Service){
        regAt1Service.loadData();
        $scope.reg_at1_data = regAt1Service.getAt1SettingData();
        $scope.saveRegAt1 = function (){
            regAt1Service.saveRegAt1();
        }
  })
  .controller('registerAt2',function($scope,regAt2Service){
        regAt2Service.loadData();
        $scope.reg_at2_data = regAt2Service.getAt2SettingData();
        $scope.saveRegAt2 = function(){
            regAt2Service.saveRegAt2();
        }
  })
  .controller('loginHomeNavigationCtrl',function($scope,$ionicHistory,$ionicViewSwitcher,$location,$ionicModal,userLoginService){
    //alert(document.getElementById("login_home_navigation_bot_div"))
    $scope.css_vertical=(document.body.scrollHeight -100-350)/2+"px";

    //$scope.$on("$ionicView.enter", function () {
    //
    //  //alert(document.body.scrollHeight   );
    //  //alert(document.getElementById("login_home_navigation_bot_div").offsetHeight);
    //  document.getElementById("login_home_navigation_mar_top").style.height=(document.body.scrollHeight -document.getElementById("login_home_navigation_bot_div").offsetHeight-350)/2+"px";
    //  document.getElementById("login_home_navigation_bot_div").style.marginTop=(document.body.scrollHeight -document.getElementById("login_home_navigation_bot_div").offsetHeight-350)/2+"px";
    //})



    $scope.icon_forward=local_resource+'img/icon/icon_forward.png';
    $scope.icon_company_name=local_resource+'img/icon/icon_company_name.png';
    $scope.icon_user=local_resource+'img/icon/icon_user.png';
    $scope.freeExpr = userLoginService.getFreeData();
    clearInterval(fufu_register_timeout);
    $scope.freeExpr.cmp_name=window.localStorage['free_trial_cmp_name'] ;
    $scope.freeExpr.cmp_contact=window.localStorage['free_trial_cmp_contact'] ;
    $scope.freeExpr.tel_no=window.localStorage['free_trial_tel_no'] ;
    $scope.freeExpr.valid_code=window.localStorage['free_trial_valid_code'] ;
    $ionicViewSwitcher.nextDirection('back');
	$scope.navigate_login = function(){
        $ionicViewSwitcher.nextDirection('forward');
        $location.path("/")
	}
    $ionicModal.fromTemplateUrl('free_experience_account.html', {
      scope: $scope,
      animation: 'slide-in-up'
    }).then(function(modal) {
      $scope.free_modal = modal;

    });
    $scope.closeFreeModal = function() {
      $scope.free_modal.hide();
    };
    $scope.sendPwdVCode = function(){
      userLoginService.sendPwdVCode();
    }
    $scope.free_experience_account=function(){
      $scope.free_modal.show()
    }
    $scope.demoLogin = function(){
      userLoginService.demoLogin($scope.free_modal);
    }
    $scope.comp_reg=function(){
      $location.path('comp_reg')
    }
    $scope.swiperData = [
      {imgUrl:local_resource+'img/register/navigation_banner_new_1.png', locationUrl:'',title:'互联网打卡',text:'无论身处何地，打卡随心所欲'},
      {imgUrl:local_resource+'img/register/navigation_banner_new_2.png', locationUrl:'',title:'薪资管理',text:'薪酬计算、工资单发放，既便捷又安全'},
      {imgUrl:local_resource+'img/register/navigation_banner_new_3.png', locationUrl:'',title:'补签卡',text:'解决手脱皮、卡钟坏、忘打卡等各种状况'},
      {imgUrl:local_resource+'img/register/navigation_banner_new_4.png', locationUrl:'',title:'查看状态',text:'叮咚，您收到一条待办消息哟～'},
      {imgUrl:local_resource+'img/register/navigation_banner_new_5.png', locationUrl:'',title:'小秘书',text:'点我你就都懂了'}
    ];



  })

  .controller('compRegCtrl',function($scope,$ionicHistory,$ionicViewSwitcher,$location,$ionicModal,userLoginService,$ionicPopup,compRegSev){
 var ionNavBarHeight = (ionic.Platform.platform() == 'ios')?'64':'44';

    $scope.$on('$ionicView.beforeEnter', function() {
      //进入之前
      $('ion-view[nav-view="active"] ion-content').css('top','0');
      $('ion-nav-bar').css('display','none');


      var imitateBarStr = (ionic.Platform.platform() == 'ios')?
                '<div class="imitateBar" style="position: absolute;top: 0;left: 0; right: 0; height: '+ionNavBarHeight+'px; background: #53afff; background-image: linear-gradient(0deg,#ddd,#ddd 50%,transparent 50%); background-position: bottom; background-size: 100% 1px; background-repeat: no-repeat;"><div style="width: auto; height: 44px; margin-left:10px; margin-right: 10px; margin-top: 20px; line-height: 44px; position: relative; text-align: center;text-overflow: ellipsis;white-space: nowrap;font-size: 17px;font-weight: 500; color: white"><button class="button back-button buttons button-clear button-light button-icon ion-ios-arrow-left header-item" style="position: absolute;top: 1px; left: -4px;font-size: 24px"><span class="back-text" style="transform: translate3d(0px, 0px, 0px);font-size: 24px"></span></button>注册新企业</div></div>'
                  :
                '<div class="imitateBar" style="position: absolute;top: 0;left: 0; right: 0; height: '+ionNavBarHeight+'px; background: #53afff; background-image: linear-gradient(0deg,#ddd,#ddd 50%,transparent 50%); background-position: bottom; background-size: 100% 1px; background-repeat: no-repeat;"><div style="width: auto; height: 44px;  margin-left:10px; margin-right: 10px; line-height: 44px; position: relative; text-align: center;text-overflow: ellipsis;white-space: nowrap;font-size: 19px;font-weight: 500; color: white"><button class="button back-button buttons button-clear button-light button-icon ion-ios-arrow-left header-item" style="position: absolute;top: 1px; left: -4px;font-size: 24px"><span class="back-text" style="transform: translate3d(0px, 0px, 0px);font-size: 24px"></span></button>注册新企业</div></div>';

      $('ion-view[nav-view!="active"]').append(imitateBarStr);
      $('ion-view[nav-view!="active"] ion-content').css('top',ionNavBarHeight+'px');
      // debugger;
    });
    $scope.$on('$ionicView.afterEnter', function(){
      //进入之后
      $('ion-nav-bar').css('display','');
      $('.imitateBar').remove();
      $('ion-view[title="注册新企业"] ion-content').css('top','');
      // debugger;
    });
    $scope.$on('$ionicView.beforeLeave', function(){
      //离开之前
      $('ion-view[title="注册新企业"] ion-content').css('top',ionNavBarHeight+'px');
      var imitateBarStr = (ionic.Platform.platform() == 'ios')?
                '<div class="imitateBar" style="position: absolute;top: 0;left: 0; right: 0; height: '+ionNavBarHeight+'px; background: #53afff; background-image: linear-gradient(0deg,#ddd,#ddd 50%,transparent 50%); background-position: bottom; background-size: 100% 1px; background-repeat: no-repeat;"><div style="width: auto; height: 44px; margin-left:10px; margin-right: 10px; margin-top: 20px; line-height: 44px; position: relative; text-align: center;text-overflow: ellipsis;white-space: nowrap;font-size: 17px;font-weight: 500; color: white"><button class="button back-button buttons button-clear button-light button-icon ion-ios-arrow-left header-item" style="position: absolute;top: 1px; left: -4px;font-size: 24px"><span class="back-text" style="transform: translate3d(0px, 0px, 0px);font-size: 24px"></span></button>注册新企业</div></div>'
                  :
                '<div class="imitateBar" style="position: absolute;top: 0;left: 0; right: 0; height: '+ionNavBarHeight+'px; background: #53afff; background-image: linear-gradient(0deg,#ddd,#ddd 50%,transparent 50%); background-position: bottom; background-size: 100% 1px; background-repeat: no-repeat;"><div style="width: auto; height: 44px;  margin-left:10px; margin-right: 10px; line-height: 44px; position: relative; text-align: center;text-overflow: ellipsis;white-space: nowrap;font-size: 19px;font-weight: 500; color: white"><button class="button back-button buttons button-clear button-light button-icon ion-ios-arrow-left header-item" style="position: absolute;top: 1px; left: -4px;font-size: 24px"><span class="back-text" style="transform: translate3d(0px, 0px, 0px);font-size: 24px"></span></button>注册新企业</div></div>';

      $('ion-view[nav-view="active"]').append(imitateBarStr);

      // debugger;
    });
    $scope.$on('$ionicView.afterLeave', function(){
      //离开之后
      // debugger;
      $('.imitateBar').remove();
    });


	$scope.icon_forward=local_resource+'img/icon/icon_forward.png';
    $scope.icon_company_name=local_resource+'img/icon/icon_company_name.png';
    $scope.icon_user=local_resource+'img/icon/icon_user.png';
    $scope.regModel = compRegSev.getRegModel();
    $scope.freeExpr = compRegSev.getFreeData();
    clearInterval(fufu_register_timeout);
    $scope.getValidCode=function(){
      compRegSev.getValidCode();
    }
    $scope.path_log=function(){
      $location.path("/")
    }

    var reg = /^1[3|4|5|7|8]\d{9}$/;
	//alert(document.getElementById("forget_tel_no").value)


	$scope.$on("$ionicView.enter", function () {
      if (!reg.test(document.getElementById("forget_tel_no").value)){
    document.getElementById("reg_valid_vcode").style.opacity='0.5';
    }
    else{
    document.getElementById("reg_valid_vcode").style.opacity='1';
    }
      if(document.getElementById("forget_valid_code").value!='' && document.getElementById("forget_tel_no").value!=''){
        document.getElementById("_find_pwd_action").style.opacity='1';
      }
      else{
        document.getElementById("_find_pwd_action").style.opacity='0.5';
      }
      });

    document.getElementById("forget_tel_no").oninput=function(){
	if (!reg.test(document.getElementById("forget_tel_no").value)){
    document.getElementById("reg_valid_vcode").style.opacity='0.5';
    }
    else{
    document.getElementById("reg_valid_vcode").style.opacity='1';
    }

      if(document.getElementById("forget_valid_code").value!='' && document.getElementById("forget_tel_no").value!=''){
        document.getElementById("_find_pwd_action").style.opacity='1';
      }
      else{
        document.getElementById("_find_pwd_action").style.opacity='0.5';
      }

    }
    document.getElementById("forget_valid_code").oninput=function(){
      if(document.getElementById("forget_valid_code").value!='' && document.getElementById("forget_tel_no").value!=''){
        document.getElementById("_find_pwd_action").style.opacity='1';
      }
      else{
        document.getElementById("_find_pwd_action").style.opacity='0.5';
      }


    }


  $scope.regCompAcct=function(){
    if($scope.regModel._phone_num=='' || $scope.regModel.valid_code==''){
      $ionicPopup.alert({
        title: '提示',
        template: '<div style="text-align: center;">手机号或者验证码为空</div>',
        okText: '确定'
      })
    }
    else{
      if (!reg.test($scope.regModel._phone_num)) {
        $ionicPopup.alert({
          title: '提示',
          template: '<div style="text-align: center;">手机号格式不正确</div>',
          okText: '确定'
        })
      }
      else{
        $location.path("comp_reg_content/"+$scope.regModel._phone_num+"/"+$scope.regModel.valid_code);
      }

    }

}

  })

  .controller('compRegContentCtrl',function($scope,$ionicHistory,$ionicViewSwitcher,$location,$ionicModal,userLoginService,sideSelect,$timeout,$stateParams,$rootScope,$ionicPopup,compRegSev){
    $scope.show_pwd=  local_resource + 'img/icon/show_pwd_icon.png';
    $scope.hide_pwd=  local_resource + 'img/icon/hide_pwd_icon.png';
    $scope.old_psw_flag= true;
    $scope.regModel = compRegSev.getRegModel();
    $scope.freeExpr = compRegSev.getFreeData();
    $scope.regModel._phone_num=$stateParams.tel_no;
    $scope.regModel.valid_code=$stateParams.valid_code;
    $scope.path_log=function(){
      $location.path("/")
    }
    $scope.old_pwd_click=function(flag){
      $scope.old_psw_flag= !flag;
      if(flag){
        $("#modifyPwdold").attr('type','text')
      }
      else{
        $("#modifyPwdold").attr('type','password')
      }
    }

      $scope.side_category_data=[{"key":"1","value":"IT|通信|电子|互联网"},{"key":"2","value":"金融业"},{"key":"3","value":"房地产|建筑业"},
        {"key":"4","value":"商业服务"},{"key":"5","value":"生产|加工|制造"},
        {"key":"6","value":"服务业"},{"key":"7","value":"能源|矿产|环保"},
        {"key":"8","value":"贸易|批发|零售|租赁业"},{"key":"9","value":"交通|运输|物流|仓储"},
        {"key":"10","value":"文体教育|工艺美术"},{"key":"11","value":"文化|传媒|娱乐|体育"},
        {"key":"12","value":"农|林|牧|渔|其他"},{"key":"13","value":"政府|非盈利机构"}]
      $scope.side_category_index=0;
      $scope.side_category=function(){
        sideSelect.show({
          type : 'ios',
          data :$scope.side_category_data,
          selectIndex :  $scope.side_category_index,
          selectedFunc : function (index) {
            if(typeof(index)!='undefined'){
              document.getElementById("login_category").innerHTML=$scope.side_category_data[index].value;
              $scope.side_category_index=index;
              $scope.regModel._category=document.getElementById("login_category").innerHTML;
            }
          }
        });
      }
      $scope.side_empl_num_data=[{"key":"1","value":"100人以下"},{"key":"2","value":"100~200人"},{"key":"3","value":"300~400人"},
        {"key":"4","value":"300~400人"},{"key":"5","value":"500人以上"}]
      $scope.side_empl_num_index=0;
      $scope.side_empl_num=function(){
        sideSelect.show({
          type : 'ios',
          data :$scope.side_empl_num_data,
          selectIndex :  $scope.side_empl_num_index,
          selectedFunc : function (index) {
            if(typeof(index)!='undefined'){
              document.getElementById("login_empl_num").innerHTML=$scope.side_empl_num_data[index].value;
              $scope.side_empl_num_index=index;
              $scope.regModel._empl_num=document.getElementById("login_empl_num").innerHTML;
            }
          }
        });
      }

	  document.getElementById("forget_tel_no").oninput=function(){
		  if(document.getElementById("forget_tel_no").value!='' && document.getElementById("modifyPwdold").value!='' && document.getElementById("forget_contact").value!=''&& document.getElementById("forget_position").value!=''){
			  document.getElementById('_find_pwd_action').style.opacity='1';
		  }
		  else{
			  document.getElementById('_find_pwd_action').style.opacity='0.5';
		  }
	  }
	  document.getElementById("modifyPwdold").oninput=function(){
		  if(document.getElementById("forget_tel_no").value!='' && document.getElementById("modifyPwdold").value!='' && document.getElementById("forget_contact").value!=''&& document.getElementById("forget_position").value!=''){
			  document.getElementById('_find_pwd_action').style.opacity='1';
		  }
		  else{
			  document.getElementById('_find_pwd_action').style.opacity='0.5';
		  }
	  }
	  document.getElementById("forget_position").oninput=function(){
		  if(document.getElementById("forget_tel_no").value!='' && document.getElementById("modifyPwdold").value!='' && document.getElementById("forget_contact").value!=''&& document.getElementById("forget_position").value!=''){
			  document.getElementById('_find_pwd_action').style.opacity='1';
		  }
		  else{
			  document.getElementById('_find_pwd_action').style.opacity='0.5';
		  }
	  }
    document.getElementById("forget_contact").oninput=function(){
      if(document.getElementById("forget_tel_no").value!='' && document.getElementById("modifyPwdold").value!='' && document.getElementById("forget_contact").value!=''&& document.getElementById("forget_position").value!=''){
        document.getElementById('_find_pwd_action').style.opacity='1';
      }
      else{
        document.getElementById('_find_pwd_action').style.opacity='0.5';
      }
    }


    $scope.regCompAcct = function(){
      var reg = /^1[3|4|5|7|8]\d{9}$/;
      if($scope.regModel._phone_num==''||$scope.regModel._pwd1==''||$scope.regModel._comp_name==''||$scope.regModel._contact_name==''||$scope.regModel._contact_position==''||$scope.regModel.valid_code==''){
        $scope.regModel._flag = 0;
        $scope.regModel._message = '注册信息不能为空!';
        $timeout(function(){
          $scope.regModel._flag = 1;
          $scope.regModel._message = '';
        },1500);
        return;
      }else if(!reg.test($scope.regModel._phone_num)){
        $scope.regModel._flag = 0;
        $scope.regModel._message = '手机号码格式不正确!';
        $timeout(function(){
          $scope.regModel._flag = 1;
          $scope.regModel._message = '';
        },1500);
        return;
      }else{
        $rootScope.showLoading();
        var _val = '';
        if($scope.regModel._empl_num=="100人以下"){
          _val = "100";
        }else if($scope.regModel._empl_num=="100~200人"){
          _val = "200";
        }else if($scope.regModel._empl_num=="200~300人"){
          _val = "300";
        }else if($scope.regModel._empl_num=="300~400人"){
          _val = "400";
        }else{
          _val = "500";
        }
        var _m = new Date().getMonth()+1;
        var _d = new Date().getDate();
        var _now = new Date().getFullYear()+"-"+(_m<=9?'0'+_m:_m)+"-"+(_d<=9?'0'+_d:_d);
        var _str = "";
        _str = _str + "user_name:"+$scope.regModel._phone_num+"\n";
        _str = _str + "password:"+$scope.regModel._pwd1+"\n";
        _str = _str + "company_name:"+$scope.regModel._comp_name+"\n";
        _str = _str + "category:"+$scope.regModel._category+"\n";
        _str = _str + "employee_ct:"+_val+"\n";
        _str = _str + "contact:"+$scope.regModel._contact_name+"\n";
        _str = _str + "position:"+$scope.regModel._contact_position+"\n";
        _str = _str + "input_date:"+_now+"\n";

        $.ajax({
          type:"GET",
          url:_redis_url+'/UserServer/user?action=addcus&data='+encodeURI(_str)+'&jsonp=true&checkCode='+$scope.regModel.valid_code,
          dataType:"jsonp",
          jsonp:"callback",
          jsonpCallback:"jsonpCallBack",
          timeout:_var_timeout,
          success:function(data){
            $rootScope.hideLoading();
            if(angular.isDefined(data)&&angular.isDefined(data.patch_version)){
              $rootScope.showSystemMaintPopup(data.message.message).then(function(res){
                $scope.regModel._flag = 1;
                $scope.regModel._message = '';
              });
              return;
            }
            if(angular.isDefined(data)&&angular.isDefined(data.message)){
              if(data.message=='sn'){
				  if(data.value==true){
							 $scope.regModel._message = "考勤机序列号已被注册";
						}else{
							 $scope.regModel._message = "考勤机序列号不允许接入";
						}
              }else if(data.message=='user_name'){
                $scope.regModel._message = '手机号码已注册!';
              }else{
                $scope.regModel._message = '创建企业失败,请与管理员联系!';
                if(angular.isDefined(data)&&data.message&&data.message=="check_code_error"){
                  $scope.regModel._message = '创建企业帐号失败,验证码错误';
                }
              }
              $scope.regModel._flag = 0;
              $timeout(function(){
                $scope.regModel._flag = 1;
                $scope.regModel._message = '';
              },1500);
              return;
            }else if(!angular.isDefined(data)||(angular.isDefined(data)&&data.success==false)){
              $scope.regModel._flag = 0;
              $scope.regModel._message = '创建企业帐号失败,请与管理员联系!';
              if(angular.isDefined(data)&&data.message&&data.message=="check_code_error"){
                $scope.regModel._message = '创建企业帐号失败,验证码错误';
              }
              $timeout(function(){
                $scope.regModel._flag = 1;
                $scope.regModel._message = '';
              },1500);
              return;
            }else{
              fufuMobclickAgent('click_company_register');
              $ionicPopup.alert({
                title: '运行结果',
                template: '<div style="text-align: center;">创建企业帐号成功,请登录</div>',
                okText: '确定'
              })
                .then(function(res) {
                  //$scope.modal.hide();
                  $location.path("/");
                  $scope.regModel = {
                    _phone_num:'',
                    _pwd1:'',
                    _pwd2:'',
                    _comp_name:'',
                    _category:'请选择您所属的行业',
                    _empl_num:'请选择企业规模',
                    _sn_list:'',
                    _contact_name:'',
                    _contact_position:'',
                    _flag:1,
                    _message:''
                  }
                });
            }
          },
          error:function(){
            $rootScope.hideLoading();
            $ionicPopup.alert({
              title : '提醒',
              template : '<div style="text-align: center;">'+fufu_network_error_msg+'</div>',
              okText : '确定'
            })
          }
        });
      }
    }
  })



  .controller('loginCtrl',function($scope,userLoginService,$ionicModal,$timeout,$rootScope,$ionicPopup,$ionicActionSheet,sideSelect,$ionicHistory,$location,MsgSettingSev){
    $scope.icon_company_name=local_resource+'img/icon/icon_company_name.png';
    $scope.icon_user=local_resource+'img/icon/icon_user.png';
    $scope.close_login_page=local_resource+'img/icon/close_login_page.png';
    clearInterval(fufu_register_timeout);
    $scope.side_category_data=[{"key":"1","value":"IT|通信|电子|互联网"},{"key":"2","value":"金融业"},{"key":"3","value":"房地产|建筑业"},
      {"key":"4","value":"商业服务"},{"key":"5","value":"生产|加工|制造"},
      {"key":"6","value":"服务业"},{"key":"7","value":"能源|矿产|环保"},
      {"key":"8","value":"贸易|批发|零售|租赁业"},{"key":"9","value":"交通|运输|物流|仓储"},
      {"key":"10","value":"文体教育|工艺美术"},{"key":"11","value":"文化|传媒|娱乐|体育"},
      {"key":"12","value":"农|林|牧|渔|其他"},{"key":"13","value":"政府|非盈利机构"}]
    $scope.side_category_index=0;
    $scope.side_category=function(){
      sideSelect.show({
        type : 'ios',
        data :$scope.side_category_data,
        selectIndex :  $scope.side_category_index,
        selectedFunc : function (index) {
          if(typeof(index)!='undefined'){
            document.getElementById("login_category").innerHTML=$scope.side_category_data[index].value;
            $scope.side_category_index=index;
            $scope.regModel._category=document.getElementById("login_category").innerHTML;
          }
        }
      });
    }
    $scope.side_empl_num_data=[{"key":"1","value":"100人以下"},{"key":"2","value":"100~200人"},{"key":"3","value":"300~400人"},
      {"key":"4","value":"300~400人"},{"key":"5","value":"500人以上"}]
    $scope.side_empl_num_index=0;
    $scope.side_empl_num=function(){
      sideSelect.show({
        type : 'ios',
        data :$scope.side_empl_num_data,
        selectIndex :  $scope.side_empl_num_index,
        selectedFunc : function (index) {
          if(typeof(index)!='undefined'){
            document.getElementById("login_empl_num").innerHTML=$scope.side_empl_num_data[index].value;
            $scope.side_empl_num_index=index;
            $scope.regModel._empl_num=document.getElementById("login_empl_num").innerHTML;
          }
        }
      });
    }

	$scope.debug_mode = debug_mode;
    $scope.loginModel = {
      _user_name:angular.isDefined(window.localStorage['_user_name'])?window.localStorage['_user_name']:'',
      _pass_word:''
    }
    $scope.loginMsg = userLoginService.loginMsg();

    $scope.userLogin = function(){
      if($scope.loginModel._user_name==''|| $scope.loginModel._pass_word==''){
        return;
      }
		MsgSettingSev.notData();
      userLoginService.userLogin($scope.loginModel);
    }

    $scope.getValidCode = function(){
      userLoginService.getValidCode();
    }

      $scope.freeExpr = userLoginService.getFreeData();


     $scope.freeExpr.cmp_name=window.localStorage['free_trial_cmp_name'] ;
     $scope.freeExpr.cmp_contact=window.localStorage['free_trial_cmp_contact'] ;
     $scope.freeExpr.tel_no=window.localStorage['free_trial_tel_no'] ;
     $scope.freeExpr.valid_code=window.localStorage['free_trial_valid_code'] ;

    $scope.sendPwdVCode = function(){
      userLoginService.sendPwdVCode();
    }
    $scope.showLoginMenu = function(){
      //$ionicActionSheet.show({
      //  buttons: [
      //    {
      //      text: '立即体验'
      //    }, {
      //      text: '企业注册'
      //    }
      //  ],
      //  titleText: '',
      //  cancelText: '取消',
      //  cancel: function() {
      //  },
      //  buttonClicked: function(index) {
      //    if(index==0){
            $scope.openFreeModal();
      //    }else{
      //      $scope.openModal();
      //    }
      //    return true;
      //  }
      //});
    }

    $scope.chooseTestingServer = function(){
      $ionicActionSheet.show({
        buttons: [
          {
            text: '118'
          }, {
            text: '120'
          }, {
            text: 'S0'
          }, {
            text: 'S1'
          }, {
            text: '111'
          }, {
            text: '120 AK'
          }, {
            text: '120 victor'
          }
        ],
        titleText: '',
        cancelText: '取消',
        cancel: function() {
        },
        buttonClicked: function(index) {
          if(index==0){
			  return;
            //alert('已经切换到118环境');
			_cdn_url = 'http://192.168.2.118/fufu/fufu/www/';
			_redis_url = 'http://120.24.153.50';
			_login_debug_url = 'http://192.168.2.118/fufu/cb_hrms/index.cfm';
			window.localStorage._cdn_url = 'http://192.168.2.118/fufu/fufu/www/';
			window.localStorage._redis_url = 'http://120.24.153.50';
			window.localStorage._login_debug_url = 'http://192.168.2.118/fufu/cb_hrms/index.cfm';
			if (ionic.Platform.isWebView()){
				window.localStorage._resource_version = '1.0';
			}
			else {
				window.localStorage._resource_version = '99.99';
			}
      window.location.reload();
          }else if (index==1){
			//alert('已经切换到120环境');
			_cdn_url = 'http://120.24.153.50/fufu/www/';
			_redis_url = 'http://120.24.153.50';
			_login_debug_url = '';
			window.localStorage._cdn_url = 'http://120.24.153.50/fufu/www/';
			window.localStorage._redis_url = 'http://120.24.153.50';
			window.localStorage._login_debug_url = '';
			if (ionic.Platform.isWebView()){
				window.localStorage._resource_version = '1.0';
			}
			else {
				window.localStorage._resource_version = '99.99';
			}
            window.location.reload();
          }else if (index==2){
			//alert('已经切换到S0环境');
			_cdn_url = 'https://s0.zkcserv.com/fufu/www/';
			_redis_url = 'https://s0.zkcserv.com';
			_login_debug_url = '';
			window.localStorage._cdn_url = 'https://s0.zkcserv.com/fufu/www/';
			window.localStorage._redis_url = 'https://s0.zkcserv.com';
			window.localStorage._login_debug_url = '';
			if (ionic.Platform.isWebView()){
				window.localStorage._resource_version = '1.0';
			}
			else {
				window.localStorage._resource_version = '99.99';
			}
            window.location.reload();
          }else if (index==3){
			//alert('已经切换到S1环境');
			_cdn_url = 'https://cname.zkcserv.com/fufu/www/';
			_redis_url = 'https://zkcserv.com';
			_login_debug_url = '';
			window.localStorage._cdn_url = 'https://cname.zkcserv.com/fufu/www/';
			window.localStorage._redis_url = 'https://zkcserv.com';
			window.localStorage._login_debug_url = '';
			if (ionic.Platform.isWebView()){
				window.localStorage._resource_version = '1.0';
			}
			else {
				window.localStorage._resource_version = '99.99';
			}
            window.location.reload();
          } else if(index==4){
            //alert('已经切换到111环境');
			_cdn_url = 'http://192.168.2.111:8888/fufu/fufu/www/';
			_redis_url = 'http://120.24.153.50';
			_login_debug_url = 'http://192.168.2.111:8888/fufu/cb_hrms/index.cfm';
			window.localStorage._cdn_url = 'http://192.168.2.111:8888/fufu/fufu/www/';
			window.localStorage._redis_url = 'http://120.24.153.50';
			window.localStorage._login_debug_url = 'http://192.168.2.111:8888/fufu/cb_hrms/index.cfm';
			if (ionic.Platform.isWebView()){
				window.localStorage._resource_version = '1.0';
			}
			else {
				window.localStorage._resource_version = '99.99';
			}
				window.location.reload();
          }else if(index==6){
            //alert('已经切换到111环境');
      _cdn_url = 'http://120.24.153.50/fufu_victor/www/';
      _redis_url = 'http://120.24.153.50';
      _login_debug_url = '';
      window.localStorage._cdn_url = 'http://120.24.153.50/fufu_victor/www/';
      window.localStorage._redis_url = 'http://120.24.153.50';
      window.localStorage._login_debug_url = '';
      if (ionic.Platform.isWebView()){
        window.localStorage._resource_version = '1.0';
      }
      else {
        window.localStorage._resource_version = '99.99';
      }
        window.location.reload();
          }
			else if(index==5){
            //alert('已经切换到120 AK环境');
			_cdn_url = 'http://120.24.153.50/fufu_ak/www/';
			_redis_url = 'http://120.24.153.50';
			_login_debug_url = '';
			window.localStorage._cdn_url = 'http://120.24.153.50/fufu_ak/www/';
			window.localStorage._redis_url = 'http://120.24.153.50';
			window.localStorage._login_debug_url = '';
			if (ionic.Platform.isWebView()){
				window.localStorage._resource_version = '1.0';
			}
			else {
				window.localStorage._resource_version = '99.99';
			}
				window.location.reload();
          }
          return true;
        }
      });
    }

    $scope.demoLogin = function(){
        userLoginService.demoLogin($scope.free_modal);
    }
    $ionicModal.fromTemplateUrl('free_experience_account.html', {
      scope: $scope,
      animation: 'slide-in-up'
    }).then(function(modal) {
      $scope.free_modal = modal;
    });
    $scope.openFreeModal = function() {
      $scope.free_modal.show();
    };
    $scope.closeFreeModal = function() {
      $scope.free_modal.hide();
    };
    $scope.$on('$destroy', function() {
      $scope.free_modal.remove();
    });

    $scope.regModel = userLoginService.getRegModel();
    $scope.regCompAcct = function(){
      var reg = /^1[3|4|5|7|8]\d{9}$/;
      if($scope.regModel._phone_num==''||$scope.regModel._pwd1==''||$scope.regModel._pwd2==''||$scope.regModel._comp_name==''||$scope.regModel._sn_list==''||$scope.regModel.valid_code==''){
        $scope.regModel._flag = 0;
        $scope.regModel._message = '注册信息不能为空!';
        $timeout(function(){
          $scope.regModel._flag = 1;
          $scope.regModel._message = '';
        },1500);
        return;
      }else if($scope.regModel._pwd1 != $scope.regModel._pwd2){
        $scope.regModel._flag = 0;
        $scope.regModel._message = '密码与确认密码不相同!';
        $timeout(function(){
          $scope.regModel._flag = 1;
          $scope.regModel._message = '';
        },1500);
        return;
      }else if(!reg.test($scope.regModel._phone_num)){
        $scope.regModel._flag = 0;
        $scope.regModel._message = '手机号码格式不正确!';
        $timeout(function(){
          $scope.regModel._flag = 1;
          $scope.regModel._message = '';
        },1500);
        return;
      }else{
        $rootScope.showLoading();
        var _val = '';
        if($scope.regModel._empl_num=="100人以下"){
          _val = "100";
        }else if($scope.regModel._empl_num=="100~200人"){
          _val = "200";
        }else if($scope.regModel._empl_num=="200~300人"){
          _val = "300";
        }else if($scope.regModel._empl_num=="300~400人"){
          _val = "400";
        }else{
          _val = "500";
        }
        var _m = new Date().getMonth()+1;
        var _d = new Date().getDate();
        var _now = new Date().getFullYear()+"-"+(_m<=9?'0'+_m:_m)+"-"+(_d<=9?'0'+_d:_d);
        var _str = "";
        _str = _str + "user_name:"+$scope.regModel._phone_num+"\n";
        _str = _str + "password:"+$scope.regModel._pwd1+"\n";
        _str = _str + "company_name:"+$scope.regModel._comp_name+"\n";
        _str = _str + "category:"+$scope.regModel._category+"\n";
        _str = _str + "employee_ct:"+_val+"\n";
        _str = _str + "sn_list:"+$scope.regModel._sn_list+"\n";
        _str = _str + "input_date:"+_now+"\n";
        $.ajax({
          type:"GET",
          url:_redis_url+'/UserServer/user?action=addcus&data='+encodeURI(_str)+'&jsonp=true&checkCode='+$scope.regModel.valid_code,
          dataType:"jsonp",
          jsonp:"callback",
          jsonpCallback:"jsonpCallBack",
          timeout:_var_timeout,
          success:function(data){
            $rootScope.hideLoading();
            if(angular.isDefined(data)&&angular.isDefined(data.patch_version)){
              $rootScope.showSystemMaintPopup(data.message.message).then(function(res){
                $scope.regModel._flag = 1;
                $scope.regModel._message = '';
              });
              return;
            }
            if(angular.isDefined(data)&&angular.isDefined(data.message)){

              if(data.message=='sn'){
                if(data.value==true){
							 $scope.regModel._message = "考勤机序列号已被注册";
						}else{
							 $scope.regModel._message = "考勤机序列号不允许接入";
						}
              }else if(data.message=='user_name'){
                $scope.regModel._message = '手机号码已注册!';
              }else{
                $scope.regModel._message = '创建企业失败,请与管理员联系!';
                if(angular.isDefined(data)&&data.message&&data.message=="check_code_error"){
                  $scope.regModel._message = '创建企业帐号失败,验证码错误';
                }
              }
              $scope.regModel._flag = 0;
              $timeout(function(){
                $scope.regModel._flag = 1;
                $scope.regModel._message = '';
              },1500);
              return;
            }else if(!angular.isDefined(data)||(angular.isDefined(data)&&data.success==false)){

              $scope.regModel._flag = 0;
              $scope.regModel._message = '创建企业帐号失败,请与管理员联系!';
              if(angular.isDefined(data)&&data.message&&data.message=="check_code_error"){
                $scope.regModel._message = '创建企业帐号失败,验证码错误';
              }
              $timeout(function(){
                $scope.regModel._flag = 1;
                $scope.regModel._message = '';
              },1500);
              return;
            }else{
				fufuMobclickAgent('click_company_register');
              $ionicPopup.alert({
                title: '运行结果',
                template: '<div style="text-align: center;">创建企业帐号成功,请登录</div>',
                okText: '确定'
              })
                .then(function(res) {
                  $scope.modal.hide();
                  $scope.regModel = {
                    _phone_num:'',
                    _pwd1:'',
                    _pwd2:'',
                    _comp_name:'',
                    _category:'请选择您所属的行业',
                    _empl_num:'请选择企业规模',
                    _sn_list:'',
                    _flag:1,
                    _message:''
                  }
                });
            }
          },
          error:function(){
            $rootScope.hideLoading();
            $ionicPopup.alert({
              title : '提醒',
              template : '<div style="text-align: center;">'+fufu_network_error_msg+'</div>',
              okText : '确定'
            })
          }
        });
      }
    }

    $ionicModal.fromTemplateUrl('comp-reg-modal.html', {
      scope: $scope,
      animation: 'slide-in-up'
    }).then(function(modal) {
      $scope.modal = modal;
    });
    $scope.openModal = function() {
      $scope.modal.show();
    };
    $scope.closeModal = function() {
      $scope.modal.hide();
    };
    $scope.$on('$destroy', function() {
      $scope.modal.remove();
    });

    $scope.loginUserChange=function(){
      if($scope.loginModel._user_name==''|| $scope.loginModel._pass_word==''){
        document.getElementById('loginSubmit').style.color='#cccccc';
        document.getElementById('loginSubmit').style.borderColor='#cccccc';
      }
      else{
        document.getElementById('loginSubmit').style.color='#53afff';
        document.getElementById('loginSubmit').style.borderColor='#53afff';
      }

    }

    $scope.loginPwdChange=function(){

      if($scope.loginModel._user_name==''|| $scope.loginModel._pass_word==''){
        document.getElementById('loginSubmit').style.color='#cccccc';
        document.getElementById('loginSubmit').style.borderColor='#cccccc';
      }
      else{
        document.getElementById('loginSubmit').style.color='#53afff';
        document.getElementById('loginSubmit').style.borderColor='#53afff';
      }
    }

  })
  .controller('userHomeCtrl',function($scope,homemessageSev,userHomeService,$location,$ionicHistory,$ionicPopup,$ionicLoading,$rootScope,$ionicScrollDelegate,$timeout,searchDeviceSev,$setstatusBar){
    $scope.net_error = local_resource + 'img/icon/net_error.png';
    $scope.rq_icon = local_resource + 'img/icon_scan.png';

    $setstatusBar.white();

    $scope.openQr = function(){


      if(ionic.Platform.isIOS()){


          barcodeScanner.scan(function(msg){

              if(msg){
                  // $timeout(function(){

                      searchDeviceSev.setReset(true);
                          autosignin.pauseSignIn();
                          homemessageSev.setLyFlag(1);
                          $location.path('/home_page/home_default/search_device');
                  // },0);
              }else{
                 //扫描失败 或者是 取消
                 barcodeScanner.close();
              }

          });
      }else{

          barcodeScanner.checkCameraPermission(function(msg){

              if(msg==1){

                barcodeScanner.scan(function(msgs){

                          if(msgs){
                              $timeout(function(){
                                  searchDeviceSev.setReset(true);
                                  autosignin.pauseSignIn();
                                  homemessageSev.setLyFlag(1);
                                  $location.path('/home_page/home_default/search_device');

                              },0);


                          }else{
                              //扫描失败 或者是 取消
                              barcodeScanner.close();
                          }

                });



              }else{
                console.log("相机权限失败");
              }
          });
      }

    }
    $scope.$on("$ionicView.afterEnter", function(event, data){
        //进入之后
      $scope.lyFlag = homemessageSev.retLyFlag();

      if($scope.lyFlag.state == 1){
        autosignin.reopenSignIn();
        homemessageSev.setLyFlag(0);
      }

      $setstatusBar.white();
    });

	  $scope.wifi_obj = userHomeService.getWifiObj();
	$timeout(function(){
		  if(document.getElementById("user_home_is_connected")!=null && typeof(document.getElementById("user_home_is_connected"))!='undefined'){
			  document.getElementById("user_home_is_connected").style.display='block';
		  }
	  },1000);

    if (login_init_flag == 0){
		 if(typeof(login_flag)!='undefined'&&login_flag==1){
			checkMbAppVersion(window.localStorage['_remote_server_addr'],$ionicPopup,$ionicLoading,$rootScope,$location);
		  }
		login_init_flag = 1;
	}
    homemessageSev.loadMessageCount();
    $scope.local_resource = local_resource;
    $scope.img_banner = local_resource + 'img/register/img_banner_2.png';
    $scope.img_exit_trial_login = local_resource + 'img/icon/exit_trial_login.png';
    if (window.localStorage["org_top_level"] != null && typeof(window.localStorage["org_top_level"]) != 'undefined' && window.localStorage["org_top_level"] != '') {

    }
    else {
      window.localStorage["org_top_level"] = '本公司';
    }

    if (window.localStorage["is_free_trial_login"] != null && typeof(window.localStorage["is_free_trial_login"]) != 'undefined' && window.localStorage["is_free_trial_login"] != '') {
      document.getElementById("home_default_is_trial_login").style.display='block';
    }
    else {
      document.getElementById("home_default_is_trial_login").style.display='none';
    }


	if (window.localStorage["menu_home"] != null && typeof(window.localStorage["menu_home"]) != 'undefined' && window.localStorage["menu_home"] != ''){
		$scope.menuList =  userHomeService.getMenuList();
		//$scope.menuList = $.parseJSON(window.localStorage["menu_home"]);
		userHomeService.setMenuList($.parseJSON(window.localStorage["menu_home"]));
		$rootScope.hideLoading();
	}
	else {
	    userHomeService.loadMenuList();
        $scope.menuList =  userHomeService.getMenuList();
	}


        $scope.redirectPage = function(menu_key,menu_name,fg){
          if(angular.isDefined(fg)&&fg==0){
            $location.path('home_page/home_default/'+menu_key+'/'+menu_name);
          }else{
			if (menu_key == 'staff_master'){
				fufuMobclickAgent('menu_staff_master');
			}
			else if (menu_key == 'employee_contract'){
				fufuMobclickAgent('menu_employee_contract');
			}
			else if (menu_key == 'at_empl_card_rec'){
				fufuMobclickAgent('menu_at_empl_card_rec');
			}
			else if (menu_key == 'my_leave_balance'){
				fufuMobclickAgent('menu_my_leave_balance');
			}
			else if (menu_key == 'pay_slip'){
				fufuMobclickAgent('menu_pay_slip');
			}
			else if (menu_key == 'at_team_record'){
				fufuMobclickAgent('menu_at_team_record');
			}
			else if (menu_key == 'leave_team_record'){
				fufuMobclickAgent('menu_leave_team_record');
			}
			else if (menu_key == 'outdoor_team_record'){
				fufuMobclickAgent('menu_outdoor_team_record');
			}
			else if (menu_key == 'leave_balance_team_record'){
				fufuMobclickAgent('menu_leave_balance_team_record');
			}
			else if (menu_key == 'ot_team_record'){
				fufuMobclickAgent('menu_ot_team_record');
			}
			else if (menu_key == 'customer_info'){
				fufuMobclickAgent('menu_customer_info');
			}
            $location.path('home_page/home_menulist/'+menu_key);
          }
        }

    $scope.swiperData = [
      {imgUrl:local_resource+'img/register/banner_3_2_blue.png', locationUrl:'#/home_page/banner_details/路过即打卡，就是蓝牙！/20'},
      {imgUrl:local_resource+'img/register/banner_3_2.jpg', locationUrl:'#/home_page/banner_details/专注员工考勤，我们一直在精进！/19'},
      {imgUrl:local_resource+'img/register/banner_2.png', locationUrl:'#/home_page/banner_details/服服补签卡业务震撼上线/18'},
    ];

    $scope.free_trial_log_out = function () {
      $ionicPopup.confirm({
        title: '退出登录',
        template: '<div style="text-align: center;">是否退出系统?</div>',
        cancelType:'button-dark',
        cancelText: '取消',
        okText: '确定'
      }).then(function (res) {
        if (res) {
          //$rootScope.showLoading();
          $.ajax({
            type: "GET",
            url: window.localStorage['_remote_server_addr']+'?event=ionicAction.ionicAction.doLogout',
            timeout: _var_timeout,
            success: function (data) {
              $rootScope.hideLoading();
            },
            error:function(data){
              $rootScope.hideLoading();
              /*
               $ionicPopup.alert({
               title : '提醒',
               template : '<div style="text-align: center;">'+fufu_network_error_msg+'</div>',
               okText : '确定'
               });
               */
            }
          });
          $ionicHistory.clearCache();
          $ionicHistory.clearHistory();
          window.localStorage['_pass_word']='';
          window.localStorage['_is_login']=0;
          if (window.localStorage["menu_list"] != null && typeof(window.localStorage["menu_list"]) != 'undefined' && window.localStorage["menu_list"] != ''){
            var model_list = window.localStorage["menu_list"].split(',');
            for (var i=0;i<model_list.length;i++){
              if (model_list[i] != ''){
                window.localStorage[model_list[i]] = '';
              }
            }
          }
          window.localStorage["menu_list"] = '';
          window.localStorage["menu_home"] = '';
          window.localStorage["menu_message"] = '';
          window.localStorage["menu_organization_management"] = '';
          window.localStorage["menu_time"] = '';
          window.localStorage["menu_payroll"] = '';
          window.localStorage["menu_ess"] = '';
          window.localStorage["menu_My_Team"] = '';
          window.localStorage["menu_setting"] = '';
          window.localStorage["personnal_data"] = '';
          window.localStorage['is_free_trial_login'] = '';
          login_init_flag = 0;
          $location.path('/');

        }
      });
    }
  })

	.controller('searchDeviceCtrl',function($scope,$rootScope,$location,searchDeviceSev,$ionicHistory,$ionicPopup,$ionicPlatform,bluetoothDeviceSev,$setstatusBar){

    $setstatusBar.black();

    $scope.local_resource = local_resource;

    $scope.removeEvent = null;

    $scope.back = function(){
      //解除绑定
        bluetoothDeviceSev.perish();

        bluetooth.cancelBleConfig();

        $ionicHistory.goBack();

    };

		$scope.isIos = ionic.Platform.isIOS();


    $scope.ratioSmall =  200 > (screen.height - screen.width);

		$scope.$on("$ionicView.beforeEnter", function(event, data){
      //进入之前

      $ionicPlatform.onHardwareBackButton($scope.back);

			$scope.searchDeviceData = searchDeviceSev.getData();


      if($scope.searchDeviceData.isReset){
        searchDeviceSev.setReset();
        searchDeviceSev.test($scope.back);
      }else{

        searchDeviceSev.setReset();
        searchDeviceSev.test($scope.back,true);

      }

		});

    $scope.$on("$ionicView.afterEnter", function(event, data){
        //进入之后

        barcodeScanner.close();
    });

    $scope.$on("$ionicView.beforeLeave", function(event, data){
        //离开之前
        $ionicPlatform.offHardwareBackButton($scope.back);
    });

	})

  .controller('deviceStateCtrl',function($scope,$rootScope,$location,connectDeviceStateSev,$ionicHistory,$ionicPopup,$ionicPlatform,$timeout,bluetoothDeviceSev,$setstatusBar){
      $scope.local_resource = local_resource;
	$setstatusBar.black();
      var curView = "/home_page/home_default/device_state";

      $scope.timeout = {};
      $scope.timeout.obj = null;
      $scope.cur_alleyway = {};
      $scope.cur_alleyway.state = null;

      $scope.myPopup = null;

      //调试用
      // connectDeviceStateSev.setDeviceState(2,"施特伟(深圳)科技有限公司");
      $scope.connectDeviceData = connectDeviceStateSev.getData();
//              5    // 考勤机蓝牙连接成功
//              6   // 考勤机蓝牙断开连接
//              12    // 考勤机连接失败（蓝牙根本连接不了）
      $scope.back = function(){

      	bluetooth.cancelBleConfig();
        bluetoothDeviceSev.perish();
        // if($scope.connectDeviceData.stateType == 5){
        //     //关闭通讯
        //     bluetooth.cancelBleConfig();
        //     //连接成功下 back
        //     $ionicHistory.goBack();
        // }else{
        //     $ionicHistory.goBack(-2);
        // }
        $ionicHistory.goBack(-2);
      };

      $scope.goToSetWifi = function(){
        $scope.timeout.obj = $timeout(function(){
          if($ionicHistory.currentView().url != curView){
            return console.log($ionicHistory.currentView().url);
          }

          $location.path('/home_page/home_default/config_wifi');

        },2000);
      }

      $scope.refresh = function(){
        $ionicHistory.goBack();
      };

      function scanBluetoothFunc(update){
          if(update.status == 10){


            if($scope.timeout.obj){
              $timeout.cancel($scope.timeout.obj);
              $scope.timeout.obj = null;
            }

            if($scope.cur_alleyway.state == 6){
              return;
            }

            if($scope.myPopup){
              $scope.myPopup.close();
              $scope.myPopup = null;
            }

            if($ionicHistory.currentView().url != curView){
              return console.log($ionicHistory.currentView().url);
            }

            $scope.myPopup = $ionicPopup.confirm({
               title: '设备连接已断开',
               scope: $scope,
               buttons: [
                  {
                    text:'返回',type:'button-light',
                    onTap: function() {
                      bluetoothDeviceSev.perish();
                        $ionicHistory.goBack(-1);
                        $timeout(function(){
                             $scope.cur_alleyway.state = null;
                        },0);
                    }
                  },
                  {
                    text:'退出',type:'button-light',
                    type: 'button-positive',
                    onTap : function(e){
                        $scope.back();
                        $timeout(function(){
                             $scope.cur_alleyway.state = null;
                        },0);
                    }
                  }
               ]
            });

        }


        if(update.status == 6){  

          if($scope.timeout.obj){
               $timeout.cancel($scope.timeout.obj);
              $scope.timeout.obj = null;

          }

        	$scope.cur_alleyway.state = 6;

          if($scope.myPopup){
              $scope.myPopup.close();
              $scope.myPopup = null;
          }

          if($ionicHistory.currentView().url != curView){
            return console.log($ionicHistory.currentView().url);
          }

        	$scope.myPopup = $ionicPopup.confirm({
               title: '设备连接已断开',
               scope: $scope,
               buttons: [
                  {
                    text:'返回',type:'button-light',
                    onTap: function() {
                      bluetoothDeviceSev.perish();
                        $ionicHistory.goBack(-1);
                        $timeout(function(){
                             $scope.cur_alleyway.state = null;
                        },0);
                    }
                  },
                  {
                    text:'退出',type:'button-light',
                    type: 'button-positive',
                    onTap : function(e){
                        $scope.back();
                        $timeout(function(){
                             $scope.cur_alleyway.state = null;
                        },0);
                    }
                  }
               ]
            });

        }
      }

      $scope.$on("$ionicView.beforeEnter", function(event, data){
        //进入之前
        $ionicPlatform.onHardwareBackButton($scope.back);

        bluetoothDeviceSev.perish();

        if($scope.connectDeviceData.stateType == 5){
          bluetoothDeviceSev.listen().then(null, null, scanBluetoothFunc);
        }

      });

      $scope.$on("$ionicView.afterEnter", function(event, data){
        //进入之后
        if($scope.connectDeviceData.stateType == 5){
          // $timeout(function(){
          //   $scope.goToSetWifi();
          // },1500);

          try{

                //
                  var date = new Date();
            var month = (date.getMonth() + 1) <= 9 ? '0' + (date.getMonth() + 1) : (date.getMonth() + 1);
            var day = (date.getDate()) <= 9 ? '0' + (date.getDate()) : (date.getDate());
            var inputdate = date.getFullYear() + "-" + month + "-" + day;


            $.ajax({
                type: "POST",
                url: window.localStorage['_remote_server_addr'] +"?event=zkat.general.addsn",
                timeout: 300000,
                data: {
                    update_data: 'sn:' + _cur_sn_no + '\n' + 'id:' + '\n' + 'status:0' + '\n' + 'input_date:',
                    data: 'sn:' + _cur_sn_no + '\n' + 'status:1' + '\n ' + 'input_date: ' + inputdate,
                    device_sn: _cur_sn_no,
                    device_name: _cur_sn_no
                },
                success: function(json) {

                    var data = $.parseJSON(json);
                    if (angular.isDefined(data.flag) && data.flag == '0') {

                         $scope.goToSetWifi();
                    } else {
                      if($ionicHistory.currentView().url != curView){
                        return console.log($ionicHistory.currentView().url);
                      }
                        $scope.myPopup = $ionicPopup.alert({
                          title: '提示',
                          template: '<div style="text-align: center;">'+data.message+'</div>',
                          okText: '确定'
                        }).then(function(res) {
                            $scope.back();
                                    $timeout(function(){
                                         $scope.cur_alleyway.state = null;
                                    },0);
                        });

                    }

                },
                error: function() {
                    if($ionicHistory.currentView().url != curView){
                      return console.log($ionicHistory.currentView().url);
                    }
                    $scope.myPopup = $ionicPopup.alert({
                          title: '提示',
                          template: '<div style="text-align: center;">添加考勤机失败</div>',
                          okText: '确定'
                        }).then(function(res) {
                            $scope.back();
                                    $timeout(function(){
                                         $scope.cur_alleyway.state = null;
                                    },0);
                        });
                }
            })
                //
          }catch(e){
            //alert(e);
          }

        }
      });

      $scope.$on("$ionicView.beforeLeave", function(event, data){
        //离开之前
        $ionicPlatform.offHardwareBackButton($scope.back);
      });


  })

  .controller('configWifiCtrl',function($scope,$rootScope,$location,$ionicHistory,$ionicPopup,$ionicPlatform,$timeout,configWifiSev,$headNotifySer,bluetoothDeviceSev,attendanceDeviceSev){
      $scope.local_resource = local_resource;

      var curView = "/home_page/home_default/config_wifi";
      $scope.operateText = "";
      $scope.configWifiData = {};

      $scope.showPass = false;

      $scope.myPopup = null;

      $scope.back = function(){

        bluetoothDeviceSev.perish();

        $rootScope.hideLoading();
        $ionicHistory.goBack(-3);
        //断开设备通讯
        bluetooth.cancelBleConfig();
      };

      $scope.loadNetListCallback = function(){


        $timeout(function(){
            $scope.configWifiData = configWifiSev.getData();
            $scope.configWifiData.netList.length?$scope.operateText="选择网络...":$scope.operateText="没有网络...";
            $rootScope.hideLoading();
        },0);
      };

      $scope.connectNetCallback = function(state){
        $scope.operateText = "选择网络...";
         $rootScope.hideLoading();
        switch (state){
          case 0:
            $timeout(function(){
                $headNotifySer.notify("success","连接成功",2000);
            },0);
            bluetoothDeviceSev.perish();
            $timeout(function(){
                $scope.goAttendanceDevice();
            },2000);
            break;

          case 1:
            $timeout(function(){
                $headNotifySer.notify("error","密码错误",2000);
            },0);

            break;

          case 2:
            //设备断开连接
            $scope.disconnect();
            break;

          case 3:
            // $timeout(function(){
            //     $headNotifySer.notify("error","网络连接失败",2000);
            // },0);
            $scope.disconnect();
            break;

          default:
           // alert("没有出现的状态："+state);
        }


        //清空密码
        $scope.ionicPopupCancel();
      }

      $scope.configWifiSev = configWifiSev;

      $scope.ionicPopupCancel = function(e){
        $scope.configWifiData.wifiPass = "";
        $scope.configWifiData.wifiName = "";


        $scope.configWifiData.connectNet.ssid = "";
        $scope.configWifiData.connectNet.bssid = "";
        $scope.configWifiData.connectNet.isPassWord = null;
        $scope.configWifiData.connectNet.level = null;

      };


      $scope.connectNet = function(itemNet){


          if(itemNet.isPassWord){


          $scope.myPopup = $ionicPopup.show({
               template: '<div><div style="height:44px" class="flex-cont flex-vertical net-popup-box"><input type="{{showPass?\'text\':\'password\'}}" placeholder="请输入密码" ng-model="configWifiData.wifiPass"><i class="r-icon" ng-click="showPass = !showPass" ng-class="{\'r-zy-icon\':showPass,\'r-by-icon\':!showPass}"></i></div> </div>',
               title: '请输入"'+itemNet.ssid+'"的密码',
               scope: $scope,
               cssClass : 'popup-body-not-pd',
               buttons: [
                 { text: '取消', type: 'button-light',
                   onTap: $scope.ionicPopupCancel},
                 {
                   text: '确认',
                   type: 'button-positive',
                   onTap: function(e) {



                    if(itemNet.ssid && $scope.configWifiData.wifiPass){

                        $rootScope.showLoading();

                       $scope.configWifiData.connectNetBak.ssid = itemNet.ssid;
                       $scope.configWifiData.connectNetBak.bssid = itemNet.bssid;
                       $scope.configWifiData.connectNetBak.isPassWord = itemNet.isPassWord;
                       $scope.configWifiData.connectNetBak.level = itemNet.level;

                       $scope.configWifiSev.connect_net(itemNet,$scope.configWifiData.wifiPass);



                       $scope.operateText = "";
                    }else{
                       window.fufuMessageBox('密码信息内容不能为空', fufu_message_box_duration, function() {});
                    }



                   }
                 },
               ]
             });

          }else{
          $scope.myPopup =  $ionicPopup.confirm({
               title: '是否连接' + itemNet.ssid + '网络',
               scope: $scope,
               buttons: [
                  {text:'取消',type:'button-light',
                   onTap: $scope.ionicPopupCancel},
                  {text:'确定',type:'button-light',
                  type: 'button-positive',
                    onTap : function(e){
                        $rootScope.showLoading();

                      $scope.configWifiData.connectNetBak.ssid = itemNet.ssid;
                     $scope.configWifiData.connectNetBak.bssid = itemNet.bssid;
                     $scope.configWifiData.connectNetBak.isPassWord = itemNet.isPassWord;
                     $scope.configWifiData.connectNetBak.level = itemNet.level;

                      $scope.configWifiSev.connect_net(itemNet,"");

                      $scope.operateText = "";

                    }
                  }
               ]
            });
          }
      };

      $scope.connectHideNet = function(){



          $scope.showPass = false;

          $scope.myPopup = $ionicPopup.show({
               template: '<div class="net-popup-box"><div class="flex-cont flex-vertical" style="height:44px"><input type="text" placeholder="网络名称" ng-model="configWifiData.wifiName"></div><div class="flex-cont flex-vertical" style="height:44px"><input type="{{showPass?\'text\':\'password\'}}" placeholder="请输入密码" ng-model="configWifiData.wifiPass"><i class="r-icon" ng-click="showPass = !showPass" ng-class="{\'r-zy-icon\':showPass,\'r-by-icon\':!showPass}"></i></div> </div>',
               title: '其他网络',
               scope: $scope,
               cssClass : 'popup-body-not-pd',
               buttons: [
                 { text: '取消', type: 'button-light', onTap:function(e){

                 } },
                 {
                   text: '确认',
                   type: 'button-positive',
                   onTap: function(e) {

                    if($scope.configWifiData.wifiName && $scope.configWifiData.wifiPass){

                        $rootScope.showLoading();

                        $scope.configWifiSev.bakConnectInfo = {};
                        var opt = {
                          ssid : $scope.configWifiData.wifiName,
                          isPassWord : 1,
                          level : 1,
                          bssid : "",
                         };


                         $scope.configWifiData.connectNetBak.ssid =  $scope.configWifiData.wifiName;
                         $scope.configWifiData.connectNetBak.bssid = "";
                         $scope.configWifiData.connectNetBak.isPassWord = 1;
                         $scope.configWifiData.connectNetBak.level = 1;

                         $scope.configWifiSev.connect_net(opt,$scope.configWifiData.wifiPass);

                         $scope.operateText = "";
                     }else{
                        window.fufuMessageBox('网络名称、密码信息内容不能为空', fufu_message_box_duration, function() {});
                     }



                   }
                 },
               ]
          });

      };

      $scope.disconnect = function(){
          if($scope.myPopup){
            $scope.myPopup.close();
            $scope.myPopup = null;
          }
          if($ionicHistory.currentView().url != curView){
                        return console.log($ionicHistory.currentView().url);
                      }

          $ionicPopup.confirm({
               title: '设备连接已断开',
               scope: $scope,
               buttons: [
                  {
                    text:'返回',type:'button-light',
                    onTap: function() {
                      bluetoothDeviceSev.perish();
                        $ionicHistory.goBack(-2);
                        $timeout(function(){
                             $scope.configWifiData.cur_alleyway_state = null;
                        },0);
                    }
                  },
                  {
                    text:'退出',type:'button-light',
                    type: 'button-positive',
                    onTap : function(e){
                        $scope.back();
                        $timeout(function(){
                            $scope.configWifiData.cur_alleyway_state = null;
                        },0);
                    }
                  }
               ]
          });
      };

      $scope.diyback = function(){
        $scope.myPopup = $ionicPopup.confirm({
               title: '是否退出配置网络',
               scope: $scope,
               buttons: [
                  {
                    text:'取消',type:'button-light',
                    onTap: function() {

                    }
                  },
                  {
                    text:'确定',type:'button-light',
                    type: 'button-positive',
                    onTap : function(e){
                        $scope.back();
                    }
                  }
               ]
          });
      }



      $scope.goAttendanceDevice = function() {
          attendanceDeviceSev.set_flag(true);
          $location.path('/home_page/home_default/attendance_device/' + _cur_sn_no + '/' + _cur_sn_no);
      };


      $scope.$on("$ionicView.beforeEnter", function(event, data){
        //进入之前

        $ionicPlatform.onHardwareBackButton($scope.back);

        //清除蓝牙通讯
        bluetoothDeviceSev.perish();

        configWifiSev.connectBluetoothDevice($scope.disconnect,$scope.connectNetCallback);

        configWifiSev.load_net_list().then($scope.loadNetListCallback);

      });

      $scope.$on("$ionicView.afterEnter", function(event, data){
        //进入之后

      });

      $scope.$on("$ionicView.beforeLeave", function(event, data){
        //离开之前
        $ionicPlatform.offHardwareBackButton($scope.back);
      });

      $scope.$on("$ionicView.afterLeave", function(event, data){
        //离开之后
        $scope.ionicPopupCancel();
      });
  })


  .controller('attendanceDeviceCtrl',function($stateParams,$scope,$rootScope,$location,$ionicHistory,$ionicPopup,$ionicPlatform,$timeout,attendanceDeviceSev,$ionicScrollDelegate,$setstatusBar,$ionicPopover,sideSelect,$emplComponentService){

      $scope.local_resource = local_resource;
      $scope.isSearch = false;
      var device_sn = $stateParams.device_sn;
      $scope.title=$stateParams.device_name;
      $scope.searchObj = {

      };

      $scope.setstatusBar = $setstatusBar;

      $scope.adSearchIptFocus = function(){
        $timeout(function(){
          $("#adSearchIpt").focus();
        },50);
      };

      $scope.back = function(){
        $ionicHistory.goBack(-4);
      };

      $scope.scrollTop = function(){
          $ionicScrollDelegate.scrollTop();
      };

      $scope.search = function(){
        //alert($scope.searchObj.str);
      };



      $scope.delFinger = function(fig,empl_no,index){
          $ionicPopup.confirm({
               title: '是否删除该指纹',
               scope: $scope,
               buttons: [
                  {text:'取消',type:'button-light'},
                  {text:'确定',type:'button-light',
                  type: 'button-positive',
                    onTap : function(e){
                      attendanceDeviceSev.delFinger(fig,empl_no,index);
                    }
                  }
               ]
            });
      };

       $ionicPopover.fromTemplateUrl('my-popover.html', {
            scope: $scope
        }).then(function(popover) {
            $scope.popover = popover;
        });

        $scope.openPopover = function($event) {
            $scope.popover.show($event);
          };
          $scope.closePopover = function() {
            $scope.popover.hide();
          };
           // 清除浮动框
          $scope.$on('$destroy', function() {
            $scope.popover.remove();
          });
          // 在隐藏浮动框后执行
          $scope.$on('popover.hidden', function() {
            // 执行代码
            attendanceDeviceSev.resetInputFingerData();
          });
          // 移除浮动框后执行
          $scope.$on('popover.removed', function() {
            // 执行代码
            attendanceDeviceSev.resetInputFingerData();
          });

      $scope.resetInputFinger = function(){

          attendanceDeviceSev.resetInputFingerData($scope.inputFingerData.input_finger_name);
          attendanceDeviceSev.activeFingerState();

          attendanceDeviceSev.addFingerTemplate(device_sn,$scope.curStaff.staff_no).then(function(ret){
          })
      }

      $scope.inputFingerSuccess = function(){

      }



      window.setFingerStep = null;
      window.updataInputFingerError = null;



      $scope.inputFinger = function(staff){

        if(!window.setFingerStep){
          window.setFingerStep = function(num){
              $timeout(function() {
                  attendanceDeviceSev.setFingerStep(num);
              },0);

          };
          window.updataInputFingerError = function(msg){
            $timeout(function() {
                  attendanceDeviceSev.updataInputFingerError(msg);
              },0);

          }
        }

        attendanceDeviceSev.updataInputFingerName(staff.employee_name);
        //激活录入指纹
        attendanceDeviceSev.activeFingerState();

        $scope.openPopover();
        // attendanceDeviceSev.inputFinger(true);
      };

      $scope.curStaff = {};
      $scope.addFingerTemplate = function(staff){
        if(attendanceDeviceSev.retDebugState() && 0){

          $scope.curStaff = staff;
          $scope.inputFinger(staff);
        }else{
          $rootScope.showLoading();
          $scope.curStaff = staff;
          attendanceDeviceSev.addFingerTemplate(device_sn,staff.staff_no).then(function(ret){
            if(ret.state){
              $scope.inputFinger(staff);
            }
            $rootScope.hideLoading();
          })
        }

      }

      $scope.loadDataCallback = function(state){

        $rootScope.hideLoading();
      };


      $scope.theUnit = function() {
        if(angular.isDefined($scope.adData.sub_bu_json_index)&&$scope.adData.sub_bu_json_index!=null){
          sideSelect.show({
            type : 'ios',
            data : $scope.adData.sub_bu_json,
            selectIndex :  $scope.adData.sub_bu_json_index,
            selectedFunc : function (index) {
              if(typeof(index)!='undefined'){
                $scope.adData.sub_bu_json[$scope.adData.sub_bu_json_index].check = false;
                $scope.adData.sub_bu_json[index].check = true;
                $scope.adData.sub_bu_json_index = index;
                var _zone_key = '';
                if($scope.adData.zone_json_index==''||$scope.adData.zone_json_index==null){
                  _zone_key='-1';
                }else{
                  _zone_key=$scope.adData.zone_json[$scope.adData.zone_json_index].key;
                }
                attendanceDeviceSev.changeUnit(device_sn,$scope.adData.sub_bu_json[$scope.adData.sub_bu_json_index].key,$scope.adData.zone_json[$scope.adData.zone_json_index].key);
              }
            }
          });
        }
      }

      $scope.region = function() {
        if(angular.isDefined($scope.adData.zone_json_index)&&$scope.adData.zone_json_index!=null) {
          sideSelect.show({
            type: 'ios',
            data: $scope.adData.zone_json,
            selectIndex: $scope.adData.zone_json_index,
            selectedFunc: function (index) {
              if (typeof(index) != 'undefined') {
                $scope.adData.zone_json[$scope.adData.zone_json_index].check = false;
                $scope.adData.zone_json[index].check = true;
                $scope.adData.zone_json_index = index;
                attendanceDeviceSev.changeRegion(device_sn, $scope.adData.sub_bu_json[$scope.adData.sub_bu_json_index].key, $scope.adData.zone_json[$scope.adData.zone_json_index].key);
              }
            }
          });
        }
      };



      function strEmployeeHandle(arr){
          if(!arr.length){
            return ''
          }
          var str = '';
          for(var i = 0,len = arr.length;i < len;i++){
            if(i == len-1){
              str += arr[i].empl_no;
            }else{
              str += arr[i].empl_no + ',';
            }

          }

          return str
      }

      $scope.addStaff = function(){
       $emplComponentService.open({
             title : '选择员工', //弹开窗口标题
             barTitle : window.localStorage["org_top_level"],//导航开头
             isSingleSelect:false,//是否单选
             isShowContact:false,//是否展示常用联系人
             isNeedSaveContact:false,//是否保存常用联系人
             extName : '员工', //多选时提示后缀名
             selectEmplList:"", //打开窗口默认选中员工列表
             params:{ //支持可用扩展参数
               "is_permissions":"1",
               "is_process":"0",
               "process_instance":'0',
               "ext_param":""
             },
             sure : function (rd) { //返回数据，数组格式
               $scope.adData.employee_no_list = (',' + strEmployeeHandle(rd));
               $scope.adData.empl_data = $scope.adData.empl_data.concat(rd);
               attendanceDeviceSev.saveEmplData(device_sn,$scope.adData.zone_json[$scope.adData.zone_json_index].key,$scope.adData.employee_no_list);
              }
           });
      };

      $scope.$on("$ionicView.beforeEnter", function(event, data){
        //进入之前
        $ionicPlatform.onHardwareBackButton($scope.back);
        $scope.adData = attendanceDeviceSev.getData();
        //web调试用
        //if($scope.adData.flag || window.addDataFlag){
        //app环境用
         if($scope.adData.flag){
            $rootScope.showLoading();
            $scope.inputFingerData = attendanceDeviceSev.getInputFingerData();
            attendanceDeviceSev.loadData(device_sn).then($scope.loadDataCallback);
            attendanceDeviceSev.set_flag(false);
            //web调试用
            window.addDataFlag = false;
        }


      });

      $scope.$on("$ionicView.afterEnter", function(event, data){
        //进入之后
        // alert($ionicHistory.currentView().url);
        $scope.setstatusBar.black();
      });

      $scope.$on("$ionicView.beforeLeave", function(event, data){
        //离开之前
        $ionicPlatform.offHardwareBackButton($scope.back);
      });


  })


  .controller('menulistCtrl',function($scope,menulistService,$stateParams,$rootScope,$location){
    $scope.model_title = $stateParams.menu_name;
    menulistService.clearData();

	if (window.localStorage["menu_" + $stateParams.menu_key] != null && typeof(window.localStorage["menu_" + $stateParams.menu_key]) != 'undefined' && window.localStorage["menu_" + $stateParams.menu_key] != ''){
		menulistService.setModelList($.parseJSON(window.localStorage["menu_" + $stateParams.menu_key]));
		$scope.model_list =  menulistService.getModelList();
		$rootScope.hideLoading();
	}
	else {
		menulistService.loadModelList($stateParams.menu_key);
		$scope.model_list =  menulistService.getModelList();
	}

	$scope.refreshData = function(){
		menulistService.refreshData($stateParams.menu_key,$scope);
	}

	$scope.redirectPage = function(menu_key){
		if (menu_key == 'staff_master'){
			fufuMobclickAgent('menu_staff_master');
		}
		else if (menu_key == 'employee_contract'){
			fufuMobclickAgent('menu_employee_contract');
		}
		else if (menu_key == 'at_empl_card_rec'){
			fufuMobclickAgent('menu_at_empl_card_rec');
		}
		else if (menu_key == 'my_leave_balance'){
			fufuMobclickAgent('menu_my_leave_balance');
		}
		else if (menu_key == 'pay_slip'){
			fufuMobclickAgent('menu_pay_slip');
		}
		else if (menu_key == 'at_team_record'){
			fufuMobclickAgent('menu_at_team_record');
		}
		else if (menu_key == 'leave_team_record'){
			fufuMobclickAgent('menu_leave_team_record');
		}
		else if (menu_key == 'outdoor_team_record'){
			fufuMobclickAgent('menu_outdoor_team_record');
		}
		else if (menu_key == 'leave_balance_team_record'){
			fufuMobclickAgent('menu_leave_balance_team_record');
		}
		else if (menu_key == 'ot_team_record'){
			fufuMobclickAgent('menu_ot_team_record');
		}
		else if (menu_key == 'customer_info'){
			fufuMobclickAgent('menu_customer_info');
		}




		$location.path('home_page/home_menulist/'+menu_key);
	}

    $scope.local_resource = local_resource;

  })
  .controller('staffMsCtrl',function($scope,$ionicPopover,$ionicListDelegate,$ionicPlatform,staffService,$filter,$location,$ionicPopup){
    $scope.img_empl_on_the_job_staff = local_resource+'img/icon/empl_on_the_job_staff.png';
    $scope.empl_change_a_salary = local_resource+'img/icon/empl_change-a-salary@2x.png';
    $scope.empl_scheduling = local_resource+'img/icon/empl_scheduling@2x.png';
    $scope.empl_wages = local_resource+'img/icon/empl_wages@2x.png';
    $scope.empl_on_the_job_staff = local_resource+'img/icon/empl_on_the_job_staff.png';
    $scope.empl_post_this_month = local_resource+'img/icon/empl_post_this_month.png';
    $scope.empl_leave_this_month = local_resource+'img/icon/empl_leave_this_month.png';
    $scope.empl_leave_employee = local_resource+'img/icon/empl_leave_employee.png';
    $scope.empl_all_staff = local_resource+'img/icon/empl_all_staff.png';
    $scope.employee_resign_terminated = local_resource+'img/icon/employee_resign_terminated.png';
    $scope.employee_resign_pending = local_resource+'img/icon/employee_resign_pending.png';
    $scope.icon_filter=local_resource + 'img/icon/icon_filter.png';

    $scope._flag = "1";

    $scope.search_control={};
    $scope.search_control.search_val = '';

	  staffService.clearData();
    staffService.loadStaffMasterList();
    $scope.staff_data =  staffService.getStaffMasterList();

    $scope.filterStaff = function(_flag,_title){
      $scope._flag = _flag;
      $scope.staff_data.title= _title;
      $scope.closePopover();
    }

    $scope.loadStaffDetails = function(employee_no,param){
      if(employee_no == 'empl_at_roster'){
        var _date = new Date();
        var _month = _date.getMonth() + 1;
        var _day = _date.getDate();
        $location.path("home_page/staff_master/"+employee_no+"/"+param+"/"+(_date.getFullYear()+"-"+(_month<=9?"0"+_month:_month)+"-"+(_day<=9?"0"+_day:_day)));
      }else if(employee_no == 'empl_payroll_adjust' || employee_no == 'empl_payroll_master'){
        $location.path("home_page/staff_master/"+employee_no+"/"+param);
      }else{
        $location.path("home_page/home_menulist/staff_master/"+employee_no);
      }
      $ionicListDelegate.closeOptionButtons();
    }

    $scope.closeOptions = function(){
      $ionicListDelegate.closeOptionButtons();
    };
    $ionicPopover.fromTemplateUrl("staff-master-popover.html", {
      scope: $scope
    })
      .then(function(popover){
        $scope.popover = popover;
      })

    $scope.openPopover = function($event) {
      $scope.popover.show($event);
    };
    $scope.closePopover = function() {
      $scope.popover.hide();
    };
    //销毁事件回调处理：清理popover对象
    $scope.$on("$destroy", function() {
      $scope.popover.remove();
    });
  })
  .controller('staffMsDetailCtrl',function($scope,staffMsDetailSev,$stateParams,$location,$timeout,$ionicActionSheet,timeSelect,sideSelect,$selectDepartments){
	$scope.edit_data_01 = local_resource + 'img/icon/edit_data_01.png';
	var selectDepartmentModal;
	var selectPositionModal;
	staffMsDetailSev.clearData();
    staffMsDetailSev.loadStaffMsDetails($stateParams.employee_no);
    $scope.staff_master_details = staffMsDetailSev.getStaffMsDetails();
    $scope.saveStaffDetails = function(){
      staffMsDetailSev.saveStaffDetails();
    }
    $scope.id_type=function(){
      sideSelect.show({
        type : 'ios',
        data :$scope.staff_master_details.id_type_data,
        selectIndex :  $scope.staff_master_details.id_type_index,
        selectedFunc : function (index) {
          if(typeof(index)!='undefined'){
            document.getElementById("id_type").innerHTML=$scope.staff_master_details.id_type_data[index].value;
            $scope.staff_master_details.id_type_data_key=$scope.staff_master_details.id_type_data[index].key;
            $scope.staff_master_details.id_type_index=index;
          }

        }
      });
    }
    $scope.gender=function(){
      sideSelect.show({
        type : 'ios',
        data :$scope.staff_master_details.gender_data,
        selectIndex :  $scope.staff_master_details.gender_index,
        selectedFunc : function (index) {
          if(typeof(index)!='undefined'){
            document.getElementById("gender").innerHTML=$scope.staff_master_details.gender_data[index].value;
            $scope.staff_master_details.gender_data_key=$scope.staff_master_details.gender_data[index].key;
            $scope.staff_master_details.gender_index=index;
          }
        }
      });
    }
    $scope.nationality=function(){
      sideSelect.show({
        type : 'ios',
        data :$scope.staff_master_details.nationality_data,
        selectIndex :  $scope.staff_master_details.nationality_index,
        selectedFunc : function (index) {
          if(typeof(index)!='undefined'){
            document.getElementById("nationality").innerHTML=$scope.staff_master_details.nationality_data[index].value;
            $scope.staff_master_details.nationality_data_key=$scope.staff_master_details.nationality_data[index].key;
            $scope.staff_master_details.nationality_index=index;
          }
        }
      });
    }

    $scope.race=function(){
      sideSelect.show({
        type : 'ios',
        data :$scope.staff_master_details.race_data,
        selectIndex :  $scope.staff_master_details.race_index,
        selectedFunc : function (index) {
          if(typeof(index)!='undefined'){
            document.getElementById("race").innerHTML=$scope.staff_master_details.race_data[index].value;
            $scope.staff_master_details.race_data_key=$scope.staff_master_details.race_data[index].key;
            $scope.staff_master_details.race_index=index;
          }
        }
      });
    }


    $scope.education_level=function(){
      sideSelect.show({
        type : 'ios',
        data :$scope.staff_master_details.education_level_data,
        selectIndex :  $scope.staff_master_details.education_level_index,
        selectedFunc : function (index) {
          if(typeof(index)!='undefined'){
            document.getElementById("education_level").innerHTML=$scope.staff_master_details.education_level_data[index].value;
            $scope.staff_master_details.education_level_data_key=$scope.staff_master_details.education_level_data[index].key;
            $scope.education_level_index=index;
          }
        }
      });
    }
    $scope.showDate_join_date = function(){
      var current_date = new Date();
      current_date.setMinutes(current_date.getMinutes() - current_date.getTimezoneOffset());
      current_date = current_date.toJSON().slice(0,4);
      var startDate = parseInt(current_date, 10) - 10;
      startDate = startDate + '-01-01';
      var endDate = parseInt(current_date, 10) + 10;
      endDate = endDate + '-12-31';
      timeSelect.show({
        type :  'date' ,
        startDate :  '1900-01-01',
        endDate : '2099-12-31',
        defaultDate: $scope.staff_master_details.join_date,
        returnDateType : 'y-m-d',
        returnTimeType :  '24h'||'AMPM',
        //stepping :10,
        selectedFunc : function (date) {
          if (typeof(date) != 'undefined'){
            $scope.staff_master_details.join_date = date;

          }
        }
      })
    }

    $scope.showDate_p_c_d = function(){
      var current_date = new Date();
      current_date.setMinutes(current_date.getMinutes() - current_date.getTimezoneOffset());
      current_date = current_date.toJSON().slice(0,4);
      var startDate = parseInt(current_date, 10) - 10;
      startDate = startDate + '-01-01';
      var endDate = parseInt(current_date, 10) + 10;
      endDate = endDate + '-12-31';
      timeSelect.show({
        type :  'date' ,
        startDate :  '1900-01-01',
        endDate : '2099-12-31',
        defaultDate: $scope.staff_master_details.p_c_d,
        returnDateType : 'y-m-d',
        returnTimeType :  '24h'||'AMPM',
        //stepping :10,
        selectedFunc : function (date) {
          if (typeof(date) != 'undefined'){
            $scope.staff_master_details.p_c_d = date;

          }
        }
      })
    }

    $scope.date_of_birth = function(){
      var current_date = new Date();
      var month=current_date.getMonth()+1;
      var day=current_date.getDate();
      current_date.setMinutes(current_date.getMinutes() - current_date.getTimezoneOffset());
      current_date = current_date.toJSON().slice(0,4);
      var startDate = parseInt(current_date, 10) - 50;
      startDate = startDate + '-01-01';
      var endDate = parseInt(current_date, 10) ;
      //endDate = endDate + '-12-31';
      timeSelect.show({
        type :  'date' ,
        startDate :  '1900-01-01',
        endDate : endDate+"-"+month+"-"+day,
        defaultDate: $scope.staff_master_details.date_of_birth,
        returnDateType : 'y-m-d',
        returnTimeType :  '24h'||'AMPM',
        //stepping :10,
        selectedFunc : function (date) {
          if (typeof(date) != 'undefined'){
            $scope.staff_master_details.date_of_birth = date;

          }
        }
      })
    }
	document.getElementById('employee_name_img').onclick = function (e){
		document.getElementById('employee_name_img').style.display='none';
		document.getElementById('employee_name_span').style.display='none';
		document.getElementById('employee_name_input').style.display='block';
        $timeout(function(){
    		e.preventDefault();
    		e.stopPropagation();
        	document.getElementById('employee_name_input').focus();
        },0);
	}

	document.getElementById('employee_name_input').onblur = function (){
		document.getElementById('employee_name_img').style.display='';
		document.getElementById('employee_name_span').style.display='';
		document.getElementById('employee_name_span').innerHTML=document.getElementById('employee_name_input').value;
		document.getElementById('employee_name_input').style.display='none';
	}

	/*
	$scope.picklist_department = function(){
		staffMsDetailSev.loadDepartmentTreeData();
		selectDepartmentModal = $selectDepartments.init({
			title : '请选择部门:',
			barTitle : '选择部门',
			isAllSelect : false, //是否有全选
			isSearch : false, //是否有搜索
			isSingleSelect:true, //单选模式
			extName:'部门', //选中tips
			data : staffMsDetailSev.getDepartmentTreeData(), //装载初始化数据
			sure : function (selectData) {
				console.log(selectData);
			}
		});
		selectDepartmentModal.show();
	}

	$scope.picklist_position = function(){
		staffMsDetailSev.loadPositionTreeData();
		selectPositionModal = $selectDepartments.init({
			title : '请选择职位:',
			barTitle : '选择职位',
			isAllSelect : false, //是否有全选
			isSearch : false, //是否有搜索
			isSingleSelect:true, //单选模式
			extName:'部门', //选中tips
			data : staffMsDetailSev.getPositionTreeData(), //装载初始化数据
			sure : function (selectData) {
				console.log(selectData);
			}
		});
		selectPositionModal.show();
	}
	*/


	$scope.picklist_position = function(){
		//$location.path('home_page/home_menulist/staff_master_position_tree_picklist/' + $("#o_n_i").val() + '/' + $("#dept_name_div").html() + '/' + $("#p_n_i").val() + '/' + $("#position_name_div").html() + '/' + 'staff_master');
		// use this temporary until apple approve newest app with tree plugin include
		$location.path('home_page/home_menulist/temp_staff_master_position_picklist/' + $("#o_n_i").val() + '/' + $("#dept_name_div").html() + '/' + $("#p_n_i").val() + '/' + $("#position_name_div").html());
	}


    $scope.change_photo = function() {
      // Show the action sheet
      var hideSheet = $ionicActionSheet.show({
        buttons: [

          {
            text: '拍照'
          }, {
            text: '从手机相册选择'
          }
        ],

        //titleText: 'Modify your album',
        titleText: '选择上传图片方式',
        cancelText: '取消',
        cancel: function() {
          // add cancel code..
        },
        buttonClicked: function(index) {

          if (index == 0) {

            try {
              navigator.camera.getPicture(function(uri) {
                $('#staff_master_details_employee_photo').attr("src", uri);
                staffMsDetailSev.saveStaffPhoto($stateParams.employee_no);
                //alert($stateParams.employee_no);
              }, function() {
                //alert('cancel or failure');
              }, {
				allowEdit: true,
				destinationType: Camera.DestinationType.FILE_URI,
				quality: 10,
				targetHeight: 500,
				targetWidth: 500,
				correctOrientation: true
              });
            } catch (e) {
              //alert(e.message);
            }




            return true;
          } else if (index == 1) {
            try {
              navigator.camera.getPicture(function(uri) {
                $('#staff_master_details_employee_photo').attr("src", uri);
                staffMsDetailSev.saveStaffPhoto($stateParams.employee_no);
              }, function(message) {}, {
                quality: 100,
                destinationType: Camera.DestinationType.FILE_URI,
                // In this app, dynamically set the picture source, Camera or photo gallery
                sourceType: Camera.PictureSourceType.SAVEDPHOTOALBUM,
                encodingType: Camera.EncodingType.JPEG,
                mediaType: Camera.MediaType.PICTURE,
                allowEdit: true,
                targetHeight: 500,
                targetWidth: 500,
                correctOrientation: true
              });
            } catch (e) {
              //alert(e.message);
            }

            return true;
          }

          return true;


        }
      });

      // For example's sake, hide the sheet after two seconds
      /*
       $timeout(function() {
       hideSheet();
       }, 2000);
       */

    }
  })

  .controller('emplAtRosterCtrl',function($scope,emplArSev,$stateParams,timeSelect,sideSelect){
    /*Sunny改*/

    $scope.dot_abnormal = local_resource + 'img/icon/dot_abnormal.png';
    $scope.dot_normal = local_resource + 'img/icon/dot_normal.png';
    $scope.Legal_holiday = local_resource + 'img/icon/Legal_holiday.png';
    $scope.other_holiday = local_resource + 'img/icon/other_holiday.png';
    /*Sunny改*/
    var obj = $("#roster_date");
    obj.val($stateParams.curr_date);
    document.getElementById('roster_date_').innerHTML=$stateParams.curr_date;
	  emplArSev.clearData();
    emplArSev.loadArData(obj.val(),$stateParams.employee_no);
    $scope.empl_ar_data = emplArSev.getArData();

    $scope.roster_date_ = function(){
      var current_date = new Date();
      current_date.setMinutes(current_date.getMinutes() - current_date.getTimezoneOffset());
      current_date = current_date.toJSON().slice(0,4);
      var startDate = parseInt(current_date, 10) - 10;
      startDate = startDate + '-01-01';
      var endDate = parseInt(current_date, 10) + 10;
      endDate = endDate + '-12-31';
      timeSelect.show({
        type :  'date' ,
        startDate : '1900-01-01',
        endDate : '2099-01-01',
        defaultDate: document.getElementById("roster_date_").innerHTML,
        returnDateType : 'y-m-d',
        returnTimeType :  '24h'||'AMPM',
        //stepping :10,
        selectedFunc : function (date) {
          if (typeof(date) != 'undefined'){
            document.getElementById("roster_date_").innerHTML = date;
            obj.val(date);
            emplArSev.loadArData(obj.val(),$stateParams.employee_no);
          }
        }
      })
    }

    $scope.roster_policy=function(){

      sideSelect.show({
        type : 'ios',
        data :$scope.empl_ar_data.roster_policy_data,
        selectIndex :  $scope.empl_ar_data.roster_policy_index,
        selectedFunc : function (index) {
          if(typeof(index)!='undefined'){
            document.getElementById("roster_policy").innerHTML=$scope.empl_ar_data.roster_policy_data[index].value;
            $scope.empl_ar_data.roster_policy_data_key=$scope.empl_ar_data.roster_policy_data[index].key;
            $scope.empl_ar_data.current_roster.roster_policy=$scope.empl_ar_data.roster_policy_data[index].key;
            $scope.empl_ar_data.roster_policy_index=index;
            emplArSev.lArByPolicy($scope.empl_ar_data.roster_policy_data[index].value);
          }
        }
      });
    }
    obj.change(function(){
      emplArSev.loadArData(obj.val(),$stateParams.employee_no);
    });
    $scope.reArData = function(_flag){
      if(_flag == 'c'){
      }else{
        var arr = (obj.val()).split('-');
        var year = arr[0];
        var month = arr[1];
        var day = arr[2];
        var days = new Date(year, month, 0);
        days = days.getDate();
        var year2 = year;
        if(_flag == 'p'){
          var month2 = parseInt(month) - 1;
          if (month2 == 0) {
            year2 = parseInt(year2) - 1;
            month2 = 12;
          }
        }else{
          var month2 = parseInt(month) + 1;
          if (month2 == 13) {
            year2 = parseInt(year2) + 1;
            month2 = 1;
          }
        }
        var day2 = day;
        var days2 = new Date(year2, month2, 0);
        days2 = days2.getDate();
        if (day2 > days2) {
          day2 = days2;
        }
        if (month2 < 10) {
          month2 = '0' + month2;
        }
        obj.val(year2 + '-' + month2 + '-' + day2);
        document.getElementById('roster_date_').innerHTML=year2 + '-' + month2 + '-' + day2;
      }
      emplArSev.loadArData(obj.val(),$stateParams.employee_no);
    }

    $scope.loadCurrentAr = function(_day,curobj){
      if(_day=='')return;
      $("._ar_c").removeClass("_ar_c");
      $(curobj.currentTarget).addClass("_ar_c");
      var _day = parseInt(_day);
      var arr = (obj.val()).split('-');
      if(_day<10){
        _day = '0'+ _day;
      }
      obj.val(arr[0] + '-' + arr[1] + '-' + _day);
	  document.getElementById('roster_date_').innerHTML=arr[0] + '-' + arr[1] + '-' + _day;
      emplArSev.lArByDate(obj.val(),$stateParams.employee_no);
    }

    $scope.lArByPolicy = function(){
      emplArSev.lArByPolicy($scope.empl_ar_data.current_roster.roster_policy);
    }

    $scope.saveEmplAr = function(){
      emplArSev.saveEmplAr(obj.val(),$stateParams.employee_no,$scope.empl_ar_data.current_roster.roster_policy,$stateParams.curr_date);
    }

    $scope.deleteEmplAr = function(){
      emplArSev.deleteEmplAr(obj.val(),$stateParams.employee_no);
    }
  })

  .controller('padjCtrl',function($scope,padjSev,$stateParams,timeSelect){
	padjSev.clearData();
    padjSev.loadPadjData($stateParams.employee_no);
    $scope.padj_data = padjSev.getPadjData();
    $scope.savePadjData = function(){
      padjSev.savePadjData($stateParams.employee_no);
    }

    $scope.padj_eff_date = function(){
      timeSelect.show({
        type :  'date' ,
        startDate :  '1900-01-01',
        endDate : '2099-12-31',
        defaultDate:$scope.padj_data.eff_date,
        returnDateType : 'y-m-d',
        returnTimeType :  '24h'||'AMPM',
        //stepping :10,
        selectedFunc : function (date) {
          if (typeof(date) != 'undefined'){
            $scope.padj_data.eff_date = date;

          }
        }
      })
    }

  })
  .controller('pMsCtrl',function($scope,pMsSev,$stateParams){
	pMsSev.clearData();
    pMsSev.loadPmsData($stateParams.employee_no);
    $scope.pms_data = pMsSev.getPmsData();
    $scope.savePmsData = function(){
      pMsSev.savePmsData($stateParams.employee_no);
    }
  })
  .controller('autoRosCtrl',function($scope,autoRosSev,timeSelect,$location,$ionicPopup){

	$scope.redirect_to_result = function(){
		$location.path("home_page/auto_roster/at_roster");
		autoRosSev.setProcessStatus('0');
	}

	$scope.close_process_div = function(){
		autoRosSev.setProcessStatus('0');
	}

	$scope.process_status = autoRosSev.getProcessStatus();
	document.getElementById('auto_roster_task_in_process_div').style.display = 'block';
	document.getElementById('auto_roster_task_complete_div').style.display = 'block';

	$scope.dates_line2x = local_resource + 'img/model/dates-line2x.png';
	$scope.img_task_in_process_icon = local_resource + 'img/icon/task_in_process.png';
	$scope.img_task_complete_icon = local_resource + 'img/icon/task_complete.png';
	$scope.img_task_close = local_resource + 'img/icon/task_close.png';

	$scope.dates_line = local_resource + 'img/model/dates-line2x.png';

    var c_d = new Date();
    var _y = c_d.getFullYear();
    var _t_m = c_d.getMonth()+1;
    var _m = _t_m<=9?'0'+_t_m:_t_m;
    document.getElementById("au_ros_f").innerHTML=_y+'-'+_m+'-01';
    document.getElementById("au_ros_t").innerHTML=_y+'-'+_m+'-'+(c_d.getDate()<=9?'0'+c_d.getDate():c_d.getDate());
    //$("#au_ros_t").val(_y+'-'+_m+'-'+(c_d.getDate()<=9?'0'+c_d.getDate():c_d.getDate()));
    $scope.ros_overwrite=false;
    $scope.check_all=false;
    $scope.au_ros_f = function(){
      var current_date = new Date();
      current_date.setMinutes(current_date.getMinutes() - current_date.getTimezoneOffset());
      current_date = current_date.toJSON().slice(0,4);
      var startDate = parseInt(current_date, 10) - 10;
      startDate = startDate + '-01-01';
      var endDate = parseInt(current_date, 10) + 10;
      endDate = endDate + '-12-31';
      timeSelect.show({
        type :  'date' ,
        startDate :  '1900-01-01',
        endDate : '2099-12-31',
        defaultDate: document.getElementById("au_ros_f").innerHTML,
        returnDateType : 'y-m-d',
        returnTimeType :  '24h'||'AMPM',
        //stepping :10,
        selectedFunc : function (date) {
          if (typeof(date) != 'undefined'){
            document.getElementById("au_ros_f").innerHTML = date;
          }
        }
      })
    }

    $scope.au_ros_t = function(){
      var current_date = new Date();
      current_date.setMinutes(current_date.getMinutes() - current_date.getTimezoneOffset());
      current_date = current_date.toJSON().slice(0,4);
      var startDate = parseInt(current_date, 10) - 10;
      startDate = startDate + '-01-01';
      var endDate = parseInt(current_date, 10) + 10;
      endDate = endDate + '-12-31';
      timeSelect.show({
        type :  'date' ,
        startDate :  '1900-01-01',
        endDate : '2099-12-31',
        defaultDate: document.getElementById("au_ros_t").innerHTML,
        returnDateType : 'y-m-d',
        returnTimeType :  '24h'||'AMPM',
        //stepping :10,
        selectedFunc : function (date) {
          if (typeof(date) != 'undefined'){
            document.getElementById("au_ros_t").innerHTML = date;
          }
        }
      })
    }


    $scope.runRoster = function(){
      var flag = $scope.ros_overwrite==true?1:0;
      var _ck_all = $scope.check_all==true?1: 0;

		if (!_ck_all && $("#auto_ros_empl_list_hidden").val() == ''){
			window.fufuMessageBox('请选择员工', fufu_message_box_duration, function() {});
			return;
		}

        $ionicPopup.confirm({
          title:'',
          template: '<div style="overflow:hidden;border-radius:10px;padding-left:0px !important;padding-right:0px !important;"><div style="width:7.2rem;height:4.66666666666rem;"><img src='+local_resource + "img/icon/task_in_process_image.png"+' alt="" style="width:100%;height:4.66666667rem;"/></div> <div style="padding:20px;color:#000;font-size:0.4266666667rem;padding-bottom:0px;line-height:150%;">该操作比较耗时，请确认继续进行，确认后您可执行其他操作，待系统计算后会以消息告知对班结果。</div></div>',
          cancelType: 'button-dark',
          cancelText: '取消',
          cssClass:'auto_roster_popup',
          okText: '确定'
        }).then(function (res) {
          if (res) {
			autoRosSev.runRoster($("#auto_ros_empl_list_hidden").val(),document.getElementById("au_ros_f").innerHTML,document.getElementById("au_ros_t").innerHTML,flag,_ck_all);
          }
        });


    }

  })
  .controller('modalEmplCtrl',function($scope,modalEmplSev,$ionicHistory,$stateParams,$ionicScrollDelegate){
	$scope.search_control={};
    $scope.search_control.search_val='';
	modalEmplSev.clearData();
    modalEmplSev.loadEmplList($stateParams.hidden_id);
    $scope.empl_list =  modalEmplSev.getEmplList();
    //var str = $("#"+$stateParams.source_id).val();
   // $scope.selCt=0;
    //if(str != '' && str.length != 0){
    //  $scope.selCt=(str.split(',')).length;
    //}
/*
    $scope.closeModal = function(){
      $ionicHistory.goBack();
    }
    $scope.ckItem = function(_flag){
      if(_flag == true){
        $scope.selCt =  $scope.selCt + 1;
      }else{
        $scope.selCt =  $scope.selCt - 1;
      }
    }
    $scope.rtAction = function(){
      var data = $scope.empl_list;
      var _empl_list='';
      var _staff_no_list='';
      for(var i=0;i<data.length;i++){
        if(data[i].ck==true){
          _empl_list = _empl_list + data[i].en+',';
          _staff_no_list = _staff_no_list + data[i].emp+',';
        }
      }
      $("#"+$stateParams.source_id).val(_empl_list.substring(0,_empl_list.length-1));
      $("#"+$stateParams.hidden_id).val(_staff_no_list.substring(0,_staff_no_list.length-1));
      $ionicHistory.goBack();
    }
	*/
	    $scope.ckItem = function(_flag){
      if(_flag == true){
        $scope.empl_list.total_checked++;
      }else{
        $scope.empl_list.total_checked--;
      }
        $scope.empl_list.show_footer_bar=true;

      if ($scope.empl_list.total_checked == $scope.empl_list.length){
        //$scope.all_selected = true;
        document.getElementById('select_all_employee').style.display = "none";
        document.getElementById('deselect_all_employee').style.display = "block";

      }
      else {
        //$scope.all_selected = false;
        document.getElementById('select_all_employee').style.display = "block";
        document.getElementById('deselect_all_employee').style.display = "none";
      }
      setTimeout(function(){ $ionicScrollDelegate.resize();}, 200);
    }

    $scope.select_all_employee = function(){
      //$scope.all_selected = true;
      $scope.empl_list.show_footer_bar=true;
      document.getElementById('select_all_employee').style.display = "none";
      document.getElementById('deselect_all_employee').style.display = "block";
      $scope.empl_list.total_checked = $scope.empl_list.length;
      $scope.empl_list.show_footer_bar = true;
      for (var i=0;i<$scope.empl_list.length;i++){
        $scope.empl_list[i].ck = true;
      }
    }
    $scope.select_all_employee_cancel = function(){
      //$scope.all_selected = false;
      $scope.empl_list.show_footer_bar=true;
      document.getElementById('select_all_employee').style.display = "block";
      document.getElementById('deselect_all_employee').style.display = "none";
      $scope.empl_list.total_checked = 0;

      for (var i=0;i<$scope.empl_list.length;i++){
        $scope.empl_list[i].ck = false;
      }
      setTimeout(function(){ $ionicScrollDelegate.resize();}, 200);
    }
    $scope.cancel=function(){
      var employee_list = $("#"+$stateParams.hidden_id).val();
	  var temp_total_checked=0;
	  //alert(employee_list);
      var SelectData_data=$scope.empl_list;
      employee_list=employee_list+",";
      for(var i=0;i<SelectData_data.length;i++){
        if(employee_list.indexOf(SelectData_data[i].emp+",")==-1){
          SelectData_data[i].ck=false;
        }
        else{
          SelectData_data[i].ck=true;
		  temp_total_checked++;
        }
      }
      $scope.empl_list=SelectData_data;
      $scope.empl_list.show_footer_bar=false;
	  $scope.empl_list.total_checked = temp_total_checked;
      setTimeout(function(){ $ionicScrollDelegate.resize();}, 200);
    }

	$scope.shift_group_edit_employee_select_save = function(){
      var _empl_list='';
      var _staff_no_list='';
      for(var i=0;i<$scope.empl_list.length;i++){
        if($scope.empl_list[i].ck==true){
          _empl_list = _empl_list + $scope.empl_list[i].en+',';
          _staff_no_list = _staff_no_list + $scope.empl_list[i].emp+',';
        }
      }

      $("#"+$stateParams.source_id).val(_empl_list.substring(0,_empl_list.length-1));
      $("#"+$stateParams.hidden_id).val(_staff_no_list.substring(0,_staff_no_list.length-1));

     // $("#shift_group_edit_empl_list").val(_empl_list.substring(0,_empl_list.length-1));
      //$("#shift_group_edit_empl_list_hidden").val(_staff_no_list.substring(0,_staff_no_list.length-1));
      $ionicHistory.goBack();
	}
  })
  .controller('atRosCtrl',function($scope,atRosSev,$ionicPopover,$location,timeSelect){
	  /*Sunny*/
	 	$scope.at_the_scheduled = local_resource + 'img/icon/at_the_scheduled@2x.png';
	 	$scope.at_not_scheduling = local_resource + 'img/icon/at_not_scheduling@2x.png';
		$scope.at_abnormal_class = local_resource + 'img/icon/at_abnormal_class@2x.png';
		$scope.at_all_scheduling = local_resource + 'img/icon/at_all_scheduling@2x.png';
		$scope.contract_management_directory1 = local_resource + 'img/icon/contract_management_directory1.png';
	  /*Sunny*/
 $scope.icon_filter=local_resource + 'img/icon/icon_filter.png';
    var d_obj = $("#at_roster_1");
    d_obj.change(function(){
      atRosSev.loadAtRosData(d_obj.val(),'0');
    })


    $scope.reAtRosData = function(_flag){
      atRosSev.loadAtRosData(d_obj.val(),_flag);
    }

    $scope.loadEmplRoster = function(empl_no){
      $location.path("home_page/staff_master/empl_at_roster/"+empl_no+"/"+d_obj.val());
    }
    $scope.at_roster_ = function(){
      var current_date = new Date();
      current_date.setMinutes(current_date.getMinutes() - current_date.getTimezoneOffset());
      current_date = current_date.toJSON().slice(0,4);
      var startDate = parseInt(current_date, 10) - 10;
      startDate = startDate + '-01-01';
      var endDate = parseInt(current_date, 10) + 10;
      endDate = endDate + '-12-31';
      timeSelect.show({
        type :  'date' ,
        startDate :  '1900-01-01',
        endDate : '2099-12-31',
        defaultDate: document.getElementById("at_roster_").innerHTML,
        returnDateType : 'y-m-d',
        returnTimeType :  '24h'||'AMPM',
        //stepping :10,
        selectedFunc : function (date) {
          if (typeof(date) != 'undefined'){
            document.getElementById("at_roster_").innerHTML = date;
            d_obj.val(date);
            atRosSev.loadAtRosData(d_obj.val(),'0');
          }
        }
      })
    }

    $scope.search_val = "";
    $scope._flag = "";

	atRosSev.clearData();
    atRosSev.loadAtRosData(d_obj.val(),'0');
    $scope.at_ros_data =  atRosSev.getAtRosData();
    $scope.filterStaff = function(_flag){
      $scope._flag = _flag;
      $scope.closePopover();
    }

    $scope.closeOptions = function(){
      $ionicListDelegate.closeOptionButtons();
    };
    $ionicPopover.fromTemplateUrl("roster-result-popover.html", {
      scope: $scope
    })
      .then(function(popover){
        $scope.popover = popover;
      })

    $scope.openPopover = function($event) {
      $scope.popover.show($event);
    };
    $scope.closePopover = function() {
      $scope.popover.hide();
    };
    //销毁事件回调处理：清理popover对象
    $scope.$on("$destroy", function() {
      $scope.popover.remove();
    });
  })
  .controller('atAnalyCtrl',function($scope,atAnalySev,timeSelect,$ionicPopup,$location){
	$scope.redirect_to_result = function(){
		$location.path('home_page/home_menulist/at_result');
		atAnalySev.setProcessStatus('0');
	}

	$scope.close_process_div = function(){
		atAnalySev.setProcessStatus('0');
	}

	$scope.process_status = atAnalySev.getProcessStatus();
	document.getElementById('at_task_in_process_div').style.display = 'block';
	document.getElementById('at_task_complete_div').style.display = 'block';

	$scope.dates_line2x = local_resource + 'img/model/dates-line2x.png';
	$scope.img_task_in_process_icon = local_resource + 'img/icon/task_in_process.png';
	$scope.img_task_complete_icon = local_resource + 'img/icon/task_complete.png';
	$scope.img_task_close = local_resource + 'img/icon/task_close.png';


	  $scope.dates_line = local_resource + 'img/model/dates-line2x.png';
    var c_d = new Date();
    var _y = c_d.getFullYear();
    var _t_m = c_d.getMonth()+1;
    var _m = _t_m<=9?'0'+_t_m:_t_m;
    document.getElementById("at_analysis_f").innerHTML=_y+'-'+_m+'-01';
    document.getElementById("at_analysis_t").innerHTML=_y+'-'+_m+'-'+(c_d.getDate()<=9?'0'+c_d.getDate():c_d.getDate());
    $scope.check_all=false;
    $scope.at_analysis_f = function(){
      var current_date = new Date();
      current_date.setMinutes(current_date.getMinutes() - current_date.getTimezoneOffset());
      current_date = current_date.toJSON().slice(0,4);
      var startDate = parseInt(current_date, 10) - 10;
      startDate = startDate + '-01-01';
      var endDate = parseInt(current_date, 10) + 10;
      endDate = endDate + '-12-31';
      timeSelect.show({
        type :  'date' ,
        startDate :  '1900-01-01',
        endDate : '2099-12-31',
        defaultDate: document.getElementById("at_analysis_f").innerHTML,
        returnDateType : 'y-m-d',
        returnTimeType :  '24h'||'AMPM',
        //stepping :10,
        selectedFunc : function (date) {
          if (typeof(date) != 'undefined'){
            document.getElementById("at_analysis_f").innerHTML = date;
          }
        }
      })
    }

    $scope.at_analysis_t = function(){
      var current_date = new Date();
      current_date.setMinutes(current_date.getMinutes() - current_date.getTimezoneOffset());
      current_date = current_date.toJSON().slice(0,4);
      var startDate = parseInt(current_date, 10) - 10;
      startDate = startDate + '-01-01';
      var endDate = parseInt(current_date, 10) + 10;
      endDate = endDate + '-12-31';
      timeSelect.show({
        type :  'date' ,
        startDate :  '1900-01-01',
        endDate : '2099-12-31',
        defaultDate: document.getElementById("at_analysis_t").innerHTML,
        returnDateType : 'y-m-d',
        returnTimeType :  '24h'||'AMPM',
        //stepping :10,
        selectedFunc : function (date) {
          if (typeof(date) != 'undefined'){
            document.getElementById("at_analysis_t").innerHTML = date;
          }
        }
      })
    }

    $scope.runAnalysis = function(){
      var _ck_all = $scope.check_all==true?1: 0;

	  	if (!_ck_all && $("#at_analysis_empl_list_hidden").val() == ''){
			window.fufuMessageBox('请选择员工', fufu_message_box_duration, function() {});
			return;
		}


        $ionicPopup.confirm({
          title:'',
          template: '<div style="overflow:hidden;border-radius:10px;padding-left:0px !important;padding-right:0px !important;"><div style="width:7.2rem;height:4.66666666666rem;"><img src='+local_resource + "img/icon/task_in_process_image.png"+' alt="" style="width:100%;height:4.66666667rem;"/></div> <div style="padding:20px;color:#000;font-size:0.4266666667rem;padding-bottom:0px;line-height:150%;">该操作比较耗时，请确认继续进行，确认后您可执行其他操作，待系统计算后会以消息告知计算结果。</div></div>',
          cancelType: 'button-dark',
          cancelText: '取消',
          cssClass:'at_cal_popup',
          okText: '确定'
        }).then(function (res) {
          if (res) {
            atAnalySev.runAnalysis($("#at_analysis_empl_list_hidden").val(),document.getElementById("at_analysis_f").innerHTML,document.getElementById("at_analysis_t").innerHTML,_ck_all);
          }
        });
    }
  })
  .controller('atResultCtrl',function($scope,atResultSev,$location,timeSelect){
    var d_obj = $("#at_result_1");

    d_obj.change(function(){
      atResultSev.loadAtResultData(d_obj.val(),'0');
    })
    $scope.loadAtEmplDetail = function(empl_no){
      $location.path("home_page/at_empl_detail/"+empl_no+"/"+d_obj.val());
    }
    $scope.reAtResultData = function(_flag){
      atResultSev.loadAtResultData(d_obj.val(),_flag);
    }
	$scope.search_control={};
    $scope.search_control.search_val = "";
	atResultSev.clearData();
    atResultSev.loadAtResultData(d_obj.val(),'0');
    $scope.at_result_data =  atResultSev.getAtResultData();

    $scope.at_result_2=function(){
      var current_date = new Date();
      current_date.setMinutes(current_date.getMinutes() - current_date.getTimezoneOffset());
      current_date = current_date.toJSON().slice(0,4);
      var startDate = parseInt(current_date, 10) - 10;
      startDate = startDate + '-01-01';
      var endDate = parseInt(current_date, 10) + 10;
      endDate = endDate + '-12-31';
      timeSelect.show({
        type :  'date' ,
        startDate :  '1900-01-01',
        endDate : '2099-12-31',
        defaultDate: document.getElementById("at_result_2").innerHTML,
        returnDateType : 'y-m-d',
        returnTimeType :  '24h'||'AMPM',
        //stepping :10,
        selectedFunc : function (date) {
          if (typeof(date) != 'undefined'){
            document.getElementById("at_result_2").innerHTML = date;
            d_obj.val(date);
            atResultSev.loadAtResultData(d_obj.val(),'0');
          }
        }
      })
    }

  })
  .controller('atEmplDetailCtrl',function($scope,atEmplDetailSev,$stateParams,$ionicModal){
    var d_obj = $("#at_empl_detail_1");
    d_obj.val($stateParams.curr_date);
    d_obj.change(function(){
      atEmplDetailSev.loadAtDetailData($stateParams.empl_no,d_obj.val(),0);
    });
	atEmplDetailSev.clearData();
    atEmplDetailSev.loadAtDetailData($stateParams.empl_no,$stateParams.curr_date,0);
    $scope.at_empl_detail_data =  atEmplDetailSev.getAtDetailData();
    $scope.reAtDetailData = function(_flag){
      atEmplDetailSev.loadAtDetailData($stateParams.empl_no,d_obj.val(),_flag);
    }
    $scope.reAtAnalysis = function(){
      atEmplDetailSev.reAtAnalysis($stateParams.empl_no,d_obj.val());
    }

    $ionicModal.fromTemplateUrl('at-empl-modal.html', {
      scope: $scope,
      animation: 'slide-in-up'
    }).then(function(modal) {
      $scope.modal = modal;
    });
    $scope.openModal = function() {
      $scope.modal.show();
      if(angular.isDefined($scope.at_empl_detail_data.daily_rec)){
        var data = $scope.at_empl_detail_data.daily_rec;
        for(var i=0;i<data.length;i++){
          $("#at_from_"+i).val(data[i].from);
          $("#at_to_"+i).val(data[i].to);
        }
      }
    };
    $scope.closeModal = function() {
      $scope.modal.hide();
    };
    $scope.$on('$destroy', function() {
      $scope.modal.remove();
    });
    // 当隐藏的模型时执行动作
    $scope.$on('modal.hide', function() {
      // 执行动作
    });
    // 当移动模型时执行动作
    $scope.$on('modal.removed', function() {
      // 执行动作
    });
    })
  .controller('payrollCalCtrl',function($scope,payrollCalSev,timeSelect,$ionicPopup,$location,sideSelect){
    payrollCalSev.loadData();
    $scope.pay_roll_data = payrollCalSev.getData();

	$scope.pay_terms_picklist = function(){
		if ($scope.pay_roll_data.pay_terms_id == '0' || $scope.pay_roll_data.pay_terms == ''){
			window.fufuMessageBox('没有薪资帐套', fufu_message_box_duration, function() {});
			return;
		}
      sideSelect.show({
        type : 'ios',
        data :$scope.pay_roll_data.pay_terms_picklist,
        selectIndex :  $scope.pay_roll_data.pay_pay_terms_picklist_index,
        selectedFunc : function (index) {
			if(typeof(index)!='undefined'){
				if (index == $scope.pay_roll_data.pay_pay_terms_picklist_index){
					return;
				}

				$('#payroll_cal_empl_list').val('');
				$('#payroll_cal_empl_list_hidden').val('');

				$scope.pay_roll_data.pay_pay_terms_picklist_index = index;
				$scope.pay_roll_data.pay_terms = $scope.pay_roll_data.pay_terms_picklist[index].value;
				$scope.pay_roll_data.pay_terms_id = $scope.pay_roll_data.pay_terms_picklist[index].key;

				$scope.pay_roll_data.pay_date_picklist = [];
				$scope.pay_roll_data.pay_date_picklist_index = 0;
				$scope.pay_roll_data.pay_date_key = $scope.pay_roll_data.pay_terms_str[index].pay_date[0].pay_start + '///' + $scope.pay_roll_data.pay_terms_str[index].pay_date[0].pay_end;
				$scope.pay_roll_data.pay_date_value = $scope.pay_roll_data.pay_terms_str[index].pay_date[0].pay_start.split('-')[0] + '-' + $scope.pay_roll_data.pay_terms_str[index].pay_date[0].pay_start.split('-')[1];
				$scope.pay_roll_data.pay_date_picklist.push({"key":$scope.pay_roll_data.pay_terms_str[index].pay_date[0].pay_start + '///' + $scope.pay_roll_data.pay_terms_str[index].pay_date[0].pay_end,"value":$scope.pay_roll_data.pay_terms_str[index].pay_date[0].pay_start.split('-')[0] + '-' + $scope.pay_roll_data.pay_terms_str[index].pay_date[0].pay_start.split('-')[1]});
				$scope.pay_roll_data.pay_date_picklist.push({"key":$scope.pay_roll_data.pay_terms_str[index].pay_date[1].pay_start + '///' + $scope.pay_roll_data.pay_terms_str[index].pay_date[1].pay_end,"value":$scope.pay_roll_data.pay_terms_str[index].pay_date[1].pay_start.split('-')[0] + '-' + $scope.pay_roll_data.pay_terms_str[index].pay_date[1].pay_start.split('-')[1]});
			}
        }
      });
	}

	$scope.pay_date_picklist = function(){
		if ($scope.pay_roll_data.pay_terms_id == '0' || $scope.pay_roll_data.pay_terms == ''){
			window.fufuMessageBox('没有薪资帐套', fufu_message_box_duration, function() {});
			return;
		}
      sideSelect.show({
        type : 'ios',
        data :$scope.pay_roll_data.pay_date_picklist,
        selectIndex :  $scope.pay_roll_data.pay_date_picklist_index,
        selectedFunc : function (index) {
			if(typeof(index)!='undefined'){
				$scope.pay_roll_data.pay_date_picklist_index = index;
				$scope.pay_roll_data.pay_date_value = $scope.pay_roll_data.pay_date_picklist[index].value;
				$scope.pay_roll_data.pay_date_key = $scope.pay_roll_data.pay_date_picklist[index].key;
			}
        }
      });

	}

	$scope.redirect_to_result = function(){
		$location.path('home_page/home_menulist/payroll_result');
		payrollCalSev.setProcessStatus('0');
	}

	$scope.close_process_div = function(){
		payrollCalSev.setProcessStatus('0');
	}

	$scope.process_status = payrollCalSev.getProcessStatus();
	document.getElementById('payroll_task_in_process_div').style.display = 'block';
	document.getElementById('payroll_task_complete_div').style.display = 'block';

	$scope.dates_line2x = local_resource + 'img/model/dates-line2x.png';
	$scope.img_task_in_process_icon = local_resource + 'img/icon/task_in_process.png';
	$scope.img_task_complete_icon = local_resource + 'img/icon/task_complete.png';
	$scope.img_task_close = local_resource + 'img/icon/task_close.png';

    var c_d = new Date();
    var _y = c_d.getFullYear();
    var _t_m = c_d.getMonth()+1;
    var _m = _t_m<=9?'0'+_t_m:_t_m;
    document.getElementById("payroll_cal_f").innerHTML=_y+'-'+_m+'-01';
    document.getElementById("payroll_cal_t").innerHTML=_y+'-'+_m+'-'+(c_d.getDate()<=9?'0'+c_d.getDate():c_d.getDate());
    $scope.check_all=false;
    $scope.payroll_cal_f = function(){
      var current_date = new Date();
      current_date.setMinutes(current_date.getMinutes() - current_date.getTimezoneOffset());
      current_date = current_date.toJSON().slice(0,4);
      var startDate = parseInt(current_date, 10) - 10;
      startDate = startDate + '-01-01';
      var endDate = parseInt(current_date, 10) + 10;
      endDate = endDate + '-12-31';
      timeSelect.show({
        type :  'date' ,
        startDate :  '1900-01-01',
        endDate : '2099-12-31',
        defaultDate:  document.getElementById("payroll_cal_f").innerHTML,
        returnDateType : 'y-m-d',
        returnTimeType :  '24h'||'AMPM',
        //stepping :10,
        selectedFunc : function (date) {
          if (typeof(date) != 'undefined'){
            document.getElementById("payroll_cal_f").innerHTML = date;

          }
        }
      })
    }
    $scope.payroll_cal_t = function(){
      var current_date = new Date();
      current_date.setMinutes(current_date.getMinutes() - current_date.getTimezoneOffset());
      current_date = current_date.toJSON().slice(0,4);
      var startDate = parseInt(current_date, 10) - 10;
      startDate = startDate + '-01-01';
      var endDate = parseInt(current_date, 10) + 10;
      endDate = endDate + '-12-31';
      timeSelect.show({
        type :  'date' ,
        startDate :  '1900-01-01',
        endDate : '2099-12-31',
        defaultDate:  document.getElementById("payroll_cal_t").innerHTML,
        returnDateType : 'y-m-d',
        returnTimeType :  '24h'||'AMPM',
        //stepping :10,
        selectedFunc : function (date) {
          if (typeof(date) != 'undefined'){
            document.getElementById("payroll_cal_t").innerHTML = date;

          }
        }
      })
    }



    $scope.runPayrollCal = function(){
      var _ck_all = $scope.check_all==true?1: 0;
		if (!_ck_all && $("#payroll_cal_empl_list_hidden").val() == ''){
			window.fufuMessageBox('请选择员工', fufu_message_box_duration, function() {});
			return;
		}

        $ionicPopup.confirm({
          title:'',
          template: '<div style="overflow:hidden;border-radius:10px;padding-left:0px !important;padding-right:0px !important;"><div style="width:7.2rem;height:4.66666666666rem;"><img src='+local_resource + "img/icon/task_in_process_image.png"+' alt="" style="width:100%;height:4.66666667rem;"/></div> <div style="padding:20px;color:#000;font-size:0.4266666667rem;padding-bottom:0px;line-height:150%;">该操作比较耗时，请确认继续进行，确认后您可执行其他操作，待系统计算后会以消息告知计算结果。</div></div>',
          cancelType: 'button-dark',
          cancelText: '取消',
          cssClass:'payroll_cal_popup',
          okText: '确定'
        }).then(function (res) {
          if (res) {
            payrollCalSev.runPayrollCal($("#payroll_cal_empl_list_hidden").val(),_ck_all);
          }
        });


    }
  })
  .controller('payrollSendCtrl',function($scope,payrollSendSev){
	 payrollSendSev.clearData();
    payrollSendSev.loadData();
    $scope.pay_send_data = payrollSendSev.getData();

    $scope.sendPayroll = function(){
      payrollSendSev.sendPayroll($scope.pay_send_data.st_date,$scope.pay_send_data.en_date);
    }
  })
  .controller('payrollSlipCtrl',function($scope,payrollSlipSev,$ionicModal,$ionicScrollDelegate){
	$scope.payroll_slip_bg = local_resource + 'img/icon/payroll_slip_bg.png';
	$scope.pryroll_delete = local_resource + 'img/icon/pryroll_delete.png';

	$scope.current_password = '';
	$scope.retype_password = '';
    if (ionic.Platform.isIOS()) {
	  payrollSlipSev.clearData();
      payrollSlipSev.loadData(0,'');
      $scope.pay_slip_data = payrollSlipSev.getData();

    } else {
      $scope.$on("$ionicView.enter", function () {
        //解决 进入明细页面back回来的时候 会再次loaddata
        if (typeof($scope.data_loaded) != 'undefined') {
          return;
        }
        else {
          $scope.data_loaded = true;
        }
        payrollSlipSev.clearData();
        payrollSlipSev.loadData(0,'');
        $scope.pay_slip_data = payrollSlipSev.getData();
      });
    }

	if (ionic.Platform.isIOS()) {
	$scope.wrap_height=parseInt(document.body.scrollHeight)-64;
	$scope.top_height=(parseInt(document.body.scrollHeight)-64)*0.3185;
	$scope.bottom_height=(parseInt(document.body.scrollHeight)-64)*0.33;
	$scope.bottom_content_height=(parseInt(document.body.scrollHeight)-64)*0.33/4;
	$scope.img_height=(parseInt(document.body.scrollHeight)-64)*0.1171*2;
	$scope.img_width=(parseInt(document.body.scrollHeight)-64)*0.1171*1.0196*2;
	}else{
	$scope.wrap_height=parseInt(document.body.scrollHeight)-44;
	$scope.top_height=(parseInt(document.body.scrollHeight)-44)*0.3185;
	$scope.bottom_height=(parseInt(document.body.scrollHeight)-44)*0.33;
	$scope.bottom_content_height=(parseInt(document.body.scrollHeight)-44)*0.33/4;
	$scope.img_height=(parseInt(document.body.scrollHeight)-44)*0.1171*2;
	$scope.img_width=(parseInt(document.body.scrollHeight)-44)*0.1171*1.0196*2;
	}
	$scope.img_margin_height=($scope.top_height-$scope.img_height)/2;



    $scope.reloadData = function(_flag){
      payrollSlipSev.loadData(_flag,$scope.pay_slip_data.data1.date);
    }

	$scope.input_password = function(current_input){
		if (document.getElementById('payslip_password_setting_text').innerHTML == '设置密码' || document.getElementById('payslip_password_setting_text').innerHTML == '输入密码'){
			if (current_input == 'x'){
				if ($scope.current_password == ''){
					return;
				}
				else {
					if ($scope.current_password.length == 1){
						document.getElementById('password_char1').style.display = "none";
					}
					else if ($scope.current_password.length == 2){
						document.getElementById('password_char2').style.display = "none";
					}
					else if ($scope.current_password.length == 3){
						document.getElementById('password_char3').style.display = "none";
					}
					$scope.current_password = $scope.current_password.slice(0, -1);
				}
			}
			else {
				$scope.current_password = $scope.current_password + current_input;
				if ($scope.current_password.length < 4){
					if ($scope.current_password.length == 1){
						document.getElementById('password_char1').style.display = "block";
					}
					else if ($scope.current_password.length == 2){
						document.getElementById('password_char2').style.display = "block";
					}
					else if ($scope.current_password.length == 3){
						document.getElementById('password_char3').style.display = "block";
					}
				}
				else {
					document.getElementById('password_char4').style.display = "block";
					if (document.getElementById('payslip_password_setting_text').innerHTML == '设置密码'){
						document.getElementById('password_char1').style.display = "none";
						document.getElementById('password_char2').style.display = "none";
						document.getElementById('password_char3').style.display = "none";
						document.getElementById('password_char4').style.display = "none";
						document.getElementById('payslip_password_setting_text').innerHTML = '再次输入密码';
					}
					else if (document.getElementById('payslip_password_setting_text').innerHTML == '输入密码'){
						payrollSlipSev.payslipVerifyPassword($scope);
					}
				}
			}

		}
		else if (document.getElementById('payslip_password_setting_text').innerHTML == '再次输入密码'){
			if (current_input == 'x'){
				if ($scope.retype_password == ''){
					return;
				}
				else {
					if ($scope.retype_password.length == 1){
						document.getElementById('password_char1').style.display = "none";
					}
					else if ($scope.retype_password.length == 2){
						document.getElementById('password_char2').style.display = "none";
					}
					else if ($scope.retype_password.length == 3){
						document.getElementById('password_char3').style.display = "none";
					}
					$scope.retype_password = $scope.retype_password.slice(0, -1);
				}
			}
			else {
				$scope.retype_password = $scope.retype_password + current_input;
				if ($scope.retype_password.length < 4){
					if ($scope.retype_password.length == 1){
						document.getElementById('password_char1').style.display = "block";
					}
					else if ($scope.retype_password.length == 2){
						document.getElementById('password_char2').style.display = "block";
					}
					else if ($scope.retype_password.length == 3){
						document.getElementById('password_char3').style.display = "block";
					}
				}
				else {
					document.getElementById('password_char4').style.display = "block";
					if ($scope.retype_password == $scope.current_password){

						payrollSlipSev.payslipSetPassword($scope);
					}
					else {
						window.fufuMessageBox("密码与确认密码不相同", fufu_message_box_duration, function() {});
						$scope.retype_password = "";
						document.getElementById('password_char1').style.display = "none";
						document.getElementById('password_char2').style.display = "none";
						document.getElementById('password_char3').style.display = "none";
						document.getElementById('password_char4').style.display = "none";
					}
				}
			}
		}
	}
	$scope.reset_password = function(){
		$ionicScrollDelegate.resize();
		$scope.current_password = '';
		$scope.retype_password = '';
		document.getElementById('payroll_slip_reset_password_div').style.display = "none";
		document.getElementById('payslip_password_setting_forgetpwd').style.display = "none";
		document.getElementById('payslip_password_setting_text').innerHTML = '设置密码';
		document.getElementById('password_char1').style.display = "none";
		document.getElementById('password_char2').style.display = "none";
		document.getElementById('password_char3').style.display = "none";
		document.getElementById('password_char4').style.display = "none";
		document.getElementById('payslip_password_setting_div').style.display = 'block';
		document.getElementById('payslip_view_div').style.display = 'none';
	}


	var current_phone_num = window.localStorage['_user_name'];
	$scope.forget_password_phone_num = current_phone_num.substr(0,3) + '****' + current_phone_num.substr(current_phone_num.length-4,4);

	$ionicModal.fromTemplateUrl('payroll_slip_forget_password.html', {
	  scope: $scope,
	  animation: 'slide-in-up'
	}).then(function(modal) {
		$scope.modal = modal;
	});

    $scope.closeModal = function() {
      $scope.modal.hide();
    };

	$scope.forget_password = function(){
		$scope.modal.show();
	}

	$scope.sendPwdVCode = function(){
		payrollSlipSev.sendPwdVCode($scope);
	}

	$scope.payroll_slip_forget_password_reset_password = function(){
		payrollSlipSev.payroll_slip_forget_password_reset_password($scope);
	}

  })
  .controller('payrollResultCtrl',function($scope,payrollResultSev,$stateParams,$location){

  	var obj = $('#payroll_result_calendar_date');
	var current_date = new Date();
	current_date.setMinutes(current_date.getMinutes() - current_date.getTimezoneOffset());
	current_date = current_date.toJSON().slice(0,7);
	obj.val(current_date);
	$scope.current_date_str = obj.val().split('-')[0] + '-' + obj.val().split('-')[1];

	payrollResultSev.clearData();
    payrollResultSev.loadPrResultData('','0');
    $scope.payroll_result_data = payrollResultSev.getPrResultData();
    $scope.search_control={};
    $scope.search_control.search_val = "";



    $scope.reloadPrData = function(_f){
      payrollResultSev.loadPrResultData(obj.val(),_f);
	  if (_f == '1'){
		document.getElementById("payroll_result_calendar_date").stepUp(1);
	  }
	  else if (_f == '-1'){
		document.getElementById("payroll_result_calendar_date").stepDown(1);
	  }
	  $scope.current_date_str = obj.val().split('-')[0] + '-' + obj.val().split('-')[1];
    }
    $scope.loadResultPaySlip = function(item,empl_no){
      $location.path('/home_page/payroll_result_slip/'+empl_no+'/'+item.pay_start+'/'+item.pay_end+'/'+item.pay_terms_id);
    }
  })
  .controller('pResultSlipCtrl',function($scope,pResultSlipSev,$stateParams){
    $scope.sd = $stateParams.start_date;
    $scope.ed = $stateParams.end_date;
	$scope.pay_terms_id = $stateParams.pay_terms_id;
	pResultSlipSev.clearData();
    pResultSlipSev.loadData($stateParams.empl_no,$scope.sd,$scope.ed,$scope.pay_terms_id);
    $scope.presult_slip_data = pResultSlipSev.getData();

    $scope.mdyPrSlip = function(){
      var v_list = '';
      var _data = $scope.presult_slip_data.dt;
      for(var i=0;i<_data.length;i++){
        v_list = v_list + _data[i].f + ':' + _data[i].v + ',';
      }
      pResultSlipSev.mdyPrSlip($stateParams.empl_no,$scope.sd,$scope.ed,v_list.substring(0,v_list.length-1));
    }
  })

  .controller('settingUdCtrl',function($scope,settingUdSev,$ionicModal,$ionicPopup,$rootScope,$timeout,$location){

    /*Sunny改*/
    $scope.web_end_import = local_resource + 'img/icon/web_end_import.png';
    $scope.address_book_import = local_resource + 'img/icon/address_book_import.png';
    $scope.manually_add = local_resource + 'img/icon/manually_add.png';

    /*Sunny改*/
    $scope.search_control={};
    $scope.search_control.search_val = "";
    $scope.search_control.c_search_val = "";
    $scope.selCt = 0;
	settingUdSev.clearData();
    settingUdSev.loadUserData();
    $scope.user_data =  settingUdSev.getUserData();

    $scope.setting_user_admin_delete = function (username,user_id){
      $ionicPopup.confirm({
        title: '提示',
        template: '<div style="text-align: center;">'+'确认删除?'+'</div>',
        cancelText:'取消',
        cancelType:'button-dark',
        okText: '确认'
      }).then(function(res) {
        if (res){
          settingUdSev.setting_user_admin_delete(username,user_id);
        }
      });

    }


    $ionicModal.fromTemplateUrl('import-contacts-modal.html', {
      scope: $scope,
      animation: 'slide-in-up'
    }).then(function(modal) {
      $scope.modal = modal;
    });

    $scope.webImport = function(){
      $location.path('home_page/home_menulist/web_import');
    }

    $scope.closeModal = function() {
      $scope.modal.hide();
    };
    $scope.$on('$destroy', function() {
      $scope.modal.remove();
      $scope.add_modal.remove();
    });

   //$scope.contacts_data = [{name:'JACK.ZHENG',phone:'18682168147',ck:false},{name:'JIN',phone:''},{name:'gary',phone:''}];
   	//$scope.contacts_data = [{name:'victor1',phone:'18680391411',ck:false},{name:'victor2',phone:'18680391412'},{name:'victor3',phone:'+86 18680391413'},{name:'victor4',phone:'#18680391414'}];
  $scope.contacts_data = [];
	//settingUdSev.loadContactsData();
	$scope.contacts_data = settingUdSev.getContactsData();
	/*
	$scope.contacts_data = [];
    try{
      var options = new ContactFindOptions();
      options.filter = "";
      options.multiple = true;
      options.hasPhoneNumber = true;
      var fields = ['*'];
      navigator.contacts.find(fields, function(contacts){
        $scope.contacts_data = [];
        for(var i=0;i<contacts.length;i++){
          $scope.contacts_data.push({
            name:ionic.Platform.isIOS()?(angular.isDefined(contacts[i].name)?contacts[i].name.formatted:''):(angular.isDefined(contacts[i].displayName)?contacts[i].displayName:''),
            phone:contacts[i].phoneNumbers!=null?(contacts[i].phoneNumbers[0].value).replace(new RegExp(/(-)/g),''):'',
            ck:false
          })
        }
      }, function(contactError){
      }, options);
    }catch(e){}
	*/

    $scope.openModal = function() {
		settingUdSev.clearContactsData();
		settingUdSev.loadContactsData();
    $scope.contacts_data = settingUdSev.getContactsData();

      $scope.modal.show();
    };
    $scope.ckItem = function(_flag){
      if(_flag == true){
        $scope.contacts_data.num_checked =  $scope.contacts_data.num_checked + 1;

      }else{
        $scope.contacts_data.num_checked =  $scope.contacts_data.num_checked - 1;
      }
    }
    //$scope.select_all_employee = function(){
    //
    //  //$scope.all_selected = true;
    //  document.getElementById('select_all_employee').style.display = "none";
    //  document.getElementById('deselect_all_employee').style.display = "block";
    //  $scope.contacts_data.num_checked = $scope.contacts_data.length;
    //  $scope.contacts_data.show_footer_bar = true;
    //  for (var i=0;i<$scope.contacts_data.length;i++){
    //    $scope.contacts_data[i].checked = true;
    //  }
    //}
    //$scope.cancel = function(){
    //  console.log($scope.contacts_data);
    //  //$scope.all_selected = false;
    //  document.getElementById('select_all_employee').style.display = "block";
    //  document.getElementById('deselect_all_employee').style.display = "none";
    //  $scope.contacts_data.num_checked = 0;
    //  $scope.contacts_data.show_footer_bar = false;
    //  for (var i=0;i<$scope.contacts_data.length;i++){
    //    $scope.contacts_data[i].checked = false;
    //  }
    //}

    $scope.importAction = function(){
      var phone_list = '';
      var name_list = '';
      var data = $scope.contacts_data;
      for(var i=0;i<data.length;i++){
        if(data[i].ck&&data[i].phone!=''){
          phone_list = phone_list + data[i].phone+'*,*';
          name_list = name_list + data[i].name+'*,*';
        }
      }
      if(phone_list==''){
        $ionicPopup.alert({
          title: '提醒',
          template: '<div style="text-align: center;">没有选中通讯录数据</div>',
          okText:'确定'
        }).then(function(res) {
        });
      }else{
        $rootScope.showLoading();
        $.ajax({
          type: 'POST',
          url: window.localStorage['_remote_server_addr']+'?event=ionicAction.ionicAction.importContacts',
          timeout:30000000,
          data: {
            phone_list:phone_list.substring(0,phone_list.length-3),
            name_list:name_list.substring(0,name_list.length-3),
            _user_name:window.localStorage['_user_name'],
            _pass_word:window.localStorage['_pass_word'],
            _is_login:window.localStorage['_is_login'],
            _notification_token:window.localStorage['_notification_token'],
            _device_type:window.localStorage['_device_type']
          },
          success: function(data, status, headers, config) {
            $rootScope.hideLoading();
            var _data = $.parseJSON(data);
			if (typeof(_data.flag) != 'undefined' && _data.flag == '0'){
				fufuMobclickAgent('click_phonebook_import');
				$location.path('home_page/home_menulist/user_import_result/'+_data.operate_date);
			}
			else {
				$ionicPopup.alert({
				  title: '运行结果',
				  template: '<div style="text-align: center;">'+fufu_network_error_msg+'</div>',
				  okText:'确定'
				}).then(function(res) {

				});
			}
          },
          error:function(data, status, headers, config) {
            $rootScope.hideLoading();
            $ionicPopup.alert({
              title : '提醒',
              template : '<div style="text-align: center;">'+fufu_network_error_msg+'</div>',
              okText : '确定'
            })
          }
        });
      }
    }

    $scope.user_contact = {
      user_name:'',
      name:'',
      staff_no:'',
      tel:'',
      email:'',
      _flag:1,
      _message:''
    }

    $ionicModal.fromTemplateUrl('add-contact-modal.html', {
      scope: $scope,
      animation: 'slide-in-up'
    }).then(function(modal) {
      $scope.add_modal = modal;
    });

    $scope.closeAddModal = function() {
      $scope.add_modal.hide();
    };
    $scope.addUser = function(){
      $scope.user_contact = {
        user_name:'',
        name:'',
        staff_no:'',
        tel:'',
        email:'',
        _flag:1,
        _message:''
      }
      $scope.add_modal.show();
    }

    $scope.saveContact = function(){
      for(var p in $scope.user_contact){
        if($scope.user_contact[p]==''&&p!='_flag'&&p!='_message'&&p!='_is_login'&&p!='_notification_token'&&p!='_device_type'){
          $scope.user_contact._flag=0;
          $scope.user_contact._message='用户信息不能为空';
          $timeout(function(){
            $scope.user_contact._flag=1;
            $scope.user_contact._message='';
          },1500);
          return;
        }
      }
      var reg = /^1[3|4|5|7|8]\d{9}$/;
      if(!reg.test($scope.user_contact.user_name)){
        $scope.user_contact._flag = 0;
        $scope.user_contact._message = '手机号码格式不正确!';
        $timeout(function(){
          $scope.user_contact._flag = 1;
          $scope.user_contact._message = '';
        },1500);
        return;
      }
      $scope.user_contact._user_name=window.localStorage['_user_name'];
      $scope.user_contact._pass_word=window.localStorage['_pass_word'];
      $scope.user_contact._is_login=window.localStorage['_is_login'];
      $scope.user_contact._notification_token=window.localStorage['_notification_token'];
      $scope.user_contact._device_type=window.localStorage['_device_type'];
      $rootScope.showLoading();
      $.ajax({
        type: 'POST',
        url: window.localStorage['_remote_server_addr']+'?event=ionicAction.ionicAction.saveContact',
        data: $scope.user_contact,
        timeout:_var_timeout,
        success: function(data, status, headers, config) {
          $rootScope.hideLoading();
          var _data = $.parseJSON(data);
          $ionicPopup.alert({
            title: '运行结果',
            template: '<div style="text-align: center;">'+_data.message+'</div>',
            okText:'确定'
          }).then(function(res) {
            if(_data.flag=="0") {
				fufuMobclickAgent('click_single_import');
              $scope.closeAddModal();
              settingUdSev.loadUserData();
            }
          });
        },
        error:function(data, status, headers, config) {
          $rootScope.hideLoading();
          $ionicPopup.alert({
            title : '提醒',
            template : '<div style="text-align: center;">'+fufu_network_error_msg+'</div>',
            okText : '确定'
          })
        }
      });
    }
  })

  .controller('essLvApplyCtrl',function($scope,essLvApplySev,$ionicModal,$ionicActionSheet,timeSelect,sideSelect,$ionicScrollDelegate,$emplComponentService){
	$scope.dates_line2x = local_resource + 'img/model/dates-line2x.png';
	$scope.dates_line3x = local_resource + 'img/model/dates-line2x.png';
	$scope.add_approver = local_resource + 'img/model/add_approver.png';
	$scope.add_approver_ = local_resource + 'img/model/add_approver_.png';
	$scope.dates_line4x = local_resource + 'img/model/dates-line2x.png';
	$scope.img_upload_file_part1 = local_resource+'img/icon/add.png';
	$scope.img_upload_file_part2 = local_resource+'img/icon/new_2.png';
	$scope.is_require_upload = false;
	essLvApplySev.clearData();
    essLvApplySev.loadData($scope);
    $scope.lv_app_data = essLvApplySev.getData();

	$scope.imagesObj = essLvApplySev.getImageData();

    $scope.essLvPolicy=function(){
      sideSelect.show({
        type : 'ios',
        data :$scope.lv_app_data.essLvPolicy_data,
        selectIndex :  $scope.lv_app_data.essLvPolicy_data_index,
        selectedFunc : function (index) {
          if(typeof(index)!='undefined'){
            document.getElementById("essLvPolicy").innerHTML=$scope.lv_app_data.essLvPolicy_data[index].value;
            $scope.lv_app_data.essLvPolicy_data_key=$scope.lv_app_data.essLvPolicy_data[index].key;
            $scope.lv_app_data.essLvPolicy_data_index=index;
            $scope.lv_app_data.default_lv_code_id=$scope.lv_app_data.essLvPolicy_data_key;
            essLvApplySev.changeEssLvPolicy($scope,$scope.lv_app_data.default_lv_code_id);
          }

        }
      });
    }
/*
    $scope.showDate_start_date = function(){
      var current_date = new Date();
      current_date.setMinutes(current_date.getMinutes() - current_date.getTimezoneOffset());
      current_date = current_date.toJSON().slice(0,4);
      var startDate = parseInt(current_date, 10) - 10;
      startDate = startDate + '-01-01';
      var endDate = parseInt(current_date, 10) + 10;
      endDate = endDate + '-12-31';
      timeSelect.show({
        type :  'date' ,
        startDate :  '1900-01-01',
        endDate : '2099-12-31',
        defaultDate: $scope.lv_app_data.start_date,
        returnDateType : 'y-m-d',
        returnTimeType :  '24h'||'AMPM',
        //stepping :10,
        selectedFunc : function (date) {
          if (typeof(date) != 'undefined'){
            $scope.lv_app_data.start_date = date;
            essLvApplySev.changeEssLvPolicy($scope,$scope.lv_app_data.default_lv_code_id);
          }
        }
      })
    }
    $scope.showDate_start_time = function(){
      var current_date = new Date();
      current_date.setMinutes(current_date.getMinutes() - current_date.getTimezoneOffset());
      current_date = current_date.toJSON().slice(0,4);
      var startDate = parseInt(current_date, 10) - 10;
      startDate = startDate + '-01-01';
      var endDate = parseInt(current_date, 10) + 10;
      endDate = endDate + '-12-31';
      timeSelect.show({
        type :  'time' ,
        startDate :  '1900-01-01',
        endDate : '2099-12-31',
        defaultDate: $scope.lv_app_data.start_time,
        returnDateType : 'y-m-d',
        returnTimeType :  '24h'||'AMPM',
        //stepping :10,
        selectedFunc : function (date) {
          if (typeof(date) != 'undefined'){
            $scope.lv_app_data.start_time = date;
            essLvApplySev.changeEssLvPolicy($scope,$scope.lv_app_data.default_lv_code_id);
          }
        }
      })
    }


    $scope.showDate_end_date = function(){
      var current_date = new Date();
      current_date.setMinutes(current_date.getMinutes() - current_date.getTimezoneOffset());
      current_date = current_date.toJSON().slice(0,4);
      var startDate = parseInt(current_date, 10) - 10;
      startDate = startDate + '-01-01';
      var endDate = parseInt(current_date, 10) + 10;
      endDate = endDate + '-12-31';
      timeSelect.show({
        type :  'date' ,
        startDate :  '1900-01-01',
        endDate : '2099-12-31',
        defaultDate: $scope.lv_app_data.end_date,
        returnDateType : 'y-m-d',
        returnTimeType :  '24h'||'AMPM',
        //stepping :10,
        selectedFunc : function (date) {
          if (typeof(date) != 'undefined'){
            $scope.lv_app_data.end_date = date;
            essLvApplySev.changeEssLvPolicy($scope,$scope.lv_app_data.default_lv_code_id);
          }
        }
      })
    }

    $scope.showDate_end_time = function(){
      var current_date = new Date();
      current_date.setMinutes(current_date.getMinutes() - current_date.getTimezoneOffset());
      current_date = current_date.toJSON().slice(0,4);
      var startDate = parseInt(current_date, 10) - 10;
      startDate = startDate + '-01-01';
      var endDate = parseInt(current_date, 10) + 10;
      endDate = endDate + '-12-31';
      timeSelect.show({
        type :  'time' ,
        startDate :  '1900-01-01',
        endDate : '2099-12-31',
        defaultDate: $scope.lv_app_data.end_time,
        returnDateType : 'y-m-d',
        returnTimeType :  '24h'||'AMPM',
        //stepping :10,
        selectedFunc : function (date) {
          if (typeof(date) != 'undefined'){
            $scope.lv_app_data.end_time = date;
            essLvApplySev.changeEssLvPolicy($scope,$scope.lv_app_data.default_lv_code_id);
          }
        }
      })
    }

*/

    $scope.show_start_date = function(){
      var current_date = new Date();
      current_date.setMinutes(current_date.getMinutes() - current_date.getTimezoneOffset());
      current_date = current_date.toJSON().slice(0,4);
      var startDate = parseInt(current_date, 10) - 1;
      startDate = startDate + '-01-01 18:00';
      var endDate = parseInt(current_date, 10) + 1;
      endDate = endDate + '-12-31 18:00';
      timeSelect.show({
        type :  'dateTime' ,
        startDate :  '1900-01-01 18:00',
        endDate : '2099-12-31 18:00',
        defaultDate: $scope.lv_app_data.start_date+' '+$scope.lv_app_data.start_time,
        returnDateType : 'y-m-d',
        returnTimeType :  '24h'||'AMPM',
        //stepping :10,
        selectedFunc : function (date) {
          if (typeof(date) != 'undefined'){

            var formatted_date = date.split(' ');
            $scope.lv_app_data.start_date = formatted_date[0];
            $scope.lv_app_data.start_time = formatted_date[1];
			essLvApplySev.changeEssLvPolicy($scope,$scope.lv_app_data.default_lv_code_id);
          }
        }
      })
    }


    $scope.show_end_date = function(){

      var current_date = new Date();
      current_date.setMinutes(current_date.getMinutes() - current_date.getTimezoneOffset());
      current_date = current_date.toJSON().slice(0,4);
      var startDate = parseInt(current_date, 10) - 1;
      startDate = startDate + '-01-01 18:00';
      var endDate = parseInt(current_date, 10) + 1;
      endDate = endDate + '-12-31 18:00';
      timeSelect.show({
        type :  'dateTime',
        startDate : '1900-01-01 18:00',
        endDate : '2099-12-31 18:00',
        defaultDate: $scope.lv_app_data.end_date+' '+$scope.lv_app_data.end_time,
        returnDateType : 'y-m-d',
        returnTimeType :  '24h'||'AMPM',
        //stepping :10,
        selectedFunc : function (date) {
          if (typeof(date) != 'undefined'){
            var formatted_date = date.split(' ');
            $scope.lv_app_data.end_date = formatted_date[0];
            $scope.lv_app_data.end_time = formatted_date[1];
			essLvApplySev.changeEssLvPolicy($scope,$scope.lv_app_data.default_lv_code_id);
          }
        }
      })
    }


	$scope.upload_photo = function (){

            // Show the action sheet
            var hideSheet = $ionicActionSheet.show({
                buttons: [

                    {
                        text: '拍照'
                    }, {
                        text: '从手机相册选择'
                    }
                ],

                //titleText: 'Modify your album',
                titleText: '选择上传图片方式',
                cancelText: '取消',
                cancel: function() {
                    // add cancel code..
                },
                buttonClicked: function(index) {

                    if (index == 0) {

                        try {
                            navigator.camera.getPicture(function(uri) {
								$scope.is_require_upload = true;
								document.getElementById('ess_leave_apply_upload_mini_photo').style.display = "block";
                                $('#ess_leave_apply_upload_mini_photo').attr("src", uri);
								document.getElementById('ess_leave_apply_upload_text').innerText='更改图片';
                                $('#ess_leave_apply_upload_icon1').attr("src", local_resource+'img/icon/upload_modify.png');
								document.getElementById('ess_leave_apply_upload_icon2').style.display = "none";
								document.getElementById('ess_leave_apply_upload_text').style.marginTop = "1.8em";

                            }, function() {
                                //alert('cancel or failure');
                            }, {
								destinationType: Camera.DestinationType.FILE_URI,
								quality: 10,
								targetHeight: 500,
								targetWidth: 500,
								correctOrientation: true
                            });
                        } catch (e) {
                            //alert(e.message);
                        }
                        return true;
                    } else if (index == 1) {
                        try {
                            navigator.camera.getPicture(function(uri) {
								$scope.is_require_upload = true;
								document.getElementById('ess_leave_apply_upload_mini_photo').style.display = "block";
                                $('#ess_leave_apply_upload_mini_photo').attr("src", uri);
								document.getElementById('ess_leave_apply_upload_text').innerText='更改图片';
                                $('#ess_leave_apply_upload_icon1').attr("src", local_resource+'img/icon/upload_modify.png');
								document.getElementById('ess_leave_apply_upload_icon2').style.display = "none";
								document.getElementById('ess_leave_apply_upload_text').style.marginTop = "1.8em";

                            }, function(message) {}, {
                                quality: 100,
                                destinationType: Camera.DestinationType.FILE_URI,
                                // In this app, dynamically set the picture source, Camera or photo gallery
                                sourceType: Camera.PictureSourceType.SAVEDPHOTOALBUM,
                                encodingType: Camera.EncodingType.JPEG,
                                mediaType: Camera.MediaType.PICTURE,
                                //allowEdit: true,
                                targetHeight: 500,
                                targetWidth: 500,
                                correctOrientation: true
                            });
                        } catch (e) {
                            //alert(e.message);
                        }

                        return true;
                    }

                    return true;


                }
            });

            // For example's sake, hide the sheet after two seconds
            /*
            $timeout(function() {
            hideSheet();
            }, 2000);
            */


	}

    $scope.changeEssLvPolicy = function(){
      essLvApplySev.changeEssLvPolicy($scope,$scope.lv_app_data.default_lv_code_id);
    }

    $scope.saveApply = function(){
		if ($scope.lv_app_data.is_attachment &&　$scope.imagesObj.data != ''){
			essLvApplySev.saveApplyWithPhoto($scope.select_user_id,$scope.select_notify_id,$scope.approver_list);
		}
		else {
			essLvApplySev.saveApply($scope.select_user_id,$scope.select_notify_id,$scope.approver_list);
		}
    }
    $scope.search_control={};
    $scope.search_control.search_val = '';
    $scope.ess_empl_data = [];
    $scope.select_user_id = '';
    $scope.select_notify_id = '';
    $scope.click_flag = 0;
    $scope.essItemCk = function(user_id,img,en,_flag){
      if(_flag == true){
        $scope.ess_empl_data.num_checked =  $scope.ess_empl_data.num_checked + 1;
      }else{
        $scope.ess_empl_data.num_checked =  $scope.ess_empl_data.num_checked - 1;
      }


      var _d = [];
      if($scope.click_flag == 0){
        $scope.select_user_id = user_id;
        _d = $scope.lv_app_data.approver_list;
      }else{
        return;
      }
      var flag = 0;
      var _len = _d.length;
      for(var i=0;i<_len;i++){
        if(angular.isDefined(_d[i].flag)&&_d[i].flag==1){
          flag = 1;
          break;
        }
      }
      if(flag == 0){
        _d.push({
          img:img,
          name:en,
          user_id:user_id,
          flag:1
        })
      }else{
        _d[_len-1] = {
          img:img,
          name:en,
          user_id:user_id,
          flag:1
        }
      }
      $scope.approver_list=_d;
      $scope.search_control.search_val = '';

      $scope.closeModal();
    }


    $scope.delete_notify=function(user_id){
      $('#essLvApply #notify_list_div').addClass('notify_list_active');
        if($scope.select_notify_id.indexOf(',')==-1){
          $scope.select_notify_id=$scope.select_notify_id.replace(user_id,'');
        }
        else if($scope.select_notify_id.indexOf(user_id+',')==-1){
          $scope.select_notify_id=$scope.select_notify_id.replace(','+user_id,'');
        }
        else{
          $scope.select_notify_id=$scope.select_notify_id.replace(user_id+',','');
        }
        for(var i=0;i<$scope.lv_app_data.notify_list.length;i++){
          if($scope.lv_app_data.notify_list[i].user_id==user_id){
            $scope.lv_app_data.notify_list.splice(i,1);
          }
        }
      setTimeout(function(){
        document.getElementById('notify_list_div').style.width=($scope.lv_app_data.notify_list.length+1)*100+20+'px';
        $ionicScrollDelegate.$getByHandle("notify_list_scroll").resize();
      },350)


    }
    $scope.delete_approver=function(user_id){
      if(!$scope.lv_app_data.approver_list_flag){
        return;
      }
      $('#essLvApply #approver_list_div').addClass('approver_list_active');
      $scope.approver_list=[];
      $scope.select_user_id=''
	  $scope.lv_app_data.approver_list=[];
    }


    $scope.selectList = function(){
      if($scope.click_flag==1){
        var _d = [];
        $scope.select_notify_id = '';
        $scope.lv_app_data.notify_list = [];
        for(var i=0;i<$scope.ess_empl_data.length;i++){
          if($scope.ess_empl_data[i].ck){
            $scope.select_notify_id = $scope.select_notify_id + ($scope.ess_empl_data)[i].user_id+',';
            $scope.lv_app_data.notify_list.push({
              img:($scope.ess_empl_data)[i].img,
              name:($scope.ess_empl_data)[i].en,
              user_id:($scope.ess_empl_data)[i].user_id,
              flag:1
            });
          }
        }
        $scope.select_notify_id = ($scope.select_notify_id).substring(0,$scope.select_notify_id.length-1);
        $scope.closeModal();
      }
      document.getElementById('notify_list_div').style.width=($scope.lv_app_data.notify_list.length+1)*100+20+'px';
      //alert($scope.lv_app_data.notify_list.length);

      $scope.search_control.search_val='';
      $ionicScrollDelegate.$getByHandle("notify_list_scroll").resize();
    }


    $ionicModal.fromTemplateUrl('ess-empl-modal.html', {
      scope: $scope,
      animation: 'slide-in-up'
    }).then(function(modal) {
      $scope.modal = modal;
    });
    $scope.openModal = function() {
		var selectEmplList = '';
		if ($scope.lv_app_data.approver_list.length != 0){
			selectEmplList = $scope.lv_app_data.approver_list[0].employee_no;
		}

		$emplComponentService.open({
			title : '选择审批人', //弹开窗口标题
			barTitle : window.localStorage["org_top_level"],//导航开头
			isSingleSelect:true,//是否单选
			isShowContact:true,//是否展示常用联系人
			isNeedSaveContact:true,//是否保存常用联系人
			extName : '员工', //多选时提示后缀名
			selectEmplList:selectEmplList, //打开窗口默认选中员工列表
			/*
			params:{ //支持可用扩展参数
				"is_permissions":"0",
				"is_process":"0",
				"process_instance":'0',
				"ext_param":"aa"
			},
			*/
			sure : function (rd) { //返回数据，数组格式

				$('#essLvApply #approver_list_div').removeClass('approver_list_active');
				$scope.select_user_id = rd[0].user_id;
				$scope.lv_app_data.approver_list = [];
				$scope.lv_app_data.approver_list.push({
				  img:rd[0].img_src,
				  name:rd[0].empl_name,
				  user_id:rd[0].user_id,
				  employee_no:rd[0].empl_no,
				  flag:1
				});
				$scope.approver_list=$scope.lv_app_data.approver_list;
			}
		});

    }
    $scope.openModal2 = function() {
		var selectEmplList = '';
		if ($scope.lv_app_data.notify_list.length != 0){
			for (var i=0;i<$scope.lv_app_data.notify_list.length;i++){
				selectEmplList += $scope.lv_app_data.notify_list[i].employee_no;
				if (i < $scope.lv_app_data.notify_list.length - 1){
					selectEmplList += ',';
				}
			}

		}

		$emplComponentService.open({
			title : '选择知会人', //弹开窗口标题
			barTitle : window.localStorage["org_top_level"],//导航开头
			isSingleSelect:false,//是否单选
			isShowContact:true,//是否展示常用联系人
			isNeedSaveContact:true,//是否保存常用联系人
			extName : '员工', //多选时提示后缀名
			selectEmplList:selectEmplList, //打开窗口默认选中员工列表
			/*
			params:{ //支持可用扩展参数
				"is_permissions":"0",
				"is_process":"0",
				"process_instance":'0',
				"ext_param":"aa"
			},
			*/
			sure : function (rd) { //返回数据，数组格式
				$('#essLvApply #notify_list_div').removeClass('notify_list_active');
				$scope.select_notify_id = '';
				$scope.lv_app_data.notify_list = [];
				for(var i=0;i<rd.length;i++){

					$scope.select_notify_id = $scope.select_notify_id + rd[i].user_id;
					$scope.lv_app_data.notify_list.push({
					  img:rd[i].img_src,
					  name:rd[i].empl_name,
					  user_id:rd[i].user_id,
					  employee_no:rd[i].empl_no,
					  flag:1
					});
					if (i < rd.length - 1){
						$scope.select_notify_id += ',';
					}
				}

				document.getElementById('notify_list_div').style.width=($scope.lv_app_data.notify_list.length+1)*100+20+'px';
				$ionicScrollDelegate.$getByHandle("notify_list_scroll").resize();
			}
		});

    }
    $scope.closeModal = function() {
      $scope.modal.hide();
      $scope.ess_empl_data = [];
      $scope.search_control.search_val='';
    }
    $scope.$on('$destroy', function() {
      $scope.modal.remove();
    });
  })
  .controller('essLvApproveCtrl',function($scope,essLvApproveSev,$ionicPopover,$location){
	  /*Sunny改*/
	  $scope.ess_pending_treatment = local_resource + 'img/icon/ess_pending_treatment@2x.png';
	  $scope.ess_processed = local_resource + 'img/icon/ess_processed@2x.png';
	  $scope.ess_approve_unhide_all = local_resource + 'img/icon/ess_approve_unhide_all@2x.png';
	  /*Sunny改*/
    /*chirs改*/
    $scope.icon_filter=local_resource + 'img/icon/icon_filter.png';
    /*chris改*/
    $scope.search_val = "";
	essLvApproveSev.clearData();
    essLvApproveSev.loadEssApproveData();
    $scope.ess_approve_data = essLvApproveSev.getEssApproveData();

    $scope.search_val = "";
    $scope._flag = "待处理";
    $scope.loadLvDetails = function(p_inst,show_type,app_status,task_id){
      var _status = app_status=='待处理'?'UC':'C';
      $location.path("home_page/leave_approve_details/"+p_inst+"/"+show_type+"/"+_status+"/"+task_id);
    }

    $scope.filterLvApprove = function(flag){
      $scope._flag = flag;
      $scope.closePopover();
    }
    $ionicPopover.fromTemplateUrl("ess-leave-approve.html", {
      scope: $scope
    })
      .then(function(popover){
        $scope.popover = popover;
      })

    $scope.openPopover = function($event) {
      $scope.popover.show($event);
    };
    $scope.closePopover = function() {
      $scope.popover.hide();
    };
    //销毁事件回调处理：清理popover对象
    $scope.$on("$destroy", function() {
      $scope.popover.remove();
    });
  })
  .controller('essLvApDetailCtrl',function($scope,essLvApDetailSev,$stateParams,essLvApplySev,$ionicModal){
	  /*Sunny改*/
	  $scope.dates_line2x = local_resource + 'img/model/dates-line2x.png';
	  $scope.icon_apply = local_resource + 'img/model/icon-apply@2x.png';
	  $scope.approval_line = local_resource + 'img/model/approval-line@2x.png';
	  $scope.icon_confirm = local_resource + 'img/model/icon-confirm@2x.png';
	  $scope.approval_line_gray = local_resource + 'img/model/approval-line-gray@2x.png';
	  $scope.icon_waiting = local_resource + 'img/model/wait_approval.png';
    $scope.icon_wait = local_resource + 'img/model/icon-waiting@2x.png';
	  $scope.approval_line_gray = local_resource + 'img/model/approval-line-gray@2x.png';
	  $scope.add_approver = local_resource + 'img/model/add_approver.png';
    $scope.add_approver_ = local_resource + 'img/model/add_approver_.png';
	  /*Sunny改*/
	essLvApDetailSev.clearData();
    essLvApDetailSev.loadData($stateParams.p_inst,$stateParams.show_type,$stateParams.my_result_status,$stateParams.task_id);
    $scope.ess_app_detail_data = essLvApDetailSev.getData();

    $scope.ess_empl_data = [];
    $scope.select_user_id='';
    $ionicModal.fromTemplateUrl('ess-approve-modal.html', {
      scope: $scope,
      animation: 'slide-in-up'
    }).then(function(modal) {
      $scope.modal = modal;
    });
    $scope.openModal = function() {
      $scope.search_val = '';
      $scope.ess_empl_data = [];
      essLvApplySev.loadEssEmplData($scope.select_user_id,$scope.ess_app_detail_data.employee_no,$scope.ess_app_detail_data.process_instance);
      $scope.ess_empl_data = essLvApplySev.getEssEmplData();
      $scope.modal.show();
    };
    $scope.closeModal = function() {
      $scope.modal.hide();
      $scope.ess_empl_data = [];
    };
    $scope.$on('$destroy', function() {
      $scope.modal.remove();
    });
    $scope.essItemCk = function(user_id,img,en){
      var _d = [];
      $scope.select_user_id = user_id;
      _d = $scope.ess_app_detail_data.approver_list;
      var flag = 0;
      var _len = _d.length;
      for(var i=0;i<_len;i++){
        if(angular.isDefined(_d[i]._flag)&&_d[i]._flag==1){
          flag = 1;
          break;
        }
      }
      if(flag == 0){
        _d.push({
          img:img,
          name:en,
          user_id:user_id,
          color:"#999",
          action:'下一层审批人',
          flag:1,
          _flag:1
        })
      }else{
        _d[_len-1] = {
          img:img,
          name:en,
          color:"#999",
          action:'下一层审批人',
          flag:1,
          user_id:user_id,
          _flag:1
        }
      }
      $scope.closeModal();
    }

    $scope.applyReject = function(){
      essLvApDetailSev.applyReject($scope.select_user_id);
    }
    $scope.applyApprove = function(){
      essLvApDetailSev.applyApprove($scope.select_user_id);
    }
  })
  .controller('essMyApplyCtrl',function($scope,essMyApplySev,$ionicPopover,$location){
	  /*Sunny改*/
	  $scope.ss_not_completed = local_resource + 'img/icon/ess_not_completed@2x.png';
	  $scope.ess_has_been_completed = local_resource + 'img/icon/ess_has_been_completed@2x.png';
	  $scope.ess_unhide_all = local_resource + 'img/icon/ess_unhide_all@2x.png';
	  /*Sunny改*/
    $scope.apply_leave_icon = local_resource + 'img/icon/apply_leave_icon.png';
    $scope.apply_overtime_icon = local_resource + 'img/icon/apply_overtime_iocn.png';
    $scope.apply_field_icon = local_resource + 'img/icon/apply_field_icon.png';
	essMyApplySev.clearData();
    essMyApplySev.loadData();
    //$scope.search_val = "";
    $scope.my_apply_icon= local_resource +'img/menus/';
    $scope.ess_my_apply_data = essMyApplySev.getData();


    $scope.loadMyApply = function(name,type){
      if(type=="leave") {
		fufuMobclickAgent('menu_ess_my_apply_details');
        $location.path("home_page/ess_my_apply_details/" + name + "/" + type);
      }
      else if(type=="fieldwork"){
		fufuMobclickAgent('menu_ess_my_apply_details_fieldwork');
        $location.path("home_page/ess_my_apply_details_fieldwork/" + name + "/" + type);
      }
      else if(type=='overtime'){
		fufuMobclickAgent('menu_ess_my_ot_apply_details');
        $location.path("home_page/ess_my_ot_apply_details/" + name + "/" + type);
      }
      else if(type=='fieldwork_bill'){
		fufuMobclickAgent('menu_ess_my_out_apply_details');
        $location.path("home_page/ess_my_out_apply_details/" + name + "/" + type);
      }
      else if(type=='offic_work_out'){
		fufuMobclickAgent('menu_ess_my_apply_details_offic_work_out');
        $location.path("home_page/ess_my_apply_details_offic_work_out/" + name + "/" + type);
      }
      else if(type=='at_daily_adj'){
		//fufuMobclickAgent('menu_ess_my_apply_details_offic_work_out');
        $location.path("home_page/ess_my_card_adj_apply_details/" + name + "/" + type);
      }
    }
  })
  .controller('essMyApplyDCtrl',function($scope,essMyApplyDSev,essLvApplySev,$stateParams,$ionicModal,$location,$ionicScrollDelegate,$ionicHistory,$timeout){

    if (ionic.Platform.isIOS()) {
      essMyApplyDSev.clearData();
      essMyApplyDSev.loadData($stateParams.type, 'UC');
      $scope.ess_my_applyD_data = essMyApplyDSev.getData();
    } else {
      $scope.$on("$ionicView.enter", function () {
        //解决 进入明细页面back回来的时候 会再次loaddata
        if (typeof($scope.data_loaded) != 'undefined') {
          return;
        }
        else {
          $scope.data_loaded = true;
        }
        essMyApplyDSev.clearData();
        essMyApplyDSev.loadData($stateParams.type, 'UC');
        $scope.ess_my_applyD_data = essMyApplyDSev.getData();
      });
    }
    //essMyApplyDSev.clearData();
    //essMyApplyDSev.loadData($stateParams.type,'UC');
    ////essMyApplyDSev.loadOtherData($stateParams.type,'C');
    //$scope.ess_my_applyD_data = essMyApplyDSev.getData();
    //$scope.ess_my_applyD_other_data = essMyApplyDSev.getOtherData();
    $scope.search_control = essMyApplyDSev.getSearchValue();

    $scope.show_search = false;
    $scope.toggle_search = function() {
      $scope.show_search = true;
      $ionicScrollDelegate.scrollTop();
    }
    $scope.cancel_search = function() {
      $scope.show_search = false;
      $scope.search_control.search_val = '';
    }

    $scope._flag = "未完成";
    $scope.noapprove_click=function(){
      $scope._flag = "未完成";
      document.getElementById('my_apply_details_noapprove').style.color='#53afff';
      document.getElementById('my_apply_details_approved').style.color='#808080';
      document.getElementById('ess_my_apply_details_tab_animate_div').style.webkitTransform='translateX(0)';
      document.getElementById('ess_my_apply_details_wrap').style.webkitTransform='translateX(0)';
      document.getElementById('ess_my_apply_details_wrap').style.overflow="visible";
      document.getElementById('ess_my_apply_details_noapprove_div').setAttribute("style","width:50%;");
      document.getElementById('ess_my_apply_details_approved_div').setAttribute("style","width: 50%;position: absolute;left:50%;top:0px;");
        $timeout(function(){ $ionicScrollDelegate.resize();
          document.getElementById('ess_my_apply_details_wrap').style.overflow="hidden";
        }, 200);



    }
    $scope.approved_click=function(){
      $scope._flag = "已完成";
      document.getElementById('my_apply_details_noapprove').style.color='#808080';
      document.getElementById('my_apply_details_approved').style.color='#53afff';
      document.getElementById('ess_my_apply_details_tab_animate_div').style.webkitTransform='translateX(100%)';
      document.getElementById('ess_my_apply_details_wrap').style.webkitTransform='translateX(-50%)';
      document.getElementById('ess_my_apply_details_wrap').style.overflow="visible";
      document.getElementById('ess_my_apply_details_noapprove_div').setAttribute("style","width:50%;position: absolute;left:0px;top:0px;");
      document.getElementById('ess_my_apply_details_approved_div').setAttribute("style","width: 50%;float: right");
        $timeout(function(){ $ionicScrollDelegate.resize();
          document.getElementById('ess_my_apply_details_wrap').style.overflow="hidden";
        }, 200);


    }
    $scope.loadMyApplyContent=function(p_inst,show_type,task_id,s_t,is_process,app_id){

      $location.path("home_page/ess_my_apply_details_content/"+p_inst+"/"+show_type+"/"+task_id+"/"+s_t+"/"+is_process+"/"+app_id+"/my_apply");
    }

    $scope.OnDrapUp=function(){
      $scope.show_search = false;
      $scope.search_control.search_val = '';
    }
    $scope.OnDrapDown=function(){
      $scope.show_search = true;

    }
  })

  .controller('essMyApplyDFCtrl',function($scope,essMyApplyDSev,essLvApplySev,$stateParams,$ionicModal,$location,$ionicScrollDelegate,$ionicHistory,$timeout){
    if (ionic.Platform.isIOS()) {
      essMyApplyDSev.clearData();
      essMyApplyDSev.loadData($stateParams.type,"UC");
      $scope.ess_my_applyD_data = essMyApplyDSev.getData();
    } else {
      $scope.$on("$ionicView.enter", function () {
        //解决 进入明细页面back回来的时候 会再次loaddata
        if (typeof($scope.data_loaded) != 'undefined') {
          return;
        }
        else {
          $scope.data_loaded = true;
        }
        essMyApplyDSev.clearData();
        essMyApplyDSev.loadData($stateParams.type,"UC");
        $scope.ess_my_applyD_data = essMyApplyDSev.getData();
      });
    }
    //$scope.$on("$ionicView.enter", function () {
    //  //解决 进入明细页面back回来的时候 会再次loaddata
    //  if (typeof($scope.data_loaded) != 'undefined'){
    //    return;
    //  }
    //  else {
    //    $scope.data_loaded = true;
    //  }
    //  essMyApplyDSev.clearData();
    //  essMyApplyDSev.loadData($stateParams.type,"UC");
    //  $scope.ess_my_applyD_data = essMyApplyDSev.getData();
    //});
    $scope.address_icon= local_resource+ 'img/icon/address_icon.png'

    $scope.search_control = essMyApplyDSev.getSearchValue();
    //$scope.search_control.search_val = "";
    $scope.show_search = false;
    $scope.toggle_search = function() {
      $scope.show_search = true;
      $ionicScrollDelegate.scrollTop();
    }
    $scope.cancel_search = function() {
      $scope.show_search = false;
      $scope.search_control.search_val = '';
    }

	 // essMyApplyDSev.clearData();
    //essMyApplyDSev.loadData($stateParams.type,"UC");
    ////essMyApplyDSev.loadOtherData($stateParams.type,"C");
    //$scope.ess_my_applyD_data = essMyApplyDSev.getData();
    //$scope.ess_my_applyD_other_data = essMyApplyDSev.getOtherData();
    $scope._flag = "未完成";
    $scope.noapprove_click=function(){
      $scope._flag = "未完成";

      document.getElementById('my_apply_details_noapprove').style.color='#53afff';
      document.getElementById('my_apply_details_approved').style.color='#808080';
      document.getElementById('ess_my_apply_details_tab_animate_div').style.webkitTransform='translateX(0)';
      document.getElementById('ess_my_apply_details_wrap').style.webkitTransform='translateX(0)';
      document.getElementById('ess_my_apply_details_noapprove_div').setAttribute("style","width:50%;");
      document.getElementById('ess_my_apply_details_approved_div').setAttribute("style","width: 50%;position: absolute;left:50%;top:0px;");
      document.getElementById('ess_my_apply_details_wrap').style.overflow="visible";
        $timeout(function(){ $ionicScrollDelegate.resize();
          document.getElementById('ess_my_apply_details_wrap').style.overflow="hidden";
        }, 200);




    }
    $scope.approved_click=function(){
      $scope._flag = "已完成";

      document.getElementById('my_apply_details_noapprove').style.color='#808080';
      document.getElementById('my_apply_details_approved').style.color='#53afff';
      document.getElementById('ess_my_apply_details_tab_animate_div').style.webkitTransform='translateX(100%)';
      document.getElementById('ess_my_apply_details_wrap').style.webkitTransform='translateX(-50%)';
      document.getElementById('ess_my_apply_details_wrap').style.overflow="visible";
        document.getElementById('ess_my_apply_details_noapprove_div').setAttribute("style","width:50%;position: absolute;left:0px;top:0px;");
        document.getElementById('ess_my_apply_details_approved_div').setAttribute("style","width: 50%;float: right");
        $timeout(function(){ $ionicScrollDelegate.resize();
          document.getElementById('ess_my_apply_details_wrap').style.overflow="hidden";
        }, 200);


  }
$scope.loadMyApplyContent=function(p_inst,show_type,task_id,s_t,is_process,rec_id){

  $location.path("home_page/ess_my_apply_details_content_fieldwork/"+p_inst+"/"+show_type+"/"+task_id+"/"+s_t+"/"+is_process+"/"+rec_id+"/my_apply");
}

  })

  .controller('essMyApplyDetailsContentCtrl',function($scope,essMyApplyDetailsContentSev,essLvApplySev,$stateParams,$ionicModal,$ionicActionSheet,$location,$ionicPopup,$timeout,zoomSlider){

    $scope.dates_line2x = local_resource + 'img/model/dates-line2x.png';
    $scope.icon_apply = local_resource + 'img/model/icon-apply@2x.png';
    $scope.approval_line = local_resource + 'img/model/approval-line@2x.png';
    $scope.icon_confirm = local_resource + 'img/model/icon-confirm@2x.png';
    $scope.icon_noappprove = local_resource + 'img/model/icon-noapprove.png';
    $scope.approval_line_gray = local_resource + 'img/model/approval-line-gray@2x.png';
    $scope.icon_waiting = local_resource + 'img/model/wait_approval.png';
    $scope.icon_wait = local_resource + 'img/model/icon-waiting@2x.png';
    $scope.icon_noapprove =local_resource +'img/model/icon-noapprove.png';
    $scope.approval_line_gray = local_resource + 'img/model/approval-line-gray@2x.png';
    $scope.add_approver = local_resource + 'img/model/add_approver.png';
    $scope.add_approver_ = local_resource + 'img/model/add_approver_.png';
    $scope.notify = local_resource + 'img/icon/notify.png';
    $scope.content_left_icon= local_resource + 'img/icon/content-left-icon.png';
	  essMyApplyDetailsContentSev.clearData();
    if($stateParams.is_process==1){
      essMyApplyDetailsContentSev.loadData($stateParams.p_inst,$stateParams.show_type,$stateParams.task_id);
    }
    else{
      essMyApplyDetailsContentSev.loadNoprocessData($stateParams.p_inst,$stateParams.show_type,$stateParams.task_id,$stateParams.app_id);
    }

    $scope.ess_my_applyDC_data = essMyApplyDetailsContentSev.getData();
    var my_app_result='';
    if($stateParams.s_t=="未完成"){
       my_app_result='UC'
    }
    else{
       my_app_result='C'
    }
    $scope.fireEvent = function(i,arr){
      $timeout(function(){
        if(arr[i].action=='拒绝'){
          document.getElementById("approver_list_img"+i).src=$scope.icon_noapprove;
        }
        else if(arr[i].action=='批准'){
          document.getElementById("approver_list_img"+i).src=$scope.icon_confirm;
        }
        if(i==(arr.length-1)){
          document.getElementById("approver_list_img_"+i).style.display="none";
        }
       if(document.getElementById("approver_list_img_"+i)!=null){
         document.getElementById("approver_list_img_"+i).style.height=document.getElementById("approver_list_div" + i).offsetHeight+'px';
         document.getElementById("approver_list_div_"+i).style.height=(document.getElementById("approver_list_div" + i).offsetHeight-16)+'px';
       }
     //if(arr[i].flag=='1'){
     //  document.getElementById("approver_list_img_"+(i-1)).src=$scope.approval_line;
     //}
     //   else if(arr[i].flag=='2'){
     //  document.getElementById("approver_list_img_"+(i-1)).src=$scope.approval_line_gray;
     //}


      }, 0);
    }
    $scope.show_img=function(index){
		zoomSlider.show({data:$scope.ess_my_applyDC_data.attachment_array, index:index})
		return;
		/*
      if (ionic.Platform.isIOS()) {
        window.open(url, '_system', 'enableViewportScale=yes');
      } else {
        window.open(url, '_system');
      }
	  	*/
    }


    $('#_ess_my_apply_d1').change(function(){
      essMyApplyDetailsContentSev.changeEssLvPolicy($scope.ess_my_applyDC_data.default_lv_code_id);
    });
    $('#_ess_my_apply_d2').change(function(){
      essMyApplyDetailsContentSev.changeEssLvPolicy($scope.ess_my_applyDC_data.default_lv_code_id);
    });
    $('#_ess_my_apply_t1').change(function(){
      essMyApplyDetailsContentSev.changeEssLvPolicy($scope.ess_my_applyDC_data.default_lv_code_id);
    });
    $('#_ess_my_apply_t2').change(function(){
      essMyApplyDetailsContentSev.changeEssLvPolicy($scope.ess_my_applyDC_data.default_lv_code_id);
    });
    $scope.changeEssLvPolicy = function(){
      essMyApplyDetailsContentSev.changeEssLvPolicy($scope.ess_my_applyDC_data.default_lv_code_id);
    }

    $scope.search_val = '';
    $scope.ess_empl_data = [];
    $scope.select_user_id = '';
    $scope.select_notify_id = '';
    $scope.click_flag = 0;
    $scope.essItemCk = function(user_id,img,en){
      var _d = [];
      if($scope.click_flag == 0){
        $scope.select_user_id = user_id;
        _d = $scope.ess_my_applyDC_data.approver_list;
      }else{
        return;
      }
      var _len = _d.length;
      if(_len == 0){
        _d.push({
          img:img,
          name:en,
          user_id:user_id,
          flag:2
        })
      }else{
        _d[_len-1] = {
          img:img,
          name:en,
          user_id:user_id,
          flag:2
        }
      }
      $scope.closeModal();
    }

    $scope.selectList = function(){
      if($scope.click_flag==1){
        var _d = [];
        $scope.select_notify_id = '';
        $scope.ess_my_applyDC_data.notify_list = [];
        for(var i=0;i<$scope.ess_empl_data.length;i++){
          if($scope.ess_empl_data[i].ck){
            $scope.select_notify_id = $scope.select_notify_id + ($scope.ess_empl_data)[i].user_id+',';
            $scope.ess_my_applyDC_data.notify_list.push({
              img:($scope.ess_empl_data)[i].img,
              name:($scope.ess_empl_data)[i].en,
              user_id:($scope.ess_empl_data)[i].user_id,
              flag:1
            });
          }
        }
        $scope.select_notify_id = ($scope.select_notify_id).substring(0,$scope.select_notify_id.length-1);
        $scope.closeModal();
      }
    }

    $ionicModal.fromTemplateUrl('ess-my-apply-empl-modal.html', {
      scope: $scope,
      animation: 'slide-in-up'
    }).then(function(modal) {
      $scope.modal = modal;
    });
    $scope.openModal = function() {
      $scope.search_val = '';
      $scope.click_flag = 0;
      $scope.ess_empl_data = [];
      var _d = $scope.ess_my_applyDC_data.approver_list;
      if(_d.length>0){
        var len = _d.length;
        $scope.select_user_id = _d[len-1].user_id;
      }
      essLvApplySev.loadEssEmplData($scope.select_user_id,$scope.ess_my_applyDC_data.employee_no,$scope.ess_my_applyDC_data.process_instance);
      $scope.ess_empl_data = essLvApplySev.getEssEmplData();
      $scope.modal.show();
    };
    $scope.openModal2 = function() {
      $scope.search_val = '';
      $scope.click_flag = 1;
      $scope.ess_empl_data = [];
      var _d = $scope.ess_my_applyDC_data.notify_list;
      $scope.select_notify_id='';
      for(var i=0;i<_d.length;i++){
        $scope.select_notify_id = $scope.select_notify_id + _d[i].user_id+',';
      }
      $scope.select_notify_id = $scope.select_notify_id.substring(0,$scope.select_notify_id.length-1);
      essLvApplySev.loadEssEmplData($scope.select_notify_id,$scope.ess_my_applyDC_data.employee_no,$scope.ess_my_applyDC_data.process_instance);
      $scope.ess_empl_data = essLvApplySev.getEssEmplData();
      $scope.modal.show();
    };
    $scope.closeModal = function() {
      $scope.modal.hide();
      $scope.ess_empl_data = [];
    };
    //$scope.$on('$destroy', function() {
    //  $scope.modal.remove();
    //});

    $scope.submitAction = function(action){
      essMyApplyDetailsContentSev.submitAction(action);
    }
    $scope.cancel= function () {


		if ($scope.ess_my_applyDC_data.action_text == '更多'){
		  var hideSheet = $ionicActionSheet.show({
			buttons: [

			  {
				text: '修改'
			  }, {
				text: '撤销'
			  }
			],

			//titleText: 'Modify your album',
			//titleText: '选择上传图片方式',
			cancelText: '取消',
			//destructiveText: 'Delete',
			cancel: function() {
			  // add cancel code..
			},
			buttonClicked: function(index) {

			  if (index == 0) {
		   if($scope.ess_my_applyDC_data.modify) {
			 $location.path("home_page/ess_my_apply_details_content_Modify/" + $stateParams.p_inst + "/" + $stateParams.show_type + "/" + $stateParams.task_id);
		   }
				else{
			 $ionicPopup.alert({
			   title : '提醒',
			   template : '<div style="text-align: center;">不能修改</div>',
			   okText : '确定'
			 })
		   }
				return true;
			  } else if (index == 1) {
				if($scope.ess_my_applyDC_data.cancel){
				  $ionicPopup.confirm({
					template: '<div style="text-align: center;">确认要撤销吗</div>',
					cancelType:'button-dark',
					cancelText: '取消',
					okText: '确认'
				  }) .then(function(res) {
					if(res) {
					  essMyApplyDetailsContentSev.submitAction('Cancel',my_app_result);
					}
				  });

				}
			  else{
				  $ionicPopup.alert({
					title : '提醒',
					template : '<div style="text-align: center;">不能撤销</div>',
					okText : '确定'
				  })
				}
				return true;
			  }
			  return true;
			}
		  });
	  }
	  else if ($scope.ess_my_applyDC_data.action_text == '修改'){
 			 $location.path("home_page/ess_my_apply_details_content_Modify/" + $stateParams.p_inst + "/" + $stateParams.show_type + "/" + $stateParams.task_id);
	  }
	  else if ($scope.ess_my_applyDC_data.action_text == '撤销'){
			  $ionicPopup.confirm({
				template: '<div style="text-align: center;">确认要撤销吗</div>',
				cancelType:'button-dark',
				cancelText: '取消',
				okText: '确认'
			  }) .then(function(res) {
				if(res) {
				  essMyApplyDetailsContentSev.submitAction('Cancel',my_app_result);
				}
			  });
	  }
	  else {
		  return;
		}

    }

  })

  .controller('essMyApplyDetailsContentFieldworkCtrl',function($scope,essMyApplyDetailsContentFieldworkSev,essLvApplySev,$stateParams,$ionicModal,$ionicActionSheet,$location,$ionicPopup,$timeout,zoomSlider){
    $scope.dates_line2x = local_resource + 'img/model/dates-line2x.png';
    $scope.icon_apply = local_resource + 'img/model/icon-apply@2x.png';
    $scope.approval_line = local_resource + 'img/model/approval-line@2x.png';
    $scope.icon_confirm = local_resource + 'img/model/icon-confirm@2x.png';
    $scope.icon_noappprove = local_resource + 'img/model/icon-noapprove.png';
    $scope.approval_line_gray = local_resource + 'img/model/approval-line-gray@2x.png';
    $scope.icon_waiting = local_resource + 'img/model/wait_approval.png';
    $scope.icon_wait = local_resource + 'img/model/icon-waiting@2x.png';
    $scope.approval_line_gray = local_resource + 'img/model/approval-line-gray@2x.png';
    $scope.add_approver = local_resource + 'img/model/add_approver.png';
    $scope.add_approver_ = local_resource + 'img/model/add_approver_.png';
    $scope.map_icon= local_resource + 'img/icon/map_icon.png';
    $scope.content_left_icon= local_resource + 'img/icon/content-left-icon.png';
    var my_app_result='';
    if($stateParams.s_t=='未完成'){
      my_app_result='UC';
    }
    else{
      my_app_result='C';
    }
    $scope.fireEvent = function(i,arr){
      $timeout(function(){
        if(document.getElementById("approver_list_img_"+i)!=null){
          document.getElementById("approver_list_img_"+i).style.height=document.getElementById("approver_list_div" + i).offsetHeight+'px';
          document.getElementById("approver_list_div_"+i).style.height=(document.getElementById("approver_list_div" + i).offsetHeight-19)+'px';
        }
        //if(arr[i].flag=='1'){
        //  document.getElementById("approver_list_img_"+(i-1)).src=$scope.approval_line;
        //}
        //else if(arr[i].flag=='2'){
        //  document.getElementById("approver_list_img_"+(i-1)).src=$scope.approval_line_gray;
        //}
        try {
          if (i == arr.length - 1) {
            document.getElementById("approver_list_img_" + i).style.display = "none";
          }
        }
        catch(e){

        }
      }, 0);
    }


    $scope.my_approval_show_map=function(longitude,latitude,location){
		getLocation.checkCanLocation(
			function(result){
				if (result == 1){
					  try {
						getLocation.showMapWithCoordinate({latitude: latitude, longitude: longitude, address: location});
					  }
					  catch(e){
						console.log(e.message);
					  }
				}
			}
		);

    }
    $scope.show_img=function(url){
		var temp_array = [];
		temp_array.push(url);
		zoomSlider.show({data:temp_array, index:0});
		/*
      if (ionic.Platform.isIOS()) {
        window.open(url, '_system', 'enableViewportScale=yes');
      } else {
        window.open(url, '_system');
      }
	  */
    }
	essMyApplyDetailsContentFieldworkSev.clearData();
    if($stateParams.is_process==1){
      essMyApplyDetailsContentFieldworkSev.loadData($stateParams.p_inst,$stateParams.show_type,$stateParams.task_id,$scope);
    }
    else{
      essMyApplyDetailsContentFieldworkSev.loadNoprocessData($stateParams.show_type,$stateParams.rec_id,$scope);
    }

    $scope.ess_my_applyDC_Fieldwork_data = essMyApplyDetailsContentFieldworkSev.getData();



    $scope.search_val = '';
    $scope.ess_empl_data = [];
    $scope.select_user_id = '';
    $scope.select_notify_id = '';
    $scope.click_flag = 0;
    $scope.essItemCk = function(user_id,img,en){
      var _d = [];
      if($scope.click_flag == 0){
        $scope.select_user_id = user_id;
        _d = $scope.ess_my_applyDC_Fieldwork_data.approver_list;
      }else{
        return;
      }
      var _len = _d.length;
      if(_len == 0){
        _d.push({
          img:img,
          name:en,
          user_id:user_id,
          flag:2
        })
      }else{
        _d[_len-1] = {
          img:img,
          name:en,
          user_id:user_id,
          flag:2
        }
      }
      $scope.closeModal();
    }

    $scope.selectList = function(){
      if($scope.click_flag==1){
        var _d = [];
        $scope.select_notify_id = '';
        $scope.ess_my_applyDC_Fieldwork_data.notify_list = [];
        for(var i=0;i<$scope.ess_empl_data.length;i++){
          if($scope.ess_empl_data[i].ck){
            $scope.select_notify_id = $scope.select_notify_id + ($scope.ess_empl_data)[i].user_id+',';
            $scope.ess_my_applyDC_Fieldwork_data.notify_list.push({
              img:($scope.ess_empl_data)[i].img,
              name:($scope.ess_empl_data)[i].en,
              user_id:($scope.ess_empl_data)[i].user_id,
              flag:1
            });
          }
        }
        $scope.select_notify_id = ($scope.select_notify_id).substring(0,$scope.select_notify_id.length-1);
        $scope.closeModal();
      }
    }

    $ionicModal.fromTemplateUrl('ess-my-apply-empl-modal.html', {
      scope: $scope,
      animation: 'slide-in-up'
    }).then(function(modal) {
      $scope.modal = modal;
    });
    $scope.openModal = function() {
      $scope.search_val = '';
      $scope.click_flag = 0;
      $scope.ess_empl_data = [];
      var _d = $scope.ess_my_applyDC_Fieldwork_data.approver_list;
      if(_d.length>0){
        var len = _d.length;
        $scope.select_user_id = _d[len-1].user_id;
      }
      essLvApplySev.loadEssEmplData($scope.select_user_id,$scope.ess_my_applyDC_Fieldwork_data.employee_no,$scope.ess_my_applyDC_Fieldwork_data.process_instance);
      $scope.ess_empl_data = essLvApplySev.getEssEmplData();
      $scope.modal.show();
    };
    $scope.openModal2 = function() {
      $scope.search_val = '';
      $scope.click_flag = 1;
      $scope.ess_empl_data = [];
      var _d = $scope.ess_my_applyDC_Fieldwork_data.notify_list;
      $scope.select_notify_id='';
      for(var i=0;i<_d.length;i++){
        $scope.select_notify_id = $scope.select_notify_id + _d[i].user_id+',';
      }
      $scope.select_notify_id = $scope.select_notify_id.substring(0,$scope.select_notify_id.length-1);
      essLvApplySev.loadEssEmplData($scope.select_notify_id,$scope.ess_my_applyDC_data.employee_no,$scope.ess_my_applyDC_data.process_instance);
      $scope.ess_empl_data = essLvApplySev.getEssEmplData();
      $scope.modal.show();
    };
    $scope.closeModal = function() {
      $scope.modal.hide();
      $scope.ess_empl_data = [];
    };
    //$scope.$on('$destroy', function() {
    //  $scope.modal.remove();
    //});

    $scope.submitAction = function(action){
      essMyApplyDetailsContentFieldworkSev.submitAction(action);
    }
    $scope.cancel= function () {

      $ionicPopup.confirm({
        template: '<div style="text-align: center;">确认要撤销吗</div>',
        cancelType:'button-dark',
        cancelText: '取消',
        okText: '确认'
      }) .then(function(res) {
        if(res) {
			  var obj_id = '';
			  var biz_type_key = '';
			  if (typeof($scope.ess_my_applyDC_Fieldwork_data.obj_id) != 'undefined'){
					 obj_id = $scope.ess_my_applyDC_Fieldwork_data.obj_id;
				}
			  if (typeof($scope.ess_my_applyDC_Fieldwork_data.biz_type_key) != 'undefined'){
					 biz_type_key = $scope.ess_my_applyDC_Fieldwork_data.biz_type_key;
				}
            essMyApplyDetailsContentFieldworkSev.submitAction('Cancel',my_app_result,$stateParams.is_process,obj_id,biz_type_key);


        }
      });


    }
  })

  .controller('payrollHomeCtrl',function($scope,payrollHomeSev){
	payrollHomeSev.clearData();
    payrollHomeSev.loadData('');
    $scope.payroll_home_data = payrollHomeSev.getData();
    $('#_payroll_empl_date').change(function(){
      payrollHomeSev.loadData($('#_payroll_empl_date').val());
    })
  })
  .controller('atHomeCtrl',function($scope,atHomeSev,homemessageSev,timeSelect,$ionicScrollDelegate,$ionicPopup,$ionicHistory,$location,$rootScope,$timeout){
    //homemessageSev.loadMessageCount();

	  /*Sunny改*/
	   $scope.dot_normal = local_resource + 'img/icon/dot_normal.png';
	   $scope.dot_abnormal = local_resource + 'img/icon/dot_abnormal.png';
	   $scope.Legal_holiday = local_resource + 'img/icon/Legal_holiday.png';
	   $scope.other_holiday = local_resource + 'img/icon/other_holiday.png';
	   $scope.contract_management_directory1 = local_resource + 'img/icon/contract_management_directory1.png';

    $scope.img_exit_trial_login = local_resource + 'img/icon/exit_trial_login.png';
    if (window.localStorage["is_free_trial_login"] != null && typeof(window.localStorage["is_free_trial_login"]) != 'undefined' && window.localStorage["is_free_trial_login"] != '') {
      document.getElementById("home_at_is_trial_login").style.display='block';
    }
    else {
      document.getElementById("home_at_is_trial_login").style.display='none';
    }


    $scope.free_trial_log_out = function () {
      $ionicPopup.confirm({
        title: '退出登录',
        template: '<div style="text-align: center;">是否退出系统?</div>',
        cancelType:'button-dark',
        cancelText: '取消',
        okText: '确定'
      }).then(function (res) {
        if (res) {
          //$rootScope.showLoading();
          $.ajax({
            type: "GET",
            url: window.localStorage['_remote_server_addr']+'?event=ionicAction.ionicAction.doLogout',
            timeout: _var_timeout,
            success: function (data) {
              $rootScope.hideLoading();
            },
            error:function(data){
              $rootScope.hideLoading();
              /*
               $ionicPopup.alert({
               title : '提醒',
               template : '<div style="text-align: center;">'+fufu_network_error_msg+'</div>',
               okText : '确定'
               });
               */
            }
          });
          $ionicHistory.clearCache();
          $ionicHistory.clearHistory();
          window.localStorage['_pass_word']='';
          window.localStorage['_is_login']=0;
          if (window.localStorage["menu_list"] != null && typeof(window.localStorage["menu_list"]) != 'undefined' && window.localStorage["menu_list"] != ''){
            var model_list = window.localStorage["menu_list"].split(',');
            for (var i=0;i<model_list.length;i++){
              if (model_list[i] != ''){
                window.localStorage[model_list[i]] = '';
              }
            }
          }
          window.localStorage["menu_list"] = '';
          window.localStorage["menu_home"] = '';
          window.localStorage["menu_message"] = '';
          window.localStorage["menu_organization_management"] = '';
          window.localStorage["menu_time"] = '';
          window.localStorage["menu_payroll"] = '';
          window.localStorage["menu_ess"] = '';
          window.localStorage["menu_My_Team"] = '';
          window.localStorage["menu_setting"] = '';
          window.localStorage["personnal_data"] = '';
          window.localStorage['is_free_trial_login'] = '';
          login_init_flag = 0;
          $location.path('/');

        }
      });
    }
	  /*Sunny改*/
	atHomeSev.clearData();
    atHomeSev.loadData('',0);
    var _dateObj = $('#_at_home_date');
    $scope.at_home_data = atHomeSev.getData();
    _dateObj.change(function(){
      atHomeSev.loadData(_dateObj.val(),0);
    })


    $scope._at_home_date = function(){
      var current_date = new Date();
      current_date.setMinutes(current_date.getMinutes() - current_date.getTimezoneOffset());
      current_date = current_date.toJSON().slice(0,4);
      var startDate = parseInt(current_date, 10) - 10;
      startDate = startDate + '-01-01';
      var endDate = parseInt(current_date, 10) + 10;
      endDate = endDate + '-12-31';
      timeSelect.show({
        type :  'date' ,
        startDate :  '1900-01-01',
        endDate : '2099-12-31',
        defaultDate: document.getElementById('_at_home_date_1').innerHTML,
        returnDateType : 'y-m-d',
        returnTimeType :  '24h'||'AMPM',
        //stepping :10,
        selectedFunc : function (date) {
          if (typeof(date) != 'undefined'){
            document.getElementById('_at_home_date_1').innerHTML = date;
            _dateObj.val(date);
            atHomeSev.loadData(_dateObj.val(),0);
          }
        }
      })
    }

    $scope.reAtHomeData = function(_flag){
      atHomeSev.loadData(_dateObj.val(),_flag);
    }
    $scope.loadByDate = function(_day,curobj){
      $("._ar_c").removeClass("_ar_c");
      $(curobj.currentTarget).addClass("_ar_c");
      var _day = parseInt(_day);
      var arr = (_dateObj.val()).split('-');
      if(_day<10){
        _day = '0'+ _day;
      }
      _dateObj.val(arr[0] + '-' + arr[1] + '-' + _day);
      atHomeSev.loadData(_dateObj.val(),0);
      setTimeout(function(){ $ionicScrollDelegate.resize(); }, 200);
    }


    $scope.time_of_out=function(){
      $("#time_of_out").css({
        "color":"#53afff",
        "borderTop":"1px solid #53afff",
        "backgroundColor":"white"
      });
      $("#times_of_in").css({
        "color":"#333",
        "borderTop":"none",
        "backgroundColor":"#f8f8f8"
      });
      $("#home_at_tab_content").css({
        "-webkit-webkitTransform":"translateX(0)"
      });


      document.getElementById('home_at_tab_content').style.overflow="visible";
      document.getElementById('home_at_tab1_div').setAttribute("style","width:50%;");
      document.getElementById('home_at_tab2_div').setAttribute("style","width: 50%;position: absolute;left:50%;top:0px;");
      $timeout(function(){ $ionicScrollDelegate.resize();
        document.getElementById('home_at_tab_content').style.overflow="hidden";
      }, 200);
    }
    $scope.times_of_in=function(){
      $("#times_of_in").css({
        "color":"#53afff",
        "borderTop":"1px solid #53afff",
        "backgroundColor":"white"
      })
      $("#time_of_out").css({
        "color":"#333",
        "borderTop":"none",
        "backgroundColor":"#f8f8f8"
      })
      $("#home_at_tab_content").css({
        "-webkit-webkitTransform":"translateX(-50%)"
      })

      document.getElementById('home_at_tab_content').style.overflow="visible";
      document.getElementById('home_at_tab2_div').setAttribute("style","width:50%;float:right");
      document.getElementById('home_at_tab1_div').setAttribute("style","width: 50%;position: absolute;left:0;top:0px;");
      $timeout(function(){ $ionicScrollDelegate.resize();
        document.getElementById('home_at_tab_content').style.overflow="hidden";
      }, 200);
    }

  })
  .controller('modifyPwdCtrl',function($scope,modifyPwdSev){
    $scope.show_pwd=  local_resource + 'img/icon/show_pwd_icon.png';
    $scope.hide_pwd=  local_resource + 'img/icon/hide_pwd_icon.png';
    $scope.old_psw_flag= true;
    $scope.new_psw_flag= true;
    $scope.pwd_obj = {
      old_pwd:'',
      new_pwd:'',
      confirm_pwd:''
    }
    $scope.modifyPwd = function(){
      if(document.getElementById('modify_pwd_save').style.opacity!='1'){
        return;
      }
      else{
        modifyPwdSev.modifyPwd($scope.pwd_obj.old_pwd,$scope.pwd_obj.new_pwd,$scope.pwd_obj.new_pwd);
      }

    }
    $scope.old_pwd_click=function(flag){
      $scope.old_psw_flag= !flag;
      if(flag){
        $("#modifyPwdold").attr('type','text')
      }
      else{
        $("#modifyPwdold").attr('type','password')
      }
    }
    $scope.new_pwd_click=function(flag){
      $scope.new_psw_flag= !flag;
      if(flag){
        $("#modifyPwdnew").attr('type','text')
      }
      else{
        $("#modifyPwdnew").attr('type','password')
      }
    }

    $("#modifyPwdold").keyup(function(){
      if($("#modifyPwdold").val()!='' && $("#modifyPwdnew").val()!=''){
        document.getElementById('modify_pwd_save').style.opacity='1';
      }
      else{
        document.getElementById('modify_pwd_save').style.opacity='0.5';
      }
    })
    $("#modifyPwdnew").keyup(function(){
      if($("#modifyPwdold").val()!='' && $("#modifyPwdnew").val()!=''){
        document.getElementById('modify_pwd_save').style.opacity='1';
      }
      else{
        document.getElementById('modify_pwd_save').style.opacity='0.5';
      }
    })
  })


    .controller('perDetailCtrl', function($scope, perDetailSev, $location, $timeout, $ionicLoading, $ionicActionSheet,timeSelect,sideSelect,$ionicModal,$ionicHistory,$ionicPopup,perDataDetailSev) {
        /*Sunny改*/
        $scope.edit_data_01 = local_resource + 'img/icon/edit_data_01.png';
    $scope.arrow_right = local_resource + 'img/icon/arrow_right.png';
        /*Sunny改*/
        $scope.show_footer_bar = false;
        //perDetailSev.clearData();
        //perDetailSev.loadStaffMsDetails();
        $scope.staff_master_details = perDataDetailSev.getStaffMsDetails();

    if($scope.staff_master_details.gender_index === ''){
      $("#personnal_details_gender").html('请选择');
      $("#personnal_details_gender").css({
        "color":"#999"
      })
    }
    else{
      $("#personnal_details_gender").html($scope.staff_master_details.gender[$scope.staff_master_details.gender_index].value_)
    }
    if($scope.staff_master_details.id_type_index===''){
      $("#personnal_details_id_type").html('请选择');
      $("#personnal_details_id_type").css({
        "color":"#999"
      })
    }
    else{
      $("#personnal_details_id_type").html($scope.staff_master_details.id_type[$scope.staff_master_details.id_type_index].value_);
    }
    if($scope.staff_master_details.nationality_index===''){
      $("#nationality").html('请选择');
      $("#nationality").css({
        "color":"#999"
      })
    }
    else{
      $("#nationality").html($scope.staff_master_details.nationality[$scope.staff_master_details.nationality_index].value_);
    }
    if($scope.staff_master_details.race_index===''){
      $("#race").html('请选择');
      $("#race").css({
        "color":"#999"
      })
    }
    else{
      $("#race").html($scope.staff_master_details.race[$scope.staff_master_details.race_index].value_);
    }


  $scope.id_type_index=$scope.staff_master_details.id_type_index;
    if( $scope.id_type_index===''){
      $scope.staff_master_details.id_type_data_key='';
    }
    else{
      $scope.staff_master_details.id_type_data_key=$scope.staff_master_details.id_type_data[$scope.id_type_index].key;
    }

    $scope.id_type=function(){
      sideSelect.show({
        type : 'ios',
        data :$scope.staff_master_details.id_type_data,
        selectIndex : $scope.id_type_index,
        selectedFunc : function (index) {
          if(typeof(index)!='undefined'){
            document.getElementById("personnal_details_id_type").innerHTML=$scope.staff_master_details.id_type_data[index].value;
            $scope.staff_master_details.id_type_data_key=$scope.staff_master_details.id_type_data[index].key;
            $scope.id_type_index=index;
          }

        }
      });
    }
    $scope.gender_index=$scope.staff_master_details.gender_index;
    if( $scope.gender_index===''){
      $scope.staff_master_details.gender_data_key='';
    }
    else{
      $scope.staff_master_details.gender_data_key=$scope.staff_master_details.gender_data[$scope.gender_index].key;
    }

    $scope.gender=function(){
      sideSelect.show({
        type : 'ios',
        data :$scope.staff_master_details.gender_data,
        selectIndex : $scope.gender_index,
        selectedFunc : function (index) {
          if(typeof(index)!='undefined'){
            console.log(document.getElementById("personnal_details_gender"));
            document.getElementById("personnal_details_gender").innerHTML=$scope.staff_master_details.gender_data[index].value;
            document.getElementById("personnal_details_gender").style.color="#333";
            $scope.staff_master_details.gender_data_key=$scope.staff_master_details.gender_data[index].key;
            $scope.gender_index=index;
          }
        }
      });
    }
    $scope.nationality_index=$scope.staff_master_details.nationality_index;
    if( $scope.nationality_index===''){
      $scope.staff_master_details.nationality_data_key='';
    }
    else{
      $scope.staff_master_details.nationality_data_key=$scope.staff_master_details.nationality_data[$scope.nationality_index].key;
    }

    $scope.nationality=function(){
      sideSelect.show({
        type : 'ios',
        data :$scope.staff_master_details.nationality_data,
        selectIndex :  $scope.nationality_index,
        selectedFunc : function (index) {
          if(typeof(index)!='undefined'){
            document.getElementById("nationality").innerHTML=$scope.staff_master_details.nationality_data[index].value;
            document.getElementById("nationality").style.color="#333";
            $scope.staff_master_details.nationality_data_key=$scope.staff_master_details.nationality_data[index].key;
            $scope.nationality_index=index;
          }
        }
      });
    }
    $scope.race_index=$scope.staff_master_details.race_index;
    if( $scope.race_index===''){
      $scope.staff_master_details.race_data_key='';
    }
    else {
      $scope.staff_master_details.race_data_key = $scope.staff_master_details.race_data[$scope.race_index].key;
    }
    $scope.race=function(){
      sideSelect.show({
        type : 'ios',
        data :$scope.staff_master_details.race_data,
        selectIndex : $scope.race_index,
        selectedFunc : function (index) {
          if(typeof(index)!='undefined'){
            document.getElementById("race").innerHTML=$scope.staff_master_details.race_data[index].value;
            document.getElementById("race").style.color="#333";
            $scope.staff_master_details.race_data_key=$scope.staff_master_details.race_data[index].key;
            $scope.race_index=index;
          }
        }
      });
    }

    $scope.education_level_index= $scope.staff_master_details.education_level_index;
    if( $scope.education_level_index===''){
      $scope.staff_master_details.education_level_data_key='';
    }
    else{
      $scope.staff_master_details.education_level_data_key=$scope.staff_master_details.education_level_data[$scope.education_level_index].key;
    }

    $scope.education_level=function(){
      sideSelect.show({
        type : 'ios',
        data :$scope.staff_master_details.education_level_data,
        selectIndex : $scope.education_level_index,
        selectedFunc : function (index) {
          if(typeof(index)!='undefined'){
            document.getElementById("education_level").innerHTML=$scope.staff_master_details.education_level_data[index].value;
            document.getElementById("education_level").style.color="#333";
            $scope.staff_master_details.education_level_data_key=$scope.staff_master_details.education_level_data[index].key;
            $scope.education_level_index=index;
          }
        }
      });
    }

    $scope.showDate_join_date = function(){
      var current_date = new Date();
      current_date.setMinutes(current_date.getMinutes() - current_date.getTimezoneOffset());
      current_date = current_date.toJSON().slice(0,4);
      var startDate = parseInt(current_date, 10) - 10;
      startDate = startDate + '-01-01';
      var endDate = parseInt(current_date, 10) + 10;
      endDate = endDate + '-12-31';
      timeSelect.show({
        type :  'date' ,
        startDate :  '1900-01-01',
        endDate : '2099-12-31',
        defaultDate: $scope.staff_master_details.join_date,
        returnDateType : 'y-m-d',
        returnTimeType :  '24h'||'AMPM',
        //stepping :10,
        selectedFunc : function (date) {
          if (typeof(date) != 'undefined'){
            $scope.staff_master_details.join_date = date;

          }
        }
      })
    }
    $scope.showDate_p_c_d = function(){
      var current_date = new Date();
      current_date.setMinutes(current_date.getMinutes() - current_date.getTimezoneOffset());
      current_date = current_date.toJSON().slice(0,4);
      var startDate = parseInt(current_date, 10) - 10;
      startDate = startDate + '-01-01';
      var endDate = parseInt(current_date, 10) + 10;
      endDate = endDate + '-12-31';
      timeSelect.show({
        type :  'date' ,
        startDate : '1900-01-01',
        endDate : '2099-12-31',
        defaultDate: $scope.staff_master_details.p_c_d,
        returnDateType : 'y-m-d',
        returnTimeType :  '24h'||'AMPM',
        //stepping :10,
        selectedFunc : function (date) {
          if (typeof(date) != 'undefined'){
            $scope.staff_master_details.p_c_d = date;

          }
        }
      })
    }
    $scope.date_of_birth = function(){
      var current_date = new Date();
      var month=current_date.getMonth()+1;
      var day=current_date.getDate();
      current_date.setMinutes(current_date.getMinutes() - current_date.getTimezoneOffset());
      current_date = current_date.toJSON().slice(0,4);
      var startDate = parseInt(current_date, 10) - 150;
      startDate = startDate + '-01-01';
      var endDate = parseInt(current_date, 10) ;
      //endDate = endDate + '-12-31';
      timeSelect.show({
        type :  'date' ,
        startDate :  '1900-01-01',
        endDate : endDate+"-"+month+"-"+day,
        defaultDate: $scope.staff_master_details.date_of_birth,
        returnDateType : 'y-m-d',
        returnTimeType :  '24h'||'AMPM',
        //stepping :10,
        selectedFunc : function (date) {
          if (typeof(date) != 'undefined'){
            document.getElementById("date_of_birth").innerHTML = date;

          }
        }
      })
    }

    $scope.cancel=function() {
      var pannel_arr = [$("#employee_name").val(), $scope.staff_master_details.gender_data_key, document.getElementById("date_of_birth").innerHTML, $scope.staff_master_details.id_type_data_key, $("#id_number").val(), $scope.staff_master_details.nationality_data_key, $("#p_o_b").val(), $scope.staff_master_details.race_data_key, $("#address").val(), $("#mobile_no").val(), $("#email").val(), $("#emergency_contact_name1").val(), $("#emergency_contact_no1").val()];
      var loaddata_arr = [$scope.staff_master_details.employee_name, $scope.staff_master_details._gender_key, $scope.staff_master_details.date_of_birth, $scope.staff_master_details._id_type_key, $scope.staff_master_details.id_number, $scope.staff_master_details._nationality_key, $scope.staff_master_details.p_o_b, $scope.staff_master_details._race_key, $scope.staff_master_details.address, $scope.staff_master_details.home_tel_no, $scope.staff_master_details.email, $scope.staff_master_details.emergency_contact_name1, $scope.staff_master_details.emergency_contact_no1]
      var _i = 0;
      for (var i = 0; i < pannel_arr.length; i++) {
        if (pannel_arr[i] != loaddata_arr[i]) {
          _i++;
          break;
        }
      }
      if (_i == 0 && !$scope.is_require_upload) {
        $ionicHistory.goBack()
      }
      else {
        $ionicPopup.confirm({
          title: '',
          template: '<div style="text-align: center;">是否放弃当前编辑</div>',
          cancelText: '放弃',
          cancelType: 'button-dark',
          okText: '继续编辑'
        }).then(function (res) {
          if (!res) {
            $ionicHistory.goBack()
          }
        });
      }
    }
        $scope.picklist_position = function() {
            //$location.path('home_page/home_menulist/personnal_details_position_tree_picklist/' + $("#o_n_i").val() + '/' + $("#dept_name_div").html() + '/' + $("#p_n_i").val() + '/' + $("#position_name_div").html() + '/' + 'personnal_details');
            // use this temporary until apple approve newest app with tree plugin include
            $location.path('home_page/home_menulist/temp_personnal_details_position_picklist/' + $("#o_n_i").val() + '/' + $("#dept_name_div").html() + '/' + $("#p_n_i").val() + '/' + $("#position_name_div").html());
        }
      $scope.is_require_upload= false;
        $scope.change_photo = function() {
            // Show the action sheet
            var hideSheet = $ionicActionSheet.show({
                buttons: [

                    {
                        text: '拍照'
                    }, {
                        text: '从手机相册选择'
                    }
                ],

                //titleText: 'Modify your album',
                titleText: '选择上传图片方式',
                cancelText: '取消',
                cancel: function() {
                    // add cancel code..
                },
                buttonClicked: function(index) {

                    if (index == 0) {

                        try {
                            navigator.camera.getPicture(function(uri) {
                                $('#personnal_details_employee_photo').attr("src", uri);
                              $scope.is_require_upload=true;
                            }, function() {
                                //alert('cancel or failure');
                            }, {
								allowEdit: true,
								destinationType: Camera.DestinationType.FILE_URI,
								quality: 10,
								targetHeight: 500,
								targetWidth: 500,
								correctOrientation: true
                            });
                        } catch (e) {
                            //alert(e.message);
                        }




                        return true;
                    } else if (index == 1) {
                        try {
                            navigator.camera.getPicture(function(uri) {
                                $('#personnal_details_employee_photo').attr("src", uri);
                              $scope.is_require_upload=true;

                            }, function(message) {}, {
                                quality: 100,
                                destinationType: Camera.DestinationType.FILE_URI,
                                // In this app, dynamically set the picture source, Camera or photo gallery
                                sourceType: Camera.PictureSourceType.SAVEDPHOTOALBUM,
                                encodingType: Camera.EncodingType.JPEG,
                                mediaType: Camera.MediaType.PICTURE,
                                allowEdit: true,
                                targetHeight: 500,
                                targetWidth: 500,
                                correctOrientation: true
                            });
                        } catch (e) {
                            //alert(e.message);
                        }

                        return true;
                    }

                    return true;


                }
            });

            // For example's sake, hide the sheet after two seconds
            /*
            $timeout(function() {
            hideSheet();
            }, 2000);
            */

        }

    $scope.saveStaffDetails = function() {
      if($scope.is_require_upload){
        perDetailSev.saveStaffDetailsWithUpload($scope);
      }
      else{
        perDetailSev.saveStaffDetails($scope);
      }

    }
    })



  .controller('findPwdCtrl',function($scope,findPwdSev,$stateParams){
    $scope.find_pwd_data = {};
    $scope.find_pwd_data = findPwdSev.getFindPwdData();
    $scope.find_pwd_data.valid_code=$stateParams.valid_code;
    $scope.find_pwd_data.tel_no=$stateParams.tel_no;
    $scope.sendPwdVCode = function(){
      if(document.getElementById("send_vcode").style.opacity=='1'){
        findPwdSev.sendPwdVCode();
      }
      else{
        return;
      }
    }

    $scope.show_pwd=  local_resource + 'img/icon/show_pwd_icon.png';
    $scope.hide_pwd=  local_resource + 'img/icon/hide_pwd_icon.png';
    $scope.old_psw_flag= true;
    $scope.new_psw_flag= true;

    $scope.old_pwd_click=function(flag){
      $scope.old_psw_flag= !flag;
      if(flag){
        $("#findpwd").attr('type','text')
      }
      else{
        $("#findpwd").attr('type','password')
      }
    }
    $scope.new_pwd_click=function(flag){
      $scope.new_psw_flag= !flag;
      if(flag){
        $("#findconfirmpwd").attr('type','text')
      }
      else{
        $("#findconfirmpwd").attr('type','password')
      }
    }
    document.getElementById("findpwd").oninput=function(){
      if(document.getElementById("findpwd").value!='' && document.getElementById("findconfirmpwd").value!=''){
        document.getElementById("find_pwd_save").style.opacity='1';
      }
      else{
        document.getElementById("find_pwd_save").style.opacity='0.5';
      }
    }
    document.getElementById("findconfirmpwd").oninput=function(){
      if(document.getElementById("findpwd").value!='' && document.getElementById("findconfirmpwd").value!=''){
        document.getElementById("find_pwd_save").style.opacity='1';
      }
      else{
        document.getElementById("find_pwd_save").style.opacity='0.5';
      }
    }

    //var reg = /^1[3|4|5|7|8]\d{9}$/;
    //document.getElementById("forget_tel_no").oninput=function(){
    //  if (!reg.test(document.getElementById("forget_tel_no").value)){
    //    document.getElementById("send_vcode").style.opacity='0.5';
    //  }
    //  else{
    //    document.getElementById("send_vcode").style.opacity='1';
    //  }
    //
    //  if(document.getElementById("forget_valid_code").value!='' && document.getElementById("forget_tel_no").value!=''){
    //    document.getElementById("forget_button").style.opacity='1';
    //  }
    //  else{
    //    document.getElementById("forget_button").style.opacity='0.5';
    //  }
    //
    //}
    //document.getElementById("forget_valid_code").oninput=function(){
    //  if(document.getElementById("forget_valid_code").value!='' && document.getElementById("forget_tel_no").value!=''){
    //    document.getElementById("forget_button").style.opacity='1';
    //  }
    //  else{
    //    document.getElementById("forget_button").style.opacity='0.5';
    //  }
    //}

    $scope.findPwdAction = function(){
      //if(document.getElementById("forget_button").style.opacity=='1'){
      //  findPwdSev.sendPwdVCode();
      //}
      //else{
      //  return;
      //}
      if(document.getElementById("find_pwd_save").style.opacity=='1'){

        findPwdSev.findPwdAction();
      }
      else{
        return;
      }

    }
  })


  .controller('regetPwdCtrl',function($scope,regetPwdSev){
    $scope.find_pwd_data = {};
    $scope.find_pwd_data = regetPwdSev.getFindPwdData();
    $scope.is_can_submit=false;

    $scope.sendPwdVCode = function(){
      if(document.getElementById("send_vcode").style.opacity=='1'){
        regetPwdSev.sendPwdVCode($scope);
      }
      else{
        return;
      }
    }

    var reg = /^1[3|4|5|7|8]\d{9}$/;
	//alert(document.getElementById("forget_tel_no").value)


      $scope.$on("$ionicView.enter", function () {
      if (!reg.test(document.getElementById("forget_tel_no").value)){
    document.getElementById("send_vcode").style.opacity='0.5';
    }
    else{
    document.getElementById("send_vcode").style.opacity='1';
    }
      });

    document.getElementById("forget_tel_no").oninput=function(){
	if (!reg.test(document.getElementById("forget_tel_no").value)){
    document.getElementById("send_vcode").style.opacity='0.5';
    }
    else{
    document.getElementById("send_vcode").style.opacity='1';
    }

      if(document.getElementById("forget_valid_code").value!='' && document.getElementById("forget_tel_no").value!='' ){
        document.getElementById("_find_pwd_action").style.opacity='1';
      }
      else{
        document.getElementById("_find_pwd_action").style.opacity='0.5';
      }

    }
    document.getElementById("forget_valid_code").oninput=function(){
      if(document.getElementById("forget_valid_code").value!='' && document.getElementById("forget_tel_no").value!='' ){
        document.getElementById("_find_pwd_action").style.opacity='1';
      }
      else{
        document.getElementById("_find_pwd_action").style.opacity='0.5';
      }


    }
    $scope.findPwdAction = function(){

      if(document.getElementById("_find_pwd_action").style.opacity=='1'){
        regetPwdSev.findPwdAction();
      }
      else{
        return;
      }
      //findPwdSev.findPwdAction();
    }
  })

  .controller('atZkLocSetCtrl',function($scope,atZkLocSetSev,$ionicListDelegate,$location){
	atZkLocSetSev.clearData();
    atZkLocSetSev.loadData();
    $scope.at_loc_data = atZkLocSetSev.getData();
    $scope.atZkLocDetail = function(z_id){
      $location.path("home_page/at_zk_loc_set_detail/"+z_id);
      $ionicListDelegate.closeOptionButtons();
    }
    $scope.hideOption = function(){
      $ionicListDelegate.closeOptionButtons();
    }
    $scope.deleteAtZkLocInfo = function(z_id,_index){
      atZkLocSetSev.deleteAtZkLocInfo(z_id,_index);
    }
  })

  .controller('atZkLocSetDetailCtrl',function($scope,$timeout,$ionicScrollDelegate,atZkLocSetDetailSev,$stateParams,$ionicModal,$ionicPopup,$rootScope,$http,sideSelect){
    /*Sunnygai*/
    $scope.fufu_delete02 = local_resource + 'img/icon/fufu_delete02.png';
    $scope.zengjia = local_resource + 'img/model/zengjia.png';
    /*Sunnygai*/
    $scope.search_val = ''
    $scope.at_zk_empl_list = [];
    $scope.search_val2 = ''
    $scope.at_zk_dev_list = [];
    $scope.new_dev = atZkLocSetDetailSev.getNewDev();
    if(ionic.Platform.isIOS()){
      $scope.style_value = 'text-align:center;background-color:#ffffff;padding:0px;margin:63px 0px 0px  0px;height:50px;';
    }else{
      $scope.style_value = 'text-align:center;background-color:#ffffff;padding:0px;margin:45px 0px 0px  0px;height:50px;';
    }
    //$('._at_zk_loc_tab2').hide();
    $('.row .col-50').click(function(){
      if($(this).attr('id')=='_at_zk_loc_tab1'){

      document.getElementById('_at_zk_loc_tab1').style.color='#53afff';
      document.getElementById('_at_zk_loc_tab2').style.color='#808080';
      document.getElementById('_at_zk_loc_tab_animate_div').style.webkitTransform='translateX(0)';
      document.getElementById('_at_zk_loc_wrap').style.webkitTransform='translateX(0)';
      document.getElementById('_at_zk_loc_wrap').style.overflow="visible";
      document.getElementById('_at_zk_loc_tab1_div').setAttribute("style","width:50%;padding-top:20px;");
      document.getElementById('_at_zk_loc_tab2_div').setAttribute("style","width: 50%;position: absolute;left:50%;top:0px;");
        $timeout(function(){ $ionicScrollDelegate.resize();
          document.getElementById('_at_zk_loc_wrap').style.overflow="hidden";
        }, 200);
      }else{
	  document.getElementById('_at_zk_loc_tab1').style.color='#808080';
      document.getElementById('_at_zk_loc_tab2').style.color='#53afff';
      document.getElementById('_at_zk_loc_tab_animate_div').style.webkitTransform='translateX(100%)';
      document.getElementById('_at_zk_loc_wrap').style.webkitTransform='translateX(-50%)';
      document.getElementById('_at_zk_loc_wrap').style.overflow="visible";
      document.getElementById('_at_zk_loc_tab1_div').setAttribute("style","width:50%;padding-top:20px;position: absolute;left:0px;top:0px;");
      document.getElementById('_at_zk_loc_tab2_div').setAttribute("style","width: 50%;float: right");
        $timeout(function(){ $ionicScrollDelegate.resize();
          document.getElementById('_at_zk_loc_wrap').style.overflow="hidden";
        }, 200);
      }
    });
    atZkLocSetDetailSev.loadData($stateParams.z_id);
    $scope.at_loc_detail_data = atZkLocSetDetailSev.getData();

	$scope.sub_bu_select = function(){
      sideSelect.show({
        type : 'ios',
        data :$scope.at_loc_detail_data.sub_bu_list,
        selectIndex :  $scope.at_loc_detail_data.sub_bu_index,
        selectedFunc : function (index) {
          if(typeof(index)!='undefined'){
				  $scope.at_loc_detail_data.sub_bu_key = $scope.at_loc_detail_data.sub_bu_list[index].key;
				  $scope.at_loc_detail_data.sub_bu_value = $scope.at_loc_detail_data.sub_bu_list[index].value;
				  $scope.at_loc_detail_data.sub_bu_index = index;
				  atZkLocSetDetailSev.zkLocSetDetailSubBuSave($stateParams.z_id);
          }
        }
      });
	}

	$scope.device_sub_bu_select = function(){
      sideSelect.show({
        type : 'ios',
        data :$scope.at_zk_dev_list.device_sub_bu_list,
        selectIndex :  $scope.at_zk_dev_list.device_sub_bu_index,
        selectedFunc : function (index) {
          if(typeof(index)!='undefined'){
				  $scope.at_zk_dev_list.device_sub_bu_key = $scope.at_zk_dev_list.device_sub_bu_list[index].key;
				  $scope.at_zk_dev_list.device_sub_bu_value = $scope.at_zk_dev_list.device_sub_bu_list[index].value;
				  $scope.at_zk_dev_list.device_sub_bu_index = index;
          }
        }
      });
	}

$scope.delZkAtDev = function(_sn,index){
      atZkLocSetDetailSev.delZkAtDev(_sn,index);
    }
    $scope.addZkAtEmpl = function(){
      var z_id = $stateParams.z_id;
      var empl_list = '';
      var del_list = '';
      for(var i=0;i<$scope.at_zk_empl_list.length;i++){
        if($scope.at_zk_empl_list[i].ck){empl_list = empl_list + $scope.at_zk_empl_list[i].emp+',';}
        if($scope.at_zk_empl_list[i].status_==1&&!$scope.at_zk_empl_list[i].ck){del_list = del_list + $scope.at_zk_empl_list[i].emp+',';}
      }
      if(angular.isDefined(window.localStorage['_is_login'])&&window.localStorage['_is_login']==true){
        _str = '_user_name='+window.localStorage['_user_name']+'&_pass_word='+window.localStorage['_pass_word']+'&_is_login='+window.localStorage['_is_login']+'&_notification_token='+window.localStorage['_notification_token']+'&_device_type='+window.localStorage['_device_type'];
      }
      $rootScope.showLoading();
      $http.post(window.localStorage['_remote_server_addr']+'?event=zkat.general.execCmd&'+_str,{},{
        timeout:_var_timeout,
        params:{
          sid: "cpe.att.person.deleteUserInfo",
          zoneid: z_id,
          zone_id:z_id,
          sync_type: 2,
          employee_list:del_list.substring(0,del_list.length-1),
          send_type:3
        }
      }).
        success(function(data, status, headers, config) {
          if (angular.isDefined(data.flag)&&data.flag == "1") {
            $http.post(window.localStorage['_remote_server_addr']+'?event=zkat.general.execCmd&'+_str,{},{
              timeout:_var_timeout,
              params:{
                sid: "cpe.att.person.upload",
                send_type: "3",
                zone_id:z_id,
                zoneid: z_id,
                employee_list:empl_list.substring(0,empl_list.length-1),
                sync_type: 2
              }
            }).
              success(function(data, status, headers, config) {
                $rootScope.hideLoading();
                if (angular.isDefined(data.flag)) {
                  $ionicPopup.alert({
                    title: '运行结果',
                    template: '<div style="text-align: center;">'+data.message+'</div>',
                    okText: '确定'
                  })
                    .then(function(res) {
						fufuMobclickAgent('click_location_add_employee');
                      $scope.closeModal();
                    });
                }else{
                  $ionicPopup.alert({
                    title : '提醒',
                    template : '<div style="text-align: center;">操作执行出错</div>',
                    okText : '确定'
                  })
                }
              }).
              error(function(data, status, headers, config) {
                $rootScope.hideLoading();
                $ionicPopup.alert({
                  title : '提醒',
                  template : '<div style="text-align: center;">'+fufu_network_error_msg+'</div>',
                  okText : '确定'
                })
              });
          }else{
            $rootScope.hideLoading();
            $ionicPopup.alert({
              title : '提醒',
              template : '<div style="text-align: center;">操作执行出错</div>',
              okText : '确定'
            })
          }
        }).
        error(function(data, status, headers, config) {
          $rootScope.hideLoading();
          $ionicPopup.alert({
            title : '提醒',
            template : '<div style="text-align: center;">'+fufu_network_error_msg+'</div>',
            okText : '确定'
          })
        });
    }

    $scope.delAtZkLocDev = function(d_sn,_index){
      atZkLocSetDetailSev.delAtZkLocDev($stateParams.z_id,d_sn,_index);
    }

    $scope.addAtZkNewDev = function(){
      if($scope.new_dev.d_name==''||$scope.new_dev.d_sn==''){
        $ionicPopup.alert({
          title: '运行结果',
          template: '<div style="text-align: center;">设备信息不能为空</div>',
          okText: '确定'
        });
        return;
      }
      var _str = '';
      if(angular.isDefined(window.localStorage['_is_login'])&&window.localStorage['_is_login']==true){
        _str = '_user_name='+window.localStorage['_user_name']+'&_pass_word='+window.localStorage['_pass_word']+'&_is_login='+window.localStorage['_is_login']+'&_notification_token='+window.localStorage['_notification_token']+'&_device_type='+window.localStorage['_device_type'];
      }
      var date = new Date();
      var month = (date.getMonth() + 1) <= 9 ? '0' + (date.getMonth() + 1) : (date.getMonth() + 1);
      var day = (date.getDate()) <= 9 ? '0' + (date.getDate()) : (date.getDate());
      var inputdate = date.getFullYear() + "-" + month + "-" + day;
      $rootScope.showLoading();
      $.ajax({
        type: "POST",
        timeout:_var_timeout,
        data: {
          update_data:encodeURIComponent('sn:' + $scope.new_dev.d_sn + '\n' + 'id:' + $scope.at_loc_detail_data._b + '\n' + 'status:0' + '\n' + 'input_date:'),
          device_sn:$scope.new_dev.d_sn,
          device_name:$scope.new_dev.d_name,
		  sub_bu: $scope.at_zk_dev_list.device_sub_bu_key
        },
        url: window.localStorage['_remote_server_addr']+"?event=zkat.general.addsn&data=" + encodeURIComponent('sn:' + $scope.new_dev.d_sn + '\n' + 'id:' + $scope.at_loc_detail_data._b + '\n' + 'status:1' + '\n' + 'input_date:' + inputdate),
        success: function (json) {
          $rootScope.hideLoading();
          var data = $.parseJSON(json);
          $ionicPopup.alert({
            title: '运行结果',
            template: '<div style="text-align: center;">'+data.message+'</div>',
            okText: '确定'
          })
            .then(function(res) {
              if(angular.isDefined(data)&&data.flag=='0'){
				  fufuMobclickAgent('click_location_add_device');
                $scope.at_zk_dev_list.dev_list.push({
                  d_name:$scope.new_dev.d_name,
                  d_sn:$scope.new_dev.d_sn
                });
                $scope.new_dev.d_name='';
                $scope.new_dev.d_sn='';
              }
            });
        },
        error:function(){
          $rootScope.hideLoading();
          $ionicPopup.alert({
            title : '提醒',
            template : '<div style="text-align: center;">'+fufu_network_error_msg+'</div>',
            okText : '确定'
          })
        }
      })
    }
    $scope.selectDevList = function(){
      var sn_list = '';
      var dev_list = '';
      for(var i=0;i<$scope.at_zk_dev_list.dev_list.length;i++){
        if($scope.at_zk_dev_list.dev_list[i].ck){sn_list = sn_list + $scope.at_zk_dev_list.dev_list[i].d_sn+',';dev_list = dev_list + $scope.at_zk_dev_list.dev_list[i].d_name+','+$scope.at_zk_dev_list.dev_list[i].d_sn+'||';}
      }
      if(sn_list==''){
        $ionicPopup.alert({
          title: '运行结果',
          template: '<div style="text-align: center;">请选中考勤机设备</div>',
          okText: '确定'
        });
        return;
      }
      var _str = '';
      if(angular.isDefined(window.localStorage['_is_login'])&&window.localStorage['_is_login']==true){
        _str = '_user_name='+window.localStorage['_user_name']+'&_pass_word='+window.localStorage['_pass_word']+'&_is_login='+window.localStorage['_is_login']+'&_notification_token='+window.localStorage['_notification_token']+'&_device_type='+window.localStorage['_device_type'];
      }
      $rootScope.showLoading();
      $http.post(window.localStorage['_remote_server_addr']+'?event=zkat.general.execCmd&'+_str,{},{
        timeout:_var_timeout,
        params:{
          sid: "cpe.att.person.upload",
          send_type: "3",
          zoneid: $stateParams.z_id,
          sn: sn_list.substring(0,sn_list.length-1),
          device_sn_list:sn_list.substring(0,sn_list.length-1),
          zone_id:$stateParams.z_id,
          sync_type: 3
        }
      }).
        success(function(data, status, headers, config) {
          $rootScope.hideLoading();
          if (angular.isDefined(data.flag)) {
            $ionicPopup.alert({
              title: '运行结果',
              template: '<div style="text-align: center;">'+data.message+'</div>',
              okText: '确定'
            })
              .then(function(res) {
                $scope.closeModal2();
              });
          }else{
            $ionicPopup.alert({
              title : '提醒',
              template : '<div style="text-align: center;">操作执行出错</div>',
              okText : '确定'
            })
          }
        }).
        error(function(data, status, headers, config) {
          $rootScope.hideLoading();
          $ionicPopup.alert({
            title : '提醒',
            template : '<div style="text-align: center;">'+fufu_network_error_msg+'</div>',
            okText : '确定'
          })
        });

    }
    $scope.saveZkEmpl = function(){
      var count = 0;
      for(var i=0;i<$scope.at_zk_empl_list.length;i++){
        if($scope.at_zk_empl_list[i].ck){count = count + 1;}
      }
      $('.zk-select-list').text('选中('+count+')');
    }

    $scope.saveZkDev = function(){
      var count = 0;
      for(var i=0;i<$scope.at_zk_dev_list.dev_list.length;i++){
        if($scope.at_zk_dev_list.dev_list[i].ck){count = count + 1;}
      }
      $('.zk-select_dev-list').text('选中('+count+')');
    }

    $ionicModal.fromTemplateUrl('at-zk-empl-list.html', {
      scope: $scope,
      animation: 'slide-in-up'
    }).then(function(modal) {
      $scope.modal = modal;
    });

    $scope.openModal = function() {
      $scope.search_val = '';
      $scope.at_zk_empl_list = [];
      atZkLocSetDetailSev.loadZkEmplList($stateParams.z_id);
      $scope.at_zk_empl_list = atZkLocSetDetailSev.getZkEmplList();
      $scope.modal.show();
    };
    $scope.closeModal = function() {
      $scope.modal.hide();
      $('.zk-select-list').text('选中(0)');
      $scope.at_zk_empl_list = [];
      $scope.search_val = '';
      atZkLocSetDetailSev.loadData($stateParams.z_id);
    };

    $ionicModal.fromTemplateUrl('at-zk-dev-list.html', {
      scope: $scope,
      animation: 'slide-in-up'
    }).then(function(modal) {
      $scope.modal2 = modal;
    });

    $scope.openModal2 = function() {
      $scope.search_val2 = '';
      $scope.at_zk_dev_list = [];
      $scope.new_dev.d_name='';
      $scope.new_dev.d_sn='';
      atZkLocSetDetailSev.loadZkDevList($stateParams.z_id);
      $scope.at_zk_dev_list = atZkLocSetDetailSev.getZkDevList();
      $scope.modal2.show();
    };
    $scope.closeModal2 = function() {
      $scope.modal2.hide();
      $('.zk-select_dev-list').text('选中(0)');
      $scope.at_zk_dev_list = [];
      $scope.search_val2 = '';
      atZkLocSetDetailSev.loadData($stateParams.z_id);
    };
    $scope.$on('$destroy', function() {
      $scope.modal.remove();
      $scope.modal2.remove();
    });
  })

  .controller('atZkLocAddCtrl',function($scope,atZkLocAddSev,$ionicPopup,$rootScope,$http,sideSelect){
    /*Sunny改*/
    $scope.zengjia = local_resource + 'img/model/zengjia.png';
    /*Sunny改*/
	atZkLocAddSev.clearData();
    atZkLocAddSev.loadData();
    $scope.at_loc_add = atZkLocAddSev.getData();
    $scope.new_dev = {
      d_sn:'',
      d_name:''
    };

	$scope.sub_bu_select = function(){
      sideSelect.show({
        type : 'ios',
        data :$scope.at_loc_add.sub_bu_list,
        selectIndex :  $scope.at_loc_add.sub_bu_index,
        selectedFunc : function (index) {
          if(typeof(index)!='undefined'){
				  $scope.at_loc_add.sub_bu_key = $scope.at_loc_add.sub_bu_list[index].key;
				  $scope.at_loc_add.sub_bu_value = $scope.at_loc_add.sub_bu_list[index].value;
				  $scope.at_loc_add.sub_bu_index = index;
          }
        }
      });
	}

	$scope.device_sub_bu_select = function(){
      sideSelect.show({
        type : 'ios',
        data :$scope.at_loc_add.device_sub_bu_list,
        selectIndex :  $scope.at_loc_add.device_sub_bu_index,
        selectedFunc : function (index) {
          if(typeof(index)!='undefined'){
				  $scope.at_loc_add.device_sub_bu_key = $scope.at_loc_add.device_sub_bu_list[index].key;
				  $scope.at_loc_add.device_sub_bu_value = $scope.at_loc_add.device_sub_bu_list[index].value;
				  $scope.at_loc_add.device_sub_bu_index = index;
          }
        }
      });
	}

    $scope.addAtLocInfo = function(){
      atZkLocAddSev.addAtLocInfo();
    }
    $scope.addAtZkNewDev = function(){
      if($scope.new_dev.d_name==''||$scope.new_dev.d_sn==''){
        $ionicPopup.alert({
          title: '运行结果',
          template: '<div style="text-align: center;">设备信息不能为空</div>',
          okText: '确定'
        });
        return;
      }
      var _str = '';
      if(angular.isDefined(window.localStorage['_is_login'])&&window.localStorage['_is_login']==true){
        _str = '_user_name='+window.localStorage['_user_name']+'&_pass_word='+window.localStorage['_pass_word']+'&_is_login='+window.localStorage['_is_login']+'&_notification_token='+window.localStorage['_notification_token']+'&_device_type='+window.localStorage['_device_type'];
      }
      var date = new Date();
      var month = (date.getMonth() + 1) <= 9 ? '0' + (date.getMonth() + 1) : (date.getMonth() + 1);
      var day = (date.getDate()) <= 9 ? '0' + (date.getDate()) : (date.getDate());
      var inputdate = date.getFullYear() + "-" + month + "-" + day;
      $rootScope.showLoading();
      $.ajax({
        type: "POST",
        url: window.localStorage['_remote_server_addr']+"?event=zkat.general.addsn&data=" + encodeURIComponent('sn:' + $scope.new_dev.d_sn + '\n' + 'id:' + $scope.at_loc_add._b + '\n' + 'status:1' + '\n' + 'input_date:' + inputdate),
        timeout:_var_timeout,
        data: {
          update_data:encodeURIComponent('sn:' + $scope.new_dev.d_sn + '\n' + 'id:' + $scope.at_loc_add._b + '\n' + 'status:0' + '\n' + 'input_date:'),
          device_sn:$scope.new_dev.d_sn,
          device_name:$scope.new_dev.d_name,
		  sub_bu: $scope.at_loc_add.device_sub_bu_key
        },
        success: function (json) {
          $rootScope.hideLoading();
          var data = $.parseJSON(json);
          $ionicPopup.alert({
            title: '运行结果',
            template: '<div style="text-align: center;">'+data.message+'</div>',
            okText: '确定'
          })
            .then(function(res) {
              if(angular.isDefined(data.flag)&&data.flag=='0'){
				  fufuMobclickAgent('click_location_add_device');
                $scope.at_loc_add.dev_list.push({
                  d_name:$scope.new_dev.d_name,
                  d_sn:$scope.new_dev.d_sn
                });
                $scope.new_dev.d_name='';
                $scope.new_dev.d_sn='';
              }
            });
        },
        error:function(){
          $rootScope.hideLoading();
          $ionicPopup.alert({
            title : '提醒',
            template : '<div style="text-align: center;">'+fufu_network_error_msg+'</div>',
            okText : '确定'
          })
        }
      })
    }
  })

  .controller('aboutFuCtrl',function($scope){

	  $scope.img_fufu_logo = local_resource + 'img/register/img_fufu_logo@2x.png';
	$scope.current_app_version = angular.isDefined(localStorage._resource_version)?localStorage._resource_version:'1.0';
	if ($scope.current_app_version < '3.2.001') {
		$scope.current_app_version = '3.2.001';
	}
    /*
    $scope.getPic = function(){
      navigator.camera.getPicture(function(uri) {
        alert(uri);
      }, function(message) {
      }, {
        targetWidth : 100,
        targetHeight : 100,
        mediaType : Camera.MediaType.ALLMEDIA,
        popoverOptions : {
          width : 100,
          height : 200,
          arrowDir : Camera.PopoverArrowDirection.ARROW_DOWN
        },
        destinationType : navigator.camera.DestinationType.FILE_URI,
        sourceType : navigator.camera.PictureSourceType.PHOTOLIBRARY
      });
    }
    $scope.takePic = function(){
      try {
        navigator.camera.getPicture(function(imageData){
          var image = $('#img_src_p');
          image.src = "data:image/jpeg;base64," + imageData;
        }, function(){
          alert('failure');
        }, { quality: 50,
          destinationType: Camera.DestinationType.DATA_URL
        });
      } catch (e) {
        alert(e.message);
      }
    }
    */

$scope.web_path=function(){
  if (ionic.Platform.isIOS()) {
    window.open('http://zkcserv.com/index.html', '_system', 'enableViewportScale=yes');
  } else {
    window.open('http://zkcserv.com/index.html', '_system');
  }
}

    $scope.about_us=function(){
      if (ionic.Platform.isIOS()) {
        window.open('http://weixin.qq.com/r/ADuEnIjEgtX9rcz-924S', '_system', 'enableViewportScale=yes');
      } else {
        window.open('http://weixin.qq.com/r/ADuEnIjEgtX9rcz-924S', '_system');
      }
    }
  })




  .controller('sysUserCtrl',function($scope,sysUserSev,$location,$ionicPopup,$ionicHistory,$rootScope,homemessageSev){

	  if(!$(document.body).hasClass('hide-arrow-left')){
      $(document.body).addClass('hide-arrow-left');
    }

    $scope.$on('$ionicView.afterEnter', function(){
        //进入之后
        if($(document.body).hasClass('hide-arrow-left')){
          $(document.body).removeClass('hide-arrow-left');
        }
    });
    $scope.message_setting=function(){
      $location.path("home_page/message_setting");
    }
    $scope.about_app=function(){
      $location.path("home_page/about_app");
    }
	  $scope.icon_my_message = local_resource + 'img/icon/icon_my_message@2x.png';
	  $scope.icon_modify_password = local_resource + 'img/icon/icon_modify_password@2x.png';
	  $scope.icon_about_us = local_resource + 'img/icon/about_clothes.png';
	  $scope.change_user = local_resource + 'img/icon/change_user.png';
	  $scope.logoff = local_resource + 'img/icon/logoff.png';
    $scope.arrow_right = local_resource + 'img/icon/arrow_right.png';
    $scope.setting_icon = local_resource + 'img/icon/setting_icon.png';
    $scope.cancellation = local_resource + 'img/icon/cancellation.png';
    $scope.my_business_new_icon = local_resource + 'img/icon/my_business_new_icon.png';
	$scope.accounts_security_icon = local_resource + 'img/icon/accounts_security_icon.png';
	$scope.notify_icon = local_resource + 'img/icon/notify_icon.png';
	$scope.about_icon = local_resource + 'img/icon/about_icon.png';


    $scope.edit_data_icon = local_resource + 'img/icon/edit_data_icon.png';
    $scope.change_user_icon = local_resource + 'img/icon/change_user_icon.png';
    $scope.img_exit_trial_login = local_resource + 'img/icon/exit_trial_login.png';
    if (window.localStorage["is_free_trial_login"] != null && typeof(window.localStorage["is_free_trial_login"]) != 'undefined' && window.localStorage["is_free_trial_login"] != '') {
      document.getElementById("home_person_is_trial_login").style.display='block';
    }
    else {
      document.getElementById("home_person_is_trial_login").style.display='none';
    }


    $scope.free_trial_log_out = function () {
      $ionicPopup.confirm({
        title: '退出登录',
        template: '<div style="text-align: center;">是否退出系统?</div>',
        cancelType:'button-dark',
        cancelText: '取消',
        okText: '确定'
      }).then(function (res) {
        if (res) {
          //$rootScope.showLoading();
          $.ajax({
            type: "GET",
            url: window.localStorage['_remote_server_addr']+'?event=ionicAction.ionicAction.doLogout',
            timeout: _var_timeout,
            success: function (data) {
              $rootScope.hideLoading();
            },
            error:function(data){
              $rootScope.hideLoading();
              /*
               $ionicPopup.alert({
               title : '提醒',
               template : '<div style="text-align: center;">'+fufu_network_error_msg+'</div>',
               okText : '确定'
               });
               */
            }
          });
          $ionicHistory.clearCache();
          $ionicHistory.clearHistory();
          window.localStorage['_pass_word']='';
          window.localStorage['_is_login']=0;
          if (window.localStorage["menu_list"] != null && typeof(window.localStorage["menu_list"]) != 'undefined' && window.localStorage["menu_list"] != ''){
            var model_list = window.localStorage["menu_list"].split(',');
            for (var i=0;i<model_list.length;i++){
              if (model_list[i] != ''){
                window.localStorage[model_list[i]] = '';
              }
            }
          }
          window.localStorage["menu_list"] = '';
          window.localStorage["menu_home"] = '';
          window.localStorage["menu_message"] = '';
          window.localStorage["menu_organization_management"] = '';
          window.localStorage["menu_time"] = '';
          window.localStorage["menu_payroll"] = '';
          window.localStorage["menu_ess"] = '';
          window.localStorage["menu_My_Team"] = '';
          window.localStorage["menu_setting"] = '';
          window.localStorage["personnal_data"] = '';
          window.localStorage['is_free_trial_login'] = '';
          login_init_flag = 0;
          $location.path('/');

        }
      });
    }

	fufuMobclickAgent('click_home_person');


    $scope.userLogout = function(){
      $ionicPopup.confirm({
        title: '退出登录',
        template: '<div style="text-align: center;">是否退出系统?</div>',
        cancelType:'button-dark',
        cancelText: '取消',
        okText: '确定'
      }).then(function (res) {
        if (res) {
          //$rootScope.showLoading();
          $.ajax({
            type: "GET",
            url: window.localStorage['_remote_server_addr']+'?event=ionicAction.ionicAction.doLogout',
            timeout: _var_timeout,
            success: function (data) {
              $rootScope.hideLoading();
            },
            error:function(data){
              $rootScope.hideLoading();
              /*
               $ionicPopup.alert({
               title : '提醒',
               template : '<div style="text-align: center;">'+fufu_network_error_msg+'</div>',
               okText : '确定'
               });
               */
            }
          });
          $ionicHistory.clearCache();
          $ionicHistory.clearHistory();
          window.localStorage['_pass_word']='';
          window.localStorage['_is_login']=0;
          if (window.localStorage["menu_list"] != null && typeof(window.localStorage["menu_list"]) != 'undefined' && window.localStorage["menu_list"] != ''){
            var model_list = window.localStorage["menu_list"].split(',');
            for (var i=0;i<model_list.length;i++){
              if (model_list[i] != ''){
                window.localStorage[model_list[i]] = '';
              }
            }
          }
          window.localStorage["menu_list"] = '';
          window.localStorage["menu_home"] = '';
          window.localStorage["menu_message"] = '';
          window.localStorage["menu_organization_management"] = '';
          window.localStorage["menu_time"] = '';
          window.localStorage["menu_payroll"] = '';
          window.localStorage["menu_ess"] = '';
          window.localStorage["menu_My_Team"] = '';
          window.localStorage["menu_setting"] = '';
          window.localStorage["personnal_data"] = '';
          window.localStorage['is_free_trial_login'] = '';
          login_init_flag = 0;
          $location.path('/');

        }
      });
    }

	$scope.refreshData=function(){
	  sysUserSev.refreshData($scope);
	}

	if (window.localStorage["personnal_data"] != null && angular.isDefined(window.localStorage["personnal_data"]) && window.localStorage["personnal_data"] != ''){

		sysUserSev.clearData();
		$scope.personnal_data = sysUserSev.getData();
		sysUserSev.setData($.parseJSON(window.localStorage["personnal_data"]));
		$rootScope.hideLoading();
	}
	else {
		sysUserSev.clearData();

		sysUserSev.loadData();
		$scope.personnal_data = sysUserSev.getData();
	}



    $scope.edit_data_path=function(){
      $location.path("home_page/personnal_details");
    }
    $scope.personnal_data_path=function(){
      $location.path("home_page/personnal_data_details");
    }

    $scope.my_business=function(){
      $location.path("home_page/my_business");
    }
    $scope.personnal_setting=function(){
      $location.path("home_page/personnal_setting");
    }
  })







  .controller('shiftPolicyCtrl',function($scope,shiftPolicySev,$location,$stateParams,$ionicPopup,$ionicHistory){
	$scope.fufu_delete = local_resource + 'img/icon/fufu_delete.png';
	$scope.img_arrow_down = local_resource+'img/icon/icon_arrow_down02.png';
	shiftPolicySev.clearData();
    shiftPolicySev.loadData();
    $scope.shiftPolicyData = shiftPolicySev.getData();
	$scope.shift_policy_edit = function(policy_id){
	$location.path('home_page/home_menulist/shift_policy_edit/' + policy_id);
	}
	$scope.shift_policy_delete = function(policy_id){
    $ionicPopup.confirm({
      title: '提示',
      template: '<div style="text-align: center;">' + '确认删除?' + '</div>',
      cancelText: '取消',
      cancelType: 'button-dark',
      okText: '确认'
    }).then(function(res){
      if(res){
        shiftPolicySev.shiftPolicyDelete(policy_id);
      }
    })
	}

  })

  .controller('shiftPolicyAddCtrl',function($scope,shiftPolicyAddSev,$stateParams,$location,$ionicPopup,$ionicHistory,timeSelect,sideSelect){
	shiftPolicyAddSev.clearData();
    shiftPolicyAddSev.loadData();
    $scope.shiftPolicyAddData = shiftPolicyAddSev.getData();
    $scope.first_in = function(){
      var current_date = new Date();
      current_date.setMinutes(current_date.getMinutes() - current_date.getTimezoneOffset());
      current_date = current_date.toJSON().slice(0,4);
      var startDate = parseInt(current_date, 10) - 10;
      startDate = startDate + '-01-01';
      var endDate = parseInt(current_date, 10) + 10;
      endDate = endDate + '-12-31';
      timeSelect.show({
        type :  'time' ,
        startDate :  '1900-01-01',
        endDate : '2099-12-31',
        defaultDate: $scope.shiftPolicyAddData.first_in,
        returnDateType : 'y-m-d',
        returnTimeType :  '24h'||'AMPM',
        //stepping :10,
        selectedFunc : function (date) {
          if (typeof(date) != 'undefined'){
            $scope.shiftPolicyAddData.first_in = date;
          }
        }
      })
    }

    $scope.first_out = function(){
      var current_date = new Date();
      current_date.setMinutes(current_date.getMinutes() - current_date.getTimezoneOffset());
      current_date = current_date.toJSON().slice(0,4);
      var startDate = parseInt(current_date, 10) - 10;
      startDate = startDate + '-01-01';
      var endDate = parseInt(current_date, 10) + 10;
      endDate = endDate + '-12-31';
      timeSelect.show({
        type :  'time' ,
        startDate :  '1900-01-01',
        endDate : '2099-12-31',
        defaultDate: $scope.shiftPolicyAddData.first_out,
        returnDateType : 'y-m-d',
        returnTimeType :  '24h'||'AMPM',
        //stepping :10,
        selectedFunc : function (date) {
          if (typeof(date) != 'undefined'){
            $scope.shiftPolicyAddData.first_out = date;
          }
        }
      })
    }
    $scope.second_in = function(){
      var current_date = new Date();
      current_date.setMinutes(current_date.getMinutes() - current_date.getTimezoneOffset());
      current_date = current_date.toJSON().slice(0,4);
      var startDate = parseInt(current_date, 10) - 10;
      startDate = startDate + '-01-01';
      var endDate = parseInt(current_date, 10) + 10;
      endDate = endDate + '-12-31';
      timeSelect.show({
        type :  'time' ,
        startDate :  startDate,
        endDate : '2099-12-31',
        defaultDate: $scope.shiftPolicyAddData.second_in,
        returnDateType : 'y-m-d',
        returnTimeType :  '24h'||'AMPM',
        //stepping :10,
        selectedFunc : function (date) {
          if (typeof(date) != 'undefined'){
            $scope.shiftPolicyAddData.second_in = date;
          }
        }
      })
    }
    $scope.second_out = function(){
      var current_date = new Date();
      current_date.setMinutes(current_date.getMinutes() - current_date.getTimezoneOffset());
      current_date = current_date.toJSON().slice(0,4);
      var startDate = parseInt(current_date, 10) - 10;
      startDate = startDate + '-01-01';
      var endDate = parseInt(current_date, 10) + 10;
      endDate = endDate + '-12-31';
      timeSelect.show({
        type :  'time' ,
        startDate :  '1900-01-01',
        endDate : '2099-12-31',
        defaultDate: $scope.shiftPolicyAddData.second_out,
        returnDateType : 'y-m-d',
        returnTimeType :  '24h'||'AMPM',
        //stepping :10,
        selectedFunc : function (date) {
          if (typeof(date) != 'undefined'){
            $scope.shiftPolicyAddData.second_out = date;
          }
        }
      })
    }
    $scope.first_in_need_data=[{
      key:'0',
      value:'需打卡'
    },{
      key:'1',
      value:'已关闭'
    }]
    $scope.first_in_need_index=0;
    $scope.first_in_need_clock=function(){
      $scope.shiftPolicyAddData.first_in_need_clock=='1'? $scope.first_in_need_index=0 : $scope.first_in_need_index=1;
      sideSelect.show({
        type : 'ios',
        data :$scope.first_in_need_data,
        selectIndex :   $scope.first_in_need_index,
        selectedFunc : function (index) {
          if(typeof(index)!='undefined'){
            document.getElementById("first_in_need_clock").innerHTML= $scope.first_in_need_data[index].value;
            index== '0' ? $scope.shiftPolicyAddData.first_in_need_clock=1 : $scope.shiftPolicyAddData.first_in_need_clock=0;
            $scope.first_in_need_index=index;
          }

        }
      });
    }


    $scope.first_out_need_data=[{
      key:'0',
      value:'需打卡'
    },{
      key:'1',
      value:'已关闭'
    }]
    $scope.first_out_need_index=0;
    $scope.first_out_need_clock=function(){
      $scope.shiftPolicyAddData.first_out_need_clock=='1'? $scope.first_out_need_index=0 : $scope.first_out_need_index=1;
      sideSelect.show({
        type : 'ios',
        data :$scope.first_out_need_data,
        selectIndex :   $scope.first_out_need_index,
        selectedFunc : function (index) {
          if(typeof(index)!='undefined'){
            document.getElementById("first_out_need_clock").innerHTML= $scope.first_out_need_data[index].value;
            index== '0' ? $scope.shiftPolicyAddData.first_out_need_clock='1' : $scope.shiftPolicyAddData.first_out_need_clock='0';
            $scope.first_out_need_index=index;
          }

        }
      });
    }

    $scope.second_in_need_data=[{
      key:'0',
      value:'需打卡'
    },{
      key:'1',
      value:'已关闭'
    }]
    $scope.second_in_need_index=0;
    $scope.second_in_need_clock=function(){
      $scope.shiftPolicyAddData.second_in_need_clock=='1'? $scope.second_in_need_index=0 : $scope.second_in_need_index=1;
      sideSelect.show({
        type : 'ios',
        data :$scope.second_in_need_data,
        selectIndex :   $scope.second_in_need_index,
        selectedFunc : function (index) {
          if(typeof(index)!='undefined'){
            document.getElementById("second_in_need_clock").innerHTML= $scope.second_in_need_data[index].value;
            index== '0' ? $scope.shiftPolicyAddData.second_in_need_clock='1' : $scope.shiftPolicyAddData.second_in_need_clock='0';
            $scope.second_in_need_index=index;
          }

        }
      });
    }

    $scope.second_out_need_data=[{
      key:'0',
      value:'需打卡'
    },{
      key:'1',
      value:'已关闭'
    }]
    $scope.second_out_need_index=0;
    $scope.second_out_need_clock=function(){
      $scope.shiftPolicyAddData.second_out_need_clock=='1'? $scope.second_out_need_index=0 : $scope.second_out_need_index=1;
      sideSelect.show({
        type : 'ios',
        data :$scope.second_out_need_data,
        selectIndex :   $scope.second_out_need_index,
        selectedFunc : function (index) {
          if(typeof(index)!='undefined'){
            document.getElementById("second_out_need_clock").innerHTML= $scope.second_out_need_data[index].value;
            index== '0' ? $scope.shiftPolicyAddData.second_out_need_clock='1' : $scope.shiftPolicyAddData.second_out_need_clock='0';
            $scope.second_out_need_index=index;
          }

        }
      });
    }
	$scope.shift_policy_add_save = function(){
		shiftPolicyAddSev.shift_policy_add_save();
	}
  })

  .controller('shiftPolicyEditCtrl',function($scope,shiftPolicyEditSev,$stateParams,$location,$ionicPopup,$ionicHistory,timeSelect,sideSelect){
	shiftPolicyEditSev.clearData();
    shiftPolicyEditSev.loadData($stateParams.shift_policy_id);
    $scope.shiftPolicyEditData = shiftPolicyEditSev.getData();
    $scope.first_in = function(){
      var current_date = new Date();
      current_date.setMinutes(current_date.getMinutes() - current_date.getTimezoneOffset());
      current_date = current_date.toJSON().slice(0,4);
      var startDate = parseInt(current_date, 10) - 10;
      startDate = startDate + '-01-01';
      var endDate = parseInt(current_date, 10) + 10;
      endDate = endDate + '-12-31';
      timeSelect.show({
        type :  'time' ,
        startDate :  '1900-01-01',
        endDate : '2099-12-31',
        defaultDate: $scope.shiftPolicyEditData.first_in,
        returnDateType : 'y-m-d',
        returnTimeType :  '24h'||'AMPM',
        //stepping :10,
        selectedFunc : function (date) {
          if (typeof(date) != 'undefined'){
            $scope.shiftPolicyEditData.first_in = date;
          }
        }
      })
    }

    $scope.first_out = function(){
      var current_date = new Date();
      current_date.setMinutes(current_date.getMinutes() - current_date.getTimezoneOffset());
      current_date = current_date.toJSON().slice(0,4);
      var startDate = parseInt(current_date, 10) - 10;
      startDate = startDate + '-01-01';
      var endDate = parseInt(current_date, 10) + 10;
      endDate = endDate + '-12-31';
      timeSelect.show({
        type :  'time' ,
        startDate :  '1900-01-01',
        endDate : '2099-12-31',
        defaultDate: $scope.shiftPolicyEditData.first_out,
        returnDateType : 'y-m-d',
        returnTimeType :  '24h'||'AMPM',
        //stepping :10,
        selectedFunc : function (date) {
          if (typeof(date) != 'undefined'){
            $scope.shiftPolicyEditData.first_out = date;
          }
        }
      })
    }
    $scope.second_in = function(){
      var current_date = new Date();
      current_date.setMinutes(current_date.getMinutes() - current_date.getTimezoneOffset());
      current_date = current_date.toJSON().slice(0,4);
      var startDate = parseInt(current_date, 10) - 10;
      startDate = startDate + '-01-01';
      var endDate = parseInt(current_date, 10) + 10;
      endDate = endDate + '-12-31';
      timeSelect.show({
        type :  'time' ,
        startDate :  startDate,
        endDate : '2099-12-31',
        defaultDate: $scope.shiftPolicyEditData.second_in,
        returnDateType : 'y-m-d',
        returnTimeType :  '24h'||'AMPM',
        //stepping :10,
        selectedFunc : function (date) {
          if (typeof(date) != 'undefined'){
            $scope.shiftPolicyEditData.second_in = date;
          }
        }
      })
    }
    $scope.second_out = function(){
      var current_date = new Date();
      current_date.setMinutes(current_date.getMinutes() - current_date.getTimezoneOffset());
      current_date = current_date.toJSON().slice(0,4);
      var startDate = parseInt(current_date, 10) - 10;
      startDate = startDate + '-01-01';
      var endDate = parseInt(current_date, 10) + 10;
      endDate = endDate + '-12-31';
      timeSelect.show({
        type :  'time' ,
        startDate :  '1900-01-01',
        endDate : '2099-12-31',
        defaultDate: $scope.shiftPolicyEditData.second_out,
        returnDateType : 'y-m-d',
        returnTimeType :  '24h'||'AMPM',
        //stepping :10,
        selectedFunc : function (date) {
          if (typeof(date) != 'undefined'){
            $scope.shiftPolicyEditData.second_out = date;
          }
        }
      })
    }
    $scope.first_in_need_data=[{
      key:'0',
      value:'需打卡'
    },{
      key:'1',
      value:'已关闭'
    }]
    $scope.first_in_need_index=0;
    $scope.first_in_need_clock=function(){
      $scope.shiftPolicyEditData.first_in_need_clock=='1'? $scope.first_in_need_index=0 : $scope.first_in_need_index=1;
      sideSelect.show({
        type : 'ios',
        data :$scope.first_in_need_data,
        selectIndex :   $scope.first_in_need_index,
        selectedFunc : function (index) {
          if(typeof(index)!='undefined'){
            document.getElementById("first_in_need_clock").innerHTML= $scope.first_in_need_data[index].value;
            index== '0' ? $scope.shiftPolicyEditData.first_in_need_clock=1 : $scope.shiftPolicyEditData.first_in_need_clock=0;
            $scope.first_in_need_index=index;
          }

        }
      });
    }


    $scope.first_out_need_data=[{
      key:'0',
      value:'需打卡'
    },{
      key:'1',
      value:'已关闭'
    }]
    $scope.first_out_need_index=0;
    $scope.first_out_need_clock=function(){
      $scope.shiftPolicyEditData.first_out_need_clock=='1'? $scope.first_out_need_index=0 : $scope.first_out_need_index=1;
      sideSelect.show({
        type : 'ios',
        data :$scope.first_out_need_data,
        selectIndex :   $scope.first_out_need_index,
        selectedFunc : function (index) {
          if(typeof(index)!='undefined'){
            document.getElementById("first_out_need_clock").innerHTML= $scope.first_out_need_data[index].value;
            index== '0' ? $scope.shiftPolicyEditData.first_out_need_clock='1' : $scope.shiftPolicyEditData.first_out_need_clock='0';
            $scope.first_out_need_index=index;
          }

        }
      });
    }

    $scope.second_in_need_data=[{
      key:'0',
      value:'需打卡'
    },{
      key:'1',
      value:'已关闭'
    }]
    $scope.second_in_need_index=0;
    $scope.second_in_need_clock=function(){
      $scope.shiftPolicyEditData.second_in_need_clock=='1'? $scope.second_in_need_index=0 : $scope.second_in_need_index=1;
      sideSelect.show({
        type : 'ios',
        data :$scope.second_in_need_data,
        selectIndex :   $scope.second_in_need_index,
        selectedFunc : function (index) {
          if(typeof(index)!='undefined'){
            document.getElementById("second_in_need_clock").innerHTML= $scope.second_in_need_data[index].value;
            index== '0' ? $scope.shiftPolicyEditData.second_in_need_clock='1' : $scope.shiftPolicyEditData.second_in_need_clock='0';
            $scope.second_in_need_index=index;
          }

        }
      });
    }

    $scope.second_out_need_data=[{
      key:'0',
      value:'需打卡'
    },{
      key:'1',
      value:'已关闭'
    }]
    $scope.second_out_need_index=0;
    $scope.second_out_need_clock=function(){
      $scope.shiftPolicyEditData.second_out_need_clock=='1'? $scope.second_out_need_index=0 : $scope.second_out_need_index=1;
      sideSelect.show({
        type : 'ios',
        data :$scope.second_out_need_data,
        selectIndex :   $scope.second_out_need_index,
        selectedFunc : function (index) {
          if(typeof(index)!='undefined'){
            document.getElementById("second_out_need_clock").innerHTML= $scope.second_out_need_data[index].value;
            index== '0' ? $scope.shiftPolicyEditData.second_out_need_clock='1' : $scope.shiftPolicyEditData.second_out_need_clock='0';
            $scope.second_out_need_index=index;
          }

        }
      });
    }

	$scope.shift_policy_edit_save = function(policy_id){
		shiftPolicyEditSev.shift_policy_edit_save(policy_id);
	}
  })

  .controller('shiftGroupCtrl',function($scope,shiftGroupSev,$location,$stateParams,$ionicPopup,$ionicHistory){
	shiftGroupSev.clearData();
    shiftGroupSev.loadData();
    $scope.shiftGroupData = shiftGroupSev.getData();
	$scope.img_delete = local_resource+'img/icon/fufu_delete.png';
	$scope.shift_group_edit = function(shift_group_id){
		$location.path('home_page/home_menulist/shift_group_edit/' + shift_group_id);
	}
	$scope.shift_group_delete = function(shift_group_id,shift_group_name){
    $ionicPopup.confirm({
      title: '提示',
      template: '<div style="text-align: center;">' + '确认删除吗?' + '</div>',
      cancelText: '取消',
      cancelType: 'button-dark',
      okText: '确认'
    }).then(function (res) {
      if(res){
        shiftGroupSev.shiftGroupDelete(shift_group_id,shift_group_name);
      }
    })

	}
  })

  .controller('shiftGroupAddCtrl',function($scope,shiftGroupAddSev,$stateParams,$location,$ionicPopup,$ionicHistory,sideSelect){
    shiftGroupAddSev.clearData();
    shiftGroupAddSev.loadData();
    $scope.shiftGroupAddData = shiftGroupAddSev.getData();

    $scope.colorStyle = {
      cccc : {
        "color":"#ccc"
      },
      c333 : {
        "color":"#333"
      }
    }

    $scope.shift_group_add_save = function(){
      shiftGroupAddSev.shift_group_add_save();
    }

    $scope.set_default_shift = function(){
      sideSelect.show({
        type : 'ios',
        data :$scope.shiftGroupAddData.shift_policy,
        selectIndex :  $scope.shiftGroupAddData.shift_policy_index,
        selectedFunc : function (index) {
          if(index == undefined){
            $scope.shiftGroupAddData.shift_policy_index = undefined;
            $scope.shiftGroupAddData.shift_policy_key = "";
            $scope.shiftGroupAddData.shift_policy_value = "";
          }else{
            $scope.shiftGroupAddData.shift_policy_index = index;
            $scope.shiftGroupAddData.shift_policy_key = $scope.shiftGroupAddData.shift_policy[index].key;
            $scope.shiftGroupAddData.shift_policy_value = $scope.shiftGroupAddData.shift_policy[index].value;
          }

        }
      });
    }

    $scope.sub_bu_select = function(){
      sideSelect.show({
        type : 'ios',
        data :$scope.shiftGroupAddData.sub_bu_list,
        selectIndex :  $scope.shiftGroupAddData.sub_bu_index,
        selectedFunc : function (index) {


          if(index == undefined){
            $scope.shiftGroupAddData.sub_bu_index = undefined;
            $scope.shiftGroupAddData.sub_bu_key = "";
            $scope.shiftGroupAddData.sub_bu_value = "";
          }else{
            $scope.shiftGroupAddData.sub_bu_key = $scope.shiftGroupAddData.sub_bu_list[index].key;
            $scope.shiftGroupAddData.sub_bu_value = $scope.shiftGroupAddData.sub_bu_list[index].value;
            $scope.shiftGroupAddData.sub_bu_index = index;
          }
        }
      });
	}
  })

  .controller('shiftGroupAddPolicyPickerCtrl',function($scope,shiftGroupAddPolicyPickerSev,$stateParams,$location,$ionicPopup,$ionicHistory){
	shiftGroupAddPolicyPickerSev.clearData();
    shiftGroupAddPolicyPickerSev.loadData();
    $scope.shiftGroupAddPolicyPickerData = shiftGroupAddPolicyPickerSev.getData();


    $scope.search_val = "";
    var str = $("#policy_id_list").html();

    $scope.selCt=0;
    if(str != '' && str.length != 0){
      $scope.selCt=(str.split(',')).length;
    }

    $scope.ckItem = function(_flag){
      if(_flag == true){
        $scope.selCt =  $scope.selCt + 1;
      }else{
        $scope.selCt =  $scope.selCt - 1;
      }
    }
    $scope.rtAction = function(){
      var data = $scope.shiftGroupAddPolicyPickerData;
      var policy_name_list='';
      var policy_id_list='';
      for(var i=0;i<data.length;i++){
        if(data[i].checked==true){
          policy_name_list = policy_name_list + data[i].policy_name+',';
          policy_id_list = policy_id_list + data[i].policy_id+',';
        }
      }


      var set_html = policy_name_list.substring(0,policy_name_list.length-1);
      $("#policy_name_list").css({"color":set_html.length?"#333":"#CCC"});
      $("#policy_name_list").html(set_html.length?set_html:"未添加班次");


      $("#policy_id_list").html(policy_id_list.substring(0,policy_id_list.length-1));


      $ionicHistory.goBack();
    }
  })

  .controller('shiftGroupAddEmployeeSelectCtrl',function($scope,shiftGroupAddEmployeeSelectSev,$stateParams,$location,$ionicPopup,$ionicHistory,$ionicScrollDelegate){
    $scope.search_control={};
    $scope.search_control.search_val='';
	shiftGroupAddEmployeeSelectSev.clearData();
    shiftGroupAddEmployeeSelectSev.loadData();
    $scope.shiftGroupAddEmployeeSelectData = shiftGroupAddEmployeeSelectSev.getData();
	$scope.img_no_notice = local_resource+'img/icon/no_notice01.png';
	$scope.img_notice = local_resource+'img/icon/notice01.png';
    $scope.ckItem = function(_flag){
      if(_flag == true){
        $scope.shiftGroupAddEmployeeSelectData.total_checked++;
      }else{
        $scope.shiftGroupAddEmployeeSelectData.total_checked--;
      }
      $scope.shiftGroupAddEmployeeSelectData.show_footer_bar=true;

      if ($scope.shiftGroupAddEmployeeSelectData.total_checked == $scope.shiftGroupAddEmployeeSelectData.length){
        //$scope.all_selected = true;
        document.getElementById('select_all_employee').style.display = "none";
        document.getElementById('deselect_all_employee').style.display = "block";

      }
      else {
        //$scope.all_selected = false;
        document.getElementById('select_all_employee').style.display = "block";
        document.getElementById('deselect_all_employee').style.display = "none";
      }
      setTimeout(function(){ $ionicScrollDelegate.resize();}, 200);
    }




    $scope.select_all_employee = function(){
      //$scope.all_selected = true;
      $scope.shiftGroupAddEmployeeSelectData.show_footer_bar=true;
      document.getElementById('select_all_employee').style.display = "none";
      document.getElementById('deselect_all_employee').style.display = "block";
      $scope.shiftGroupAddEmployeeSelectData.total_checked = $scope.shiftGroupAddEmployeeSelectData.data.length;
      $scope.shiftGroupAddEmployeeSelectData.show_footer_bar = true;
      for (var i=0;i<$scope.shiftGroupAddEmployeeSelectData.data.length;i++){
        $scope.shiftGroupAddEmployeeSelectData.data[i].ck = true;
      }
    }
    $scope.select_all_employee_cancel = function(){
      //$scope.all_selected = false;
      $scope.shiftGroupAddEmployeeSelectData.show_footer_bar=true;
      document.getElementById('select_all_employee').style.display = "block";
      document.getElementById('deselect_all_employee').style.display = "none";
      $scope.shiftGroupAddEmployeeSelectData.total_checked = 0;

      for (var i=0;i<$scope.shiftGroupAddEmployeeSelectData.data.length;i++){
        $scope.shiftGroupAddEmployeeSelectData.data[i].ck = false;
      }
      setTimeout(function(){ $ionicScrollDelegate.resize();}, 200);
    }
    $scope.cancel=function(){
		var temp_total_checked = 0;
      var employee_list = $('#shift_group_add_empl_list_hidden').val();
      var SelectData_data=$scope.shiftGroupAddEmployeeSelectData.data;
      employee_list=employee_list+",";
      for(var i=0;i<SelectData_data.length;i++){
        if(employee_list.indexOf(SelectData_data[i].emp+",")==-1){
          SelectData_data[i].ck=false;
        }
        else{
          SelectData_data[i].ck=true;
		  temp_total_checked ++;
        }
      }
      $scope.shiftGroupAddEmployeeSelectData.data=SelectData_data;
      $scope.shiftGroupAddEmployeeSelectData.show_footer_bar=false;
	  $scope.shiftGroupAddEmployeeSelectData.total_checked = temp_total_checked;
      setTimeout(function(){ $ionicScrollDelegate.resize();}, 200);
    }


	$scope.shift_group_add_employee_select_save = function(){
      var _empl_list='';
      var _staff_no_list='';
      for(var i=0;i<$scope.shiftGroupAddEmployeeSelectData.data.length;i++){
        if($scope.shiftGroupAddEmployeeSelectData.data[i].ck==true){
          _empl_list = _empl_list + $scope.shiftGroupAddEmployeeSelectData.data[i].en+',';
          _staff_no_list = _staff_no_list + $scope.shiftGroupAddEmployeeSelectData.data[i].emp+',';
        }
      }
      $("#shift_group_add_empl_list").val(_empl_list.substring(0,_empl_list.length-1));
      $("#shift_group_add_empl_list_hidden").val(_staff_no_list.substring(0,_staff_no_list.length-1));
      $ionicHistory.goBack();
	}

  })

  .controller('shiftGroupEditCtrl',function($scope,shiftGroupEditSev,$stateParams,$location,$ionicPopup,$ionicHistory,sideSelect){
	shiftGroupEditSev.clearData();
    shiftGroupEditSev.loadData($stateParams.shift_group_id);
    $scope.shiftGroupEditData = shiftGroupEditSev.getData();

    $scope.colorStyle = {
      cccc : {
        "color":"#ccc"
      },
      c333 : {
        "color":"#333"
      }
    }



    $scope.shift_group_edit_save = function(){
      shiftGroupEditSev.shift_group_edit_save();
    }

    $scope.sub_bu_select = function(){
      sideSelect.show({
        type : 'ios',
        data :$scope.shiftGroupEditData.sub_bu_list,
        selectIndex :  $scope.shiftGroupEditData.sub_bu_index,
        selectedFunc : function (index) {
          // debugger;


          if(index == undefined){
            $scope.shiftGroupEditData.sub_bu_index = undefined;
            $scope.shiftGroupEditData.sub_bu_key = "";
            $scope.shiftGroupEditData.sub_bu_value = "";
          }else{
            $scope.shiftGroupEditData.sub_bu_key = $scope.shiftGroupEditData.sub_bu_list[index].key;
            $scope.shiftGroupEditData.sub_bu_value = $scope.shiftGroupEditData.sub_bu_list[index].value;
            $scope.shiftGroupEditData.sub_bu_index = index;
          }
        }
      });
    }

    $scope.set_default_shift = function(){
      sideSelect.show({
        type : 'ios',
        data :$scope.shiftGroupEditData.shift_policy,
        selectIndex :  $scope.shiftGroupEditData.shift_policy_index,
        selectedFunc : function (index) {
          if(index == undefined){
            $scope.shiftGroupEditData.shift_policy_index = undefined;
            $scope.shiftGroupEditData.shift_policy_key = "";
            $scope.shiftGroupEditData.shift_policy_value = "";
          }else{
            $scope.shiftGroupEditData.shift_policy_key = $scope.shiftGroupEditData.shift_policy[index].key;
            $scope.shiftGroupEditData.shift_policy_value = $scope.shiftGroupEditData.shift_policy[index].value;
            $scope.shiftGroupEditData.shift_policy_index = index;

          }

        }
      });
    }

  })

  .controller('shiftGroupEditEmployeeSelectCtrl',function($scope,shiftGroupEditEmployeeSelectSev,$stateParams,$location,$ionicPopup,$ionicHistory,$ionicScrollDelegate){
    $scope.search_control={};
    $scope.search_control.search_val='';
	shiftGroupEditEmployeeSelectSev.clearData();
    shiftGroupEditEmployeeSelectSev.loadData();
    $scope.shiftGroupEditEmployeeSelectData = shiftGroupEditEmployeeSelectSev.getData();
	$scope.img_no_notice = local_resource+'img/icon/no_notice01.png';
	$scope.img_notice = local_resource+'img/icon/notice01.png';
    $scope.ckItem = function(_flag){
      if(_flag == true){
        $scope.shiftGroupEditEmployeeSelectData.total_checked++;
      }else{
        $scope.shiftGroupEditEmployeeSelectData.total_checked--;
      }
        $scope.shiftGroupEditEmployeeSelectData.show_footer_bar=true;

      if ($scope.shiftGroupEditEmployeeSelectData.total_checked == $scope.shiftGroupEditEmployeeSelectData.length){
        //$scope.all_selected = true;
        document.getElementById('select_all_employee').style.display = "none";
        document.getElementById('deselect_all_employee').style.display = "block";

      }
      else {
        //$scope.all_selected = false;
        document.getElementById('select_all_employee').style.display = "block";
        document.getElementById('deselect_all_employee').style.display = "none";
      }
      setTimeout(function(){ $ionicScrollDelegate.resize();}, 200);
    }

    $scope.select_all_employee = function(){
      //$scope.all_selected = true;
      $scope.shiftGroupEditEmployeeSelectData.show_footer_bar=true;
      document.getElementById('select_all_employee').style.display = "none";
      document.getElementById('deselect_all_employee').style.display = "block";
      $scope.shiftGroupEditEmployeeSelectData.total_checked = $scope.shiftGroupEditEmployeeSelectData.data.length;
      $scope.shiftGroupEditEmployeeSelectData.show_footer_bar = true;
      for (var i=0;i<$scope.shiftGroupEditEmployeeSelectData.data.length;i++){
        $scope.shiftGroupEditEmployeeSelectData.data[i].ck = true;
      }
    }
    $scope.select_all_employee_cancel = function(){
      //$scope.all_selected = false;
      $scope.shiftGroupEditEmployeeSelectData.show_footer_bar=true;
      document.getElementById('select_all_employee').style.display = "block";
      document.getElementById('deselect_all_employee').style.display = "none";
      $scope.shiftGroupEditEmployeeSelectData.total_checked = 0;

      for (var i=0;i<$scope.shiftGroupEditEmployeeSelectData.data.length;i++){
        $scope.shiftGroupEditEmployeeSelectData.data[i].ck = false;
      }
      setTimeout(function(){ $ionicScrollDelegate.resize();}, 200);
    }
    $scope.cancel=function(){
      var employee_list = $('#shift_group_edit_empl_list_hidden').val();
	  var temp_total_checked=0;
	  //alert(employee_list);
      var SelectData_data=$scope.shiftGroupEditEmployeeSelectData.data;
      employee_list=employee_list+",";
      for(var i=0;i<SelectData_data.length;i++){
        if(employee_list.indexOf(SelectData_data[i].emp+",")==-1){
          SelectData_data[i].ck=false;
        }
        else{
          SelectData_data[i].ck=true;
		  temp_total_checked++;
        }
      }
      $scope.shiftGroupEditEmployeeSelectData.data=SelectData_data;
      $scope.shiftGroupEditEmployeeSelectData.show_footer_bar=false;
	  $scope.shiftGroupEditEmployeeSelectData.total_checked = temp_total_checked;
      setTimeout(function(){ $ionicScrollDelegate.resize();}, 200);
    }

	$scope.shift_group_edit_employee_select_save = function(){
      var _empl_list='';
      var _staff_no_list='';
      for(var i=0;i<$scope.shiftGroupEditEmployeeSelectData.data.length;i++){
        if($scope.shiftGroupEditEmployeeSelectData.data[i].ck==true){
          _empl_list = _empl_list + $scope.shiftGroupEditEmployeeSelectData.data[i].en+',';
          _staff_no_list = _staff_no_list + $scope.shiftGroupEditEmployeeSelectData.data[i].emp+',';
        }
      }
      $("#shift_group_edit_empl_list").val(_empl_list.substring(0,_empl_list.length-1));
      $("#shift_group_edit_empl_list_hidden").val(_staff_no_list.substring(0,_staff_no_list.length-1));
      $ionicHistory.goBack();
	}

  })

  .controller('holidayPolicyCtrl',function($scope,holidayPolicySev,$stateParams,$location,$ionicPopup,$ionicHistory){
	  /*Sunny改*/
	  $scope.ot_normal = local_resource + 'img/icon/dot_normal.png';
	  $scope.dot_abnormal = local_resource + 'img/icon/dot_abnormal.png';
	  /*Sunny改*/
    if (ionic.Platform.isIOS()) {
      holidayPolicySev.clearData();
      holidayPolicySev.loadData();
      $scope.holidayPolicyData = holidayPolicySev.getData();
    } else {
      $scope.$on("$ionicView.enter", function () {
        //解决 进入明细页面back回来的时候 会再次loaddata
        if (typeof($scope.data_loaded) != 'undefined') {
          return;
        }
        else {
          $scope.data_loaded = true;
        }
        holidayPolicySev.clearData();
        holidayPolicySev.loadData();
        $scope.holidayPolicyData = holidayPolicySev.getData();
      });
    }
    //holidayPolicySev.clearData();
    //holidayPolicySev.loadData();
    //$scope.holidayPolicyData = holidayPolicySev.getData();
	$scope.holiday_policy_delete = function (holiday_policy_id){
		$ionicPopup.confirm({
			title: '提示',
			template: '<div style="text-align: center;">'+'确认删除?'+'</div>',
			cancelText:'取消',
			cancelType:'button-dark',
			okText: '确认'
		}).then(function(res) {
			if (res){
				holidayPolicySev.holiday_policy_delete(holiday_policy_id);
			}
		});

	}
	$scope.holiday_policy_edit = function (holiday_policy_id,holiday_policy_name){
		$location.path('home_page/home_menulist/holiday_policy_edit/' + holiday_policy_id + '/' + holiday_policy_name);
	}


  })

  .controller('holidayPolicyAddCtrl',function($scope,holidayPolicyAddSev,$stateParams,$location,$ionicPopup,$ionicHistory,sideSelect){
	holidayPolicyAddSev.clearData();
    holidayPolicyAddSev.loadData();
    $scope.holidayPolicyAddData = holidayPolicyAddSev.getData();
    $scope.holiday_policy_add_save = function (){
		holidayPolicyAddSev.holiday_policy_add_save();
	}

	$scope.sub_bu_select = function(){
      sideSelect.show({
        type : 'ios',
        data :$scope.holidayPolicyAddData.sub_bu_list,
        selectIndex :  $scope.holidayPolicyAddData.sub_bu_index,
        selectedFunc : function (index) {
          if(typeof(index)!='undefined'){
				  $scope.holidayPolicyAddData.sub_bu_key = $scope.holidayPolicyAddData.sub_bu_list[index].key;
				  $scope.holidayPolicyAddData.sub_bu_value = $scope.holidayPolicyAddData.sub_bu_list[index].value;
				  $scope.holidayPolicyAddData.sub_bu_index = index;
          }
        }
      });
	}

  })

  .controller('holidayPolicyEditCtrl',function($scope,holidayPolicyEditSev,$stateParams,$location,$ionicPopup,$ionicHistory,timeSelect,sideSelect,$ionicScrollDelegate){
	$scope.img_national_holiday = local_resource+'img/icon/dot_national_holiday.png';
	$scope.img_public_holiday = local_resource+'img/icon/dot_public_holiday.png';
	$scope.img_other_holiday = local_resource+'img/icon/dot_other_holiday.png';
	$scope.img_add = local_resource+'img/icon/fufu_add_to.png';
	$scope.img_edit = local_resource+'img/icon/fufu_edit.png';
	$scope.img_delete = local_resource+'img/icon/fufu_delete.png';

	var current_date = new Date();
	var obj = $('#calendar_date_input1');

    current_date = (current_date.getFullYear() + '-' + (current_date.getMonth() + 1 < 10 ? '0' + (current_date.getMonth() + 1): (current_date.getMonth() + 1)) + '-' + (current_date.getDate() < 10 ? '0' + (current_date.getDate()): (current_date.getDate())));
  	obj.val(current_date);
    document.getElementById('calendar_date_input').innerHTML=current_date;
	$scope.toolbar_title = $stateParams.holiday_policy_name;

	$scope.load_data = function(){
		 holidayPolicyEditSev.loadData($stateParams.holiday_policy_id,obj.val());
	}

	$scope.holiday_policy_detail_delete = function() {
		holidayPolicyEditSev.holiday_policy_detail_delete($scope);
	}

	$scope.holiday_policy_detail_edit_mode = function(){
    $scope.holidayPolicyEditData.current_holiday.temp_holiday_name = $scope.holidayPolicyEditData.current_holiday.holiday_name;
    $scope.holidayPolicyEditData.current_holiday.temp_ct_days = $scope.holidayPolicyEditData.current_holiday.ct_days;
    $scope.holidayPolicyEditData.temp_holiday_type_data_key= $scope.holidayPolicyEditData.holiday_type_data_key;
    $scope.holidayPolicyEditData.temp_holiday_type_data_value=$scope.holidayPolicyEditData.holiday_type_data_value;
    holidayPolicyEditSev.setEditMode(true);
    setTimeout(function(){ $ionicScrollDelegate.resize(); }, 200);
	}

	$scope.holiday_policy_detail_cancel_edit_mode = function(){
    $scope.holidayPolicyEditData.current_holiday.holiday_name = $scope.holidayPolicyEditData.current_holiday.temp_holiday_name;
    $scope.holidayPolicyEditData.current_holiday.ct_days = $scope.holidayPolicyEditData.current_holiday.temp_ct_days;
    $scope.holidayPolicyEditData.Holiday_type_key=$scope.holidayPolicyEditData.holiday_type_data_key;
    $scope.holidayPolicyEditData.Holiday_type_index=$scope.holidayPolicyEditData.holiday_type_data_index;
      holidayPolicyEditSev.setEditMode(false);

    setTimeout(function(){ $ionicScrollDelegate.resize(); }, 200);
	}

    $scope.holiday_type=function(){

      sideSelect.show({
        type : 'ios',
        data :$scope.holidayPolicyEditData.holiday_type_data,
        selectIndex :  $scope.holidayPolicyEditData.holiday_type_index,
        selectedFunc : function (index) {
          if(typeof(index)!='undefined'){
            document.getElementById("holiday_type").innerHTML=$scope.holidayPolicyEditData.holiday_type_data[index].value;
            $scope.holidayPolicyEditData.holiday_type_data_key=$scope.holidayPolicyEditData.holiday_type_data[index].key;
            $scope.holidayPolicyEditData.holiday_type_index=index;
          }

        }
      });
    }

	holidayPolicyEditSev.clearData();
    holidayPolicyEditSev.loadData($stateParams.holiday_policy_id,obj.val());
    $scope.holidayPolicyEditData = holidayPolicyEditSev.getData();

    obj.change(function(){
      holidayPolicyEditSev.loadData($stateParams.holiday_policy_id,obj.val());
    });

    $scope.loadByMonth = function(_flag){
      if(_flag == 'c'){
      }else{
        var arr = (obj.val()).split('-');
        var year = arr[0];
        var month = arr[1];
        var day = arr[2];
        var days = new Date(year, month, 0);
        days = days.getDate();
        var year2 = year;
        if(_flag == 'p'){
          var month2 = parseInt(month) - 1;
          if (month2 == 0) {
            year2 = parseInt(year2) - 1;
            month2 = 12;
          }
        }else{
          var month2 = parseInt(month) + 1;
          if (month2 == 13) {
            year2 = parseInt(year2) + 1;
            month2 = 1;
          }
        }
        var day2 = day;
        var days2 = new Date(year2, month2, 0);
        days2 = days2.getDate();
        if (day2 > days2) {
          day2 = days2;
        }
        if (month2 < 10) {
          month2 = '0' + month2;
        }
        obj.val(year2 + '-' + month2 + '-' + day2);
        document.getElementById('calendar_date_input').innerHTML=year2 + '-' + month2 + '-' + day2;
      }
      holidayPolicyEditSev.loadData($stateParams.holiday_policy_id,obj.val());
    }
    $scope.calendar_date_input=function(){
      var current_date = new Date();

      current_date = current_date.getFullYear();
      var startDate = parseInt(current_date, 10) - 10;
      startDate = startDate + '-01-01';
      var endDate = parseInt(current_date, 10) + 10;
      endDate = endDate + '-12-31';
      timeSelect.show({
        type :  'date' ,
        startDate :  '1900-01-01',
        endDate : '2099-12-31',
        defaultDate: document.getElementById("calendar_date_input").innerHTML,
        returnDateType : 'y-m-d',
        returnTimeType :  '24h'||'AMPM',
        //stepping :10,
        selectedFunc : function (date) {
          if (typeof(date) != 'undefined'){
            document.getElementById("calendar_date_input").innerHTML = date;
            obj.val(date);
            holidayPolicyEditSev.loadData($stateParams.holiday_policy_id,obj.val());
          }
        }
      })
    }
    $scope.loadDetail = function(_day,curobj){
      if(_day=='')return;
      $("._ar_c").removeClass("_ar_c");
      $(curobj.currentTarget).addClass("_ar_c");
      var _day = parseInt(_day);
      var arr = (document.getElementById('calendar_date_input').innerHTML).split('-');
      if(_day<10){
        _day = '0'+ _day;
      }
      obj.val(arr[0] + '-' + arr[1] + '-' + _day);
      document.getElementById('calendar_date_input').innerHTML=arr[0] + '-' + arr[1] + '-' + _day
      holidayPolicyEditSev.loadData($stateParams.holiday_policy_id,obj.val());
    }

    $scope.holiday_policy_detail_save = function(){

      holidayPolicyEditSev.holiday_policy_detail_save($stateParams.holiday_policy_id,$stateParams.holiday_policy_name,$scope);

	  //holidayPolicyEditSev.loadData($stateParams.holiday_policy_id,obj.val());
    }

    $scope.holiday_policy_edit_employee_select = function(){
		$location.path('home_page/home_menulist/holiday_policy_edit_employee_select/' + $stateParams.holiday_policy_id);
    }


	$scope.sub_bu_select = function(){
      sideSelect.show({
        type : 'ios',
        data :$scope.holidayPolicyEditData.sub_bu_list,
        selectIndex :  $scope.holidayPolicyEditData.sub_bu_index,
        selectedFunc : function (index) {
          if(typeof(index)!='undefined'){
				  $scope.holidayPolicyEditData.sub_bu_key = $scope.holidayPolicyEditData.sub_bu_list[index].key;
				  $scope.holidayPolicyEditData.sub_bu_value = $scope.holidayPolicyEditData.sub_bu_list[index].value;
				  $scope.holidayPolicyEditData.sub_bu_index = index;
				  holidayPolicyEditSev.holidayPolicySubBuSave($stateParams.holiday_policy_id);
          }
        }
      });
	}

  })

  .controller('holidayPolicyAddEmployeeSelectCtrl',function($scope,holidayPolicyAddEmployeeSelectSev,$stateParams,$location,$ionicPopup,$ionicHistory,$ionicScrollDelegate){
    $scope.search_control={};
    $scope.search_control.search_val='';
	holidayPolicyAddEmployeeSelectSev.clearData();
    holidayPolicyAddEmployeeSelectSev.loadData();
    $scope.holidayPolicyAddEmployeeSelectData = holidayPolicyAddEmployeeSelectSev.getData();
	$scope.img_no_policy = local_resource+'img/icon/no_announcement_notice01.png';
	$scope.img_has_policy = local_resource+'img/icon/Announcement_notice01.png';
    $scope.ckItem = function(_flag){
      if(_flag == true){
        $scope.holidayPolicyAddEmployeeSelectData.total_checked++;
      }else{
        $scope.holidayPolicyAddEmployeeSelectData.total_checked--;
      }
      $scope.holidayPolicyAddEmployeeSelectData.show_footer_bar=true;

      if ($scope.holidayPolicyAddEmployeeSelectData.total_checked == $scope.holidayPolicyAddEmployeeSelectData.data.length){
        //$scope.all_selected = true;
        document.getElementById('select_all_employee').style.display = "none";
        document.getElementById('deselect_all_employee').style.display = "block";

      }
      else {
        //$scope.all_selected = false;
        document.getElementById('select_all_employee').style.display = "block";
        document.getElementById('deselect_all_employee').style.display = "none";
      }
      setTimeout(function(){ $ionicScrollDelegate.resize();}, 200);
    }

    $scope.select_all_employee = function(){
      //$scope.all_selected = true;
      $scope.holidayPolicyAddEmployeeSelectData.show_footer_bar=true;
      document.getElementById('select_all_employee').style.display = "none";
      document.getElementById('deselect_all_employee').style.display = "block";
      $scope.holidayPolicyAddEmployeeSelectData.total_checked = $scope.holidayPolicyAddEmployeeSelectData.data.length;
      $scope.holidayPolicyAddEmployeeSelectData.show_footer_bar = true;
      for (var i=0;i<$scope.holidayPolicyAddEmployeeSelectData.data.length;i++){
        $scope.holidayPolicyAddEmployeeSelectData.data[i].ck = true;
      }
    }
    $scope.select_all_employee_cancel = function(){
      //$scope.all_selected = false;
      $scope.holidayPolicyAddEmployeeSelectData.show_footer_bar=true;
      document.getElementById('select_all_employee').style.display = "block";
      document.getElementById('deselect_all_employee').style.display = "none";
      $scope.holidayPolicyAddEmployeeSelectData.total_checked = 0;

      for (var i=0;i<$scope.holidayPolicyAddEmployeeSelectData.data.length;i++){
        $scope.holidayPolicyAddEmployeeSelectData.data[i].ck = false;
      }
      setTimeout(function(){ $ionicScrollDelegate.resize();}, 200);
    }
    $scope.cancel=function(){
   /*   document.getElementById('select_all_employee').style.display = "block";
      document.getElementById('deselect_all_employee').style.display = "none";
      $scope.holidayPolicyAddEmployeeSelectData.total_checked = 0;
      $scope.holidayPolicyAddEmployeeSelectData.show_footer_bar = false;
      for (var i=0;i<$scope.holidayPolicyAddEmployeeSelectData.data.length;i++){
        $scope.holidayPolicyAddEmployeeSelectData.data[i].ck = false;
      }
      setTimeout(function(){ $ionicScrollDelegate.resize();}, 200);

	  */



	  var temp_total_checked = 0;
      var employee_list = $('#holiday_policy_add_empl_list_hidden').val();
      var SelectData_data=$scope.holidayPolicyAddEmployeeSelectData.data;
      employee_list=employee_list+",";
      for(var i=0;i<SelectData_data.length;i++){
        if(employee_list.indexOf(SelectData_data[i].emp+",")==-1){
          SelectData_data[i].ck=false;
        }
        else{
          SelectData_data[i].ck=true;
		  temp_total_checked ++;
        }
      }
      $scope.holidayPolicyAddEmployeeSelectData.data=SelectData_data;
      $scope.holidayPolicyAddEmployeeSelectData.show_footer_bar=false;
	  $scope.holidayPolicyAddEmployeeSelectData.total_checked = temp_total_checked;
      setTimeout(function(){ $ionicScrollDelegate.resize();}, 200);




    }

	$scope.holiday_policy_add_employee_select_save = function(){
      var _empl_list='';
      var _staff_no_list='';
      for(var i=0;i<$scope.holidayPolicyAddEmployeeSelectData.data.length;i++){
        if($scope.holidayPolicyAddEmployeeSelectData.data[i].ck==true){
          _empl_list = _empl_list + $scope.holidayPolicyAddEmployeeSelectData.data[i].en+',';
          _staff_no_list = _staff_no_list + $scope.holidayPolicyAddEmployeeSelectData.data[i].emp+',';
        }
      }
      $("#holiday_policy_add_empl_list").val(_empl_list.substring(0,_empl_list.length-1));
      $("#holiday_policy_add_empl_list_hidden").val(_staff_no_list.substring(0,_staff_no_list.length-1));
      $ionicHistory.goBack();
	}

  })

  .controller('holidayPolicyEditEmployeeSelectCtrl',function($scope,holidayPolicyEditEmployeeSelectSev,$stateParams,$location,$ionicPopup,$ionicHistory,$ionicScrollDelegate){
    $scope.search_control={};
    $scope.search_control.search_val='';
	holidayPolicyEditEmployeeSelectSev.clearData();
    holidayPolicyEditEmployeeSelectSev.loadData($stateParams.holiday_policy_id);
    $scope.holidayPolicyEditEmployeeSelectData = holidayPolicyEditEmployeeSelectSev.getData();
	$scope.img_no_policy = local_resource+'img/icon/no_announcement_notice01.png';
	$scope.img_has_policy = local_resource+'img/icon/Announcement_notice01.png';
    $scope.ckItem = function(_flag){
      if(_flag == true){
        $scope.holidayPolicyEditEmployeeSelectData.total_checked++;
      }else{
        $scope.holidayPolicyEditEmployeeSelectData.total_checked--;
      }
      $scope.holidayPolicyEditEmployeeSelectData.show_footer_bar=true;

      if ($scope.holidayPolicyEditEmployeeSelectData.total_checked == $scope.holidayPolicyEditEmployeeSelectData.data.length){
        //$scope.all_selected = true;
        document.getElementById('select_all_employee').style.display = "none";
        document.getElementById('deselect_all_employee').style.display = "block";

      }
      else {
        //$scope.all_selected = false;
        document.getElementById('select_all_employee').style.display = "block";
        document.getElementById('deselect_all_employee').style.display = "none";
      }
      setTimeout(function(){ $ionicScrollDelegate.resize();}, 200);
    }

    $scope.select_all_employee = function(){
      //$scope.all_selected = true;
      $scope.holidayPolicyEditEmployeeSelectData.show_footer_bar=true;
      document.getElementById('select_all_employee').style.display = "none";
      document.getElementById('deselect_all_employee').style.display = "block";
      $scope.holidayPolicyEditEmployeeSelectData.total_checked = $scope.holidayPolicyEditEmployeeSelectData.data.length;
      $scope.holidayPolicyEditEmployeeSelectData.show_footer_bar = true;
      for (var i=0;i<$scope.holidayPolicyEditEmployeeSelectData.data.length;i++){
        $scope.holidayPolicyEditEmployeeSelectData.data[i].ck = true;
      }
    }
    $scope.select_all_employee_cancel = function(){
      //$scope.all_selected = false;
      $scope.holidayPolicyEditEmployeeSelectData.show_footer_bar=true;
      document.getElementById('select_all_employee').style.display = "block";
      document.getElementById('deselect_all_employee').style.display = "none";
      $scope.holidayPolicyEditEmployeeSelectData.total_checked = 0;

      for (var i=0;i<$scope.holidayPolicyEditEmployeeSelectData.data.length;i++){
        $scope.holidayPolicyEditEmployeeSelectData.data[i].ck = false;
      }
      setTimeout(function(){ $ionicScrollDelegate.resize();}, 200);
    }
    $scope.cancel=function(){
      var employee_list =$scope.holidayPolicyEditEmployeeSelectData.string;
      var SelectData_data=$scope.holidayPolicyEditEmployeeSelectData.data;
	  var temp_total_checked=0;
      for(var i=0;i<SelectData_data.length;i++){
        if(employee_list.indexOf(SelectData_data[i].emp+",")==-1){
          SelectData_data[i].ck=false;
        }
        else{
          SelectData_data[i].ck=true;
		  temp_total_checked++;
        }
      }
	  $scope.holidayPolicyEditEmployeeSelectData.total_checked = temp_total_checked;
      $scope.holidayPolicyEditEmployeeSelectData.data=SelectData_data;
      $scope.holidayPolicyEditEmployeeSelectData.show_footer_bar=false;
      setTimeout(function(){ $ionicScrollDelegate.resize();}, 200);
    }

	$scope.holiday_policy_edit_employee_select_save = function(){
		holidayPolicyEditEmployeeSelectSev.holiday_policy_edit_employee_select_save($stateParams.holiday_policy_id);
	}

  })


  .controller('lvCodeSettingCtrl',function($scope,lvCodeSettingSev,$stateParams,$location,$ionicPopup,$ionicHistory){
	$scope.local_resource = local_resource;
	lvCodeSettingSev.clearData();
    lvCodeSettingSev.loadData();
    $scope.lvCodeSettingData = lvCodeSettingSev.getData();
    $scope.lv_code_setting_detail = function (lv_code_id,lv_code_name,has_balance){
		$location.path('home_page/home_menulist/lv_code_setting_detail/' + lv_code_id + '/' + lv_code_name + '/' + has_balance);
	}
  })

  .controller('lvCodeSettingDetailCtrl',function($scope,lvCodeSettingDetailSev,$stateParams,$location,$ionicPopup,$ionicHistory,$ionicScrollDelegate){
	lvCodeSettingDetailSev.clearData();
    lvCodeSettingDetailSev.loadData($stateParams.lv_code_id,$stateParams.lv_code_name,$stateParams.has_balance);
    $scope.lvCodeSettingDetailData = lvCodeSettingDetailSev.getData();

	$scope.toolbar_title= $stateParams.lv_code_name + "设置";
	$scope.lv_code_name = $stateParams.lv_code_name;

	if ($stateParams.has_balance == '0'){
		document.getElementById('lv_code_has_balance').style.display = "none";
	}



	$scope.picklist_min_unit = function(){
		var picklist_key_list = "";
		var picklist_value_list = "";
		var checked_key = $('#min_unit').val();
		var checked_value = $('#min_unit_name').html();
		var picklist_title = '休假最小单位';
		var return_key_field_id = 'min_unit';
		var return_value_field_id = 'min_unit_name'


		for (var i=0;i<$scope.lvCodeSettingDetailData.min_unit_list.length;i++){
			picklist_key_list = picklist_key_list + $scope.lvCodeSettingDetailData.min_unit_list[i].key;
			picklist_value_list = picklist_value_list + $scope.lvCodeSettingDetailData.min_unit_list[i].name;
			if (i < $scope.lvCodeSettingDetailData.min_unit_list.length - 1){
				picklist_key_list = picklist_key_list + ',';
				picklist_value_list = picklist_value_list + ',';
			}
		}

		$location.path('home_page/home_menulist/picklist_min_unit/' + picklist_key_list + '/' + picklist_value_list + '/' + checked_key + '/' + checked_value + '/' + picklist_title + '/' + return_key_field_id + '/' + return_value_field_id);
	}

	$scope.picklist_exit_action = function(){
		var picklist_key_list = "";
		var picklist_value_list = "";
		var checked_key = $('#exit_action').val();
		var checked_value = $('#exit_action_name').html();
		var picklist_title = '未休完年假处理';
		var return_key_field_id = 'exit_action';
		var return_value_field_id = 'exit_action_name'

		for (var i=0;i<$scope.lvCodeSettingDetailData.exit_action_list.length;i++){
			picklist_key_list = picklist_key_list + $scope.lvCodeSettingDetailData.exit_action_list[i].key;
			picklist_value_list = picklist_value_list + $scope.lvCodeSettingDetailData.exit_action_list[i].name;
			if (i < $scope.lvCodeSettingDetailData.exit_action_list.length - 1){
				picklist_key_list = picklist_key_list + ',';
				picklist_value_list = picklist_value_list + ',';
			}
		}

		$location.path('home_page/home_menulist/picklist_template/' + picklist_key_list + '/' + picklist_value_list + '/' + checked_key + '/' + checked_value + '/' + picklist_title + '/' + return_key_field_id + '/' + return_value_field_id);
	}

	$scope.picklist_cutoff_type = function(){
		var picklist_key_list = "";
		var picklist_value_list = "";
		var checked_key = $('#cutoff_type').val();
		var checked_value = $('#cutoff_type_name').html();
		var picklist_title = '年结方式';
		var return_key_field_id = 'cutoff_type';
		var return_value_field_id = 'cutoff_type_name'

		for (var i=0;i<$scope.lvCodeSettingDetailData.cutoff_type_list.length;i++){
			picklist_key_list = picklist_key_list + $scope.lvCodeSettingDetailData.cutoff_type_list[i].key;
			picklist_value_list = picklist_value_list + $scope.lvCodeSettingDetailData.cutoff_type_list[i].name;
			if (i < $scope.lvCodeSettingDetailData.cutoff_type_list.length - 1){
				picklist_key_list = picklist_key_list + ',';
				picklist_value_list = picklist_value_list + ',';
			}
		}

		$location.path('home_page/home_menulist/picklist_template/' + picklist_key_list + '/' + picklist_value_list + '/' + checked_key + '/' + checked_value + '/' + picklist_title + '/' + return_key_field_id + '/' + return_value_field_id);
	}


	$scope.picklist_entitle_begin_date = function(){
		var picklist_key_list = "";
		var picklist_value_list = "";
		var checked_key = $('#entitle_begin_date').val();
		var checked_value = $('#entitle_begin_date_name').html();
		var picklist_title = '开始日期';
		var return_key_field_id = 'entitle_begin_date';
		var return_value_field_id = 'entitle_begin_date_name'

		for (var i=0;i<$scope.lvCodeSettingDetailData.entitle_begin_date_list.length;i++){
			picklist_key_list = picklist_key_list + $scope.lvCodeSettingDetailData.entitle_begin_date_list[i].key;
			picklist_value_list = picklist_value_list + $scope.lvCodeSettingDetailData.entitle_begin_date_list[i].name;
			if (i < $scope.lvCodeSettingDetailData.entitle_begin_date_list.length - 1){
				picklist_key_list = picklist_key_list + ',';
				picklist_value_list = picklist_value_list + ',';
			}
		}

		$location.path('home_page/home_menulist/picklist_template/' + picklist_key_list + '/' + picklist_value_list + '/' + checked_key + '/' + checked_value + '/' + picklist_title + '/' + return_key_field_id + '/' + return_value_field_id);
	}

	$scope.picklist_entitle_type = function(){
		var picklist_key_list = "";
		var picklist_value_list = "";
		var checked_key = $('#entitle_type').val();
		var checked_value = $('#entitle_type_name').html();
		var picklist_title = '享有类型';
		var return_key_field_id = 'entitle_type';
		var return_value_field_id = 'entitle_type_name'

		for (var i=0;i<$scope.lvCodeSettingDetailData.entitle_type_list.length;i++){
			picklist_key_list = picklist_key_list + $scope.lvCodeSettingDetailData.entitle_type_list[i].key;
			picklist_value_list = picklist_value_list + $scope.lvCodeSettingDetailData.entitle_type_list[i].name;
			if (i < $scope.lvCodeSettingDetailData.entitle_type_list.length - 1){
				picklist_key_list = picklist_key_list + ',';
				picklist_value_list = picklist_value_list + ',';
			}
		}

		$location.path('home_page/home_menulist/picklist_template/' + picklist_key_list + '/' + picklist_value_list + '/' + checked_key + '/' + checked_value + '/' + picklist_title + '/' + return_key_field_id + '/' + return_value_field_id);
	}


	$scope.addEntitleData = function(){
		$scope.lvCodeSettingDetailData.entitle_data.push({
			'from':'',
			'to':'',
			'days':''
		});
		setTimeout(function(){ $ionicScrollDelegate.resize(); }, 200);//scrollbottom
	}

	$scope.deleteEntitleData = function(item){
		var idx = $scope.lvCodeSettingDetailData.entitle_data.indexOf(item);
		$scope.lvCodeSettingDetailData.entitle_data.splice(idx,1);
		setTimeout(function(){ $ionicScrollDelegate.resize(); }, 200);//scrollbottom
	}

	$scope.lv_code_setting_detail_save = function(){
		lvCodeSettingDetailSev.lv_code_setting_detail_save($stateParams.lv_code_name,$scope.lvCodeSettingDetailData,$stateParams.has_balance);
	}

  })


  .controller('picklistTemplateCtrl',function($scope,$stateParams,$location,$ionicPopup,$ionicHistory){
	$scope.picklist_key_list = $stateParams.picklist_key_list.split(',');
	$scope.picklist_value_list = $stateParams.picklist_value_list.split(',');
	$scope.picklist_title = $stateParams.picklist_title;
	$scope.checked_key = $stateParams.checked_key;
	$scope.checked_value = $stateParams.checked_value;
	$scope.picklist_submit = function (){
		if (typeof (document.getElementById($stateParams.return_key_field_id).value) != 'undefined'){
			$('#' + $stateParams.return_key_field_id).val($scope.checked_key);
		}
		else {
			$('#' + $stateParams.return_key_field_id).html($scope.checked_key);
		}

		if (typeof (document.getElementById($stateParams.return_value_field_id).value) != 'undefined'){
			$('#' + $stateParams.return_value_field_id).val($scope.checked_value);
		}
		else {
			$('#' + $stateParams.return_value_field_id).html($scope.checked_value);
		}
		$ionicHistory.goBack();
	}

	$scope.item_clicked = function (checked_key,checked_value){
		document.getElementById('picklist_item_' + $scope.checked_key).style.display = "none";
		$scope.checked_key = checked_key;
		$scope.checked_value = checked_value;
		document.getElementById('picklist_item_' + $scope.checked_key).style.display = "block";
    $scope.picklist_submit();
	}

  })

.controller('picklistSignInReasonCtrl',function($scope,$stateParams,$location,$ionicPopup,$ionicHistory){
    $scope.picklist_key_list = $stateParams.picklist_key_list.split(',');
    $scope.picklist_value_list = $stateParams.picklist_value_list.split(',');
    $scope.picklist_title = $stateParams.picklist_title;
    $scope.checked_key = $stateParams.checked_key;
    $scope.checked_value = $stateParams.checked_value;
    $scope.picklist_submit = function (){
      $('#sign_in_reason_key').val($scope.checked_value);
      $('#sign_in_reason').html($scope.checked_value);
      if($scope.checked_value=="拜访客户"){
        document.getElementById("sign_in_outdoor_customer_name_div").style.display="block";
      }
      else{
        document.getElementById("sign_in_outdoor_customer_name_div").style.display="none";
      }

      $ionicHistory.goBack();
    }

    $scope.item_clicked = function (checked_key,checked_value) {
      if ($scope.checked_key != '') {
        document.getElementById('picklist_item_' + $scope.checked_key).style.display = "none";
      }
      $scope.checked_key = checked_key;
      $scope.checked_value = checked_value;
      document.getElementById('picklist_item_' + $scope.checked_key).style.display = "block";
    }

  })
  .controller('picklistEmployeeContractDetailContractTermCtrl',function($scope,$stateParams,$location,$ionicPopup,$ionicHistory){
	$scope.picklist_key_list = $stateParams.picklist_key_list.split(',');
	$scope.picklist_value_list = $stateParams.picklist_value_list.split(',');
	$scope.picklist_title = $stateParams.picklist_title;
	$scope.checked_key = $stateParams.checked_key;
	$scope.checked_value = $stateParams.checked_value;
	$scope.picklist_submit = function (){
		if (typeof (document.getElementById($stateParams.return_key_field_id).value) != 'undefined'){
			$('#' + $stateParams.return_key_field_id).val($scope.checked_key);
		}
		else {
			$('#' + $stateParams.return_key_field_id).html($scope.checked_key);
		}


		if (typeof (document.getElementById($stateParams.return_value_field_id).value) != 'undefined'){
			$('#' + $stateParams.return_value_field_id).val($scope.checked_value);
		}
		else {
			$('#' + $stateParams.return_value_field_id).html($scope.checked_value);
		}
		if ($scope.checked_key == 'F'){
			for (var i=0;i<$stateParams.hidden_fields.split(',').length;i++){
				document.getElementById($stateParams.hidden_fields.split(',')[i]).style.display = "block";
			}
			//document.getElementById('contract_end_date_uneditable_div').style.display = "block";
			//document.getElementById('contract_end_date_editable_div').style.display = "block";
		}
		else if ($scope.checked_key == 'O'){
			for (var i=0;i<$stateParams.hidden_fields.split(',').length;i++){
				document.getElementById($stateParams.hidden_fields.split(',')[i]).style.display = "none";
			}
			//document.getElementById('contract_end_date_uneditable_div').style.display = "none";
			//document.getElementById('contract_end_date_editable_div').style.display = "none";
		}
		$ionicHistory.goBack();
	}

	$scope.item_clicked = function (checked_key,checked_value){
		document.getElementById('picklist_item_' + $scope.checked_key).style.display = "none";
		$scope.checked_key = checked_key;
		$scope.checked_value = checked_value;
		document.getElementById('picklist_item_' + $scope.checked_key).style.display = "block";
    $scope.picklist_submit();
	}

  })

  .controller('attendanceSettingCtrl',function($scope,attendanceSettingSev,$stateParams,$location,$ionicPopup,$ionicHistory){
	attendanceSettingSev.clearData();
    attendanceSettingSev.loadData();
    $scope.attendanceSettingData = attendanceSettingSev.getData();
	$scope.attendance_setting_save = function(){
		attendanceSettingSev.attendance_setting_save($scope.attendanceSettingData);
	}
  })

  .controller('otToLeaveSettingCtrl',function($scope,otToLeaveSettingSev,$stateParams,$location,$ionicPopup,$ionicHistory){
	otToLeaveSettingSev.clearData();
    otToLeaveSettingSev.loadData();
    $scope.otToLeaveSettingData = otToLeaveSettingSev.getData();

	$scope.picklist_post_date_type = function(){
		var picklist_key_list = "";
		var picklist_value_list = "";
		var checked_key = $('#post_date_type').val();
		var checked_value = $('#post_date_type_name').html();
		var picklist_title = '调休假有效开始日期';
		var return_key_field_id = 'post_date_type';
		var return_value_field_id = 'post_date_type_name'


		for (var i=0;i<$scope.otToLeaveSettingData.post_data_type_list.length;i++){
			picklist_key_list = picklist_key_list + $scope.otToLeaveSettingData.post_data_type_list[i].key;
			picklist_value_list = picklist_value_list + $scope.otToLeaveSettingData.post_data_type_list[i].name;
			if (i < $scope.otToLeaveSettingData.post_data_type_list.length - 1){
				picklist_key_list = picklist_key_list + ',';
				picklist_value_list = picklist_value_list + ',';
			}
		}

		$location.path('home_page/home_menulist/picklist_template/' + picklist_key_list + '/' + picklist_value_list + '/' + checked_key + '/' + checked_value + '/' + picklist_title + '/' + return_key_field_id + '/' + return_value_field_id);
	}

	$scope.ot_to_leave_setting_save = function(){
		otToLeaveSettingSev.ot_to_leave_setting_save($scope.otToLeaveSettingData);
	}
  })

  .controller('otToLeaveCtrl',function($scope,otToLeaveSev,$stateParams,$location,$ionicPopup,$ionicHistory,$ionicScrollDelegate,timeSelect){
    $scope.search_control={};
   	$scope.search_control.search_val = "";
    if (ionic.Platform.isIOS()) {
      otToLeaveSev.clearData();
      otToLeaveSev.loadData(current_date);
      $scope.otToLeaveData = otToLeaveSev.getData();
    } else {
      $scope.$on("$ionicView.enter", function () {
        //解决 进入明细页面back回来的时候 会再次loaddata
        if (typeof($scope.data_loaded) != 'undefined') {
          return;
        }
        else {
          $scope.data_loaded = true;
        }
        otToLeaveSev.clearData();
        otToLeaveSev.loadData(current_date);
        $scope.otToLeaveData = otToLeaveSev.getData();
      });
    }

	$scope.all_selected = false;
	var current_date = new Date();
	var obj = $('#target_date1');

    current_date = (current_date.getFullYear() + '-' + (current_date.getMonth() + 1 < 10 ? '0' + (current_date.getMonth() + 1): (current_date.getMonth() + 1)) + '-' + (current_date.getDate() < 10 ? '0' + (current_date.getDate()): (current_date.getDate())));
    obj.val(current_date)
	document.getElementById("target_date").innerHTML=current_date;
    //otToLeaveSev.clearData();
    //otToLeaveSev.loadData(current_date);
    //$scope.otToLeaveData = otToLeaveSev.getData();

    $scope.target_date=function(){
        var current_date = new Date();

        current_date = current_date.getFullYear();
        var startDate = parseInt(current_date, 10) - 10;
        startDate = startDate + '-01-01';
        var endDate = parseInt(current_date, 10) + 10;
        endDate = endDate + '-12-31';
        timeSelect.show({
          type :  'date' ,
          startDate :  '1900-01-01',
          endDate : '2099-12-31',
          defaultDate: document.getElementById("target_date").innerHTML,
          returnDateType : 'y-m-d',
          returnTimeType :  '24h'||'AMPM',
          //stepping :10,
          selectedFunc : function (date) {
            if (typeof(date) != 'undefined'){
              document.getElementById("target_date").innerHTML = date;
              obj.val(date);
              otToLeaveSev.loadData(obj.val());
            }
          }
        })
      }

    obj.change(function(){
      otToLeaveSev.loadData(obj.val());
    })

    $scope.ckItem = function(_flag){

      if(_flag == true){
        $scope.otToLeaveData.num_checked =  $scope.otToLeaveData.num_checked + 1;
      }else{
        $scope.otToLeaveData.num_checked =  $scope.otToLeaveData.num_checked - 1;
      }

	  if ($scope.otToLeaveData.num_checked > 0){
		  $scope.otToLeaveData.show_footer_bar = true;
	  }
	  else{
		  $scope.otToLeaveData.show_footer_bar = false;
		  	//$ionicScrollDelegate.resize();
			//setTimeout(function(){ $ionicScrollDelegate.resize(); }, 200);
	  }
	  if ($scope.otToLeaveData.num_checked == $scope.otToLeaveData.data.length){
		//$scope.all_selected = true;
		document.getElementById('select_all_employee').style.display = "none";
		document.getElementById('deselect_all_employee').style.display = "block";

	  }
	  else {
		  //$scope.all_selected = false;
		document.getElementById('select_all_employee').style.display = "block";
		document.getElementById('deselect_all_employee').style.display = "none";
	  }
    }
    $scope.previous_day = function(){
		document.getElementById("target_date1").stepDown(1);
      document.getElementById("target_date").innerHTML=obj.val();
		otToLeaveSev.loadData(obj.val());
	}
    $scope.next_day = function(){

		document.getElementById("target_date1").stepUp(1);
      document.getElementById("target_date").innerHTML=obj.val();
		otToLeaveSev.loadData(obj.val());
	}
    $scope.select_all_employee = function(){
		//$scope.all_selected = true;
		document.getElementById('select_all_employee').style.display = "none";
		document.getElementById('deselect_all_employee').style.display = "block";
		$scope.otToLeaveData.num_checked = $scope.otToLeaveData.data.length;
		$scope.otToLeaveData.show_footer_bar = true;
		for (var i=0;i<$scope.otToLeaveData.data.length;i++){
				$scope.otToLeaveData.data[i].checked = true;
		}
	}
    $scope.cancel = function(){
		//$scope.all_selected = false;
		document.getElementById('select_all_employee').style.display = "block";
		document.getElementById('deselect_all_employee').style.display = "none";
		$scope.otToLeaveData.num_checked = 0;
		$scope.otToLeaveData.show_footer_bar = false;
		for (var i=0;i<$scope.otToLeaveData.data.length;i++){
				$scope.otToLeaveData.data[i].checked = false;
		}

	}
    $scope.ot_to_leave_save = function(){
		otToLeaveSev.ot_to_leave_save();
	}


  })

  .controller('employeeDeleteCtrl',function($scope,employeeDeleteSev,$stateParams,$location,$ionicPopup,$ionicHistory){
	$scope.employee_resign_terminated = local_resource+'img/icon/employee_resign_terminated.png';
	$scope.employee_resign_pending = local_resource+'img/icon/employee_resign_pending.png';
    $scope.search_control={};
   	$scope.search_control.search_val = "";
	employeeDeleteSev.clearData();
	employeeDeleteSev.loadData();
    $scope.employeeDeleteData = employeeDeleteSev.getData();
	$scope.employee_delete = function (employee_no){
		$ionicPopup.confirm({
			title: '提示',
			template: '<div style="text-align: center;">'+'确认删除?'+'</div>',
			cancelText:'取消',
			cancelType:'button-dark',
			okText: '确认'
		}).then(function(res) {
			if (res){
				employeeDeleteSev.employee_delete(employee_no);
			}
		});
	}
  })

  .controller('employeeResignCtrl',function($scope,employeeResignSev,$stateParams,$location,$ionicPopup,$ionicHistory,$ionicScrollDelegate){
	$scope.img_employee_resign_pending = local_resource+'img/icon/employee_resign_pending.png';
	$scope.img_employee_resign_terminated = local_resource+'img/icon/employee_resign_terminated.png';
    $scope.search_control={};
   	$scope.search_control.search_val = "";
	employeeResignSev.clearData();
	employeeResignSev.loadData();
    $scope.employeeResignData = employeeResignSev.getData();
    $scope.employee_resign_detail = function (employee_no, flag){
		$location.path('home_page/home_menulist/employee_resign_detail/' + employee_no + '/' + flag);
	}
  })

  .controller('employeeResignDetailCtrl',function($scope,employeeResignDetailSev,$stateParams,$location,$ionicPopup,$ionicHistory,$ionicScrollDelegate,timeSelect){
	employeeResignDetailSev.clearData();
	employeeResignDetailSev.loadData($stateParams.employee_no);
    $scope.employeeResignDetailData = employeeResignDetailSev.getData();
    $scope.termination_effect_date = function(){
      var current_date = new Date();
      current_date.setMinutes(current_date.getMinutes() - current_date.getTimezoneOffset());
      current_date = current_date.toJSON().slice(0,4);
      var startDate = parseInt(current_date, 10) - 10;
      startDate = startDate + '-01-01';
      var endDate = parseInt(current_date, 10) + 10;
      endDate = endDate + '-12-31';
      var _defaultDate='';
      if($scope.employeeResignDetailData.termination_effect_date==''){
        _defaultDate=new Date().getFullYear()+"-"+(new Date().getMonth()+1)+"-"+new Date().getDate()
      }
      else{
        _defaultDate=$scope.employeeResignDetailData.termination_effect_date;
      }
      timeSelect.show({
        type :  'date' ,
        startDate :  '1900-01-01',
        endDate : '2099-12-31',
        defaultDate:_defaultDate ,
        returnDateType : 'y-m-d',
        returnTimeType :  '24h'||'AMPM',
        //stepping :10,
        selectedFunc : function (date) {
          if (typeof(date) != 'undefined'){
            $scope.employeeResignDetailData.termination_effect_date = date;
          }
        }
      })
    }

    $scope.last_working_date = function(){
      var current_date = new Date();
      current_date.setMinutes(current_date.getMinutes() - current_date.getTimezoneOffset());
      current_date = current_date.toJSON().slice(0,4);
      var startDate = parseInt(current_date, 10) - 10;
      startDate = startDate + '-01-01';
      var endDate = parseInt(current_date, 10) + 10;
      endDate = endDate + '-12-31';
      var _defaultDate='';
      if($scope.employeeResignDetailData.last_working_date==''){
        _defaultDate=new Date().getFullYear()+"-"+(new Date().getMonth()+1)+"-"+new Date().getDate()
      }
      else{
        _defaultDate=$scope.employeeResignDetailData.last_working_date;
      }
      timeSelect.show({
        type :  'date' ,
        startDate :  '1900-01-01',
        endDate : '2099-12-31',
        defaultDate:_defaultDate ,
        returnDateType : 'y-m-d',
        returnTimeType :  '24h'||'AMPM',
        //stepping :10,
        selectedFunc : function (date) {
          if (typeof(date) != 'undefined'){
            $scope.employeeResignDetailData.last_working_date = date;
          }
        }
      })
    }


	if ($stateParams.flag == '0'){
		$scope.is_can_cancel = '0';
	}
	else {
		$scope.is_can_cancel = '1';
	}
	$scope.picklist_is_rehire = function(){
		var picklist_key_list = "";
		var picklist_value_list = "";
		var checked_key = $('#is_rehire').val();
		var checked_value = $('#is_rehire_name').html();
		var picklist_title = '是否重新雇佣';
		var return_key_field_id = 'is_rehire';
		var return_value_field_id = 'is_rehire_name'


		for (var i=0;i<$scope.employeeResignDetailData.is_rehire_list.length;i++){
			picklist_key_list = picklist_key_list + $scope.employeeResignDetailData.is_rehire_list[i].key;
			picklist_value_list = picklist_value_list + $scope.employeeResignDetailData.is_rehire_list[i].name;
			if (i < $scope.employeeResignDetailData.is_rehire_list.length - 1){
				picklist_key_list = picklist_key_list + ',';
				picklist_value_list = picklist_value_list + ',';

			}
		}

		$location.path('home_page/home_menulist/picklist_template/' + picklist_key_list + '/' + picklist_value_list + '/' + checked_key + '/' + checked_value + '/' + picklist_title + '/' + return_key_field_id + '/' + return_value_field_id);
	}

	$scope.employee_resign_detail_save = function(){
		employeeResignDetailSev.employee_resign_detail_save();
	}

	$scope.employee_cancel_resign = function(employee_no){
      $ionicPopup.confirm({
        title: '提示',
        template: '<div style="text-align: center;">'+'确认撤销离职?'+'</div>',
        cancelText:'取消',
        cancelType:'button-dark',
        okText: '确认'
      }).then(function(res) {
        if (res){
			employeeResignDetailSev.employee_cancel_resign(employee_no);
        }
      });


	}


  })

  .controller('employeeContractCtrl',function($scope,employeeContractSev,$stateParams,$location,$ionicPopup,$ionicHistory,$timeout,$ionicScrollDelegate){

	$scope.not_data=local_resource + "img/not_data.png";
	$scope.cry=local_resource + "img/cry.png";
	$scope.search_img = local_resource+'img/search_img.png';
	$scope.contract_management_directory1 = local_resource+'img/icon/contract_management_directory1.png';
    $scope.search_control=employeeContractSev.getSearchValue();
	$scope.searchState=employeeContractSev.getSearchState();
	$scope.searchNodata= employeeContractSev.getSearchNodata();
    $scope.end_of_list = employeeContractSev.getEndOfList();
	employeeContractSev.clearData();
	//employeeContractSev.loadData();
  //  $scope.employeeContractData = employeeContractSev.getData();

    $scope.$on("$ionicView.enter", function () {
		//解决 进入明细页面back回来的时候 会再次loaddata
		if (typeof($scope.data_loaded) != 'undefined') {
		  return;
		}
		else {
		  $scope.data_loaded = true;
		}
		employeeContractSev.loadData('');
		$scope.employeeContractData = employeeContractSev.getData();
		$scope.search_control=employeeContractSev.getSearchValue();
		$scope.searchState=employeeContractSev.getSearchState();
		$scope.searchNodata= employeeContractSev.getSearchNodata();
		$scope.end_of_list = employeeContractSev.getEndOfList();

    });
    if (ionic.Platform.isIOS()) {
		  $scope.content_top='64';
    } else {
		$scope.content_top='44';
    }

	$scope.search=function(){
		employeeContractSev.loadData($scope.search_control.search_val);
	}

    $scope.employee_contract_detail = function (employee_no,flag){
		//flag:1 有合同, flag:0 没有合同
		$location.path('home_page/home_menulist/employee_contract_detail/'+employee_no+'/'+flag);
	}
	//$scope.end_of_list=employeeContractSev.getEndOfList();
	$scope.loadMoreEmployeeData=function(){
		employeeContractSev.loadMoreData($scope)
	}

	$scope.employee_contract_search_key_down = function(){
		var e = event || window.event || arguments.callee.caller.arguments[0];
		var keycode= e.KeyCode;

		if(e.keyCode=='13'){
		$timeout(function(){
			$ionicScrollDelegate.scrollTop();
			employeeContractSev.loadData($scope.search_control.search_val);
		})
		}


	}
  })

  .controller('employeeContractDetailCtrl',function($scope,employeeContractDetailSev,$stateParams,$location,$ionicPopup,$ionicHistory,$ionicScrollDelegate,$timeout,$ionicActionSheet,timeSelect){
	$scope.img_contract_history = local_resource+'img/icon/icon_contract_history.png';
	$scope.img_delete = local_resource+'img/icon/fufu_delete.png';
	$scope.img_edit = local_resource+'img/icon/fufu_edit.png';
	$scope.img_add = local_resource+'img/icon/fufu_add_to.png';
	$scope.img_upload_file_part1 = local_resource+'img/icon/add.png';
	$scope.img_upload_file_part2 = local_resource+'img/icon/new_2.png';

	$scope.new_contract_is_require_upload = false;
	$scope.current_contract_is_require_upload = false;
    if (ionic.Platform.isIOS()) {
      employeeContractDetailSev.clearData();
      employeeContractDetailSev.loadData($scope,$stateParams.employee_no,current_date);
      $scope.employeeContractDetailData = employeeContractDetailSev.getData();
    } else {
      $scope.$on("$ionicView.enter", function () {
        //解决 进入明细页面back回来的时候 会再次loaddata
        if (typeof($scope.data_loaded) != 'undefined') {
          return;
        }
        else {
          $scope.data_loaded = true;
        }
        employeeContractDetailSev.clearData();
        employeeContractDetailSev.loadData($scope,$stateParams.employee_no,current_date);
        $scope.employeeContractDetailData = employeeContractDetailSev.getData();
      });
    }

	var current_date = new Date();

    current_date = (current_date.getFullYear() + '-' + (current_date.getMonth() + 1 < 10 ? '0' + (current_date.getMonth() + 1): (current_date.getMonth() + 1)) + '-' + (current_date.getDate() < 10 ? '0' + (current_date.getDate()): (current_date.getDate())));
   $scope.current_date_start=current_date;
    $scope.current_date_end=current_date;


    $scope.showDate_new_contract_start_date = function(){
      var current_date = new Date();
      current_date.setMinutes(current_date.getMinutes() - current_date.getTimezoneOffset());
      current_date = current_date.toJSON().slice(0,4);
      var startDate = parseInt(current_date, 10) - 10;
      startDate = startDate + '-01-01';
      var endDate = parseInt(current_date, 10) + 10;
      endDate = endDate + '-12-31';
      timeSelect.show({
        type :  'date' ,
        startDate :  '1900-01-01',
        endDate : '2099-12-31',
        defaultDate: $scope.current_date_start,
        returnDateType : 'y-m-d',
        returnTimeType :  '24h'||'AMPM',
        //stepping :10,
        selectedFunc : function (date) {
          if (typeof(date) != 'undefined'){
            $scope.current_date_start = date;
            //$scope.employeeContractDetailData.c_c_d[0].contract_start_date=date;
            //essLvApplySev.changeEssLvPolicy($scope,$scope.lv_app_data.default_lv_code_id);
          }
        }
      })
    }

    $scope.showDate_new_contract_end_date = function(){
      var current_date = new Date();
      current_date.setMinutes(current_date.getMinutes() - current_date.getTimezoneOffset());
      current_date = current_date.toJSON().slice(0,4);
      var startDate = parseInt(current_date, 10) - 10;
      startDate = startDate + '-01-01';
      var endDate = parseInt(current_date, 10) + 10;
      endDate = endDate + '-12-31';
      timeSelect.show({
        type :  'date' ,
        startDate :  '1900-01-01',
        endDate : '2099-12-31',
        defaultDate: $scope.current_date_end,
        returnDateType : 'y-m-d',
        returnTimeType :  '24h'||'AMPM',
        //stepping :10,
        selectedFunc : function (date) {
          if (typeof(date) != 'undefined'){
            $scope.current_date_end = date;
            //$scope.employeeContractDetailData.c_c_d[0].contract_end_date=date;
            //essLvApplySev.changeEssLvPolicy($scope,$scope.lv_app_data.default_lv_code_id);
          }
        }
      })
    }
	//flag:1 有合同, flag:0 没有合同
	//$scope.flag = $stateParams.flag;


    $scope.contract_start_date = function(){
      var current_date = new Date();
      current_date.setMinutes(current_date.getMinutes() - current_date.getTimezoneOffset());
      current_date = current_date.toJSON().slice(0,4);
      var startDate = parseInt(current_date, 10) - 10;
      startDate = startDate + '-01-01';
      var endDate = parseInt(current_date, 10) + 10;
      endDate = endDate + '-12-31';
      timeSelect.show({
        type :  'date' ,
        startDate :  '1900-01-01',
        endDate : '2099-12-31',
        defaultDate: document.getElementById('contract_start_date').innerHTML,
        returnDateType : 'y-m-d',
        returnTimeType :  '24h'||'AMPM',
        //stepping :10,
        selectedFunc : function (date) {
          if (typeof(date) != 'undefined'){
            document.getElementById('contract_start_date').innerHTML = date;
            //$scope.employeeContractDetailData.c_c_d[0].contract_start_date=date;
            //essLvApplySev.changeEssLvPolicy($scope,$scope.lv_app_data.default_lv_code_id);
          }
        }
      })
    }

    $scope.contract_end_date = function(){
      var current_date = new Date();
      current_date.setMinutes(current_date.getMinutes() - current_date.getTimezoneOffset());
      current_date = current_date.toJSON().slice(0,4);
      var startDate = parseInt(current_date, 10) - 10;
      startDate = startDate + '-01-01';
      var endDate = parseInt(current_date, 10) + 10;
      endDate = endDate + '-12-31';
      timeSelect.show({
        type :  'date' ,
        startDate :  startDate,
        endDate : '2099-12-31',
        defaultDate: document.getElementById('contract_end_date').innerHTML,
        returnDateType : 'y-m-d',
        returnTimeType :  '24h'||'AMPM',
        //stepping :10,
        selectedFunc : function (date) {
          if (typeof(date) != 'undefined'){
            document.getElementById('contract_end_date').innerHTML = date;
          }
        }
      })
    }

    $scope.contract_start_date_ = function(i){
      var current_date = new Date();
      current_date.setMinutes(current_date.getMinutes() - current_date.getTimezoneOffset());
      current_date = current_date.toJSON().slice(0,4);
      var startDate = parseInt(current_date, 10) - 10;
      startDate = startDate + '-01-01';
      var endDate = parseInt(current_date, 10) + 10;
      endDate = endDate + '-12-31';
      timeSelect.show({
        type :  'date' ,
        startDate :  '1900-01-01',
        endDate : '2099-12-31',
        defaultDate: document.getElementById('contract_start_date_'+i).innerHTML,
        returnDateType : 'y-m-d',
        returnTimeType :  '24h'||'AMPM',
        //stepping :10,
        selectedFunc : function (date) {
          if (typeof(date) != 'undefined'){
            document.getElementById('contract_start_date_'+i).innerHTML = date;
          }
        }
      })
    }

    $scope.contract_end_date_ = function(i){
      var current_date = new Date();
      current_date.setMinutes(current_date.getMinutes() - current_date.getTimezoneOffset());
      current_date = current_date.toJSON().slice(0,4);
      var startDate = parseInt(current_date, 10) - 10;
      startDate = startDate + '-01-01';
      var endDate = parseInt(current_date, 10) + 10;
      endDate = endDate + '-12-31';
      timeSelect.show({
        type :  'date' ,
        startDate :  '1900-01-01',
        endDate : '2099-12-31',
        defaultDate: document.getElementById('contract_end_date_'+i).innerHTML,
        returnDateType : 'y-m-d',
        returnTimeType :  '24h'||'AMPM',
        //stepping :10,
        selectedFunc : function (date) {
          if (typeof(date) != 'undefined'){
            document.getElementById('contract_end_date_'+i).innerHTML = date;
          }
        }
      })
    }
    $scope.employee_contract_detail_history = function (){
		fufuMobclickAgent('click_view_history_contract');
		$location.path('home_page/home_menulist/employee_contract_detail_history/' + $stateParams.employee_no);
	}

	$scope.picklist_contract_term = function(){
		var picklist_key_list = "";
		var picklist_value_list = "";
		var checked_key = ($('#contract_term_key').val()==''?'F':$('#contract_term_key').val());
		var checked_value = ($('#contract_term').html()==''?'固定期限劳动合同':$('#contract_term').html());
		var picklist_title = '合同类型';
		var return_key_field_id = 'contract_term_key';
		var return_value_field_id = 'contract_term';
		var hidden_fields = 'contract_end_date_uneditable_div,contract_end_date_editable_div';

		for (var i=0;i<$scope.employeeContractDetailData.p_d.length;i++){
			picklist_key_list = picklist_key_list + $scope.employeeContractDetailData.p_d[i].key;
			picklist_value_list = picklist_value_list + $scope.employeeContractDetailData.p_d[i].name;
			if (i < $scope.employeeContractDetailData.p_d.length - 1){
				picklist_key_list = picklist_key_list + ',';
				picklist_value_list = picklist_value_list + ',';
			}
		}


		$location.path('home_page/home_menulist/picklist_employee_contract_detail_contract_term/' + picklist_key_list + '/' + picklist_value_list + '/' + checked_key + '/' + checked_value + '/' + picklist_title + '/' + return_key_field_id + '/' + return_value_field_id + '/' + hidden_fields);
	}


		$scope.upload_photo_new = function (){

            // Show the action sheet
            var hideSheet = $ionicActionSheet.show({
                buttons: [

                    {
                        text: '拍照'
                    }, {
                        text: '从手机相册选择'
                    }
                ],

                //titleText: 'Modify your album',
                titleText: '选择上传图片方式',
                cancelText: '取消',
                cancel: function() {
                    // add cancel code..
                },
                buttonClicked: function(index) {

                    if (index == 0) {

                        try {
                            navigator.camera.getPicture(function(uri) {
								$scope.new_contract_is_require_upload = true;
								document.getElementById('contract_upload_mini_photo_new').style.display = "block";
                                $('#contract_upload_mini_photo_new').attr("src", uri);
								document.getElementById('contract_upload_text_new').innerText='更改图片';
                                $('#contract_upload_icon1_new').attr("src", local_resource+'img/icon/upload_modify.png');
								document.getElementById('contract_upload_icon2_new').style.display = "none";
								document.getElementById('contract_upload_text_new').style.marginTop = "1.8em";
                            }, function() {
                                //alert('cancel or failure');
                            }, {
                                quality: 10,
                                //allowEdit: true,
                                destinationType: Camera.DestinationType.FILE_URI,
                              targetHeight: 500,
                              targetWidth: 500,
                              correctOrientation: true
                            });
                        } catch (e) {
                            //alert(e.message);
                        }
                        return true;
                    } else if (index == 1) {
                        try {
                            navigator.camera.getPicture(function(uri) {
								$scope.new_contract_is_require_upload = true;
								document.getElementById('contract_upload_mini_photo_new').style.display = "block";
                                $('#contract_upload_mini_photo_new').attr("src", uri);
								document.getElementById('contract_upload_text_new').innerText='更改图片';
                                $('#contract_upload_icon1_new').attr("src", local_resource+'img/icon/upload_modify.png');
								document.getElementById('contract_upload_icon2_new').style.display = "none";
								document.getElementById('contract_upload_text_new').style.marginTop = "1.8em";
                            }, function(message) {}, {
                                quality: 100,
                                destinationType: Camera.DestinationType.FILE_URI,
                                // In this app, dynamically set the picture source, Camera or photo gallery
                                sourceType: Camera.PictureSourceType.SAVEDPHOTOALBUM,
                                encodingType: Camera.EncodingType.JPEG,
                                mediaType: Camera.MediaType.PICTURE,
                                //allowEdit: true,
                                targetHeight: 500,
                                targetWidth: 500,
                                correctOrientation: true
                            });
                        } catch (e) {
                            //alert(e.message);
                        }

                        return true;
                    }

                    return true;


                }
            });

            // For example's sake, hide the sheet after two seconds
            /*
            $timeout(function() {
            hideSheet();
            }, 2000);
            */


	}


		$scope.upload_photo_current_editable = function (){

            // Show the action sheet
            var hideSheet = $ionicActionSheet.show({
                buttons: [

                    {
                        text: '拍照'
                    }, {
                        text: '从手机相册选择'
                    }
                ],

                //titleText: 'Modify your album',
                titleText: '选择上传图片方式',
                cancelText: '取消',
                cancel: function() {
                    // add cancel code..
                },
                buttonClicked: function(index) {

                    if (index == 0) {

                        try {
                            navigator.camera.getPicture(function(uri) {
								$scope.current_contract_is_require_upload = true;
								document.getElementById('contract_upload_mini_photo_current_editable').style.display = "block";
                                $('#contract_upload_mini_photo_current_editable').attr("src", uri);
								document.getElementById('contract_upload_text_current_editable').innerText='更改图片';
                                $('#contract_upload_icon1_current_editable').attr("src", local_resource+'img/icon/upload_modify.png');
								document.getElementById('contract_upload_icon2_current_editable').style.display = "none";
								document.getElementById('contract_upload_text_current_editable').style.marginTop = "1.8em";

								document.getElementById('contract_upload_mini_photo_current_uneditable').style.display = "block";
                                $('#contract_upload_mini_photo_current_uneditable').attr("src", uri);
								//document.getElementById('contract_upload_text_current_uneditable').innerText='更改图片';
                                $('#contract_upload_icon1_current_uneditable').attr("src", local_resource+'img/icon/upload_modify.png');
								//document.getElementById('contract_upload_icon2_current_uneditable').style.display = "none";
								document.getElementById('contract_upload_text_current_uneditable').style.marginTop = "1.8em";
                            }, function() {
                                //alert('cancel or failure');
                            }, {
                                quality: 10,
                                //allowEdit: true,
                                destinationType: Camera.DestinationType.FILE_URI,
                              targetHeight: 500,
                              targetWidth: 500,
                              correctOrientation: true
                            });
                        } catch (e) {
                            //alert(e.message);
                        }
                        return true;
                    } else if (index == 1) {
                        try {
                            navigator.camera.getPicture(function(uri) {
								$scope.current_contract_is_require_upload = true;
								document.getElementById('contract_upload_mini_photo_current_editable').style.display = "block";
                                $('#contract_upload_mini_photo_current_editable').attr("src", uri);
								document.getElementById('contract_upload_text_current_editable').innerText='更改图片';
                                $('#contract_upload_icon1_current_editable').attr("src", local_resource+'img/icon/upload_modify.png');
								document.getElementById('contract_upload_icon2_current_editable').style.display = "none";
								document.getElementById('contract_upload_text_current_editable').style.marginTop = "1.8em";

								document.getElementById('contract_upload_mini_photo_current_uneditable').style.display = "block";
                                $('#contract_upload_mini_photo_current_uneditable').attr("src", uri);
								//document.getElementById('contract_upload_text_current_uneditable').innerText='更改图片';
                                $('#contract_upload_icon1_current_uneditable').attr("src", local_resource+'img/icon/upload_modify.png');
								//document.getElementById('contract_upload_icon2_current_uneditable').style.display = "none";
								document.getElementById('contract_upload_text_current_uneditable').style.marginTop = "1.8em";
                            }, function(message) {}, {
                                quality: 100,
                                destinationType: Camera.DestinationType.FILE_URI,
                                // In this app, dynamically set the picture source, Camera or photo gallery
                                sourceType: Camera.PictureSourceType.SAVEDPHOTOALBUM,
                                encodingType: Camera.EncodingType.JPEG,
                                mediaType: Camera.MediaType.PICTURE,
                                //allowEdit: true,
                                targetHeight: 500,
                                targetWidth: 500,
                                correctOrientation: true
                            });
                        } catch (e) {
                            //alert(e.message);
                        }

                        return true;
                    }

                    return true;


                }
            });

            // For example's sake, hide the sheet after two seconds
            /*
            $timeout(function() {
            hideSheet();
            }, 2000);
            */


	}


		$scope.upload_photo_future = function (current_item){

            // Show the action sheet
            var hideSheet = $ionicActionSheet.show({
                buttons: [

                    {
                        text: '拍照'
                    }, {
                        text: '从手机相册选择'
                    }
                ],

                //titleText: 'Modify your album',
                titleText: '选择上传图片方式',
                cancelText: '取消',
                cancel: function() {
                    // add cancel code..
                },
                buttonClicked: function(index) {

                    if (index == 0) {

                        try {
                            navigator.camera.getPicture(function(uri) {
								current_item.is_require_upload = true;
								document.getElementById('contract_upload_mini_photo_future_editable_' + current_item.contract_id).style.display = "block";
                                $('#contract_upload_mini_photo_future_editable_' + current_item.contract_id).attr("src", uri);
								document.getElementById('contract_upload_text_future_editable_' + current_item.contract_id).innerText='更改图片';
                                $('#contract_upload_icon1_future_editable_' + current_item.contract_id).attr("src", local_resource+'img/icon/upload_modify.png');
								document.getElementById('contract_upload_icon2_future_editable_' + current_item.contract_id).style.display = "none";
								document.getElementById('contract_upload_text_future_editable_' + current_item.contract_id).style.marginTop = "1.8em";

								document.getElementById('contract_upload_mini_photo_future_uneditable_' + current_item.contract_id).style.display = "block";
                                $('#contract_upload_mini_photo_future_uneditable_' + current_item.contract_id).attr("src", uri);
								//document.getElementById('contract_upload_text_current_uneditable').innerText='更改图片';
                                $('#contract_upload_icon1_future_uneditable_' + current_item.contract_id).attr("src", local_resource+'img/icon/upload_modify.png');
								//document.getElementById('contract_upload_icon2_current_uneditable').style.display = "none";
								document.getElementById('contract_upload_text_future_uneditable_' + current_item.contract_id).style.marginTop = "1.8em";
                            }, function() {
                                //alert('cancel or failure');
                            }, {
                                quality: 10,
                                //allowEdit: true,
                                destinationType: Camera.DestinationType.FILE_URI,
                              targetHeight: 500,
                              targetWidth: 500,
                              correctOrientation: true
                            });
                        } catch (e) {
                            //alert(e.message);
                        }
                        return true;
                    } else if (index == 1) {
                        try {
                            navigator.camera.getPicture(function(uri) {
								current_item.is_require_upload = true;
								document.getElementById('contract_upload_mini_photo_future_editable_' + current_item.contract_id).style.display = "block";
                                $('#contract_upload_mini_photo_future_editable_' + current_item.contract_id).attr("src", uri);
								document.getElementById('contract_upload_text_future_editable_' + current_item.contract_id).innerText='更改图片';
                                $('#contract_upload_icon1_future_editable_' + current_item.contract_id).attr("src", local_resource+'img/icon/upload_modify.png');
								document.getElementById('contract_upload_icon2_future_editable_' + current_item.contract_id).style.display = "none";
								document.getElementById('contract_upload_text_future_editable_' + current_item.contract_id).style.marginTop = "1.8em";

								document.getElementById('contract_upload_mini_photo_future_uneditable_' + current_item.contract_id).style.display = "block";
                                $('#contract_upload_mini_photo_future_uneditable_' + current_item.contract_id).attr("src", uri);
								//document.getElementById('contract_upload_text_current_uneditable').innerText='更改图片';
                                $('#contract_upload_icon1_future_uneditable_' + current_item.contract_id).attr("src", local_resource+'img/icon/upload_modify.png');
								//document.getElementById('contract_upload_icon2_current_uneditable').style.display = "none";
								document.getElementById('contract_upload_text_future_uneditable_' + current_item.contract_id).style.marginTop = "1.8em";
                            }, function(message) {}, {
                                quality: 100,
                                destinationType: Camera.DestinationType.FILE_URI,
                                // In this app, dynamically set the picture source, Camera or photo gallery
                                sourceType: Camera.PictureSourceType.SAVEDPHOTOALBUM,
                                encodingType: Camera.EncodingType.JPEG,
                                mediaType: Camera.MediaType.PICTURE,
                                //allowEdit: true,
                                targetHeight: 500,
                                targetWidth: 500,
                                correctOrientation: true
                            });
                        } catch (e) {
                            //alert(e.message);
                        }

                        return true;
                    }

                    return true;


                }
            });

            // For example's sake, hide the sheet after two seconds
            /*
            $timeout(function() {
            hideSheet();
            }, 2000);
            */


	}


	$scope.employee_contract_detail_edit_mode = function(){
		$scope.edit_mode = true;
		$scope.expand_mode = true;
		setTimeout(function(){ $ionicScrollDelegate.resize(); }, 200);//scrollbottom
	}

	$scope.employee_contract_detail_cancel_edit_mode = function(){
		$scope.edit_mode = false;
		$scope.expand_mode = false;
		setTimeout(function(){ $ionicScrollDelegate.resize(); }, 200);//scrolltop
	}

	$scope.employee_contract_detail_delete = function(){
		employeeContractDetailSev.employee_contract_detail_delete($stateParams.employee_no);
	}

	$scope.employee_contract_detail_save = function(){

		var num_of_upload = 0;
		var updated_o_attachment = '';
		var updated_o_attachment_array = [];
		var attachment_array = $scope.employeeContractDetailData.c_c_d[0].attachment.split(',');
		var o_attachment_array = $scope.employeeContractDetailData.c_c_d[0].o_attachment.split(',');
		var imagesObj_data_array = $scope.employeeContractDetailData.c_c_d[0].contract_image_data.split(',');

		if ($scope.employeeContractDetailData.c_c_d[0].contract_image_data != ''){
			for (var i=0;i<imagesObj_data_array.length;i++){
				if ($scope.employeeContractDetailData.c_c_d[0].attachment.indexOf(imagesObj_data_array[i])==-1){
					num_of_upload++;
				}
			}
		}

		if ($scope.employeeContractDetailData.c_c_d[0].o_attachment != ''){
			for (var i=0;i<o_attachment_array.length;i++){
				if ($scope.employeeContractDetailData.c_c_d[0].contract_image_data.indexOf(o_attachment_array[i])!=-1){
					updated_o_attachment_array.push(o_attachment_array[i]);
				}
			}
		}

		updated_o_attachment = updated_o_attachment_array.join(',');

		updated_o_attachment = updated_o_attachment.replace(' ','');


		if(num_of_upload > 0){
			employeeContractDetailSev.employee_contract_detail_save_with_upload($stateParams.employee_no,num_of_upload,updated_o_attachment);
		}
		else{
			employeeContractDetailSev.employee_contract_detail_save($stateParams.employee_no,updated_o_attachment);
		}

	}

	$scope.employee_contract_detail_toggle_expand_mode = function(){
		if ($scope.expand_mode){
			$scope.expand_mode = false;
			setTimeout(function(){ $ionicScrollDelegate.resize(); }, 200);//scrolltop
		}
		else {
			$scope.expand_mode = true;
			setTimeout(function(){ $ionicScrollDelegate.resize(); }, 200);//scrollbottom
		}
	}
//////新合同

	$scope.new_picklist_contract_term = function(){
		var picklist_key_list = "";
		var picklist_value_list = "";
		var checked_key = ($('#new_contract_term_key').val()==''?'F':$('#new_contract_term_key').val());
		var checked_value = ($('#new_contract_term').html()==''?'固定期限劳动合同':$('#new_contract_term').html());
		var picklist_title = '合同类型';
		var return_key_field_id = 'new_contract_term_key';
		var return_value_field_id = 'new_contract_term';
		var hidden_fields = 'new_contract_end_date_editable_div';


		for (var i=0;i<$scope.employeeContractDetailData.p_d.length;i++){
			picklist_key_list = picklist_key_list + $scope.employeeContractDetailData.p_d[i].key;
			picklist_value_list = picklist_value_list + $scope.employeeContractDetailData.p_d[i].name;
			if (i < $scope.employeeContractDetailData.p_d.length - 1){
				picklist_key_list = picklist_key_list + ',';
				picklist_value_list = picklist_value_list + ',';
			}
		}

		$location.path('home_page/home_menulist/picklist_employee_contract_detail_contract_term/' + picklist_key_list + '/' + picklist_value_list + '/' + checked_key + '/' + checked_value + '/' + picklist_title + '/' + return_key_field_id + '/' + return_value_field_id + '/' + hidden_fields);
	}

	$scope.new_employee_contract_detail_edit_mode = function(){
		$scope.new_expand_mode = true;
		setTimeout(function(){ $ionicScrollDelegate.resize(); }, 200);//scrollbottom
	}

	$scope.new_employee_contract_detail_cancel_edit_mode = function(){
		$scope.new_expand_mode = false;
		setTimeout(function(){ $ionicScrollDelegate.resize(); }, 200);//scrolltop
	}

	$scope.new_employee_contract_detail_delete = function(){
		employeeContractDetailSev.employee_contract_detail_delete($stateParams.employee_no);
	}

	$scope.new_employee_contract_detail_save = function(){
		if ($scope.employeeContractDetailData.new_contract_image_data != ''){
			employeeContractDetailSev.new_employee_contract_detail_save_with_upload($stateParams.employee_no);
		}
		else {
			employeeContractDetailSev.new_employee_contract_detail_save($stateParams.employee_no);
		}
	}

	$scope.new_employee_contract_detail_toggle_expand_mode = function(){
		if ($scope.new_expand_mode){
			$scope.new_expand_mode = false;
			setTimeout(function(){ $ionicScrollDelegate.resize(); }, 200);//scrolltop
		}
		else {
			$scope.new_expand_mode = true;
			setTimeout(function(){ $ionicScrollDelegate.resize(); }, 200);//scrollbottom
		}
	}

////////将来合同



	$scope.fireEvent = function(i){
		$timeout(function(){
				var current_contract_id = $scope.employeeContractDetailData.c_f_d[i].contract_id;
				$scope.employeeContractDetailData.c_f_d[i].is_require_upload = false;
				/*
				if ($scope.employeeContractDetailData.c_f_d[i].attachment != ''){
					document.getElementById('contract_upload_mini_photo_future_editable_' + current_contract_id).style.display = "block";
					$('#contract_upload_mini_photo_future_editable_' + current_contract_id).attr("src", $scope.employeeContractDetailData.c_f_d[i].attachment);
					document.getElementById('contract_upload_text_future_editable_' + current_contract_id).innerText='更改图片';
					$('#contract_upload_icon1_future_editable_' + current_contract_id).attr("src", local_resource+'img/icon/upload_modify.png');
					document.getElementById('contract_upload_icon2_future_editable_' + current_contract_id).style.display = "none";
					document.getElementById('contract_upload_text_future_editable_' + current_contract_id).style.marginTop = "1.8em";

					document.getElementById('contract_upload_mini_photo_future_uneditable_' + current_contract_id).style.display = "block";
					$('#contract_upload_mini_photo_future_uneditable_' + current_contract_id).attr("src", $scope.employeeContractDetailData.c_f_d[i].attachment);
					//document.getElementById('contract_upload_text_current_uneditable').innerText='更改图片';
					$('#contract_upload_icon1_future_uneditable_' + current_contract_id).attr("src", local_resource+'img/icon/upload_modify.png');
					//document.getElementById('contract_upload_icon2_current_uneditable').style.display = "none";
					document.getElementById('contract_upload_text_future_uneditable_' + current_contract_id).style.marginTop = "1.8em";
				}
				*/

				$scope.employeeContractDetailData.c_f_d[i].edit_mode = false;
				$scope.employeeContractDetailData.c_f_d[i].expand_mode = false;
				document.getElementById('contract_start_date_' + $scope.employeeContractDetailData.c_f_d[i].contract_id).innerHTML=$scope.employeeContractDetailData.c_f_d[i].contract_start_date;
        document.getElementById('contract_end_date_' + $scope.employeeContractDetailData.c_f_d[i].contract_id).innerHTML=$scope.employeeContractDetailData.c_f_d[i].contract_end_date;
				$('#contract_term_key_' + $scope.employeeContractDetailData.c_f_d[i].contract_id).val($scope.employeeContractDetailData.c_f_d[i].contract_term_key);
				$('#contract_term_' + $scope.employeeContractDetailData.c_f_d[i].contract_id).html($scope.employeeContractDetailData.c_f_d[i].contract_term);
				$('#contract_times_after2008_' + $scope.employeeContractDetailData.c_f_d[i].contract_id).html('2008年后第' + $scope.employeeContractDetailData.c_f_d[i].contract_times_after2008 + '次签约');
				$('#remark_' + $scope.employeeContractDetailData.c_f_d[i].contract_id).html($scope.employeeContractDetailData.c_f_d[i].remark);


				$('#uneditable_contract_start_date_' + $scope.employeeContractDetailData.c_f_d[i].contract_id).html($scope.employeeContractDetailData.c_f_d[i].contract_start_date);
				$('#uneditable_contract_end_date_' + $scope.employeeContractDetailData.c_f_d[i].contract_id).html($scope.employeeContractDetailData.c_f_d[i].contract_end_date);
				$('#uneditable_contract_term_' + $scope.employeeContractDetailData.c_f_d[i].contract_id).html($scope.employeeContractDetailData.c_f_d[i].contract_term);
				$('#uneditable_contract_times_after2008_' + $scope.employeeContractDetailData.c_f_d[i].contract_id).html('2008年后第' + $scope.employeeContractDetailData.c_f_d[i].contract_times_after2008 + '次签约');
				$('#uneditable_remark_' + $scope.employeeContractDetailData.c_f_d[i].contract_id).html($scope.employeeContractDetailData.c_f_d[i].remark);

				if ($scope.employeeContractDetailData.c_f_d[i].contract_term_key == 'O'){
					document.getElementById('contract_end_date_uneditable_div_' + $scope.employeeContractDetailData.c_f_d[i].contract_id).style.display = "none";
					document.getElementById('contract_end_date_editable_div_' + $scope.employeeContractDetailData.c_f_d[i].contract_id).style.display = "none";
				}
        }, 0);



	}


	$scope.future_picklist_contract_term = function(contract_id){
		var picklist_key_list = "";
		var picklist_value_list = "";
		var checked_key = ($('#contract_term_key_' + contract_id).val()==''?'F':$('#contract_term_key_' + contract_id).val());
		var checked_value = ($('#contract_term_' + contract_id).html()==''?'固定期限劳动合同':$('#contract_term_' + contract_id).html());
		var picklist_title = '合同类型';
		var return_key_field_id = 'contract_term_key_' + contract_id;
		var return_value_field_id = 'contract_term_' + contract_id;
		var hidden_fields = 'contract_end_date_uneditable_div_' + contract_id + ',contract_end_date_editable_div_' + contract_id;

		for (var i=0;i<$scope.employeeContractDetailData.p_d.length;i++){
			picklist_key_list = picklist_key_list + $scope.employeeContractDetailData.p_d[i].key;
			picklist_value_list = picklist_value_list + $scope.employeeContractDetailData.p_d[i].name;
			if (i < $scope.employeeContractDetailData.p_d.length - 1){
				picklist_key_list = picklist_key_list + ',';
				picklist_value_list = picklist_value_list + ',';
			}
		}


		$location.path('home_page/home_menulist/picklist_employee_contract_detail_contract_term/' + picklist_key_list + '/' + picklist_value_list + '/' + checked_key + '/' + checked_value + '/' + picklist_title + '/' + return_key_field_id + '/' + return_value_field_id + '/' + hidden_fields);
	}

	$scope.future_employee_contract_detail_edit_mode = function(contract_id){
		for (var i=0;i<$scope.employeeContractDetailData.c_f_d.length;i++){
			if ($scope.employeeContractDetailData.c_f_d[i].contract_id == contract_id){
				$scope.employeeContractDetailData.c_f_d[i].edit_mode = true;
				$scope.employeeContractDetailData.c_f_d[i].expand_mode = true;
				setTimeout(function(){ $ionicScrollDelegate.resize(); }, 200);//scrollbottom
			}
		}
	}

	$scope.future_employee_contract_detail_cancel_edit_mode = function(contract_id){
		for (var i=0;i<$scope.employeeContractDetailData.c_f_d.length;i++){
			if ($scope.employeeContractDetailData.c_f_d[i].contract_id == contract_id){
				$scope.employeeContractDetailData.c_f_d[i].edit_mode = false;
				$scope.employeeContractDetailData.c_f_d[i].expand_mode = false;
				setTimeout(function(){ $ionicScrollDelegate.resize(); }, 200);//scrolltop
			}
		}
	}

	$scope.future_employee_contract_detail_delete = function(contract_id){
		employeeContractDetailSev.future_employee_contract_detail_delete($stateParams.employee_no,contract_id);
	}

	$scope.future_employee_contract_detail_save = function(current_item,contract_id){
		var num_of_upload = 0;
		var updated_o_attachment = '';
		var updated_o_attachment_array = [];
		var attachment_array = current_item.attachment.split(',');
		var o_attachment_array = current_item.o_attachment.split(',');
		var imagesObj_data_array = current_item.contract_image_data.split(',');

		if (current_item.contract_image_data != ''){
			for (var i=0;i<imagesObj_data_array.length;i++){
				if (current_item.attachment.indexOf(imagesObj_data_array[i])==-1){
					num_of_upload++;
				}
			}
		}

		if (current_item.o_attachment != ''){
			for (var i=0;i<o_attachment_array.length;i++){
				if (current_item.contract_image_data.indexOf(o_attachment_array[i])!=-1){
					updated_o_attachment_array.push(o_attachment_array[i]);
				}
			}
		}

		updated_o_attachment = updated_o_attachment_array.join(',');


		if(num_of_upload > 0){
			employeeContractDetailSev.future_employee_contract_detail_save_with_upload($stateParams.employee_no,contract_id,current_item,num_of_upload,updated_o_attachment);
		}
		else{
			employeeContractDetailSev.future_employee_contract_detail_save($stateParams.employee_no,contract_id,current_item,updated_o_attachment);
		}

	}

	$scope.future_employee_contract_detail_toggle_expand_mode = function(contract_id){
		for (var i=0;i<$scope.employeeContractDetailData.c_f_d.length;i++){
			if ($scope.employeeContractDetailData.c_f_d[i].contract_id == contract_id){
				if ($scope.employeeContractDetailData.c_f_d[i].expand_mode){
					$scope.employeeContractDetailData.c_f_d[i].expand_mode = false;
					setTimeout(function(){ $ionicScrollDelegate.resize(); }, 200);//scrolltop
				}
				else {
					$scope.employeeContractDetailData.c_f_d[i].expand_mode = true;
					setTimeout(function(){ $ionicScrollDelegate.resize(); }, 200);//scrollbottom
				}
			}
		}


	}


  })

  .controller('employeeContractDetailHistoryCtrl',function($scope,employeeContractDetailHistorySev,$stateParams,$location,$ionicPopup,$ionicHistory,$timeout,$ionicActionSheet,timeSelect,$ionicScrollDelegate){

	$scope.zhiwen = local_resource + 'img/icon/zhiwen.png';
	$scope.renlian = local_resource + 'img/icon/renlian.png';
	$scope.contract_management_directory1 = local_resource + 'img/icon/contract_management_directory1.png';

	$scope.img_delete = local_resource+'img/icon/fufu_delete.png';
	$scope.img_edit = local_resource+'img/icon/fufu_edit.png';

	$scope.img_upload_file_part1 = local_resource+'img/icon/add.png';
	$scope.img_upload_file_part2 = local_resource+'img/icon/new_2.png';

	employeeContractDetailHistorySev.clearData();

    $scope.contract_start_date = function(i){
      var current_date = new Date();
      current_date.setMinutes(current_date.getMinutes() - current_date.getTimezoneOffset());
      current_date = current_date.toJSON().slice(0,4);
      var startDate = parseInt(current_date, 10) - 10;
      startDate = startDate + '-01-01';
      var endDate = parseInt(current_date, 10) + 10;
      endDate = endDate + '-12-31';
      timeSelect.show({
        type :  'date' ,
        startDate :  '1900-01-01',
        endDate : '2099-12-31',
        defaultDate: document.getElementById('contract_start_date_'+i).innerHTML,
        returnDateType : 'y-m-d',
        returnTimeType :  '24h'||'AMPM',
        //stepping :10,
        selectedFunc : function (date) {
          if (typeof(date) != 'undefined'){
            document.getElementById('contract_start_date_'+i).innerHTML = date;
          }
        }
      })
    }

    $scope.contract_end_date = function(i){
      var current_date = new Date();
      current_date.setMinutes(current_date.getMinutes() - current_date.getTimezoneOffset());
      current_date = current_date.toJSON().slice(0,4);
      var startDate = parseInt(current_date, 10) - 10;
      startDate = startDate + '-01-01';
      var endDate = parseInt(current_date, 10) + 10;
      endDate = endDate + '-12-31';
      timeSelect.show({
        type :  'date' ,
        startDate :  '1900-01-01',
        endDate : '2099-12-31',
        defaultDate: document.getElementById('contract_end_date_'+i).innerHTML,
        returnDateType : 'y-m-d',
        returnTimeType :  '24h'||'AMPM',
        //stepping :10,
        selectedFunc : function (date) {
          if (typeof(date) != 'undefined'){
            document.getElementById('contract_end_date_'+i).innerHTML = date;
          }
        }
      })
    }
	employeeContractDetailHistorySev.loadData($stateParams.employee_no);
    $scope.employeeContractDetailHistoryData = employeeContractDetailHistorySev.getData();

	$scope.employee_contract_detail_history_edit_mode = function(current_item){
		current_item.expand_mode = true;
		current_item.edit_mode = true;
		setTimeout(function(){ $ionicScrollDelegate.resize(); }, 200);//scrolltop
	}

	$scope.employee_contract_detail_cancel_edit_mode = function(current_item){
		current_item.edit_mode = false;
		current_item.expand_mode = false;
		setTimeout(function(){ $ionicScrollDelegate.resize(); }, 200);//scrolltop
	}

	$scope.employee_contract_detail_history_toggle_expand_mode = function(current_item){
		if (current_item.expand_mode){
			current_item.expand_mode = false;
			current_item.edit_mode = false;
		}
		else {
			current_item.expand_mode = true;
		}
		setTimeout(function(){ $ionicScrollDelegate.resize(); }, 200);//scrolltop
	}


	$scope.employee_contract_detail_history_delete = function(current_item){
		employeeContractDetailHistorySev.employee_contract_detail_history_delete(current_item);
	}

	$scope.employee_contract_detail_history_save = function(current_item){
		var num_of_upload = 0;
		var updated_o_attachment = '';
		var updated_o_attachment_array = [];
		var attachment_array = current_item.attachment.split(',');
		var o_attachment_array = current_item.o_attachment.split(',');
		var imagesObj_data_array = current_item.contract_image_data.split(',');

		if (current_item.contract_image_data != ''){
			for (var i=0;i<imagesObj_data_array.length;i++){
				if (current_item.attachment.indexOf(imagesObj_data_array[i])==-1){
					num_of_upload++;
				}
			}
		}

		if (current_item.o_attachment != ''){
			for (var i=0;i<o_attachment_array.length;i++){
				if (current_item.contract_image_data.indexOf(o_attachment_array[i])!=-1){
					updated_o_attachment_array.push(o_attachment_array[i]);
				}
			}
		}

		updated_o_attachment = updated_o_attachment_array.join(',');




		if(num_of_upload > 0){
			employeeContractDetailHistorySev.employee_contract_detail_history_save_with_upload(current_item,$scope,num_of_upload,updated_o_attachment);
		}
		else{
			employeeContractDetailHistorySev.employee_contract_detail_history_save(current_item,$scope,updated_o_attachment);
		}


	}

	$scope.load_data = function(){
		employeeContractDetailHistorySev.clearData();
		employeeContractDetailHistorySev.loadData($stateParams.employee_no);
	}

	$scope.fireEvent = function(i,current_item,contract_id){
		$timeout(function(){
				document.getElementById('contract_start_date_' + $scope.employeeContractDetailHistoryData[i].contract_id).innerHTML=$scope.employeeContractDetailHistoryData[i].contract_start_date;
      document.getElementById('contract_end_date_' + $scope.employeeContractDetailHistoryData[i].contract_id).innerHTML=$scope.employeeContractDetailHistoryData[i].contract_end_date;

	  /*
				if (current_item.attachment != ''){
					document.getElementById('contract_upload_mini_photo_' + contract_id).style.display = "block";
					$('#contract_upload_mini_photo_' + contract_id).attr("src", current_item.attachment);
					document.getElementById('contract_upload_text_' + contract_id).innerText='更改图片';
					$('#contract_upload_icon1_' + contract_id).attr("src", local_resource+'img/icon/upload_modify.png');
					document.getElementById('contract_upload_icon2_' + contract_id).style.display = "none";
					document.getElementById('contract_upload_text_' + contract_id).style.marginTop = "1.8em";
				}
		*/
        }, 0);
	}

	$scope.upload_photo = function (contract_id,current_item){
			if (current_item.edit_mode == false) {
				return;
			}

            // Show the action sheet
            var hideSheet = $ionicActionSheet.show({
                buttons: [

                    {
                        text: '拍照'
                    }, {
                        text: '从手机相册选择'
                    }
                ],

                //titleText: 'Modify your album',
                titleText: '选择上传图片方式',
                cancelText: '取消',
                cancel: function() {
                    // add cancel code..
                },
                buttonClicked: function(index) {

                    if (index == 0) {

                        try {
                            navigator.camera.getPicture(function(uri) {
								current_item.is_require_upload = true;
								document.getElementById('contract_upload_mini_photo_' + contract_id).style.display = "block";
                                $('#contract_upload_mini_photo_' + contract_id).attr("src", uri);
								document.getElementById('contract_upload_text_' + contract_id).innerText='更改图片';
                                $('#contract_upload_icon1_' + contract_id).attr("src", local_resource+'img/icon/upload_modify.png');
								document.getElementById('contract_upload_icon2_' + contract_id).style.display = "none";
								document.getElementById('contract_upload_text_' + contract_id).style.marginTop = "1.8em";
                            }, function() {
                                //alert('cancel or failure');
                            }, {
                                quality: 10,
                                //allowEdit: true,
                                destinationType: Camera.DestinationType.FILE_URI,
                              targetHeight: 500,
                              targetWidth: 500,
                              correctOrientation: true
                            });
                        } catch (e) {
                            //alert(e.message);
                        }
                        return true;
                    } else if (index == 1) {
                        try {
                            navigator.camera.getPicture(function(uri) {
								current_item.is_require_upload = true;
								document.getElementById('contract_upload_mini_photo_' + contract_id).style.display = "block";
                                $('#contract_upload_mini_photo_' + contract_id).attr("src", uri);
								document.getElementById('contract_upload_text_' + contract_id).innerText='更改图片';
                                $('#contract_upload_icon1_' + contract_id).attr("src", local_resource+'img/icon/upload_modify.png');
								document.getElementById('contract_upload_icon2_' + contract_id).style.display = "none";
								document.getElementById('contract_upload_text_' + contract_id).style.marginTop = "1.8em";
                            }, function(message) {}, {
                                quality: 100,
                                destinationType: Camera.DestinationType.FILE_URI,
                                // In this app, dynamically set the picture source, Camera or photo gallery
                                sourceType: Camera.PictureSourceType.SAVEDPHOTOALBUM,
                                encodingType: Camera.EncodingType.JPEG,
                                mediaType: Camera.MediaType.PICTURE,
                                //allowEdit: true,
                                targetHeight: 500,
                                targetWidth: 500,
                                correctOrientation: true
                            });
                        } catch (e) {
                            //alert(e.message);
                        }

                        return true;
                    }

                    return true;


                }
            });

            // For example's sake, hide the sheet after two seconds
            /*
            $timeout(function() {
            hideSheet();
            }, 2000);
            */


	}

  })



  .controller('atEmplCardRecCtrl',function($scope,atEmplCardRecSev,$stateParams,$location,$ionicPopup,$ionicHistory,timeSelect){
	//$scope.zhiwen = local_resource + 'img/icon/zhiwen.png';
	$scope.renlian = local_resource + 'img/icon/renlian.png';
	//$scope.dingwei = local_resource + 'img/icon/dingwei.png';
	//$scope.qita = local_resource + 'img/icon/qita.png';
  	$scope.img_team_attendance_fingerprint = local_resource+'img/icon/team_attendance_fingerprint.png';
	$scope.img_normal_sign_in = local_resource+'img/icon/sign_in_normal.png';
	$scope.img_fieldwork_sign_in = local_resource+'img/icon/sign_in_fieldwork.png';
	$scope.img_other_sign_in = local_resource+'img/icon/sign_in_other_types.png';
	$scope.contract_management_directory1 = local_resource + 'img/icon/contract_management_directory1.png';


    $scope.search_control = {};
   	$scope.search_control.search_val = "";
	var current_date = new Date();
	var obj = $('#card_date1');

    current_date = (current_date.getFullYear() + '-' + (current_date.getMonth() + 1 < 10 ? '0' + (current_date.getMonth() + 1): (current_date.getMonth() + 1)) + '-' + (current_date.getDate() < 10 ? '0' + (current_date.getDate()): (current_date.getDate())));
	document.getElementById('card_date').innerHTML=current_date;
    obj.val(current_date);
    //atEmplCardRecSev.clearData();
    //atEmplCardRecSev.loadData(obj.val());
    //$scope.atEmplCardRecData = atEmplCardRecSev.getData();
    if (ionic.Platform.isIOS()) {
      atEmplCardRecSev.clearData();
      atEmplCardRecSev.loadData(obj.val());
      $scope.atEmplCardRecData = atEmplCardRecSev.getData();
    } else {
      $scope.$on("$ionicView.enter", function () {
        //解决 进入明细页面back回来的时候 会再次loaddata
        if (typeof($scope.data_loaded) != 'undefined') {
          return;
        }
        else {
          $scope.data_loaded = true;
        }
        atEmplCardRecSev.clearData();
        atEmplCardRecSev.loadData(obj.val());
        $scope.atEmplCardRecData = atEmplCardRecSev.getData();
      });
    }
    obj.change(function(){
      atEmplCardRecSev.loadData(obj.val());
    })
    $scope.previous_day = function(){
		document.getElementById("card_date1").stepDown(1);
      document.getElementById('card_date').innerHTML= obj.val();
      atEmplCardRecSev.loadData(obj.val());
	}
    $scope.next_day = function(){
		document.getElementById("card_date1").stepUp(1);
      document.getElementById('card_date').innerHTML= obj.val();
		atEmplCardRecSev.loadData(obj.val());
	}

    $scope.card_date = function(){
      var current_date = new Date();
      current_date.setMinutes(current_date.getMinutes() - current_date.getTimezoneOffset());
      current_date = current_date.toJSON().slice(0,4);
      var startDate = parseInt(current_date, 10) - 10;
      startDate = startDate + '-01-01';
      var endDate = parseInt(current_date, 10) + 10;
      endDate = endDate + '-12-31';
      timeSelect.show({
        type :  'date' ,
        startDate :  '1900-01-01',
        endDate : '2099-12-31',
        defaultDate:document.getElementById('card_date').innerHTML,
        returnDateType : 'y-m-d',
        returnTimeType :  '24h'||'AMPM',
        //stepping :10,
        selectedFunc : function (date) {
          if (typeof(date) != 'undefined'){
            document.getElementById('card_date').innerHTML = date;
            obj.val(date);
            atEmplCardRecSev.loadData(obj.val());
          }
        }
      })
    }


  })




  .controller('webImportCtrl',function($scope,webImportSev,$stateParams,$location,$ionicPopup,$ionicHistory,$ionicScrollDelegate){
    $scope.search_control={};
   	$scope.search_control.search_val = "";
	  $scope.all_selected = false;
	webImportSev.clearData();
    webImportSev.loadData();
    $scope.webImportData = webImportSev.getData();

    $scope.ckItem = function(_flag){

      if(_flag == true){
        $scope.webImportData.num_checked =  $scope.webImportData.num_checked + 1;
      }else{
        $scope.webImportData.num_checked =  $scope.webImportData.num_checked - 1;
      }

	  if ($scope.webImportData.num_checked > 0){
		  $scope.webImportData.show_footer_bar = true;
	  }
	  else{
		  $scope.webImportData.show_footer_bar = false;
		  	//$ionicScrollDelegate.resize();
			//setTimeout(function(){ $ionicScrollDelegate.resize(); }, 200);
	  }
	  if ($scope.webImportData.num_checked == $scope.webImportData.data.length){
		//$scope.all_selected = true;
		document.getElementById('select_all_employee').style.display = "none";
		document.getElementById('deselect_all_employee').style.display = "block";

	  }
	  else {
		  //$scope.all_selected = false;
		document.getElementById('select_all_employee').style.display = "block";
		document.getElementById('deselect_all_employee').style.display = "none";
	  }
      setTimeout(function(){ $ionicScrollDelegate.resize();}, 200);
    }

    $scope.select_all_employee = function(){
		//$scope.all_selected = true;
		document.getElementById('select_all_employee').style.display = "none";
		document.getElementById('deselect_all_employee').style.display = "block";
		$scope.webImportData.num_checked = $scope.webImportData.data.length;
		$scope.webImportData.show_footer_bar = true;
		for (var i=0;i<$scope.webImportData.data.length;i++){
				$scope.webImportData.data[i].checked = true;
		}
	}
    $scope.cancel = function(){
		//$scope.all_selected = false;
		document.getElementById('select_all_employee').style.display = "block";
		document.getElementById('deselect_all_employee').style.display = "none";
		$scope.webImportData.num_checked = 0;
		$scope.webImportData.show_footer_bar = false;
		for (var i=0;i<$scope.webImportData.data.length;i++){
				$scope.webImportData.data[i].checked = false;
		}
      setTimeout(function(){ $ionicScrollDelegate.resize();}, 200);
	}
    $scope.web_import_save = function(){
		$ionicPopup.confirm({
			title: '提示',
			template: '<div style="text-align: center;">'+'确定导入' + $scope.webImportData.num_checked + '人到系统?'+'</div>',
			cancelText:'取消',
			cancelType:'button-dark',
			okText: '确认'
		}).then(function(res) {
			if (res){
				webImportSev.web_import_save($location);
			}
		});


	}


  })



  .controller('webImportResultCtrl',function($scope,webImportResultSev,$stateParams,$location,$ionicPopup,$ionicHistory){
	$scope.failure_employee_no_list = $stateParams.failure_employee_no_list;
	$scope.success_employee_no_list = $stateParams.success_employee_no_list;
	webImportResultSev.clearData();
	webImportResultSev.loadData($scope,$scope.failure_employee_no_list,$scope.success_employee_no_list);
	$scope.webImportResultCtrlData = webImportResultSev.getData();
	$scope.current_datetime = $stateParams.current_datetime;

	if ($scope.failure_employee_no_list == ''){
		$scope.failure_employee_count = 0;
	}
	else {
		$scope.failure_employee_count = $stateParams.failure_employee_no_list.split(',').length;
	}
	if ($scope.success_employee_no_list == ''){
		$scope.success_employee_count = 0;
	}
	else {
		$scope.success_employee_count = $stateParams.success_employee_no_list.split(',').length;
	}


	$scope.back_to_user_admin = function(){
		$location.path('home_page/home_menulist/web_import_result_user_admin/' + $stateParams.current_datetime);
	}
	$scope.import_failure_employee = function(){
		webImportResultSev.import_failure_employee($scope);
	}

	$scope.refresh_data = function(){
		webImportResultSev.loadData($scope,$scope.failure_employee_no_list,$scope.success_employee_no_list);
	}

  })

  .controller('webImportResultUserAdminCtrl',function($scope,$stateParams,settingUdSev,$ionicModal,$ionicPopup,$rootScope,$timeout,$location,$ionicHistory){
	  /*Sunny改*/
	  $scope.web_end_import = local_resource + 'img/icon/web_end_import.png';
	  $scope.address_book_import = local_resource + 'img/icon/address_book_import.png';
	  $scope.manually_add = local_resource + 'img/icon/manually_add.png';

	  /*Sunny改*/
    $scope.search_val = "";
    $scope.c_search_val = "";
    $scope.selCt = 0;
	settingUdSev.clearData();
    settingUdSev.loadSortedUserData($stateParams.current_datetime);
    $scope.user_data =  settingUdSev.getUserData();

	$scope.custom_back = function(){
		$ionicHistory.goBack(-4);
	}

	$scope.setting_user_admin_delete = function (username,user_id){
		$ionicPopup.confirm({
			title: '提示',
			template: '<div style="text-align: center;">'+'确认删除?'+'</div>',
			cancelText:'取消',
			cancelType:'button-dark',
			okText: '确认'
		}).then(function(res) {
			if (res){
				settingUdSev.setting_user_admin_delete(username,user_id);
			}
		});

	}

    $ionicModal.fromTemplateUrl('import-contacts-modal.html', {
      scope: $scope,
      animation: 'slide-in-up'
    }).then(function(modal) {
      $scope.modal = modal;
    });

	$scope.webImport = function(){
		$location.path('home_page/home_menulist/web_import');
	}

    $scope.closeModal = function() {
      $scope.modal.hide();
    };
    $scope.$on('$destroy', function() {
      $scope.modal.remove();
      $scope.add_modal.remove();
    });

    // $scope.contacts_data = [{name:'JACK.ZHENG',phone:'18682168147',ck:false},{name:'JIN',phone:'13528722976'},{name:'gary',phone:'13199092692'}];
    $scope.contacts_data = [];
    try{
      var options = new ContactFindOptions();
      options.filter = "";
      options.multiple = true;
      options.hasPhoneNumber = true;
      var fields = ['*'];
      navigator.contacts.find(fields, function(contacts){
        $scope.contacts_data = [];
        for(var i=0;i<contacts.length;i++){
          $scope.contacts_data.push({
            name:ionic.Platform.isIOS()?(angular.isDefined(contacts[i].name)?contacts[i].name.formatted:''):(angular.isDefined(contacts[i].displayName)?contacts[i].displayName:''),
            phone:contacts[i].phoneNumbers!=null?(contacts[i].phoneNumbers[0].value).replace(new RegExp(/(-)/g),''):'',
            ck:false
          })
        }
      }, function(contactError){
      }, options);
    }catch(e){}
    $scope.openModal = function() {
      $scope.modal.show();
    };

    $scope.importAction = function(){
      var phone_list = '';
      var name_list = '';
      var data = $scope.contacts_data;
      for(var i=0;i<data.length;i++){
        if(data[i].ck){
          phone_list = phone_list + data[i].phone+'*,*';
          name_list = name_list + data[i].name+'*,*';
        }
      }
      if(phone_list==''){
        $ionicPopup.alert({
          title: '提醒',
          template: '<div style="text-align: center;">没有选中通讯录数据</div>',
          okText:'确定'
        }).then(function(res) {
        });
      }else{
        $rootScope.showLoading();
        $.ajax({
          type: 'POST',
          url: window.localStorage['_remote_server_addr']+'?event=ionicAction.ionicAction.importContacts',
          timeout: 30000000,
          data: {
            phone_list:phone_list.substring(0,phone_list.length-3),
            name_list:name_list.substring(0,name_list.length-3),
            _user_name:window.localStorage['_user_name'],
            _pass_word:window.localStorage['_pass_word'],
            _is_login:window.localStorage['_is_login'],
            _notification_token:window.localStorage['_notification_token'],
            _device_type:window.localStorage['_device_type']
          },
          success: function(data, status, headers, config) {
            $rootScope.hideLoading();
            var _data = $.parseJSON(data);
			if (typeof(_data.flag) != 'undefined' && _data.flag == '0'){
				fufuMobclickAgent('click_phonebook_import');
				$location.path('home_page/home_menulist/user_import_result/'+_data.operate_date);
			}
			else {
				$ionicPopup.alert({
				  title: '运行结果',
				  template: '<div style="text-align: center;">'+fufu_network_error_msg+'</div>',
				  okText:'确定'
				}).then(function(res) {

				});
			}
          },
          error:function(data, status, headers, config) {
            $rootScope.hideLoading();
            $ionicPopup.alert({
              title : '提醒',
              template : '<div style="text-align: center;">'+fufu_network_error_msg+'</div>',
              okText : '确定'
            })
          }
        });
      }
    }

    $scope.user_contact = {
      user_name:'',
      name:'',
      staff_no:'',
      tel:'',
      email:'',
      _flag:1,
      _message:''
    }

    $ionicModal.fromTemplateUrl('add-contact-modal.html', {
      scope: $scope,
      animation: 'slide-in-up'
    }).then(function(modal) {
      $scope.add_modal = modal;
    });

    $scope.closeAddModal = function() {
      $scope.add_modal.hide();
    };
    $scope.addUser = function(){
      $scope.user_contact = {
        user_name:'',
        name:'',
        staff_no:'',
        tel:'',
        email:'',
        _flag:1,
        _message:''
      }
      $scope.add_modal.show();
    }

    $scope.saveContact = function(){
      for(var p in $scope.user_contact){
        if($scope.user_contact[p]==''&&p!='_flag'&&p!='_message'&&p!='_is_login'&&p!='_notification_token'&&p!='_device_type'){
          $scope.user_contact._flag=0;
          $scope.user_contact._message='用户信息不能为空';
          $timeout(function(){
            $scope.user_contact._flag=1;
            $scope.user_contact._message='';
          },1500);
          return;
       }
      }
      var reg = /^1[3|4|5|7|8]\d{9}$/;
      if(!reg.test($scope.user_contact.user_name)){
        $scope.user_contact._flag = 0;
        $scope.user_contact._message = '手机号码格式不正确!';
        $timeout(function(){
          $scope.user_contact._flag = 1;
          $scope.user_contact._message = '';
        },1500);
        return;
      }
      $scope.user_contact._user_name=window.localStorage['_user_name'];
      $scope.user_contact._pass_word=window.localStorage['_pass_word'];
      $scope.user_contact._is_login=window.localStorage['_is_login'];
      $scope.user_contact._notification_token=window.localStorage['_notification_token'];
      $scope.user_contact._device_type=window.localStorage['_device_type'];
      $rootScope.showLoading();
      $.ajax({
        type: 'POST',
        url: window.localStorage['_remote_server_addr']+'?event=ionicAction.ionicAction.saveContact',
        data: $scope.user_contact,
        timeout:_var_timeout,
        success: function(data, status, headers, config) {
          $rootScope.hideLoading();
          var _data = $.parseJSON(data);
          $ionicPopup.alert({
            title: '运行结果',
            template: '<div style="text-align: center;">'+_data.message+'</div>',
            okText:'确定'
          }).then(function(res) {
              if(_data.flag=="0") {
				  fufuMobclickAgent('click_single_import');
                $scope.closeAddModal();
                settingUdSev.loadUserData();
              }
          });
        },
        error:function(data, status, headers, config) {
          $rootScope.hideLoading();
          $ionicPopup.alert({
            title : '提醒',
            template : '<div style="text-align: center;">'+fufu_network_error_msg+'</div>',
            okText : '确定'
          })
        }
      });
    }
  })


  .controller('changeUsernameCtrl',function($scope,changeUsernameSev,$stateParams,$location,$ionicPopup,$ionicHistory,$timeout){
    var reg = /^1[3|4|5|7|8]\d{9}$/;
    $('#_change_username_action').attr('disabled','disabled');
	$scope.change_user_data = changeUsernameSev.getChangeUserData();
	$scope.changeUsernameSendVCode = function(){
		if(!reg.test($scope.change_user_data.tel_no)){
          $scope.change_user_data._flag = 0;
          $scope.change_user_data._message = '手机号码格式不正确!';
          $timeout(function () {
            $scope.change_user_data._flag = 1;
            $scope.change_user_data._message = '';
          }, 1500);
		}
		else{
			changeUsernameSev.changeUsernameSendVCode();
		}
	}

	$scope.changeUsernameAction = function(){
		changeUsernameSev.changeUsernameAction();
	}

  })

  .controller('resignUserCtrl',function($scope,resignUserSev,$stateParams,$location,$ionicPopup,$ionicHistory,$timeout){
	$scope.img_cancel = local_resource + "img/icon/cancellatio_of_personal_user.png";
	$scope.resign_user_action = function(){
		$ionicPopup.confirm({
			title: '提示',
			template: '<div style="text-align: center;">'+'确认注销当前用户?'+'</div><div style="text-align: center;">(注销之后将无法再使用当前用户)</div>',
			cancelText:'取消',
			cancelType:'button-dark',
			okText: '确认'
		}).then(function(res) {
			if (res){
				resignUserSev.resignUserAction();
			}
		});

	}
  })

  .controller('companyInfoCtrl',function($scope,companyInfoSev,$stateParams,$location,$ionicPopup,$ionicHistory,$timeout,sideSelect){
	companyInfoSev.clearData();
	companyInfoSev.loadData();
    $scope.companyInfoData = companyInfoSev.getData();
	$scope.resignCompany = function(){
		$ionicPopup.confirm({
			title: '提示',
			template: '<div style="text-align: center;">'+'确认注销当前企业?'+'</div><div style="text-align: center;">(注销之后将无法还原,请慎重)</div>',
			cancelText:'取消',
			cancelType:'button-dark',
			okText: '确认'
		}).then(function(res) {
			if (res){
				companyInfoSev.resignCompany();
			}
		});

	}
	$scope.saveCompanyInfo = function(){

		companyInfoSev.saveCompanyInfo();
	}


    $scope.side_category=function(){
      sideSelect.show({
        type : 'ios',
        data :$scope.companyInfoData.side_category_data,
        selectIndex :  $scope.companyInfoData.side_category_index,
        selectedFunc : function (index) {
          if(typeof(index)!='undefined'){
            document.getElementById("company_info_category").innerHTML=$scope.companyInfoData.side_category_data[index].value;
            $scope.companyInfoData.side_category_index=index;
            $scope.companyInfoData.cg=$scope.companyInfoData.side_category_data[index].key;
          }
        }
      });
    }

    $scope.side_empl_num=function(){
      sideSelect.show({
        type : 'ios',
        data :$scope.companyInfoData.side_empl_num_data,
        selectIndex :  $scope.companyInfoData.side_empl_num_index,
        selectedFunc : function (index) {
          if(typeof(index)!='undefined'){
            document.getElementById("login_empl_num").innerHTML=$scope.companyInfoData.side_empl_num_data[index].value;
            $scope.companyInfoData.side_empl_num_index=index;
			$scope.companyInfoData.e_ct=$scope.companyInfoData.side_empl_num_data[index].key;

            //$scope.regModel._empl_num=document.getElementById("login_empl_num").innerHTML;
          }
        }
      });
    }

  })

  .controller('staffMasterPositionTreePicklistCtrl',function($scope,staffMasterPositionTreePicklistSev,$stateParams,$location,$ionicPopup,$ionicHistory,$timeout){
	staffMasterPositionTreePicklistSev.clearData();
	staffMasterPositionTreePicklistSev.loadData($stateParams.o_i);
    $scope.staffMasterPositionTreePicklistData = staffMasterPositionTreePicklistSev.getData();
	if ($stateParams.o_i != '') {
		$scope.checked_node = $stateParams.o_i;
		$scope.checked_node_name = $stateParams.o_n;
		//document.getElementById('position_picklist_tree_button').style.display = "block";
	}
	else {
		$scope.checked_node = '';
		$scope.checked_node_name = '';
	}
	$scope.$on('$ionTreeList:ItemClicked', function(event, item) {

		if ($scope.checked_node != ''){
			document.getElementById('position_node_' + 	$scope.checked_node).style.backgroundColor = '#fff';
		}
		$scope.checked_node = item.n_i;
		$scope.checked_node_name = item.n_n;
	  	document.getElementById('position_node_' + 	$scope.checked_node).style.backgroundColor = '#f5f5f5';
		//document.getElementById('position_picklist_tree_button').style.display = "block";
	});
	$scope.position_picklist = function (){
		if ($scope.checked_node == ''){
			$ionicPopup.alert({
			  title: '提醒',
			  template: '<div style="text-align: center;">请选择组织架构</div>',
			  okText:'确定'
			}).then(function(res) {
			});
		}
		else {
			if ($stateParams.page_name == 'staff_master') {
				$location.path('home_page/home_menulist/staff_master_position_picklist/' + $scope.checked_node + '/' + $scope.checked_node_name + '/' + $stateParams.p_i + '/' + $stateParams.p_n);
			}
			else {
				$location.path('home_page/home_menulist/personnal_details_position_picklist/' + $scope.checked_node + '/' + $scope.checked_node_name + '/' + $stateParams.p_i + '/' + $stateParams.p_n);
			}
		}
	}



/*
$scope.temp_tree=[{
    "n_i": "2538",
    "n_n": "施特伟",
    "ch": false,
    "tr": [{
        "n_i": "2539",
        "n_n": "深圳分公司",
        "ch": false,
        "tr": [{
            "n_i": "2540",
            "n_n": "开发部",
            "ch": false,
            "tr": [{
                "n_i": "2543",
                "n_n": "云项目",
                "ch": false
            }, {
                "n_i": "2544",
                "n_n": "实施项目",
                "ch": false
            }]
        }, {
            "n_i": "2541",
            "n_n": "行政部",
            "ch": true
        }, {
            "n_i": "2542",
            "n_n": "设计部",
            "ch": false
        }]
    }]
}]
*/
  })

 .controller('staffMasterPositionPicklistCtrl',function($scope,staffMasterPositionPicklistSev,$stateParams,$location,$ionicPopup,$ionicHistory,$timeout){
	staffMasterPositionPicklistSev.clearData();
	staffMasterPositionPicklistSev.loadData($stateParams.o_i,$stateParams.p_i);
    $scope.staffMasterPositionPicklistData = staffMasterPositionPicklistSev.getData();
	$scope.position_clicked = function (position_id){
		document.getElementById('position_picklist_button').style.display = "block";
		for (var i=0;i<$scope.staffMasterPositionPicklistData.length;i++){
			if ($scope.staffMasterPositionPicklistData[i].n_i == position_id){
				$scope.staffMasterPositionPicklistData[i].ch = true;
			}
			else {
				$scope.staffMasterPositionPicklistData[i].ch = false;
			}
		}
    	//$ionicHistory.goBack(-2);
	}
	$scope.picklist_complete = function (){
		for (var i=0;i<$scope.staffMasterPositionPicklistData.length;i++){
			if ($scope.staffMasterPositionPicklistData[i].ch){
				$('#p_n_i').val($scope.staffMasterPositionPicklistData[i].n_i);
				$('#o_n_i').val($stateParams.o_i);
				$("#dept_name_div").html($stateParams.o_n)
				$("#position_name_div").html($scope.staffMasterPositionPicklistData[i].n_n)
				$ionicHistory.goBack(-2);
			}
		}
	}
  })

 .controller('tempStaffMasterPositionPicklistCtrl',function($scope,tempStaffMasterPositionPicklistSev,$stateParams,$location,$ionicPopup,$ionicHistory,$timeout){
	$scope.o_i = $stateParams.o_i;
	$scope.p_i = $stateParams.p_i;
	$scope.o_n = $stateParams.o_n;
	$scope.p_n = $stateParams.p_n;

	tempStaffMasterPositionPicklistSev.clearData();
	tempStaffMasterPositionPicklistSev.loadData($stateParams.node_id);
    $scope.tempStaffMasterPositionPicklistData = tempStaffMasterPositionPicklistSev.getData();
	$scope.position_clicked = function (p_i,p_n,o_i,o_n){
		$scope.o_i = o_i;
		$scope.p_i = p_i;
		$scope.o_n = o_n;
		$scope.p_n = p_n;
    $scope.picklist_submit();
	}
	$scope.picklist_submit = function (){
		$("#o_n_i").val($scope.o_i);
		$("#dept_name_div").html($scope.o_n);
		$("#p_n_i").val($scope.p_i);
		$("#position_name_div").html($scope.p_n);
    	$ionicHistory.goBack();
	}

  })


    .controller('atSignInCtrl',function($scope,atSignInSev,$stateParams,$location,$ionicPopup,$ionicHistory,$rootScope,$ionicActionSheet,homemessageSev,timeSelect){

      var current_date = new Date();
      var shake_process_timeout;
      var current_address = '';
      var current_latitude = '';
      var current_longitude = '';
      var  address_city='';
      $scope.shake_original = local_resource + 'img/icon/shake_process1.png';
      $scope.shake_disable = local_resource + 'img/icon/shake_disable.png';
      $scope.press_img = local_resource + 'img/icon/Field_manual_punch.png';
      $scope.press_disable_img = local_resource + 'img/icon/Field_manual_punch_02.png';
      $scope.img_selected = local_resource + 'img/icon/selected.png';
      $scope.wifi_img = local_resource + 'img/icon/wifi.png';
      $scope.img_at_disable_sign_in = local_resource + 'img/icon/at_disable_sign_in.png';
      $scope.signinbgimg= local_resource + 'img/model/sign_in_div_bgimg.png';
//new imgsrc
      $scope.field_attendance= local_resource+'img/icon/field_attendance.png';
      $scope.Sign_photos= local_resource+'img/icon/Sign_photos.png';
      $scope.img_team_attendance_iocation = local_resource+'img/icon/team_attendance_iocation.png';
      $scope.img_team_attendance_wifi = local_resource+'img/icon/team_attendance_wifi.png';
      $scope.img_team_attendance_fingerprint = local_resource+'img/icon/team_attendance_fingerprint.png';
      $scope.img_team_attendance_examination = local_resource+'img/icon/team_attendance_examination.png';
      $scope.img_circle3 = local_resource+'img/icon/circle3.png';
      $scope.img_circle4 = local_resource+'img/icon/circle4.png';
      $scope.img_circle5 = local_resource+'img/icon/circle5.png';
      $scope.img_circle6 = local_resource+'img/icon/circle6.png';
      $scope.img_normal_sign_in = local_resource+'img/icon/sign_in_normal.png';
      $scope.img_fieldwork_sign_in = local_resource+'img/icon/sign_in_fieldwork.png';
      $scope.img_other_sign_in = local_resource+'img/icon/sign_in_other_types.png';

	  fufuMobclickAgent('click_sign_in_view');

      $scope.outdoor_address='';

		try{
		  getLocation.location(function(msg){
			current_address = msg.address;
			current_latitude = msg.latitude;
			current_longitude = msg.longitude;
			address_city= msg.city;
			//$scope.outdoor_address=msg.address;
			if(typeof(current_address)!="undefined" && current_address!='') {
			  try{
				document.getElementById('wifi_sign_in_out').style.display = 'block';
				document.getElementById('wifi_sign_in_out_address').innerHTML=current_address;
			  }
			  catch(e){

			  }

			}
		  });
		}catch(e){
		  console.log(e.message);
		}



    $scope.details_click=function(){
      document.getElementById('sign_in_tab_1').style.color='white';
      document.getElementById('sign_in_tab_1').style.backgroundColor='#53afff';
      document.getElementById('sign_in_tab_1').style.border='1px solid #53afff';
      document.getElementById('sign_in_tab_2').style.color='black';
      document.getElementById('sign_in_tab_2').style.backgroundColor='white';
      document.getElementById('sign_in_tab_2').style.border='1px solid #eeeeee';
      document.getElementById('sign_in_tab_2').style.borderLeft='none';
      document.getElementById('signoutdoor').style.display="block";
      document.getElementById('signindoor').style.display="none";
      //OtTeamRecordSev.loadData(_date,$scope);
      //$scope.ot_team_record_data = OtTeamRecordSev.getData();
    }
    $scope.statistics_click=function(){
      document.getElementById('signoutdoor').style.display="none";
      document.getElementById('signindoor').style.display="block";
      document.getElementById('sign_in_tab_2').style.border='1px solid #53afff'
      document.getElementById('sign_in_tab_1').style.color='black';
      document.getElementById('sign_in_tab_1').style.backgroundColor='white';
      document.getElementById('sign_in_tab_1').style.border='1px solid #eeeeee';
      document.getElementById('sign_in_tab_1').style.borderRight='none';
      document.getElementById('sign_in_tab_2').style.color='white';
      document.getElementById('sign_in_tab_2').style.backgroundColor='#53afff';
      //OtTeamRecordSev.loadStatisticsData(_date,$scope);
      //$scope.ot_team_record_statistics_data=OtTeamRecordSev.getStatisticsData();
    };
    $scope.no_out_door_click=function(){
      $ionicPopup.alert({
        title: '提醒',
        template: '<div style="text-align: center;">今天尚未申请外出</div>',
        okText: '确定'
      }).then(function (res) {

      });
    }

	$scope.redirect_to_approval = function(p_i,t_id,ty,is_process){
    if(ty=='100'){
      $location.path("home_page/ess_my_apply_details_content_fieldwork_atsignin/"+p_i+"/"+"my_apply"+"/"+t_id+"/"+"未完成"+"/"+is_process+"/at_sign_in");
    }
    else if(ty=='101'){
      $location.path("home_page/ess_my_apply_details_content_offic_work_out_atsignin/"+p_i+"/"+"my_apply"+"/"+t_id+"/"+"未完成"+"/"+is_process+"/at_sign_in");
    }
	}

	    $scope.processing = 0;
      var process_counter = 0;
      //$('._press_at_sign_in').text('按一下打卡');
      clearTimeout(shake_process_timeout);
      //点击图片获得地理位置
      $scope.shake_outer_div_click = function (){
		if ($scope.atSignInData.is_can_in == '0'){

			return;
		}

        if ($scope.atSignInData.valid_mode == '1,2' ||  $scope.atSignInData.valid_mode == '2'){
          getLocation.checkCanLocation(
            function(result) {
              if (result == 1) {
                sign_in_preset();
              }
            });
        }
        else {
          sign_in_preset();
        }


	  }

      function sign_in_preset(){
        if ($scope.processing == 0){
          $scope.processing = 1;
          current_address = '';
          current_latitude = '';
          current_longitude = '';
          document.getElementById("sign_in_wifi_name").value = '';
          document.getElementById("sign_in_wifi_mac").value = '';
          $rootScope.showLoading();
          shake_process();


          try{
            getLocation.location(function(msg){
              current_address = msg.address;
              current_latitude = msg.latitude;
              current_longitude = msg.longitude;
              address_city= msg.city;
            });
          }catch(e){
            console.log(e.message);
          }



          if ($scope.atSignInData.valid_mode == '1,2' ||  $scope.atSignInData.valid_mode == '1'){
            try{
              network.wifiInfo(function(msg){
                try{
                  var wifi_arr1=msg.wifiName.replace(/(.)(?=[^$])/g,"$1,").split(",");
                  var wifi_str="";
                  for(var v=0;v<wifi_arr1.length;v++){
                    if(wifi_arr1[v]!='"'){
                      wifi_str=wifi_str+wifi_arr1[v];
                    }
                  }
                  document.getElementById("sign_in_wifi_name").value= wifi_str;
                  document.getElementById("sign_in_wifi_mac").value= msg.mac;

                  if (typeof($scope.atSignInData.wifi_mac) != 'undefined'){

                    if ($scope.atSignInData.wifi_mac ==  msg.mac && ($scope.atSignInData.valid_mode == '1,2' ||  $scope.atSignInData.valid_mode == '1')){

                      document.getElementById("wifi_sign_in").style.display = "block";
                    }
                    else {
                      document.getElementById("wifi_sign_in").style.display = "none";
                    }
                  }
                }catch(e){

                }
                //  alert(msg.mac);
              });
            }
            catch(e){
              console.log(e.message);

            }
          }



        }

      }


      function shake_process() {


        $('._press_at_sign_in').text('正在打卡，请稍等...');
        shake_process_timeout = setTimeout(shake_process, 100);


        process_counter = process_counter + 1;
        if (process_counter == 100 || ($scope.atSignInData.valid_mode == '1,2' && current_address != '' && document.getElementById("sign_in_wifi_mac").value != '') ||
          ($scope.atSignInData.valid_mode == '1' && document.getElementById("sign_in_wifi_mac").value != '') ||
          ($scope.atSignInData.valid_mode == '2' && current_address != '') ||
          ($scope.atSignInData.valid_mode == '')
        ) {

          $rootScope.hideLoading();
          clearTimeout(shake_process_timeout);
          process_counter = 0;

          if (process_counter == 100) {
            if (current_address == '') {
              $ionicPopup.alert({
                title: '提醒',
                template: '<div style="text-align: center;">获取定位信息失败，请重新打卡</div>',
                okText: '确定'
              }).then(function (res) {
                $scope.processing = 0;
                $rootScope.hideLoading();
                //$('._press_at_sign_in').text('按一下打卡');
              });
            }
            else if (document.getElementById("sign_in_wifi_mac").value == '' && ($scope.atSignInData.valid_mode == '1,2' || $scope.atSignInData.valid_mode == '1')) {
              $ionicPopup.alert({
                title: '提醒',
                template: '<div style="text-align: center;">获取Wifi信息失败，请重新打卡</div>',
                okText: '确定'
              }).then(function (res) {
                $scope.processing = 0;
                $rootScope.hideLoading();
                //$('._press_at_sign_in').text('按一下打卡');
              });
            }
          }
          else {
            atSignInSev.signInAction($scope, current_address, current_latitude, current_longitude);
          }


        }
      }

        $scope.reddi = function () {
        if($scope.atSignInData.is_can_out=="1"){
          $ionicPopup.confirm({
            template: '<div style="text-align: center;">不在允许签到范围内，是否使用异地打卡继续签到?</div>',
            cancelType: 'button-dark',
            cancelText: '取消',
            okText: '继续打卡'
          }).then(function (res) {
            if (res) {
              $scope.processing = 0;
              $location.path('home_page/remote_clock');
            }

          });
        }
          else{
          $ionicPopup.alert({
            title: '提醒',
            template: '<div style="text-align: center;">未抵达内勤签到位置范围！</div>',
            okText: '确定'
          }).then(function (res) {

          });

        }

          $scope.processing = 0;
        }
        current_date.setMinutes(current_date.getMinutes() - current_date.getTimezoneOffset());
        current_date = current_date.toJSON().slice(0, 10);

		atSignInSev.clearData();
        atSignInSev.loadData(current_date);

        $scope.$on("$ionicView.enter", function(event, data){
          //$('#at_sign_in_current_date').val();
          //console.log(document.getElementById('at_sign_in_current_date'));
      document.getElementById("previous_day").onclick=function(){
		  fufuMobclickAgent('click_sign_in_history');
        document.getElementById("at_sign_in_current_date").stepDown(1);
        document.getElementById("at_sign_in_current_date_1").innerHTML=document.getElementById("at_sign_in_current_date").value;
        atSignInSev.loadData($('#at_sign_in_current_date').val());

      }
          document.getElementById("next_day_clickable").onclick=function(){
			  fufuMobclickAgent('click_sign_in_history');
            document.getElementById("at_sign_in_current_date").stepUp(1);
            document.getElementById("at_sign_in_current_date_1").innerHTML=document.getElementById("at_sign_in_current_date").value;
            atSignInSev.loadData($('#at_sign_in_current_date').val());

          }

          $('#at_sign_in_current_date').change(function(){
            atSignInSev.loadData($('#at_sign_in_current_date').val());
          })
          $('#at_sign_in_current_date').val(current_date);
          var obj = $('#at_sign_in_current_date');
          $scope.load_card_record = function () {
            atSignInSev.loadData(obj.val());
          }
          document.getElementById("at_sign_in_current_date_2").onclick=function(){
              var current_date = new Date();
              var month=current_date.getMonth()+1;
              var day=current_date.getDate();
              current_date.setMinutes(current_date.getMinutes() - current_date.getTimezoneOffset());
              current_date = current_date.toJSON().slice(0,4);
              var startDate = parseInt(current_date, 10) - 10;
              startDate = startDate + '-01-01';
              var endDate = parseInt(current_date, 10)
              timeSelect.show({
                type :  'date' ,
                startDate :  '1900-01-01',
                endDate : endDate+"-"+month+"-"+day,
                defaultDate: document.getElementById("at_sign_in_current_date_1").innerHTML,
                returnDateType : 'y-m-d',
                returnTimeType :  '24h'||'AMPM',
                //stepping :10,
                selectedFunc : function (date) {
                  if (typeof(date) != 'undefined'){
					  fufuMobclickAgent('click_sign_in_history');
                    document.getElementById("at_sign_in_current_date_1").innerHTML = date;
                    document.getElementById("at_sign_in_current_date").value=date;
                    atSignInSev.loadData($('#at_sign_in_current_date').val());
                  }
                }
              })

          }
        });

        $scope.sign_in_outdoor = function () {
          $location.path('home_page/at_sign_in_outdoor');
          //$location.path('home_page/remote_clock');
        }

        $scope.atSignInData = atSignInSev.getData();
        $scope.display_time = atSignInSev.getDisplayTime();

        //obj.change(function () {
        //  alert(obj.val());
        //  atSignInSev.loadData(obj.val());
        //})
        //$scope.previous_day = function () {
        //
        //  document.getElementById("at_sign_in_current_date").stepDown(1);
        //  atSignInSev.loadData(obj.val());
        //}
        //$scope.next_day = function () {
        //  document.getElementById("at_sign_in_current_date").stepUp(1);
        //  atSignInSev.loadData(obj.val());
        //}

        //$scope.load_card_record = function () {
        //  atSignInSev.loadData(obj.val());
        //}

        if ($scope.atSignInData.valid_mode == '1,2' || $scope.atSignInData.valid_mode == '1') {
          try {
            network.wifiInfo(function (msg) {
         try{
           if(msg.state=='-1'&&ionic.Platform.isIOS()){
             $ionicPopup.alert(
               {
                 title: '提醒',
                 template: '<div style="text-align: center;">无法获取当前WiFi,请启动WIFI重试</div>',
                 okText: '确定'
               });
             return;
           }
           var wifi_arr1 = msg.wifiName.replace(/(.)(?=[^$])/g, "$1,").split(",");
           var wifi_str = "";
           for (var v = 0; v < wifi_arr1.length; v++) {
             if (wifi_arr1[v] != '"') {
               wifi_str = wifi_str + wifi_arr1[v];
             }
           }

           document.getElementById("sign_in_wifi_name").value = wifi_str;
           document.getElementById("sign_in_wifi_mac").value = msg.mac;

           if (typeof($scope.atSignInData.wifi_mac) != 'undefined') {

             if ($scope.atSignInData.mac == document.getElementById("sign_in_wifi_mac").value && ($scope.atSignInData.valid_mode == '1,2' || $scope.atSignInData.valid_mode == '1')) {

               document.getElementById("wifi_sign_in").style.display = "block";
             }
             else {
               document.getElementById("wifi_sign_in").style.display = "none";
             }
           }
         }
              catch(e){

              }
              //  alert(msg.mac);
            });
          }
          catch (e) {
            console.log(e.message);

          }
        }


      })
    .controller('atSignInOutDoorCtrl', function ($scope,atSignInOutDoorSev,$location,$ionicModal,essLvApplySev,$ionicPopup,$rootScope,$ionicHistory,$ionicScrollDelegate,$emplComponentService) {

      var current_address='';
      var current_latitude='';
      var current_longitude='';
      var location_obj = {'latitude':'','longitude':'','address':'','city':''};
      $scope.field_attendance= local_resource+'img/icon/field_attendance.png';
      $scope.Sign_photos= local_resource+'img/icon/Sign_photos.png';
	  $scope.is_require_upload = '0';
      try{
        document.getElementById("atSignInOutDoorCtrlSpinner").style.display='block';
        document.getElementById("atSignInOutDoorCtrlSubmit").style.backgroundColor='#eeeeee';

		getLocation.checkCanLocation(
			function(result){
				if (result == 1){
					getLocation.location(function(msg){
					  try{
              location_obj = {
                'latitude':msg.latitude,
                'longitude':msg.longitude,
                'address':msg.address,
                'city':msg.city
              };
						current_address = msg.address;
              if(typeof(current_address)!='undefined' && current_address !='') {
                document.getElementById("address_now").innerText = current_address;
                document.getElementById("atSignInOutDoorCtrlSpinner").style.display='none';
                document.getElementById("atSignInOutDoorCtrlSubmit").style.backgroundColor='#53afff';
                document.getElementById("message_city").value = msg.city;
                current_latitude = msg.latitude;
                current_longitude = msg.longitude;
                $("#atSignInOutDoor #current_latitude_hidden").val(current_latitude);
                $("#atSignInOutDoor #current_longitude_hidden").val(current_longitude);
              }


					  }catch(e){}

					});
				}
        else{
          //$ionicHistory.goBack();
          document.getElementById("atSignInOutDoorCtrlSpinner").style.display='none';
        }
			}
		);


      }catch(e){
        console.log(e.message);
      }
		atSignInOutDoorSev.clearData();
      atSignInOutDoorSev.loadData($scope);
      $scope.atSignInOutDoorData = atSignInOutDoorSev.getData();
      $scope.getAddress= function ($scope) {
        if(document.getElementById("atSignInOutDoorCtrlSpinner").style.display=='block'){
          return;
        }
        try{
			getLocation.checkCanLocation(
				function(result){
					if (result == 1){
					  getLocation.showMap(function(msg){
						if(typeof(msg.address)=='undefined'|| msg.address==""||msg.address==null||msg.address=='(null)'){}
						else {
						 try{

               location_obj = {
                 'latitude':msg.latitude,
                 'longitude':msg.longitude,
                 'address':msg.address,
                 'city':msg.detailAddress
               };

						   current_address = msg.address;
						   document.getElementById("address_now").innerText = current_address;
						   document.getElementById("message_city").value = msg.city;
						   current_latitude = msg.latitude;
						   current_longitude = msg.longitude;
						   $("#atSignInOutDoor #current_latitude_hidden").val(current_latitude);
						   $("#atSignInOutDoor #current_longitude_hidden").val(current_longitude);
						   document.getElementById("message_city").value = msg.city;
						 }catch(e){}

						}
					  },location_obj);
					}
				}
			);
        }catch(e){
          console.log(e.message);
          alert(e.message);
        }
      }

      $scope.sign_in=function(){
        if($("#atSignInOutDoor #current_latitude_hidden").val()==''||$("#atSignInOutDoor #current_latitude_hidden").val()=='undefined'){
          return;
        }
        $rootScope.showLoading();
		  try{
				getLocation.checkCanLocation(
					function(result){
						if (result == 1){
							getLocation.location(function(msg){
								//提交
								try{
								  if ($scope.is_require_upload == '0'){
									atSignInOutDoorSev.signInOutDoorSave('submit','',current_latitude,current_longitude,$scope.select_user_id,$scope.select_notify_id,msg.latitude,msg.longitude);
								  }
								  else {
									atSignInOutDoorSev.signInOutDoorSaveWithUpload('submit','',current_latitude,current_longitude,$scope.select_user_id,$scope.select_notify_id,msg.latitude,msg.longitude);
								  }
								}catch(e){}

							});
						}
					}
				);
		  }catch(e){
        $rootScope.hideLoading();
				$ionicPopup.alert(
					{
						title: '提醒',
						template: '<div style="text-align: center;">'+fufu_network_error_msg+'</div>',
						okText: '确定'
					});
		  }

      }

      $scope.sign_change_photos= function () {
        try {
          navigator.camera.getPicture(function(uri) {
			$scope.is_require_upload = '1';
            $('#Sign_photos').attr("src", uri);

          }, function() {
            //alert('cancel or failure');
          }, {
			destinationType: Camera.DestinationType.FILE_URI,
			quality: 10,
			targetHeight: 500,
			targetWidth: 500,
			correctOrientation: true

          });
        } catch (e) {
          //alert(e.message);
        }
      }

      $scope.picklist_sign_in_reason = function(){
        var picklist_key_list = "";
        var picklist_value_list = "";
        var checked_key = $('#sign_in_reason_key').val();
        var checked_value = $('#sign_in_reason').val();
        var picklist_title = '签到原因';
        var return_key_field_id = 'sign_in_reason_key';
        var return_value_field_id = 'sign_in_reason';
        var hidden_fields = 'new_contract_end_date_editable_div';

        /*
         for (var i=0;i<$scope.employeeContractDetailData.p_d.length;i++){
         picklist_key_list = picklist_key_list + $scope.employeeContractDetailData.p_d[i].key;
         picklist_value_list = picklist_value_list + $scope.employeeContractDetailData.p_d[i].name;
         if (i < $scope.employeeContractDetailData.p_d.length - 1){
         picklist_key_list = picklist_key_list + ',';
         picklist_value_list = picklist_value_list + ',';
         }
         }
         */
        picklist_key_list = '拜访客户,会议,发布会,培训,巡查,采购,公务办理,其他';
        picklist_value_list = '拜访客户,会议,发布会,培训,巡查,采购,公务办理,其他';

        $location.path('home_page/home_menulist/picklist_sign_in_reason/' + picklist_key_list + '/' + picklist_value_list + '/' + checked_key + '/' + checked_value + '/' + picklist_title + '/' + return_key_field_id + '/' + return_value_field_id + '/' + hidden_fields);
      }

//////////////选择审批人//////////////
	$scope.dates_line2x = local_resource + 'img/model/dates-line2x.png';
	$scope.dates_line3x = local_resource + 'img/model/dates-line2x.png';
	$scope.add_approver = local_resource + 'img/model/add_approver.png';
    $scope.add_approver_ = local_resource + 'img/model/add_approver_.png';
	$scope.dates_line4x = local_resource + 'img/model/dates-line2x.png';
    $scope.approver_list = [];
    $scope.search_control={};
    $scope.search_control.search_val = '';
    $scope.ess_empl_data = [];
    $scope.select_user_id = '';
    $scope.select_notify_id = '';
    $scope.click_flag = 0;
    $scope.essItemCk = function(user_id,img,en,_flag){
      if(_flag == true){
        $scope.ess_empl_data.num_checked =  $scope.ess_empl_data.num_checked + 1;
      }else{
        $scope.ess_empl_data.num_checked =  $scope.ess_empl_data.num_checked - 1;
      }
      var _d = [];
      if($scope.click_flag == 0){
        $scope.select_user_id = user_id;
        _d = $scope.atSignInOutDoorData.approver_list;
      }else{
        return;
      }
      var flag = 0;
      var _len = _d.length;
      for(var i=0;i<_len;i++){
        if(angular.isDefined(_d[i].flag)&&_d[i].flag==1){
          flag = 1;
          break;
        }
      }
      if(flag == 0){
        _d.push({
          img:img,
          name:en,
          user_id:user_id,
          flag:1
        })
      }else{
        _d[_len-1] = {
          img:img,
          name:en,
          user_id:user_id,
          flag:1
        }
      }
      $scope.search_control.search_val = '';
      $scope.closeModal();
    }

    $scope.delete_notify=function(user_id){
      $('#notify_list_div').addClass('notify_list_active');
      if($scope.select_notify_id.indexOf(',')==-1){
        $scope.select_notify_id=$scope.select_notify_id.replace(user_id,'');
      }
      else if($scope.select_notify_id.indexOf(user_id+',')==-1){
        $scope.select_notify_id=$scope.select_notify_id.replace(','+user_id,'');
      }
      else{
        $scope.select_notify_id=$scope.select_notify_id.replace(user_id+',','');
      }
      for(var i=0;i<$scope.atSignInOutDoorData.notify_list.length;i++){
        if($scope.atSignInOutDoorData.notify_list[i].user_id==user_id){
          $scope.atSignInOutDoorData.notify_list.splice(i,1);
        }
      }
      setTimeout(function(){
        document.getElementById('notify_list_div').style.width=($scope.atSignInOutDoorData.notify_list.length+1)*100+20+'px';
        $ionicScrollDelegate.$getByHandle("notify_list_scroll").resize();
      },350)


    }

    $scope.delete_approver=function(user_id){
      if(!$scope.atSignInOutDoorData.approver_list_flag){
        return;
      }
      $('#approver_list_div').addClass('approver_list_active');
      $scope.atSignInOutDoorData.approver_list=[];
      $scope.select_user_id=''
    }

    $scope.selectList = function(){
      if($scope.click_flag==1){
        var _d = [];
        $scope.select_notify_id = '';
        $scope.atSignInOutDoorData.notify_list = [];
        for(var i=0;i<$scope.ess_empl_data.length;i++){
          if($scope.ess_empl_data[i].ck){
            $scope.select_notify_id = $scope.select_notify_id + ($scope.ess_empl_data)[i].user_id+',';
            $scope.atSignInOutDoorData.notify_list.push({
              img:($scope.ess_empl_data)[i].img,
              name:($scope.ess_empl_data)[i].en,
              user_id:($scope.ess_empl_data)[i].user_id,
              flag:1
            });
          }
        }
        $scope.select_notify_id = ($scope.select_notify_id).substring(0,$scope.select_notify_id.length-1);

        $scope.closeModal();
      }
      document.getElementById('notify_list_div').style.width=($scope.atSignInOutDoorData.notify_list.length+1)*100+20+'px';
      $scope.search_control.search_val = '';
    }

    $ionicModal.fromTemplateUrl('ess-empl-modal.html', {
      scope: $scope,
      animation: 'slide-in-up'
    }).then(function(modal) {
      $scope.modal = modal;
    });


	$scope.openModal = function() {

		var selectEmplList = '';
		if ($scope.atSignInOutDoorData.approver_list.length != 0){
			selectEmplList = $scope.atSignInOutDoorData.approver_list[0].employee_no;
		}

		$emplComponentService.open({
			title : '选择审批人', //弹开窗口标题
			barTitle : window.localStorage["org_top_level"],//导航开头
			isSingleSelect:true,//是否单选
			isShowContact:true,//是否展示常用联系人
			isNeedSaveContact:true,//是否保存常用联系人
			extName : '员工', //多选时提示后缀名
			selectEmplList:selectEmplList, //打开窗口默认选中员工列表
			routerName:'sign',
			sure : function (rd) { //返回数据，数组格式

				$('#approver_list_div').removeClass('approver_list_active');
				$scope.select_user_id = rd[0].user_id;
				$scope.atSignInOutDoorData.approver_list = [];
				$scope.atSignInOutDoorData.approver_list.push({
				  img:rd[0].img_src,
				  name:rd[0].empl_name,
				  user_id:rd[0].user_id,
				  employee_no:rd[0].empl_no,
				  flag:1
				});
				//$scope.approver_list=$scope.atSignInOutDoorData.approver_list;
			}
		});

    }

    $scope.openModal2 = function() {
		var selectEmplList = '';
		if ($scope.atSignInOutDoorData.notify_list.length != 0){
			for (var i=0;i<$scope.atSignInOutDoorData.notify_list.length;i++){
				selectEmplList += $scope.atSignInOutDoorData.notify_list[i].employee_no;
				if (i < $scope.atSignInOutDoorData.notify_list.length - 1){
					selectEmplList += ',';
				}
			}

		}

		$emplComponentService.open({
			title : '选择知会人', //弹开窗口标题
			barTitle : window.localStorage["org_top_level"],//导航开头
			isSingleSelect:false,//是否单选
			isShowContact:true,//是否展示常用联系人
			isNeedSaveContact:true,//是否保存常用联系人
			extName : '员工', //多选时提示后缀名
			selectEmplList:selectEmplList, //打开窗口默认选中员工列表
			routerName:'sign',
			sure : function (rd) { //返回数据，数组格式
				$('#notify_list_div').removeClass('notify_list_active');
				$scope.select_notify_id = '';
				$scope.atSignInOutDoorData.notify_list = [];
				for(var i=0;i<rd.length;i++){

					$scope.select_notify_id = $scope.select_notify_id + rd[i].user_id;
					$scope.atSignInOutDoorData.notify_list.push({
					  img:rd[i].img_src,
					  name:rd[i].empl_name,
					  user_id:rd[i].user_id,
					  employee_no:rd[i].empl_no,
					  flag:1
					});
					if (i < rd.length - 1){
						$scope.select_notify_id += ',';
					}
				}

				document.getElementById('notify_list_div').style.width=($scope.atSignInOutDoorData.notify_list.length+1)*100+20+'px';
				$ionicScrollDelegate.$getByHandle("notify_list_scroll").resize();
			}
		});

    }


/*
    $scope.openModal = function() {
      $('#approver_list_div').removeClass('approver_list_active');
      $scope.search_val = '';
      $scope.click_flag = 0;
      $scope.ess_empl_data = [];
      essLvApplySev.loadEssEmplData($scope.select_user_id,$scope.atSignInOutDoorData.employee_no,'');
      $scope.ess_empl_data = essLvApplySev.getEssEmplData();
      $scope.modal.show();
    };
    $scope.openModal2 = function() {
      $scope.search_val = '';
      $scope.click_flag = 1;
      $scope.ess_empl_data = [];
      essLvApplySev.loadEssEmplData($scope.select_notify_id,$scope.atSignInOutDoorData.employee_no,'');
      $scope.ess_empl_data = essLvApplySev.getEssEmplData();
      $scope.modal.show();
    };
*/
    $scope.closeModal = function() {
      $scope.modal.hide();
      $scope.ess_empl_data = [];
      $scope.search_control.search_val = '';
    };
    $scope.$on('$destroy', function() {
      $scope.modal.remove();
    });
//////////////选择审批人结束//////////////

    })

    .controller('atSignInRemoteCtrl', function ($scope,atSignInRemoteSev,$location,$ionicModal,essLvApplySev,$ionicPopup,$rootScope,$ionicHistory,$ionicScrollDelegate,$emplComponentService) {
      var current_address='';
      var current_latitude='';
      var current_longitude='';
      var location_obj = {'latitude':'','longitude':'','address':'','city':''};
      $scope.field_attendance= local_resource+'img/icon/field_attendance.png';
      $scope.Sign_photos= local_resource+'img/icon/Sign_photos.png';
	  $scope.is_require_upload = '0';
    try{
      document.getElementById('atSignInRemoteCtrlSpinner').style.display='block';
      document.getElementById('atSignInRemoteCtrlSubmit').style.backgroundColor='#eeeeee';
		getLocation.checkCanLocation(
			function(result){
				if (result == 1){
				  getLocation.location(function(msg){
					try{
					  if(typeof(msg.address)=='undefined' || msg.address==""||msg.address==null||msg.address=='(null)'){}
					  else {
              location_obj = {
                'latitude':msg.latitude,
                'longitude':msg.longitude,
                'address':msg.address,
                'city':msg.city
              };

						current_address = msg.address;
						document.getElementById("address_now").innerText = current_address;
						document.getElementById('atSignInRemoteCtrlSpinner').style.display='none';
						document.getElementById('atSignInRemoteCtrlSubmit').style.backgroundColor='#53afff';
						document.getElementById("message_city").value = msg.city;
						current_latitude = msg.latitude;
						current_longitude = msg.longitude;
						$("#atSignInRemote #current_latitude_hidden").val(current_latitude);
						$("#atSignInRemote #current_longitude_hidden").val(current_longitude);

					  }
					}catch(e){}

				  });
				}
        else{
          //$ionicHistory.goBack();
          document.getElementById('atSignInRemoteCtrlSpinner').style.display='none';
        }
			}
		);

    }catch(e){
      console.log(e.message);
    }

		atSignInRemoteSev.clearData();
      atSignInRemoteSev.loadData($scope);
      $scope.atSignInRemoteData = atSignInRemoteSev.getData();
      $scope.getAddress= function ($scope) {
        if(document.getElementById('atSignInRemoteCtrlSpinner').style.display=='block'){
          return;
        }
        try{
			getLocation.checkCanLocation(
				function(result){
					if (result == 1){
					  getLocation.showMap(function(msg){
						if(typeof(msg.address)=='undefined' || msg.address==""||msg.address==null||msg.address=='(null)'){}
						else {
						  try{

                location_obj = {
                  'latitude':msg.latitude,
                  'longitude':msg.longitude,
                  'address':msg.address,
                  'city':msg.detailAddress
                };

							current_address = msg.address;
							document.getElementById("address_now").innerText=current_address;
							document.getElementById("message_city").value = msg.city;
							current_latitude = msg.latitude;
							current_longitude = msg.longitude;
							$("#atSignInRemote #current_latitude_hidden").val(current_latitude);
							$("#atSignInRemote #current_longitude_hidden").val(current_longitude);
						  }catch(e){

						  }
						}
					  },location_obj);
					}
				}
			);
        }catch(e){
          console.log(e.message);
          alert(e.message);
        }
      }

      $scope.sign_in=function(){
        if($("#atSignInRemote #current_latitude_hidden").val()=='undefined'||$("#atSignInRemote #current_latitude_hidden").val()==''){
          return;
        }
        $rootScope.showLoading();
		  try{
			getLocation.checkCanLocation(
				function(result){
					if (result == 1){
						getLocation.location(function(msg){
							//提交
							try{
							  if ($scope.is_require_upload == '0'){
								atSignInRemoteSev.signInOutDoorSave('submit','',current_latitude,current_longitude,$scope.select_user_id,$scope.select_notify_id,msg.latitude,msg.longitude);
							  }
							  else {
								atSignInRemoteSev.signInOutDoorSaveWithUpload('submit','',current_latitude,current_longitude,$scope.select_user_id,$scope.select_notify_id,msg.latitude,msg.longitude);
							  }
							}catch(e){

							}
						});
					}
				}
			);
		  }catch(e){
        $rootScope.hideLoading();
				$ionicPopup.alert(
					{
						title: '提醒',
						template: '<div style="text-align: center;">'+fufu_network_error_msg+'</div>',
						okText: '确定'
					});
		  }

      }

      $scope.sign_change_photos= function () {
        try {
          navigator.camera.getPicture(function(uri) {
			$scope.is_require_upload = '1';
            $('#Sign_photos').attr("src", uri);

          }, function() {
            //alert('cancel or failure');
          }, {
            quality: 10,
            //allowEdit: true,
            destinationType: Camera.DestinationType.FILE_URI
          });
        } catch (e) {
          //alert(e.message);
        }
        // For example's sake, hide the sheet after two seconds

      }

      $scope.picklist_sign_in_reason = function(){
        var picklist_key_list = "";
        var picklist_value_list = "";
        var checked_key = $('#sign_in_reason_key').val();
        var checked_value = $('#sign_in_reason').html();
        var picklist_title = '签到原因';
        var return_key_field_id = 'sign_in_reason_key';
        var return_value_field_id = 'sign_in_reason';
        var hidden_fields = 'new_contract_end_date_editable_div';

        /*
         for (var i=0;i<$scope.employeeContractDetailData.p_d.length;i++){
         picklist_key_list = picklist_key_list + $scope.employeeContractDetailData.p_d[i].key;
         picklist_value_list = picklist_value_list + $scope.employeeContractDetailData.p_d[i].name;
         if (i < $scope.employeeContractDetailData.p_d.length - 1){
         picklist_key_list = picklist_key_list + ',';
         picklist_value_list = picklist_value_list + ',';
         }
         }
         */
        picklist_key_list = '拜访客户,会议,发布会,培训,巡查,采购,公务办理,其他';
        picklist_value_list = '拜访客户,会议,发布会,培训,巡查,采购,公务办理,其他';

        $location.path('home_page/home_menulist/picklist_sign_in_reason/' + picklist_key_list + '/' + picklist_value_list + '/' + checked_key + '/' + checked_value + '/' + picklist_title + '/' + return_key_field_id + '/' + return_value_field_id + '/' + hidden_fields);
      }


//////////////选择审批人//////////////
    $scope.dates_line2x = local_resource + 'img/model/dates-line2x.png';
    $scope.dates_line3x = local_resource + 'img/model/dates-line2x.png';
    $scope.add_approver = local_resource + 'img/model/add_approver.png';
    $scope.add_approver_ = local_resource + 'img/model/add_approver_.png';
    $scope.dates_line4x = local_resource + 'img/model/dates-line2x.png';
    $scope.approver_list = [];
    $scope.search_control={};
    $scope.search_control.search_val = '';
    $scope.ess_empl_data = [];
    $scope.select_user_id = '';
    $scope.select_notify_id = '';
    $scope.click_flag = 0;
    $scope.essItemCk = function(user_id,img,en,_flag){
      if(_flag == true){
        $scope.ess_empl_data.num_checked =  $scope.ess_empl_data.num_checked + 1;
      }else{
        $scope.ess_empl_data.num_checked =  $scope.ess_empl_data.num_checked - 1;
      }
      var _d = [];
      if($scope.click_flag == 0){
        $scope.select_user_id = user_id;
        _d = $scope.atSignInRemoteData.approver_list;
      }else{
        return;
      }
      var flag = 0;
      var _len = _d.length;
      for(var i=0;i<_len;i++){
        if(angular.isDefined(_d[i].flag)&&_d[i].flag==1){
          flag = 1;
          break;
        }
      }
      if(flag == 0){
        _d.push({
          img:img,
          name:en,
          user_id:user_id,
          flag:1
        })
      }else{
        _d[_len-1] = {
          img:img,
          name:en,
          user_id:user_id,
          flag:1
        }
      }
      $scope.search_control.search_val = '';
      $scope.closeModal();
    }
    $scope.delete_approver=function(user_id){
      if(!$scope.atSignInRemoteData.approver_list_flag){
        return;
      }
      $('#approver_list_div').addClass('approver_list_active');
      $scope.atSignInRemoteData.approver_list=[];
      $scope.select_user_id=''
    }
    $scope.selectList = function(){
      if($scope.click_flag==1){
        var _d = [];
        $scope.select_notify_id = '';
        $scope.atSignInRemoteData.notify_list = [];
        for(var i=0;i<$scope.ess_empl_data.length;i++){
          if($scope.ess_empl_data[i].ck){
            $scope.select_notify_id = $scope.select_notify_id + ($scope.ess_empl_data)[i].user_id+',';
            $scope.atSignInRemoteData.notify_list.push({
              img:($scope.ess_empl_data)[i].img,
              name:($scope.ess_empl_data)[i].en,
              user_id:($scope.ess_empl_data)[i].user_id,
              flag:1
            });
          }
        }
        $scope.select_notify_id = ($scope.select_notify_id).substring(0,$scope.select_notify_id.length-1);
        $scope.closeModal();
      }
      document.getElementById('notify_list_div').style.width=($scope.atSignInRemoteData.notify_list.length+1)*100+20+'px';
      $scope.search_control.search_val = '';
    }

    $ionicModal.fromTemplateUrl('ess-empl-modal.html', {
      scope: $scope,
      animation: 'slide-in-up'
    }).then(function(modal) {
      $scope.modal = modal;
    });


	$scope.openModal = function() {

		var selectEmplList = '';
		if ($scope.atSignInRemoteData.approver_list.length != 0){
			selectEmplList = $scope.atSignInRemoteData.approver_list[0].employee_no;
		}

		$emplComponentService.open({
			title : '选择审批人', //弹开窗口标题
			barTitle : window.localStorage["org_top_level"],//导航开头
			isSingleSelect:true,//是否单选
			isShowContact:true,//是否展示常用联系人
			isNeedSaveContact:true,//是否保存常用联系人
			extName : '员工', //多选时提示后缀名
			selectEmplList:selectEmplList, //打开窗口默认选中员工列表
			routerName:'sign',
			sure : function (rd) { //返回数据，数组格式

				$('#approver_list_div').removeClass('approver_list_active');
				$scope.select_user_id = rd[0].user_id;
				$scope.atSignInRemoteData.approver_list = [];
				$scope.atSignInRemoteData.approver_list.push({
				  img:rd[0].img_src,
				  name:rd[0].empl_name,
				  user_id:rd[0].user_id,
				  employee_no:rd[0].empl_no,
				  flag:1
				});
				//$scope.approver_list=$scope.atSignInRemoteData.approver_list;
			}
		});

    }

    $scope.openModal2 = function() {
		var selectEmplList = '';
		if ($scope.atSignInRemoteData.notify_list.length != 0){
			for (var i=0;i<$scope.atSignInRemoteData.notify_list.length;i++){
				selectEmplList += $scope.atSignInRemoteData.notify_list[i].employee_no;
				if (i < $scope.atSignInRemoteData.notify_list.length - 1){
					selectEmplList += ',';
				}
			}

		}

		$emplComponentService.open({
			title : '选择知会人', //弹开窗口标题
			barTitle : window.localStorage["org_top_level"],//导航开头
			isSingleSelect:false,//是否单选
			isShowContact:true,//是否展示常用联系人
			isNeedSaveContact:true,//是否保存常用联系人
			extName : '员工', //多选时提示后缀名
			selectEmplList:selectEmplList, //打开窗口默认选中员工列表
			routerName:'sign',
			sure : function (rd) { //返回数据，数组格式
				$('#notify_list_div').removeClass('notify_list_active');
				$scope.select_notify_id = '';
				$scope.atSignInRemoteData.notify_list = [];
				for(var i=0;i<rd.length;i++){

					$scope.select_notify_id = $scope.select_notify_id + rd[i].user_id;
					$scope.atSignInRemoteData.notify_list.push({
					  img:rd[i].img_src,
					  name:rd[i].empl_name,
					  user_id:rd[i].user_id,
					  employee_no:rd[i].empl_no,
					  flag:1
					});
					if (i < rd.length - 1){
						$scope.select_notify_id += ',';
					}
				}

				document.getElementById('notify_list_div').style.width=($scope.atSignInRemoteData.notify_list.length+1)*100+20+'px';
				$ionicScrollDelegate.$getByHandle("notify_list_scroll").resize();
			}
		});

    }
/*
    $scope.openModal = function() {
      $('#approver_list_div').removeClass('approver_list_active');
      $scope.search_val = '';
      $scope.click_flag = 0;
      $scope.ess_empl_data = [];
      essLvApplySev.loadEssEmplData($scope.select_user_id,$scope.atSignInRemoteData.employee_no,'');
      $scope.ess_empl_data = essLvApplySev.getEssEmplData();
      $scope.modal.show();
    };
    $scope.openModal2 = function() {
		$('#atSignInRemote #notify_list_div').removeClass('notify_list_active');
      $scope.search_val = '';
      $scope.click_flag = 1;
      $scope.ess_empl_data = [];
      essLvApplySev.loadEssEmplData($scope.select_notify_id,$scope.atSignInRemoteData.employee_no,'');
      $scope.ess_empl_data = essLvApplySev.getEssEmplData();
      $scope.modal.show();
    };
*/
    $scope.closeModal = function() {
      $scope.modal.hide();
      $scope.ess_empl_data = [];
      $scope.search_control.search_val = '';
    };
    $scope.$on('$destroy', function() {
      $scope.modal.remove();
    });
//////////////选择审批人结束//////////////

    $scope.delete_notify=function(user_id){
      $('#atSignInRemote #notify_list_div').addClass('notify_list_active');
      if($scope.select_notify_id.indexOf(',')==-1){
        $scope.select_notify_id=$scope.select_notify_id.replace(user_id,'');
      }
      else if($scope.select_notify_id.indexOf(user_id+',')==-1){
        $scope.select_notify_id=$scope.select_notify_id.replace(','+user_id,'');
      }
      else{
        $scope.select_notify_id=$scope.select_notify_id.replace(user_id+',','');
      }
      for(var i=0;i<$scope.atSignInRemoteData.notify_list.length;i++){
        if($scope.atSignInRemoteData.notify_list[i].user_id==user_id){
          $scope.atSignInRemoteData.notify_list.splice(i,1);
        }
      }
      setTimeout(function(){
        document.getElementById('notify_list_div').style.width=($scope.atSignInRemoteData.notify_list.length+1)*100+20+'px';
        $ionicScrollDelegate.$getByHandle("notify_list_scroll").resize();
      },350)


    }
    })
.controller('userImportResultCtrl',function($scope,userImportResultSev,$stateParams,$ionicHistory){
    $scope.img_import_information_icon = local_resource + 'img/icon/import_information_icon.png';
	userImportResultSev.clearData();
    userImportResultSev.loadData($stateParams.operate_date);
    $scope.userImportResultData = userImportResultSev.getData();
	$scope.import_success_return = function(){
      $ionicHistory.goBack();
	}

  })

    .controller('atMbIndoorSettingCtrl',function(atMbIndoorSettingSev,$scope,$stateParams,$location){
		atMbIndoorSettingSev.clearData();
      atMbIndoorSettingSev.loadData();
      $scope.atMbIndoorSettingData = atMbIndoorSettingSev.getData();
      $scope.at_mb_indoor_setting_edit= function (id,name) {
        $location.path('home_page/home_menulist/at_mb_indoor_setting_detail/'+id+'/'+name);
      }

    })

    .controller('atMbIndoorSettingDetailCtrl',function($scope,$location,$timeout,$stateParams,atMbIndoorSettingDetailSev,$ionicPopup,$ionicScrollDelegate){
		atMbIndoorSettingDetailSev.clearData();
      atMbIndoorSettingDetailSev.loadData($stateParams.shift_group_id,local_resource);
      $scope.atMbIndoorSettingDetailData = atMbIndoorSettingDetailSev.getData();
    $scope.at_mb_indoor_setting_detail_title=$stateParams.shift_group_name;
	$scope.img_edit = local_resource+'img/icon/small_icon_edit.png';
	$scope.img_delete = local_resource+'img/icon/small_icon_delete.png';
	$scope.indoor_setting_detail_edit=function(id){

		$location.path("home_page/home_menulist/at_mb_indoor_setting_detail_edit/"+setting_detail_id);
	}

	$scope.reload_data = function(shift_group_id,local_resource){
		atMbIndoorSettingDetailSev.loadData(shift_group_id,local_resource);
	}

    $scope.details_click=function(){
     /* document.getElementById('details_div').style.color='white';
      document.getElementById('details_div').style.backgroundColor='#53afff';
      document.getElementById('details_div').style.border='none';
      document.getElementById('statistics_div').style.color='black';
      document.getElementById('statistics_div').style.backgroundColor='white';
      document.getElementById('statistics_div').style.border='1px solid #eeeeee';
        document.getElementById('statistics_div').style.borderLeft='none';
      document.getElementById('indoor_setting_wrap_left').style.display="block";
      document.getElementById('indoor_setting_wrap_right').style.display="none";
	  */

      document.getElementById('details_div').style.color='#53afff';
      document.getElementById('statistics_div').style.color='#808080';
	  document.getElementById('details_div').style.borderBottom='none';
	  document.getElementById('statistics_div').style.borderBottom='1px solid #f5f5f5';
      document.getElementById('indoor_setting_animate_div').style.webkitTransform='translateX(0)';
      document.getElementById('indoor_setting_wrap').style.webkitTransform='translateX(0)';
      document.getElementById('indoor_setting_wrap').style.overflow="visible";
      document.getElementById('indoor_setting_wrap_left').setAttribute("style","width:50%;padding-top:11px;");
      document.getElementById('indoor_setting_wrap_right').setAttribute("style","width: 50%;position: absolute;left:50%;top:0px;");
        $timeout(function(){ $ionicScrollDelegate.resize();
          document.getElementById('indoor_setting_wrap').style.overflow="hidden";
        }, 200);


    }
    $scope.statistics_click=function(){
      /*document.getElementById('indoor_setting_wrap_left').style.display="none";
      document.getElementById('indoor_setting_wrap_right').style.display="block";
      document.getElementById('statistics_div').style.border='none'
      document.getElementById('details_div').style.color='black';
      document.getElementById('details_div').style.backgroundColor='white';
      document.getElementById('details_div').style.border='1px solid #eeeeee';
      document.getElementById('details_div').style.borderRight='none';
      document.getElementById('statistics_div').style.color='white';
      document.getElementById('statistics_div').style.backgroundColor='#53afff';
	  */





      document.getElementById('details_div').style.color='#808080';
      document.getElementById('statistics_div').style.color='#53afff';
	  document.getElementById('statistics_div').style.borderBottom='none';
	  document.getElementById('details_div').style.borderBottom='1px solid #f5f5f5';
      document.getElementById('indoor_setting_animate_div').style.webkitTransform='translateX(100%)';
      document.getElementById('indoor_setting_wrap').style.webkitTransform='translateX(-50%)';
      document.getElementById('indoor_setting_wrap').style.overflow="visible";
      document.getElementById('indoor_setting_wrap_left').setAttribute("style","width:50%;position: absolute;left:0px;top:0px;padding-top:11px;");
      document.getElementById('indoor_setting_wrap_right').setAttribute("style","width: 50%;float: right");
        $timeout(function(){ $ionicScrollDelegate.resize();
          document.getElementById('indoor_setting_wrap').style.overflow="hidden";
        }, 200);
    }



	$scope.at_mb_indoor_setting_detail_checkbox= function () {

		if(document.getElementById("at_mb_indoor_setting_detail_checkbox").checked){
		  //document.getElementById("is_active_content").style.display="block";
		  $scope.atMbIndoorSettingDetailData.i_a='1';
		}
		else{
		  //document.getElementById("is_active_content").style.display="none";
		  $scope.atMbIndoorSettingDetailData.i_a='0';
		}

		/*
        $timeout(function(){ $ionicScrollDelegate.resize();
        }, 100);
		*/

		/*
		if ($scope.atMbIndoorSettingDetailData.i_a == $scope.atMbIndoorSettingDetailData.default_i_a){
			document.getElementById("at_mb_indoor_setting_detail_normal_save_div").style.display="none";
		}
		else {
			document.getElementById("at_mb_indoor_setting_detail_normal_save_div").style.display="block";
		}
		*/




	}

    $scope.is_active=function(){
      if(document.getElementById("is_active").checked){
        $scope.atMbIndoorSettingDetailData.i_a_o='1';
        document.getElementById("is_active_content_right").style.display='block';
      }
      else{
        $scope.atMbIndoorSettingDetailData.i_a_o='0';
        document.getElementById("is_active_content_right").style.display='none';
      }
    }
    $scope.is_use_work_flow=function(){
      if(document.getElementById("is_use_work_flow").checked){
        $scope.atMbIndoorSettingDetailData.i_wf='1';
      }
      else{
        $scope.atMbIndoorSettingDetailData.i_wf='0';
      }
    }
    $scope.is_need_photo=function(){
      if(document.getElementById("is_need_photo").checked){
        $scope.atMbIndoorSettingDetailData.i_p='1';
      }
      else{
        $scope.atMbIndoorSettingDetailData.i_p='0';
      }
    }
    $scope.is_sent_location=function(){
      if(document.getElementById("is_sent_location").checked){
        $scope.atMbIndoorSettingDetailData.i_l='1';
      }
      else{
        $scope.atMbIndoorSettingDetailData.i_l='0';
      }
    }

	$scope.at_mb_indoor_setting_detail_normal_save=function(){

        atMbIndoorSettingDetailSev.at_mb_indoor_setting_detail_normal_save($stateParams.shift_group_id,$scope);
	}

	$scope.at_mb_indoor_setting_detail_outdoor_save=function(){

        atMbIndoorSettingDetailSev.at_mb_indoor_setting_detail_outdoor_save($stateParams.shift_group_id);
	}

	$scope.at_mb_indoor_setting_detail_edit = function(setting_detail_id,form_title){

		$location.path('home_page/home_menulist/at_mb_indoor_setting_detail_edit/' + setting_detail_id + '/' + form_title + '/' + $stateParams.shift_group_id);
	}

	$scope.at_mb_indoor_setting_detail_delete = function(setting_detail_id,detail_str){
		$ionicPopup.confirm({
			template: '<div style="text-align: center;">确认删除' + detail_str + '?</div>',
			cancelType:'button-dark',
			cancelText: '取消',
			okText: '确认'
			}) .then(function(res) {
			if(res) {
				atMbIndoorSettingDetailSev.at_mb_indoor_setting_detail_location_delete(setting_detail_id,$scope,$stateParams.shift_group_id,local_resource);
			}
		});



	}

    })


	.controller('atMbIndoorSettingDetailEditCtrl',function($scope,$location,$timeout,$stateParams,atMbIndoorSettingDetailSev,$ionicPopup,$ionicScrollDelegate){

	atMbIndoorSettingDetailSev.loadLocationData($stateParams.setting_detail_id);
	$scope.atMbIndoorSettingDetailData = atMbIndoorSettingDetailSev.getLocationData();

	$scope.at_mb_indoor_setting_detail_title = $stateParams.form_title;
	try {
		getLocation.checkCanLocation(
			function(result){

			}
		);
	} catch (e) {
		console.log(e.message);
	}

      try{
        network.wifiInfo(function(msg){

          try{
            if(msg.state=='-1'&&ionic.Platform.isIOS()){
              $ionicPopup.alert(
                {
                  title: '提醒',
                  template: '<div style="text-align: center;">无法获取当前WiFi,请启动WIFI重试</div>',
                  okText: '确定'
                });
              return;
            }
            var wifi_arr1=msg.wifiName.replace(/(.)(?=[^$])/g,"$1,").split(",");
            var wifi_str="";
            for(var v=0;v<wifi_arr1.length;v++){
              if(wifi_arr1[v]!='"'){
                wifi_str=wifi_str+wifi_arr1[v];
              }
            }
            document.getElementById("wifi_name").innerHTML= wifi_str;
            document.getElementById("at_mb_indoor_setting_wifi_mac").value= msg.mac;
          }catch(e){}
        })
      }
      catch(e){
        console.log(e.message);
      }

      $scope.at_mb_indoor_setting_detail_location_save=function(){
        if(document.getElementById("atMbIndoorSettingDetailCtrlSpinner").style.display=='block'){
          return;
        }
        var valid_mode ="";
        if(document.getElementById("w_f_content").style.display=="block"&&document.getElementById("loc_content").style.display=="block"){
          valid_mode="1,2"
        }
        else if(document.getElementById("w_f_content").style.display=="block"){
          valid_mode="1"
        }
        else if(document.getElementById("loc_content").style.display=="block"){
          valid_mode="2";
        }
        else{
          valid_mode="";
        }
        atMbIndoorSettingDetailSev.atMbIndoorSettingDetailLocationSave($stateParams.shift_group_id,valid_mode,$stateParams.setting_detail_id);
      }
	  $scope.use_current_wifi = function(){
      if (document.getElementById("wifi_name").innerHTML != '') {
        $ionicPopup.alert({
          title: '提醒',
          template: '<div style="text-align: center;">已取到当前WiFi</div>',
          okText: '确定'
        }).then(function (res) {
          document.getElementById("wifi_name_submit").innerHTML = document.getElementById("wifi_name").innerHTML;
          document.getElementById("at_mb_indoor_setting_wifi_mac_submit").value = document.getElementById("at_mb_indoor_setting_wifi_mac").value;
        });
      }
      else {
        $ionicPopup.alert({
          title: '提醒',
          template: '<div style="text-align: center;">不能获取当前WiFi,请检查WiFi是否已经连上然后再重试.</div>',
          okText: '确定'
        }).then(function (res) {

        });
      }

		}


      $scope.indoor_setting_img_1=function(){
        var res=$scope.atMbIndoorSettingDetailData.v_m[0].ch;
        res=!res;
        $scope.atMbIndoorSettingDetailData.v_m[0].ch=res;
        if(res){
          document.getElementById("indoor_setting_img_1").src=local_resource +'img/icon/selected.png';
          document.getElementById("w_f_content").style.display="block";
          try{
            network.wifiInfo(function(msg){

              try{
                if(msg.state=='-1'&&ionic.Platform.isIOS()){
                  $ionicPopup.alert(
                    {
                      title: '提醒',
                      template: '<div style="text-align: center;">无法获取当前WiFi,请启动WIFI重试</div>',
                      okText: '确定'
                    });
                  return;
                }
                var wifi_arr1=msg.wifiName.replace(/(.)(?=[^$])/g,"$1,").split(",");
                var wifi_str="";
                for(var v=0;v<wifi_arr1.length;v++){
                  if(wifi_arr1[v]!='"'){
                    wifi_str=wifi_str+wifi_arr1[v];
                  }
                }

                document.getElementById("wifi_name").innerHTML= wifi_str;
                document.getElementById("at_mb_indoor_setting_wifi_mac").value= msg.mac;
              }catch(e){}
            });
          }
          catch(e){
            document.getElementById("indoor_setting_img_1").src=local_resource +'img/icon/noselect.png';
            document.getElementById("w_f_content").style.display="none";
            console.log(e.message);
          }
        }
        else{
          document.getElementById("indoor_setting_img_1").src=local_resource +'img/icon/noselect.png';
          document.getElementById("w_f_content").style.display="none";
        }
      }
      $scope.indoor_setting_img_2=function(){
        var res=$scope.atMbIndoorSettingDetailData.v_m[1].ch;
        res=!res;
        $scope.atMbIndoorSettingDetailData.v_m[1].ch=res;
        if(res) {
          document.getElementById("indoor_setting_img_2").src = local_resource + 'img/icon/selected.png';
          document.getElementById("loc_content").style.display = "block";
          if (document.getElementById('sign_in_location').innerHTML == '') {


            try {
              document.getElementById("atMbIndoorSettingDetailCtrlSpinner").style.display = 'block';
              document.getElementById("at_mb_indoor_setting_detail_save").style.backgroundColor='#eeeeee';

				getLocation.checkCanLocation(
					function(result){
						if (result == 1){
							  getLocation.location(function (msg) {
								try {
								  document.getElementById("sign_in_location").innerHTML = msg.address;
								  document.getElementById("atMbIndoorSettingDetailCtrlSpinner").style.display = 'none';
								  document.getElementById("at_mb_indoor_setting_detail_save").style.backgroundColor='#53afff';

								  $("#at_mb_indoor_setting_latitude").val(msg.latitude);
								  $("#at_mb_indoor_setting_longitude").val(msg.longitude);
								} catch (e) {

								}
							  });
						}
					}
				);
            } catch (e) {
              console.log(e.message);
              document.getElementById("indoor_setting_img_2").src = local_resource + 'img/icon/noselect.png';
              document.getElementById("loc_content").style.display = "none";
            }
          }
        }


        else{
          document.getElementById("indoor_setting_img_2").src=local_resource +'img/icon/noselect.png';
          document.getElementById("loc_content").style.display="none";
        }
      }



      $scope.searchMap=function(){
        if(document.getElementById("atMbIndoorSettingDetailCtrlSpinner").style.display=='block'){
          return;
        }

		getLocation.checkCanLocation(
			function(result){
				if (result == 1){
					getLocation.searchMap({latitude:$scope.atMbIndoorSettingDetailData.lat,longitude:$scope.atMbIndoorSettingDetailData.lon,anotherName:$scope.atMbIndoorSettingDetailData.loc},function(msg){
					  try{
						if (msg.latitude != ''){
						  document.getElementById("sign_in_location").innerHTML=msg.anotherName;
						  $("#at_mb_indoor_setting_latitude").val(msg.latitude);
						  $("#at_mb_indoor_setting_longitude").val(msg.longitude);
						  $scope.atMbIndoorSettingDetailData.lat=msg.latitude;
						  $scope.atMbIndoorSettingDetailData.lon=msg.longitude;
						  $scope.atMbIndoorSettingDetailData.loc=msg.anotherName;
						}
					  }catch(e){}
					  //alert(msg.latitude);
					  //alert(msg.longitude);
					  //alert(msg.address);
					});
				}
			}
		);


      }

	})

    .controller('atMbOutdoorSettingCtrl',function($scope,$stateParams,atMbOutdoorSettingSev,$timeout,$ionicScrollDelegate){
    atMbOutdoorSettingSev.clearData();
      atMbOutdoorSettingSev.loadData($stateParams.shift_group_id);
      $scope.atMbOutdoorSettingData = atMbOutdoorSettingSev.getData();

      $scope.at_mb_outdoor_setting_save=function(){
		//console.log($scope.atMbOutdoorSettingData.with_bill_location_deviation)
        atMbOutdoorSettingSev.atMbOutdoorSettingSave()
      }
      $scope.is_active=function(){
        if(document.getElementById("is_active").checked){
          $scope.atMbOutdoorSettingData.i_a='1';
          document.getElementById("is_active_content").style.display='block';
        }
        else{
          $scope.atMbOutdoorSettingData.i_a='0';
          document.getElementById("is_active_content").style.display='none';
        }
      }
      $scope.is_use_work_flow=function(){
        if(document.getElementById("is_use_work_flow").checked){
          $scope.atMbOutdoorSettingData.i_wf='1';
        }
        else{
          $scope.atMbOutdoorSettingData.i_wf='0';
        }
      }
    $scope.is_use_work_flow_left=function(){
      if(document.getElementById("is_use_work_flow_left").checked){
        $scope.atMbOutdoorSettingData.i_wf_b='1';
      }
      else{
        $scope.atMbOutdoorSettingData.i_wf_b='0';
      }
    }
      $scope.is_need_photo=function(){
        if(document.getElementById("is_need_photo").checked){
          $scope.atMbOutdoorSettingData.i_p='1';
        }
        else{
          $scope.atMbOutdoorSettingData.i_p='0';
        }
      }
      $scope.is_sent_location=function(){
        if(document.getElementById("is_sent_location").checked){
          $scope.atMbOutdoorSettingData.i_l='1';
        }
        else{
          $scope.atMbOutdoorSettingData.i_l='0';
        }
      }
      $scope.is_use_bill_location=function(){
        if(document.getElementById("is_use_bill_location").checked){
          $scope.atMbOutdoorSettingData.is_use_bill_location='1';
		  document.getElementById("is_use_bill_location_div").style.display='block';
        }
        else{
          $scope.atMbOutdoorSettingData.is_use_bill_location='0';
		  document.getElementById("is_use_bill_location_div").style.display='none';
        }
      }

    $scope.details_click=function(){
      /*document.getElementById('details_div').style.color='white';
      document.getElementById('details_div').style.backgroundColor='#53afff';
      document.getElementById('details_div').style.border='none';
      document.getElementById('statistics_div').style.color='black';
      document.getElementById('statistics_div').style.backgroundColor='white';
      document.getElementById('statistics_div').style.border='1px solid #eeeeee';
      document.getElementById('statistics_div').style.borderLeft='none';
      document.getElementById('outdoor_setting_wrap_left').style.display="block";
      document.getElementById('outdoor_setting_wrap_right').style.display="none";
	  */

      document.getElementById('details_div').style.color='#53afff';
      document.getElementById('statistics_div').style.color='#808080';
	  document.getElementById('details_div').style.borderBottom='none';
	  document.getElementById('statistics_div').style.borderBottom='1px solid #f5f5f5';
      document.getElementById('outdoor_setting_animate_div').style.webkitTransform='translateX(0)';
      document.getElementById('outdoor_setting_wrap').style.webkitTransform='translateX(0)';
      document.getElementById('outdoor_setting_wrap').style.overflow="visible";
      document.getElementById('outdoor_setting_wrap_left').setAttribute("style","width:50%;padding-top:10px;");
      document.getElementById('outdoor_setting_wrap_right').setAttribute("style","width: 50%;position: absolute;left:50%;top:0px;padding-top:10px;");
        $timeout(function(){ $ionicScrollDelegate.resize();
          document.getElementById('outdoor_setting_wrap').style.overflow="hidden";
        }, 200);
    }
    $scope.statistics_click=function(){
      /*document.getElementById('outdoor_setting_wrap_left').style.display="none";
      document.getElementById('outdoor_setting_wrap_right').style.display="block";
      document.getElementById('statistics_div').style.border='none'
      document.getElementById('details_div').style.color='black';
      document.getElementById('details_div').style.backgroundColor='white';
      document.getElementById('details_div').style.border='1px solid #eeeeee';
      document.getElementById('details_div').style.borderRight='none';
      document.getElementById('statistics_div').style.color='white';
      document.getElementById('statistics_div').style.backgroundColor='#53afff';
	  */

      document.getElementById('details_div').style.color='#808080';
      document.getElementById('statistics_div').style.color='#53afff';
	  document.getElementById('statistics_div').style.borderBottom='none';
	  document.getElementById('details_div').style.borderBottom='1px solid #f5f5f5';
      document.getElementById('outdoor_setting_animate_div').style.webkitTransform='translateX(100%)';
      document.getElementById('outdoor_setting_wrap').style.webkitTransform='translateX(-50%)';
      document.getElementById('outdoor_setting_wrap').style.overflow="visible";
      document.getElementById('outdoor_setting_wrap_left').setAttribute("style","width:50%;position: absolute;left:0px;top:0px;padding-top:10px;");
      document.getElementById('outdoor_setting_wrap_right').setAttribute("style","width: 50%;float: right;padding-top:10px;");
        $timeout(function(){ $ionicScrollDelegate.resize();
          document.getElementById('outdoor_setting_wrap').style.overflow="hidden";
        }, 200);
    }

    })

  .controller('picklistMinUnitCtrl',function($scope,lvCodeSettingDetailSev,$stateParams,$location,$ionicPopup,$ionicHistory){
	$scope.picklist_key_list = $stateParams.picklist_key_list.split(',');
	$scope.picklist_value_list = $stateParams.picklist_value_list.split(',');
	$scope.picklist_title = $stateParams.picklist_title;
	$scope.checked_key = $stateParams.checked_key;
	$scope.checked_value = $stateParams.checked_value;
	$scope.picklist_submit = function (){
		if (typeof (document.getElementById($stateParams.return_key_field_id).value) != 'undefined'){
			$('#' + $stateParams.return_key_field_id).val($scope.checked_key);
		}
		else {
			$('#' + $stateParams.return_key_field_id).html($scope.checked_key);
		}


		if (typeof (document.getElementById($stateParams.return_value_field_id).value) != 'undefined'){
			$('#' + $stateParams.return_value_field_id).val($scope.checked_value);
		}
		else {
			$('#' + $stateParams.return_value_field_id).html($scope.checked_value);
		}

		lvCodeSettingDetailSev.setMinUnit($scope.checked_value);
		$ionicHistory.goBack();
	}

	$scope.item_clicked = function (checked_key,checked_value){
		document.getElementById('picklist_item_' + $scope.checked_key).style.display = "none";
		$scope.checked_key = checked_key;
		$scope.checked_value = checked_value;
		document.getElementById('picklist_item_' + $scope.checked_key).style.display = "block";

    $scope.picklist_submit();
	}

  })

  .controller('atTeamRecordCtrl',function($scope,$rootScope,atTeamRecordSev,$stateParams,$location,$ionicPopup,$ionicHistory,$ionicScrollDelegate,timeSelect,$timeout,$deptComponentSer){




	$scope.img_team_attendance_iocation = local_resource+'img/icon/team_attendance_iocation.png';
	$scope.img_team_attendance_wifi = local_resource+'img/icon/team_attendance_wifi.png';

	$scope.img_circle3 = local_resource+'img/icon/circle3.png';
	$scope.img_circle4 = local_resource+'img/icon/circle4.png';
	$scope.img_circle5 = local_resource+'img/icon/circle5.png';
	$scope.img_circle6 = local_resource+'img/icon/circle6.png';
	$scope.not_data=local_resource + "img/not_data.png";
	$scope.cry=local_resource + "img/cry.png";
	$scope.img_circle_arrow_down = local_resource+'img/icon/circle_arrow_down.png';
	$scope.img_circle_arrow_up = local_resource+'img/icon/circle_arrow_up.png';
	$scope.img_team_attendance_fingerprint = local_resource+'img/icon/team_attendance_fingerprint.png';
	$scope.img_normal_sign_in = local_resource+'img/icon/sign_in_normal.png';
	$scope.img_fieldwork_sign_in = local_resource+'img/icon/sign_in_fieldwork.png';
	$scope.img_other_sign_in = local_resource+'img/icon/sign_in_other_types.png';
	$scope.img_at_team_record_icon = local_resource+'img/icon/at_team_record_icon.png';
	$scope.img_contract_management_directory1 = local_resource+'img/icon/contract_management_directory1.png';
	$scope.search_img = local_resource+'img/search_img.png';


	$scope.at_team_record_content=function(name,employee_no){
		$location.path('home_page/home_menulist/at_team_record_content/'+$scope.current_date_str+"/"+name+"/"+employee_no);
	}
	if(window.localStorage['_role_name']=='ess'){
		$scope.is_show_picklist = false;
	} else {
		$scope.is_show_picklist = true;
	}

	var today_date = new Date();
	var current_date = new Date();
	var today_date_str = (today_date.getFullYear() + '-' + (today_date.getMonth() + 1 < 10 ? '0' + (today_date.getMonth() + 1): (today_date.getMonth() + 1)) + '-' + (today_date.getDate() < 10 ? '0' + (today_date.getDate()): (today_date.getDate())));

	$scope.current_date_str = '';
	current_date.setFullYear(today_date_str.split('-')[0],(parseInt(today_date_str.split('-')[1],10)-1),today_date_str.split('-')[2]);
    $scope.current_date_str = (current_date.getFullYear() + '-' + (current_date.getMonth() + 1 < 10 ? '0' + (current_date.getMonth() + 1): (current_date.getMonth() + 1)) + '-' + (current_date.getDate() < 10 ? '0' + (current_date.getDate()): (current_date.getDate())));
	$scope.current_date_text= $scope.current_date_str.split("-")[0]+'年'+$scope.current_date_str.split("-")[1]+'月'+$scope.current_date_str.split("-")[2]+'日';
	$scope.today_date_text= $scope.current_date_str.split("-")[0]+'年'+$scope.current_date_str.split("-")[1]+'月'+$scope.current_date_str.split("-")[2]+'日';
	$scope.current_tab = '1';
	$scope.dept_id = '0';

		if (ionic.Platform.isIOS()) {
		  $scope.content_top='104';

		} else {
		  $scope.content_top='84';

		}


	$scope.isSelectDeptBack = false;
	$scope.selectDeptRd = [];


	/*$scope.$on("$ionicView.afterEnter", function(event, data){
		if($scope.isSelectDeptBack){
			$scope.isSelectDeptBack = false;

			if ($scope.selectDeptRd.length == 0){
					document.getElementById('at_team_record_dept_picklist').innerHTML = '请选择部门';
					$scope.dept_id = '0';
				}
				else if ($scope.selectDeptRd.length == 1){
					$timeout(function(){
						document.getElementById('at_team_record_dept_picklist').innerHTML = $scope.selectDeptRd[0].name;
						$scope.dept_id = $scope.selectDeptRd[0].id;
					},0)

				}
				else {

					document.getElementById('at_team_record_dept_picklist').innerHTML = $scope.selectDeptRd.length + '个部门(含子部门)';
					$scope.dept_id = '';
					for (var i=0;i<$scope.selectDeptRd.length;i++){
						$scope.dept_id = $scope.dept_id + $scope.selectDeptRd[i].id;
						if (i < $scope.selectDeptRd.length - 1){
							$scope.dept_id = $scope.dept_id + ',';
						}
					}



				}
				atTeamRecordSev.loadData($scope.current_date_str,$scope.dept_id);
				console.log(document.getElementById('details_div').onclick);



/*
		if (document.getElementById('details_div').onclick != null){
			console.log("have_click");
			$("#details_div").unbind("click");
			$("#statistics_div").unbind("click");
			document.getElementById('details_div').onclick = null;
			document.getElementById('statistics_div').onclick = null;
		}


		if (document.getElementById('details_div').onclick == null){
			console.log("not_cli");
			  document.getElementById('details_div').onclick=function(){
				  details_div_click();
				  $scope.current_tab = '1';
			  }
			  document.getElementById('statistics_div').onclick=function(){
				statistics_div_click();
				$scope.current_tab = '2';
			  }


		}


		if ($scope.current_tab == '2'){
		  reload_statistics_div();
		}

		}
	});
*/
	$scope.at_team_record_dept_picklist = function(){
		$deptComponentSer.open({
			title : '选择部门', //标题
			//barTitle : '施特伟科技有限公司',//导航标题
			barTitle : '组织架构',
			isSingleSelect:false, //是否单选
			isInherit:true, //是否选父带子
			selectNodeList:$scope.dept_id, //默认选中部门节点
			params:{ //加载扩展参数
				"is_permissions":"1",
				"is_process":"0"
			},
			/*
			params:{ //加载扩展参数
			"param1":"aa",
			"param2":"bb"
			},
			*/
			extName : '部门(含子部门)', //多选显示扩展后缀名
			sure : function (rd) { //确认返回接口，数组
			$rootScope.showLoading();
			$scope.isSelectDeptBack = true;
			$scope.selectDeptRd = [];
			$scope.selectDeptRd = rd;

			/*	if (rd.length == 0){
					document.getElementById('at_team_record_dept_picklist').innerHTML = '请选择部门';
					$scope.dept_id = '0';
				}
				else if (rd.length == 1){
					document.getElementById('at_team_record_dept_picklist').innerHTML = rd[0].name;
					$scope.dept_id = rd[0].id;
				}
				else {
					document.getElementById('at_team_record_dept_picklist').innerHTML = rd.length + '个部门(含子部门)';
					$scope.dept_id = '';
					for (var i=0;i<rd.length;i++){
						$scope.dept_id = $scope.dept_id + rd[i].id;
						if (i < rd.length - 1){
							$scope.dept_id = $scope.dept_id + ',';
						}
					}
				}
				atTeamRecordSev.loadData(current_date_str,$scope.dept_id);
				*/

			}
		});
	};





	$scope.at_team_record_by_type_detail=function(type){

		$location.path("home_page/home_menulist/at_team_record_by_type_detail/" + type + "/" + $scope.current_date_str+"/"+$scope.dept_id);
	}


	$scope.search=function(){
		atTeamRecordSev.loadData($scope.current_date_str,$scope.dept_id);
	}


    $scope.contract_management_directory1 = local_resource + 'img/icon/contract_management_directory1.png';
    $scope.is_pc_icon= local_resource + 'img/icon/is_pc_icon.png';

    $scope.select_date = function(){
      timeSelect.show({
        type :  'date',
        startDate : '2000年01月01日',
        endDate : $scope.today_date_text,
        defaultDate: $scope.current_date_text,
        returnDateType : 'ymd',
        returnTimeType :  '24h'||'AMPM',
        //stepping :10,
        selectedFunc : function (date) {

          if(typeof(date)=='undefined'){
          }
          else{
				current_date.setFullYear(parseInt(date.slice(0,4),10),(parseInt(date.slice(5,7),10)-1),(parseInt(date.slice(8,10),10)));
				$scope.current_date_str = (current_date.getFullYear() + '-' + (current_date.getMonth() + 1 < 10 ? '0' + (current_date.getMonth() + 1): (current_date.getMonth() + 1)) + '-' + (current_date.getDate() < 10 ? '0' + (current_date.getDate()): (current_date.getDate())));
				$scope.current_date_text= $scope.current_date_str.split("-")[0]+'年'+$scope.current_date_str.split("-")[1]+'月'+$scope.current_date_str.split("-")[2]+'日';
				atTeamRecordSev.loadData($scope.current_date_str,$scope.dept_id);
          }
        }
      });
    }

	function details_div_click(){

		if (document.getElementById('details_div').style.backgroundColor == 'white'){
			return;
		}

//		$scope.cancel_search();
		$scope.current_tab = '1';

		document.getElementById('atTeamRecordSearch').style.display='none';

        document.getElementById('details_div').style.color='#53afff';
        document.getElementById('details_div').style.backgroundColor='white';
        document.getElementById('details_div').style.border='none';
        document.getElementById('statistics_div').style.color='white';
        document.getElementById('statistics_div').style.backgroundColor='#53afff';
        document.getElementById('statistics_div').style.border='1px solid white';
        document.getElementById('statistics_div').style.borderLeft='none';

        document.getElementById('at_team_record_wrap').style.webkitTransform='translateX(0)';

        for(var i=0;i<document.getElementsByClassName('details_cls').length;i++){
          document.getElementsByClassName('details_cls')[i].style.display='block';
          document.getElementsByClassName('statistics_cls')[i].style.display='none';
        }
        document.getElementById('details_content_div').setAttribute("style","width:50%;padding-top:16px;");
        document.getElementById('statistics_content_div').setAttribute("style","width: 50%;position: absolute;left:50%;top:0px;");
        document.getElementById('at_team_record_wrap').style.overflow='visible';
        $timeout(function(){ $ionicScrollDelegate.scrollTop();
          document.getElementById('at_team_record_wrap').style.overflow='hidden';
        }, 100);
	}

	function statistics_div_click(){


		$scope.current_tab = '2';
		document.getElementById('atTeamRecordSearch').style.display='block';




        document.getElementById('statistics_div').style.color='#53afff';
        document.getElementById('statistics_div').style.backgroundColor='white';
        document.getElementById('statistics_div').style.border='none';
        document.getElementById('details_div').style.color='white';
        document.getElementById('details_div').style.backgroundColor='#53afff';
        document.getElementById('details_div').style.border='1px solid white';
        document.getElementById('details_div').style.borderRight='none';

        document.getElementById('at_team_record_wrap').style.webkitTransform='translateX(-50%)';
          document.getElementById('details_content_div').setAttribute("style","padding-top:16px;width:50%;position: absolute;left:0px;top:0px;");
          document.getElementById('statistics_content_div').setAttribute("style","width: 50%;float: right");
          document.getElementById('at_team_record_wrap').style.overflow='visible';
          $timeout(function(){ $ionicScrollDelegate.scrollTop();
            document.getElementById('at_team_record_wrap').style.overflow='hidden';
          }, 100);
	}

	function reload_statistics_div(){

		$scope.current_tab = '2';





        document.getElementById('statistics_div').style.color='#53afff';
        document.getElementById('statistics_div').style.backgroundColor='white';
        document.getElementById('statistics_div').style.border='none';
        document.getElementById('details_div').style.color='white';
        document.getElementById('details_div').style.backgroundColor='#53afff';
        document.getElementById('details_div').style.border='1px solid white';
        document.getElementById('details_div').style.borderRight='none';

        document.getElementById('at_team_record_wrap').style.webkitTransform='translateX(-50%)';

          document.getElementById('details_content_div').setAttribute("style","padding-top:10px;width:50%;position: absolute;left:0px;top:0px;");
          document.getElementById('statistics_content_div').setAttribute("style","width: 50%;float: right");
          document.getElementById('at_team_record_wrap').style.overflow='visible';
		  document.getElementById('at_team_record_wrap').style.overflow='hidden';
	}




	$scope.search_control=atTeamRecordSev.getSearchValue();
	$scope.searchState=atTeamRecordSev.getSearchState();
	$scope.searchNodata= atTeamRecordSev.getSearchNodata();
	$scope.end_of_list = atTeamRecordSev.getEndOfList();
    $scope.$on("$ionicView.enter", function () {


	if($scope.current_tab!='2'){

		$timeout(function(){

		document.getElementById('details_div').style.color='#53afff';
		document.getElementById('details_div').style.backgroundColor='white';
		document.getElementById('details_div').style.border='none';
		document.getElementById('statistics_div').style.color='white';
		document.getElementById('statistics_div').style.backgroundColor='#53afff';
		document.getElementById('statistics_div').style.border='1px solid white';
		document.getElementById('statistics_div').style.borderLeft='none';
		document.getElementById('atTeamRecordSearch').style.display='none';
		},200)



	}
	else{

		$timeout(function(){

        document.getElementById('statistics_div').style.color='#53afff';
        document.getElementById('statistics_div').style.backgroundColor='white';
        document.getElementById('statistics_div').style.border='none';
        document.getElementById('details_div').style.color='white';
        document.getElementById('details_div').style.backgroundColor='#53afff';
        document.getElementById('details_div').style.border='1px solid white';
        document.getElementById('details_div').style.borderRight='none';
		document.getElementById('atTeamRecordSearch').style.display='block';

		},200)

	}

		//debugger;


        //解决 进入明细页面back回来的时候 会再次loaddata
        if (typeof($scope.data_loaded) == 'undefined') {
			$scope.data_loaded = true;
			atTeamRecordSev.clearData();
			atTeamRecordSev.loadData($scope.current_date_str,$scope.dept_id);
			//$scope.at_team_record_data = atTeamRecordSev.getData();
			$scope.by_type_data = atTeamRecordSev.getByTypeData();
			$scope.by_employee_data = atTeamRecordSev.getByEmployeeData();
			$scope.end_of_list = atTeamRecordSev.getEndOfList();
			$scope.search_control=atTeamRecordSev.getSearchValue();
			//$scope.search_control=atTeamRecordSev.getSearchValue();
        }

		$timeout(function(){
		if (document.getElementById('details_div').onclick != null){

			$("#details_div").unbind("click");
			$("#statistics_div").unbind("click");
			document.getElementById('details_div').onclick = null;
			document.getElementById('statistics_div').onclick = null;
		}


		if (document.getElementById('details_div').onclick == null){

			  document.getElementById('details_div').onclick=function(){
				  details_div_click();
				  $scope.current_tab = '1';
			  }
			  document.getElementById('statistics_div').onclick=function(){
				statistics_div_click();
				$scope.current_tab = '2';
			  }


		}
		},200)



		/*ionic.off('click',nav_bar_tab_func,$('ion-nav-bar')[0])

		ionic.on('click',nav_bar_tab_func,$('ion-nav-bar')[0])
		*/

	/*
		if ($scope.current_tab == '2'){
		  reload_statistics_div();
		}
		*/

		if($scope.isSelectDeptBack){
			//$scope.isSelectDeptBack = false;

			if ($scope.selectDeptRd.length == 0){
					document.getElementById('at_team_record_dept_picklist').innerHTML = '请选择部门';
					$scope.dept_id = '0';
					atTeamRecordSev.loadData($scope.current_date_str,$scope.dept_id);
				}
				else if ($scope.selectDeptRd.length == 1){
					$timeout(function(){
						document.getElementById('at_team_record_dept_picklist').innerHTML = $scope.selectDeptRd[0].name;
						$scope.dept_id = $scope.selectDeptRd[0].id;
						atTeamRecordSev.loadData($scope.current_date_str,$scope.dept_id);
					},0)

				}
				else {

					document.getElementById('at_team_record_dept_picklist').innerHTML = $scope.selectDeptRd.length + '个部门(含子部门)';
					$scope.dept_id = '';
					for (var i=0;i<$scope.selectDeptRd.length;i++){
						$scope.dept_id = $scope.dept_id + $scope.selectDeptRd[i].id;
						if (i < $scope.selectDeptRd.length - 1){
							$scope.dept_id = $scope.dept_id + ',';
						}
					}
				atTeamRecordSev.loadData($scope.current_date_str,$scope.dept_id);


				}

				//console.log(document.getElementById('details_div').onclick);



/*
		if (document.getElementById('details_div').onclick != null){
			console.log("have_click");
			$("#details_div").unbind("click");
			$("#statistics_div").unbind("click");
			document.getElementById('details_div').onclick = null;
			document.getElementById('statistics_div').onclick = null;
		}


		if (document.getElementById('details_div').onclick == null){
			console.log("not_cli");
			  document.getElementById('details_div').onclick=function(){
				  details_div_click();
				  $scope.current_tab = '1';
			  }
			  document.getElementById('statistics_div').onclick=function(){
				statistics_div_click();
				$scope.current_tab = '2';
			  }


		}


		if ($scope.current_tab == '2'){
		  reload_statistics_div();
		}
		*/
		}




    });

	$scope.atTeamRecordBack=function(){
		$ionicHistory.goBack();
		atTeamRecordSev.clearStatusBar();
	}

	$scope.loadMoreEmployeeData=function(){
		if (document.getElementById('details_div').style.backgroundColor == 'white'){
			return;
		}
		atTeamRecordSev.loadMoreEmployeeData($scope.current_date_str,$scope.dept_id,$scope);
	}





  })


  .controller('atTeamRecordDetailCtrl',function($scope,atTeamRecordDetailSev,$stateParams,$location,$ionicPopup,$ionicHistory,$ionicScrollDelegate,timeSelect){
	atTeamRecordDetailSev.clearData();
	atTeamRecordDetailSev.loadData($stateParams.current_date, $stateParams.employee_no,$scope);
	$scope.atTeamRecordDetailData = atTeamRecordDetailSev.getData();
	$scope._title = $stateParams.user_name + '的考勤';
	var obj = $('#record_detail_target_date');
	obj.val($stateParams.current_date);
    document.getElementById('record_detail_target_date_').innerHTML=$stateParams.current_date;

    $scope.record_detail_target_date_ = function(){
      var current_date = new Date();
      current_date.setMinutes(current_date.getMinutes() - current_date.getTimezoneOffset());
      current_date = current_date.toJSON().slice(0,4);
      var startDate = parseInt(current_date, 10) - 10;
      startDate = startDate + '-01-01';
      var endDate = parseInt(current_date, 10) + 10;
      endDate = endDate + '-12-31';
      timeSelect.show({
        type :  'date' ,
        startDate :  '1900-01-01',
        endDate : '2099-12-31',
        defaultDate: document.getElementById("record_detail_target_date_").innerHTML,
        returnDateType : 'y-m-d',
        returnTimeType :  '24h'||'AMPM',
        //stepping :10,
        selectedFunc : function (date) {
          if (typeof(date) != 'undefined'){
            document.getElementById("record_detail_target_date_").innerHTML = date;
            obj.val(date);
            atTeamRecordDetailSev.loadData(obj.val(), $stateParams.employee_no);
          }
        }
      })
    }
    obj.change(function(){
		atTeamRecordDetailSev.loadData(obj.val(), $stateParams.employee_no);
    })
    $scope.previous_day = function(){

      document.getElementById("record_detail_target_date").stepDown(7);
      document.getElementById('record_detail_target_date_').innerHTML=obj.val();
      atTeamRecordDetailSev.loadData(obj.val(), $stateParams.employee_no);
    }


    $scope.next_day = function(){
      document.getElementById("record_detail_target_date").stepUp(7);
      document.getElementById('record_detail_target_date_').innerHTML=obj.val();
      atTeamRecordDetailSev.loadData(obj.val(), $stateParams.employee_no);
    }

  })



  .controller('essMyApplyDCMCtrl',function($scope,essMyApplyDCMSev,$ionicModal,$ionicActionSheet,$stateParams,sideSelect,timeSelect,$ionicScrollDelegate,$emplComponentService){
    $scope.dates_line2x = local_resource + 'img/model/dates-line2x.png';
    $scope.dates_line3x = local_resource + 'img/model/dates-line2x.png';
    $scope.add_approver = local_resource + 'img/model/add_approver.png';
    $scope.add_approver_ = local_resource + 'img/model/add_approver_.png';
    $scope.dates_line4x = local_resource + 'img/model/dates-line2x.png';
    $scope.img_upload_file_part1 = local_resource+'img/icon/add.png';
    $scope.img_upload_file_part2 = local_resource+'img/icon/new_2.png';
    $scope.is_require_upload = false;
    $scope.select_user_id = '';
    $scope.select_notify_id = '';
	essMyApplyDCMSev.clearData();
    essMyApplyDCMSev.loadData($stateParams.p_inst,$stateParams.show_type,$stateParams.task_id,$scope);
    $scope.lv_app_data = essMyApplyDCMSev.getData();
	$scope.imagesObj = essMyApplyDCMSev.getImageData();



    $scope.essLvPolicy=function(){
      sideSelect.show({
        type : 'ios',
        data :$scope.lv_app_data.essLvPolicy_data,
        selectIndex :  $scope.lv_app_data.essLvPolicy_data_index,
        selectedFunc : function (index) {
          if(typeof(index)!='undefined'){
            document.getElementById("essLvPolicy").innerHTML=$scope.lv_app_data.essLvPolicy_data[index].value;
            $scope.lv_app_data.essLvPolicy_data_key=$scope.lv_app_data.essLvPolicy_data[index].key;
            $scope.lv_app_data.essLvPolicy_data_index=index;
            $scope.lv_app_data.default_lv_code_id=$scope.lv_app_data.essLvPolicy_data_key;
            essMyApplyDCMSev.changeEssLvPolicy($scope,$scope.lv_app_data.default_lv_code_id);
          }

        }
      });
    }

    $scope.showDate_start_date = function(){
      var current_date = new Date();
      current_date.setMinutes(current_date.getMinutes() - current_date.getTimezoneOffset());
      current_date = current_date.toJSON().slice(0,4);
      var startDate = parseInt(current_date, 10) - 10;
      startDate = startDate + '-01-01';
      var endDate = parseInt(current_date, 10) + 10;
      endDate = endDate + '-12-31';
      timeSelect.show({
        type :  'date' ,
        startDate :  '1900-01-01',
        endDate : '2099-12-31',
        defaultDate: $scope.lv_app_data.start_date,
        returnDateType : 'y-m-d',
        returnTimeType :  '24h'||'AMPM',
        //stepping :10,
        selectedFunc : function (date) {
          if (typeof(date) != 'undefined'){
            $scope.lv_app_data.start_date = date;
            essMyApplyDCMSev.changeEssLvPolicy($scope,$scope.lv_app_data.default_lv_code_id);
          }
        }
      })
    }
    $scope.showDate_start_time = function(){
      var current_date = new Date();
      current_date.setMinutes(current_date.getMinutes() - current_date.getTimezoneOffset());
      current_date = current_date.toJSON().slice(0,4);
      var startDate = parseInt(current_date, 10) - 10;
      startDate = startDate + '-01-01';
      var endDate = parseInt(current_date, 10) + 10;
      endDate = endDate + '-12-31';
      timeSelect.show({
        type :  'time' ,
        startDate :  '1900-01-01',
        endDate : '2099-12-31',
        defaultDate: $scope.lv_app_data.start_time,
        returnDateType : 'y-m-d',
        returnTimeType :  '24h'||'AMPM',
        //stepping :10,
        selectedFunc : function (date) {
          if (typeof(date) != 'undefined'){
            $scope.lv_app_data.start_time = date;
            essMyApplyDCMSev.changeEssLvPolicy($scope,$scope.lv_app_data.default_lv_code_id);
          }
        }
      })
    }


    $scope.showDate_end_date = function(){
      var current_date = new Date();
      current_date.setMinutes(current_date.getMinutes() - current_date.getTimezoneOffset());
      current_date = current_date.toJSON().slice(0,4);
      var startDate = parseInt(current_date, 10) - 10;
      startDate = startDate + '-01-01';
      var endDate = parseInt(current_date, 10) + 10;
      endDate = endDate + '-12-31';
      timeSelect.show({
        type :  'date' ,
        startDate :  '1900-01-01',
        endDate : '2099-12-31',
        defaultDate: $scope.lv_app_data.end_date,
        returnDateType : 'y-m-d',
        returnTimeType :  '24h'||'AMPM',
        //stepping :10,
        selectedFunc : function (date) {
          if (typeof(date) != 'undefined'){
            $scope.lv_app_data.end_date = date;
            essMyApplyDCMSev.changeEssLvPolicy($scope,$scope.lv_app_data.default_lv_code_id);
          }
        }
      })
    }

    $scope.showDate_end_time = function(){
      var current_date = new Date();
      current_date.setMinutes(current_date.getMinutes() - current_date.getTimezoneOffset());
      current_date = current_date.toJSON().slice(0,4);
      var startDate = parseInt(current_date, 10) - 10;
      startDate = startDate + '-01-01';
      var endDate = parseInt(current_date, 10) + 10;
      endDate = endDate + '-12-31';
      timeSelect.show({
        type :  'time' ,
        startDate :  '1900-01-01',
        endDate : '2099-12-31',
        defaultDate: $scope.lv_app_data.end_time,
        returnDateType : 'y-m-d',
        returnTimeType :  '24h'||'AMPM',
        //stepping :10,
        selectedFunc : function (date) {
          if (typeof(date) != 'undefined'){
            $scope.lv_app_data.end_time = date;
            essMyApplyDCMSev.changeEssLvPolicy($scope,$scope.lv_app_data.default_lv_code_id);
          }
        }
      })
    }


    $scope.upload_photo = function (){

      // Show the action sheet
      var hideSheet = $ionicActionSheet.show({
        buttons: [

          {
            text: '拍照'
          }, {
            text: '从手机相册选择'
          }
        ],

        //titleText: 'Modify your album',
        titleText: '选择上传图片方式',
        cancelText: '取消',
        cancel: function() {
          // add cancel code..
        },
        buttonClicked: function(index) {

          if (index == 0) {

            try {
              navigator.camera.getPicture(function(uri) {
                $scope.is_require_upload = true;
                document.getElementById('ess_leave_apply_upload_mini_photo').style.display = "block";
                $('#ess_leave_apply_upload_mini_photo').attr("src", uri);
                document.getElementById('ess_leave_apply_upload_text').innerText='更改图片';
                $('#ess_leave_apply_upload_icon1').attr("src", local_resource+'img/icon/upload_modify.png');
                document.getElementById('ess_leave_apply_upload_icon2').style.display = "none";
                document.getElementById('ess_leave_apply_upload_text').style.marginTop = "1.8em";

              }, function() {
                //alert('cancel or failure');
              }, {
                quality: 10,
                //allowEdit: true,
                destinationType: Camera.DestinationType.FILE_URI,
                targetHeight: 500,
                targetWidth: 500,
                correctOrientation: true
              });
            } catch (e) {
              //alert(e.message);
            }
            return true;
          } else if (index == 1) {
            try {
              navigator.camera.getPicture(function(uri) {
                $scope.is_require_upload = true;
                document.getElementById('ess_leave_apply_upload_mini_photo').style.display = "block";
                $('#ess_leave_apply_upload_mini_photo').attr("src", uri);
                document.getElementById('ess_leave_apply_upload_text').innerText='更改图片';
                $('#ess_leave_apply_upload_icon1').attr("src", local_resource+'img/icon/upload_modify.png');
                document.getElementById('ess_leave_apply_upload_icon2').style.display = "none";
                document.getElementById('ess_leave_apply_upload_text').style.marginTop = "1.8em";

              }, function(message) {}, {
                quality: 100,
                destinationType: Camera.DestinationType.FILE_URI,
                // In this app, dynamically set the picture source, Camera or photo gallery
                sourceType: Camera.PictureSourceType.SAVEDPHOTOALBUM,
                encodingType: Camera.EncodingType.JPEG,
                mediaType: Camera.MediaType.PICTURE,
                //allowEdit: true,
                targetHeight: 500,
                targetWidth: 500,
                correctOrientation: true
              });
            } catch (e) {
              //alert(e.message);
            }

            return true;
          }

          return true;


        }
      });

      // For example's sake, hide the sheet after two seconds
      /*
       $timeout(function() {
       hideSheet();
       }, 2000);
       */


    }

    $scope.changeEssLvPolicy = function(){
      essMyApplyDCMSev.changeEssLvPolicy($scope,$scope.lv_app_data.default_lv_code_id);
    }

    $scope.saveApply = function(){
		var num_of_upload = 0;
		var updated_o_attachment = '';
		var updated_o_attachment_array = [];
		var lv_app_data_attachment_array = $scope.lv_app_data.attachment.split(',');
		var lv_app_data_o_attachment_array = $scope.lv_app_data.o_attachment.split(',');
		var imagesObj_data_array = $scope.imagesObj.data.split(',');

		if ($scope.imagesObj.data != ''){
			for (var i=0;i<imagesObj_data_array.length;i++){
				if ($scope.lv_app_data.attachment.indexOf(imagesObj_data_array[i])==-1){
					num_of_upload++;
				}
			}
		}

		if ($scope.lv_app_data.o_attachment != ''){
			for (var i=0;i<lv_app_data_o_attachment_array.length;i++){
				if ($scope.imagesObj.data.indexOf(lv_app_data_o_attachment_array[i])!=-1){
					updated_o_attachment_array.push(lv_app_data_o_attachment_array[i]);
				}
			}
		}

		updated_o_attachment = updated_o_attachment_array.join(',');


		if(num_of_upload > 0){
		  essMyApplyDCMSev.saveApplyWithPhoto($scope.select_user_id,$scope.select_notify_id,num_of_upload,updated_o_attachment);
		}
		else{
		  essMyApplyDCMSev.saveApply($scope.select_user_id,$scope.select_notify_id,updated_o_attachment);
		}

	}
    $scope.search_control={};
    $scope.search_control.search_val = '';
    $scope.ess_empl_data = [];
    //$scope.select_user_id = '';
    //$scope.select_notify_id = '';
    $scope.click_flag = 0;
    $scope.essItemCk = function(user_id,img,en,_flag){
      if(_flag == true){
        $scope.ess_empl_data.num_checked =  $scope.ess_empl_data.num_checked + 1;
      }else{
        $scope.ess_empl_data.num_checked =  $scope.ess_empl_data.num_checked - 1;
      }
      var _d = [];
      if($scope.click_flag == 0){
        $scope.select_user_id = user_id;
        _d = $scope.lv_app_data.approver_list;
      }else{
        return;
      }
      var flag = 0;
      var _len = _d.length;
      for(var i=0;i<_len;i++){
        if(angular.isDefined(_d[i].flag)&&_d[i].flag==1){
          flag = 1;
          break;
        }
      }
      if(flag == 0){
        _d.push({
          img:img,
          name:en,
          user_id:user_id,
          flag:1
        })
      }else{
        _d[_len-1] = {
          img:img,
          name:en,
          user_id:user_id,
          flag:1
        }
      }
      $scope.closeModal();
      $scope.approver_list=_d;
      $scope.search_control.search_val = '';
    }

    $scope.delete_notify=function(user_id){
      $('#essMyApplyDCM #notify_list_div').addClass('notify_list_active');
      if($scope.select_notify_id.indexOf(',')==-1){
        $scope.select_notify_id=$scope.select_notify_id.replace(user_id,'');
      }
      else if($scope.select_notify_id.indexOf(user_id+',')==-1){
        $scope.select_notify_id=$scope.select_notify_id.replace(','+user_id,'');
      }
      else{
        $scope.select_notify_id=$scope.select_notify_id.replace(user_id+',','');
      }
      for(var i=0;i<$scope.lv_app_data.notify_list.length;i++){
        if($scope.lv_app_data.notify_list[i].user_id==user_id){
          $scope.lv_app_data.notify_list.splice(i,1);
        }
      }
      setTimeout(function(){
        document.getElementById('notify_list_div').style.width=($scope.lv_app_data.notify_list.length+1)*100+20+'px';
        $ionicScrollDelegate.$getByHandle("notify_list_scroll").resize();
      },350)


    }
    $scope.delete_approver=function(user_id){
      if(!$scope.lv_app_data.approver_list_flag){
        return;
      }
      $('#essMyApplyDCM #approver_list_div').addClass('approver_list_active');
      $scope.approver_list=[];
      $scope.select_user_id=''
    }

    $scope.selectList = function(){
      if($scope.click_flag==1){
        var _d = [];
        $scope.select_notify_id = '';
        $scope.lv_app_data.notify_list = [];
        for(var i=0;i<$scope.ess_empl_data.length;i++){
          if($scope.ess_empl_data[i].ck){
            $scope.select_notify_id = $scope.select_notify_id + ($scope.ess_empl_data)[i].user_id+',';
            $scope.lv_app_data.notify_list.push({
              img:($scope.ess_empl_data)[i].img,
              name:($scope.ess_empl_data)[i].en,
              user_id:($scope.ess_empl_data)[i].user_id,
              flag:1
            });
          }
        }
        $scope.select_notify_id = ($scope.select_notify_id).substring(0,$scope.select_notify_id.length-1);
        $scope.closeModal();
      }
      $scope.search_control.search_val = '';
      $ionicScrollDelegate.$getByHandle("notify_list_scroll").resize();
      document.getElementById('notify_list_div').style.width=($scope.lv_app_data.notify_list.length+1)*100+20+'px';
    }

    $ionicModal.fromTemplateUrl('ess-empl-modal.html', {
      scope: $scope,
      animation: 'slide-in-up'
    }).then(function(modal) {
      $scope.modal = modal;
    });

	$scope.openModal = function() {

		var selectEmplList = '';
		if ($scope.lv_app_data.approver_list.length != 0){
			selectEmplList = $scope.lv_app_data.approver_list[0].employee_no;
		}

		$emplComponentService.open({
			title : '选择审批人', //弹开窗口标题
			barTitle : window.localStorage["org_top_level"],//导航开头
			isSingleSelect:true,//是否单选
			isShowContact:true,//是否展示常用联系人
			isNeedSaveContact:true,//是否保存常用联系人
			extName : '员工', //多选时提示后缀名
			selectEmplList:selectEmplList, //打开窗口默认选中员工列表

			sure : function (rd) { //返回数据，数组格式

				$('#approver_list_div').removeClass('approver_list_active');
				$scope.select_user_id = rd[0].user_id;
				$scope.lv_app_data.approver_list = [];
				$scope.lv_app_data.approver_list.push({
				  img:rd[0].img_src,
				  name:rd[0].empl_name,
				  user_id:rd[0].user_id,
				  employee_no:rd[0].empl_no,
				  flag:1
				});
				$scope.approver_list=$scope.lv_app_data.approver_list;
			}
		});

    }

    $scope.openModal2 = function() {
		var selectEmplList = '';
		if ($scope.lv_app_data.notify_list.length != 0){
			for (var i=0;i<$scope.lv_app_data.notify_list.length;i++){
				selectEmplList += $scope.lv_app_data.notify_list[i].employee_no;
				if (i < $scope.lv_app_data.notify_list.length - 1){
					selectEmplList += ',';
				}
			}

		}

		$emplComponentService.open({
			title : '选择知会人', //弹开窗口标题
			barTitle : window.localStorage["org_top_level"],//导航开头
			isSingleSelect:false,//是否单选
			isShowContact:true,//是否展示常用联系人
			isNeedSaveContact:true,//是否保存常用联系人
			extName : '员工', //多选时提示后缀名
			selectEmplList:selectEmplList, //打开窗口默认选中员工列表

			sure : function (rd) { //返回数据，数组格式
				$('#notify_list_div').removeClass('notify_list_active');
				$scope.select_notify_id = '';
				$scope.lv_app_data.notify_list = [];
				for(var i=0;i<rd.length;i++){

					$scope.select_notify_id = $scope.select_notify_id + rd[i].user_id;
					$scope.lv_app_data.notify_list.push({
					  img:rd[i].img_src,
					  name:rd[i].empl_name,
					  user_id:rd[i].user_id,
					  employee_no:rd[i].empl_no,
					  flag:1
					});
					if (i < rd.length - 1){
						$scope.select_notify_id += ',';
					}
				}

				document.getElementById('notify_list_div').style.width=($scope.lv_app_data.notify_list.length+1)*100+20+'px';
				$ionicScrollDelegate.$getByHandle("notify_list_scroll").resize();
			}
		});

    }

/*
    $scope.openModal = function() {
      $('#approver_list_div').removeClass('approver_list_active');
      $scope.search_val = '';
      $scope.click_flag = 0;
      $scope.ess_empl_data = [];
      essMyApplyDCMSev.loadEssEmplData($scope.select_user_id,$scope.lv_app_data.employee_no,$scope.lv_app_data.process_instance);
      $scope.ess_empl_data = essMyApplyDCMSev.getEssEmplData();
      $scope.modal.show();
    };
    $scope.openModal2 = function() {
      $('#notify_list_div').removeClass('notify_list_active');
      $scope.search_val = '';
      $scope.click_flag = 1;
      $scope.ess_empl_data = [];
      essMyApplyDCMSev.loadEssEmplData($scope.select_notify_id,$scope.lv_app_data.employee_no,$scope.lv_app_data.process_instance);
      $scope.ess_empl_data = essMyApplyDCMSev.getEssEmplData();
      $scope.modal.show();
    };
*/
    $scope.closeModal = function() {
      $scope.modal.hide();
      $scope.ess_empl_data = [];
      $scope.search_control.search_val = '';
    };
    $scope.$on('$destroy', function() {
      $scope.modal.remove();
    });
  })

  .controller('essMyApprovalCtrl',function($scope,essMyApprovalSev,$ionicPopover,$location){
    /*Sunny改*/
    $scope.ss_not_completed = local_resource + 'img/icon/ess_not_completed@2x.png';
    $scope.ess_has_been_completed = local_resource + 'img/icon/ess_has_been_completed@2x.png';
    $scope.ess_unhide_all = local_resource + 'img/icon/ess_unhide_all@2x.png';
    /*Sunny改*/
    $scope.apply_leave_icon = local_resource + 'img/icon/apply_leave_icon.png';
    $scope.apply_overtime_icon = local_resource + 'img/icon/apply_overtime_iocn.png';
    $scope.apply_field_icon = local_resource + 'img/icon/apply_field_icon.png';
	essMyApprovalSev.clearData();
    essMyApprovalSev.loadData();
    //$scope.search_val = "";
    $scope.my_apply_icon= local_resource +'img/menus/';
    $scope.ess_my_approval_data = essMyApprovalSev.getData();
    $scope.loadMyApply = function(name,type){
      if(type=="leave") {
        $location.path("home_page/ess_my_approval_details/" + name + "/" + type);
      }
      else if(type=="fieldwork"){
        $location.path("home_page/ess_my_approval_details_fieldwork/" + name + "/" + type);
      }
      else if(type=="overtime"){
        $location.path("home_page/ess_my_approval_details_overtime/" + name + "/" + type);
      }
      else if(type=='fieldwork_bill'){
        $location.path("home_page/ess_my_approval_details_out/" + name + "/" + type);
      }
      else if(type=='offic_work_out'){
        $location.path("home_page/ess_my_approval_details_offic_work_out/" + name + "/" + type);
      }
      else if(type=='at_daily_adj'){
        $location.path("home_page/ess_my_approval_details_card_adj/" + name + "/" + type);
      }
    }
  })


  .controller('essMyApprovalDCtrl',function($scope,essMyApprovalDSev,essLvApplySev,$stateParams,$ionicModal,$location,$ionicScrollDelegate,$timeout,$ionicHistory){
    if (ionic.Platform.isIOS()) {
      essMyApprovalDSev.clearData();
      essMyApprovalDSev.loadData($stateParams.type,'UC');
      $scope.ess_my_approvalD_data = essMyApprovalDSev.getData();
    } else {
      $scope.$on("$ionicView.enter", function () {
        //解决 进入明细页面back回来的时候 会再次loaddata
        if (typeof($scope.data_loaded) != 'undefined') {
          return;
        }
        else {
          $scope.data_loaded = true;
        }
        essMyApprovalDSev.clearData();
        essMyApprovalDSev.loadData($stateParams.type,'UC');
        $scope.ess_my_approvalD_data = essMyApprovalDSev.getData();
      });
    }
//    $scope.$on("$ionicView.enter", function () {
////解决 进入明细页面back回来的时候 会再次loaddata
//      if (typeof($scope.data_loaded) != 'undefined'){
//        return;
//      }
//      else {
//        $scope.data_loaded = true;
//      }
//      essMyApprovalDSev.clearData();
//      essMyApprovalDSev.loadData($stateParams.type,'UC');
//      $scope.ess_my_approvalD_data = essMyApprovalDSev.getData();
//    });
    $scope.search_control = essMyApprovalDSev.getSearchValue();
    //$scope.search_control.search_val = "";
    $scope.show_search = false;
    $scope.toggle_search = function() {
      $scope.show_search = true;
      $ionicScrollDelegate.scrollTop();
    }
    $scope.cancel_search = function() {
      $scope.show_search = false;
      $scope.search_control.search_val = '';
    }
    $scope.ess_my_approval_details_title=$stateParams.name +"审批";
	 // essMyApprovalDSev.clearData();
    //essMyApprovalDSev.loadData($stateParams.type,'UC');
    ////essMyApprovalDSev.loadOtherData($stateParams.type,'C');
    //$scope.ess_my_approvalD_data = essMyApprovalDSev.getData();
    //$scope.ess_my_approvalD_other_data = essMyApprovalDSev.getOtherData();
    $scope._flag='待处理';
    $scope.noapprove_click=function(){
      $scope._flag='待处理';
      document.getElementById('my_apply_details_noapprove').style.color='#53afff';
      document.getElementById('my_apply_details_approved').style.color='#808080';
      document.getElementById('ess_my_apply_details_tab_animate_div').style.webkitTransform='translateX(0)';
      document.getElementById('ess_my_apply_details_wrap').style.webkitTransform='translateX(0)';
      document.getElementById('ess_my_apply_details_wrap').style.overflow="visible";
      document.getElementById('ess_my_apply_details_noapprove_div').setAttribute("style","width:50%;");
      document.getElementById('ess_my_apply_details_approved_div').setAttribute("style","width: 50%;position: absolute;left:50%;top:0px;");
      $timeout(function(){ $ionicScrollDelegate.resize();
          document.getElementById('ess_my_apply_details_wrap').style.overflow="hidden";
        }, 200);



    }
    $scope.approved_click=function(){
      $scope._flag='已处理';
      document.getElementById('my_apply_details_noapprove').style.color='#808080';
      document.getElementById('my_apply_details_approved').style.color='#53afff';
      document.getElementById('ess_my_apply_details_tab_animate_div').style.webkitTransform='translateX(100%)';
      document.getElementById('ess_my_apply_details_wrap').style.webkitTransform='translateX(-50%)';
      document.getElementById('ess_my_apply_details_wrap').style.overflow="visible";
      document.getElementById('ess_my_apply_details_noapprove_div').setAttribute("style","width:50%;position: absolute;left:0px;top:0px;");
      document.getElementById('ess_my_apply_details_approved_div').setAttribute("style","width: 50%;float: right");
        $timeout(function(){ $ionicScrollDelegate.resize();
          document.getElementById('ess_my_apply_details_wrap').style.overflow="hidden";
        }, 200);


    }


    $scope.loadMyApplyContent=function(p_inst,show_type,task_id,my_app_result,is_normal_path){
      //if(my_app_result=="待处理"){
      //  my_app_result="UC";
      //}
      //else{
      //  my_app_result="C";
      //}
      $location.path("home_page/ess_my_approval_details_content/"+p_inst+"/"+show_type+"/"+task_id+"/"+my_app_result+"/"+is_normal_path+"/my_approval");
    }

  })

  .controller('essMyApprovalDetailsContentCtrl',function($emplComponentService,$scope,essMyApprovalDetailsContentSev,essLvApplySev,$stateParams,$ionicModal,$ionicActionSheet,$location,$timeout,$ionicPopup,sideSelect,$ionicScrollDelegate,zoomSlider){
    if($stateParams.my_app_result=='c'){
      $scope.app_result=false;
    }
    else{
      $scope.app_result=true;
    }

    $scope.fireEvent = function(i,arr){
      $timeout(function(){
        if(i==arr.length-1&&$scope.ess_my_approvalDC_data.approver_list_flag==false){
          document.getElementById("approver_list_img_"+i).style.display="none";
        }
        if(document.getElementById("approver_list_img_"+i)!=null){
          document.getElementById("approver_list_img_"+i).style. height=document.getElementById("approver_list_div" + i).offsetHeight+'px';
          document.getElementById("approver_list_div_"+i).style.height=(document.getElementById("approver_list_div" + i).offsetHeight-16)+'px';
        }
      }, 0);
    }

    $scope.view_team_at_exception = function(start_date){
		fufuMobclickAgent('click_leave_clash_report');
      if($stateParams.is_normal_path=='true'){
        $location.path("home_page/home_menulist/team_at_exception/"+start_date+"/"+$stateParams.is_normal_path);
      }
      else{
        $location.path("home_page/home_menulist/team_at_exception_msg/"+start_date+"/"+$stateParams.is_normal_path);
      }

    }



    $scope.dates_line2x = local_resource + 'img/model/dates-line2x.png';
    $scope.dates_line4x = local_resource + 'img/model/dates-line2x.png';
    $scope.icon_apply = local_resource + 'img/model/icon-apply@2x.png';
    $scope.approval_line = local_resource + 'img/model/approval-line@2x.png';
    $scope.icon_confirm = local_resource + 'img/model/icon-confirm@2x.png';
    $scope.icon_noappprove = local_resource + 'img/model/icon-noapprove.png';
    $scope.approval_line_gray = local_resource + 'img/model/approval-line-gray@2x.png';
    $scope.icon_waiting = local_resource + 'img/model/wait_approval.png';
    $scope.icon_wait = local_resource + 'img/model/icon-waiting@2x.png';
    $scope.approval_line_gray = local_resource + 'img/model/approval-line-gray@2x.png';
    $scope.add_approver = local_resource + 'img/model/add_approver.png';
    $scope.add_approver_ = local_resource + 'img/model/add_approver_.png';
    $scope.approve_icon= local_resource + 'img/icon/approve_icon.png';
    $scope.read_leave_icon= local_resource + 'img/icon/read_leave_icon.png';
    $scope.notify= local_resource + 'img/icon/notify.png';
    $scope.content_left_icon=local_resource + 'img/icon/content-left-icon.png';
    $scope.is_expand=true;
    $scope.notify_toggle=function(){
      $scope.is_expand=!$scope.is_expand;
    }
	essMyApprovalDetailsContentSev.clearData();
    essMyApprovalDetailsContentSev.loadData($stateParams.p_inst,$stateParams.show_type,$stateParams.task_id,$stateParams.my_app_result,$scope);
    $scope.ess_my_approvalDC_data = essMyApprovalDetailsContentSev.getData();

    $scope.show_img=function(index){
		zoomSlider.show({data:$scope.ess_my_approvalDC_data.attachment_array, index:index})
		return;
		/*
      if (ionic.Platform.isIOS()) {
        window.open(url, '_system', 'enableViewportScale=yes');
      } else {
        window.open(url, '_system');
      }
	  	*/
    }


    $scope.search_control={};
    $scope.search_control.search_val = '';
    $scope.ess_empl_data = [];
    $scope.select_user_id = '';
    $scope.select_notify_id = '';
    $scope.click_flag = 0;

    $scope.essItemCk = function(user_id,img,en,_flag){
      if(_flag == true){
        $scope.ess_empl_data.num_checked =  $scope.ess_empl_data.num_checked + 1;
      }else{
        $scope.ess_empl_data.num_checked =  $scope.ess_empl_data.num_checked - 1;
      }
      var _d = [];
      if($scope.click_flag == 0){
        $scope.select_user_id = user_id;
        _d = $scope.ess_my_approvalDC_data.approver_list;
        var flag = 0;
        var _len = _d.length;
        for(var i=0;i<_len;i++){
          if(angular.isDefined(_d[i]._flag)&&_d[i]._flag==1){
            flag = 1;
            break;
          }
        }

        if(flag == 0){
          _d.push({
            img:img,
            name:en,
            user_id:user_id,
            action:'下一层审批人',
            flag:1,
            _flag:1,
            attachment:'',
            approval_remark:'',
            color:"#999"
          })
        }else{
          _d[_len-1] = {
            img:img,
            name:en,
            action:'下一层审批人',
            flag:1,
            user_id:user_id,
            _flag:1,
            attachment:'',
            approval_remark:'',
            color:"#999"
          }
        }

        $scope.closeModal();
      }else{
        var _d = [];
        if($scope.click_flag == 0){
          $scope.select_user_id = user_id;
          _d = $scope.ess_my_approvalDC_data.approver_list;
        }else{
          return;
        }
        var flag = 0;
        var _len = _d.length;
        for(var i=0;i<_len;i++){
          if(angular.isDefined(_d[i].flag)&&_d[i].flag==1){
            flag = 1;
            break;
          }
        }
        if(flag == 0){
          _d.push({
            img:img,
            name:en,
            user_id:user_id,
            flag:1
          })
        }else{
          _d[_len-1] = {
            img:img,
            name:en,
            user_id:user_id,
            flag:1
          }
        }
        $scope.approver_list=_d;
        $scope.search_control.search_val = '';
        $scope.closeModal();
      }
    }
    $scope.delete_notify=function(user_id){
      $('#essMyApprovalDetailsContent #notify_list_div').addClass('notify_list_active');
      if($scope.select_notify_id.indexOf(',')==-1){
        $scope.select_notify_id=$scope.select_notify_id.replace(user_id,'');
      }
      else if($scope.select_notify_id.indexOf(user_id+',')==-1){
        $scope.select_notify_id=$scope.select_notify_id.replace(','+user_id,'');
      }
      else{
        $scope.select_notify_id=$scope.select_notify_id.replace(user_id+',','');
      }
      for(var i=0;i<$scope.ess_my_approvalDC_data.notify_list.length;i++){
        if($scope.ess_my_approvalDC_data.notify_list[i].user_id==user_id){
          $scope.ess_my_approvalDC_data.notify_list.splice(i,1);
        }
      }
      setTimeout(function(){
        document.getElementById('notify_list_div').style.width=($scope.ess_my_approvalDC_data.notify_list.length+1)*100+20+'px';
        $ionicScrollDelegate.$getByHandle("notify_list_scroll").resize();
      },350)

    }
    $scope.selectList = function(){
      if($scope.click_flag==1){
        var _d = [];
        $scope.select_notify_id = '';
        $scope.ess_my_approvalDC_data.notify_list = [];
        for(var i=0;i<$scope.ess_empl_data.length;i++){
          if($scope.ess_empl_data[i].ck){
            $scope.select_notify_id = $scope.select_notify_id + ($scope.ess_empl_data)[i].user_id+',';
            $scope.ess_my_approvalDC_data.notify_list.push({
              img:($scope.ess_empl_data)[i].img,
              name:($scope.ess_empl_data)[i].en,
              user_id:($scope.ess_empl_data)[i].user_id,
              flag:1
            });
          }
        }
        $scope.select_notify_id = ($scope.select_notify_id).substring(0,$scope.select_notify_id.length-1);
        $scope.closeModal();
      }
      document.getElementById('notify_list_div').style.width=($scope.ess_my_approvalDC_data.notify_list.length+1)*100+20+'px';
      //alert($scope.lv_app_data.notify_list.length);
      $ionicScrollDelegate.$getByHandle("notify_list_scroll").resize();
      $scope.search_control.search_val='';
    }

    $ionicModal.fromTemplateUrl('ess-empl-modal.html', {
      scope: $scope,
      animation: 'slide-in-up'
    }).then(function(modal) {
      $scope.modal = modal;
    });

/*
    $scope.openModal = function() {

      $scope.search_val = '';
      $scope.click_flag = 0;
      $scope.ess_empl_data = [];
      essMyApprovalDetailsContentSev.loadEssEmplData($scope.select_user_id,$scope.ess_my_approvalDC_data.employee_no,$scope.ess_my_approvalDC_data.process_instance);
      $scope.ess_empl_data = essMyApprovalDetailsContentSev.getEssEmplData();
      $scope.modal.show();
    };


    $scope.openModal2 = function() {
      $('#essMyApprovalDetailsContent #notify_list_div').removeClass('notify_list_active');
      $scope.search_val = '';
      $scope.click_flag = 1;
      $scope.ess_empl_data = [];
      essMyApprovalDetailsContentSev.loadEssEmplData($scope.select_notify_id,$scope.ess_my_approvalDC_data.employee_no,$scope.ess_my_approvalDC_data.process_instance);
      $scope.ess_empl_data = essMyApprovalDetailsContentSev.getEssEmplData();

      $scope.modal.show();
    };
	*/

	var routerName = '';
	if (typeof($stateParams.from_source) != 'undefined'){
		if ($stateParams.from_source == 'at_team_record'){
			routerName = 'default';
		}
		else if ($stateParams.from_source == 'my_approval'){
			routerName = 'default';
		}
		else if ($stateParams.from_source == 'home_message'){
			routerName = 'message';
		}
		else if ($stateParams.from_source == 'at_team_record'){
			routerName = 'default';
		}
	}

	$scope.openModal = function() {

		var _d = [];
		_d = $scope.ess_my_approvalDC_data.approver_list;
		var flag = 0;
		var _len = _d.length;

		var flag = 0;
		for(var i=0;i<_len;i++){
		  if(angular.isDefined(_d[i]._flag)&&_d[i]._flag==1){
			flag = 1;
			break;
		  }
		}

		var selectEmplList = '';
		if (flag == 1){
			selectEmplList = _d[_len-1].employee_no;
		}

		$emplComponentService.open({
			title : '选择审批人', //弹开窗口标题
			barTitle : window.localStorage["org_top_level"],//导航开头
			isSingleSelect:true,//是否单选
			isShowContact:true,//是否展示常用联系人
			isNeedSaveContact:true,//是否保存常用联系人
			extName : '员工', //多选时提示后缀名
			selectEmplList:selectEmplList, //打开窗口默认选中员工列表
			routerName: routerName,
			sure : function (rd) { //返回数据，数组格式
				$scope.select_user_id = rd[0].user_id;

				if(flag == 0){
				  _d.push({
					employee_no:rd[0].empl_no,
					img:rd[0].img_src,
					name:rd[0].empl_name,
					user_id:rd[0].user_id,
					action:'下一层审批人',
					flag:1,
					_flag:1,
					attachment:'',
					approval_remark:'',
					color:"#999"
				  })
				}else{
				  _d[_len-1] = {
					employee_no:rd[0].empl_no,
					img:rd[0].img_src,
					name:rd[0].empl_name,
					action:'下一层审批人',
					flag:1,
					user_id:rd[0].user_id,
					_flag:1,
					attachment:'',
					approval_remark:'',
					color:"#999"
				  }
				}

			}
		});


    }

	$scope.openModal2 = function() {
		var selectEmplList = '';
		if ($scope.ess_my_approvalDC_data.notify_list.length != 0){
			for (var i=0;i<$scope.ess_my_approvalDC_data.notify_list.length;i++){
				selectEmplList += $scope.ess_my_approvalDC_data.notify_list[i].employee_no;
				if (i < $scope.ess_my_approvalDC_data.notify_list.length - 1){
					selectEmplList += ',';
				}
			}

		}

		$emplComponentService.open({
			title : '选择知会人', //弹开窗口标题
			barTitle : window.localStorage["org_top_level"],//导航开头
			isSingleSelect:false,//是否单选
			isShowContact:true,//是否展示常用联系人
			isNeedSaveContact:true,//是否保存常用联系人
			extName : '员工', //多选时提示后缀名
			selectEmplList:selectEmplList, //打开窗口默认选中员工列表
			routerName: routerName,
			/*
			params:{ //支持可用扩展参数
				"is_permissions":"0",
				"is_process":"0",
				"process_instance":'0',
				"ext_param":"aa"
			},
			*/
			sure : function (rd) { //返回数据，数组格式
				$('#notify_list_div').removeClass('notify_list_active');
				$scope.select_notify_id = '';
				$scope.ess_my_approvalDC_data.notify_list = [];
				for(var i=0;i<rd.length;i++){

					$scope.select_notify_id = $scope.select_notify_id + rd[i].user_id;
					$scope.ess_my_approvalDC_data.notify_list.push({
					  img:rd[i].img_src,
					  name:rd[i].empl_name,
					  user_id:rd[i].user_id,
					  employee_no:rd[i].empl_no,
					  flag:1
					});
					if (i < rd.length - 1){
						$scope.select_notify_id += ',';
					}
				}

				document.getElementById('notify_list_div').style.width=($scope.ess_my_approvalDC_data.notify_list.length+1)*100+20+'px';
				$ionicScrollDelegate.$getByHandle("notify_list_scroll").resize();
			}
		});

    }

    $scope.closeModal = function() {
      $scope.modal.hide();
      $scope.ess_empl_data = [];
      $scope.search_control.search_val='';
    };
    $scope.$on('$destroy', function() {
      $scope.modal.remove();
    });


    $scope.submitAction = function(action){
      essMyApprovalDetailsContentSev.submitAction(action);
    }
    $scope.approval_date=[{
      key:'0',
      value:'批准'
    },{
      key:'1',
      value:'驳回'
    }]
    $scope.remark_flag=true;
    $scope.approval_index=0;
    $scope.approval_or_noapproval=function(){
      sideSelect.show({
        type : 'ios',
        data :$scope.approval_date,
        selectIndex :  $scope.approval_index,
        selectedFunc : function (index) {
          if(typeof(index)!='undefined'){
            document.getElementById("approval_answer").innerHTML= $scope.approval_date[index].value;
            index== '0' ? $scope.remark_flag=true : $scope.remark_flag=false;
            $scope.approval_index=index;
          }

        }
      });
    }

    $scope.save=function(){
      if($scope.remark_flag==false&&document.getElementById('leave_approval_remark_textarea').value==''){
        $ionicPopup.alert({
          title: '提醒',
          template: '<div style="text-align: center;">请填写备注</div>',
          okText: '确定'
        })
      }
      else {
        if ($scope.remark_flag) {
          essMyApprovalDetailsContentSev.applyApprove($scope.select_user_id,$stateParams.my_app_result,$scope.select_notify_id,$stateParams.from_source);
        }
        else {
          essMyApprovalDetailsContentSev.applyReject($scope.select_user_id,$stateParams.my_app_result,$scope.select_notify_id,$stateParams.from_source);
        }
      }
    }





  })

  .controller('essMyApprovalDFCtrl',function($scope,essMyApprovalDFSev,essLvApplySev,$stateParams,$ionicModal,$location,$ionicScrollDelegate,$ionicHistory,$timeout){
    if (ionic.Platform.isIOS()) {
      essMyApprovalDFSev.clearData();
      essMyApprovalDFSev.loadData($stateParams.type,"UC");
      $scope.ess_my_approvalD_data = essMyApprovalDFSev.getData();
    } else {
      $scope.$on("$ionicView.enter", function () {
        //解决 进入明细页面back回来的时候 会再次loaddata
        if (typeof($scope.data_loaded) != 'undefined') {
          return;
        }
        else {
          $scope.data_loaded = true;
        }
        essMyApprovalDFSev.clearData();
        essMyApprovalDFSev.loadData($stateParams.type,"UC");
        $scope.ess_my_approvalD_data = essMyApprovalDFSev.getData();
      });
    }
    //$scope.$on("$ionicView.enter", function () {
    //  //解决 进入明细页面back回来的时候 会再次loaddata
    //  if (typeof($scope.data_loaded) != 'undefined'){
    //    return;
    //  }
    //  else {
    //    $scope.data_loaded = true;
    //  }
    //  essMyApprovalDFSev.clearData();
    //  essMyApprovalDFSev.loadData($stateParams.type,"UC");
    //  $scope.ess_my_approvalD_data = essMyApprovalDFSev.getData();
    //});
    $scope.search_control = essMyApprovalDFSev.getSearchValue();
    //$scope.search_control.search_val = "";
    $scope.show_search = false;
    $scope.toggle_search = function() {
      $scope.show_search = true;
      $ionicScrollDelegate.scrollTop();
    }
    $scope.cancel_search = function() {
      $scope.show_search = false;
      $scope.search_control.search_val = '';
    }
    $scope.address_icon= local_resource + 'img/icon/address_icon.png';
    $scope.ess_my_approval_details_title=$stateParams.name +"审批";
	 // essMyApprovalDFSev.clearData();
    //essMyApprovalDFSev.loadData($stateParams.type,"UC");
    //essMyApprovalDFSev.loadOtherData($stateParams.type,"C");
    //$scope.ess_my_approvalD_data = essMyApprovalDFSev.getData();
    //$scope.ess_my_approvalD_other_data = essMyApprovalDFSev.getOtherData();
    $scope._flag="待处理";
    $scope.noapprove_click=function(){
      $scope._flag="待处理";
      document.getElementById('my_apply_details_noapprove').style.color='#53afff';
      document.getElementById('my_apply_details_approved').style.color='#808080';
      document.getElementById('ess_my_apply_details_tab_animate_div').style.webkitTransform='translateX(0)';
      //essMyApprovalDFSev.loadData($stateParams.type,"UC");
      //setTimeout(function(){ $ionicScrollDelegate.resize(); }, 200);
      document.getElementById('ess_my_apply_details_wrap').style.webkitTransform='translateX(0)';
      document.getElementById('ess_my_apply_details_wrap').style.overflow="visible";
      document.getElementById('ess_my_apply_details_noapprove_div').setAttribute("style","width:50%;");
      document.getElementById('ess_my_apply_details_approved_div').setAttribute("style","width: 50%;position: absolute;left:50%;top:0px;");
      $timeout(function(){ $ionicScrollDelegate.resize();
          document.getElementById('ess_my_apply_details_wrap').style.overflow="visible";
        }, 200);



    }
    $scope.approved_click=function(){
      $scope._flag="已处理";
      document.getElementById('my_apply_details_noapprove').style.color='#808080';
      document.getElementById('my_apply_details_approved').style.color='#53afff';
      document.getElementById('ess_my_apply_details_tab_animate_div').style.webkitTransform='translateX(100%)';
      //essMyApprovalDFSev.loadData($stateParams.type,"C");
      //setTimeout(function(){ $ionicScrollDelegate.resize(); }, 200);
      document.getElementById('ess_my_apply_details_wrap').style.webkitTransform='translateX(-50%)';
      document.getElementById('ess_my_apply_details_wrap').style.overflow="visible";
      document.getElementById('ess_my_apply_details_noapprove_div').setAttribute("style","width:50%;position: absolute;left:0px;top:0px;");
      document.getElementById('ess_my_apply_details_approved_div').setAttribute("style","width: 50%;float: right");
        $timeout(function(){ $ionicScrollDelegate.resize();
          document.getElementById('ess_my_apply_details_wrap').style.overflow="hidden";
        }, 200);


    }
    $scope.loadMyApplyContent=function(p_inst,show_type,task_id,my_app_result,is_normal_path){
      if(my_app_result=="待处理"){
        my_app_result="UC";
      }
      else{
        my_app_result="C";
      }

      $location.path("home_page/ess_my_approval_details_content_fieldwork/"+p_inst+"/"+show_type+"/"+task_id+"/"+my_app_result+"/"+is_normal_path+"/my_approval");
    }

  })



  .controller('atSignInOutDoorModifyCtrl',function(atSignInOutDoorModifySev,$scope,atSignInOutDoorSev,essLvApplySev,$stateParams,$ionicModal,$ionicActionSheet,$location){
	atSignInOutDoorModifySev.clearData();
    atSignInOutDoorModifySev.loadData($stateParams.p_inst,$stateParams.show_type,$stateParams.task_id,$scope);
    $scope.ess_my_applyDC_Fieldwork_data = atSignInOutDoorModifySev.getData();
    atSignInOutDoorSev.loadData();
    $scope.atSignInOutDoorData = atSignInOutDoorSev.getData();
    $scope.add_approver = local_resource + 'img/model/add_approver.png';
    $scope.add_approver_ = local_resource + 'img/model/add_approver_.png';
    var current_address='';
    var current_latitude='';
    var current_longitude='';
    $scope.is_require_upload = '0';
    $scope.field_attendance= local_resource+'img/icon/field_attendance.png';
    $scope.Sign_photos= local_resource+'img/icon/Sign_photos.png';

    var location_obj = {
      'latitude':'',
      'longitude':'',
      'address':'',
      'city':''
    };

    $scope.getAddress= function ($scope) {
      try{
			getLocation.checkCanLocation(
				function(result){
					if (result == 1){
						getLocation.showMap(function(msg){
						  try{
							if(msg.address==""||msg.address==null||msg.address=='(null)'){}
							else {

                location_obj = {
                  'latitude':msg.latitude,
                  'longitude':msg.longitude,
                  'address':msg.address,
                  'city':msg.detailAddress
                };

							  current_address = msg.address;
							  document.getElementById("address_now").innerText=current_address;
							  current_latitude = msg.latitude;
							  current_longitude = msg.longitude;
							  $("#current_latitude_hidden").val(current_latitude);
							  $("#current_longitude_hidden").val(current_longitude);
							  document.getElementById("message_city").value=msg.city;
							}
						  } catch (e){

						  }


						},location_obj);
					}
				}
			);
      }catch(e){
        console.log(e.message);
        alert(e.message);
      }
    }

    $scope.sign_in=function(){
      if ($scope.is_require_upload == '0'){
        atSignInOutDoorModifySev.signInOutDoorSave($scope,'modify',$scope.ess_my_applyDC_Fieldwork_data.o_photo,$("#current_latitude_hidden").val(),$("#current_longitude_hidden").val(),$scope.select_user_id,$scope.ess_my_applyDC_Fieldwork_data.process_instance,$scope.ess_my_applyDC_Fieldwork_data.task_id);
      }
      else {
        atSignInOutDoorModifySev.signInOutDoorSaveWithUpload($scope,'modify',$scope.ess_my_applyDC_Fieldwork_data.o_photo,$("#current_latitude_hidden").val(),$("#current_longitude_hidden").val(),$scope.select_user_id,$scope.ess_my_applyDC_Fieldwork_data.process_instance,$scope.ess_my_applyDC_Fieldwork_data.task_id);
      }
    }

    $scope.sign_change_photos= function () {
      try {
        navigator.camera.getPicture(function(uri) {
          $('#Sign_photos').attr("src", uri);
          $scope.is_require_upload = '1';
        }, function() {
          //alert('cancel or failure');
        }, {
			destinationType: Camera.DestinationType.FILE_URI,
			quality: 10,
			targetHeight: 500,
			targetWidth: 500,
			correctOrientation: true
        });
      } catch (e) {
        //alert(e.message);
      }
    }
    $scope.search_val = '';
    $scope.ess_empl_data = [];
   // $scope.select_user_id = '';
    //$scope.select_notify_id = '';
    $scope.click_flag = 0;
    $scope.essItemCk = function(user_id,img,en){
      var _d = [];
      if($scope.click_flag == 0){
        $scope.select_user_id = user_id;
        _d = $scope.ess_my_applyDC_Fieldwork_data.approver_list;
      }else{
        return;
      }
      var flag = 0;
      var _len = _d.length;
      for(var i=0;i<_len;i++){
        if(angular.isDefined(_d[i].flag)&&_d[i].flag==1){
          flag = 1;
          break;
        }
      }
      if(flag == 0){
        _d.push({
          img:img,
          name:en,
          user_id:user_id,
          flag:1
        })
      }else{
        _d[_len-1] = {
          img:img,
          name:en,
          user_id:user_id,
          flag:1
        }
      }
      $scope.closeModal();
    }

    $scope.selectList = function(){
      if($scope.click_flag==1){
        var _d = [];
        $scope.select_notify_id = '';
        $scope.lv_app_data.notify_list = [];
        for(var i=0;i<$scope.ess_empl_data.length;i++){
          if($scope.ess_empl_data[i].ck){
            $scope.select_notify_id = $scope.select_notify_id + ($scope.ess_empl_data)[i].user_id+',';
            $scope.ess_my_applyDC_Fieldwork_data.notify_list.push({
              img:($scope.ess_empl_data)[i].img,
              name:($scope.ess_empl_data)[i].en,
              user_id:($scope.ess_empl_data)[i].user_id,
              flag:1
            });
          }
        }
        $scope.select_notify_id = ($scope.select_notify_id).substring(0,$scope.select_notify_id.length-1);
        $scope.closeModal();
      }
    }

    $ionicModal.fromTemplateUrl('ess-empl-modal.html', {
      scope: $scope,
      animation: 'slide-in-up'
    }).then(function(modal) {
      $scope.modal = modal;
    });
    $scope.openModal = function() {
      $scope.search_val = '';
      $scope.click_flag = 0;
      $scope.ess_empl_data = [];
      atSignInOutDoorModifySev.loadEssEmplData($scope.select_user_id,$scope.ess_my_applyDC_Fieldwork_data.employee_no,$scope.ess_my_applyDC_Fieldwork_data.process_instance);
      $scope.ess_empl_data = atSignInOutDoorModifySev.getEssEmplData();
      $scope.modal.show();
    };
    $scope.closeModal = function() {
      $scope.modal.hide();
      $scope.ess_empl_data = [];
    };
    $scope.$on('$destroy', function() {
      $scope.modal.remove();
    });

    $scope.picklist_sign_in_reason = function(){
      var picklist_key_list = "";
      var picklist_value_list = "";
      var checked_key = $('#sign_in_reason_key').val();
      var checked_value = $('#sign_in_reason').val();
      var picklist_title = '签到原因';
      var return_key_field_id = 'sign_in_reason_key';
      var return_value_field_id = 'sign_in_reason';
      var hidden_fields = 'new_contract_end_date_editable_div';

      picklist_key_list = '拜访客户,会议,发布会,培训,巡查,采购,公务办理,其他';
      picklist_value_list = '拜访客户,会议,发布会,培训,巡查,采购,公务办理,其他';

      $location.path('home_page/home_menulist/modify_picklist_sign_in_reason/' + picklist_key_list + '/' + picklist_value_list + '/' + checked_key + '/' + checked_value + '/' + picklist_title + '/' + return_key_field_id + '/' + return_value_field_id + '/' + hidden_fields);
    }

  })

  .controller('essMyApprovalDFCCtrl',function($emplComponentService,$scope,essMyApprovalDFCSev,essLvApplySev,$stateParams,$ionicModal,$ionicActionSheet,$location,$timeout,$ionicPopup,sideSelect,$ionicScrollDelegate,zoomSlider){

      $scope.approval_content_fieldwork_title='上报位置单审批';

    $scope.fireEvent = function(i,arr,flag){
      $timeout(function(){
        if(document.getElementById("approver_list_img_"+i)!=null){
          document.getElementById("approver_list_img_"+i).style.height=document.getElementById("approver_list_div" + i).offsetHeight+'px';
          document.getElementById("approver_list_div_"+i).style.height=(document.getElementById("approver_list_div" + i).offsetHeight-16)+'px';
        }

        if(i==arr.length-1&&flag==false){
          document.getElementById("approver_list_img_"+i).style.display="none";
        }
      }, 0);
    }
    $scope.dates_line2x = local_resource + 'img/model/dates-line2x.png';
    $scope.icon_apply = local_resource + 'img/model/icon-apply@2x.png';
    $scope.approval_line = local_resource + 'img/model/approval-line@2x.png';
    $scope.icon_confirm = local_resource + 'img/model/icon-confirm@2x.png';
    $scope.icon_noappprove = local_resource + 'img/model/icon-noapprove.png';
    $scope.approval_line_gray = local_resource + 'img/model/approval-line-gray@2x.png';
    $scope.icon_waiting = local_resource + 'img/model/wait_approval.png';
    $scope.icon_wait = local_resource + 'img/model/icon-waiting@2x.png';
    $scope.approval_line_gray = local_resource + 'img/model/approval-line-gray@2x.png';
    $scope.add_approver = local_resource + 'img/model/add_approver.png';
    $scope.add_approver_ = local_resource + 'img/model/add_approver_.png';
     $scope.approve_icon= local_resource + 'img/icon/approve_icon.png';
    $scope.map_icon=local_resource+'img/icon/map_icon.png';
    $scope.content_left_icon=local_resource+'img/icon/content-left-icon.png';
    $scope.notify= local_resource + 'img/icon/notify.png';
	essMyApprovalDFCSev.clearData();
    essMyApprovalDFCSev.loadData($stateParams.p_inst,$stateParams.show_type,$stateParams.task_id,$stateParams.my_app_result,$scope);
    if($stateParams.my_app_result=='C'){
      $scope.app_result=false;
    }
    else{
      $scope.app_result=true;
    }

    $scope.my_approval_show_map=function(longitude,latitude,location){
      try {
		getLocation.checkCanLocation(
			function(result){
				if (result == 1){
			        getLocation.showMapWithCoordinate({latitude: latitude, longitude: longitude, address: location});
				}
			}
		);
      }
      catch(e){
        console.log(e.message);
      }
      }
    $scope.show_img=function(url){
		var temp_array = [];
		temp_array.push(url);
		zoomSlider.show({data:temp_array, index:0});
		/*
      if (ionic.Platform.isIOS()) {
        window.open(url, '_system', 'enableViewportScale=yes');
      } else {
        window.open(url, '_system');
      }
	  */
    }
    $scope.ess_my_approvalDC_data = essMyApprovalDFCSev.getData();
    $scope.search_control={};
    $scope.search_control.search_val = '';
    $scope.ess_empl_data = [];
    //$scope.select_user_id = '';
    $scope.select_notify_id = '';
    $scope.click_flag = 0;

    $scope.delete_notify=function(user_id){
      $('#essMyApprovalDFC #notify_list_div').addClass('notify_list_active');
      if($scope.select_notify_id.indexOf(',')==-1){
        $scope.select_notify_id=$scope.select_notify_id.replace(user_id,'');
      }
      else if($scope.select_notify_id.indexOf(user_id+',')==-1){
        $scope.select_notify_id=$scope.select_notify_id.replace(','+user_id,'');
      }
      else{
        $scope.select_notify_id=$scope.select_notify_id.replace(user_id+',','');
      }
      for(var i=0;i<$scope.ess_my_approvalDC_data.notify_list.length;i++){
        if($scope.ess_my_approvalDC_data.notify_list[i].user_id==user_id){
          $scope.ess_my_approvalDC_data.notify_list.splice(i,1);
        }
      }
      setTimeout(function(){
        document.getElementById('notify_list_div').style.width=($scope.ess_my_approvalDC_data.notify_list.length+1)*100+20+'px';
        $ionicScrollDelegate.$getByHandle("notify_list_scroll").resize();
      },350)


    }


    $scope.essItemCk = function(user_id,img,en,_flag){
      if(_flag == true){
        $scope.ess_empl_data.num_checked =  $scope.ess_empl_data.num_checked + 1;
      }else{
        $scope.ess_empl_data.num_checked =  $scope.ess_empl_data.num_checked - 1;
      }
      var _d = [];
      if($scope.click_flag == 0){
        $scope.select_user_id = user_id;
        _d = $scope.ess_my_approvalDC_data.approver_list;
        var flag = 0;
        var _len = _d.length;
        for(var i=0;i<_len;i++){
          if(angular.isDefined(_d[i]._flag)&&_d[i]._flag==1){
            flag = 1;
            break;
          }
        }
        if(flag == 0){
          _d.push({
            img:img,
            name:en,
            user_id:user_id,
            color:"#999",
            action:'下一层审批人',
            flag:1,
            _flag:1,
            attachment:'',
            approval_remark:''
          })
        }else{
          _d[_len-1] = {
            img:img,
            name:en,
            color:"#999",
            action:'下一层审批人',
            flag:1,
            user_id:user_id,
            _flag:1,
            attachment:'',
            approval_remark:''
          }
        }
        $scope.approver_list=_d;
      }else{
        var _d = [];
        if($scope.click_flag == 0){
          $scope.select_user_id = user_id;
          _d = $scope.ess_my_approvalDC_data.approver_list;
        }else{
          return;
        }
        var flag = 0;
        var _len = _d.length;
        for(var i=0;i<_len;i++){
          if(angular.isDefined(_d[i].flag)&&_d[i].flag==1){
            flag = 1;
            break;
          }
        }
        if(flag == 0){
          _d.push({
            img:img,
            name:en,
            user_id:user_id,
            flag:1
          })
        }else{
          _d[_len-1] = {
            img:img,
            name:en,
            user_id:user_id,
            flag:1
          }
        }

      }
      $scope.search_control.search_val = '';
      $scope.closeModal();
    }




    $scope.selectList = function(){
      if($scope.click_flag==1){
        var _d = [];
        $scope.select_notify_id = '';
        $scope.ess_my_approvalDC_data.notify_list = [];
        for(var i=0;i<$scope.ess_empl_data.length;i++){
          if($scope.ess_empl_data[i].ck){
            $scope.select_notify_id = $scope.select_notify_id + ($scope.ess_empl_data)[i].user_id+',';
            $scope.ess_my_approvalDC_data.notify_list.push({
              img:($scope.ess_empl_data)[i].img,
              name:($scope.ess_empl_data)[i].en,
              user_id:($scope.ess_empl_data)[i].user_id,
              flag:1
            });
          }
        }
        $scope.select_notify_id = ($scope.select_notify_id).substring(0,$scope.select_notify_id.length-1);
        document.getElementById('notify_list_div').style.width=($scope.ess_my_approvalDC_data.notify_list.length+1)*100+20+'px';
        $scope.closeModal();
      }

    }

    $scope.select_user_id='';
    $ionicModal.fromTemplateUrl('ess-my-apply-empl-modal.html', {
      scope: $scope,
      animation: 'slide-in-up'
    }).then(function(modal) {
      $scope.modal = modal;
    });
	/*
    $scope.openModal = function() {
      $scope.search_val = '';
      $scope.click_flag = 0;
      $scope.ess_empl_data = [];
      essLvApplySev.loadEssEmplData($scope.select_user_id,$scope.ess_my_approvalDC_data.employee_no,$scope.ess_my_approvalDC_data.process_instance);
      $scope.ess_empl_data = essLvApplySev.getEssEmplData();
      $scope.modal.show();
    };
    $scope.openModal2 = function() {
      $('#essMyApprovalDFC #notify_list_div').removeClass('notify_list_active');
      $scope.search_val = '';
      $scope.click_flag = 1;
      $scope.ess_empl_data = [];
      essLvApplySev.loadEssEmplData($scope.select_notify_id,$scope.ess_my_approvalDC_data.employee_no,$scope.ess_my_approvalDC_data.process_instance);
      $scope.ess_empl_data = essLvApplySev.getEssEmplData();

      $scope.modal.show();
    };
	*/

	var routerName = '';
	if (typeof($stateParams.from_source) != 'undefined'){
		if ($stateParams.from_source == 'at_team_record'){
			routerName = 'default';
		}
		else if ($stateParams.from_source == 'my_approval'){
			routerName = 'default';
		}
		else if ($stateParams.from_source == 'home_message'){
			routerName = 'message';
		}
		else if ($stateParams.from_source == 'at_team_record'){
			routerName = 'default';
		}
	}

	$scope.openModal = function() {

		var _d = [];
		_d = $scope.ess_my_approvalDC_data.approver_list;
		var flag = 0;
		var _len = _d.length;

		var flag = 0;
		for(var i=0;i<_len;i++){
		  if(angular.isDefined(_d[i]._flag)&&_d[i]._flag==1){
			flag = 1;
			break;
		  }
		}

		var selectEmplList = '';
		if (flag == 1){
			selectEmplList = _d[_len-1].employee_no;
		}

		$emplComponentService.open({
			title : '选择审批人', //弹开窗口标题
			barTitle : window.localStorage["org_top_level"],//导航开头
			isSingleSelect:true,//是否单选
			isShowContact:true,//是否展示常用联系人
			isNeedSaveContact:true,//是否保存常用联系人
			extName : '员工', //多选时提示后缀名
			selectEmplList:selectEmplList, //打开窗口默认选中员工列表
			routerName: routerName,
			sure : function (rd) { //返回数据，数组格式
				$scope.select_user_id = rd[0].user_id;

				if(flag == 0){
				  _d.push({
					employee_no:rd[0].empl_no,
					img:rd[0].img_src,
					name:rd[0].empl_name,
					user_id:rd[0].user_id,
					action:'下一层审批人',
					flag:1,
					_flag:1,
					attachment:'',
					approval_remark:'',
					color:"#999"
				  })
				}else{
				  _d[_len-1] = {
					employee_no:rd[0].empl_no,
					img:rd[0].img_src,
					name:rd[0].empl_name,
					action:'下一层审批人',
					flag:1,
					user_id:rd[0].user_id,
					_flag:1,
					attachment:'',
					approval_remark:'',
					color:"#999"
				  }
				}

			}
		});


    }

	$scope.openModal2 = function() {
		var selectEmplList = '';
		if ($scope.ess_my_approvalDC_data.notify_list.length != 0){
			for (var i=0;i<$scope.ess_my_approvalDC_data.notify_list.length;i++){
				selectEmplList += $scope.ess_my_approvalDC_data.notify_list[i].employee_no;
				if (i < $scope.ess_my_approvalDC_data.notify_list.length - 1){
					selectEmplList += ',';
				}
			}

		}

		$emplComponentService.open({
			title : '选择知会人', //弹开窗口标题
			barTitle : window.localStorage["org_top_level"],//导航开头
			isSingleSelect:false,//是否单选
			isShowContact:true,//是否展示常用联系人
			isNeedSaveContact:true,//是否保存常用联系人
			extName : '员工', //多选时提示后缀名
			selectEmplList:selectEmplList, //打开窗口默认选中员工列表
			routerName: routerName,
			/*
			params:{ //支持可用扩展参数
				"is_permissions":"0",
				"is_process":"0",
				"process_instance":'0',
				"ext_param":"aa"
			},
			*/
			sure : function (rd) { //返回数据，数组格式
				$('#notify_list_div').removeClass('notify_list_active');
				$scope.select_notify_id = '';
				$scope.ess_my_approvalDC_data.notify_list = [];
				for(var i=0;i<rd.length;i++){

					$scope.select_notify_id = $scope.select_notify_id + rd[i].user_id;
					$scope.ess_my_approvalDC_data.notify_list.push({
					  img:rd[i].img_src,
					  name:rd[i].empl_name,
					  user_id:rd[i].user_id,
					  employee_no:rd[i].empl_no,
					  flag:1
					});
					if (i < rd.length - 1){
						$scope.select_notify_id += ',';
					}
				}

				document.getElementById('notify_list_div').style.width=($scope.ess_my_approvalDC_data.notify_list.length+1)*100+20+'px';
				$ionicScrollDelegate.$getByHandle("notify_list_scroll").resize();
			}
		});

    }

    $scope.closeModal = function() {
      $scope.modal.hide();
      $scope.ess_empl_data = [];
    };
    //$scope.$on('$destroy', function() {
    //  $scope.modal.remove();
    //});
    //$scope.essItemCk = function(user_id,img,en){
    //  var _d = [];
    //  $scope.select_user_id = user_id;
    //  _d = $scope.ess_my_approvalDC_data.approver_list;
    //  var flag = 0;
    //  var _len = _d.length;
    //  for(var i=0;i<_len;i++){
    //    if(angular.isDefined(_d[i]._flag)&&_d[i]._flag==1){
    //      flag = 1;
    //      break;
    //    }
    //  }
    //  if(flag == 0){
    //    _d.push({
    //      img:img,
    //      name:en,
    //      user_id:user_id,
    //      color:"#999",
    //      action:'下一层审批人',
    //      flag:1,
    //      _flag:1,
    //      attachment:'',
    //      approval_remark:''
    //    })
    //  }else{
    //    _d[_len-1] = {
    //      img:img,
    //      name:en,
    //      color:"#999",
    //      action:'下一层审批人',
    //      flag:1,
    //      user_id:user_id,
    //      _flag:1,
    //      attachment:'',
    //      approval_remark:''
    //    }
    //  }
    //  $scope.closeModal();
    //}

    //$scope.applyReject = function(){
    //  essLvApDetailSev.applyReject($scope.select_user_id);
    //}
    //$scope.applyApprove = function(){
    //  essLvApDetailSev.applyApprove($scope.select_user_id);
    //}


    $scope.submitAction = function(action){
      essMyApprovalDFCSev.submitAction(action);
    }

    $scope.approval_date=[{
      "key":"0",
      "value":"批准"
    },{
      "key":"1",
      "value":"驳回"
    }]
    $scope.remark_flag=true;
    $scope.approval_index=0;
    $scope.approval_or_noapproval=function(){
      sideSelect.show({
        type : 'ios',
        data :$scope.approval_date,
        selectIndex :  $scope.approval_index,
        selectedFunc : function (index) {
          if(typeof(index)!='undefined'){
            document.getElementById("approval_answer").innerHTML= $scope.approval_date[index].value;
            index== '0' ? $scope.remark_flag=true : $scope.remark_flag=false;
            $scope.approval_index=index;
          }

        }
      });
    }

    $scope.save=function(){
      if($scope.remark_flag==false&&document.getElementById('remark_textarea').value==''){
        $ionicPopup.alert({
          title: '提醒',
          template: '<div style="text-align: center;">请填写备注</div>',
          okText: '确定'
        })
      }
      else {
        if ($scope.remark_flag) {
          essMyApprovalDFCSev.applyApprove($scope.select_user_id, $scope.select_notify_id,$stateParams.from_source);
        }
        else {
          essMyApprovalDFCSev.applyReject($scope.select_user_id, $scope.select_notify_id,$stateParams.from_source);
        }
       }
    }
  })

  .controller('essOtApplyCtrl',function($scope,essOtApplySev,$ionicModal,$ionicActionSheet,$location,essLvApplySev,timeSelect,sideSelect,$stateParams,$ionicScrollDelegate,$emplComponentService){
    $scope.dates_line2x = local_resource + 'img/model/dates-line2x.png';
    $scope.dates_line3x = local_resource + 'img/model/dates-line2x.png';
    $scope.add_approver = local_resource + 'img/model/add_approver.png';
    $scope.add_approver_ = local_resource + 'img/model/add_approver_.png';
    $scope.dates_line4x = local_resource + 'img/model/dates-line2x.png';
    $scope.img_upload_file_part1 = local_resource+'img/icon/add.png';
    $scope.img_upload_file_part2 = local_resource+'img/icon/new_2.png';
    $scope.contract_management_directory1 = local_resource + 'img/icon/contract_management_directory1.png';
    $scope.start_ot_icon=local_resource+'img/icon/start_ot_icon.png';
    $scope.end_ot_icon=local_resource+'img/icon/end_ot_icon.png';
    $scope.start_rest_icon=local_resource+'img/icon/start_rest_icon.png';
    $scope.end_rest_icon=local_resource+'img/icon/end_rest_icon.png';
    $scope.ot_hours_icon=local_resource+'img/icon/ot_hours_icon.png';
	  essOtApplySev.clearData();

    if (typeof($stateParams.task_id) != 'undefined'){
      //essOtApplyModifySev.loadData($stateParams.p_inst,$stateParams.show_type,$stateParams.task_id,$scope);
      essOtApplySev.loadModifyData($stateParams.p_inst,$stateParams.show_type,$stateParams.task_id,$scope);
      $scope.ot_apply_title='修改加班单'
    }
    else{
      $scope.ot_apply_title='加班申请'
      essOtApplySev.loadData($scope);
    }

    $scope.ot_app_data = essOtApplySev.getData();
    //$scope.add_time_list=[{name:'',in:$scope.ot_app_data.first_in,in_need_clock:$scope.ot_app_data.first_in_need_clock,out:$scope.ot_app_data.first_out,out_need_clock:$scope.ot_app_data.first_out_need_clock,is_need:$scope.ot_app_data.is_need_first},{name:'',in:$scope.ot_app_data.second_in,in_need_clock:$scope.ot_app_data.second_in_need_clock,out:$scope.ot_app_data.second_out,out_need_clock:$scope.ot_app_data.second_out_need_clock,is_need:$scope.ot_app_data.is_need_second},{name:'',in:$scope.ot_app_data.ot_in,in_need_clock:$scope.ot_app_data.ot_in_need_clock,out:$scope.ot_app_data.ot_out,out_need_clock:$scope.ot_app_data.ot_out_need_clock,is_need:$scope.ot_app_data.is_need_ot}];

    $scope.essOtPolicy=function(){
      sideSelect.show({
        type : 'ios',
        data :$scope.ot_app_data.essOtPolicy_data,
        selectIndex :  $scope.ot_app_data.essOtPolicy_index,
        selectedFunc : function (index) {
          if(typeof(index)!='undefined'){
            document.getElementById("essOtPolicy").innerHTML=$scope.ot_app_data.essOtPolicy_data[index].value;
            $scope.ot_app_data.essOtPolicy_data_key=$scope.ot_app_data.essOtPolicy_data[index].key;
            $scope.ot_app_data.essOtPolicy_index=index;
            $scope.ot_app_data.ot_code_key=$scope.ot_app_data.essOtPolicy_data_key;
            for(var i=0;i<$scope.ot_app_data.ot_code.length;i++){
              $scope.ot_app_data.ot_code[i].check=false;
            }
            $scope.ot_app_data.ot_code[index].check=true;
            if($scope.time_list_ot_apply.length==0){
              card_times=$scope.ot_app_data.card_times;
            }
            else{
              card_times=$scope.time_list_ot_apply.length+1;
            }

            essOtApplySev.add_time_save($scope.time_list_ot_apply,$scope,false,'1',card_times)
          }

        }
      });
    }
    $scope.showDate_date = function(){
      timeSelect.show({
        type :  'date',
        startDate :'1900年01月01日',
        endDate : '2099年12月31日',
        defaultDate: $scope.ot_app_data.ot_date,
        returnDateType : 'ymd',
        returnTimeType :  '24h'||'AMPM',
        //stepping :10,
        selectedFunc : function (date) {
          if (typeof(date) != 'undefined'){
            var formatted_date = date.replace('年','-');
            formatted_date = formatted_date.replace('月','-');
            formatted_date = formatted_date.replace('日','');
            $scope.ot_app_data.ot_date = formatted_date;
          }
        }
      })
    }
    $scope.showTime_ot_in = function(){
      timeSelect.show({
        type :  'time',
        startDate :'1900年01月01日',
        endDate : '2099年12月31日',
        defaultDate:  $scope.ot_app_data.ot_in,
        returnDateType : 'hm',
        returnTimeType :  '24h'||'AMPM',
        //stepping :10,
        selectedFunc : function (date) {
          if (typeof(date) != 'undefined'){
            $scope.ot_app_data.ot_in = date;
            var s_t=$scope.ot_app_data.ot_in;
            var e_t=$scope.ot_app_data.ot_out;
            s_t=s_t.split(":");
            e_t=e_t.split(":");
            var _hours=( (e_t[0]-s_t[0])*60+(e_t[1]-s_t[1]));
            if(_hours>0){
            }
            else{
              _hours=parseInt(_hours)+(24*60);
            }
            var min=_hours;
            essOtApplySev.get_ot_hours_normal(min,$scope.ot_app_data.ot_valid_min,$scope.ot_app_data.ot_min_unit,$scope);
          }
        }
      })
    }
    $scope.showTime_ot_out = function(){
      timeSelect.show({
        type :  'time',
        startDate :'1900年01月01日',
        endDate : '2099年12月31日',
        defaultDate:  $scope.ot_app_data.ot_out,
        returnDateType : 'hm',
        returnTimeType :  '24h'||'AMPM',
        //stepping :10,
        selectedFunc : function (date) {
          if (typeof(date) != 'undefined'){
            $scope.ot_app_data.ot_out = date;
            var s_t=$scope.ot_app_data.ot_in;
            var e_t=$scope.ot_app_data.ot_out;
            s_t=s_t.split(":");
            e_t=e_t.split(":");
            var _hours=( (e_t[0]-s_t[0])*60+(e_t[1]-s_t[1]));
            if(_hours>0){
              //$scope.ot_app_data.ot_hours=_hours;
              //    document.getElementById('ot_hours').innerHTML=_hours+'小时'
            }
            else{
              _hours=parseInt(_hours)+(24*60);
              //$scope.ot_app_data.ot_hours=_hours;
              //document.getElementById('ot_hours').innerHTML=_hours+'小时'
            }
            var min=_hours;
            essOtApplySev.get_ot_hours_normal(min,$scope.ot_app_data.ot_valid_min,$scope.ot_app_data.ot_min_unit,$scope);
          }
        }
      })
    }


$scope.time_list_ot_apply=essOtApplySev.getTimeList();




    var card_times=''
    $scope.saveApply = function(){

  if($scope.time_list_ot_apply.length==0){
    card_times=$scope.ot_app_data.card_times;
  }
      else{
    card_times=$scope.time_list_ot_apply.length+1;
  }
      if (typeof($stateParams.task_id) != 'undefined') {

        //essOtApplyModifySev.saveApply($scope.select_user_id, $scope.select_notify_id);
        essOtApplySev.saveModifyApply($scope.select_user_id,$scope.select_notify_id,card_times,'2');
      }
      else{
        essOtApplySev.saveApply($scope.select_user_id,$scope.select_notify_id,card_times,'2');
      }

    }

    $scope.add_time=function(){

      $location.path('home_page/home_menulist/add_time');
    }
    $scope.search_control={};
    $scope.search_control.search_val = '';
    $scope.ess_empl_data = [];
    $scope.select_user_id = '';
    $scope.select_notify_id = '';
    $scope.click_flag = 0;
    $scope.essItemCk = function(user_id,img,en,_flag){
      if(_flag == true){
        $scope.ess_empl_data.num_checked =  $scope.ess_empl_data.num_checked + 1;
      }else{
        $scope.ess_empl_data.num_checked =  $scope.ess_empl_data.num_checked - 1;
      }
      var _d = [];
      if($scope.click_flag == 0){
        $scope.select_user_id = user_id;
        _d = $scope.ot_app_data.approver_list;
      }else{
        return;
      }
      var flag = 0;
      var _len = _d.length;
      for(var i=0;i<_len;i++){
        if(angular.isDefined(_d[i].flag)&&_d[i].flag==1){
          flag = 1;
          break;
        }
      }
      if(flag == 0){
        _d.push({
          img:img,
          name:en,
          user_id:user_id,
          flag:1
        })
      }else{
        _d[_len-1] = {
          img:img,
          name:en,
          user_id:user_id,
          flag:1
        }
      }
      $scope.closeModal();
   $scope.ot_app_data._approver_list=_d;
      $scope.search_control.search_val = '';
    }
    $scope.delete_notify=function(user_id){
      $('#essOtApply #notify_list_div').addClass('notify_list_active');
      if($scope.select_notify_id.indexOf(',')==-1){
        $scope.select_notify_id=$scope.select_notify_id.replace(user_id,'');
      }
      else if($scope.select_notify_id.indexOf(user_id+',')==-1){
        $scope.select_notify_id=$scope.select_notify_id.replace(','+user_id,'');
      }
      else{
        $scope.select_notify_id=$scope.select_notify_id.replace(user_id+',','');
      }
      for(var i=0;i<$scope.ot_app_data.notify_list.length;i++){
        if($scope.ot_app_data.notify_list[i].user_id==user_id){
          $scope.ot_app_data.notify_list.splice(i,1);
        }
      }
      setTimeout(function(){
        document.getElementById('notify_list_div').style.width=($scope.ot_app_data.notify_list.length+1)*100+20+'px';
        $ionicScrollDelegate.$getByHandle("notify_list_scroll").resize();
      },350)


    }
    $scope.delete_approver=function(user_id){
      if(!$scope.ot_app_data.approver_list_flag){
        return;
      }
      $('#essOtApply #approver_list_div').addClass('approver_list_active');
      $scope.ot_app_data._approver_list=[];
      $scope.select_user_id=''
    }

    $scope.selectList = function(){
      if($scope.click_flag==1){
        var _d = [];
        $scope.select_notify_id = '';
        $scope.ot_app_data.notify_list = [];
        for(var i=0;i<$scope.ess_empl_data.length;i++){
          if($scope.ess_empl_data[i].ck){
            $scope.select_notify_id = $scope.select_notify_id + ($scope.ess_empl_data)[i].user_id+',';
            $scope.ot_app_data.notify_list.push({
              img:($scope.ess_empl_data)[i].img,
              name:($scope.ess_empl_data)[i].en,
              user_id:($scope.ess_empl_data)[i].user_id,
              flag:1
            });
          }
        }
        $scope.select_notify_id = ($scope.select_notify_id).substring(0,$scope.select_notify_id.length-1);
        $scope.closeModal();
      }
      document.getElementById('notify_list_div').style.width=($scope.ot_app_data.notify_list.length+1)*100+20+'px';
      //alert($scope.lv_app_data.notify_list.length);
      $scope.search_control.search_val = '';
      $ionicScrollDelegate.$getByHandle("notify_list_scroll").resize();
    }

    $ionicModal.fromTemplateUrl('ess-empl-modal.html', {
      scope: $scope,
      animation: 'slide-in-up'
    }).then(function(modal) {
      $scope.modal = modal;
    });

	/*
    $scope.openModal = function() {
      $('#essOtApply #approver_list_div').removeClass('approver_list_active');
      $scope.search_val = '';
      $scope.click_flag = 0;
      $scope.ess_empl_data = [];
      essOtApplySev.loadEssEmplData($scope.select_user_id,$scope.ot_app_data.employee_no,'');
      $scope.ess_empl_data = essOtApplySev.getEssEmplData();
      $scope.modal.show();
    };
    $scope.openModal2 = function() {
      $('#essOtApply #notify_list_div').removeClass('notify_list_active');
      $scope.search_val = '';
      $scope.click_flag = 1;
      $scope.ess_empl_data = [];
      essOtApplySev.loadEssEmplData($scope.select_notify_id,$scope.ot_app_data.employee_no,'');
      $scope.ess_empl_data = essOtApplySev.getEssEmplData();
      $scope.modal.show();
    };
	*/

	$scope.openModal = function() {

		var selectEmplList = '';
		if ($scope.ot_app_data._approver_list.length != 0){
			selectEmplList = $scope.ot_app_data._approver_list[0].employee_no;
		}

		$emplComponentService.open({
			title : '选择审批人', //弹开窗口标题
			barTitle : window.localStorage["org_top_level"],//导航开头
			isSingleSelect:true,//是否单选
			isShowContact:true,//是否展示常用联系人
			isNeedSaveContact:true,//是否保存常用联系人
			extName : '员工', //多选时提示后缀名
			selectEmplList:selectEmplList, //打开窗口默认选中员工列表
			/*
			params:{ //支持可用扩展参数
				"is_permissions":"0",
				"is_process":"0",
				"process_instance":'0',
				"ext_param":"aa"
			},
			*/
			sure : function (rd) { //返回数据，数组格式

				$('#essOtApply #approver_list_div').removeClass('approver_list_active');
				$scope.select_user_id = rd[0].user_id;
				$scope.ot_app_data._approver_list = [];
				$scope.ot_app_data._approver_list.push({
				  img:rd[0].img_src,
				  name:rd[0].empl_name,
				  user_id:rd[0].user_id,
				  employee_no:rd[0].empl_no,
				  flag:1
				});
				//$scope.approver_list=$scope.ot_app_data.approver_list;
			}
		});

    }

    $scope.openModal2 = function() {
		var selectEmplList = '';
		if ($scope.ot_app_data.notify_list.length != 0){
			for (var i=0;i<$scope.ot_app_data.notify_list.length;i++){
				selectEmplList += $scope.ot_app_data.notify_list[i].employee_no;
				if (i < $scope.ot_app_data.notify_list.length - 1){
					selectEmplList += ',';
				}
			}

		}

		$emplComponentService.open({
			title : '选择知会人', //弹开窗口标题
			barTitle : window.localStorage["org_top_level"],//导航开头
			isSingleSelect:false,//是否单选
			isShowContact:true,//是否展示常用联系人
			isNeedSaveContact:true,//是否保存常用联系人
			extName : '员工', //多选时提示后缀名
			selectEmplList:selectEmplList, //打开窗口默认选中员工列表
			/*
			params:{ //支持可用扩展参数
				"is_permissions":"0",
				"is_process":"0",
				"process_instance":'0',
				"ext_param":"aa"
			},
			*/
			sure : function (rd) { //返回数据，数组格式
				$('#essOtApply #notify_list_div').removeClass('notify_list_active');
				$scope.select_notify_id = '';
				$scope.ot_app_data.notify_list = [];
				for(var i=0;i<rd.length;i++){

					$scope.select_notify_id = $scope.select_notify_id + rd[i].user_id;
					$scope.ot_app_data.notify_list.push({
					  img:rd[i].img_src,
					  name:rd[i].empl_name,
					  user_id:rd[i].user_id,
					  employee_no:rd[i].empl_no,
					  flag:1
					});
					if (i < rd.length - 1){
						$scope.select_notify_id += ',';
					}
				}

				document.getElementById('notify_list_div').style.width=($scope.ot_app_data.notify_list.length+1)*100+20+'px';
				$ionicScrollDelegate.$getByHandle("notify_list_scroll").resize();
			}
		});

    }


    $scope.closeModal = function() {
      $scope.modal.hide();
      $scope.ess_empl_data = [];
      $scope.search_control.search_val = '';
    };
    $scope.$on('$destroy', function() {
      $scope.modal.remove();
    });

    $scope.first_in_need_clock_click=function(flag){
      flag=!flag;
      $scope.ot_app_data.first_in_need_clock=flag;
    };
    $scope.first_out_need_clock_click=function(flag){
      flag=!flag;
      $scope.ot_app_data.first_out_need_clock=flag;
    };
    $scope.second_in_need_clock_click=function(flag){
      flag=!flag;
      $scope.ot_app_data.second_in_need_clock=flag;
    };
    $scope.second_out_need_clock_click=function(flag){
      flag=!flag;
      $scope.ot_app_data.second_out_need_clock=flag;
    };
    $scope.ot_in_need_clock_click=function(flag){
      flag=!flag;
      $scope.ot_app_data.ot_in_need_clock=flag;
    };
    $scope.ot_out_need_clock_click=function(flag){
      flag=!flag;
      $scope.ot_app_data.ot_out_need_clock=flag;
    };
  })



  .controller('addTimeCtrl',function($scope,essOtApplySev,$ionicModal,$ionicActionSheet,$location,timeSelect,$ionicScrollDelegate,$ionicPopup){
    $scope.dates_line2x = local_resource + 'img/model/dates-line2x.png';
    $scope.dates_line3x = local_resource + 'img/model/dates-line2x.png';
    $scope.add_approver = local_resource + 'img/model/add_approver.png';
    $scope.add_approver_ = local_resource + 'img/model/add_approver_.png';
    $scope.dates_line4x = local_resource + 'img/model/dates-line2x.png';
    $scope.img_upload_file_part1 = local_resource+'img/icon/add.png';
    $scope.img_upload_file_part2 = local_resource+'img/icon/new_2.png';
    $scope.contract_management_directory1 = local_resource + 'img/icon/contract_management_directory1.png';
    $scope.delete_icon= local_resource+'img/icon/delete_icon.png';
    $scope.add_icon=local_resource+'img/icon/add_icon.png';

    $scope.start_ot_icon=local_resource+'img/icon/start_ot_icon.png';
    $scope.end_ot_icon=local_resource+'img/icon/end_ot_icon.png';
    $scope.start_rest_icon=local_resource+'img/icon/start_rest_icon.png';
    $scope.end_rest_icon=local_resource+'img/icon/end_rest_icon.png';
    $scope.ot_hours_icon=local_resource+'img/icon/ot_hours_icon.png';


    //essOtApplySev.loadData();
    $scope.ot_app_data = essOtApplySev.getData();

    //初始化add_time页面用到的first_in, last_out参数
    $scope.ot_app_data.add_time_first_in = $scope.ot_app_data.first_in;
    if ($scope.ot_app_data.fifth_in != ''){
      $scope.ot_app_data.add_time_last_out = $scope.ot_app_data.fifth_out;
      $scope.ot_app_data.add_time_last_out_need_clock = $scope.ot_app_data.fifth_out_need_clock;
    }
    else if ($scope.ot_app_data.forth_in != ''){
      $scope.ot_app_data.add_time_last_out = $scope.ot_app_data.forth_out;
      $scope.ot_app_data.add_time_last_out_need_clock = $scope.ot_app_data.forth_out_need_clock;
    }
    else if ($scope.ot_app_data.third_in != ''){
      $scope.ot_app_data.add_time_last_out = $scope.ot_app_data.third_out;
      $scope.ot_app_data.add_time_last_out_need_clock = $scope.ot_app_data.third_out_need_clock;
    }
    else if ($scope.ot_app_data.second_in != ''){
      $scope.ot_app_data.add_time_last_out = $scope.ot_app_data.second_out;
      $scope.ot_app_data.add_time_last_out_need_clock = $scope.ot_app_data.second_out_need_clock;
    }
    else {
      $scope.ot_app_data.add_time_last_out = $scope.ot_app_data.first_out;
      $scope.ot_app_data.add_time_last_out_need_clock = $scope.ot_app_data.first_out_need_clock;
    }

    $scope.add_time_list=[];
    //初始化休息段的数组
    if ($scope.ot_app_data.second_in != '') {
      $scope.add_time_list.push({
        name:'',
        in:$scope.ot_app_data.first_out,
        in_need_clock:$scope.ot_app_data.first_out_need_clock,
        out:$scope.ot_app_data.second_in,
        out_need_clock:$scope.ot_app_data.second_in_need_clock,
        is_need: true
      })
    }
    if ($scope.ot_app_data.third_in != '') {
      $scope.add_time_list.push({
        name:'',
        in:$scope.ot_app_data.second_out,
        in_need_clock:$scope.ot_app_data.second_out_need_clock,
        out:$scope.ot_app_data.third_in,
        out_need_clock:$scope.ot_app_data.third_in_need_clock,
        is_need: true
      })
    }
    if ($scope.ot_app_data.forth_in != '') {
      $scope.add_time_list.push({
        name:'',
        in:$scope.ot_app_data.third_out,
        in_need_clock:$scope.ot_app_data.third_out_need_clock,
        out:$scope.ot_app_data.forth_in,
        out_need_clock:$scope.ot_app_data.forth_in_need_clock,
        is_need: true
      })
    }
    if ($scope.ot_app_data.fifth_in != '') {
      $scope.add_time_list.push({
        name:'',
        in:$scope.ot_app_data.forth_out,
        in_need_clock:$scope.ot_app_data.forth_out_need_clock,
        out:$scope.ot_app_data.fifth_in,
        out_need_clock:$scope.ot_app_data.fifth_in_need_clock,
        is_need: true
      })
    }

    if($scope.ot_app_data.second_in!=''){
      document.getElementById('add_time_check').checked=true;
    }
    else{
      document.getElementById('add_time_check').checked=false;
    }

var card_times=$scope.ot_app_data.card_times;


    $scope.delete=function(item){
      var idx =  $scope.add_time_list.indexOf(item);
      $scope.add_time_list.splice(idx,1);
      if($scope.add_time_list.length=='0'){
        card_times=$scope.ot_app_data.card_times;
      }
      else{
        card_times=$scope.add_time_list.length+1;
      }

      var v=0;
      for(var j=0;j<$scope.add_time_list.length;j++){
        if($scope.add_time_list[j].in=='请选择'||$scope.add_time_list[j].out=='请选择'){
          v++;
        }
      }
      if(v==0){
        essOtApplySev.add_time_save($scope.add_time_list,$scope,false,'3',card_times);
      }




    }
    $scope.add=function(item){
      if( $scope.add_time_list.length==0){
        $scope.add_time_list.push({
          name:'',
          in:'请选择',
          in_need_clock:$scope.ot_app_data.first_out_need_clock,
          out:'请选择',
          out_need_clock:$scope.ot_app_data.second_in_need_clock,
          is_need:''
        })
        $scope.ot_app_data.last_out_need_clock=$scope.ot_app_data.second_out_need_clock;
      }
      else if( $scope.add_time_list.length==1){
        $scope.add_time_list.push({
          name:'',
          in:'请选择',
          in_need_clock:$scope.ot_app_data.second_out_need_clock,
          out:'请选择',
          out_need_clock:$scope.ot_app_data.third_in_need_clock,
          is_need:''
        })
        $scope.ot_app_data.last_out_need_clock=$scope.ot_app_data.third_out_need_clock;
      }
      else if( $scope.add_time_list.length==2){
        $scope.add_time_list.push({
          name:'',
          in:'请选择',
          in_need_clock:$scope.ot_app_data.third_out_need_clock,
          out:'请选择',
          out_need_clock:$scope.ot_app_data.forth_in_need_clock,
          is_need:''
        })
        $scope.ot_app_data.last_out_need_clock=$scope.ot_app_data.forth_out_need_clock;
      }
      else if( $scope.add_time_list.length==3){
        $scope.add_time_list.push({
          name:'',
          in:'请选择',
          in_need_clock:$scope.ot_app_data.forth_out_need_clock,
          out:'请选择',
          out_need_clock:$scope.ot_app_data.fifth_in_need_clock,
          is_need:''
        })
        $scope.ot_app_data.last_out_need_clock=$scope.ot_app_data.fifth_out_need_clock;
      }

      setTimeout(function(){ $ionicScrollDelegate.resize(); }, 200);
      if($scope.add_time_list.length=='0'){
        card_times=$scope.ot_app_data.card_times;
      }
      else{
        card_times=$scope.add_time_list.length+1;
      }
    }

    $scope.showTime_in = function(i){

      if( $scope.add_time_list[i].in=='请选择'){
        $scope.add_time_list[i].defaultDate='00:00';
      }
      else{
        $scope.add_time_list[i].defaultDate=$scope.add_time_list[i].in
      }
      timeSelect.show({
        type :  'time',
        startDate :'1993年12月01日',
        endDate : '',
        defaultDate: $scope.add_time_list[i].defaultDate,
        returnDateType : 'hm',
        returnTimeType :  '24h'||'AMPM',
        //stepping :10,
        selectedFunc : function (date) {
          if (typeof(date) != 'undefined'){
            $scope.add_time_list[i].in = date;
            var v=0;
            for(var j=0;j<$scope.add_time_list.length;j++){
              if($scope.add_time_list[j].in=='请选择'||$scope.add_time_list[j].out=='请选择'){
                v++;
              }
            }
            if(v==0){
              essOtApplySev.add_time_save($scope.add_time_list,$scope,false,'3',card_times);
            }

          }
        }
      })
    }
    $scope.showTime_out = function(i){
      if( $scope.add_time_list[i].out=='请选择'){
        $scope.add_time_list[i].defaultDate='00:00';
      }
      else{
        $scope.add_time_list[i].defaultDate=$scope.add_time_list[i].out
      }
      timeSelect.show({
        type :  'time',
        startDate :'1993年12月01日',
        endDate : '',
        defaultDate: $scope.add_time_list[i].defaultDate,
        returnDateType : 'hm',
        returnTimeType :  '24h'||'AMPM',
        //stepping :10,
        selectedFunc : function (date) {
          if (typeof(date) != 'undefined'){
            $scope.add_time_list[i].out = date;
            var v=0;
            for(var j=0;j<$scope.add_time_list.length;j++){
              if($scope.add_time_list[j].in=='请选择'||$scope.add_time_list[j].out=='请选择'){
                v++;
              }
            }
            if(v==0){
              essOtApplySev.add_time_save($scope.add_time_list,$scope,false,'3',card_times);
            }
          }
        }
      })
    }
    $scope.show_time_first_in = function(){
      timeSelect.show({
        type :  'time',
        startDate :'1993年12月01日',
        endDate : '',
        defaultDate: $scope.ot_app_data.add_time_first_in,
        returnDateType : 'hm',
        returnTimeType :  '24h'||'AMPM',
        //stepping :10,
        selectedFunc : function (date) {
          if (typeof(date) != 'undefined'){
            $scope.ot_app_data.add_time_first_in = date;
            var v=0;
            for(var i=0;i<$scope.add_time_list.length;i++){
              if($scope.add_time_list[i].in=='请选择'||$scope.add_time_list[i].out=='请选择'){
                v++;
              }
            }
            if(v==0){
              essOtApplySev.add_time_save($scope.add_time_list,$scope,false,'3',card_times);
            }
          }
        }
      })
    }
    $scope.show_time_last_out = function(i){
      timeSelect.show({
        type :  'time',
        startDate :'1993年12月01日',
        endDate : '',
        defaultDate: $scope.ot_app_data.add_time_last_out,
        returnDateType : 'hm',
        returnTimeType :  '24h'||'AMPM',
        //stepping :10,
        selectedFunc : function (date) {
          if (typeof(date) != 'undefined'){
            $scope.ot_app_data.add_time_last_out = date;
            var v=0;
            for(var i=0;i<$scope.add_time_list.length;i++){
              if($scope.add_time_list[i].in=='请选择'||$scope.add_time_list[i].out=='请选择'){
                v++;
              }
            }
            if(v==0){
              essOtApplySev.add_time_save($scope.add_time_list,$scope,false,'3',card_times);
            }
          }
        }
      })
    }
  //
    var new_arr_add_time_list=[];
    $scope.add_time_check=function(){

      if(document.getElementById('add_time_check').checked){
        document.getElementById('add_time_check').checked=false;
        document.getElementById('add_time_repeat_content').style.display='none';
        new_arr_add_time_list=$scope.add_time_list;
        $scope.add_time_list=[];
        card_times=$scope.add_time_list.length+1;

        var v=0;
        for(var i=0;i<$scope.add_time_list.length;i++){
          if($scope.add_time_list[i].in=='请选择'||$scope.add_time_list[i].out=='请选择'){
            v++;
          }
        }
        if(v!=0){
        }
        else {
          essOtApplySev.add_time_save($scope.add_time_list, $scope, false, '3', card_times);
        }

      }
      else{
      document.getElementById('add_time_check').checked=true;
        document.getElementById('add_time_repeat_content').style.display='block';
        if(new_arr_add_time_list.length!=0){
          $scope.add_time_list=new_arr_add_time_list;
          card_times=$scope.add_time_list.length+1;
          var v=0;
          for(var i=0;i<$scope.add_time_list.length;i++){
            if($scope.add_time_list[i].in=='请选择'||$scope.add_time_list[i].out=='请选择'){
              v++;
            }
          }
          if(v!=0){
            //alert('非法!');
          }
          else {
            essOtApplySev.add_time_save($scope.add_time_list, $scope, false, '3', card_times);
          }
        }
        else{
          $scope.add();
        }
      }
    }
  $scope.add_time_save=function(){
 //console.log
    if(document.getElementById("add_time_submit").style.opacity!=1){
      return;
    }
    var v=0;
    for(var i=0;i<$scope.add_time_list.length;i++){
      if($scope.add_time_list[i].in=='请选择'||$scope.add_time_list[i].out=='请选择'){
        v++;
      }
    }
if(v!=0){
  $ionicPopup.alert({
    title: '运行结果',
    template: '<div style="text-align: center;">请选择休息时间</div>',
    okText: '确定'
  })
}
    else{
  essOtApplySev.add_time_save($scope.add_time_list,$scope,true,'1',card_times);
}
  }
  })

  .controller('essMyOtApplyDCtrl',function($scope,essMyOtApplyDSev,essLvApplySev,$stateParams,$ionicModal,$location,$ionicScrollDelegate,$ionicNavBarDelegate,$ionicHistory,$timeout){

    //$scope.$on("$ionicView.enter", function () {
    //  //解决 进入明细页面back回来的时候 会再次loaddata
    //  if (typeof($scope.data_loaded) != 'undefined'){
    //    return;
    //  }
    //  else {
    //    $scope.data_loaded = true;
    //  }
    //  essMyOtApplyDSev.clearData();
    //  essMyOtApplyDSev.loadData($stateParams.type,'UC');
    //  //essMyOtApplyDSev.loadOtherData($stateParams.type,'C');
    //  $scope.ess_my_applyD_data = essMyOtApplyDSev.getData();
    //
    //
    //});
    if (ionic.Platform.isIOS()) {
      essMyOtApplyDSev.clearData();
      essMyOtApplyDSev.loadData($stateParams.type,'UC');
      $scope.ess_my_applyD_data = essMyOtApplyDSev.getData();
    } else {
      $scope.$on("$ionicView.enter", function () {
        //解决 进入明细页面back回来的时候 会再次loaddata
        if (typeof($scope.data_loaded) != 'undefined') {
          return;
        }
        else {
          $scope.data_loaded = true;
        }
        essMyOtApplyDSev.clearData();
        essMyOtApplyDSev.loadData($stateParams.type,'UC');
        $scope.ess_my_applyD_data = essMyOtApplyDSev.getData();
      });
    }
	 // essMyOtApplyDSev.clearData();
    //essMyOtApplyDSev.loadData($stateParams.type,'UC');
    //$scope.ess_my_applyD_data = essMyOtApplyDSev.getData();

    $scope.search_control = essMyOtApplyDSev.getSearchValue();

    $scope.show_search = false;
    $scope.toggle_search = function() {
      $scope.show_search = true;
      $ionicScrollDelegate.scrollTop();
    }
    $scope.cancel_search = function() {
      $scope.show_search = false;
      $scope.search_control.search_val = '';
    }

    //$scope._flag = "未完成";
    //
    $scope.noapprove_click=function(){
      //$scope._flag = "未完成";

      document.getElementById('my_apply_details_noapprove').style.color='#53afff';
      document.getElementById('my_apply_details_approved').style.color='#808080';
      document.getElementById('ess_my_apply_details_tab_animate_div').style.webkitTransform='translateX(0)';
      document.getElementById('ess_my_apply_details_wrap').style.webkitTransform='translateX(0)';

      //essMyOtApplyDSev.loadData($stateParams.type,'UC');
      document.getElementById('ess_my_apply_details_wrap').style.overflow="visible";
      document.getElementById('ess_my_apply_details_noapprove_div').setAttribute("style","width:50%;");
      document.getElementById('ess_my_apply_details_approved_div').setAttribute("style","width: 50%;position: absolute;left:50%;top:0px;");
        $timeout(function(){ $ionicScrollDelegate.resize();
          document.getElementById('ess_my_apply_details_wrap').style.overflow="hidden";
        }, 200);



    }
    $scope.approved_click=function(){
      //$scope._flag = "已完成";

      document.getElementById('my_apply_details_noapprove').style.color='#808080';
      document.getElementById('my_apply_details_approved').style.color='#53afff';
      document.getElementById('ess_my_apply_details_tab_animate_div').style.webkitTransform='translateX(100%)';
      document.getElementById('ess_my_apply_details_wrap').style.webkitTransform='translateX(-50%)';
      document.getElementById('ess_my_apply_details_wrap').style.overflow="visible";
      document.getElementById('ess_my_apply_details_noapprove_div').setAttribute("style","width:50%;position: absolute;left:0px;top:0px;");
      document.getElementById('ess_my_apply_details_approved_div').setAttribute("style","width: 50%;float: right");
        $timeout(function(){ $ionicScrollDelegate.resize();
          document.getElementById('ess_my_apply_details_wrap').style.overflow="hidden";
        }, 200);



      //essMyOtApplyDSev.loadData($stateParams.type,'C');
    }
    $scope.loadMyApplyContent=function(p_inst,show_type,task_id,ot_code_n,s_t,is_process,it_date){
      var ot_date=it_date.split("/");
      ot_date=ot_date.toString();
       ot_date=ot_date.replace(/,/g,'-');
      $location.path("home_page/ess_my_ot_apply_details_content/"+p_inst+"/"+show_type+"/"+task_id+"/"+ot_code_n+"/"+s_t+"/"+is_process+"/"+ot_date+"/my_apply");
    }


  })


  .controller('essMyOtApprovalDCtrl',function($scope,essMyApprovalDSev,essLvApplySev,$stateParams,$ionicModal,$location,$ionicScrollDelegate){
    $scope.ess_my_approval_details_title=$stateParams.name +"审批";
    //essMyApprovalDSev.loadData($stateParams.type,$scope);
    //$scope.ess_my_approvalD_data = essMyApprovalDSev.getData();
    //$scope._flag='待处理';
    $scope.noapprove_click=function(){
      //$scope._flag='待处理';
      document.getElementById("my_apply_details_noapprove").style.color="#3ba5ff";
      document.getElementById("my_apply_details_noapprove").style.borderBottom="1px solid #3ba5ff";
      document.getElementById("my_apply_details_approved").style.color="black";
      document.getElementById("my_apply_details_approved").style.borderBottom="1px solid #f5f5f5";
      setTimeout(function(){ $ionicScrollDelegate.resize(); }, 200);
    }
    $scope.approved_click=function(){
      //$scope._flag='已处理';
      document.getElementById("my_apply_details_approved").style.color="#3ba5ff";
      document.getElementById("my_apply_details_approved").style.borderBottom="1px solid #3ba5ff";
      document.getElementById("my_apply_details_noapprove").style.color="black";
      document.getElementById("my_apply_details_noapprove").style.borderBottom="1px solid #f5f5f5";

      setTimeout(function(){ $ionicScrollDelegate.resize(); }, 200);
    }
    //
    //
    //$scope.loadMyApplyContent=function(p_inst,show_type,task_id,my_app_result){
    //
    //  if(my_app_result=="待处理"){
    //    my_app_result="UC";
    //  }
    //  else{
    //    my_app_result="C";
    //  }
    //  $location.path("home_page/ess_my_approval_details_content/"+p_inst+"/"+show_type+"/"+task_id+"/"+my_app_result);
    //}

  })



  .controller('essMyOtApplyDetailsContentCtrl',function($scope,essMyOtApplyDetailsContentSev,essLvApplySev,$stateParams,$ionicModal,$ionicActionSheet,$location,$ionicPopup,$timeout){
    $scope.dates_line2x = local_resource + 'img/model/dates-line2x.png';
    $scope.icon_apply = local_resource + 'img/model/icon-apply@2x.png';
    $scope.approval_line = local_resource + 'img/model/approval-line@2x.png';
    $scope.icon_confirm = local_resource + 'img/model/icon-confirm@2x.png';
    $scope.icon_noappprove = local_resource + 'img/model/icon-noapprove.png';
    $scope.approval_line_gray = local_resource + 'img/model/approval-line-gray@2x.png';
    $scope.icon_waiting = local_resource + 'img/model/wait_approval.png';
    $scope.icon_wait = local_resource + 'img/model/icon-waiting@2x.png';
    $scope.icon_noapprove =local_resource +'img/model/icon-noapprove.png';
    $scope.approval_line_gray = local_resource + 'img/model/approval-line-gray@2x.png';
    $scope.add_approver = local_resource + 'img/model/add_approver.png';
    $scope.add_approver_ = local_resource + 'img/model/add_approver_.png';
    $scope.notify = local_resource + 'img/icon/notify.png';
    $scope.content_left_icon= local_resource + 'img/icon/content-left-icon.png';
    $scope.contract_management_directory1 = local_resource + 'img/icon/contract_management_directory1.png';
    $scope.start_ot_icon=local_resource+'img/icon/start_ot_icon.png';
    $scope.end_ot_icon=local_resource+'img/icon/end_ot_icon.png';
    $scope.start_rest_icon=local_resource+'img/icon/start_rest_icon.png';
    $scope.end_rest_icon=local_resource+'img/icon/end_rest_icon.png';
    $scope.ot_hours_icon=local_resource+'img/icon/ot_hours_icon.png';
    $scope.ot_code_n=$stateParams.ot_code_n;
	  essMyOtApplyDetailsContentSev.clearData();

    if($stateParams.is_process==1){
      essMyOtApplyDetailsContentSev.loadData($stateParams.p_inst,$stateParams.show_type,$stateParams.task_id);
    }
    else{
      essMyOtApplyDetailsContentSev.loadNoprocessData($stateParams.show_type,$stateParams.it_date);
    }

    $scope.ess_my_applyDC_data = essMyOtApplyDetailsContentSev.getData();
    var my_app_result='';
    if($stateParams.s_t=='未完成'){
      my_app_result='UC';
    }
    else{
      my_app_result='C';
    }


    $scope.time_list_ot_apply=essMyOtApplyDetailsContentSev.getTimeList();


    $scope.fireEvent = function(i,arr){
      $timeout(function(){
        if(arr[i].action=='拒绝'){
          document.getElementById("approver_list_img"+i).src=$scope.icon_noapprove;
        }
        else if(arr[i].action=='批准'){
          document.getElementById("approver_list_img"+i).src=$scope.icon_confirm;
        }
        if(i==(arr.length-1)){
          document.getElementById("approver_list_img_"+i).style.display="none";
        }
        if(document.getElementById("approver_list_img_"+i)!=null){
          document.getElementById("approver_list_img_"+i).style.height=document.getElementById("approver_list_div" + i).offsetHeight+'px';
          document.getElementById("approver_list_div_"+i).style.height=(document.getElementById("approver_list_div" + i).offsetHeight-16)+'px';
        }

      }, 0);
    }
    $scope.show_img=function(url){
      if (ionic.Platform.isIOS()) {
        window.open(url, '_system', 'enableViewportScale=yes');
      } else {
        window.open(url, '_system');
      }
    }


    $scope.changeEssLvPolicy = function(){
      essMyApplyDetailsContentSev.changeEssLvPolicy($scope.ess_my_applyDC_data.default_lv_code_id);
    }

    $scope.search_val = '';
    $scope.ess_empl_data = [];
    $scope.select_user_id = '';
    $scope.select_notify_id = '';
    $scope.click_flag = 0;
    $scope.essItemCk = function(user_id,img,en){
      var _d = [];
      if($scope.click_flag == 0){
        $scope.select_user_id = user_id;
        _d = $scope.ess_my_applyDC_data.approver_list;
      }else{
        return;
      }
      var _len = _d.length;
      if(_len == 0){
        _d.push({
          img:img,
          name:en,
          user_id:user_id,
          flag:2
        })
      }else{
        _d[_len-1] = {
          img:img,
          name:en,
          user_id:user_id,
          flag:2
        }
      }
      $scope.closeModal();
    }

    $scope.selectList = function(){
      if($scope.click_flag==1){
        var _d = [];
        $scope.select_notify_id = '';
        $scope.ess_my_applyDC_data.notify_list = [];
        for(var i=0;i<$scope.ess_empl_data.length;i++){
          if($scope.ess_empl_data[i].ck){
            $scope.select_notify_id = $scope.select_notify_id + ($scope.ess_empl_data)[i].user_id+',';
            $scope.ess_my_applyDC_data.notify_list.push({
              img:($scope.ess_empl_data)[i].img,
              name:($scope.ess_empl_data)[i].en,
              user_id:($scope.ess_empl_data)[i].user_id,
              flag:1
            });
          }
        }
        $scope.select_notify_id = ($scope.select_notify_id).substring(0,$scope.select_notify_id.length-1);
        $scope.closeModal();
      }
    }

    $ionicModal.fromTemplateUrl('ess-my-apply-empl-modal.html', {
      scope: $scope,
      animation: 'slide-in-up'
    }).then(function(modal) {
      $scope.modal = modal;
    });
    $scope.openModal = function() {
      $scope.search_val = '';
      $scope.click_flag = 0;
      $scope.ess_empl_data = [];
      var _d = $scope.ess_my_applyDC_data.approver_list;
      if(_d.length>0){
        var len = _d.length;
        $scope.select_user_id = _d[len-1].user_id;
      }
      essLvApplySev.loadEssEmplData($scope.select_user_id,$scope.ess_my_applyDC_data.employee_no,$scope.ess_my_applyDC_data.process_instance);
      $scope.ess_empl_data = essLvApplySev.getEssEmplData();
      $scope.modal.show();
    };
    $scope.openModal2 = function() {
      $scope.search_val = '';
      $scope.click_flag = 1;
      $scope.ess_empl_data = [];
      var _d = $scope.ess_my_applyDC_data.notify_list;
      $scope.select_notify_id='';
      for(var i=0;i<_d.length;i++){
        $scope.select_notify_id = $scope.select_notify_id + _d[i].user_id+',';
      }
      $scope.select_notify_id = $scope.select_notify_id.substring(0,$scope.select_notify_id.length-1);
      essLvApplySev.loadEssEmplData($scope.select_notify_id,$scope.ess_my_applyDC_data.employee_no,$scope.ess_my_applyDC_data.process_instance);
      $scope.ess_empl_data = essLvApplySev.getEssEmplData();
      $scope.modal.show();
    };
    $scope.closeModal = function() {
      $scope.modal.hide();
      $scope.ess_empl_data = [];
    };
    //$scope.$on('$destroy', function() {
    //  $scope.modal.remove();
    //});

    $scope.submitAction = function(action){
      essMyOtApplyDetailsContentSev.submitAction(action);
    }
    $scope.cancel= function () {
		if ($scope.ess_my_applyDC_data.action_text == '更多'){
		  var hideSheet = $ionicActionSheet.show({
			buttons: [

			  {
				text: '修改'
			  }, {
				text: '撤销'
			  }
			],

			//titleText: 'Modify your album',
			//titleText: '选择上传图片方式',
			cancelText: '取消',
			cancel: function() {
			  // add cancel code..
			},
			buttonClicked: function(index) {

			  if (index == 0) {
				if($scope.ess_my_applyDC_data.modify) {
				  $location.path("home_page/ess_my_ot_apply_details_content_modify/" + $stateParams.p_inst + "/" + $stateParams.show_type + "/" + $stateParams.task_id);
				}
				else{
				  $ionicPopup.alert({
					title : '提醒',
					template : '<div style="text-align: center;">不能修改</div>',
					okText : '确定'
				  })
				}
				return true;
			  } else if (index == 1) {
				if($scope.ess_my_applyDC_data.cancel){
				  $ionicPopup.confirm({
					template: '<div style="text-align: center;">确认要撤销吗</div>',
					cancelType:'button-dark',
					cancelText: '取消',
					okText: '确认'
				  }) .then(function(res) {
					if(res) {
					  essMyOtApplyDetailsContentSev.submitAction('Cancel',my_app_result);
					}
				  });

				}
				else{
				  $ionicPopup.alert({
					title : '提醒',
					template : '<div style="text-align: center;">不能撤销</div>',
					okText : '确定'
				  })
				}
				return true;
			  }

			  return true;


			}
		  });
		 }
		  else if ($scope.ess_my_applyDC_data.action_text == '修改'){
				  $location.path("home_page/ess_my_ot_apply_details_content_modify/" + $stateParams.p_inst + "/" + $stateParams.show_type + "/" + $stateParams.task_id);
		  }
		  else if ($scope.ess_my_applyDC_data.action_text == '撤销'){
				  $ionicPopup.confirm({
					template: '<div style="text-align: center;">确认要撤销吗</div>',
					cancelType:'button-dark',
					cancelText: '取消',
					okText: '确认'
				  }) .then(function(res) {
					if(res) {
						essMyOtApplyDetailsContentSev.submitAction('Cancel',my_app_result);
					}
				  });
		  }
		  else {
			  return;
			}

    }

  })



  .controller('essOtApplyModifyCtrl',function($scope,essOtApplySev,essOtApplyModifySev,$ionicModal,$ionicActionSheet,$location,essLvApplySev,$stateParams,timeSelect,sideSelect,$emplComponentService){
    $scope.dates_line2x = local_resource + 'img/model/dates-line2x.png';
    $scope.dates_line3x = local_resource + 'img/model/dates-line2x.png';
    $scope.add_approver = local_resource + 'img/model/add_approver.png';
    $scope.add_approver_ = local_resource + 'img/model/add_approver_.png';;
    $scope.dates_line4x = local_resource + 'img/model/dates-line2x.png';
    $scope.img_upload_file_part1 = local_resource+'img/icon/add.png';
    $scope.img_upload_file_part2 = local_resource+'img/icon/new_2.png';
    $scope.contract_management_directory1 = local_resource + 'img/icon/contract_management_directory1.png';
    $scope.ot_hours_icon=local_resource+'img/icon/ot_hours_icon.png';
	essOtApplyModifySev.clearData();
    essOtApplyModifySev.loadData($stateParams.p_inst,$stateParams.show_type,$stateParams.task_id,$scope);
    $scope.ot_app_data = essOtApplyModifySev.getData();
    $scope.add_time_list=[{name:'',in:$scope.ot_app_data.first_in,in_need_clock:$scope.ot_app_data.first_in_need_clock,out:$scope.ot_app_data.first_out,out_need_clock:$scope.ot_app_data.first_out_need_clock,is_need:$scope.ot_app_data.is_need_first},{name:'',in:$scope.ot_app_data.second_in,in_need_clock:$scope.ot_app_data.second_in_need_clock,out:$scope.ot_app_data.second_out,out_need_clock:$scope.ot_app_data.second_out_need_clock,is_need:$scope.ot_app_data.is_need_second},{name:'',in:$scope.ot_app_data.ot_in,in_need_clock:$scope.ot_app_data.ot_in_need_clock,out:$scope.ot_app_data.ot_out,out_need_clock:$scope.ot_app_data.ot_out_need_clock,is_need:$scope.ot_app_data.is_need_ot}];
    $scope.essOtPolicy=function(){

      sideSelect.show({
        type : 'ios',
        data :$scope.ot_app_data.essOtPolicy_data,
        selectIndex :  $scope.ot_app_data.essOtPolicy_data_index,
        selectedFunc : function (index) {
          if(typeof(index)!='undefined'){
            document.getElementById("essOtPolicy").innerHTML=$scope.ot_app_data.essOtPolicy_data[index].value;
            $scope.ot_app_data.essOtPolicy_data_key=$scope.ot_app_data.essOtPolicy_data[index].key;
            $scope.ot_app_data.essOtPolicy_data_index=index;
            $scope.ot_app_data.ot_code_key=$scope.ot_app_data.essOtPolicy_data_key;
            //essLvApplySev.changeessOtPolicy($scope,$scope.lv_app_data.default_lv_code_id);
            if(document.getElementById('essOtPolicy').innerHTML!='日常加班'){
              document.getElementById("time_div").style.display='none';
              document.getElementById("add_time_div").style.display='block';
              document.getElementById("div_time").style.display='block'
              essOtApplyModifySev.get_ot_hours($scope);
            }
            else{
              document.getElementById("time_div").style.display='block';
              document.getElementById("add_time_div").style.display='none';
              document.getElementById("div_time").style.display='none';

              var s_t=$scope.ot_app_data.ot_in;
              var e_t=$scope.ot_app_data.ot_out;
              s_t=s_t.split(":");
              e_t=e_t.split(":");
              var _hours=( (e_t[0]-s_t[0])*60+(e_t[1]-s_t[1]));
              if(_hours>0){

              }
              else{
                _hours=parseInt(_hours)+(24*60);
              }
              var min=_hours;

              essOtApplyModifySev.get_ot_hours_normal(min,$scope.ot_app_data.ot_valid_min,$scope.ot_app_data.ot_min_unit,$scope);

            }
          }

        }
      });
    }

    $scope.showDate_date = function(){
      timeSelect.show({
        type :  'date',
        startDate :'1993年12月01日',
        endDate : '',
        defaultDate: $scope.ot_app_data.ot_date,
        returnDateType : 'ymd',
        returnTimeType :  '24h'||'AMPM',
        //stepping :10,
        selectedFunc : function (date) {
          if (typeof(date) != 'undefined'){
            var formatted_date = date.replace('年','-');
            formatted_date = formatted_date.replace('月','-');
            formatted_date = formatted_date.replace('日','');
            $scope.ot_app_data.ot_date = formatted_date;
          }
        }
      })
    }

    $scope.showTime_ot_in = function(){
      timeSelect.show({
        type :  'time',
        startDate :'1993年12月01日',
        endDate : '',
        defaultDate:  $scope.ot_app_data.ot_in,
        returnDateType : 'hm',
        returnTimeType :  '24h'||'AMPM',
        //stepping :10,
        selectedFunc : function (date) {
          if (typeof(date) != 'undefined'){
            $scope.ot_app_data.ot_in = date;
            var s_t=$scope.ot_app_data.ot_in;
            var e_t=$scope.ot_app_data.ot_out;
            s_t=s_t.split(":");
            e_t=e_t.split(":");
            var _hours=( (e_t[0]-s_t[0])*60+(e_t[1]-s_t[1]));
            if(_hours>0){
            }
            else{
              _hours=parseInt(_hours)+(24*60);
            }
            var min=_hours;
            essOtApplySev.get_ot_hours_normal(min,$scope.ot_app_data.ot_valid_min,$scope.ot_app_data.ot_min_unit,$scope);
          }
        }
      })
    }

    $scope.showTime_ot_out = function(){
      timeSelect.show({
        type :  'time',
        startDate :'1993年12月01日',
        endDate : '',
        defaultDate:  $scope.ot_app_data.ot_out,
        returnDateType : 'hm',
        returnTimeType :  '24h'||'AMPM',
        //stepping :10,
        selectedFunc : function (date) {
          if (typeof(date) != 'undefined'){
            $scope.ot_app_data.ot_out = date;
            var s_t=$scope.ot_app_data.ot_in;
            var e_t=$scope.ot_app_data.ot_out;
            s_t=s_t.split(":");
            e_t=e_t.split(":");
            var _hours=( (e_t[0]-s_t[0])*60+(e_t[1]-s_t[1]));
            if(_hours>0){
            }
            else{
              _hours=parseInt(_hours)+(24*60);
            }
            var min=_hours;
            essOtApplySev.get_ot_hours_normal(min,$scope.ot_app_data.ot_valid_min,$scope.ot_app_data.ot_min_unit,$scope);
          }
        }
      })
    }

    $scope.changeEssLvPolicy = function(){
      //alert($scope.ot_app_data.ot_code_key);
      if(document.getElementById('ot_apply_select').value!='post_ot'){
        document.getElementById("time_div").style.display='none';
        document.getElementById("add_time_div").style.display='block';
        document.getElementById("div_time").style.display='block';
        $scope.ot_app_data.is_need_first=true;
        essOtApplyModifySev.get_ot_hours($scope);
      }
      else{
        document.getElementById("time_div").style.display='block';
        document.getElementById("add_time_div").style.display='none';
        document.getElementById("div_time").style.display='none';

        var s_t=$scope.ot_app_data.ot_in;
        var e_t=$scope.ot_app_data.ot_out;
        s_t=s_t.split(":");
        e_t=e_t.split(":");
        var _hours=( (e_t[0]-s_t[0])*60+(e_t[1]-s_t[1]));
        if(_hours>0){

        }
        else{
          _hours=parseInt(_hours)+24*60;
        }
        var min=_hours;
        essOtApplyModifySev.get_ot_hours_normal(min,$scope.ot_app_data.ot_valid_min,$scope.ot_app_data.ot_min_unit,$scope);

      }
    }


    $scope.saveApply = function(){

      essOtApplyModifySev.saveApply($scope.select_user_id,$scope.select_notify_id);

    }

    $scope.add_time=function(){
      $location.path('home_page/home_menulist/add_time_modify');

    }
    $scope.search_control={};
    $scope.search_control.search_val = '';
    $scope.ess_empl_data = [];
    $scope.select_user_id = '';
    $scope.select_notify_id = '';
    $scope.click_flag = 0;
    $scope.essItemCk = function(user_id,img,en){
      var _d = [];
      if($scope.click_flag == 0){
        $scope.select_user_id = user_id;
        _d = $scope.ot_app_data.approver_list;
      }else{
        return;
      }
      var flag = 0;
      var _len = _d.length;
      for(var i=0;i<_len;i++){
        if(angular.isDefined(_d[i].flag)&&_d[i].flag==1){
          flag = 1;
          break;
        }
      }
      if(flag == 0){
        _d.push({
          img:img,
          name:en,
          user_id:user_id,
          flag:1
        })
      }else{
        _d[_len-1] = {
          img:img,
          name:en,
          user_id:user_id,
          flag:1
        }
      }
      $scope.closeModal();
      $scope.search_control.search_val = '';
    }

    $scope.selectList = function(){
      if($scope.click_flag==1){
        var _d = [];
        $scope.select_notify_id = '';
        $scope.ot_app_data.notify_list = [];
        for(var i=0;i<$scope.ess_empl_data.length;i++){
          if($scope.ess_empl_data[i].ck){
            $scope.select_notify_id = $scope.select_notify_id + ($scope.ess_empl_data)[i].user_id+',';
            $scope.ot_app_data.notify_list.push({
              img:($scope.ess_empl_data)[i].img,
              name:($scope.ess_empl_data)[i].en,
              user_id:($scope.ess_empl_data)[i].user_id,
              flag:1
            });
          }
        }
        //$scope.select_notify_id = ($scope.select_notify_id).substring(0,$scope.select_notify_id.length-1);
        $scope.closeModal();
      }
      document.getElementById('notify_list_div').style.width=($scope.ot_app_data.notify_list.length+1)*100+20+'px';
      //alert($scope.lv_app_data.notify_list.length);
      $scope.search_control.search_val = '';
    }

    $ionicModal.fromTemplateUrl('ess-empl-modal.html', {
      scope: $scope,
      animation: 'slide-in-up'
    }).then(function(modal) {
      $scope.modal = modal;
    });

	$scope.openModal = function() {

		var selectEmplList = '';
		if ($scope.ot_app_data.approver_list.length != 0){
			selectEmplList = $scope.ot_app_data.approver_list[0].employee_no;
		}

		$emplComponentService.open({
			title : '选择审批人', //弹开窗口标题
			barTitle : window.localStorage["org_top_level"],//导航开头
			isSingleSelect:true,//是否单选
			isShowContact:true,//是否展示常用联系人
			isNeedSaveContact:true,//是否保存常用联系人
			extName : '员工', //多选时提示后缀名
			selectEmplList:selectEmplList, //打开窗口默认选中员工列表

			sure : function (rd) { //返回数据，数组格式

				$('#approver_list_div').removeClass('approver_list_active');
				$scope.select_user_id = rd[0].user_id;
				$scope.ot_app_data.approver_list = [];
				$scope.ot_app_data.approver_list.push({
				  img:rd[0].img_src,
				  name:rd[0].empl_name,
				  user_id:rd[0].user_id,
				  employee_no:rd[0].empl_no,
				  flag:1
				});
				$scope.approver_list=$scope.ot_app_data.approver_list;
			}
		});

    }

    $scope.openModal2 = function() {
		var selectEmplList = '';
		if ($scope.ot_app_data.notify_list.length != 0){
			for (var i=0;i<$scope.ot_app_data.notify_list.length;i++){
				selectEmplList += $scope.ot_app_data.notify_list[i].employee_no;
				if (i < $scope.ot_app_data.notify_list.length - 1){
					selectEmplList += ',';
				}
			}

		}

		$emplComponentService.open({
			title : '选择知会人', //弹开窗口标题
			barTitle : window.localStorage["org_top_level"],//导航开头
			isSingleSelect:false,//是否单选
			isShowContact:true,//是否展示常用联系人
			isNeedSaveContact:true,//是否保存常用联系人
			extName : '员工', //多选时提示后缀名
			selectEmplList:selectEmplList, //打开窗口默认选中员工列表

			sure : function (rd) { //返回数据，数组格式
				$('#notify_list_div').removeClass('notify_list_active');
				$scope.select_notify_id = '';
				$scope.ot_app_data.notify_list = [];
				for(var i=0;i<rd.length;i++){

					$scope.select_notify_id = $scope.select_notify_id + rd[i].user_id;
					$scope.ot_app_data.notify_list.push({
					  img:rd[i].img_src,
					  name:rd[i].empl_name,
					  user_id:rd[i].user_id,
					  employee_no:rd[i].empl_no,
					  flag:1
					});
					if (i < rd.length - 1){
						$scope.select_notify_id += ',';
					}
				}

				document.getElementById('notify_list_div').style.width=($scope.ot_app_data.notify_list.length+1)*100+20+'px';
				$ionicScrollDelegate.$getByHandle("notify_list_scroll").resize();
			}
		});

    }
	/*
    $scope.openModal = function() {
      $scope.search_val = '';
      $scope.click_flag = 0;
      $scope.ess_empl_data = [];
      essLvApplySev.loadEssEmplData($scope.select_user_id,$scope.ot_app_data.employee_no,'');
      $scope.ess_empl_data = essLvApplySev.getEssEmplData();
      $scope.modal.show();
    };
    $scope.openModal2 = function() {
      $scope.search_val = '';
      $scope.click_flag = 1;
      $scope.ess_empl_data = [];
      essOtApplySev.loadEssEmplData($scope.select_notify_id,$scope.ot_app_data.employee_no,'');
      $scope.ess_empl_data = essOtApplySev.getEssEmplData();
      $scope.modal.show();
    };
	*/
    $scope.closeModal = function() {
      $scope.modal.hide();
      $scope.ess_empl_data = [];
      $scope.search_control.search_val = '';
    };
    $scope.$on('$destroy', function() {
      $scope.modal.remove();
    });

    $scope.first_in_need_clock_click=function(flag){
      flag=!flag;
      $scope.ot_app_data.first_in_need_clock=flag;
    };
    $scope.first_out_need_clock_click=function(flag){
      flag=!flag;
      $scope.ot_app_data.first_out_need_clock=flag;
    };
    $scope.second_in_need_clock_click=function(flag){
      flag=!flag;
      $scope.ot_app_data.second_in_need_clock=flag;
    };
    $scope.second_out_need_clock_click=function(flag){
      flag=!flag;
      $scope.ot_app_data.second_out_need_clock=flag;
    };
    $scope.ot_in_need_clock_click=function(flag){
      flag=!flag;
      $scope.ot_app_data.ot_in_need_clock=flag;
    };
    $scope.ot_out_need_clock_click=function(flag){
      flag=!flag;
      $scope.ot_app_data.ot_out_need_clock=flag;
    };
  })



  .controller('essMyApprovalDOTCtrl',function($scope,essMyApprovalDOTSev,essLvApplySev,$stateParams,$ionicModal,$location,$ionicScrollDelegate,$ionicNavBarDelegate,$ionicHistory,$timeout){
    if (ionic.Platform.isIOS()) {
      essMyApprovalDOTSev.clearData();
      essMyApprovalDOTSev.loadData($stateParams.type,'UC');
      $scope.essMyApprovalDOTData = essMyApprovalDOTSev.getData();
    } else {
      $scope.$on("$ionicView.enter", function () {
        //解决 进入明细页面back回来的时候 会再次loaddata
        if (typeof($scope.data_loaded) != 'undefined') {
          return;
        }
        else {
          $scope.data_loaded = true;
        }
        essMyApprovalDOTSev.clearData();
        essMyApprovalDOTSev.loadData($stateParams.type,'UC');
        $scope.essMyApprovalDOTData = essMyApprovalDOTSev.getData();
      });
    }
    //$scope.$on("$ionicView.enter", function () {
    //  //解决 进入明细页面back回来的时候 会再次loaddata
    //  if (typeof($scope.data_loaded) != 'undefined'){
    //    return;
    //  }
    //  else {
    //    $scope.data_loaded = true;
    //  }
    //  essMyApprovalDOTSev.clearData();
    //  essMyApprovalDOTSev.loadData($stateParams.type,'UC');
    //  $scope.essMyApprovalDOTData = essMyApprovalDOTSev.getData();
    //});
    $scope.search_control = essMyApprovalDOTSev.getSearchValue();
    //$scope.search_control.search_val = "";
    $scope.show_search = false;
    $scope.toggle_search = function() {
      $scope.show_search = true;
      $ionicScrollDelegate.scrollTop();
    }
    $scope.cancel_search = function() {
      $scope.show_search = false;
      $scope.search_control.search_val = '';
    }
    $scope.address_icon= local_resource + 'img/icon/address_icon.png';
    $scope.ess_my_approval_details_title=$stateParams.name +"审批";
	 // essMyApprovalDOTSev.clearData();
    //essMyApprovalDOTSev.loadData($stateParams.type,'UC');
    ////essMyApprovalDOTSev.loadOtherData($stateParams.type,'C');
    //$scope.essMyApprovalDOTData = essMyApprovalDOTSev.getData();
    //$scope.essMyApprovalDOTOtherData = essMyApprovalDOTSev.getOtherData();
    $scope._flag="待处理";
    $scope.noapprove_click=function(){
      //essMyApprovalDOTSev.loadData($stateParams.type,'UC');
      $scope._flag="待处理";
      document.getElementById('my_apply_details_noapprove').style.color='#53afff';
      document.getElementById('my_apply_details_approved').style.color='#808080';
      document.getElementById('ess_my_apply_details_tab_animate_div').style.webkitTransform='translateX(0)';
      document.getElementById('ess_my_apply_details_wrap').style.webkitTransform='translateX(0)';
      document.getElementById('ess_my_apply_details_wrap').style.overflow="visible";
      document.getElementById('ess_my_apply_details_noapprove_div').setAttribute("style","width:50%;");
      document.getElementById('ess_my_apply_details_approved_div').setAttribute("style","width: 50%;position: absolute;left:50%;top:0px;");
      $timeout(function(){ $ionicScrollDelegate.resize();
          document.getElementById('ess_my_apply_details_wrap').style.overflow="hidden";
        }, 200);





    }
    $scope.approved_click=function(){
      //essMyApprovalDOTSev.loadData($stateParams.type,'C');
      $scope._flag="已处理";
      document.getElementById('my_apply_details_noapprove').style.color='#808080';
      document.getElementById('my_apply_details_approved').style.color='#53afff';
      document.getElementById('ess_my_apply_details_tab_animate_div').style.webkitTransform='translateX(100%)';
      document.getElementById('ess_my_apply_details_wrap').style.webkitTransform='translateX(-50%)';
      document.getElementById('ess_my_apply_details_wrap').style.overflow="visible";
      document.getElementById('ess_my_apply_details_noapprove_div').setAttribute("style","width:50%;position: absolute;left:0px;top:0px;");
      document.getElementById('ess_my_apply_details_approved_div').setAttribute("style","width: 50%;float: right");
        $timeout(function(){ $ionicScrollDelegate.resize();
          document.getElementById('ess_my_apply_details_wrap').style.overflow="hidden";
        }, 200);


    }
    $scope.loadMyApplyContent=function(p_inst,show_type,task_id,app_status,ot_code_n,is_normal_path){



      $location.path("home_page/ess_my_approval_details_content_overtime/"+p_inst+"/"+show_type+"/"+task_id+"/"+app_status+"/"+ot_code_n+"/"+is_normal_path+"/my_approval");
    }

  })

  .controller('essMyApprovalDOTCCtrl',function($emplComponentService,$scope,essMyApprovalDOTCSev,essLvApplySev,$stateParams,$ionicModal,$ionicActionSheet,$location,$timeout,$ionicPopup,sideSelect,$ionicScrollDelegate){
    $scope.ot_code_n=$stateParams.ot_code_n;

    $scope.approval_content_overtime_title='加班单审批';
    $scope.fireEvent = function(i,arr,flag){
      $timeout(function(){
        if(document.getElementById("approver_list_img_"+i)!=null){
          document.getElementById("approver_list_img_"+i).style.height=document.getElementById("approver_list_div" + i).offsetHeight+'px';
          document.getElementById("approver_list_div_"+i).style.height=(document.getElementById("approver_list_div" + i).offsetHeight-16)+'px';
        }
        //if(arr[i].flag=='1'){
        //  document.getElementById("approver_list_img_"+(i-1)).src=$scope.approval_line;
        //}
        //else if(arr[i].flag=='2'){
        //  document.getElementById("approver_list_img_"+(i-1)).src=$scope.approval_line_gray;
        //}
        if(i==arr.length-1&&flag==false){
          document.getElementById("approver_list_img_"+i).style.display="none";
        }
      }, 0);
    }
    $scope.dates_line4x = local_resource + 'img/model/dates-line2x.png';
    $scope.icon_apply = local_resource + 'img/model/icon-apply@2x.png';
    $scope.approval_line = local_resource + 'img/model/approval-line@2x.png';
    $scope.icon_confirm = local_resource + 'img/model/icon-confirm@2x.png';
    $scope.icon_noappprove = local_resource + 'img/model/icon-noapprove.png';
    $scope.approval_line_gray = local_resource + 'img/model/approval-line-gray@2x.png';
    $scope.icon_waiting = local_resource + 'img/model/wait_approval.png';
    $scope.icon_wait = local_resource + 'img/model/icon-waiting@2x.png';
    $scope.approval_line_gray = local_resource + 'img/model/approval-line-gray@2x.png';
    $scope.add_approver = local_resource + 'img/model/add_approver.png';
    $scope.add_approver_ = local_resource + 'img/model/add_approver_.png';
    $scope.approve_icon= local_resource + 'img/icon/approve_icon.png';
    $scope.map_icon=local_resource+'img/icon/map_icon.png';
    $scope.content_left_icon=local_resource+'img/icon/content-left-icon.png';
    $scope.notify = local_resource + 'img/icon/notify.png';
    $scope.contract_management_directory1 = local_resource + 'img/icon/contract_management_directory1.png';
    $scope.start_ot_icon=local_resource+'img/icon/start_ot_icon.png';
    $scope.end_ot_icon=local_resource+'img/icon/end_ot_icon.png';
    $scope.start_rest_icon=local_resource+'img/icon/start_rest_icon.png';
    $scope.end_rest_icon=local_resource+'img/icon/end_rest_icon.png';
    $scope.ot_hours_icon=local_resource+'img/icon/ot_hours_icon.png';

    var my_app_result='';
    if($stateParams.app_status=='待处理'){
      $scope.app_result=true;
      my_app_result='UC';
    }
    else{
      $scope.app_result=false;
      my_app_result='C';
    }
	essMyApprovalDOTCSev.clearData();
    $scope.time_list_ot_apply=essMyApprovalDOTCSev.getTimeList();
    essMyApprovalDOTCSev.loadData($stateParams.p_inst,$stateParams.show_type,$stateParams.task_id,my_app_result,$scope);

    $scope.ess_my_approvalDC_data = essMyApprovalDOTCSev.getData();

    //$scope.search_val = '';
    //$scope.ess_empl_data = [];
    //$scope.select_notify_id = '';
    //$scope.click_flag = 0;
    //
    //$scope.selectList = function(){
    //  if($scope.click_flag==1){
    //    var _d = [];
    //    $scope.select_notify_id = '';
    //    $scope.ess_my_applyDC_data.notify_list = [];
    //    for(var i=0;i<$scope.ess_empl_data.length;i++){
    //      if($scope.ess_empl_data[i].ck){
    //        $scope.select_notify_id = $scope.select_notify_id + ($scope.ess_empl_data)[i].user_id+',';
    //        $scope.ess_my_applyDC_data.notify_list.push({
    //          img:($scope.ess_empl_data)[i].img,
    //          name:($scope.ess_empl_data)[i].en,
    //          user_id:($scope.ess_empl_data)[i].user_id,
    //          flag:1
    //        });
    //      }
    //    }
    //    $scope.select_notify_id = ($scope.select_notify_id).substring(0,$scope.select_notify_id.length-1);
    //    $scope.closeModal();
    //  }
    //}
    //
    //$scope.select_user_id='';
    //$ionicModal.fromTemplateUrl('ess-my-apply-empl-modal.html', {
    //  scope: $scope,
    //  animation: 'slide-in-up'
    //}).then(function(modal) {
    //  $scope.modal = modal;
    //});
    //$scope.openModal = function() {
    //  $scope.search_val = '';
    //  $scope.ess_empl_data = [];
    //  essLvApplySev.loadEssEmplData($scope.select_user_id,$scope.ess_my_approvalDC_data.employee_no,$scope.ess_my_approvalDC_data.process_instance);
    //  $scope.ess_empl_data = essLvApplySev.getEssEmplData();
    //  $scope.modal.show();
    //};
    //$scope.closeModal = function() {
    //  $scope.modal.hide();
    //  $scope.ess_empl_data = [];
    //};
    ////$scope.$on('$destroy', function() {
    ////  $scope.modal.remove();
    ////});
    //$scope.essItemCk = function(user_id,img,en){
    //  var _d = [];
    //  $scope.select_user_id = user_id;
    //  _d = $scope.ess_my_approvalDC_data.approver_list;
    //  var flag = 0;
    //  var _len = _d.length;
    //  for(var i=0;i<_len;i++){
    //    if(angular.isDefined(_d[i]._flag)&&_d[i]._flag==1){
    //      flag = 1;
    //      break;
    //    }
    //  }
    //  if(flag == 0){
    //    _d.push({
    //      img:img,
    //      name:en,
    //      user_id:user_id,
    //      color:"#999",
    //      action:'下一层审批人',
    //      flag:1,
    //      _flag:1,
    //      approval_remark:'',
    //      apply_remark:''
    //    })
    //  }else{
    //    _d[_len-1] = {
    //      img:img,
    //      name:en,
    //      color:"#999",
    //      action:'下一层审批人',
    //      flag:1,
    //      user_id:user_id,
    //      _flag:1,
    //      approval_remark:'',
    //      apply_remark:''
    //    }
    //  }
    //  $scope.closeModal();
    //}


    $scope.search_control={};
    $scope.search_control.search_val = '';
    $scope.ess_empl_data = [];
    $scope.select_user_id = '';
    $scope.select_notify_id = '';
    $scope.click_flag = 0;

    $scope.essItemCk = function(user_id,img,en,_flag){
      if(_flag == true){
        $scope.ess_empl_data.num_checked =  $scope.ess_empl_data.num_checked + 1;
      }else{
        $scope.ess_empl_data.num_checked =  $scope.ess_empl_data.num_checked - 1;
      }
      var _d = [];
      if($scope.click_flag == 0){
        $scope.select_user_id = user_id;
        _d = $scope.ess_my_approvalDC_data.approver_list;
        var flag = 0;
        var _len = _d.length;
        for(var i=0;i<_len;i++){
          if(angular.isDefined(_d[i]._flag)&&_d[i]._flag==1){
            flag = 1;
            break;
          }
        }

        if(flag == 0){
          _d.push({
            img:img,
            name:en,
            user_id:user_id,
            action:'下一层审批人',
            flag:1,
            _flag:1,
            attachment:'',
            approval_remark:'',
            color:"#999"
          })
        }else{
          _d[_len-1] = {
            img:img,
            name:en,
            action:'下一层审批人',
            flag:1,
            user_id:user_id,
            _flag:1,
            attachment:'',
            approval_remark:'',
            color:"#999"
          }
        }

        $scope.closeModal();
      }else{
        var _d = [];
        if($scope.click_flag == 0){
          $scope.select_user_id = user_id;
          _d = $scope.lv_app_data.approver_list;
        }else{
          return;
        }
        var flag = 0;
        var _len = _d.length;
        for(var i=0;i<_len;i++){
          if(angular.isDefined(_d[i].flag)&&_d[i].flag==1){
            flag = 1;
            break;
          }
        }
        if(flag == 0){
          _d.push({
            img:img,
            name:en,
            user_id:user_id,
            flag:1
          })
        }else{
          _d[_len-1] = {
            img:img,
            name:en,
            user_id:user_id,
            flag:1
          }
        }
        $scope.approver_list=_d;
        $scope.search_control.search_val = '';
        $scope.closeModal();
      }

    }
    $scope.delete_notify=function(user_id){
      $('#essMyApprovalDOTC #notify_list_div').addClass('notify_list_active');
      if($scope.select_notify_id.indexOf(',')==-1){
        $scope.select_notify_id=$scope.select_notify_id.replace(user_id,'');
      }
      else if($scope.select_notify_id.indexOf(user_id+',')==-1){
        $scope.select_notify_id=$scope.select_notify_id.replace(','+user_id,'');
      }
      else{
        $scope.select_notify_id=$scope.select_notify_id.replace(user_id+',','');
      }
      for(var i=0;i<$scope.ess_my_approvalDC_data.notify_list.length;i++){
        if($scope.ess_my_approvalDC_data.notify_list[i].user_id==user_id){
          $scope.ess_my_approvalDC_data.notify_list.splice(i,1);
        }
      }
      setTimeout(function(){
        document.getElementById('notify_list_div').style.width=($scope.ess_my_approvalDC_data.notify_list.length+1)*100+20+'px';
        $ionicScrollDelegate.$getByHandle("notify_list_scroll").resize();
      },350)


    }

    $scope.selectList = function(){
      if($scope.click_flag==1){
        var _d = [];
        $scope.select_notify_id = '';
        $scope.ess_my_approvalDC_data.notify_list = [];
        for(var i=0;i<$scope.ess_empl_data.length;i++){
          if($scope.ess_empl_data[i].ck){
            $scope.select_notify_id = $scope.select_notify_id + ($scope.ess_empl_data)[i].user_id+',';
            $scope.ess_my_approvalDC_data.notify_list.push({
              img:($scope.ess_empl_data)[i].img,
              name:($scope.ess_empl_data)[i].en,
              user_id:($scope.ess_empl_data)[i].user_id,
              flag:1
            });
          }
        }
        $scope.select_notify_id = ($scope.select_notify_id).substring(0,$scope.select_notify_id.length-1);
        $scope.closeModal();
      }
      document.getElementById('notify_list_div').style.width=($scope.ess_my_approvalDC_data.notify_list.length+1)*100+20+'px';
      //alert($scope.lv_app_data.notify_list.length);

      $scope.search_control.search_val='';
      $ionicScrollDelegate.$getByHandle("notify_list_scroll").resize();
    }

    $ionicModal.fromTemplateUrl('ess-empl-modal.html', {
      scope: $scope,
      animation: 'slide-in-up'
    }).then(function(modal) {
      $scope.modal = modal;
    });
	/*
    $scope.openModal = function() {
      $scope.search_val = '';
      $scope.click_flag = 0;
      $scope.ess_empl_data = [];
      essLvApplySev.loadEssEmplData($scope.select_user_id,$scope.ess_my_approvalDC_data.employee_no,$scope.ess_my_approvalDC_data.process_instance);
      $scope.ess_empl_data = essLvApplySev.getEssEmplData();
      $scope.modal.show();
    };
    $scope.openModal2 = function() {
      $('#essMyApprovalDOTC #notify_list_div').removeClass('notify_list_active');
      $scope.search_val = '';
      $scope.click_flag = 1;
      $scope.ess_empl_data = [];
      essLvApplySev.loadEssEmplData($scope.select_notify_id,$scope.ess_my_approvalDC_data.employee_no,$scope.ess_my_approvalDC_data.process_instance);
      $scope.ess_empl_data = essLvApplySev.getEssEmplData();
      $scope.modal.show();
    };
	*/

	var routerName = '';
	if (typeof($stateParams.from_source) != 'undefined'){
		if ($stateParams.from_source == 'at_team_record'){
			routerName = 'default';
		}
		else if ($stateParams.from_source == 'my_approval'){
			routerName = 'default';
		}
		else if ($stateParams.from_source == 'home_message'){
			routerName = 'message';
		}
	}

	$scope.openModal = function() {

		var _d = [];
		_d = $scope.ess_my_approvalDC_data.approver_list;
		var flag = 0;
		var _len = _d.length;

		var flag = 0;
		for(var i=0;i<_len;i++){
		  if(angular.isDefined(_d[i]._flag)&&_d[i]._flag==1){
			flag = 1;
			break;
		  }
		}

		var selectEmplList = '';
		if (flag == 1){
			selectEmplList = _d[_len-1].employee_no;
		}

		$emplComponentService.open({
			title : '选择审批人', //弹开窗口标题
			barTitle : window.localStorage["org_top_level"],//导航开头
			isSingleSelect:true,//是否单选
			isShowContact:true,//是否展示常用联系人
			isNeedSaveContact:true,//是否保存常用联系人
			extName : '员工', //多选时提示后缀名
			selectEmplList:selectEmplList, //打开窗口默认选中员工列表
			routerName: routerName,
			sure : function (rd) { //返回数据，数组格式
				$scope.select_user_id = rd[0].user_id;

				if(flag == 0){
				  _d.push({
					employee_no:rd[0].empl_no,
					img:rd[0].img_src,
					name:rd[0].empl_name,
					user_id:rd[0].user_id,
					action:'下一层审批人',
					flag:1,
					_flag:1,
					attachment:'',
					approval_remark:'',
					color:"#999"
				  })
				}else{
				  _d[_len-1] = {
					employee_no:rd[0].empl_no,
					img:rd[0].img_src,
					name:rd[0].empl_name,
					action:'下一层审批人',
					flag:1,
					user_id:rd[0].user_id,
					_flag:1,
					attachment:'',
					approval_remark:'',
					color:"#999"
				  }
				}

			}
		});


    }

	$scope.openModal2 = function() {
		var selectEmplList = '';
		if ($scope.ess_my_approvalDC_data.notify_list.length != 0){
			for (var i=0;i<$scope.ess_my_approvalDC_data.notify_list.length;i++){
				selectEmplList += $scope.ess_my_approvalDC_data.notify_list[i].employee_no;
				if (i < $scope.ess_my_approvalDC_data.notify_list.length - 1){
					selectEmplList += ',';
				}
			}

		}

		$emplComponentService.open({
			title : '选择知会人', //弹开窗口标题
			barTitle : window.localStorage["org_top_level"],//导航开头
			isSingleSelect:false,//是否单选
			isShowContact:true,//是否展示常用联系人
			isNeedSaveContact:true,//是否保存常用联系人
			extName : '员工', //多选时提示后缀名
			selectEmplList:selectEmplList, //打开窗口默认选中员工列表
			routerName: routerName,
			/*
			params:{ //支持可用扩展参数
				"is_permissions":"0",
				"is_process":"0",
				"process_instance":'0',
				"ext_param":"aa"
			},
			*/
			sure : function (rd) { //返回数据，数组格式
				$('#notify_list_div').removeClass('notify_list_active');
				$scope.select_notify_id = '';
				$scope.ess_my_approvalDC_data.notify_list = [];
				for(var i=0;i<rd.length;i++){

					$scope.select_notify_id = $scope.select_notify_id + rd[i].user_id;
					$scope.ess_my_approvalDC_data.notify_list.push({
					  img:rd[i].img_src,
					  name:rd[i].empl_name,
					  user_id:rd[i].user_id,
					  employee_no:rd[i].empl_no,
					  flag:1
					});
					if (i < rd.length - 1){
						$scope.select_notify_id += ',';
					}
				}

				document.getElementById('notify_list_div').style.width=($scope.ess_my_approvalDC_data.notify_list.length+1)*100+20+'px';
				$ionicScrollDelegate.$getByHandle("notify_list_scroll").resize();
			}
		});

    }

    $scope.closeModal = function() {
      $scope.modal.hide();
      $scope.ess_empl_data = [];
      $scope.search_control.search_val='';
    };
    $scope.$on('$destroy', function() {
      $scope.modal.remove();
    });
    //$scope.applyReject = function(){
    //  essLvApDetailSev.applyReject($scope.select_user_id);
    //}
    //$scope.applyApprove = function(){
    //  essLvApDetailSev.applyApprove($scope.select_user_id);
    //}
    $scope.add_time=function(){
      if($stateParams.is_normal_path=='true'){
        $location.path('home_page/home_menulist/add_time_my_approval');
      }
      else{
        $location.path('home_page/add_time_my_approval_home_message');
      }


    }

    $scope.submitAction = function(action){
      essMyApprovalDOTCSev.submitAction(action);
    }
    $scope.approval_date=[{
      key:'0',
      value:'批准'
    },{
      key:'1',
      value:'驳回'
    }]
    $scope.remark_flag=true;
    $scope.approval_index=0;
    $scope.approval_or_noapproval=function(){
      sideSelect.show({
        type : 'ios',
        data :$scope.approval_date,
        selectIndex :  $scope.approval_index,
        selectedFunc : function (index) {
          if(typeof(index)!='undefined'){
            document.getElementById("approval_answer").innerHTML= $scope.approval_date[index].value;
            index== '0' ? $scope.remark_flag=true : $scope.remark_flag=false;
            $scope.approval_index=index;
          }

        }
      });
    }

    $scope.save=function(){
      if($scope.remark_flag==false&&document.getElementById('remark_textarea').value==''){
        $ionicPopup.alert({
          title: '提醒',
          template: '<div style="text-align: center;">请填写备注</div>',
          okText: '确定'
        })
      }
      else {
        if ($scope.remark_flag) {
          essMyApprovalDOTCSev.applyApprove($scope.select_user_id,$scope.select_notify_id,my_app_result,$stateParams.from_source);
        }
        else {
          essMyApprovalDOTCSev.applyReject($scope.select_user_id,$scope.select_notify_id,my_app_result,$stateParams.from_source);
        }
      }
    }
    $scope.first_in_need_clock_click=function(flag){
      flag=!flag;
      $scope.ess_my_approvalDC_data.first_in_need_clock=flag;
    };
    $scope.first_out_need_clock_click=function(flag){
      flag=!flag;
      $scope.ess_my_approvalDC_data.first_out_need_clock=flag;
    };
    $scope.second_in_need_clock_click=function(flag){
      flag=!flag;
      $scope.ess_my_approvalDC_data.second_in_need_clock=flag;
    };
    $scope.second_out_need_clock_click=function(flag){
      flag=!flag;
      $scope.ess_my_approvalDC_data.second_out_need_clock=flag;
    };
    $scope.ot_in_need_clock_click=function(flag){
      flag=!flag;
      $scope.ess_my_approvalDC_data.ot_in_need_clock=flag;
    };
    $scope.ot_out_need_clock_click=function(flag){
      flag=!flag;
      $scope.ess_my_approvalDC_data.ot_out_need_clock=flag;
    };



  })

  .controller('addTimeModifyCtrl',function($scope,essOtApplyModifySev,$ionicModal,$ionicActionSheet,$location,timeSelect){
    $scope.dates_line2x = local_resource + 'img/model/dates-line2x.png';
    $scope.dates_line3x = local_resource + 'img/model/dates-line2x.png';
    $scope.add_approver = local_resource + 'img/model/add_approver.png';
    $scope.add_approver_ = local_resource + 'img/model/add_approver_.png';
    $scope.dates_line4x = local_resource + 'img/model/dates-line2x.png';
    $scope.img_upload_file_part1 = local_resource+'img/icon/add.png';
    $scope.img_upload_file_part2 = local_resource+'img/icon/new_2.png';
    $scope.contract_management_directory1 = local_resource + 'img/icon/contract_management_directory1.png';
    $scope.delete_icon= local_resource+'img/icon/delete_icon.png';
    $scope.add_icon=local_resource+'img/icon/add_icon.png';
    //essOtApplySev.loadData();
    $scope.ot_app_data = essOtApplyModifySev.getData();
    $scope.in_need_clock=function(flag,i){
      flag=!flag;
      $scope.add_time_list[i].in_need_clock=flag;
    }
    $scope.out_need_clock=function(flag,i){
      flag=!flag;
      $scope.add_time_list[i].out_need_clock=flag;
    }
    $scope.delete=function(item){
      var idx =  $scope.add_time_list.indexOf(item);
      $scope.add_time_list.splice(idx,1);
    }
    $scope.add=function(item){
      $scope.add_time_list.push({
        name:'',
        in:'00:00',
        in_need_clock:'',
        out:'00:00',
        out_need_clock:'',
        is_need:''
      })
    }
    $scope.add_time_list=[];
    if($scope.ot_app_data.is_need_first){
      $scope.add_time_list.push({
        name:'',
        in:$scope.ot_app_data.first_in,
        in_need_clock:$scope.ot_app_data.first_in_need_clock,
        out:$scope.ot_app_data.first_out,
        out_need_clock:$scope.ot_app_data.first_out_need_clock,
        is_need:$scope.ot_app_data.is_need_first
      })
    }
    if($scope.ot_app_data.is_need_second){
      $scope.add_time_list.push({
        name:'',
        in:$scope.ot_app_data.second_in,
        in_need_clock:$scope.ot_app_data.second_in_need_clock,
        out:$scope.ot_app_data.second_out,
        out_need_clock:$scope.ot_app_data.second_out_need_clock,
        is_need:$scope.ot_app_data.is_need_second
      })
    }
    if($scope.ot_app_data.is_need_ot){
      $scope.add_time_list.push({
        name:'',
        in:$scope.ot_app_data.ot_in,
        in_need_clock:$scope.ot_app_data.ot_in_need_clock,
        out:$scope.ot_app_data.ot_out,
        out_need_clock:$scope.ot_app_data.ot_out_need_clock,
        is_need:$scope.ot_app_data.is_need_ot
      })
    }
    $scope.showTime_in = function(i){
      timeSelect.show({
        type :  'time',
        startDate :'1993年12月01日',
        endDate : '',
        defaultDate: $scope.add_time_list[i].in,
        returnDateType : 'hm',
        returnTimeType :  '24h'||'AMPM',
        //stepping :10,
        selectedFunc : function (date) {
          if (typeof(date) != 'undefined'){
            $scope.add_time_list[i].in = date;
          }
        }
      })
    }
    $scope.showTime_out = function(i){
      timeSelect.show({
        type :  'time',
        startDate :'1993年12月01日',
        endDate : '',
        defaultDate: $scope.add_time_list[i].out,
        returnDateType : 'hm',
        returnTimeType :  '24h'||'AMPM',
        //stepping :10,
        selectedFunc : function (date) {
          if (typeof(date) != 'undefined'){
            $scope.add_time_list[i].out = date;
          }
        }
      })
    }



    $scope.add_time_save=function(){

      essOtApplyModifySev.add_time_save($scope.add_time_list,$scope);
    }
  })


.controller('benefitsettingCtrl',function($scope,essLvApplySev,$ionicModal,$ionicActionSheet,timeSelect,sideSelect,$ionicScrollDelegate,$emplComponentService){
	$scope.dates_line2x = local_resource + 'img/model/dates-line2x.png';
	$scope.dates_line3x = local_resource + 'img/model/dates-line2x.png';
	$scope.add_approver = local_resource + 'img/model/add_approver.png';
	$scope.add_approver_ = local_resource + 'img/model/add_approver_.png';
	$scope.dates_line4x = local_resource + 'img/model/dates-line2x.png';
	$scope.img_upload_file_part1 = local_resource+'img/icon/add.png';
	$scope.img_upload_file_part2 = local_resource+'img/icon/new_2.png';
	$scope.is_require_upload = false;
	essLvApplySev.clearData();
    essLvApplySev.loadData($scope);
    $scope.lv_app_data = essLvApplySev.getData();

	$scope.imagesObj = essLvApplySev.getImageData();

    $scope.essLvPolicy=function(){
      sideSelect.show({
        type : 'ios',
        data :$scope.lv_app_data.essLvPolicy_data,
        selectIndex :  $scope.lv_app_data.essLvPolicy_data_index,
        selectedFunc : function (index) {
          if(typeof(index)!='undefined'){
            document.getElementById("essLvPolicy").innerHTML=$scope.lv_app_data.essLvPolicy_data[index].value;
            $scope.lv_app_data.essLvPolicy_data_key=$scope.lv_app_data.essLvPolicy_data[index].key;
            $scope.lv_app_data.essLvPolicy_data_index=index;
            $scope.lv_app_data.default_lv_code_id=$scope.lv_app_data.essLvPolicy_data_key;
            essLvApplySev.changeEssLvPolicy($scope,$scope.lv_app_data.default_lv_code_id);
          }

        }
      });
    }
/*
    $scope.showDate_start_date = function(){
      var current_date = new Date();
      current_date.setMinutes(current_date.getMinutes() - current_date.getTimezoneOffset());
      current_date = current_date.toJSON().slice(0,4);
      var startDate = parseInt(current_date, 10) - 10;
      startDate = startDate + '-01-01';
      var endDate = parseInt(current_date, 10) + 10;
      endDate = endDate + '-12-31';
      timeSelect.show({
        type :  'date' ,
        startDate :  '1900-01-01',
        endDate : '2099-12-31',
        defaultDate: $scope.lv_app_data.start_date,
        returnDateType : 'y-m-d',
        returnTimeType :  '24h'||'AMPM',
        //stepping :10,
        selectedFunc : function (date) {
          if (typeof(date) != 'undefined'){
            $scope.lv_app_data.start_date = date;
            essLvApplySev.changeEssLvPolicy($scope,$scope.lv_app_data.default_lv_code_id);
          }
        }
      })
    }
    $scope.showDate_start_time = function(){
      var current_date = new Date();
      current_date.setMinutes(current_date.getMinutes() - current_date.getTimezoneOffset());
      current_date = current_date.toJSON().slice(0,4);
      var startDate = parseInt(current_date, 10) - 10;
      startDate = startDate + '-01-01';
      var endDate = parseInt(current_date, 10) + 10;
      endDate = endDate + '-12-31';
      timeSelect.show({
        type :  'time' ,
        startDate :  '1900-01-01',
        endDate : '2099-12-31',
        defaultDate: $scope.lv_app_data.start_time,
        returnDateType : 'y-m-d',
        returnTimeType :  '24h'||'AMPM',
        //stepping :10,
        selectedFunc : function (date) {
          if (typeof(date) != 'undefined'){
            $scope.lv_app_data.start_time = date;
            essLvApplySev.changeEssLvPolicy($scope,$scope.lv_app_data.default_lv_code_id);
          }
        }
      })
    }


    $scope.showDate_end_date = function(){
      var current_date = new Date();
      current_date.setMinutes(current_date.getMinutes() - current_date.getTimezoneOffset());
      current_date = current_date.toJSON().slice(0,4);
      var startDate = parseInt(current_date, 10) - 10;
      startDate = startDate + '-01-01';
      var endDate = parseInt(current_date, 10) + 10;
      endDate = endDate + '-12-31';
      timeSelect.show({
        type :  'date' ,
        startDate :  '1900-01-01',
        endDate : '2099-12-31',
        defaultDate: $scope.lv_app_data.end_date,
        returnDateType : 'y-m-d',
        returnTimeType :  '24h'||'AMPM',
        //stepping :10,
        selectedFunc : function (date) {
          if (typeof(date) != 'undefined'){
            $scope.lv_app_data.end_date = date;
            essLvApplySev.changeEssLvPolicy($scope,$scope.lv_app_data.default_lv_code_id);
          }
        }
      })
    }

    $scope.showDate_end_time = function(){
      var current_date = new Date();
      current_date.setMinutes(current_date.getMinutes() - current_date.getTimezoneOffset());
      current_date = current_date.toJSON().slice(0,4);
      var startDate = parseInt(current_date, 10) - 10;
      startDate = startDate + '-01-01';
      var endDate = parseInt(current_date, 10) + 10;
      endDate = endDate + '-12-31';
      timeSelect.show({
        type :  'time' ,
        startDate :  '1900-01-01',
        endDate : '2099-12-31',
        defaultDate: $scope.lv_app_data.end_time,
        returnDateType : 'y-m-d',
        returnTimeType :  '24h'||'AMPM',
        //stepping :10,
        selectedFunc : function (date) {
          if (typeof(date) != 'undefined'){
            $scope.lv_app_data.end_time = date;
            essLvApplySev.changeEssLvPolicy($scope,$scope.lv_app_data.default_lv_code_id);
          }
        }
      })
    }

*/

    $scope.show_start_date = function(){
      var current_date = new Date();
      current_date.setMinutes(current_date.getMinutes() - current_date.getTimezoneOffset());
      current_date = current_date.toJSON().slice(0,4);
      var startDate = parseInt(current_date, 10) - 1;
      startDate = startDate + '-01-01 18:00';
      var endDate = parseInt(current_date, 10) + 1;
      endDate = endDate + '-12-31 18:00';
      timeSelect.show({
        type :  'dateTime' ,
        startDate :  '1900-01-01 18:00',
        endDate : '2099-12-31 18:00',
        defaultDate: $scope.lv_app_data.start_date+' '+$scope.lv_app_data.start_time,
        returnDateType : 'y-m-d',
        returnTimeType :  '24h'||'AMPM',
        //stepping :10,
        selectedFunc : function (date) {
          if (typeof(date) != 'undefined'){

            var formatted_date = date.split(' ');
            $scope.lv_app_data.start_date = formatted_date[0];
            $scope.lv_app_data.start_time = formatted_date[1];
			essLvApplySev.changeEssLvPolicy($scope,$scope.lv_app_data.default_lv_code_id);
          }
        }
      })
    }


    $scope.show_end_date = function(){

      var current_date = new Date();
      current_date.setMinutes(current_date.getMinutes() - current_date.getTimezoneOffset());
      current_date = current_date.toJSON().slice(0,4);
      var startDate = parseInt(current_date, 10) - 1;
      startDate = startDate + '-01-01 18:00';
      var endDate = parseInt(current_date, 10) + 1;
      endDate = endDate + '-12-31 18:00';
      timeSelect.show({
        type :  'dateTime',
        startDate : '1900-01-01 18:00',
        endDate : '2099-12-31 18:00',
        defaultDate: $scope.lv_app_data.end_date+' '+$scope.lv_app_data.end_time,
        returnDateType : 'y-m-d',
        returnTimeType :  '24h'||'AMPM',
        //stepping :10,
        selectedFunc : function (date) {
          if (typeof(date) != 'undefined'){
            var formatted_date = date.split(' ');
            $scope.lv_app_data.end_date = formatted_date[0];
            $scope.lv_app_data.end_time = formatted_date[1];
			essLvApplySev.changeEssLvPolicy($scope,$scope.lv_app_data.default_lv_code_id);
          }
        }
      })
    }


	$scope.upload_photo = function (){

            // Show the action sheet
            var hideSheet = $ionicActionSheet.show({
                buttons: [

                    {
                        text: '拍照'
                    }, {
                        text: '从手机相册选择'
                    }
                ],

                //titleText: 'Modify your album',
                titleText: '选择上传图片方式',
                cancelText: '取消',
                cancel: function() {
                    // add cancel code..
                },
                buttonClicked: function(index) {

                    if (index == 0) {

                        try {
                            navigator.camera.getPicture(function(uri) {
								$scope.is_require_upload = true;
								document.getElementById('ess_leave_apply_upload_mini_photo').style.display = "block";
                                $('#ess_leave_apply_upload_mini_photo').attr("src", uri);
								document.getElementById('ess_leave_apply_upload_text').innerText='更改图片';
                                $('#ess_leave_apply_upload_icon1').attr("src", local_resource+'img/icon/upload_modify.png');
								document.getElementById('ess_leave_apply_upload_icon2').style.display = "none";
								document.getElementById('ess_leave_apply_upload_text').style.marginTop = "1.8em";

                            }, function() {
                                //alert('cancel or failure');
                            }, {
								destinationType: Camera.DestinationType.FILE_URI,
								quality: 10,
								targetHeight: 500,
								targetWidth: 500,
								correctOrientation: true
                            });
                        } catch (e) {
                            //alert(e.message);
                        }
                        return true;
                    } else if (index == 1) {
                        try {
                            navigator.camera.getPicture(function(uri) {
								$scope.is_require_upload = true;
								document.getElementById('ess_leave_apply_upload_mini_photo').style.display = "block";
                                $('#ess_leave_apply_upload_mini_photo').attr("src", uri);
								document.getElementById('ess_leave_apply_upload_text').innerText='更改图片';
                                $('#ess_leave_apply_upload_icon1').attr("src", local_resource+'img/icon/upload_modify.png');
								document.getElementById('ess_leave_apply_upload_icon2').style.display = "none";
								document.getElementById('ess_leave_apply_upload_text').style.marginTop = "1.8em";

                            }, function(message) {}, {
                                quality: 100,
                                destinationType: Camera.DestinationType.FILE_URI,
                                // In this app, dynamically set the picture source, Camera or photo gallery
                                sourceType: Camera.PictureSourceType.SAVEDPHOTOALBUM,
                                encodingType: Camera.EncodingType.JPEG,
                                mediaType: Camera.MediaType.PICTURE,
                                //allowEdit: true,
                                targetHeight: 500,
                                targetWidth: 500,
                                correctOrientation: true
                            });
                        } catch (e) {
                            //alert(e.message);
                        }

                        return true;
                    }

                    return true;


                }
            });

            // For example's sake, hide the sheet after two seconds
            /*
            $timeout(function() {
            hideSheet();
            }, 2000);
            */


	}

    $scope.changeEssLvPolicy = function(){
      essLvApplySev.changeEssLvPolicy($scope,$scope.lv_app_data.default_lv_code_id);
    }

    $scope.saveApply = function(){
		if ($scope.lv_app_data.is_attachment &&　$scope.imagesObj.data != ''){
			essLvApplySev.saveApplyWithPhoto($scope.select_user_id,$scope.select_notify_id,$scope.approver_list);
		}
		else {
			essLvApplySev.saveApply($scope.select_user_id,$scope.select_notify_id,$scope.approver_list);
		}
    }
    $scope.search_control={};
    $scope.search_control.search_val = '';
    $scope.ess_empl_data = [];
    $scope.select_user_id = '';
    $scope.select_notify_id = '';
    $scope.click_flag = 0;
    $scope.essItemCk = function(user_id,img,en,_flag){
      if(_flag == true){
        $scope.ess_empl_data.num_checked =  $scope.ess_empl_data.num_checked + 1;
      }else{
        $scope.ess_empl_data.num_checked =  $scope.ess_empl_data.num_checked - 1;
      }


      var _d = [];
      if($scope.click_flag == 0){
        $scope.select_user_id = user_id;
        _d = $scope.lv_app_data.approver_list;
      }else{
        return;
      }
      var flag = 0;
      var _len = _d.length;
      for(var i=0;i<_len;i++){
        if(angular.isDefined(_d[i].flag)&&_d[i].flag==1){
          flag = 1;
          break;
        }
      }
      if(flag == 0){
        _d.push({
          img:img,
          name:en,
          user_id:user_id,
          flag:1
        })
      }else{
        _d[_len-1] = {
          img:img,
          name:en,
          user_id:user_id,
          flag:1
        }
      }
      $scope.approver_list=_d;
      $scope.search_control.search_val = '';

      $scope.closeModal();
    }


    $scope.delete_notify=function(user_id){
      $('#essLvApply #notify_list_div').addClass('notify_list_active');
        if($scope.select_notify_id.indexOf(',')==-1){
          $scope.select_notify_id=$scope.select_notify_id.replace(user_id,'');
        }
        else if($scope.select_notify_id.indexOf(user_id+',')==-1){
          $scope.select_notify_id=$scope.select_notify_id.replace(','+user_id,'');
        }
        else{
          $scope.select_notify_id=$scope.select_notify_id.replace(user_id+',','');
        }
        for(var i=0;i<$scope.lv_app_data.notify_list.length;i++){
          if($scope.lv_app_data.notify_list[i].user_id==user_id){
            $scope.lv_app_data.notify_list.splice(i,1);
          }
        }
      setTimeout(function(){
        document.getElementById('notify_list_div').style.width=($scope.lv_app_data.notify_list.length+1)*100+20+'px';
        $ionicScrollDelegate.$getByHandle("notify_list_scroll").resize();
      },350)


    }
    $scope.delete_approver=function(user_id){
      if(!$scope.lv_app_data.approver_list_flag){
        return;
      }
      $('#essLvApply #approver_list_div').addClass('approver_list_active');
      $scope.approver_list=[];
      $scope.select_user_id=''
	  $scope.lv_app_data.approver_list=[];
    }


    $scope.selectList = function(){
      if($scope.click_flag==1){
        var _d = [];
        $scope.select_notify_id = '';
        $scope.lv_app_data.notify_list = [];
        for(var i=0;i<$scope.ess_empl_data.length;i++){
          if($scope.ess_empl_data[i].ck){
            $scope.select_notify_id = $scope.select_notify_id + ($scope.ess_empl_data)[i].user_id+',';
            $scope.lv_app_data.notify_list.push({
              img:($scope.ess_empl_data)[i].img,
              name:($scope.ess_empl_data)[i].en,
              user_id:($scope.ess_empl_data)[i].user_id,
              flag:1
            });
          }
        }
        $scope.select_notify_id = ($scope.select_notify_id).substring(0,$scope.select_notify_id.length-1);
        $scope.closeModal();
      }
      document.getElementById('notify_list_div').style.width=($scope.lv_app_data.notify_list.length+1)*100+20+'px';
      //alert($scope.lv_app_data.notify_list.length);

      $scope.search_control.search_val='';
      $ionicScrollDelegate.$getByHandle("notify_list_scroll").resize();
    }


    $ionicModal.fromTemplateUrl('ess-empl-modal.html', {
      scope: $scope,
      animation: 'slide-in-up'
    }).then(function(modal) {
      $scope.modal = modal;
    });
    $scope.openModal = function() {

		var selectEmplList = '';
		if ($scope.approver_list.length != 0){
			for (var i=0;i<$scope.approver_list.length;i++){
				selectEmplList += $scope.approver_list[i].employee_no;
				if (i < $scope.approver_list.length - 1){
					selectEmplList += ',';
				}
			}

			console.log($scope.approver_list);

			//selectEmplList = $scope.lv_app_data.approver_list[0].employee_no;
		}

		$emplComponentService.open({
			title : '选择审批人', //弹开窗口标题
			barTitle : window.localStorage["org_top_level"],//导航开头
			isSingleSelect:false,//是否单选
			isShowContact:true,//是否展示常用联系人
			isNeedSaveContact:true,//是否保存常用联系人
			extName : '员工', //多选时提示后缀名
			selectEmplList:selectEmplList, //打开窗口默认选中员工列表
			/*
			params:{ //支持可用扩展参数
				"is_permissions":"0",
				"is_process":"0",
				"process_instance":'0',
				"ext_param":"aa"
			},
			*/
			sure : function (rd) { //返回数据，数组格式
				//console.log(rd);
				$scope.lv_app_data.approver_list = [];
				for(var i=0;i<rd.length;i++){
					$scope.select_user_id = $scope.select_user_id + rd[i].user_id;
					$scope.approver_list.push({
					  img:rd[i].img_src,
					  name:rd[i].empl_name,
					  user_id:rd[i].user_id,
					  employee_no:rd[i].empl_no,
					  flag:1
					});
					if (i < rd.length - 1){
						$scope.select_user_id += ',';
					}
				}
				document.getElementById('approver_list_div').style.width=($scope.approver_list.length+1)*100+20+'px';
				$ionicScrollDelegate.$getByHandle("approver_list_scroll").resize();
				/*
				$scope.select_user_id = rd[0].user_id;

				$scope.lv_app_data.approver_list.push({
				  img:rd[0].img_src,
				  name:rd[0].empl_name,
				  user_id:rd[0].user_id,
				  employee_no:rd[0].empl_no,
				  flag:1
				});
				$scope.approver_list=$scope.lv_app_data.approver_list;
				*/
			}
		});

    }
    $scope.openModal2 = function() {
		var selectEmplList = '';
		if ($scope.lv_app_data.notify_list.length != 0){
			for (var i=0;i<$scope.lv_app_data.notify_list.length;i++){
				selectEmplList += $scope.lv_app_data.notify_list[i].employee_no;
				if (i < $scope.lv_app_data.notify_list.length - 1){
					selectEmplList += ',';
				}
			}

		}

		$emplComponentService.open({
			title : '选择知会人', //弹开窗口标题
			barTitle : window.localStorage["org_top_level"],//导航开头
			isSingleSelect:false,//是否单选
			isShowContact:true,//是否展示常用联系人
			isNeedSaveContact:true,//是否保存常用联系人
			extName : '员工', //多选时提示后缀名
			selectEmplList:selectEmplList, //打开窗口默认选中员工列表
			/*
			params:{ //支持可用扩展参数
				"is_permissions":"0",
				"is_process":"0",
				"process_instance":'0',
				"ext_param":"aa"
			},
			*/
			sure : function (rd) { //返回数据，数组格式
				$('#essLvApply #notify_list_div').removeClass('notify_list_active');
				$scope.select_notify_id = '';
				$scope.lv_app_data.notify_list = [];
				for(var i=0;i<rd.length;i++){

					$scope.select_notify_id = $scope.select_notify_id + rd[i].user_id;
					$scope.lv_app_data.notify_list.push({
					  img:rd[i].img_src,
					  name:rd[i].empl_name,
					  user_id:rd[i].user_id,
					  employee_no:rd[i].empl_no,
					  flag:1
					});
					if (i < rd.length - 1){
						$scope.select_notify_id += ',';
					}
				}

				document.getElementById('notify_list_div').style.width=($scope.lv_app_data.notify_list.length+1)*100+20+'px';
				$ionicScrollDelegate.$getByHandle("notify_list_scroll").resize();
			}
		});

    }
    $scope.closeModal = function() {
      $scope.modal.hide();
      $scope.ess_empl_data = [];
      $scope.search_control.search_val='';
    }
    $scope.$on('$destroy', function() {
      $scope.modal.remove();
    });
  })



  .controller('OtTeamRecordCtrl',function($scope,$stateParams,OtTeamRecordSev,$ionicNavBarDelegate,$ionicHistory,$location,$timeout,timeSelect,$ionicScrollDelegate){

    $scope.$on("$ionicView.enter", function () {
      document.getElementById('details_div').onclick=function(){
        document.getElementById('details_div').style.color='#53afff';
        document.getElementById('details_div').style.backgroundColor='white';
        document.getElementById('details_div').style.border='none';
        document.getElementById('statistics_div').style.color='white';
        document.getElementById('statistics_div').style.backgroundColor='#53afff';
        document.getElementById('statistics_div').style.border='1px solid white';
        document.getElementById('statistics_div').style.borderLeft='none';
        //document.getElementById('details_content_div').style.display="block";
        //document.getElementById('statistics_content_div').style.display="none";
        document.getElementById('ot_team_record_wrap').style.webkitTransform='translateX(0)';
        //OtTeamRecordSev.loadData(_date,$scope);
        //$scope.ot_team_record_data = OtTeamRecordSev.getData();
        for(var i=0;i<document.getElementsByClassName('details_cls').length;i++){
          document.getElementsByClassName('details_cls')[i].style.display='block';
          document.getElementsByClassName('statistics_cls')[i].style.display='none';
        }
        document.getElementById('details_content_div').setAttribute("style","width:50%;");
        document.getElementById('statistics_content_div').setAttribute("style","width: 50%;position: absolute;left:50%;top:0px;");
        document.getElementById('ot_team_record_wrap').style.overflow='visible';
        $timeout(function(){ $ionicScrollDelegate.resize();
          document.getElementById('ot_team_record_wrap').style.overflow='hidden';
        }, 200);
      }
      document.getElementById('statistics_div').onclick=function(){
        document.getElementById('statistics_div').style.color='#53afff';
        document.getElementById('statistics_div').style.backgroundColor='white';
        document.getElementById('statistics_div').style.border='none';
        document.getElementById('details_div').style.color='white';
        document.getElementById('details_div').style.backgroundColor='#53afff';
        document.getElementById('details_div').style.border='1px solid white';
        document.getElementById('details_div').style.borderRight='none';
        //document.getElementById('details_content_div').style.display="none";
        //document.getElementById('statistics_content_div').style.display="block";
        //OtTeamRecordSev.loadStatisticsData(_date,$scope);
        document.getElementById('ot_team_record_wrap').style.webkitTransform='translateX(-50%)';

        for(var i=0;i<document.getElementsByClassName('details_cls').length;i++){
          document.getElementsByClassName('details_cls')[i].style.display='none';
          document.getElementsByClassName('statistics_cls')[i].style.display='block';
        }
          document.getElementById('details_content_div').setAttribute("style","width:50%;position: absolute;left:0px;top:0px;");
          document.getElementById('statistics_content_div').setAttribute("style","width: 50%;float: right");
          document.getElementById('ot_team_record_wrap').style.overflow='visible';
          $timeout(function(){ $ionicScrollDelegate.resize();
            document.getElementById('ot_team_record_wrap').style.overflow='hidden';
          }, 200);
      }
    });
  $scope.OtTeamRecordBack=function(){

      $ionicHistory.goBack();
    OtTeamRecordSev.clearStatusBar();
}


    $scope.search_control = {};
    $scope.search_control.search_val = "";
    $scope.contract_management_directory1 = local_resource + 'img/icon/contract_management_directory1.png';
    $scope.is_pc_icon= local_resource + 'img/icon/is_pc_icon.png';
    $scope.show_search = false;
    $scope.toggle_search = function() {
      $scope.show_search = true;
      $ionicScrollDelegate.scrollTop();
    }
    $scope.cancel_search = function() {
      $scope.show_search = false;
      $scope.search_control.search_val = '';
    }
    var _date='';
    var t=new Date();
    if(t.getMonth()+1<10){
      _date= t.getFullYear()+"/"+ '0'+(t.getMonth()+1)+'/'+ '01';
    }
    else{
      _date= t.getFullYear()+"/"+(t.getMonth()+1)+'/'+ '01';
    }

    $scope.date_year=t.getFullYear();
    if(t.getMonth()+1<10){
      $scope.date_month="0"+(t.getMonth()+1);
    }
    else{
      $scope.date_month=t.getMonth()+1;
    }

    if (ionic.Platform.isIOS()) {
      OtTeamRecordSev.clearData();
      OtTeamRecordSev.loadData(_date,$scope);
      $scope.ot_team_record_data = OtTeamRecordSev.getData();
    } else {
      $scope.$on("$ionicView.enter", function () {
        //解决 进入明细页面back回来的时候 会再次loaddata
        if (typeof($scope.data_loaded) != 'undefined') {
          return;
        }
        else {
          $scope.data_loaded = true;
        }
        OtTeamRecordSev.clearData();
        OtTeamRecordSev.loadData(_date,$scope);
        $scope.ot_team_record_data = OtTeamRecordSev.getData();
      });
    }
	 // OtTeamRecordSev.clearData();
    //OtTeamRecordSev.loadData(_date,$scope);
    //$scope.ot_team_record_data = OtTeamRecordSev.getData();
    //$scope.ot_team_record_statistics_data=OtTeamRecordSev.getStatisticsData();


    var d_date='';
    d_date=new Date().getFullYear()+'年'+ (new Date().getMonth()+1)+'月';
    $scope.showDate = function(){
      timeSelect.show({
        type :  'yearsMonth',
        startDate : '1993年12月01日',
        endDate : '',
        defaultDate: d_date ,
        returnDateType : 'ymd',
        returnTimeType :  '24h'||'AMPM',
        //stepping :10,
        selectedFunc : function (date) {
          if(typeof(date)=='undefined'){
          }
          else{
            _date=date.slice(0,4)+'/'+date.slice(5,7)+'/'+'01';
            $scope.date_year= date.slice(0,4);
            $scope.date_month=date.slice(5,7);
            d_date=date;
            if(document.getElementById('details_content_div').style.display=='none'){
              OtTeamRecordSev.loadStatisticsData(_date,$scope);

            }
            else {
              OtTeamRecordSev.loadData(_date, $scope);

              //OtTeamRecordSev.loadStatisticsData(_date,$scope);
            }
          }
        }
      })
    }


    //$scope.fireEvent = function(i,arr){
    //  var max_ot=arr.max_ot;
    //  $timeout(function(){
    //    document.getElementById('post_num_'+i).style.width= (arr.ot_data[i].post_num/max_ot)*100+"%";
    //    document.getElementById('off_num_'+i).style.width= (arr.ot_data[i].off_num/max_ot)*100+"%";
    //    document.getElementById('nh_num_'+i).style.width= (arr.ot_data[i].nh_num/max_ot)*100+"%";
    //  }, 0);
    //}


    $scope.details_click=function(){
      document.getElementById('details_div').style.color='white';
      document.getElementById('details_div').style.backgroundColor='#53afff';
      document.getElementById('details_div').style.border='none';
      document.getElementById('statistics_div').style.color='black';
      document.getElementById('statistics_div').style.backgroundColor='white';
      document.getElementById('statistics_div').style.border='1px solid #eeeeee';
      document.getElementById('statistics_div').style.borderLeft='none';
      document.getElementById('details_content_div').style.display="block";
      document.getElementById('statistics_content_div').style.display="none";
      OtTeamRecordSev.loadData(_date,$scope);
      $scope.ot_team_record_data = OtTeamRecordSev.getData();
    }
    $scope.statistics_click=function(){
      document.getElementById('details_content_div').style.display="none";
      document.getElementById('statistics_content_div').style.display="block";
      document.getElementById('statistics_div').style.border='none'
      document.getElementById('details_div').style.color='black';
      document.getElementById('details_div').style.backgroundColor='white';
      document.getElementById('details_div').style.border='1px solid #eeeeee';
      document.getElementById('details_div').style.borderRight='none';
      document.getElementById('statistics_div').style.color='white';
      document.getElementById('statistics_div').style.backgroundColor='#53afff';
      OtTeamRecordSev.loadStatisticsData(_date,$scope);
    }
    $scope.loadOtteamContent=function(process_instance,shift_date,is_pc,employee_name,ot_code_name,employee_no){
      if(is_pc=='0'){
        $location.path("home_page/home_menulist/ot_team_details_content/"+process_instance+"/"+shift_date+"/"+is_pc+"/"+employee_name+"/"+ot_code_name+"/"+employee_no);
      }
      else if(is_pc=='1'){
        $location.path("home_page/home_menulist/ot_team_details_pc_content/"+process_instance+"/"+shift_date+"/"+is_pc+"/"+employee_name+"/"+ot_code_name+"/"+employee_no);
      }

    }



  })


  .controller('LvTeamRecordCtrl',function($scope,$stateParams,LvTeamRecordSev,$ionicNavBarDelegate,$ionicHistory,$location,$ionicNavBarDelegate,timeSelect,$timeout){
    $scope.$on("$ionicView.enter", function () {
      //document.getElementById('LvTeamRecordCloseIonic').onclick=function(){
      //
      //  document.getElementById('LvTeamRecordCloseIonic').style.display='none';
      //  document.getElementById('LvTeamRecordSearchInput').value='';
      //  $timeout(function(){
      //    $scope.search_control.search_val=document.getElementById('LvTeamRecordSearchInput').value;
      //  })
      //}
      //
      //document.getElementById('LvTeamRecordBack').onclick=function(){
      //  $ionicHistory.goBack();
      //}
      //document.getElementById('LvTeamRecordSearch').onclick=function(){
      //  document.getElementById("LvTeamRecordSearchDiv").style.display='block';
      //  $timeout(function(){
      //    document.getElementById("LvTeamRecordSearchDiv").style.opacity='1';
      //  },300);
      //  $timeout(function(){document.getElementById('LvTeamRecordSearchInput').focus();})
      //}
      //document.getElementById('LvTeamRecordSearchCancelBtn').onclick=function(){
      //  document.getElementById('LvTeamRecordCloseIonic').style.display='none';
      //  $timeout(function(){ $scope.search_control.search_val='';})
      //  document.getElementById('LvTeamRecordSearchInput').value='';
      //  document.getElementById("LvTeamRecordSearchDiv").style.opacity='0';
      //  $timeout(function(){
      //    document.getElementById("LvTeamRecordSearchDiv").style.display='none';
      //  },300);
      //}
      //document.getElementById('LvTeamRecordSearchInput').onkeyup=function(){
      //  if(document.getElementById('LvTeamRecordSearchInput').value==''){
      //    document.getElementById('LvTeamRecordCloseIonic').style.display='none';
      //  }
      //  else{
      //    document.getElementById('LvTeamRecordCloseIonic').style.display='block';
      //  }
      //  $timeout(function(){
      //    $scope.search_control.search_val=document.getElementById('LvTeamRecordSearchInput').value;
      //  })
      //}
      //document.getElementById('LvTeamRecordSearchInput').onfocus=function(){
      //  if(document.getElementById('LvTeamRecordSearchInput').value==''){
      //    document.getElementById('LvTeamRecordCloseIonic').style.display='none';
      //  }
      //  else{
      //    document.getElementById('LvTeamRecordCloseIonic').style.display='block';
      //  }
      //
      //}
      //document.getElementById('LvTeamRecordSearchInput').onblur=function(){
      //  document.getElementById('LvTeamRecordCloseIonic').style.display='none';
      //}
    });
    $scope.search_control = LvTeamRecordSev.getSearchValue();
    var _date='';
    var t=new Date();
    _date= t.getFullYear()+"/"+'0'+(t.getMonth()+1)+'/'+ '01';
    $scope.date_year=t.getFullYear();
    if(t.getMonth()+1<10){
      $scope.date_month="0"+(t.getMonth()+1);
    }
    else{
      $scope.date_month=t.getMonth()+1;
    }

    LvTeamRecordSev.clearData();
    LvTeamRecordSev.loadData(_date);
    $scope.lv_team_record_data = LvTeamRecordSev.getData();

    $scope.show_search = false;
    //$scope.toggle_search = function() {
    //  $scope.show_search = true;
    //  $ionicScrollDelegate.scrollTop();
    //}
    //$scope.cancel_search = function() {
    //  $scope.show_search = false;
    //  $scope.search_control.search_val = '';
    //}
    $scope.toggle_search=function(){
      document.getElementById("LvTeamRecordSearchDiv").style.display='block';
      setTimeout(function(){
        document.getElementById("LvTeamRecordSearchDiv").style.opacity='1';
      },500);
    }
    $scope.cancel_search=function(){

      document.getElementById("LvTeamRecordSearchDiv").style.opacity='0';
      setTimeout(function(){
        document.getElementById("LvTeamRecordSearchDiv").style.display='none';
      },500);
    }
    $scope.is_pc_icon= local_resource + 'img/icon/is_pc_icon.png';

    var d_date='';
    d_date=t.getFullYear()+"/"+'0'+(t.getMonth()+1);
    $scope.showDate = function(){
      timeSelect.show({
        type :  'yearsMonth',
        startDate : '1993年12月01日',
        endDate : '',
        defaultDate: d_date,
        returnDateType : 'ymd',
        returnTimeType :  '24h'||'AMPM',
        //stepping :10,
        selectedFunc : function (date) {
        if(typeof(date)=='undefined'){
          //$ionicNavBarDelegate.showBar(false);
        }
          else{

          _date=date.slice(0,4)+'/'+date.slice(5,7)+'/'+'01';
          $scope.date_year= date.slice(0,4);
          $scope.date_month=date.slice(5,7);
          d_date=date;
          LvTeamRecordSev.loadData(_date);
        }

          }

      })
    }


    $scope.loadLvTeamContent=function(process_instance,app_id,is_pc,employee_name){
      if(is_pc=='0'){
        $location.path("home_page/home_menulist/leave_team_details_content/"+process_instance+"/"+app_id+"/"+is_pc+"/"+employee_name);
      }
      else if(is_pc=='1'){
        $location.path("home_page/home_menulist/leave_team_details_pc_content/"+process_instance+"/"+app_id+"/"+is_pc+"/"+employee_name);
      }

    }

  })
  .controller('LvTeamDCCtrl',function($scope,LvTeamDCSev,$stateParams,$ionicModal,$ionicActionSheet,$location,$timeout,$ionicPopup,zoomSlider,$timeout){

    $scope.is_pc_icon= local_resource + 'img/icon/is_pc_icon.png';
    $scope.employee_name=$stateParams.employee_name;
    $scope.lv_team_dc_title=$stateParams.employee_name+'的请假单';
    $scope.fireEvent = function(i,arr){
      $timeout(function(){
        //if(i==arr.length-1&&$scope.lv_team_dc_data.approver_list_flag==false){
        //  document.getElementById("approver_list_img_"+i).style.display="none";
        //}
        if(document.getElementById("approver_list_img_"+i)!=null){
          document.getElementById("approver_list_img_"+i).style.height=document.getElementById("approver_list_div" + i).offsetHeight+'px';
          document.getElementById("approver_list_div_"+i).style.height=(document.getElementById("approver_list_div" + i).offsetHeight-16)+'px';
        }
        if(i==(arr.length-1)){
          document.getElementById("approver_list_img_"+i).style.display="none";
        }

      }, 0);
    }

    $scope.dates_line2x = local_resource + 'img/model/dates-line2x.png';
    $scope.icon_apply = local_resource + 'img/model/icon-apply@2x.png';
    $scope.approval_line = local_resource + 'img/model/approval-line@2x.png';
    $scope.icon_confirm = local_resource + 'img/model/icon-confirm@2x.png';
    $scope.icon_noappprove = local_resource + 'img/model/icon-noapprove.png';
    $scope.approval_line_gray = local_resource + 'img/model/approval-line-gray@2x.png';
    $scope.icon_waiting = local_resource + 'img/model/wait_approval.png';
    $scope.icon_wait = local_resource + 'img/model/icon-waiting@2x.png';
    $scope.approval_line_gray = local_resource + 'img/model/approval-line-gra y@2x.png';
    $scope.add_approver = local_resource + 'img/model/add_approver.png';
    $scope.add_approver_ = local_resource + 'img/model/add_approver_.png';
    $scope.approve_icon= local_resource + 'img/icon/approve_icon.png';
    $scope.notify= local_resource + 'img/icon/notify.png';
    $scope.content_left_icon=local_resource + 'img/icon/content-left-icon.png';
    $scope.is_expand=true;
    LvTeamDCSev.clearData();
    LvTeamDCSev.loadData($stateParams.process_instance,$stateParams.app_id,$stateParams.is_pc).then(function(greeting) {

      $timeout(function(){
        $scope.lv_team_dc_data = LvTeamDCSev.getData();

        for (var i = 0; i < $scope.lv_team_dc_data.approver_list.length; i++) {
          $scope.lv_team_dc_data.approver_list[i].attachmentList = $scope.lv_team_dc_data.approver_list[i].attachment.split(',');

          if($scope.lv_team_dc_data.approver_list[i].attachmentList.length && $scope.lv_team_dc_data.approver_list[i].attachmentList[$scope.lv_team_dc_data.approver_list[i].attachmentList.length-1] == ""){
            delete $scope.lv_team_dc_data.approver_list[i].attachmentList[$scope.lv_team_dc_data.approver_list[i].attachmentList.length-1];
          }
        }
      },0);

    }, function(reason) {
      //alert('失败鸟: ' + reason);
    }, function(update) {
      //alert('收到通知: ' + update);
    });




    $scope.show_img=function(arr,index){
      // if (ionic.Platform.isIOS()) {
      //   window.open(url, '_system', 'enableViewportScale=yes');
      // } else {
      //   window.open(url, '_system');
      // }

      zoomSlider.show({data:arr, index:index});
    }

  })
  .controller('OtTeamDCCtrl',function($scope,OtTeamDCSev,$stateParams,$ionicModal,$ionicActionSheet,$location,$timeout,$ionicPopup){
    $scope.ot_code_name=$stateParams.ot_code_name;
    $scope.is_pc_icon= local_resource + 'img/icon/is_pc_icon.png';
    $scope.employee_name=$stateParams.employee_name;
    $scope.ot_team_dc_title=$stateParams.employee_name+'的加班单';
    $scope.contract_management_directory1 = local_resource + 'img/icon/contract_management_directory1.png';
    $scope.fireEvent = function(i,arr){
      $timeout(function(){
        //if(i==arr.length-1&&$scope.ot_team_dc_data.approver_list_flag==false){
        //  document.getElementById("approver_list_img_"+i).style.display="none";
        //}
        if(document.getElementById("approver_list_img_"+i)!=null){
          document.getElementById("approver_list_img_"+i).style.height=document.getElementById("approver_list_div" + i).offsetHeight+'px';
          document.getElementById("approver_list_div_"+i).style.height=(document.getElementById("approver_list_div" + i).offsetHeight-16)+'px';
        }
        if(i==(arr.length-1)){
          document.getElementById("approver_list_img_"+i).style.display="none";
        }

      }, 0);
    }
    $scope.dates_line2x = local_resource + 'img/model/dates-line2x.png';
    $scope.icon_apply = local_resource + 'img/model/icon-apply@2x.png';
    $scope.approval_line = local_resource + 'img/model/approval-line@2x.png';
    $scope.icon_confirm = local_resource + 'img/model/icon-confirm@2x.png';
    $scope.icon_noappprove = local_resource + 'img/model/icon-noapprove.png';
    $scope.approval_line_gray = local_resource + 'img/model/approval-line-gray@2x.png';
    $scope.icon_waiting = local_resource + 'img/model/wait_approval.png';
    $scope.icon_wait = local_resource + 'img/model/icon-waiting@2x.png';
    $scope.approval_line_gray = local_resource + 'img/model/approval-line-gray@2x.png';
    $scope.add_approver = local_resource + 'img/model/add_approver.png';
    $scope.add_approver_ = local_resource + 'img/model/add_approver_.png';
    $scope.approve_icon= local_resource + 'img/icon/approve_icon.png';
    $scope.notify= local_resource + 'img/icon/notify.png';
    $scope.content_left_icon=local_resource + 'img/icon/content-left-icon.png';
    $scope.is_expand=true;
	OtTeamDCSev.clearData();
    OtTeamDCSev.loadData($stateParams.process_instance,$stateParams.shift_date,$stateParams.is_pc,$stateParams.employee_no);
    $scope.ot_team_dc_data = OtTeamDCSev.getData();
    $scope.show_img=function(url){
      if (ionic.Platform.isIOS()) {
        window.open(url, '_system', 'enableViewportScale=yes');
      } else {
        window.open(url, '_system');
      }
    }

  })



  .controller('MyLvBalanceCtrl',function($scope,$stateParams,MyLvBalanceSev,$ionicNavBarDelegate,$ionicHistory,$location,$ionicNavBarDelegate,sideSelect,timeSelect){
    $scope.img_leave_balance_time = local_resource + 'img/icon/leave_balance_time.png';
    $scope.img_wave2_2 = local_resource + 'img/icon/wave2_2.png';
    $scope.img_leave_balance_dongh_06 = local_resource + 'img/icon/leave_balance_dongh_06.png';
    $scope.img_leave_balance_dongh_08 = local_resource + 'img/icon/leave_balance_dongh_08.png';
    $scope.img_icon_noapprove2 = local_resource + 'img/icon/icon-noapprove2.png';


	if (typeof($stateParams.employee_no) == 'undefined'){
		$scope.employee_no = '-1';
		$scope.title = '假期结余';
	}
	else {
		$scope.employee_no = $stateParams.employee_no;
		$scope.title = $stateParams.employee_name + '的假期结余';
	}

	MyLvBalanceSev.clearData();
    MyLvBalanceSev.loadData('0','','','',$scope.employee_no);
    $scope.my_lv_balance_data = MyLvBalanceSev.getData();

    $scope.changeLeaveType = function(flag){
      sideSelect.show({
        type : 'ios',
        data :$scope.my_lv_balance_data.lv_str,
        selectIndex : $scope.my_lv_balance_data.selectIndex,
        selectedFunc : function (index) {
          if (typeof(index) == 'undefined'){
            return;
          }

          $scope.my_lv_balance_data.selectIndex = index;
          $scope.my_lv_balance_data.selectLvCodeId = $scope.my_lv_balance_data.lv_str[index].id;
          $scope.my_lv_balance_data.selectLvCodeKey = $scope.my_lv_balance_data.lv_str[index].key_;
          MyLvBalanceSev.loadData($scope.my_lv_balance_data.selectLvCodeId,$scope.my_lv_balance_data.selectLvCodeKey,'','',$scope.employee_no);
        },
        title : '假期类型'
      });
    }


    $scope.start_date_select = function(){
      if ($scope.my_lv_balance_data.selectLvCodeKey != 'CL'){
        return;
      }
      var current_date = new Date();
      current_date.setMinutes(current_date.getMinutes() - current_date.getTimezoneOffset());
      current_date = current_date.toJSON().slice(0,4);
      var startDate = parseInt(current_date, 10) - 1;
      startDate = startDate + '-01-01';
      var endDate = parseInt(current_date, 10) + 1;
      endDate = endDate + '-12-31';
      timeSelect.show({
        type :  'date',
        startDate : '1900-01-01',
        endDate : '2099-12-31',
        defaultDate: $scope.my_lv_balance_data.start_date_text,
        returnDateType : 'ymd',
        returnTimeType :  '24h'||'AMPM',
        //stepping :10,
        selectedFunc : function (date) {
          if (typeof(date) != 'undefined'){
            var formatted_date = date.replace('年','-');
            formatted_date = formatted_date.replace('月','-');
            formatted_date = formatted_date.replace('日','');
            $scope.my_lv_balance_data.start_date = formatted_date;
            MyLvBalanceSev.loadData($scope.my_lv_balance_data.selectLvCodeId,$scope.my_lv_balance_data.selectLvCodeKey,$scope.my_lv_balance_data.start_date,$scope.my_lv_balance_data.end_date,$scope.employee_no);
          }
        }
      })
    }

    $scope.end_date_select = function(){
      var current_date = new Date();
      current_date.setMinutes(current_date.getMinutes() - current_date.getTimezoneOffset());
      current_date = current_date.toJSON().slice(0,4);
      var startDate = parseInt(current_date, 10) - 1;
      startDate = startDate + '-01-01';
      var endDate = parseInt(current_date, 10) + 1;
      endDate = endDate + '-12-31';
      timeSelect.show({
        type :  'date',
        startDate : '1900-01-01',
        endDate : '2099-12-31',
        defaultDate: $scope.my_lv_balance_data.end_date_text,
        returnDateType : 'ymd',
        returnTimeType :  '24h'||'AMPM',
        //stepping :10,
        selectedFunc : function (date) {
          if (typeof(date) != 'undefined'){
            var formatted_date = date.replace('年','-');
            formatted_date = formatted_date.replace('月','-');
            formatted_date = formatted_date.replace('日','');
            $scope.my_lv_balance_data.end_date = formatted_date;
            MyLvBalanceSev.loadData($scope.my_lv_balance_data.selectLvCodeId,$scope.my_lv_balance_data.selectLvCodeKey,$scope.my_lv_balance_data.start_date,$scope.my_lv_balance_data.end_date,$scope.employee_no);
          }
        }
      })
    }
  })

  .controller('OutdoorApplyCtrl',function($scope,OutdoorApplySev,$ionicModal,$ionicActionSheet,$location,timeSelect,essLvApplySev,$ionicPopup,$ionicScrollDelegate,$emplComponentService){
	try {
		getLocation.checkCanLocation(
			function(result){

			}
		);
	} catch (e) {
		console.log(e.message);
	}
    $scope.dates_line2x = local_resource + 'img/model/dates-line2x.png';
    $scope.dates_line3x = local_resource + 'img/model/dates-line2x.png';
    $scope.add_approver = local_resource + 'img/model/add_approver.png';
    $scope.add_approver_ = local_resource + 'img/model/add_approver_.png';
    $scope.dates_line4x = local_resource + 'img/model/dates-line2x.png';
    $scope.img_upload_file_part1 = local_resource+'img/icon/add.png';
    $scope.img_upload_file_part2 = local_resource+'img/icon/new_2.png';
    $scope.is_require_upload = false;
	  OutdoorApplySev.clearData();
    OutdoorApplySev.loadData($scope);
    $scope.lv_app_data = OutdoorApplySev.getData();
    var current_address='';
    var current_latitude='';
    var current_longitude='';

    $scope.getAddress = function ($scope) {

		getLocation.checkCanLocation(
			function(result){

				if (result == 1){

					  try{
						  getLocation.searchMap({latitude:current_latitude,longitude:current_longitude,anotherName:current_address},function(msg){
							try{
							  if (msg.latitude != ''){

								current_address = msg.anotherName;
								document.getElementById("address_now").innerHTML=msg.anotherName;
								current_latitude = msg.latitude;
								current_longitude = msg.longitude;
							  }
							} catch (e){

							}

							  //alert(msg.latitude);
							  //alert(msg.longitude);
							  //alert(msg.address);
						  });


					  }catch(e){
						console.log(e.message);
						//alert(e.message);
					  }
				}
			}
		);

    }
    //if(document.getElementById("address_now").innerText==''){
    //  $scope.address_flag=false
    //}
    //else{
    //  $scope.address_flag=true
    //}
    $scope.saveApply = function(){
      if(document.getElementById("outdoor_reason").innerHTML=='拜访客户'&&$("#outdoor_customer_name").val()==''){
        $ionicPopup.alert({
          title: '提醒',
          template: '<div style="text-align: center;">请填写客户名称</div>',
          okText: '确定'
        })
      }
     else if($("#outdoor_remark").val()==''){
        $ionicPopup.alert({
          title: '提醒',
          template: '<div style="text-align: center;">请填写外出事由</div>',
          okText: '确定'
        })
      }
else {
        if ($scope.lv_app_data.i_wf == '1') {
          OutdoorApplySev.saveApply($scope.select_user_id, $scope.select_notify_id,current_latitude,current_longitude);
        }
        else {
          OutdoorApplySev.saveApplyWithoutApprovel(current_latitude,current_longitude);
        }

      }
    }
    $scope.search_control={};
    $scope.search_control.search_val = '';
    $scope.ess_empl_data = [];
    $scope.select_user_id = '';
    $scope.select_notify_id = '';
    $scope.click_flag = 0;
    $scope.essItemCk = function(user_id,img,en,_flag){
      if(_flag == true){
        $scope.ess_empl_data.num_checked =  $scope.ess_empl_data.num_checked + 1;
      }else{
        $scope.ess_empl_data.num_checked =  $scope.ess_empl_data.num_checked - 1;
      }
      var _d = [];
      if($scope.click_flag == 0){
        $scope.select_user_id = user_id;
        _d = $scope.lv_app_data.approver_list;
      }else{
        return;
      }
      var flag = 0;
      var _len = _d.length;
      for(var i=0;i<_len;i++){
        if(angular.isDefined(_d[i].flag)&&_d[i].flag==1){
          flag = 1;
          break;
        }
      }
      if(flag == 0){
        _d.push({
          img:img,
          name:en,
          user_id:user_id,
          flag:1
        })
      }else{
        _d[_len-1] = {
          img:img,
          name:en,
          user_id:user_id,
          flag:1
        }
      }
      $scope.search_control.search_val = '';
      $scope.closeModal();
    }

    $scope.delete_notify=function(user_id){
      $('#OutdoorApply #notify_list_div').addClass('notify_list_active');
      if($scope.select_notify_id.indexOf(',')==-1){
        $scope.select_notify_id=$scope.select_notify_id.replace(user_id,'');
      }
      else if($scope.select_notify_id.indexOf(user_id+',')==-1){
        $scope.select_notify_id=$scope.select_notify_id.replace(','+user_id,'');
      }
      else{
        $scope.select_notify_id=$scope.select_notify_id.replace(user_id+',','');
      }
      for(var i=0;i<$scope.lv_app_data.notify_list.length;i++){
        if($scope.lv_app_data.notify_list[i].user_id==user_id){
          $scope.lv_app_data.notify_list.splice(i,1);
        }
      }
      setTimeout(function(){
        document.getElementById('notify_list_div').style.width=($scope.lv_app_data.notify_list.length+1)*100+20+'px';
        $ionicScrollDelegate.$getByHandle("notify_list_scroll").resize();
      },350)


    }
    $scope.delete_approver=function(user_id){
      if(!$scope.lv_app_data.approver_list_flag){
        return;
      }
      $('#OutdoorApply #approver_list_div').addClass('approver_list_active');
      $scope.lv_app_data.approver_list=[];
      $scope.select_user_id=''
    }


    $scope.selectList = function(){
      if($scope.click_flag==1){
        var _d = [];
        $scope.select_notify_id = '';
        $scope.lv_app_data.notify_list = [];
        for(var i=0;i<$scope.ess_empl_data.length;i++){
          if($scope.ess_empl_data[i].ck){
            $scope.select_notify_id = $scope.select_notify_id + ($scope.ess_empl_data)[i].user_id+',';
            $scope.lv_app_data.notify_list.push({
              img:($scope.ess_empl_data)[i].img,
              name:($scope.ess_empl_data)[i].en,
              user_id:($scope.ess_empl_data)[i].user_id,
              flag:1
            });
          }
        }
        $scope.select_notify_id = ($scope.select_notify_id).substring(0,$scope.select_notify_id.length-1);
        $scope.closeModal();
      }
      document.getElementById('notify_list_div').style.width=($scope.lv_app_data.notify_list.length+1)*100+20+'px';
      //alert($scope.lv_app_data.notify_list.length);
      $scope.search_control.search_val = '';
      $ionicScrollDelegate.$getByHandle("notify_list_scroll").resize();
    }

    $ionicModal.fromTemplateUrl('ess-empl-modal.html', {
      scope: $scope,
      animation: 'slide-in-up'
    }).then(function(modal) {
      $scope.modal = modal;
    });

	$scope.openModal = function() {

		var selectEmplList = '';
		if ($scope.lv_app_data.approver_list.length != 0){
			selectEmplList = $scope.lv_app_data.approver_list[0].employee_no;
		}

		$emplComponentService.open({
			title : '选择审批人', //弹开窗口标题
			barTitle : window.localStorage["org_top_level"],//导航开头
			isSingleSelect:true,//是否单选
			isShowContact:true,//是否展示常用联系人
			isNeedSaveContact:true,//是否保存常用联系人
			extName : '员工', //多选时提示后缀名
			selectEmplList:selectEmplList, //打开窗口默认选中员工列表
			/*
			params:{ //支持可用扩展参数
				"is_permissions":"0",
				"is_process":"0",
				"process_instance":'0',
				"ext_param":"aa"
			},
			*/
			sure : function (rd) { //返回数据，数组格式

				$('#approver_list_div').removeClass('approver_list_active');
				$scope.select_user_id = rd[0].user_id;
				$scope.lv_app_data.approver_list = [];
				$scope.lv_app_data.approver_list.push({
				  img:rd[0].img_src,
				  name:rd[0].empl_name,
				  user_id:rd[0].user_id,
				  employee_no:rd[0].empl_no,
				  flag:1
				});
				//$scope.approver_list=$scope.lv_app_data.approver_list;
			}
		});

    }

    $scope.openModal2 = function() {
		var selectEmplList = '';
		if ($scope.lv_app_data.notify_list.length != 0){
			for (var i=0;i<$scope.lv_app_data.notify_list.length;i++){
				selectEmplList += $scope.lv_app_data.notify_list[i].employee_no;
				if (i < $scope.lv_app_data.notify_list.length - 1){
					selectEmplList += ',';
				}
			}

		}

		$emplComponentService.open({
			title : '选择知会人', //弹开窗口标题
			barTitle : window.localStorage["org_top_level"],//导航开头
			isSingleSelect:false,//是否单选
			isShowContact:true,//是否展示常用联系人
			isNeedSaveContact:true,//是否保存常用联系人
			extName : '员工', //多选时提示后缀名
			selectEmplList:selectEmplList, //打开窗口默认选中员工列表
			/*
			params:{ //支持可用扩展
				"is_permissions":"0",
				"is_process":"0",
				"process_instance":'0',
				"ext_param":"aa"
			},
			*/
			sure : function (rd) { //返回数据，数组格式
				$('#notify_list_div').removeClass('notify_list_active');
				$scope.select_notify_id = '';
				$scope.lv_app_data.notify_list = [];
				for(var i=0;i<rd.length;i++){

					$scope.select_notify_id = $scope.select_notify_id + rd[i].user_id;
					$scope.lv_app_data.notify_list.push({
					  img:rd[i].img_src,
					  name:rd[i].empl_name,
					  user_id:rd[i].user_id,
					  employee_no:rd[i].empl_no,
					  flag:1
					});
					if (i < rd.length - 1){
						$scope.select_notify_id += ',';
					}
				}

				document.getElementById('notify_list_div').style.width=($scope.lv_app_data.notify_list.length+1)*100+20+'px';
				$ionicScrollDelegate.$getByHandle("notify_list_scroll").resize();
			}
		});

    }
/*
    $scope.openModal = function() {
      $('#approver_list_div').removeClass('approver_list_active');
      $scope.search_val = '';
      $scope.click_flag = 0;
      $scope.ess_empl_data = [];
      OutdoorApplySev.loadEssEmplData($scope.select_user_id,$scope.lv_app_data.employee_no,'');
      $scope.ess_empl_data = OutdoorApplySev.getEssEmplData();
      $scope.modal.show();
    };
    $scope.openModal2 = function() {
      $('#notify_list_div').removeClass('notify_list_active');
      $scope.search_val = '';
      $scope.click_flag = 1;
      $scope.ess_empl_data = [];
      OutdoorApplySev.loadEssEmplData($scope.select_notify_id,$scope.lv_app_data.employee_no,'');
      $scope.ess_empl_data = OutdoorApplySev.getEssEmplData();
      $scope.modal.show();
    };
*/
    $scope.closeModal = function() {
      $scope.modal.hide();
      $scope.ess_empl_data = [];
      $scope.search_control.search_val = '';
    };
    $scope.$on('$destroy', function() {
      $scope.modal.remove();
    });

    $scope.picklist_outdoor_reason = function(){
      var picklist_key_list = "";
      var picklist_value_list = "";
      var checked_key = $('#sign_in_reason_key').val();
      var checked_value = $('#outdoor_reason').html();
      var picklist_title = '外出原因';
      var return_key_field_id = 'sign_in_reason_key';
      var return_value_field_id = 'sign_in_reason';
      var hidden_fields = 'new_contract_end_date_editable_div';

      picklist_key_list = '拜访客户,会议,发布会,培训,巡查,采购,公务办理,其他';
      picklist_value_list = '拜访客户,会议,发布会,培训,巡查,采购,公务办理,其他';

      $location.path('home_page/home_menulist/picklist_outdoor_reason/' + picklist_key_list + '/' + picklist_value_list + '/' + checked_key + '/' + checked_value + '/' + picklist_title + '/' + return_key_field_id + '/' + return_value_field_id + '/' + hidden_fields);
    }

    $scope.show_start_date = function(  ){
      var current_date = new Date();
      current_date.setMinutes(current_date.getMinutes() - current_date.getTimezoneOffset());
      current_date = current_date.toJSON().slice(0,4);
      var startDate = parseInt(current_date, 10) - 1;
      startDate = startDate + '-01-01 18:00';
      var endDate = parseInt(current_date, 10) + 1;
      endDate = endDate + '-12-31 18:00';
      timeSelect.show({
        type :  'dateTime' ,
        startDate :  '1900-01-01 18:00',
        endDate : '2099-12-31 18:00',
        defaultDate: $scope.lv_app_data.start_date+' '+$scope.lv_app_data.start_time,
        returnDateType : 'y-m-d',
        returnTimeType :  '24h'||'AMPM',
        //stepping :10,
        selectedFunc : function (date) {
          if (typeof(date) != 'undefined'){

            var formatted_date = date.split(' ');
            $scope.lv_app_data.start_date = formatted_date[0];
            $scope.lv_app_data.start_time = formatted_date[1];
          }
        }
      })
    }


    $scope.show_end_date = function(){

      var current_date = new Date();
      current_date.setMinutes(current_date.getMinutes() - current_date.getTimezoneOffset());
      current_date = current_date.toJSON().slice(0,4);
      var startDate = parseInt(current_date, 10) - 1;
      startDate = startDate + '-01-01 18:00';
      var endDate = parseInt(current_date, 10) + 1;
      endDate = endDate + '-12-31 18:00';
      timeSelect.show({
        type :  'dateTime',
        startDate : '1900-01-01 18:00',
        endDate : '2099-12-31 18:00',
        defaultDate: $scope.lv_app_data.end_date+' '+$scope.lv_app_data.end_time,
        returnDateType : 'y-m-d',
        returnTimeType :  '24h'||'AMPM',
        //stepping :10,
        selectedFunc : function (date) {
          if (typeof(date) != 'undefined'){
            var formatted_date = date.split(' ');
            $scope.lv_app_data.end_date = formatted_date[0];
            $scope.lv_app_data.end_time = formatted_date[1];
          }
        }
      })
    }


  })





  .controller('picklistOutdoorReasonCtrl',function($scope,$stateParams,$location,$ionicPopup,$ionicHistory){
    $scope.picklist_key_list = $stateParams.picklist_key_list.split(',');
    $scope.picklist_value_list = $stateParams.picklist_value_list.split(',');
    $scope.picklist_title = $stateParams.picklist_title;
    $scope.checked_key = $stateParams.checked_key;
    $scope.checked_value = $stateParams.checked_value;
    $scope.picklist_submit = function (){
      if($scope.checked_value!='undefined') {
        $('#sign_in_reason_key').val($scope.checked_value);
        document.getElementById('outdoor_reason').innerHTML = $scope.checked_value;
      }
      if($scope.checked_value=="拜访客户"){
        document.getElementById("outdoor_customer_name_div").style.display="block";
      }
      else{
        document.getElementById("outdoor_customer_name_div").style.display="none";
      }

      $ionicHistory.goBack();
    }

    $scope.item_clicked = function (checked_key,checked_value) {
      if ($scope.checked_key != '') {
        document.getElementById('picklist_item_' + $scope.checked_key).style.display = "none";
      }
      $scope.checked_key = checked_key;
      $scope.checked_value = checked_value;
      document.getElementById('picklist_item_' + $scope.checked_key).style.display = "block";

      $scope.picklist_submit();
    }
  })
  .controller('essMyOutApplyDCtrl',function($scope,essMyOutApplyDSev,essLvApplySev,$stateParams,$ionicModal,$location,$ionicScrollDelegate,$ionicNavBarDelegate,$ionicHistory,$timeout){
    if (ionic.Platform.isIOS()) {
      essMyOutApplyDSev.clearData();
      essMyOutApplyDSev.loadData($stateParams.type,'UC');
      $scope.ess_my_applyD_data = essMyOutApplyDSev.getData();
    } else {
      $scope.$on("$ionicView.enter", function () {
        //解决 进入明细页面back回来的时候 会再次loaddata
        if (typeof($scope.data_loaded) != 'undefined') {
          return;
        }
        else {
          $scope.data_loaded = true;
        }
        essMyOutApplyDSev.clearData();
        essMyOutApplyDSev.loadData($stateParams.type,'UC');
        $scope.ess_my_applyD_data = essMyOutApplyDSev.getData();
      });
    }
    //$scope.$on("$ionicView.enter", function () {
    //  //解决 进入明细页面back回来的时候 会再次loaddata
    //  if (typeof($scope.data_loaded) != 'undefined'){
    //    return;
    //  }
    //  else {
    //    $scope.data_loaded = true;
    //  }
    //  essMyOutApplyDSev.clearData();
    //  essMyOutApplyDSev.loadData($stateParams.type,'UC');
    //  $scope.ess_my_applyD_data = essMyOutApplyDSev.getData();
    //});

    $scope.search_control = essMyOutApplyDSev.getSearchValue();
    //$scope.search_control.search_val = "";
	 // essMyOutApplyDSev.clearData();
    //essMyOutApplyDSev.loadData($stateParams.type,'UC');
    ////essMyOutApplyDSev.loadOtherData($stateParams.type,'C');
    //$scope.ess_my_applyD_data = essMyOutApplyDSev.getData();
    //$scope.ess_my_applyD_other_data = essMyOutApplyDSev.getOtherData();

    $scope.show_search = false;
    $scope.toggle_search = function() {
      $scope.show_search = true;
      $ionicScrollDelegate.scrollTop();
    }
    $scope.cancel_search = function() {
      $scope.show_search = false;
      $scope.search_control.search_val = '';
    }

    //$scope._flag = "未完成";
    //
    $scope.noapprove_click=function(){

      document.getElementById('my_apply_details_noapprove').style.color='#53afff';
      document.getElementById('my_apply_details_approved').style.color='#808080';
      document.getElementById('ess_my_apply_details_tab_animate_div').style.webkitTransform='translateX(0)';
      document.getElementById('ess_my_apply_details_wrap').style.webkitTransform='translateX(0)';
      document.getElementById('ess_my_apply_details_wrap').style.overflow="visible";
      document.getElementById('ess_my_apply_details_noapprove_div').setAttribute("style","width:50%;");
      document.getElementById('ess_my_apply_details_approved_div').setAttribute("style","width: 50%;position: absolute;left:50%;top:0px;");
        $timeout(function(){ $ionicScrollDelegate.resize();
          document.getElementById('ess_my_apply_details_wrap').style.overflow="hidden";
        }, 200);



    }
    $scope.approved_click=function(){

      document.getElementById('my_apply_details_noapprove').style.color='#808080';
      document.getElementById('my_apply_details_approved').style.color='#53afff';
      document.getElementById('ess_my_apply_details_tab_animate_div').style.webkitTransform='translateX(100%)';
      document.getElementById('ess_my_apply_details_wrap').style.webkitTransform='translateX(-50%)';
      document.getElementById('ess_my_apply_details_wrap').style.overflow="visible";
      document.getElementById('ess_my_apply_details_noapprove_div').setAttribute("style","width:50%;position: absolute;left:0px;top:0px;");
      document.getElementById('ess_my_apply_details_approved_div').setAttribute("style","width: 50%;float: right");
        $timeout(function(){ $ionicScrollDelegate.resize();
          document.getElementById('ess_my_apply_details_wrap').style.overflow="hidden";
        }, 200);


    }
    $scope.loadMyApplyContent=function(p_inst,show_type,task_id,s_t,is_process,app_id){
      $location.path("home_page/ess_my_out_apply_details_content/"+p_inst+"/"+show_type+"/"+task_id+"/"+s_t+"/"+is_process+"/"+app_id+"/my_apply");
    }

  })

  .controller('essMyOutApplyDetailsContentCtrl',function($scope,essMyOutApplyDetailsContentSev,essLvApplySev,$stateParams,$ionicModal,$ionicActionSheet,$location,$ionicPopup,$timeout){
    $scope.dates_line2x = local_resource + 'img/model/dates-line2x.png';
    $scope.icon_apply = local_resource + 'img/model/icon-apply@2x.png';
    $scope.approval_line = local_resource + 'img/model/approval-line@2x.png';
    $scope.icon_confirm = local_resource + 'img/model/icon-confirm@2x.png';
    $scope.icon_noappprove = local_resource + 'img/model/icon-noapprove.png';
    $scope.approval_line_gray = local_resource + 'img/model/approval-line-gray@2x.png';
    $scope.icon_waiting = local_resource + 'img/model/wait_approval.png';
    $scope.icon_wait = local_resource + 'img/model/icon-waiting@2x.png';
    $scope.icon_noapprove =local_resource +'img/model/icon-noapprove.png';
    $scope.approval_line_gray = local_resource + 'img/model/approval-line-gray@2x.png';
    $scope.add_approver = local_resource + 'img/model/add_approver.png';
    $scope.add_approver_ = local_resource + 'img/model/add_approver_.png';
    $scope.notify = local_resource + 'img/icon/notify.png';
    $scope.content_left_icon= local_resource + 'img/icon/content-left-icon.png';
    $scope.my_approval_show_map=function(longitude,latitude,location){
      try {
		getLocation.checkCanLocation(
			function(result){
				if (result == 1){
					getLocation.showMapWithCoordinate({latitude: latitude, longitude: longitude, address: location});
				}
			}
		);

      }
      catch(e){
        console.log(e.message);
      }
    }
    var my_app_result='';
    if($stateParams.s_t=='未完成'){
      my_app_result='UC';
    }
    else{
      my_app_result='C';
    }


    $scope.map_icon=local_resource+'img/icon/map_icon.png';
    $scope.ot_code_n=$stateParams.ot_code_n;
	  essMyOutApplyDetailsContentSev.clearData();
    if($stateParams.is_process==1){
      essMyOutApplyDetailsContentSev.loadData($stateParams.p_inst,$stateParams.show_type,$stateParams.task_id);
    }
    else{
      essMyOutApplyDetailsContentSev.loadNoprocessData($stateParams.show_type,$stateParams.app_id);
    }

    $scope.ess_my_applyDC_data = essMyOutApplyDetailsContentSev.getData();
    $scope.fireEvent = function(i,arr){
      $timeout(function(){
        if(arr[i].action=='拒绝'){
          document.getElementById("approver_list_img"+i).src=$scope.icon_noapprove;
        }
        else if(arr[i].action=='批准'){
          document.getElementById("approver_list_img"+i).src=$scope.icon_confirm;
        }
        try {
          if (i == (arr.length - 1)) {
            document.getElementById("approver_list_img_" + i).style.display = "none";
          }
        }catch(e){

        }
        if(document.getElementById("approver_list_img_"+i)!=null){
          document.getElementById("approver_list_img_"+i).style.height=document.getElementById("approver_list_div" + i).offsetHeight+'px';
          document.getElementById("approver_list_div_"+i).style.height=(document.getElementById("approver_list_div" + i).offsetHeight-16)+'px';
        }

      }, 0);
    }
    $scope.show_img=function(url){
      if (ionic.Platform.isIOS()) {
        window.open(url, '_system', 'enableViewportScale=yes');
      } else {
        window.open(url, '_system');
      }
    }




    $scope.search_val = '';
    $scope.ess_empl_data = [];
    $scope.select_user_id = '';
    $scope.select_notify_id = '';
    $scope.click_flag = 0;
    $scope.essItemCk = function(user_id,img,en){
      var _d = [];
      if($scope.click_flag == 0){
        $scope.select_user_id = user_id;
        _d = $scope.ess_my_applyDC_data.approver_list;
      }else{
        return;
      }
      var _len = _d.length;
      if(_len == 0){
        _d.push({
          img:img,
          name:en,
          user_id:user_id,
          flag:2
        })
      }else{
        _d[_len-1] = {
          img:img,
          name:en,
          user_id:user_id,
          flag:2
        }
      }
      $scope.closeModal();
    }

    $scope.selectList = function(){
      if($scope.click_flag==1){
        var _d = [];
        $scope.select_notify_id = '';
        $scope.ess_my_applyDC_data.notify_list = [];
        for(var i=0;i<$scope.ess_empl_data.length;i++){
          if($scope.ess_empl_data[i].ck){
            $scope.select_notify_id = $scope.select_notify_id + ($scope.ess_empl_data)[i].user_id+',';
            $scope.ess_my_applyDC_data.notify_list.push({
              img:($scope.ess_empl_data)[i].img,
              name:($scope.ess_empl_data)[i].en,
              user_id:($scope.ess_empl_data)[i].user_id,
              flag:1
            });
          }
        }
        $scope.select_notify_id = ($scope.select_notify_id).substring(0,$scope.select_notify_id.length-1);
        $scope.closeModal();
      }
    }

    $ionicModal.fromTemplateUrl('ess-my-apply-empl-modal.html', {
      scope: $scope,
      animation: 'slide-in-up'
    }).then(function(modal) {
      $scope.modal = modal;
    });
    $scope.openModal = function() {
      $scope.search_val = '';
      $scope.click_flag = 0;
      $scope.ess_empl_data = [];
      var _d = $scope.ess_my_applyDC_data.approver_list;
      if(_d.length>0){
        var len = _d.length;
        $scope.select_user_id = _d[len-1].user_id;
      }
      essLvApplySev.loadEssEmplData($scope.select_user_id,$scope.ess_my_applyDC_data.employee_no,$scope.ess_my_applyDC_data.process_instance);
      $scope.ess_empl_data = essLvApplySev.getEssEmplData();
      $scope.modal.show();
    };
    $scope.openModal2 = function() {
      $scope.search_val = '';
      $scope.click_flag = 1;
      $scope.ess_empl_data = [];
      var _d = $scope.ess_my_applyDC_data.notify_list;
      $scope.select_notify_id='';
      for(var i=0;i<_d.length;i++){
        $scope.select_notify_id = $scope.select_notify_id + _d[i].user_id+',';
      }
      $scope.select_notify_id = $scope.select_notify_id.substring(0,$scope.select_notify_id.length-1);
      essLvApplySev.loadEssEmplData($scope.select_notify_id,$scope.ess_my_applyDC_data.employee_no,$scope.ess_my_applyDC_data.process_instance);
      $scope.ess_empl_data = essLvApplySev.getEssEmplData();
      $scope.modal.show();
    };
    $scope.closeModal = function() {
      $scope.modal.hide();
      $scope.ess_empl_data = [];
    };
    //$scope.$on('$destroy', function() {
    //  $scope.modal.remove();
    //});

    $scope.submitAction = function(action){
      essMyOtApplyDetailsContentSev.submitAction(action);
    }
    $scope.cancel= function () {
      if($scope.ess_my_applyDC_data.cancel){
        $ionicPopup.confirm({
          template: '<div style="text-align: center;font-size: 17px;">确认要撤销吗</div>',
          cancelType:'button-dark',
          cancelText: '取消',
          okText: '确认'
        }) .then(function(res) {
          if(res) {
			  var obj_id = '';
			  var biz_type_key = '';
			  if (typeof($scope.ess_my_applyDC_data.obj_id) != 'undefined'){
					 obj_id = $scope.ess_my_applyDC_data.obj_id;
				}
			  if (typeof($scope.ess_my_applyDC_data.biz_type_key) != 'undefined'){
					 biz_type_key = $scope.ess_my_applyDC_data.biz_type_key;
				}
            essMyOutApplyDetailsContentSev.submitAction('Cancel',my_app_result,$stateParams.is_process,obj_id,biz_type_key);
          }
        });

      }
      else{
        $ionicPopup.alert({
          title : '提醒',
          template : '<div style="text-align: center;">不能撤销</div>',
          okText : '确定'
        })
      }
    }

  })

  .controller('essMyApprovalDOCtrl',function($scope,essMyApprovalDOSev,essLvApplySev,$stateParams,$ionicModal,$location,$ionicScrollDelegate,$ionicNavBarDelegate,$ionicHistory,$timeout){
    if (ionic.Platform.isIOS()) {
      essMyApprovalDOSev.clearData();
      essMyApprovalDOSev.loadData($stateParams.type,'UC');
      $scope.essMyApprovalDOTData = essMyApprovalDOSev.getData();
    } else {
      $scope.$on("$ionicView.enter", function () {
        //解决 进入明细页面back回来的时候 会再次loaddata
        if (typeof($scope.data_loaded) != 'undefined') {
          return;
        }
        else {
          $scope.data_loaded = true;
        }
        essMyApprovalDOSev.clearData();
        essMyApprovalDOSev.loadData($stateParams.type,'UC');
        $scope.essMyApprovalDOTData = essMyApprovalDOSev.getData();
      });
    }
    //$scope.$on("$ionicView.enter", function () {
    //  //解决 进入明细页面back回来的时候 会再次loaddata
    //  if (typeof($scope.data_loaded) != 'undefined'){
    //    return;
    //  }
    //  else {
    //    $scope.data_loaded = true;
    //  }
    //  essMyApprovalDOSev.clearData();
    //  essMyApprovalDOSev.loadData($stateParams.type,'UC');
    //  $scope.essMyApprovalDOTData = essMyApprovalDOSev.getData();
    //});

    $scope.search_control = essMyApprovalDOSev.getSearchValue();
    //$scope.search_control.search_val = "";
    $scope.show_search = false;
    $scope.toggle_search = function() {
      $scope.show_search = true;
      $ionicScrollDelegate.scrollTop();
    }
    $scope.cancel_search = function() {
      $scope.show_search = false;
      $scope.search_control.search_val = '';
    }
    $scope.address_icon= local_resource + 'img/icon/address_icon.png';
	 // essMyApprovalDOSev.clearData();
    //essMyApprovalDOSev.loadData($stateParams.type,'UC');
    ////essMyApprovalDOSev.loadOtherData($stateParams.type,'C');
    //$scope.essMyApprovalDOTData = essMyApprovalDOSev.getData();
    //$scope.essMyApprovalDOTOtherData = essMyApprovalDOSev.getOtherData();
    $scope._flag="待处理";
    $scope.noapprove_click=function(){
      //essMyApprovalDOSev.loadData($stateParams.type,'UC');
      $scope._flag="待处理";
      document.getElementById('my_apply_details_noapprove').style.color='#53afff';
      document.getElementById('my_apply_details_approved').style.color='#808080';
      document.getElementById('ess_my_apply_details_tab_animate_div').style.webkitTransform='translateX(0)';

      document.getElementById('ess_my_apply_details_wrap').style.webkitTransform='translateX(0)';
      document.getElementById('ess_my_apply_details_wrap').style.overflow="visible";
      document.getElementById('ess_my_apply_details_noapprove_div').setAttribute("style","width:50%;");
      document.getElementById('ess_my_apply_details_approved_div').setAttribute("style","width: 50%;position: absolute;left:50%;top:0px;");
      $timeout(function(){ $ionicScrollDelegate.resize();
          document.getElementById('ess_my_apply_details_wrap').style.overflow="hidden";
        }, 200);



      //setTimeout(function(){ $ionicScrollDelegate.resize(); }, 200);
    }
    $scope.approved_click=function(){
      //essMyApprovalDOSev.loadData($stateParams.type,'C');
      $scope._flag="已处理";
      document.getElementById('my_apply_details_noapprove').style.color='#808080';
      document.getElementById('my_apply_details_approved').style.color='#53afff';
      document.getElementById('ess_my_apply_details_tab_animate_div').style.webkitTransform='translateX(100%)';

      document.getElementById('ess_my_apply_details_wrap').style.webkitTransform='translateX(-50%)';
      document.getElementById('ess_my_apply_details_wrap').style.overflow="visible";
      document.getElementById('ess_my_apply_details_noapprove_div').setAttribute("style","width:50%;position: absolute;left:0px;top:0px;");
      document.getElementById('ess_my_apply_details_approved_div').setAttribute("style","width: 50%;float: right");
        $timeout(function(){ $ionicScrollDelegate.resize();
          document.getElementById('ess_my_apply_details_wrap').style.overflow="hidden";
        }, 200);


      //setTimeout(function(){ $ionicScrollDelegate.resize(); }, 200);
    }
    $scope.loadMyApplyContent=function(p_inst,show_type,task_id,app_status,is_normal_path){

      $location.path("home_page/ess_my_approval_details_content_out/"+p_inst+"/"+show_type+"/"+task_id+"/"+app_status+'/'+is_normal_path+"/my_approval");
    }

  })

  .controller('essMyApprovalDFCOCtrl',function($emplComponentService,$scope,essMyApprovalDFCOSev,essLvApplySev,$stateParams,$ionicModal,$ionicActionSheet,$location,$timeout,$ionicPopup,sideSelect,$ionicScrollDelegate){
    $scope.fireEvent = function(i,arr,flag){
      $timeout(function(){
        if(document.getElementById("approver_list_img_"+i)!=null){
          document.getElementById("approver_list_img_"+i).style.height=document.getElementById("approver_list_div" + i).offsetHeight+'px';
          document.getElementById("approver_list_div_"+i).style.height=(document.getElementById("approver_list_div" + i).offsetHeight-16)+'px';
        }
        //if(arr[i].flag=='1'){
        //  document.getElementById("approver_list_img_"+(i-1)).src=$scope.approval_line;
        //}
        //else if(arr[i].flag=='2'){
        //  document.getElementById("approver_list_img_"+(i-1)).src=$scope.approval_line_gray;
        //}
        try {
          //if (i == (arr.length - 1)) {
          //  document.getElementById("approver_list_img_" + i).style.display = "none";
          //}
          if(i==arr.length-1&&flag==false){
            document.getElementById("approver_list_img_"+i).style.display="none";
          }
        }catch(e){

        }

      }, 0);
    }
    $scope.dates_line4x = local_resource + 'img/model/dates-line2x.png';
    $scope.icon_apply = local_resource + 'img/model/icon-apply@2x.png';
    $scope.approval_line = local_resource + 'img/model/approval-line@2x.png';
    $scope.icon_confirm = local_resource + 'img/model/icon-confirm@2x.png';
    $scope.icon_noappprove = local_resource + 'img/model/icon-noapprove.png';
    $scope.approval_line_gray = local_resource + 'img/model/approval-line-gray@2x.png';
    $scope.icon_waiting = local_resource + 'img/model/wait_approval.png';
    $scope.icon_wait = local_resource + 'img/model/icon-waiting@2x.png';
    $scope.approval_line_gray = local_resource + 'img/model/approval-line-gray@2x.png';
    $scope.add_approver = local_resource + 'img/model/add_approver.png';
    $scope.add_approver_ = local_resource + 'img/model/add_approver_.png';
    $scope.approve_icon= local_resource + 'img/icon/approve_icon.png';
    $scope.map_icon=local_resource+'img/icon/map_icon.png';
    $scope.content_left_icon=local_resource+'img/icon/content-left-icon.png';
    $scope.notify = local_resource + 'img/icon/notify.png';

    $scope.my_approval_show_map=function(longitude,latitude,location){
      try {
		getLocation.checkCanLocation(
			function(result){
				if (result == 1){
					getLocation.showMapWithCoordinate({latitude: latitude, longitude: longitude, address: location});
				}
			}
		);
      }
      catch(e){
        console.log(e.message);
      }
    }



    $scope.map_icon=local_resource+'img/icon/map_icon.png';
    var my_app_result='';
    if($stateParams.app_status=='待处理'){
      $scope.app_result=true;
      my_app_result='UC'
    }
    else{
      $scope.app_result=false;
      my_app_result='C';
    }

	essMyApprovalDFCOSev.clearData();
    essMyApprovalDFCOSev.loadData($stateParams.p_inst,$stateParams.show_type,$stateParams.task_id,my_app_result,$scope);

    $scope.ess_my_approvalDC_data = essMyApprovalDFCOSev.getData();

    //$scope.search_val = '';
    //$scope.ess_empl_data = [];
    //
    //$scope.select_notify_id = '';
    //$scope.click_flag = 0;
    //
    //$scope.selectList = function(){
    //  if($scope.click_flag==1){
    //    var _d = [];
    //    $scope.select_notify_id = '';
    //    $scope.ess_my_applyDC_data.notify_list = [];
    //    for(var i=0;i<$scope.ess_empl_data.length;i++){
    //      if($scope.ess_empl_data[i].ck){
    //        $scope.select_notify_id = $scope.select_notify_id + ($scope.ess_empl_data)[i].user_id+',';
    //        $scope.ess_my_applyDC_data.notify_list.push({
    //          img:($scope.ess_empl_data)[i].img,
    //          name:($scope.ess_empl_data)[i].en,
    //          user_id:($scope.ess_empl_data)[i].user_id,
    //          flag:1
    //        });
    //      }
    //    }
    //    $scope.select_notify_id = ($scope.select_notify_id).substring(0,$scope.select_notify_id.length-1);
    //    $scope.closeModal();
    //  }
    //}
    //
    //$scope.select_user_id='';
    //$ionicModal.fromTemplateUrl('ess-my-apply-empl-modal.html', {
    //  scope: $scope,
    //  animation: 'slide-in-up'
    //}).then(function(modal) {
    //  $scope.modal = modal;
    //});
    //$scope.openModal = function() {
    //  $scope.search_val = '';
    //  $scope.ess_empl_data = [];
    //  essLvApplySev.loadEssEmplData($scope.select_user_id,$scope.ess_my_approvalDC_data.employee_no,$scope.ess_my_approvalDC_data.process_instance);
    //  $scope.ess_empl_data = essLvApplySev.getEssEmplData();
    //  $scope.modal.show();
    //};
    //$scope.closeModal = function() {
    //  $scope.modal.hide();
    //  $scope.ess_empl_data = [];
    //};
    //$scope.$on('$destroy', function() {
    //  $scope.modal.remove();
    //});
    //$scope.essItemCk = function(user_id,img,en){
    //  var _d = [];
    //  $scope.select_user_id = user_id;
    //  _d = $scope.ess_my_approvalDC_data.approver_list;
    //  var flag = 0;
    //  var _len = _d.length;
    //  for(var i=0;i<_len;i++){
    //    if(angular.isDefined(_d[i]._flag)&&_d[i]._flag==1){
    //      flag = 1;
    //      break;
    //    }
    //  }
    //  if(flag == 0){
    //    _d.push({
    //      img:img,
    //      name:en,
    //      user_id:user_id,
    //      color:"#999",
    //      action:'下一层审批人',
    //      flag:1,
    //      _flag:1,
    //      attachment:'',
    //      approval_remark:''
    //    })
    //  }else{
    //    _d[_len-1] = {
    //      img:img,
    //      name:en,
    //      color:"#999",
    //      action:'下一层审批人',
    //      flag:1,
    //      user_id:user_id,
    //      _flag:1,
    //      attachment:'',
    //      approval_remark:''
    //    }
    //  }
    //  $scope.closeModal();
    //}

    $scope.search_control={};
    $scope.search_control.search_val = '';
    $scope.ess_empl_data = [];
    $scope.select_user_id = '';
    $scope.select_notify_id = '';
    $scope.click_flag = 0;

    $scope.essItemCk = function(user_id,img,en,_flag){
      if(_flag == true){
        $scope.ess_empl_data.num_checked =  $scope.ess_empl_data.num_checked + 1;
      }else{
        $scope.ess_empl_data.num_checked =  $scope.ess_empl_data.num_checked - 1;
      }
      var _d = [];
      if($scope.click_flag == 0){
        $scope.select_user_id = user_id;
        _d = $scope.ess_my_approvalDC_data.approver_list;
        var flag = 0;
        var _len = _d.length;
        for(var i=0;i<_len;i++){
          if(angular.isDefined(_d[i]._flag)&&_d[i]._flag==1){
            flag = 1;
            break;
          }
        }

        if(flag == 0){
          _d.push({
            img:img,
            name:en,
            user_id:user_id,
            action:'下一层审批人',
            flag:1,
            _flag:1,
            attachment:'',
            approval_remark:'',
            color:"#999"
          })
        }else{
          _d[_len-1] = {
            img:img,
            name:en,
            action:'下一层审批人',
            flag:1,
            user_id:user_id,
            _flag:1,
            attachment:'',
            approval_remark:'',
            color:"#999"
          }
        }

        $scope.closeModal();
      }else{
        var _d = [];
        if($scope.click_flag == 0){
          $scope.select_user_id = user_id;
          _d = $scope.lv_app_data.approver_list;
        }else{
          return;
        }
        var flag = 0;
        var _len = _d.length;
        for(var i=0;i<_len;i++){
          if(angular.isDefined(_d[i].flag)&&_d[i].flag==1){
            flag = 1;
            break;
          }
        }
        if(flag == 0){
          _d.push({
            img:img,
            name:en,
            user_id:user_id,
            flag:1
          })
        }else{
          _d[_len-1] = {
            img:img,
            name:en,
            user_id:user_id,
            flag:1
          }
        }
        $scope.approver_list=_d;
        $scope.search_control.search_val = '';
        $scope.closeModal();
      }

    }

    $scope.delete_notify=function(user_id){
      $('#essMyApprovalDFCO #notify_list_div').addClass('notify_list_active');
      if($scope.select_notify_id.indexOf(',')==-1){
        $scope.select_notify_id=$scope.select_notify_id.replace(user_id,'');
      }
      else if($scope.select_notify_id.indexOf(user_id+',')==-1){
        $scope.select_notify_id=$scope.select_notify_id.replace(','+user_id,'');
      }
      else{
        $scope.select_notify_id=$scope.select_notify_id.replace(user_id+',','');
      }
      for(var i=0;i<$scope.ess_my_approvalDC_data.notify_list.length;i++){
        if($scope.ess_my_approvalDC_data.notify_list[i].user_id==user_id){
          $scope.ess_my_approvalDC_data.notify_list.splice(i,1);
        }
      }
      setTimeout(function(){
        document.getElementById('notify_list_div').style.width=($scope.ess_my_approvalDC_data.notify_list.length+1)*100+20+'px';
        $ionicScrollDelegate.$getByHandle("notify_list_scroll").resize();
      },350)


    }

    $scope.selectList = function(){
      if($scope.click_flag==1){
        var _d = [];
        $scope.select_notify_id = '';
        $scope.ess_my_approvalDC_data.notify_list = [];
        for(var i=0;i<$scope.ess_empl_data.length;i++){
          if($scope.ess_empl_data[i].ck){
            $scope.select_notify_id = $scope.select_notify_id + ($scope.ess_empl_data)[i].user_id+',';
            $scope.ess_my_approvalDC_data.notify_list.push({
              img:($scope.ess_empl_data)[i].img,
              name:($scope.ess_empl_data)[i].en,
              user_id:($scope.ess_empl_data)[i].user_id,
              flag:1
            });
          }
        }
        $scope.select_notify_id = ($scope.select_notify_id).substring(0,$scope.select_notify_id.length-1);
        $scope.closeModal();
      }
      document.getElementById('notify_list_div').style.width=($scope.ess_my_approvalDC_data.notify_list.length+1)*100+20+'px';
      //alert($scope.lv_app_data.notify_list.length);

      $scope.search_control.search_val='';
      $ionicScrollDelegate.$getByHandle("notify_list_scroll").resize();
    }


    $ionicModal.fromTemplateUrl('ess-empl-modal.html', {
      scope: $scope,
      animation: 'slide-in-up'
    }).then(function(modal) {
      $scope.modal = modal;
    });
	/*
    $scope.openModal = function() {
      $scope.search_val = '';
      $scope.click_flag = 0;
      $scope.ess_empl_data = [];
      essLvApplySev.loadEssEmplData($scope.select_user_id,$scope.ess_my_approvalDC_data.employee_no,$scope.ess_my_approvalDC_data.process_instance);
      $scope.ess_empl_data = essLvApplySev.getEssEmplData();
      $scope.modal.show();
    };
    $scope.openModal2 = function() {
      //alert($scope.select_notify_id);
      $('#essMyApprovalDFCO #notify_list_div').removeClass('notify_list_active');
      $scope.search_val = '';
      $scope.click_flag = 1;
      $scope.ess_empl_data = [];
      essLvApplySev.loadEssEmplData($scope.select_notify_id,$scope.ess_my_approvalDC_data.employee_no,$scope.ess_my_approvalDC_data.process_instance);
      $scope.ess_empl_data = essLvApplySev.getEssEmplData();
      $scope.modal.show();
    };
	*/

	var routerName = '';
	if (typeof($stateParams.from_source) != 'undefined'){
		if ($stateParams.from_source == 'at_team_record'){
			routerName = 'default';
		}
		else if ($stateParams.from_source == 'my_approval'){
			routerName = 'default';
		}
		else if ($stateParams.from_source == 'home_message'){
			routerName = 'message';
		}
	}


	$scope.openModal = function() {

		var _d = [];
		_d = $scope.ess_my_approvalDC_data.approver_list;
		var flag = 0;
		var _len = _d.length;

		var flag = 0;
		for(var i=0;i<_len;i++){
		  if(angular.isDefined(_d[i]._flag)&&_d[i]._flag==1){
			flag = 1;
			break;
		  }
		}

		var selectEmplList = '';
		if (flag == 1){
			selectEmplList = _d[_len-1].employee_no;
		}

		$emplComponentService.open({
			title : '选择审批人', //弹开窗口标题
			barTitle : window.localStorage["org_top_level"],//导航开头
			isSingleSelect:true,//是否单选
			isShowContact:true,//是否展示常用联系人
			isNeedSaveContact:true,//是否保存常用联系人
			extName : '员工', //多选时提示后缀名
			selectEmplList:selectEmplList, //打开窗口默认选中员工列表
			routerName: routerName,
			sure : function (rd) { //返回数据，数组格式
				$scope.select_user_id = rd[0].user_id;

				if(flag == 0){
				  _d.push({
					employee_no:rd[0].empl_no,
					img:rd[0].img_src,
					name:rd[0].empl_name,
					user_id:rd[0].user_id,
					action:'下一层审批人',
					flag:1,
					_flag:1,
					attachment:'',
					approval_remark:'',
					color:"#999"
				  })
				}else{
				  _d[_len-1] = {
					employee_no:rd[0].empl_no,
					img:rd[0].img_src,
					name:rd[0].empl_name,
					action:'下一层审批人',
					flag:1,
					user_id:rd[0].user_id,
					_flag:1,
					attachment:'',
					approval_remark:'',
					color:"#999"
				  }
				}

			}
		});


    }

	$scope.openModal2 = function() {
		var selectEmplList = '';
		if ($scope.ess_my_approvalDC_data.notify_list.length != 0){
			for (var i=0;i<$scope.ess_my_approvalDC_data.notify_list.length;i++){
				selectEmplList += $scope.ess_my_approvalDC_data.notify_list[i].employee_no;
				if (i < $scope.ess_my_approvalDC_data.notify_list.length - 1){
					selectEmplList += ',';
				}
			}

		}

		$emplComponentService.open({
			title : '选择知会人', //弹开窗口标题
			barTitle : window.localStorage["org_top_level"],//导航开头
			isSingleSelect:false,//是否单选
			isShowContact:true,//是否展示常用联系人
			isNeedSaveContact:true,//是否保存常用联系人
			extName : '员工', //多选时提示后缀名
			selectEmplList:selectEmplList, //打开窗口默认选中员工列表
			routerName: routerName,
			/*
			params:{ //支持可用扩展参数
				"is_permissions":"0",
				"is_process":"0",
				"process_instance":'0',
				"ext_param":"aa"
			},
			*/
			sure : function (rd) { //返回数据，数组格式
				$('#notify_list_div').removeClass('notify_list_active');
				$scope.select_notify_id = '';
				$scope.ess_my_approvalDC_data.notify_list = [];
				for(var i=0;i<rd.length;i++){

					$scope.select_notify_id = $scope.select_notify_id + rd[i].user_id;
					$scope.ess_my_approvalDC_data.notify_list.push({
					  img:rd[i].img_src,
					  name:rd[i].empl_name,
					  user_id:rd[i].user_id,
					  employee_no:rd[i].empl_no,
					  flag:1
					});
					if (i < rd.length - 1){
						$scope.select_notify_id += ',';
					}
				}

				document.getElementById('notify_list_div').style.width=($scope.ess_my_approvalDC_data.notify_list.length+1)*100+20+'px';
				$ionicScrollDelegate.$getByHandle("notify_list_scroll").resize();
			}
		});

    }

    $scope.closeModal = function() {
      $scope.modal.hide();
      $scope.ess_empl_data = [];
      $scope.search_control.search_val='';
    };
    $scope.$on('$destroy', function() {
      $scope.modal.remove();
    });

    $scope.approval_date=[{
      key:'0',
      value:'批准'
    },{
      key:'1',
      value:'驳回'
    }]
    $scope.remark_flag=true;
    $scope.approval_index=0;
    $scope.approval_or_noapproval=function(){
      sideSelect.show({
        type : 'ios',
        data :$scope.approval_date,
        selectIndex :  $scope.approval_index,
        selectedFunc : function (index) {
          if(typeof(index)!='undefined'){
            document.getElementById("approval_answer").innerHTML= $scope.approval_date[index].value;
            index== '0' ? $scope.remark_flag=true : $scope.remark_flag=false;
            $scope.approval_index=index;
          }

        }
      });
    }
	//alert($stateParams.from_source);
    $scope.save=function(){
      if($scope.remark_flag==false&&document.getElementById('remark_textarea').value==''){

        $ionicPopup.alert({
          title: '提醒',
          template: '<div style="text-align: center;">请填写备注</div>',
          okText: '确定'
        })
      }
      else {
        if ($scope.remark_flag) {
          essMyApprovalDFCOSev.applyApprove($scope.select_user_id,$scope.select_notify_id,my_app_result,$stateParams.from_source);
        }
        else {
          essMyApprovalDFCOSev.applyReject($scope.select_user_id,$scope.select_notify_id,my_app_result,$stateParams.from_source);
        }
      }
    }
  })

  .controller('OutdoorTeamRecordCtrl',function($scope,$stateParams,zoomSlider,OutdoorTeamRecordSev,$ionicNavBarDelegate,$ionicHistory,$location,$timeout,timeSelect,$ionicScrollDelegate){
    if (ionic.Platform.isIOS()) {
      var _date='';
      var t=new Date();
      if(t.getMonth()+1<10){
        _date= t.getFullYear()+"/"+ '0'+(t.getMonth()+1)+'/'+ '01';
      }
      else{
        _date= t.getFullYear()+"/"+(t.getMonth()+1)+'/'+ '01';
      }
      OutdoorTeamRecordSev.clearData();
      OutdoorTeamRecordSev.loadData(_date,$scope);
      $scope.ot_team_record_data = OutdoorTeamRecordSev.getData();
    } else {
      $scope.$on("$ionicView.enter", function () {
        //解决 进入明细页面back回来的时候 会再次loaddata
        var _date='';
        var t=new Date();
        if(t.getMonth()+1<10){
          _date= t.getFullYear()+"/"+ '0'+(t.getMonth()+1)+'/'+ '01';
        }
        else{
          _date= t.getFullYear()+"/"+(t.getMonth()+1)+'/'+ '01';
        }
        if (typeof($scope.data_loaded) != 'undefined') {
          return;
        }
        else {
          $scope.data_loaded = true;
        }
        OutdoorTeamRecordSev.clearData();
        OutdoorTeamRecordSev.loadData(_date,$scope);
        $scope.ot_team_record_data = OutdoorTeamRecordSev.getData();
      });
    }

	$scope.show_img=function(url,e){
		window.event? window.event.cancelBubble = true : e.stopPropagation();
		var temp_array = [];
		temp_array.push(url);
		zoomSlider.show({data:temp_array, index:0});

	}

    $scope.$on("$ionicView.enter", function () {
      document.getElementById('details_div').onclick=function(){
        document.getElementById('details_div').style.color='#53afff';
        document.getElementById('details_div').style.backgroundColor='white';
        document.getElementById('details_div').style.border='none';
        document.getElementById('statistics_div').style.color='white';
        document.getElementById('statistics_div').style.backgroundColor='#53afff';
        document.getElementById('statistics_div').style.border='1px solid white';
        document.getElementById('statistics_div').style.borderLeft='none';
        document.getElementById('outdoor_team_record_wrap').style.webkitTransform='translateX(0)';
        //OutdoorTeamRecordSev.loadData(_date,$scope);
        //$scope.ot_team_record_data = OutdoorTeamRecordSev.getData();
        document.getElementsByClassName("details_cls")[0].style.display='block';
        document.getElementsByClassName("statistics_cls")[0].style.display='none';
        $ionicScrollDelegate.scrollTop();
        document.getElementById('outdoor_team_record_wrap').style.overflow="visible";
          document.getElementById('details_content_div').setAttribute("style","width:50%;");
          document.getElementById('statistics_content_div').setAttribute("style","width: 50%;position: absolute;left:50%;top:0px;");
          $timeout(function(){ $ionicScrollDelegate.resize();
            document.getElementById('outdoor_team_record_wrap').style.overflow="hidden";
          }, 200);

      }
      document.getElementById('statistics_div').onclick=function(){
        document.getElementById('statistics_div').style.border='none';
        document.getElementById('details_div').style.color='white';
        document.getElementById('details_div').style.backgroundColor='#53afff';
        document.getElementById('details_div').style.border='1px solid white';
        document.getElementById('details_div').style.borderRight='none';
        document.getElementById('statistics_div').style.color='#53afff';
        document.getElementById('statistics_div').style.backgroundColor='white';
        document.getElementById('outdoor_team_record_wrap').style.webkitTransform='translateX(-50%)';
        document.getElementById('outdoor_team_record_wrap').style.overflow="visible";
        document.getElementsByClassName("details_cls")[0].style.display='none';
        document.getElementsByClassName("statistics_cls")[0].style.display='block';


        $ionicScrollDelegate.scrollTop();
        document.getElementById('outdoor_team_record_wrap').style.overflow="visible";
        document.getElementById('details_content_div').setAttribute("style","width:50%;position: absolute;left:0px;top:0px;");
        document.getElementById('statistics_content_div').setAttribute("style","width: 50%;float: right");
          $timeout(function(){ $ionicScrollDelegate.resize();
            document.getElementById('outdoor_team_record_wrap').style.overflow="hidden";}, 200);




      }
    });
    $scope.search_control = {};
    $scope.search_control.search_val = "";
    $scope.icon_wait = local_resource + 'img/model/icon-waiting@2x.png';
    $scope.contract_management_directory1 = local_resource + 'img/icon/contract_management_directory1.png';
    $scope.is_pc_icon= local_resource + 'img/icon/is_pc_icon.png';
    $scope.img_team_attendance_iocation = local_resource+'img/icon/team_attendance_iocation.png';
    $scope.img_circle3 = local_resource+'img/icon/circle3.png';
    $scope.img_circle4 = local_resource+'img/icon/circle4.png';
    $scope.img_circle5 = local_resource+'img/icon/circle5.png';
    $scope.img_circle6 = local_resource+'img/icon/circle6.png';
    $scope.img_team_attendance_fingerprint = local_resource+'img/icon/team_attendance_fingerprint.png';
    $scope.img_normal_sign_in = local_resource+'img/icon/sign_in_normal.png';
    $scope.img_fieldwork_sign_in = local_resource+'img/icon/sign_in_fieldwork.png';
    $scope.img_other_sign_in = local_resource+'img/icon/sign_in_other_types.png';
    $scope.show_search = false;
    $scope.toggle_search = function() {
      $scope.show_search = true;
      //console.log( $scope.ot_team_record_data.data2);
      $ionicScrollDelegate.scrollTop();
      for(var i=0;i< $scope.ot_team_record_data.data2.data_list.length;i++){
        $scope.ot_team_record_data.data2.data_list[i].is_expand=false;
        $(".team_outdoor_"+ $scope.ot_team_record_data.data2.data_list[i].date+"_"+$scope.ot_team_record_data.data2.data_list[i].employee_no).css({"display":"none"});
      }
    }
    $scope.OutdoorTeamRecordBack=function(){

      OutdoorTeamRecordSev.clearStatusBar();
      $scope.statistics='外出统计';
      $ionicHistory.goBack();
    }
    $scope.cancel_search = function() {
      $scope.show_search = false;
      $scope.search_control.search_val = '';
    }
    $scope.statistics='外出统计';

    var _date='';
    var t=new Date();
    if(t.getMonth()+1<10){
      _date= t.getFullYear()+"/"+ '0'+(t.getMonth()+1)+'/'+ '01';
    }
    else{
      _date= t.getFullYear()+"/"+(t.getMonth()+1)+'/'+ '01';
    }

    $scope.date_year=t.getFullYear();
    if(t.getMonth()+1<10){
      $scope.date_month="0"+(t.getMonth()+1);
    }
    else{
      $scope.date_month=t.getMonth()+1;
    }

    //OutdoorTeamRecordSev.clearData();
    //OutdoorTeamRecordSev.loadData(_date,$scope);
    //$scope.ot_team_record_data = OutdoorTeamRecordSev.getData();
    //$scope.ot_team_record_statistics_data=OutdoorTeamRecordSev.getStatisticsData();
    //$scope.ot_team_record_statistics_data={"data_list":''};
    var d_date='';
    d_date=new Date().getFullYear()+'年'+ (new Date().getMonth()+1)+'月';
    $scope.showDate = function(){
      timeSelect.show({
        type :  'yearsMonth',
        startDate : '1993年12月01日',
        endDate : '',
        defaultDate: d_date ,
        returnDateType : 'ymd',
        returnTimeType :  '24h'||'AMPM',
        //stepping :10,
        selectedFunc : function (date) {
          if(typeof(date)=='undefined'){
          }
          else{
            _date=date.slice(0,4)+'/'+date.slice(5,7)+'/'+'01';
            $scope.date_year= date.slice(0,4);
            $scope.date_month=date.slice(5,7);
            d_date=date;

              OutdoorTeamRecordSev.loadData(_date,$scope);

          }
        }
      })
    }

    $scope.loadSearchMap=function(date,employee_no){
  //alert(date);
   try {
	 var _str = '_user_name=' + window.localStorage['_user_name'] + '&_pass_word=' + window.localStorage['_pass_word'] + '&_is_login=' + window.localStorage['_is_login'] + '&_notification_token=' + window.localStorage['_notification_token'] + '&_device_type=' + window.localStorage['_device_type'] + '&employee_no=' + employee_no;
	 var map_url = window.localStorage['_remote_server_addr'] + '?event=ionicAction.ionicAction.getOutdoorMapData&' + _str;
		getLocation.checkCanLocation(
			function(result){
				if (result == 1){
					 getLocation.singCountMap({url: map_url, target_date:date}, function (msg) {
					 });
				}
			}
		);

   }
      catch(e){
        console.log(e.message);
      }
    }

    //$scope.fireEvent = function(i,arr){
    //  var max_ot=arr.max_ot;
    //  console.log();
    //  $timeout(function(){
    //    document.getElementById('post_num_'+i).style.width= (arr.ot_data[i].ot_data[0].post_num/max_ot)*100+"%";
    //    document.getElementById('off_num_'+i).style.width= (arr.ot_data[i].ot_data[0].off_num/max_ot)*100+"%";
    //    document.getElementById('nh_num_'+i).style.width= (arr.ot_data[i].ot_data[0].nh_num/max_ot)*100+"%";
    //  }, 0);
    //}
    $scope.expand_item = function (current_item,$event,classname){

      $event.stopPropagation();
      if (current_item.is_expand){
        current_item.is_expand = false;
        $("."+classname).css({"display":"none"});
      }
      else{
        current_item.is_expand = true;
        $("."+classname).css({"display":"block"});
      }
      setTimeout(function(){ $ionicScrollDelegate.resize(); }, 200);
    }


    $scope.loadOtteamContent=function(process_instance,app_id){
        $location.path("home_page/home_menulist/outdoor_team_details_content/"+process_instance+"/"+app_id);
    }
  })

  .controller('essMyOutdoorApplyDetailsContentCtrl',function($scope,essMyOutdoorApplyDetailsContentSev,essLvApplySev,$stateParams,$ionicModal,$ionicActionSheet,$location,$ionicPopup,$timeout){
    $scope.dates_line2x = local_resource + 'img/model/dates-line2x.png';
    $scope.icon_apply = local_resource + 'img/model/icon-apply@2x.png';
    $scope.approval_line = local_resource + 'img/model/approval-line@2x.png';
    $scope.icon_confirm = local_resource + 'img/model/icon-confirm@2x.png';
    $scope.icon_noappprove = local_resource + 'img/model/icon-noapprove.png';
    $scope.approval_line_gray = local_resource + 'img/model/approval-line-gray@2x.png';
    $scope.icon_waiting = local_resource + 'img/model/wait_approval.png';
    $scope.icon_wait = local_resource + 'img/model/icon-waiting@2x.png';
    $scope.icon_noapprove =local_resource +'img/model/icon-noapprove.png';
    $scope.approval_line_gray = local_resource + 'img/model/approval-line-gray@2x.png';
    $scope.add_approver = local_resource + 'img/model/add_approver.png';
    $scope.add_approver_ = local_resource + 'img/model/add_approver_.png';
    $scope.notify = local_resource + 'img/icon/notify.png';
    $scope.content_left_icon= local_resource + 'img/icon/content-left-icon.png';
    $scope.map_icon=local_resource+'img/icon/map_icon.png';
    $scope.ot_code_n=$stateParams.ot_code_n;
	essMyOutdoorApplyDetailsContentSev.clearData();
    essMyOutdoorApplyDetailsContentSev.loadData($stateParams.process_instance,$stateParams.app_id);
    $scope.ess_my_applyDC_data = essMyOutdoorApplyDetailsContentSev.getData();
    $scope.fireEvent = function(i,arr){
      $timeout(function(){
        if(arr[i].action=='拒绝'){
          document.getElementById("approver_list_img"+i).src=$scope.icon_noapprove;
        }
        else if(arr[i].action=='批准'){
          document.getElementById("approver_list_img"+i).src=$scope.icon_confirm;
        }
        try {
          if (i == (arr.length - 1)) {
            document.getElementById("approver_list_img_" + i).style.display = "none";
          }
        }catch(e){

        }
        if(document.getElementById("approver_list_img_"+i)!=null){
          document.getElementById("approver_list_img_"+i).style.height=document.getElementById("approver_list_div" + i).offsetHeight+'px';
          document.getElementById("approver_list_div_"+i).style.height=(document.getElementById("approver_list_div" + i).offsetHeight-16)+'px';
        }

      }, 0);
    }
    $scope.show_img=function(url){
      if (ionic.Platform.isIOS()) {
        window.open(url, '_system', 'enableViewportScale=yes');
      } else {
        window.open(url, '_system');
      }
    }

    $scope.my_approval_show_map=function(longitude,latitude,location){
      try {
		getLocation.checkCanLocation(
			function(result){
				if (result == 1){
			        getLocation.showMapWithCoordinate({latitude: latitude, longitude: longitude, address: location});
				}
			}
		);
      }
      catch(e){
        console.log(e.message);
      }
    }


    $scope.search_val = '';
    $scope.ess_empl_data = [];
    $scope.select_user_id = '';
    $scope.select_notify_id = '';
    $scope.click_flag = 0;
    $scope.essItemCk = function(user_id,img,en){
      var _d = [];
      if($scope.click_flag == 0){
        $scope.select_user_id = user_id;
        _d = $scope.ess_my_applyDC_data.approver_list;
      }else{
        return;
      }
      var _len = _d.length;
      if(_len == 0){
        _d.push({
          img:img,
          name:en,
          user_id:user_id,
          flag:2
        })
      }else{
        _d[_len-1] = {
          img:img,
          name:en,
          user_id:user_id,
          flag:2
        }
      }
      $scope.closeModal();
    }

    $scope.selectList = function(){
      if($scope.click_flag==1){
        var _d = [];
        $scope.select_notify_id = '';
        $scope.ess_my_applyDC_data.notify_list = [];
        for(var i=0;i<$scope.ess_empl_data.length;i++){
          if($scope.ess_empl_data[i].ck){
            $scope.select_notify_id = $scope.select_notify_id + ($scope.ess_empl_data)[i].user_id+',';
            $scope.ess_my_applyDC_data.notify_list.push({
              img:($scope.ess_empl_data)[i].img,
              name:($scope.ess_empl_data)[i].en,
              user_id:($scope.ess_empl_data)[i].user_id,
              flag:1
            });
          }
        }
        $scope.select_notify_id = ($scope.select_notify_id).substring(0,$scope.select_notify_id.length-1);
        $scope.closeModal();
      }
    }

    $ionicModal.fromTemplateUrl('ess-my-apply-empl-modal.html', {
      scope: $scope,
      animation: 'slide-in-up'
    }).then(function(modal) {
      $scope.modal = modal;
    });
    $scope.openModal = function() {
      $scope.search_val = '';
      $scope.click_flag = 0;
      $scope.ess_empl_data = [];
      var _d = $scope.ess_my_applyDC_data.approver_list;
      if(_d.length>0){
        var len = _d.length;
        $scope.select_user_id = _d[len-1].user_id;
      }
      essLvApplySev.loadEssEmplData($scope.select_user_id,$scope.ess_my_applyDC_data.employee_no,$scope.ess_my_applyDC_data.process_instance);
      $scope.ess_empl_data = essLvApplySev.getEssEmplData();
      $scope.modal.show();
    };
    $scope.openModal2 = function() {
      $scope.search_val = '';
      $scope.click_flag = 1;
      $scope.ess_empl_data = [];
      var _d = $scope.ess_my_applyDC_data.notify_list;
      $scope.select_notify_id='';
      for(var i=0;i<_d.length;i++){
        $scope.select_notify_id = $scope.select_notify_id + _d[i].user_id+',';
      }
      $scope.select_notify_id = $scope.select_notify_id.substring(0,$scope.select_notify_id.length-1);
      essLvApplySev.loadEssEmplData($scope.select_notify_id,$scope.ess_my_applyDC_data.employee_no,$scope.ess_my_applyDC_data.process_instance);
      $scope.ess_empl_data = essLvApplySev.getEssEmplData();
      $scope.modal.show();
    };
    $scope.closeModal = function() {
      $scope.modal.hide();
      $scope.ess_empl_data = [];
    };
    //$scope.$on('$destroy', function() {
    //  $scope.modal.remove();
    //});

    $scope.submitAction = function(action){
      essMyOtApplyDetailsContentSev.submitAction(action);
    }
    $scope.cancel= function () {
      if($scope.ess_my_applyDC_data.cancel){
        $ionicPopup.confirm({
          template: '<div style="text-align: center;">确认要撤销吗</div>',
          cancelType:'button-dark',
          cancelText: '取消',
          okText: '确认'
        }) .then(function(res) {
          if(res) {
            essMyOtApplyDetailsContentSev.submitAction('Cancel');
          }
        });

      }
      else{
        $ionicPopup.alert({
          title : '提醒',
          template : '<div style="text-align: center;">不能撤销</div>',
          okText : '确定'
        })
      }
    }

  })
  .controller('homemessageCtrl',function($scope,homemessageSev,$stateParams,$location,$rootScope,$ionicPopup,$ionicHistory){

	$scope.home_message_icon_process_approval = local_resource +'img/icon/process_approval.png';
	$scope.home_message_icon_process_notice = local_resource +'img/icon/process_notice.png';
	$scope.home_message_icon_card_notice = local_resource +'img/icon/card_reminder.png';
	$scope.home_message_icon_secretary = local_resource +'img/icon/secretary.png';
	$scope.home_message_icon_notice = local_resource +'img/icon/notice.png';
	$scope.home_message_icon_system = local_resource +'img/icon/system.png';

	$scope.message_approval_data = homemessageSev.getApprovalMessageData();
	$scope.message_process_notice_data = homemessageSev.getProcessNoticeMessageData();
	$scope.message_card_notice_data = homemessageSev.getCardNoticeMessageData();
	$scope.message_secretary_data = homemessageSev.getSecretaryMessageData();
	$scope.message_notice_data = homemessageSev.getNoticeMessageData();
	$scope.message_system_data = homemessageSev.getSystemMessageData();



    $scope.home_message_icon= local_resource +'img/icon/';
	fufuMobclickAgent('click_home_message');


    $scope.img_exit_trial_login = local_resource + 'img/icon/exit_trial_login.png';
    if (window.localStorage["is_free_trial_login"] != null && typeof(window.localStorage["is_free_trial_login"]) != 'undefined' && window.localStorage["is_free_trial_login"] != '') {
      document.getElementById("home_message_is_trial_login").style.display='block';
    }
    else {
      document.getElementById("home_message_is_trial_login").style.display='none';
    }


    $scope.free_trial_log_out = function () {
      $ionicPopup.confirm({
        title: '退出登录',
        template: '<div style="text-align: center;">是否退出系统?</div>',
        cancelType:'button-dark',
        cancelText: '取消',
        okText: '确定'
      }).then(function (res) {
        if (res) {
          //$rootScope.showLoading();
          $.ajax({
            type: "GET",
            url: window.localStorage['_remote_server_addr']+'?event=ionicAction.ionicAction.doLogout',
            timeout: _var_timeout,
            success: function (data) {
              $rootScope.hideLoading();
            },
            error:function(data){
              $rootScope.hideLoading();
              /*
               $ionicPopup.alert({
               title : '提醒',
               template : '<div style="text-align: center;">'+fufu_network_error_msg+'</div>',
               okText : '确定'
               });
               */
            }
          });
          $ionicHistory.clearCache();
          $ionicHistory.clearHistory();
          window.localStorage['_pass_word']='';
          window.localStorage['_is_login']=0;
          if (window.localStorage["menu_list"] != null && typeof(window.localStorage["menu_list"]) != 'undefined' && window.localStorage["menu_list"] != ''){
            var model_list = window.localStorage["menu_list"].split(',');
            for (var i=0;i<model_list.length;i++){
              if (model_list[i] != ''){
                window.localStorage[model_list[i]] = '';
              }
            }
          }
          window.localStorage["menu_list"] = '';
          window.localStorage["menu_home"] = '';
          window.localStorage["menu_message"] = '';
          window.localStorage["menu_organization_management"] = '';
          window.localStorage["menu_time"] = '';
          window.localStorage["menu_payroll"] = '';
          window.localStorage["menu_ess"] = '';
          window.localStorage["menu_My_Team"] = '';
          window.localStorage["menu_setting"] = '';
          window.localStorage["personnal_data"] = '';
          window.localStorage['is_free_trial_login'] = '';
          login_init_flag = 0;
          $location.path('/');

        }
      });
    }




	$scope.refreshData=function(){
	  homemessageSev.refreshData($scope);
	}



    $scope.HomeMessageContent=function(message_type){
      if(message_type=='process_approval') {
		fufuMobclickAgent('menu_process_approval');
        $location.path("home_page/ess_my_approval_details_content_out_home_message/" + message_type);
      }
      else if(message_type=='process_notice'){
		fufuMobclickAgent('menu_process_notice');
        $location.path("home_page/ess_my_apply_details_content_out_home_message/" + message_type);
      }
      else if(message_type=='card_notice'){
        $location.path("home_page/home_message_card_notice");
      }
      else if(message_type=='secretary'){
        $location.path("home_page/home_message_secretary");
      }
      else if(message_type=='notice'){
        $location.path("home_page/home_message_notice");
      }
	  else if(message_type=='system'){
		$location.path("home_page/home_message_system");
	  }
    }
  })

  .controller('homeMessageContentCtrl',function($scope,homeMessageContentSev,$stateParams,$location,$ionicScrollDelegate,$timeout){
	$scope.no_notices=local_resource + 'img/icon/no_notices.png';
	$scope.address_icon= local_resource+ 'img/icon/address_icon.png';
    $scope.search_control = homeMessageContentSev.getSearchValue();
	$scope.leave_bg=local_resource +'img/model/leave_bg.png';
    $scope.overtime_bg=local_resource +'img/model/overtime_bg.png';
    $scope.outdoor_bg=local_resource +'img/model/outdoor_bg.png';
    $scope.work_out_bg=local_resource +'img/model/work_out_bg.png';
    $scope.fieldwork_bg=local_resource +'img/model/fieldwork_bg.png';
    $scope.timeline=local_resource +'img/icon/Timeline.png';
    $scope.arroworange=local_resource +'img/icon/arroworange.png';
    $scope.arrowblue=local_resource +'img/icon/arrowblue.png';
    $scope.message_type=$stateParams.message_type;
    $scope.show_search = false;
    $scope.toggle_search = function() {
      $scope.show_search = true;
      $ionicScrollDelegate.scrollTop();
    }
    $scope.cancel_search = function() {
      $scope.show_search = false;
      $scope.search_control.search_val = '';
    }
    if (ionic.Platform.isIOS()) {
      homeMessageContentSev.clearData();
      homeMessageContentSev.loadData($stateParams.message_type);
      $scope.home_message_content_date = homeMessageContentSev.getData();
    } else {
      $scope.$on("$ionicView.enter", function () {
        //解决 进入明细页面back回来的时候 会再次loaddata
        if (typeof($scope.data_loaded) != 'undefined') {
          return;
        }
        else {
          $scope.data_loaded = true;
        }
        homeMessageContentSev.clearData();
        homeMessageContentSev.loadData($stateParams.message_type);
        $scope.home_message_content_date = homeMessageContentSev.getData();
      });
    }
    //homeMessageContentSev.clearData();
    //homeMessageContentSev.loadData($stateParams.message_type);
    //$scope.home_message_content_date = homeMessageContentSev.getData();



    $scope.fireEvent = function(i){

      $timeout(function(){
        document.getElementsByClassName("repeat_right_icon")[i].style.height=document.getElementsByClassName("repeat_content")[i].offsetHeight+10+'px';
        document.getElementsByClassName("repeat_left_title")[i].style.height=document.getElementsByClassName("r epeat_right_icon")[i].offsetHeight+'px';

      }, 0);
    }


    $scope.home_message_path=function(type,p_inst,show_type,task_id,app_status,ot_code_n,is_normal_path){
      if(type=='fieldwork_bill'){
        $location.path("home_page/ess_my_approval_details_content_out_msg/"+p_inst+"/"+show_type+"/"+task_id+"/"+app_status+'/'+is_normal_path+"/home_message");
      }
      else if(type=='leave'){
          var my_app_result='';
          if(app_status=="待处理"){
            my_app_result="UC";
          }
          else{
            my_app_result="C";
          }
          $location.path("home_page/ess_my_approval_details_content_msg/"+p_inst+"/"+show_type+"/"+task_id+"/"+my_app_result+"/"+is_normal_path+"/home_message");
      }
      else if(type=='overtime'){
          $location.path("home_page/ess_my_approval_details_content_overtime_msg/"+p_inst+"/"+show_type+"/"+task_id+"/"+app_status+"/"+ot_code_n+"/"+is_normal_path+"/home_message");
      }
      else if(type=='fieldwork'){
          var my_app_result='';
          if(app_status=="待处理"){
            my_app_result="UC";
          }
          else{
            my_app_result="C";
          }
          $location.path("home_page/ess_my_approval_details_content_fieldwork_msg/"+p_inst+"/"+show_type+"/"+task_id+"/"+my_app_result+"/"+is_normal_path+"/home_message");
      }
      else if(type=='offic_work_out'){
          var my_app_result='';
          if(app_status=="待处理"){
            my_app_result="UC";
          }
          else{
            my_app_result="C";
          }
          $location.path("home_page/ess_my_approval_details_content_offic_work_out_msg/"+p_inst+"/"+show_type+"/"+task_id+"/"+my_app_result+"/"+is_normal_path+"/home_message");
      }
	  else if(type=="at_daily_adj"){
          var my_app_result='';
          if(app_status=="待处理"){
            my_app_result="UC";
          }
          else{
            my_app_result="C";
          }
		  $location.path("home_page/ess_my_approval_details_card_adj_content_msg/"+p_inst+"/"+show_type+"/"+task_id+"/"+my_app_result+"/"+is_normal_path+"/home_message");
	  }

    }
  })

  .controller('homeMessageDetailCtrl',function($scope,homeMessageDetailSev,$stateParams,$location,$ionicScrollDelegate,$timeout,$ionicHistory,$ionicModal){

	$scope.address_icon= local_resource+ 'img/icon/address_icon.png';
    $scope.leave_bg=local_resource +'img/model/leave_bg.png';
    $scope.overtime_bg=local_resource +'img/model/overtime_bg.png';
    $scope.outdoor_bg=local_resource +'img/model/outdoor_bg.png';
    $scope.work_out_bg=local_resource +'img/model/work_out_bg.png';
    $scope.fieldwork_bg=local_resource +'img/model/fieldwork_bg.png';
    $scope.timeline=local_resource +'img/icon/Timeline.png';
    $scope.arroworange=local_resource +'img/icon/arroworange.png';
    $scope.arrowred=local_resource +'img/icon/arrowred.png';
	$scope.not_data=local_resource + "img/not_data.png";
	$scope.cry=local_resource + "img/cry.png";
	$scope.search_img = local_resource+'img/search_img.png';
	$scope.no_notices=local_resource + 'img/icon/no_notices.png';
    $scope.message_type=$stateParams.message_type;



    //$scope.$on("$ionicView.enter", function () {
    //  //解决 进入明细页面back回来的时候 会再次loaddata
    //  if (typeof($scope.data_loaded) != 'undefined'){
    //    return;
    //  }
    //  else {
    //    $scope.data_loaded = true;
    //  }
    //  homeMessageDetailSev.clearData();
    //  homeMessageDetailSev.loadData($stateParams.message_type,$scope.search_control.search_val);
    //  $scope.home_message_detail_date = homeMessageDetailSev.getData();
    //
    //});
    $scope.search_control=homeMessageDetailSev.getSearchValue();
	$scope.searchState=homeMessageDetailSev.getSearchState();
	$scope.searchNodata= homeMessageDetailSev.getSearchNodata();
    $scope.end_of_list = homeMessageDetailSev.getEndOfList();


      $scope.$on("$ionicView.enter", function () {
        //解决 进入明细页面back回来的时候 会再次loaddata
        if (typeof($scope.data_loaded) != 'undefined') {

		if($scope.search_control.search_val!=''){

			document.getElementById("homeMessageDetailSearchDiv").style.display='block';
			document.getElementById("homeMessageDetailSearchDiv").style.opacity='1';
			document.getElementById("homeMessageDetailBack").style.display='none';
			document.getElementById("homeMessageDetailSearchInput").value=$scope.search_control.search_val;

		}
          return;
        }
        else {
          $scope.data_loaded = true;
        }
    if (ionic.Platform.isIOS()) {
		  homeMessageDetailSev.clearData();
		  homeMessageDetailSev.loadData($stateParams.message_type,$scope.search_control.search_val);
		  $scope.home_message_detail_date = homeMessageDetailSev.getData();
		  $scope.content_top='64';

	} else {
		$scope.content_top='44';
		homeMessageDetailSev.clearData();
		homeMessageDetailSev.loadData($stateParams.message_type,$scope.search_control.search_val);
		$scope.home_message_detail_date = homeMessageDetailSev.getData();
    }



      });



    $scope.loadMoreData = function(){
      homeMessageDetailSev.loadMoreData($scope,$stateParams.message_type,$scope.search_control.search_val);
    }
    /*
    $scope.fireEvent = function(i){

      $timeout(function(){
        document.getElementsByClassName("repeat_right_icon")[i].style.height=document.getElementsByClassName("repeat_content")[i].offsetHeight+10+'px';
        document.getElementsByClassName("repeat_left_title")[i].style.height=document.getElementsByClassName("repeat_right_icon")[i].offsetHeight+'px';

      }, 0);
    }
    */


    $scope.home_message_path=function(type,p_inst,show_type,task_id,app_status,ot_code_n,is_normal_path){
      if(type=='fieldwork_bill'){
        $location.path("home_page/ess_my_approval_details_content_out_msg/"+p_inst+"/"+show_type+"/"+task_id+"/"+app_status+'/'+is_normal_path+"/home_message");
      }
      else if(type=='leave'){
        var my_app_result='';
        if(app_status=="待处理"){
          my_app_result="UC";
        }
        else{
          my_app_result="c";
        }
        $location.path("home_page/ess_my_approval_details_content_msg/"+p_inst+"/"+show_type+"/"+task_id+"/"+my_app_result+"/"+is_normal_path+"/home_message");
      }
      else if(type=='overtime'){
        $location.path("home_page/ess_my_approval_details_content_overtime_msg/"+p_inst+"/"+show_type+"/"+task_id+"/"+app_status+"/"+ot_code_n+"/"+is_normal_path+"/home_message");
      }
      else if(type=='fieldwork'){
        var my_app_result='';
        if(app_status=="待处理"){
          my_app_result="UC";
        }
        else{
          my_app_result="C";
        }
        $location.path("home_page/ess_my_approval_details_content_fieldwork_msg/"+p_inst+"/"+show_type+"/"+task_id+"/"+my_app_result+"/"+is_normal_path+"/home_message");
      }
      else if(type=='offic_work_out'){
        var my_app_result='';
        if(app_status=="待处理"){
          my_app_result="UC";
        }
        else{
          my_app_result="C";
        }
        $location.path("home_page/ess_my_approval_details_content_offic_work_out_msg/"+p_inst+"/"+show_type+"/"+task_id+"/"+my_app_result+"/"+is_normal_path+"/home_message");
      }
	  else if(type=="at_daily_adj"){
        if(app_status=="待处理"){
          my_app_result="UC";
        }
        else{
          my_app_result="C";
        }
		  $location.path("home_page/ess_my_approval_details_card_adj_content_msg/"+p_inst+"/"+show_type+"/"+task_id+"/"+my_app_result+'/'+is_normal_path+"/home_message");
	  }

    }


	$scope.search=function(){
		homeMessageDetailSev.loadData('process_notice',$scope.search_control.search_val);
	}

  })

  .controller('essMyApplyDOCtrl',function($scope,essMyApplyDSev,essLvApplySev,$stateParams,$ionicModal,$location,$ionicScrollDelegate,$ionicHistory,$timeout){
    if (ionic.Platform.isIOS()) {
      essMyApplyDSev.clearData();
      essMyApplyDSev.loadData($stateParams.type,'UC');
      $scope.ess_my_applyD_data = essMyApplyDSev.getData();
    } else {
      $scope.$on("$ionicView.enter", function () {
        //解决 进入明细页面back回来的时候 会再次loaddata
        if (typeof($scope.data_loaded) != 'undefined') {
          return;
        }
        else {
          $scope.data_loaded = true;
        }
        essMyApplyDSev.clearData();
        essMyApplyDSev.loadData($stateParams.type,'UC');
        $scope.ess_my_applyD_data = essMyApplyDSev.getData();
      });
    }
    //$scope.$on("$ionicView.enter", function () {
    //  //解决 进入明细页面back回来的时候 会再次loaddata
    //  if (typeof($scope.data_loaded) != 'undefined'){
    //    return;
    //  }
    //  else {
    //    $scope.data_loaded = true;
    //  }
    //  essMyApplyDSev.clearData();
    //  essMyApplyDSev.loadData($stateParams.type,'UC');
    //  $scope.ess_my_applyD_data = essMyApplyDSev.getData();
    //});
    $scope.search_control = essMyApplyDSev.getSearchValue();
    //$scope.search_control.search_val = "";
    $scope.show_search = false;
    $scope.toggle_search = function() {
      $scope.show_search = true;
      $ionicScrollDelegate.scrollTop();
    }
    $scope.cancel_search = function() {
      $scope.show_search = false;
      $scope.search_control.search_val = '';
    }
    $scope.address_icon= local_resource+ 'img/icon/address_icon.png'
    $scope.ess_my_apply_details_title=$stateParams.name;
    //essMyApplyDSev.clearData();
    //essMyApplyDSev.loadData($stateParams.type,'UC');
    ////essMyApplyDSev.loadOtherData($stateParams.type,'C');
    //$scope.ess_my_applyD_data = essMyApplyDSev.getData();
    //$scope.ess_my_applyD_other_data = essMyApplyDSev.getOtherData();
    $scope._flag = "未完成";
    $scope.noapprove_click=function(){
      $scope._flag = "未完成";

      document.getElementById('my_apply_details_noapprove').style.color='#53afff';
      document.getElementById('my_apply_details_approved').style.color='black';
      document.getElementById('ess_my_apply_details_tab_animate_div').style.webkitTransform='translateX(0)';
      document.getElementById('ess_my_apply_details_wrap').style.webkitTransform='translateX(0)';
      document.getElementById('ess_my_apply_details_wrap').style.overflow="visible";
      document.getElementById('ess_my_apply_details_noapprove_div').setAttribute("style","width:50%;");
      document.getElementById('ess_my_apply_details_approved_div').setAttribute("style","width: 50%;position: absolute;left:50%;top:0px;");
      $timeout(function(){ $ionicScrollDelegate.resize();
          document.getElementById('ess_my_apply_details_wrap').style.overflow="hidden";
        }, 200);



    }
    $scope.approved_click=function(){
      $scope._flag = "已完成";

      document.getElementById('my_apply_details_noapprove').style.color='black';
      document.getElementById('my_apply_details_approved').style.color='#53afff';
      document.getElementById('ess_my_apply_details_tab_animate_div').style.webkitTransform='translateX(100%)';
      document.getElementById('ess_my_apply_details_wrap').style.webkitTransform='translateX(-50%)';
      document.getElementById('ess_my_apply_details_wrap').style.overflow="visible";
      document.getElementById('ess_my_apply_details_noapprove_div').setAttribute("style","width:50%;position: absolute;left:0px;top:0px;");
      document.getElementById('ess_my_apply_details_approved_div').setAttribute("style","width: 50%;float: right");
      $timeout(function(){ $ionicScrollDelegate.resize();
          document.getElementById('ess_my_apply_details_wrap').style.overflow="hidden";
        }, 200);


    }
    $scope.loadMyApplyContent=function(p_inst,show_type,task_id,s_t,is_process,rec_id){

      $location.path("home_page/ess_my_apply_details_content_offic_work_out/"+p_inst+"/"+show_type+"/"+task_id+"/"+s_t+"/"+is_process+"/"+rec_id+"/my_apply");
    }

  })


  .controller('essMyApplyDetailsContentOfficWorkCtrl',function($scope,essMyApplyDetailsContentOfficWorkSev,essLvApplySev,$stateParams,$ionicModal,$ionicActionSheet,$location,$ionicPopup,$timeout,zoomSlider){
    $scope.dates_line2x = local_resource + 'img/model/dates-line2x.png';
    $scope.icon_apply = local_resource + 'img/model/icon-apply@2x.png';
    $scope.approval_line = local_resource + 'img/model/approval-line@2x.png';
    $scope.icon_confirm = local_resource + 'img/model/icon-confirm@2x.png';
    $scope.icon_noappprove = local_resource + 'img/model/icon-noapprove.png';
    $scope.approval_line_gray = local_resource + 'img/model/approval-line-gray@2x.png';
    $scope.icon_waiting = local_resource + 'img/model/wait_approval.png';
    $scope.icon_wait = local_resource + 'img/model/icon-waiting@2x.png';
    $scope.approval_line_gray = local_resource + 'img/model/approval-line-gray@2x.png';
    $scope.add_approver = local_resource + 'img/model/add_approver.png';
    $scope.add_approver_ = local_resource + 'img/model/add_approver_.png';
    $scope.map_icon= local_resource + 'img/icon/map_icon.png';
    $scope.content_left_icon= local_resource + 'img/icon/content-left-icon.png';
    $scope.apply_content_fieldwork_title='我的异地单';
    var my_app_result='';
    if($stateParams.s_t=='未完成'){
      my_app_result='UC';
    }
    else{
      my_app_result='C';
    }

    $scope.my_approval_show_map=function(longitude,latitude,location){
      try {
		getLocation.checkCanLocation(
			function(result){
				if (result == 1){
			        getLocation.showMapWithCoordinate({latitude: latitude, longitude: longitude, address: location});
				}
			}
		);
      }
      catch(e){
        console.log(e.message);
      }
    }
    $scope.show_img=function(url){
		var temp_array = [];
		temp_array.push(url);
		zoomSlider.show({data:temp_array, index:0});
		/*
      if (ionic.Platform.isIOS()) {
        window.open(url, '_system', 'enableViewportScale=yes');
      } else {
        window.open(url, '_system');
      }
	  */
    }
	essMyApplyDetailsContentOfficWorkSev.clearData();
    if($stateParams.is_process==1){
      essMyApplyDetailsContentOfficWorkSev.loadData($stateParams.p_inst,$stateParams.show_type,$stateParams.task_id,$scope);
    }
    else{
      essMyApplyDetailsContentOfficWorkSev.loadNoprocessData($stateParams.show_type,$stateParams.rec_id,$scope);
    }

    $scope.ess_my_applyDC_Fieldwork_data = essMyApplyDetailsContentOfficWorkSev.getData();

    $scope.fireEvent = function(i,arr){
      $timeout(function(){
        if(document.getElementById("approver_list_img_"+i)!=null){
          document.getElementById("approver_list_img_"+i).style.height=document.getElementById("approver_list_div" + i).offsetHeight+'px';
          document.getElementById("approver_list_div_"+i).style.height=(document.getElementById("approver_list_div" + i).offsetHeight-16)+'px';
        }

        try {
          if (i == arr.length - 1) {
            document.getElementById("approver_list_img_" + i).style.display = "none";
          }
        }
        catch(e){

        }
      }, 0);
    }
    //$scope.submitAction = function(action){
    //  essMyApplyDetailsContentFieldworkSev.submitAction(action);
    //}
    $scope.cancel= function () {
      $ionicPopup.confirm({
        template: '<div style="text-align: center;">确认要撤销吗</div>',
        cancelType:'button-dark',
        cancelText: '取消',
        okText: '确认'
      }) .then(function(res) {
        if(res) {
			  var obj_id = '';
			  var biz_type_key = '';
			  if (typeof($scope.ess_my_applyDC_Fieldwork_data.obj_id) != 'undefined'){
					 obj_id = $scope.ess_my_applyDC_Fieldwork_data.obj_id;
				}
			  if (typeof($scope.ess_my_applyDC_Fieldwork_data.biz_type_key) != 'undefined'){
					 biz_type_key = $scope.ess_my_applyDC_Fieldwork_data.biz_type_key;
				}
            essMyApplyDetailsContentOfficWorkSev.submitAction('Cancel',my_app_result,$stateParams.is_process,obj_id,biz_type_key);
        }
      });

    }
  })

  .controller('essMyApprovalDOFCtrl',function($scope,essMyApprovalDFSev,essLvApplySev,$stateParams,$ionicModal,$location,$ionicScrollDelegate,$ionicHistory,$timeout){
    if (ionic.Platform.isIOS()) {
      essMyApprovalDFSev.clearData();
      essMyApprovalDFSev.loadData($stateParams.type,"UC");
      $scope.ess_my_approvalD_data = essMyApprovalDFSev.getData();
    } else {
      $scope.$on("$ionicView.enter", function () {
        //解决 进入明细页面back回来的时候 会再次loaddata
        if (typeof($scope.data_loaded) != 'undefined') {
          return;
        }
        else {
          $scope.data_loaded = true;
        }
        essMyApprovalDFSev.clearData();
        essMyApprovalDFSev.loadData($stateParams.type,"UC");
        $scope.ess_my_approvalD_data = essMyApprovalDFSev.getData();
      });
    }
    //$scope.$on("$ionicView.enter", function () {
    //  //解决 进入明细页面back回来的时候 会再次loaddata
    //  if (typeof($scope.data_loaded) != 'undefined'){
    //    return;
    //  }
    //  else {
    //    $scope.data_loaded = true;
    //  }
    //  essMyApprovalDFSev.clearData();
    //  essMyApprovalDFSev.loadData($stateParams.type,"UC");
    //  $scope.ess_my_approvalD_data = essMyApprovalDFSev.getData();
    //});
    $scope.search_control = essMyApprovalDFSev.getSearchValue();
    //$scope.search_control.search_val = "";
    $scope.show_search = false;
    $scope.toggle_search = function() {
      $scope.show_search = true;
      $ionicScrollDelegate.scrollTop();
    }
    $scope.cancel_search = function() {
      $scope.show_search = false;
      $scope.search_control.search_val = '';
    }
    $scope.address_icon= local_resource + 'img/icon/address_icon.png';
    $scope.ess_my_approval_details_title=$stateParams.name +"审批";
	 // essMyApprovalDFSev.clearData();
    //essMyApprovalDFSev.loadData($stateParams.type,"UC");
    ////essMyApprovalDFSev.loadOtherData($stateParams.type,"C");
    //$scope.ess_my_approvalD_data = essMyApprovalDFSev.getData();
    //$scope.ess_my_approvalD_other_data = essMyApprovalDFSev.getOtherData();
    $scope._flag="待处理";
    $scope.noapprove_click=function(){
      $scope._flag="待处理";
      document.getElementById('my_apply_details_noapprove').style.color='#53afff';
      document.getElementById('my_apply_details_approved').style.color='#808080';
      document.getElementById('ess_my_apply_details_tab_animate_div').style.webkitTransform='translateX(0)';

      document.getElementById('ess_my_apply_details_wrap').style.webkitTransform='translateX(0)';
      document.getElementById('ess_my_apply_details_wrap').style.overflow="visible";
      document.getElementById('ess_my_apply_details_noapprove_div').setAttribute("style","width:50%;");
      document.getElementById('ess_my_apply_details_approved_div').setAttribute("style","width: 50%;position: absolute;left:50%;top:0px;");
      $timeout(function(){ $ionicScrollDelegate.resize();
          document.getElementById('ess_my_apply_details_wrap').style.overflow="hidden";
        }, 200);



      //essMyApprovalDFSev.loadData($stateParams.type,"UC");
      //setTimeout(function(){ $ionicScrollDelegate.resize(); }, 200);
    }
    $scope.approved_click=function(){
      $scope._flag="已处理";
      document.getElementById('my_apply_details_noapprove').style.color='#808080';
      document.getElementById('my_apply_details_approved').style.color='#53afff';
      document.getElementById('ess_my_apply_details_tab_animate_div').style.webkitTransform='translateX(100%)';

      document.getElementById('ess_my_apply_details_wrap').style.webkitTransform='translateX(-50%)';
      document.getElementById('ess_my_apply_details_wrap').style.overflow="visible";
      document.getElementById('ess_my_apply_details_noapprove_div').setAttribute("style","width:50%;position: absolute;left:0px;top:0px;");
      document.getElementById('ess_my_apply_details_approved_div').setAttribute("style","width: 50%;float: right");
        $timeout(function(){ $ionicScrollDelegate.resize();
          document.getElementById('ess_my_apply_details_wrap').style.overflow="hidden";
        }, 200);

      //essMyApprovalDFSev.loadData($stateParams.type,"C");
      //setTimeout(function(){ $ionicScrollDelegate.resize(); }, 200);
    }
    $scope.loadMyApplyContent=function(p_inst,show_type,task_id,my_app_result,is_normal_path){
      if(my_app_result=="待处理"){
        my_app_result="UC";
      }
      else{
        my_app_result="C";
      }
      $location.path("home_page/ess_my_approval_details_content_offic_work_out/"+p_inst+"/"+show_type+"/"+task_id+"/"+my_app_result+"/"+is_normal_path+"/my_approval");
    }
  })

  .controller('essMyApprovalDCOCtrl',function($emplComponentService,$scope,essMyApprovalDCOSev,essLvApplySev,$stateParams,$ionicModal,$ionicActionSheet,$location,$timeout,$ionicPopup,sideSelect,$ionicScrollDelegate,zoomSlider){

      $scope.approval_content_fieldwork_title='异地单审批';
      $scope.fireEvent = function(i,arr,flag){
      $timeout(function(){
        if(document.getElementById("approver_list_img_"+i)!=null){
          document.getElementById("approver_list_img_"+i).style.height=document.getElementById("approver_list_div" + i).offsetHeight+'px';
          document.getElementById("approver_list_div_"+i).style.height=(document.getElementById("approver_list_div" + i).offsetHeight-16)+'px';
        }
        if(i==arr.length-1&&flag==false){
          document.getElementById("approver_list_img_"+i).style.display="none";
        }
      }, 0);
    }
    $scope.dates_line2x = local_resource + 'img/model/dates-line2x.png';
    $scope.icon_apply = local_resource + 'img/model/icon-apply@2x.png';
    $scope.approval_line = local_resource + 'img/model/approval-line@2x.png';
    $scope.icon_confirm = local_resource + 'img/model/icon-confirm@2x.png';
    $scope.icon_noappprove = local_resource + 'img/model/icon-noapprove.png';
    $scope.approval_line_gray = local_resource + 'img/model/approval-line-gray@2x.png';
    $scope.icon_waiting = local_resource + 'img/model/wait_approval.png';
    $scope.icon_wait = local_resource + 'img/model/icon-waiting@2x.png';
    $scope.approval_line_gray = local_resource + 'img/model/approval-line-gray@2x.png';
    $scope.add_approver = local_resource + 'img/model/add_approver.png';
    $scope.add_approver_ = local_resource + 'img/model/add_approver_.png';
    $scope.approve_icon= local_resource + 'img/icon/approve_icon.png';
    $scope.map_icon=local_resource+'img/icon/map_icon.png';
    $scope.notify= local_resource + 'img/icon/notify.png';
    $scope.content_left_icon=local_resource+'img/icon/content-left-icon.png';
	  essMyApprovalDCOSev.clearData();
    essMyApprovalDCOSev.loadData($stateParams.p_inst,$stateParams.show_type,$stateParams.task_id,$stateParams.my_app_result,$scope);
    if($stateParams.my_app_result=='C'){
      $scope.app_result=false;
    }
    else{
      $scope.app_result=true;
    }

    $scope.my_approval_show_map=function(longitude,latitude,location){
      try {
		getLocation.checkCanLocation(
			function(result){
				if (result == 1){
			        getLocation.showMapWithCoordinate({latitude: latitude, longitude: longitude, address: location});
				}
			}
		);
      }
      catch(e){
        console.log(e.message);
      }
    }
    $scope.show_img=function(url){
		var temp_array = [];
		temp_array.push(url);
		zoomSlider.show({data:temp_array, index:0});
		/*
      if (ionic.Platform.isIOS()) {
        window.open(url, '_system', 'enableViewportScale=yes');
      } else {
        window.open(url, '_system');
      }
	  */
    }
    $scope.ess_my_approvalDC_data = essMyApprovalDCOSev.getData();
    $scope.search_control={};
    $scope.search_control.search_val = '';
    $scope.ess_empl_data = [];
    $scope.select_notify_id = '';
    $scope.click_flag = 0;


    $scope.delete_notify=function(user_id){
      $('#essMyApprovalDCO #notify_list_div').addClass('notify_list_active');
      if($scope.select_notify_id.indexOf(',')==-1){
        $scope.select_notify_id=$scope.select_notify_id.replace(user_id,'');
      }
      else if($scope.select_notify_id.indexOf(user_id+',')==-1){
        $scope.select_notify_id=$scope.select_notify_id.replace(','+user_id,'');
      }
      else{
        $scope.select_notify_id=$scope.select_notify_id.replace(user_id+',','');
      }
      for(var i=0;i<$scope.ess_my_approvalDC_data.notify_list.length;i++){
        if($scope.ess_my_approvalDC_data.notify_list[i].user_id==user_id){
          $scope.ess_my_approvalDC_data.notify_list.splice(i,1);
        }
      }
      setTimeout(function(){
        document.getElementById('notify_list_div').style.width=($scope.ess_my_approvalDC_data.notify_list.length+1)*100+20+'px';
        $ionicScrollDelegate.$getByHandle("notify_list_scroll").resize();
      },350)


    }
    $scope.selectList = function(){
      if($scope.click_flag==1){
        var _d = [];
        $scope.select_notify_id = '';
        $scope.ess_my_approvalDC_data.notify_list = [];
        for(var i=0;i<$scope.ess_empl_data.length;i++){
          if($scope.ess_empl_data[i].ck){
            $scope.select_notify_id = $scope.select_notify_id + ($scope.ess_empl_data)[i].user_id+',';
            $scope.ess_my_approvalDC_data.notify_list.push({
              img:($scope.ess_empl_data)[i].img,
              name:($scope.ess_empl_data)[i].en,
              user_id:($scope.ess_empl_data)[i].user_id,
              flag:1
            });
          }
        }
        $scope.select_notify_id = ($scope.select_notify_id).substring(0,$scope.select_notify_id.length-1);
        document.getElementById('notify_list_div').style.width=($scope.ess_my_approvalDC_data.notify_list.length+1)*100+20+'px';
        $scope.closeModal();
      }

    }

    $scope.select_user_id='';
    $ionicModal.fromTemplateUrl('ess-my-apply-empl-modal.html', {
      scope: $scope,
      animation: 'slide-in-up'
    }).then(function(modal) {
      $scope.modal = modal;
    });
	/*
    $scope.openModal = function() {
      $scope.search_val = '';
      $scope.click_flag = 0;
      $scope.ess_empl_data = [];
      essLvApplySev.loadEssEmplData($scope.select_user_id,$scope.ess_my_approvalDC_data.employee_no,$scope.ess_my_approvalDC_data.process_instance);
      $scope.ess_empl_data = essLvApplySev.getEssEmplData();
      $scope.modal.show();
    };
    $scope.openModal2 = function() {
      $('#notify_list_div').removeClass('notify_list_active');
      $scope.search_val = '';
      $scope.click_flag = 1;
      $scope.ess_empl_data = [];
      essLvApplySev.loadEssEmplData($scope.select_notify_id,$scope.ess_my_approvalDC_data.employee_no,$scope.ess_my_approvalDC_data.process_instance);
      $scope.ess_empl_data = essLvApplySev.getEssEmplData();
      $scope.modal.show();
    };
	*/

	var routerName = '';
	if (typeof($stateParams.from_source) != 'undefined'){
		if ($stateParams.from_source == 'at_team_record'){
			routerName = 'default';
		}
		else if ($stateParams.from_source == 'my_approval'){
			routerName = 'default';
		}
		else if ($stateParams.from_source == 'home_message'){
			routerName = 'message';
		}
		else if ($stateParams.from_source == 'at_team_record'){
			routerName = 'default';
		}
	}

	$scope.openModal = function() {

		var _d = [];
		_d = $scope.ess_my_approvalDC_data.approver_list;
		var flag = 0;
		var _len = _d.length;

		var flag = 0;
		for(var i=0;i<_len;i++){
		  if(angular.isDefined(_d[i]._flag)&&_d[i]._flag==1){
			flag = 1;
			break;
		  }
		}

		var selectEmplList = '';
		if (flag == 1){
			selectEmplList = _d[_len-1].employee_no;
		}

		$emplComponentService.open({
			title : '选择审批人', //弹开窗口标题
			barTitle : window.localStorage["org_top_level"],//导航开头
			isSingleSelect:true,//是否单选
			isShowContact:true,//是否展示常用联系人
			isNeedSaveContact:true,//是否保存常用联系人
			extName : '员工', //多选时提示后缀名
			selectEmplList:selectEmplList, //打开窗口默认选中员工列表
			routerName:routerName,
			sure : function (rd) { //返回数据，数组格式
				$scope.select_user_id = rd[0].user_id;

				if(flag == 0){
				  _d.push({
					employee_no:rd[0].empl_no,
					img:rd[0].img_src,
					name:rd[0].empl_name,
					user_id:rd[0].user_id,
					action:'下一层审批人',
					flag:1,
					_flag:1,
					attachment:'',
					approval_remark:'',
					color:"#999"
				  })
				}else{
				  _d[_len-1] = {
					employee_no:rd[0].empl_no,
					img:rd[0].img_src,
					name:rd[0].empl_name,
					action:'下一层审批人',
					flag:1,
					user_id:rd[0].user_id,
					_flag:1,
					attachment:'',
					approval_remark:'',
					color:"#999"
				  }
				}

			}
		});


    }

	$scope.openModal2 = function() {
		var selectEmplList = '';
		if ($scope.ess_my_approvalDC_data.notify_list.length != 0){
			for (var i=0;i<$scope.ess_my_approvalDC_data.notify_list.length;i++){
				selectEmplList += $scope.ess_my_approvalDC_data.notify_list[i].employee_no;
				if (i < $scope.ess_my_approvalDC_data.notify_list.length - 1){
					selectEmplList += ',';
				}
			}

		}

		$emplComponentService.open({
			title : '选择知会人', //弹开窗口标题
			barTitle : window.localStorage["org_top_level"],//导航开头
			isSingleSelect:false,//是否单选
			isShowContact:true,//是否展示常用联系人
			isNeedSaveContact:true,//是否保存常用联系人
			extName : '员工', //多选时提示后缀名
			selectEmplList:selectEmplList, //打开窗口默认选中员工列表
			routerName:routerName,
			/*
			params:{ //支持可用扩展参数
				"is_permissions":"0",
				"is_process":"0",
				"process_instance":'0',
				"ext_param":"aa"
			},
			*/
			sure : function (rd) { //返回数据，数组格式
				$('#notify_list_div').removeClass('notify_list_active');
				$scope.select_notify_id = '';
				$scope.ess_my_approvalDC_data.notify_list = [];
				for(var i=0;i<rd.length;i++){

					$scope.select_notify_id = $scope.select_notify_id + rd[i].user_id;
					$scope.ess_my_approvalDC_data.notify_list.push({
					  img:rd[i].img_src,
					  name:rd[i].empl_name,
					  user_id:rd[i].user_id,
					  employee_no:rd[i].empl_no,
					  flag:1
					});
					if (i < rd.length - 1){
						$scope.select_notify_id += ',';
					}
				}

				document.getElementById('notify_list_div').style.width=($scope.ess_my_approvalDC_data.notify_list.length+1)*100+20+'px';

				$ionicScrollDelegate.$getByHandle("notify_list_scroll").resize();
			}
		});

    }

    $scope.closeModal = function() {
      $scope.modal.hide();
      $scope.ess_empl_data = [];
    };


    $scope.essItemCk = function(user_id,img,en,_flag){
      if(_flag == true){
        $scope.ess_empl_data.num_checked =  $scope.ess_empl_data.num_checked + 1;
      }else{
        $scope.ess_empl_data.num_checked =  $scope.ess_empl_data.num_checked - 1;
      }
      var _d = [];
      if($scope.click_flag == 0){
        $scope.select_user_id = user_id;
        _d = $scope.ess_my_approvalDC_data.approver_list;
        var flag = 0;
        var _len = _d.length;
        for(var i=0;i<_len;i++){
          if(angular.isDefined(_d[i]._flag)&&_d[i]._flag==1){
            flag = 1;
            break;
          }
        }
        if(flag == 0){
          _d.push({
            img:img,
            name:en,
            user_id:user_id,
            color:"#999",
            action:'下一层审批人',
            flag:1,
            _flag:1,
            attachment:'',
            approval_remark:''
          })
        }else{
          _d[_len-1] = {
            img:img,
            name:en,
            color:"#999",
            action:'下一层审批人',
            flag:1,
            user_id:user_id,
            _flag:1,
            attachment:'',
            approval_remark:''
          }
        }
        $scope.approver_list=_d;
      }else{
        var _d = [];
        if($scope.click_flag == 0){
          $scope.select_user_id = user_id;
          _d = $scope.ess_my_approvalDC_data.approver_list;
        }else{
          return;
        }
        var flag = 0;
        var _len = _d.length;
        for(var i=0;i<_len;i++){
          if(angular.isDefined(_d[i].flag)&&_d[i].flag==1){
            flag = 1;
            break;
          }
        }
        if(flag == 0){
          _d.push({
            img:img,
            name:en,
            user_id:user_id,
            flag:1
          })
        }else{
          _d[_len-1] = {
            img:img,
            name:en,
            user_id:user_id,
            flag:1
          }
        }

      }
      $scope.search_control.search_val = '';
      $scope.closeModal();
    }




    $scope.submitAction = function(action){
      essMyApprovalDFCSev.submitAction(action);
    }

    $scope.approval_date=[{
      key:'0',
      value:'批准'
    },{
      key:'1',
      value:'驳回'
    }]
    $scope.remark_flag=true;
    $scope.approval_index=0;
    $scope.approval_or_noapproval=function(){
      sideSelect.show({
        type : 'ios',
        data :$scope.approval_date,
        selectIndex :  $scope.approval_index,
        selectedFunc : function (index) {
          if(typeof(index)!='undefined'){
            document.getElementById("approval_answer").innerHTML= $scope.approval_date[index].value;
            index== '0' ? $scope.remark_flag=true : $scope.remark_flag=false;
            $scope.approval_index=index;
          }

        }
      });
    }

    $scope.save=function(){
      if($scope.remark_flag==false&&document.getElementById('remark_textarea').value==''){
        $ionicPopup.alert({
          title: '提醒',
          template: '<div style="text-align: center;">请填写备注</div>',
          okText: '确定'
        })
      }
      else {
        if ($scope.remark_flag) {
          essMyApprovalDCOSev.applyApprove($scope.select_user_id,$stateParams.my_app_result,$scope.select_notify_id,$stateParams.from_source);
        }
        else {
          essMyApprovalDCOSev.applyReject($scope.select_user_id,$stateParams.my_app_result,$scope.select_notify_id,$stateParams.from_source);
        }
      }
    }
  })


  .controller('teamAtExceptionCtrl',function($scope,teamAtExceptionSev,essLvApplySev,$stateParams,$ionicModal,$ionicActionSheet,$location,$timeout,$ionicPopup,sideSelect,timeSelect){

    $scope.is_show_leave = true;
    $scope.is_show_attendance = true;


//            temp_date.setFullYear(formatted_date.split('-')[0],(parseInt(formatted_date.split('-')[1],10)-1),formatted_date.split('-')[2]);

    var current_date = new Date();
	current_date.setFullYear($stateParams.start_date.split('-')[0],(parseInt($stateParams.start_date.split('-')[1],10)-1),$stateParams.start_date.split('-')[2]);
    var temp_date;
    var target_date;
    var day_of_week = ['日','一','二','三','四','五','六'];

    //current_date.setMinutes(current_date.getMinutes() - current_date.getTimezoneOffset());
    temp_date = new Date(current_date);
    target_date = new Date(temp_date.getTime());

    //alert((temp_date.getFullYear() + '-' + (temp_date.getMonth() + 1 < 10 ? '0' + (temp_date.getMonth() + 1): (temp_date.getMonth() + 1)) + '-' + (temp_date.getDate() < 10 ? '0' + (temp_date.getDate()): (temp_date.getDate()))));
    //alert(temp_date.getFullYear());
    //alert(temp_date.getMonth() + 1);
    //alert(temp_date.getDate());
    //alert(day_of_week[temp_date.getDay()]);

    //console.log(temp_date.toJSON().slice(0,4)); // 年
    //parseInt(temp_date.toJSON().slice(0,4),10)
    //console.log(temp_date.toJSON().slice(5,7)); // 月
    //parseInt(temp_date.toJSON().slice(5,5),10)
    //console.log(temp_date.toJSON().slice(8,10)); // 日
    //parseInt(temp_date.toJSON().slice(8,10),10)

	teamAtExceptionSev.clearData();
    teamAtExceptionSev.loadData((target_date.getFullYear() + '-' + (target_date.getMonth() + 1 < 10 ? '0' + (target_date.getMonth() + 1): (target_date.getMonth() + 1)) + '-' + (target_date.getDate() < 10 ? '0' + (target_date.getDate()): (target_date.getDate()))),$scope.is_show_leave,$scope.is_show_attendance,$("#team_at_exception_filter_employee_list").val());
    $scope.team_at_exception_data = teamAtExceptionSev.getData();



    $scope.set_calendar = function(){
      document.getElementById('team_at_exception_calendar_year').innerHTML = temp_date.toJSON().slice(0,4) + '年';
      document.getElementById('team_at_exception_calendar_month').innerHTML = temp_date.toJSON().slice(5,7);

      temp_date.setDate(temp_date.getDate() - 7);
      if ((target_date.getFullYear() + '-' + (target_date.getMonth() + 1 < 10 ? '0' + (target_date.getMonth() + 1): (target_date.getMonth() + 1)) + '-' + (target_date.getDate() < 10 ? '0' + (target_date.getDate()): (target_date.getDate()))) == (temp_date.getFullYear() + '-' + (temp_date.getMonth() + 1 < 10 ? '0' + (temp_date.getMonth() + 1): (temp_date.getMonth() + 1)) + '-' + (temp_date.getDate() < 10 ? '0' + (temp_date.getDate()): (temp_date.getDate())))){
        document.getElementById('calendar_week_page1_first_item').style.backgroundColor = '#53afff';
        document.getElementById('calendar_week_page1_first_item').style.borderRadius = '4px';
      }
      else{
        document.getElementById('calendar_week_page1_first_item').style.backgroundColor = '';
        document.getElementById('calendar_week_page1_first_item').style.borderRadius = '';
      }
      for (var i=0;i<7;i++){
        document.getElementsByClassName('calendar_week_page1_day_of_week')[i].innerHTML = day_of_week[temp_date.getDay()];
        document.getElementsByClassName('calendar_week_page1_day')[i].innerHTML = temp_date.getDate();
        temp_date.setDate(temp_date.getDate() + 1);
      }
      if ((target_date.getFullYear() + '-' + (target_date.getMonth() + 1 < 10 ? '0' + (target_date.getMonth() + 1): (target_date.getMonth() + 1)) + '-' + (target_date.getDate() < 10 ? '0' + (target_date.getDate()): (target_date.getDate()))) == (temp_date.getFullYear() + '-' + (temp_date.getMonth() + 1 < 10 ? '0' + (temp_date.getMonth() + 1): (temp_date.getMonth() + 1)) + '-' + (temp_date.getDate() < 10 ? '0' + (temp_date.getDate()): (temp_date.getDate())))){
        document.getElementById('calendar_week_page2_first_item').style.backgroundColor = '#53afff';
        document.getElementById('calendar_week_page2_first_item').style.borderRadius = '4px';
      }
      else{
        document.getElementById('calendar_week_page2_first_item').style.backgroundColor = '';
        document.getElementById('calendar_week_page2_first_item').style.borderRadius = '';
      }
      for (var i=0;i<7;i++){
        document.getElementsByClassName('calendar_week_page2_day_of_week')[i].innerHTML = day_of_week[temp_date.getDay()];
        document.getElementsByClassName('calendar_week_page2_day')[i].innerHTML = temp_date.getDate();
        temp_date.setDate(temp_date.getDate() + 1);
      }
      if ((target_date.getFullYear() + '-' + (target_date.getMonth() + 1 < 10 ? '0' + (target_date.getMonth() + 1): (target_date.getMonth() + 1)) + '-' + (target_date.getDate() < 10 ? '0' + (target_date.getDate()): (target_date.getDate()))) == (temp_date.getFullYear() + '-' + (temp_date.getMonth() + 1 < 10 ? '0' + (temp_date.getMonth() + 1): (temp_date.getMonth() + 1)) + '-' + (temp_date.getDate() < 10 ? '0' + (temp_date.getDate()): (temp_date.getDate())))){
        document.getElementById('calendar_week_page3_first_item').style.backgroundColor = '#53afff';
        document.getElementById('calendar_week_page3_first_item').style.borderRadius = '4px';
      }
      else{
        document.getElementById('calendar_week_page3_first_item').style.backgroundColor = '';
        document.getElementById('calendar_week_page3_first_item').style.borderRadius = '';
      }
      for (var i=0;i<7;i++){
        document.getElementsByClassName('calendar_week_page3_day_of_week')[i].innerHTML = day_of_week[temp_date.getDay()];
        document.getElementsByClassName('calendar_week_page3_day')[i].innerHTML = temp_date.getDate();
        temp_date.setDate(temp_date.getDate() + 1);
      }
      temp_date.setDate(temp_date.getDate() - 14);
    }

    $scope.set_calendar();


    var paging_in_progress = false;

    $scope.calendar_week_next_week = function(){
      if (paging_in_progress){
        return;
      }
      paging_in_progress = true;
      var translateX=-33.3333;
      document.getElementById('calendar_week_group_translate_div').style.transition='all 0.5s linear';
      document.getElementById('calendar_week_group_translate_div').style.webkitTransition='all 0.5s linear';
      translateX=translateX-33.3333;
      document.getElementById('calendar_week_group_translate_div').style.webkitTransform='translateX('+translateX+'%)';
      document.getElementById('calendar_week_group_translate_div').style.webkitTransform='translateX('+translateX+'%)';
      setTimeout(function(){
        translateX=translateX+33.3333;
        document.getElementById('calendar_week_group_translate_div').style.transition='';
        document.getElementById('calendar_week_group_translate_div').style.webkitTransition='';
        document.getElementById('calendar_week_group_translate_div').style.webkitTransform='translateX('+translateX+'%)';
        document.getElementById('calendar_week_group_translate_div').style.webkitTransform='translateX('+translateX+'%)';
        temp_date.setDate(temp_date.getDate() + 7);
        $scope.set_calendar();
        paging_in_progress = false;
      }, 500);
    }

    $scope.calendar_week_previous_week = function(){
      if (paging_in_progress){
        return;
      }
      paging_in_progress = true;
      var translateX=-33.3333;
      document.getElementById('calendar_week_group_translate_div').style.transition='all 0.5s linear';
      document.getElementById('calendar_week_group_translate_div').style.webkitTransition='all 0.5s linear';
      translateX=translateX+33.3333;
      document.getElementById('calendar_week_group_translate_div').style.webkitTransform='translateX('+translateX+'%)';
      document.getElementById('calendar_week_group_translate_div').style.webkitTransform='translateX('+translateX+'%)';
      setTimeout(function(){
        translateX=translateX-33.3333;
        document.getElementById('calendar_week_group_translate_div').style.transition='';
        document.getElementById('calendar_week_group_translate_div').style.webkitTransition='';
        document.getElementById('calendar_week_group_translate_div').style.webkitTransform='translateX('+translateX+'%)';
        document.getElementById('calendar_week_group_translate_div').style.webkitTransform='translateX('+translateX+'%)';
        temp_date.setDate(temp_date.getDate() - 7);
        $scope.set_calendar();
        paging_in_progress = false;
      }, 500);
    }

    $scope.weekday_select = function(n){
      if (paging_in_progress){
        return;
      }

      temp_date.setDate(temp_date.getDate() + n);
      target_date = new Date(temp_date.getTime());
      $scope.set_calendar();

      teamAtExceptionSev.loadData((target_date.getFullYear() + '-' + (target_date.getMonth() + 1 < 10 ? '0' + (target_date.getMonth() + 1): (target_date.getMonth() + 1)) + '-' + (target_date.getDate() < 10 ? '0' + (target_date.getDate()): (target_date.getDate()))),$scope.is_show_leave,$scope.is_show_attendance,$("#team_at_exception_filter_employee_list").val());
    }



    $scope.showDate = function(){
      var today_date = new Date();
      var today_date_start_date_str = '';
      var today_date_end_date_str = '';
      today_date_start_date_str = (today_date.getFullYear() - 10) + '年01月';
      today_date_end_date_str = (today_date.getFullYear() + 10) + '年12月';
      today_date_str = (temp_date.getFullYear()) + '年' + (temp_date.getMonth() + 1) + '月';

      timeSelect.show({
        type :  'yearsMonth',
        startDate :today_date_start_date_str,
        endDate : today_date_end_date_str,
        defaultDate: today_date_str,
        returnDateType : 'ymd',
        //stepping :10,
        selectedFunc : function (date) {
          if (typeof(date) != 'undefined'){
            var formatted_date = date.replace('年','-');
            formatted_date = formatted_date.replace('月','-');
            formatted_date = formatted_date.replace('日','');
            formatted_date += '01';
            temp_date.setFullYear(formatted_date.split('-')[0],(parseInt(formatted_date.split('-')[1],10)-1),formatted_date.split('-')[2]);
            target_date.setFullYear(formatted_date.split('-')[0],(parseInt(formatted_date.split('-')[1],10)-1),formatted_date.split('-')[2]);
            $scope.set_calendar();
	      teamAtExceptionSev.loadData((target_date.getFullYear() + '-' + (target_date.getMonth() + 1 < 10 ? '0' + (target_date.getMonth() + 1): (target_date.getMonth() + 1)) + '-' + (target_date.getDate() < 10 ? '0' + (target_date.getDate()): (target_date.getDate()))),$scope.is_show_leave,$scope.is_show_attendance,$("#team_at_exception_filter_employee_list").val());
          }
        }
      })
    }

    $scope.toggle_leave = function (){
      $scope.is_show_leave = !$scope.is_show_leave;
      teamAtExceptionSev.loadData((target_date.getFullYear() + '-' + (target_date.getMonth() + 1 < 10 ? '0' + (target_date.getMonth() + 1): (target_date.getMonth() + 1)) + '-' + (target_date.getDate() < 10 ? '0' + (target_date.getDate()): (target_date.getDate()))),$scope.is_show_leave,$scope.is_show_attendance,$("#team_at_exception_filter_employee_list").val());
    }

    $scope.toggle_attendance = function (){
      $scope.is_show_attendance = !$scope.is_show_attendance;
      teamAtExceptionSev.loadData((target_date.getFullYear() + '-' + (target_date.getMonth() + 1 < 10 ? '0' + (target_date.getMonth() + 1): (target_date.getMonth() + 1)) + '-' + (target_date.getDate() < 10 ? '0' + (target_date.getDate()): (target_date.getDate()))),$scope.is_show_leave,$scope.is_show_attendance,$("#team_at_exception_filter_employee_list").val());
    }

    $scope.team_at_exception_clear_filter = function (){
      $("#team_at_exception_filter_employee_list").val('');
      document.getElementById('team_at_exception_clear_filter_checkmark').style.display = "none";
      document.getElementById('team_at_exception_clear_filter').style.display = "none";
      document.getElementById('team_at_exception_clear_filter_text').style.color = "#333";
      teamAtExceptionSev.loadData((target_date.getFullYear() + '-' + (target_date.getMonth() + 1 < 10 ? '0' + (target_date.getMonth() + 1): (target_date.getMonth() + 1)) + '-' + (target_date.getDate() < 10 ? '0' + (target_date.getDate()): (target_date.getDate()))),$scope.is_show_leave,$scope.is_show_attendance,$("#team_at_exception_filter_employee_list").val());
    }


    $scope.team_at_exception_employee_select = function(){
      var employee_list = $("#team_at_exception_filter_employee_list").val();
      if($stateParams.is_normal_path=='true'){
        $location.path('home_page/home_menulist/team_at_exception_employee_select/' + $scope.is_show_leave + '/' + $scope.is_show_attendance+'/' + (target_date.getFullYear() + '-' + (target_date.getMonth() + 1 < 10 ? '0' + (target_date.getMonth() + 1): (target_date.getMonth() + 1)) + '-' + (target_date.getDate() < 10 ? '0' + (target_date.getDate()): (target_date.getDate()))));
      }
     else{
        $location.path('home_page/home_menulist/team_at_exception_employee_select_msg/' + $scope.is_show_leave + '/' + $scope.is_show_attendance+'/' + (target_date.getFullYear() + '-' + (target_date.getMonth() + 1 < 10 ? '0' + (target_date.getMonth() + 1): (target_date.getMonth() + 1)) + '-' + (target_date.getDate() < 10 ? '0' + (target_date.getDate()): (target_date.getDate()))));
      }
    }

  })

  .controller('teamAtExceptionEmployeeSelectCtrl',function($scope,teamAtExceptionSev,teamAtExceptionEmployeeSelectSev,$stateParams,$location,$ionicPopup,$ionicHistory){
    //test_array.unshift(test_array.splice(2,1)[0]);
    var employee_list_control_value = $("#team_at_exception_filter_employee_list").val();
    var employee_list_array;
    if (employee_list_control_value == ''){
      employee_list_array = [];
    }
    else {
      employee_list_array = employee_list_control_value.split(',');
    }
	teamAtExceptionEmployeeSelectSev.clearData();
    teamAtExceptionEmployeeSelectSev.loadData(employee_list_control_value);
    $scope.teamAtExceptionEmployeeSelectData = teamAtExceptionEmployeeSelectSev.getData();
    $scope.img_no_notice = local_resource+'img/icon/no_notice01.png';
    $scope.img_notice = local_resource+'img/icon/notice01.png';
    $scope.ckItem = function(_flag,employee_no){
      if(_flag == true){
        $scope.teamAtExceptionEmployeeSelectData.total_checked++;
        employee_list_array.push(employee_no);
        //console.log(employee_list_array);
      }else{
        $scope.teamAtExceptionEmployeeSelectData.total_checked--;
        var index = employee_list_array.indexOf(employee_no);
        employee_list_array.splice(index, 1);
        //console.log(employee_list_array);
      }
    }

    $scope.employee_select_save = function(){
      /*
       var _empl_list='';
       var _staff_no_list='';
       for(var i=0;i<$scope.teamAtExceptionEmployeeSelectData.data.length;i++){
       if($scope.teamAtExceptionEmployeeSelectData.data[i].ck==true){
       _empl_list = _empl_list + $scope.teamAtExceptionEmployeeSelectData.data[i].en+',';
       _staff_no_list = _staff_no_list + $scope.teamAtExceptionEmployeeSelectData.data[i].emp+',';
       }
       }
       //$("#shift_group_edit_empl_list").val(_empl_list.substring(0,_empl_list.length-1));
       //$("#shift_group_edit_empl_list_hidden").val(_staff_no_list.substring(0,_staff_no_list.length-1));
       $("#team_at_exception_filter_employee_list").val(_staff_no_list.substring(0,_staff_no_list.length-1));
       */
      $("#team_at_exception_filter_employee_list").val(employee_list_array.toString());
      teamAtExceptionSev.loadData($stateParams.target_date,$stateParams.is_show_leave,$stateParams.is_show_attendance,$("#team_at_exception_filter_employee_list").val());
      if ($("#team_at_exception_filter_employee_list").val() == ''){
        document.getElementById('team_at_exception_clear_filter_checkmark').style.display = "none";
        document.getElementById('team_at_exception_clear_filter').style.display = "none";
        document.getElementById('team_at_exception_clear_filter_text').style.color = "#333";

      }
      else {
        document.getElementById('team_at_exception_clear_filter_checkmark').style.display = "inline-block";
        document.getElementById('team_at_exception_clear_filter').style.display = "block";
        document.getElementById('team_at_exception_clear_filter_text').style.color = "#07b237";
      }

      $ionicHistory.goBack();
    }

  })

  .controller('LvBalanceTeamRecordCtrl',function($deptComponentSer,$scope,LvBalanceTeamRecordSev,$stateParams,$location,$ionicPopup,$rootScope,$ionicHistory,$ionicScrollDelegate,$timeout){

		$scope.not_data=local_resource + "img/not_data.png";
		$scope.cry=local_resource + "img/cry.png";
		$scope.search_img = local_resource+'img/search_img.png';


  	if(window.localStorage['_role_name']=='ess'){
		$scope.is_show_picklist = false;
	} else {
		$scope.is_show_picklist = true;
	}

	$scope.search=function(){
		document.getElementById('statistics_content_div').style.display='block';
		$ionicScrollDelegate.scrollTop();
		LvBalanceTeamRecordSev.loadData($scope.dept_id,$scope.search_control.search_val);
	}
	$scope.dept_id = '0';
	//$scope.search_control = LvBalanceTeamRecordSev.getSearchValue();

    $scope.search_control=LvBalanceTeamRecordSev.getSearchValue();
	$scope.searchState=LvBalanceTeamRecordSev.getSearchState();
	$scope.searchNodata= LvBalanceTeamRecordSev.getSearchNodata();



      $scope.$on("$ionicView.enter", function () {
        //解决 进入明细页面back回来的时候 会再次loaddata
        if (typeof($scope.data_loaded) != 'undefined') {
			if($scope.search_control.search_val!=''){
				$timeout(function(){
				  document.getElementById("LvBalanceTeamRecordSearchDiv").style.display="block";
				  document.getElementById("LvBalanceTeamRecordSearchDiv").style.opacity="1";
				  $("#LvBalanceTeamRecordBack").css({"display":"none"});
				  $("#LvBalanceTeamRecordSearchInput").val($scope.search_control.search_val);
				})



			}


        }
        else {
          $scope.data_loaded = true;
        }

		if (ionic.Platform.isIOS()) {
		  $scope.content_top='104';
		  LvBalanceTeamRecordSev.clearData();
		  LvBalanceTeamRecordSev.loadData($scope.dept_id,$scope.search_control.search_val);
		  $scope.LvBalanceTeamRecordData = LvBalanceTeamRecordSev.getData();
		  $scope.end_of_list = LvBalanceTeamRecordSev.getEndOfList();

		} else {
		  $scope.content_top='84';
		  LvBalanceTeamRecordSev.clearData();
		  LvBalanceTeamRecordSev.loadData($scope.dept_id,$scope.search_control.search_val);
		  $scope.LvBalanceTeamRecordData = LvBalanceTeamRecordSev.getData();
		  $scope.end_of_list = LvBalanceTeamRecordSev.getEndOfList();
		}


		if($scope.isSelectDeptBack){

			if ($scope.selectDeptRd.length == 0){
					document.getElementById('leave_balance_team_record_dept_picklist').innerHTML = '请选择部门';
					$scope.dept_id = '0';
					LvBalanceTeamRecordSev.loadData($scope.dept_id,$scope.search_control.search_val);
				}
				else if ($scope.selectDeptRd.length == 1){
					document.getElementById('leave_balance_team_record_dept_picklist').innerHTML = $scope.selectDeptRd[0].name;
					$scope.dept_id = $scope.selectDeptRd[0].id;
					LvBalanceTeamRecordSev.loadData($scope.dept_id,$scope.search_control.search_val);
				}
				else {
					document.getElementById('leave_balance_team_record_dept_picklist').innerHTML = $scope.selectDeptRd.length + '个部门(含子部门)';
					$scope.dept_id = '';
					for (var i=0;i<$scope.selectDeptRd.length;i++){
						$scope.dept_id = $scope.dept_id + $scope.selectDeptRd[i].id;
						if (i < $scope.selectDeptRd.length - 1){
							$scope.dept_id = $scope.dept_id + ',';
						}
					}
					LvBalanceTeamRecordSev.loadData($scope.dept_id,$scope.search_control.search_val);
				}

		}

      });



	$scope.end_of_list= LvBalanceTeamRecordSev.getEndOfList();
	$scope.loadMoreEmployeeData=function(){

		LvBalanceTeamRecordSev.loadMoreData($scope,$scope.dept_id,$scope.search_control.search_val);
	}

    //$scope.search_control.search_val = "";
    $scope.show_search = false;
    $scope.toggle_search = function() {
      $("#leave_balance_team_record .leave_balance_team_record_content").css({'top':'152px'});
      $(" .platform-win32.platform-cordova #leave_balance_team_record .leave_balance_team_record_content").css({'top':'132px'});
      $(" .platform-android.platform-cordova #leave_balance_team_record .leave_balance_team_record_content").css({'top':'132px'});
      $scope.show_search = true;
      $ionicScrollDelegate.scrollTop();
    }
    $scope.cancel_search = function() {
      $("#leave_balance_team_record .leave_balance_team_record_content").css({'top':'108px'});
      $(" .platform-win32.platform-cordova #leave_balance_team_record .leave_balance_team_record_content").css({'top':'88px'});
      $(" .platform-android.platform-cordova #leave_balance_team_record .leave_balance_team_record_content").css({'top':'88px'});
      $scope.show_search = false;
      $scope.search_control.search_val = '';
    }
    //LvBalanceTeamRecordSev.clearData();
    //LvBalanceTeamRecordSev.loadData();
    //$scope.LvBalanceTeamRecordData = LvBalanceTeamRecordSev.getData();

    $scope.view_detail = function(employee_no,employee_name) {
        $location.path("home_page/home_menulist/team_record_my_leave_balance/"+employee_no+'/' + employee_name);
    }


	$scope.isSelectDeptBack = false;
	$scope.selectDeptRd = [];



	$scope.leave_balance_team_record_dept_picklist = function(){
		$deptComponentSer.open({
			title : '选择部门', //标题
			//barTitle : '施特伟科技有限公司',//导航标题
			barTitle : '组织架构',
			isSingleSelect:false, //是否单选
			isInherit:true, //是否选父带子
			selectNodeList:$scope.dept_id, //默认选中部门节点
			params:{ //加载扩展参数
				"is_permissions":"1",
				"is_process":"0"
			},
			/*
			params:{ //加载扩展参数
			"param1":"aa",
			"param2":"bb"
			},
			*/
			extName : '部门(含子部门)', //多选显示扩展后缀名
			sure : function (rd) { //确认返回接口，数组
			$rootScope.showLoading();
			$scope.isSelectDeptBack = true;
			$scope.selectDeptRd = [];
			$scope.selectDeptRd = rd;
				/*
				if (rd.length == 0){
					document.getElementById('leave_balance_team_record_dept_picklist').innerHTML = '请选择部门';
					$scope.dept_id = '0';
				}
				else if (rd.length == 1){
					document.getElementById('leave_balance_team_record_dept_picklist').innerHTML = rd[0].name;
					$scope.dept_id = rd[0].id;
				}
				else {
					document.getElementById('leave_balance_team_record_dept_picklist').innerHTML = rd.length + '个部门(含子部门)';
					$scope.dept_id = '';
					for (var i=0;i<rd.length;i++){
						$scope.dept_id = $scope.dept_id + rd[i].id;
						if (i < rd.length - 1){
							$scope.dept_id = $scope.dept_id + ',';
						}
					}
				}
				LvBalanceTeamRecordSev.loadData($scope.dept_id,$scope.search_control.search_val);
			*/
			}
		});
	}

  })
  .controller('atTeamRecordSearchCtrl',function($scope,atTeamRecordSev,$stateParams,$location,$ionicPopup,$ionicHistory,$ionicScrollDelegate,timeSelect){

	$scope.search_control = atTeamRecordSev.getSearchData();


    $scope.all_tap_flag=$scope.search_control.is_show_all;
    $scope.is_show_leakage_card=$scope.search_control.is_show_leakage_card;
    $scope.is_show_late=$scope.search_control.is_show_late;
    $scope.is_show_leave_early=$scope.search_control.is_show_leave_early;
    $scope.is_show_leave=$scope.search_control.is_show_leave;
    $scope.is_show_outdoor=$scope.search_control.is_show_outdoor;
    $scope.is_show_overtime=$scope.search_control.is_show_overtime;

	$('#at_team_record_search_sch_ipt').val($scope.search_control.search_val);

	if ($scope.all_tap_flag){
		$("#all_tap").css({'backgroundColor':'#53afff','color':'white'})
	}

	  if($('#at_team_record_search_sch_ipt').val()==''){
		document.getElementById('at_team_record_search_wrap').style.display='block';
	  }
	  else{
		document.getElementById('at_team_record_search_wrap').style.display='none';
	  }
	  if (!$scope.is_show_leakage_card && !$scope.is_show_late && !$scope.is_show_leave_early && !$scope.is_show_leave && !$scope.is_show_outdoor && !$scope.is_show_overtime && !$scope.all_tap_flag){
        document.getElementById('at_team_record_blur_search_wrap').style.display='block';
      }
      else{
        document.getElementById('at_team_record_blur_search_wrap').style.display='none';
      }

    $scope.all_tap=function(all_tap_flag){
      $scope.all_tap_flag=!$scope.all_tap_flag;
      if($scope.all_tap_flag){
        $("#all_tap").css({'backgroundColor':'#53afff','color':'white'})
      }
      else{
        $("#all_tap").css({'backgroundColor':'white','color':'#999'})
      }
	  if (!$scope.is_show_leakage_card && !$scope.is_show_late && !$scope.is_show_leave_early && !$scope.is_show_leave && !$scope.is_show_outdoor && !$scope.is_show_overtime && !$scope.all_tap_flag){
        document.getElementById('at_team_record_blur_search_wrap').style.display='block';
      }
      else{
        document.getElementById('at_team_record_blur_search_wrap').style.display='none';
      }
    }

    $scope.toggle_leakage_card = function (){
      $scope.is_show_leakage_card = !$scope.is_show_leakage_card;
	  if (!$scope.is_show_leakage_card && !$scope.is_show_late && !$scope.is_show_leave_early && !$scope.is_show_leave && !$scope.is_show_outdoor && !$scope.is_show_overtime && !$scope.all_tap_flag){
        document.getElementById('at_team_record_blur_search_wrap').style.display='block';
      }
      else{
        document.getElementById('at_team_record_blur_search_wrap').style.display='none';
      }
    }
    $scope.toggle_late = function (){
      $scope.is_show_late = !$scope.is_show_late;
	  if (!$scope.is_show_leakage_card && !$scope.is_show_late && !$scope.is_show_leave_early && !$scope.is_show_leave && !$scope.is_show_outdoor && !$scope.is_show_overtime && !$scope.all_tap_flag){
        document.getElementById('at_team_record_blur_search_wrap').style.display='block';
      }
      else{
        document.getElementById('at_team_record_blur_search_wrap').style.display='none';
      }
    }
    $scope.toggle_leave_early = function (){
      $scope.is_show_leave_early = !$scope.is_show_leave_early;
	  if (!$scope.is_show_leakage_card && !$scope.is_show_late && !$scope.is_show_leave_early && !$scope.is_show_leave && !$scope.is_show_outdoor && !$scope.is_show_overtime && !$scope.all_tap_flag){
        document.getElementById('at_team_record_blur_search_wrap').style.display='block';
      }
      else{
        document.getElementById('at_team_record_blur_search_wrap').style.display='none';
      }
    }
    $scope.toggle_leave = function (){
      $scope.is_show_leave = !$scope.is_show_leave;
	  if (!$scope.is_show_leakage_card && !$scope.is_show_late && !$scope.is_show_leave_early && !$scope.is_show_leave && !$scope.is_show_outdoor && !$scope.is_show_overtime && !$scope.all_tap_flag){
        document.getElementById('at_team_record_blur_search_wrap').style.display='block';
      }
      else{
        document.getElementById('at_team_record_blur_search_wrap').style.display='none';
      }
    }
    $scope.toggle_outdoor = function (){
      $scope.is_show_outdoor = !$scope.is_show_outdoor;
	  if (!$scope.is_show_leakage_card && !$scope.is_show_late && !$scope.is_show_leave_early && !$scope.is_show_leave && !$scope.is_show_outdoor && !$scope.is_show_overtime && !$scope.all_tap_flag){
        document.getElementById('at_team_record_blur_search_wrap').style.display='block';
      }
      else{
        document.getElementById('at_team_record_blur_search_wrap').style.display='none';
      }
    }
    $scope.toggle_overtime = function (){
      $scope.is_show_overtime = !$scope.is_show_overtime;
	  if (!$scope.is_show_leakage_card && !$scope.is_show_late && !$scope.is_show_leave_early && !$scope.is_show_leave && !$scope.is_show_outdoor && !$scope.is_show_overtime && !$scope.all_tap_flag){
        document.getElementById('at_team_record_blur_search_wrap').style.display='block';
      }
      else{
        document.getElementById('at_team_record_blur_search_wrap').style.display='none';
      }
    }


    document.getElementById('at_team_record_search_sch_ipt').onkeyup=function(){
      if($('#at_team_record_search_sch_ipt').val()==''){
        document.getElementById('at_team_record_search_wrap').style.display='block';
      }
      else{
        document.getElementById('at_team_record_search_wrap').style.display='none';
      }
    }

    $scope.at_team_record_sub_search=function(){
      var at_status_str = '';
      if($("#at_team_record_search_sch_ipt").val()==''){
        if($scope.is_show_leakage_card){
          at_status_str=at_status_str+'at_status_1';
        }
        if($scope.is_show_late){
          at_status_str=at_status_str+'at_status_5';
        }
        if($scope.is_show_leave_early){
          at_status_str=at_status_str+'at_status_6';
        }
        if($scope.is_show_leave){
          at_status_str=at_status_str+'at_status_3';
        }
        if($scope.is_show_outdoor){
          at_status_str=at_status_str+'at_status_4';
        }
        if($scope.is_show_overtime){
          at_status_str=at_status_str+'at_status_2';
        }
		if ($scope.all_tap_flag){
			at_status_str = '';
			atTeamRecordSev.setAtStatusFlag(false,false,false,false,false,false,$scope.all_tap_flag);
			atTeamRecordSev.setAtStatus(at_status_str);
		}
		else {
			atTeamRecordSev.setAtStatusFlag($scope.is_show_leakage_card,$scope.is_show_overtime,$scope.is_show_leave,$scope.is_show_outdoor,$scope.is_show_late,$scope.is_show_leave_early,$scope.all_tap_flag);
			atTeamRecordSev.setAtStatus(at_status_str);
		}

      }
      else{
        var search_val=$("#at_team_record_search_sch_ipt").val();
        atTeamRecordSev.setSearchVal(search_val);
      }


      if ($("#at_team_record_search_sch_ipt").val()=='' && at_status_str == '' && !$scope.all_tap_flag){
        document.getElementById('at_team_record_clear_filter_checkmark').style.display = "none";
        document.getElementById('at_team_record_clear_filter').style.display = "none";
        document.getElementById('at_team_record_clear_filter_text').style.color = "#333";
		atTeamRecordSev.setAtStatusFlag(false,false,false,false,false,false,$scope.all_tap_flag);
		atTeamRecordSev.setAtStatus('');
		atTeamRecordSev.setSearchVal('');

      }
      else {
        document.getElementById('at_team_record_clear_filter_checkmark').style.display = "inline-block";
        document.getElementById('at_team_record_clear_filter').style.display = "block";
        document.getElementById('at_team_record_clear_filter_text').style.color = "#07b237";
      }

      $ionicHistory.goBack();
    }


  })






  .controller('addTimeMyapprovalCtrl',function($scope,essMyApprovalDOTCSev,$ionicModal,$ionicActionSheet,$location,timeSelect,$ionicScrollDelegate,$ionicPopup){
    $scope.dates_line2x = local_resource + 'img/model/dates-line2x.png';
    $scope.dates_line3x = local_resource + 'img/model/dates-line2x.png';
    $scope.add_approver = local_resource + 'img/model/add_approver.png';
    $scope.add_approver_ = local_resource + 'img/model/add_approver_.png';
    $scope.dates_line4x = local_resource + 'img/model/dates-line2x.png';
    $scope.img_upload_file_part1 = local_resource+'img/icon/add.png';
    $scope.img_upload_file_part2 = local_resource+'img/icon/new_2.png';
    $scope.contract_management_directory1 = local_resource + 'img/icon/contract_management_directory1.png';
    $scope.delete_icon= local_resource+'img/icon/delete_icon.png';
    $scope.add_icon=local_resource+'img/icon/add_icon.png';

    $scope.start_ot_icon=local_resource+'img/icon/start_ot_icon.png';
    $scope.end_ot_icon=local_resource+'img/icon/end_ot_icon.png';
    $scope.start_rest_icon=local_resource+'img/icon/start_rest_icon.png';
    $scope.end_rest_icon=local_resource+'img/icon/end_rest_icon.png';
    $scope.ot_hours_icon=local_resource+'img/icon/ot_hours_icon.png';


    //essOtApplySev.loadData();
    $scope.ot_app_data = essMyApprovalDOTCSev.getData();

    //初始化add_time页面用到的first_in, last_out参数
    $scope.ot_app_data.add_time_first_in = $scope.ot_app_data.first_in;
    if ($scope.ot_app_data.fifth_in != ''){
      $scope.ot_app_data.add_time_last_out = $scope.ot_app_data.fifth_out;
      $scope.ot_app_data.add_time_last_out_need_clock = $scope.ot_app_data.fifth_out_need_clock;
    }
    else if ($scope.ot_app_data.forth_in != ''){
      $scope.ot_app_data.add_time_last_out = $scope.ot_app_data.forth_out;
      $scope.ot_app_data.add_time_last_out_need_clock = $scope.ot_app_data.forth_out_need_clock;
    }
    else if ($scope.ot_app_data.third_in != ''){
      $scope.ot_app_data.add_time_last_out = $scope.ot_app_data.third_out;
      $scope.ot_app_data.add_time_last_out_need_clock = $scope.ot_app_data.third_out_need_clock;
    }
    else if ($scope.ot_app_data.second_in != ''){
      $scope.ot_app_data.add_time_last_out = $scope.ot_app_data.second_out;
      $scope.ot_app_data.add_time_last_out_need_clock = $scope.ot_app_data.second_out_need_clock;
    }
    else {
      $scope.ot_app_data.add_time_last_out = $scope.ot_app_data.first_out;
      $scope.ot_app_data.add_time_last_out_need_clock = $scope.ot_app_data.first_out_need_clock;
    }

    $scope.add_time_list=[];
    //初始化休息段的数组
    if ($scope.ot_app_data.second_in != '') {
      $scope.add_time_list.push({
        name:'',
        in:$scope.ot_app_data.first_out,
        in_need_clock:$scope.ot_app_data.first_out_need_clock,
        out:$scope.ot_app_data.second_in,
        out_need_clock:$scope.ot_app_data.second_in_need_clock,
        is_need: true
      })
    }
    if ($scope.ot_app_data.third_in != '') {
      $scope.add_time_list.push({
        name:'',
        in:$scope.ot_app_data.second_out,
        in_need_clock:$scope.ot_app_data.second_out_need_clock,
        out:$scope.ot_app_data.third_in,
        out_need_clock:$scope.ot_app_data.third_in_need_clock,
        is_need: true
      })
    }
    if ($scope.ot_app_data.forth_in != '') {
      $scope.add_time_list.push({
        name:'',
        in:$scope.ot_app_data.third_out,
        in_need_clock:$scope.ot_app_data.third_out_need_clock,
        out:$scope.ot_app_data.forth_in,
        out_need_clock:$scope.ot_app_data.forth_in_need_clock,
        is_need: true
      })
    }
    if ($scope.ot_app_data.fifth_in != '') {
      $scope.add_time_list.push({
        name:'',
        in:$scope.ot_app_data.forth_out,
        in_need_clock:$scope.ot_app_data.forth_out_need_clock,
        out:$scope.ot_app_data.fifth_in,
        out_need_clock:$scope.ot_app_data.fifth_in_need_clock,
        is_need: true
      })
    }

    if($scope.ot_app_data.second_in!=''){
      document.getElementById('add_time_check').checked=true;
    }
    else{
      document.getElementById('add_time_check').checked=false;
    }

    //if($scope.ot_app_data.first_in_need_clock){
    //  document.getElementsByClassName('ot_need_click')[0].checked=true;
    //}
    //else{
    //  document.getElementsByClassName('ot_need_click')[0].checked=false;
    //}
    //if($scope.ot_app_data.first_out_need_clock){
    //  document.getElementsByClassName('ot_need_click')[1].checked=true;
    //}
    //else{
    //  document.getElementsByClassName('ot_need_click')[1].checked=false;
    //}
    //if($scope.ot_app_data.third_in_need_clock){
    //  document.getElementsByClassName('ot_break_need_clock')[0].checked=true;
    //}
    //else{
    //  document.getElementsByClassName('ot_break_need_clock')[0].checked=false;
    //}
    //if($scope.ot_app_data.third_out_need_clock){
    //  document.getElementsByClassName('ot_need_click')[1].checked=true;
    //}
    //else{
    //  document.getElementsByClassName('ot_need_click')[1].checked=false;
    //}
    //if($scope.ot_app_data.first_in_need_clock){
    //  document.getElementsByClassName('ot_need_click')[0].checked=true;
    //}
    //else{
    //  document.getElementsByClassName('ot_need_click')[0].checked=false;
    //}
    //if($scope.ot_app_data.first_out_need_clock){
    //  document.getElementsByClassName('ot_need_click')[1].checked=true;
    //}
    //else{
    //  document.getElementsByClassName('ot_need_click')[1].checked=false;
    //}
    //if($scope.ot_app_data.first_in_need_clock){
    //  document.getElementsByClassName('ot_need_click')[0].checked=true;
    //}
    //else{
    //  document.getElementsByClassName('ot_need_click')[0].checked=false;
    //}
    //if($scope.ot_app_data.first_out_need_clock){
    //  document.getElementsByClassName('ot_need_click')[1].checked=true;
    //}
    //else{
    //  document.getElementsByClassName('ot_need_click')[1].checked=false;
    //}


    if($scope.ot_app_data.ot_break_need_clock=='1'){
      for(var i=0;i<  document.getElementsByClassName('ot_break_need_clock').length;i++){
        document.getElementsByClassName('ot_break_need_clock')[i].checked=true;
      }
    }
    else{
      for(var i=0;i<  document.getElementsByClassName('ot_break_need_clock').length;i++){
        document.getElementsByClassName('ot_break_need_clock')[i].checked=false;
      }
    }
    var card_times=$scope.ot_app_data.card_times;

    //  $scope.in_need_clock=function(flag,i){
    //    console.log(  $scope.add_time_list);
    //    flag=!flag;
    //    $scope.add_time_list[i].in_need_clock=flag;
    //  }
    //  $scope.out_need_clock=function(flag,i){
    //    flag=!flag;
    //    $scope.add_time_list[i].out_need_clock=flag;
    //  }
    $scope.delete=function(item){
      var idx =  $scope.add_time_list.indexOf(item);
      $scope.add_time_list.splice(idx,1);
      if($scope.add_time_list.length=='0'){
        card_times=$scope.ot_app_data.card_times;
      }
      else{
        card_times=$scope.add_time_list.length+1;
      }

      var v=0;
      for(var j=0;j<$scope.add_time_list.length;j++){
        if($scope.add_time_list[j].in=='请选择'||$scope.add_time_list[j].out=='请选择'){
          v++;
        }
      }
      if(v==0){
        essMyApprovalDOTCSev.add_time_save($scope.add_time_list,$scope,false,'3',card_times);
      }


    }

    $scope.add=function(item){
      $scope.add_time_list.push({
        name:'',
        in:'请选择',
        in_need_clock:'',
        out:'请选择',
        out_need_clock:'',
        is_need:''
      })
      setTimeout(function(){ $ionicScrollDelegate.resize(); }, 200);
      if($scope.add_time_list.length=='0'){
        card_times=$scope.ot_app_data.card_times;
      }
      else{
        card_times=$scope.add_time_list.length+1;
      }
    }
  $scope.first_in_need_clock=function(){
    document.getElementById('first_in_need_clock').checked=!document.getElementById('first_in_need_clock').checked;
}
    $scope.first_out_need_clock=function(){
      document.getElementById('first_out_need_clock').checked=!document.getElementById('first_out_need_clock').checked;
    }
    $scope.rest_in=function(i){
      document.getElementById('rest_in'+i).checked=!document.getElementById('rest_in'+i).checked;
    }
    $scope.rest_out=function(i){
      document.getElementById('rest_out'+i).checked=!document.getElementById('rest_out'+i).checked;
    }

    $scope.showTime_in = function(i){

      if( $scope.add_time_list[i].in=='请选择'){
        $scope.add_time_list[i].defaultDate='00:00';
      }
      else{
        $scope.add_time_list[i].defaultDate=$scope.add_time_list[i].in
      }
      timeSelect.show({
        type :  'time',
        startDate :'1993年12月01日',
        endDate : '',
        defaultDate: $scope.add_time_list[i].defaultDate,
        returnDateType : 'hm',
        returnTimeType :  '24h'||'AMPM',
        //stepping :10,
        selectedFunc : function (date) {
          if (typeof(date) != 'undefined'){
            $scope.add_time_list[i].in = date;
            var v=0;
            for(var j=0;j<$scope.add_time_list.length;j++){
              if($scope.add_time_list[j].in=='请选择'||$scope.add_time_list[j].out=='请选择'){
                v++;
              }
            }
            if(v==0){
              essMyApprovalDOTCSev.add_time_save($scope.add_time_list,$scope,false,'3',card_times);
            }

          }
        }
      })
    }
    $scope.showTime_out = function(i){
      if( $scope.add_time_list[i].out=='请选择'){
        $scope.add_time_list[i].defaultDate='00:00';
      }
      else{
        $scope.add_time_list[i].defaultDate=$scope.add_time_list[i].out
      }
      timeSelect.show({
        type :  'time',
        startDate :'1993年12月01日',
        endDate : '',
        defaultDate: $scope.add_time_list[i].defaultDate,
        returnDateType : 'hm',
        returnTimeType :  '24h'||'AMPM',
        //stepping :10,
        selectedFunc : function (date) {
          if (typeof(date) != 'undefined'){
            $scope.add_time_list[i].out = date;
            var v=0;
            for(var j=0;j<$scope.add_time_list.length;j++){
              if($scope.add_time_list[j].in=='请选择'||$scope.add_time_list[j].out=='请选择'){
                v++;
              }
            }
            if(v==0){
              essMyApprovalDOTCSev.add_time_save($scope.add_time_list,$scope,false,'3',card_times);
            }
          }
        }
      })
    }
    $scope.show_time_first_in = function(){
      timeSelect.show({
        type :  'time',
        startDate :'1993年12月01日',
        endDate : '',
        defaultDate: $scope.ot_app_data.add_time_first_in,
        returnDateType : 'hm',
        returnTimeType :  '24h'||'AMPM',
        //stepping :10,
        selectedFunc : function (date) {
          if (typeof(date) != 'undefined'){
            $scope.ot_app_data.add_time_first_in = date;
            var v=0;
            for(var i=0;i<$scope.add_time_list.length;i++){
              if($scope.add_time_list[i].in=='请选择'||$scope.add_time_list[i].out=='请选择'){
                v++;
              }
            }
            if(v==0){
              essMyApprovalDOTCSev.add_time_save($scope.add_time_list,$scope,false,'3',card_times);
            }
          }
        }
      })
    }
    $scope.show_time_last_out = function(){
      timeSelect.show({
        type :  'time',
        startDate :'1993年12月01日',
        endDate : '',
        defaultDate: $scope.ot_app_data.add_time_last_out,
        returnDateType : 'hm',
        returnTimeType :  '24h'||'AMPM',
        //stepping :10,
        selectedFunc : function (date) {
          if (typeof(date) != 'undefined'){
            $scope.ot_app_data.add_time_last_out = date;
            var v=0;
            for(var i=0;i<$scope.add_time_list.length;i++){
              if($scope.add_time_list[i].in=='请选择'||$scope.add_time_list[i].out=='请选择'){
                v++;
              }
            }
            if(v==0){
              essMyApprovalDOTCSev.add_time_save($scope.add_time_list,$scope,false,'3',card_times);
            }
          }
        }
      })
    }
    //
    var new_arr_add_time_list=[];
    $scope.add_time_check=function(){

      if(document.getElementById('add_time_check').checked){
        document.getElementById('add_time_check').checked=false;
        document.getElementById('add_time_repeat_content').style.display='none';
        new_arr_add_time_list=$scope.add_time_list;
        $scope.add_time_list=[];
        card_times=$scope.add_time_list.length+1;

        var v=0;
        for(var i=0;i<$scope.add_time_list.length;i++){
          if($scope.add_time_list[i].in=='请选择'||$scope.add_time_list[i].out=='请选择'){
            v++;
          }
        }
        if(v!=0){
        }
        else {
          essMyApprovalDOTCSev.add_time_save($scope.add_time_list, $scope, false, '3', card_times);
        }

      }
      else{
        document.getElementById('add_time_check').checked=true;
        document.getElementById('add_time_repeat_content').style.display='block';
        if(new_arr_add_time_list.length!=0){
          $scope.add_time_list=new_arr_add_time_list;
          card_times=$scope.add_time_list.length+1;
          var v=0;
          for(var i=0;i<$scope.add_time_list.length;i++){
            if($scope.add_time_list[i].in=='请选择'||$scope.add_time_list[i].out=='请选择'){
              v++;
            }
          }
          if(v!=0){
            //alert('非法!');
          }
          else {
            essMyApprovalDOTCSev.add_time_save($scope.add_time_list, $scope, false, '3', card_times);
          }
        }
        else{
          $scope.add();
        }
      }
    }
    $scope.add_time_save=function(){
      //console.log
      var v=0;
      for(var i=0;i<$scope.add_time_list.length;i++){
        if($scope.add_time_list[i].in=='请选择'||$scope.add_time_list[i].out=='请选择'){
          v++;
        }
      }
      if(v!=0){
        $ionicPopup.alert({
          title: '运行结果',
          template: '<div style="text-align: center;">请选择休息时间</div>',
          okText: '确定'
        })
      }
      else{
        essMyApprovalDOTCSev.add_time_save($scope.add_time_list,$scope,true,'1',card_times);
      }
    }
  })

   .controller('perDataDetailCtrl', function($scope, perDataDetailSev, $location, $timeout, $ionicLoading, $ionicActionSheet,timeSelect,sideSelect,$ionicHistory,$ionicScrollDelegate) {
    /*Sunny改*/
    $scope.edit_data_01 = local_resource + 'img/icon/edit_data_01.png';
    $scope.personnal_data_bg= local_resource + 'img/model/personnal_data_bg.png';
    $scope.personnal_data_back= local_resource + 'img/icon/personnal_data_back.png';
    $scope.personnal_data_edit= local_resource + 'img/icon/personnal_data_edit.png';
    $scope.male_icon= local_resource + 'img/icon/male_icon.png';
    $scope.female_icon= local_resource + 'img/icon/female_icon.png';
    $scope.arrow_right = local_resource + 'img/icon/arrow_right.png';
    $scope.id_card_icon = local_resource + 'img/icon/id_card_icon.png';
    $scope.education_icon = local_resource + 'img/icon/education_icon.png';
    $scope.telephone_icon = local_resource + 'img/icon/telephone_icon.png';
    $scope.email_icon = local_resource + 'img/icon/email_icon.png';
    $scope.residence_address_icon = local_resource + 'img/icon/residence_address_icon.png';
    $scope.emergency_contact_icon = local_resource + 'img/icon/emergency_contact_icon.png';
    $scope.emergency_telephone = local_resource + 'img/icon/emergency_telephone.png';
    $scope.personnal_data_detail_bgt = local_resource + 'img/model/personnal_data_detail_bgt.png';
    perDataDetailSev.clearData();
    perDataDetailSev.loadStaffMsDetails();
    $scope.staff_master_details = perDataDetailSev.getStaffMsDetails();

    $scope.change_bg=function(){
      var hideSheet = $ionicActionSheet.show({
        buttons: [

          {
            text: '拍照'
          }, {
            text: '从手机相册选择'
          }
        ],

        //titleText: 'Modify your album',
        titleText: '选择上传图片方式',
        cancelText: '取消',
        cancel: function() {
          // add cancel code..
        },
        buttonClicked: function(index) {

          if (index == 0) {

            try {
              navigator.camera.getPicture(function(uri) {


                $('#perdatadetail_bg_img').attr("src", uri);

                perDataDetailSev.saveStaffPhoto($scope.staff_master_details.employee_no);
				fufuMobclickAgent('click_personnal_background_save');
              }, function() {
                //alert('cancel or failure');
              }, {
                allowEdit: false,
                destinationType: Camera.DestinationType.FILE_URI,
                quality: 100,
                targetHeight: 800,
                targetWidth: 800,
                correctOrientation: true
              });
            } catch (e) {
              //alert(e.message);
            }




            return true;
          } else if (index == 1) {
            try {
              navigator.camera.getPicture(function(uri) {


                $('#perdatadetail_bg_img').attr("src", uri);
                perDataDetailSev.saveStaffPhoto($scope.staff_master_details.employee_no);
				fufuMobclickAgent('click_personnal_background_save');
              }, function(message) {}, {
                quality: 100,
                destinationType: Camera.DestinationType.FILE_URI,
                // In this app, dynamically set the picture source, Camera or photo gallery
                sourceType: Camera.PictureSourceType.SAVEDPHOTOALBUM,
                encodingType: Camera.EncodingType.JPEG,
                mediaType: Camera.MediaType.PICTURE,
                allowEdit: false,
                targetHeight: 800,
                targetWidth: 800,
                correctOrientation: true
              });
            } catch (e) {
              //alert(e.message);
            }

            return true;
          }

          return true;


        }
      });
    }
    $scope.perDataDetailBack=function(){
      $ionicHistory.goBack();
    }
    $scope.perDataDetailEdit=function(){
      $location.path("home_page/personnal_details");
    }

    $scope.edit_id_detail=function(){
      $location.path("home_page/edit_id_detail");
    }
    $scope.edit_contact_detail=function(){
      $location.path("home_page/edit_contact_detail");
    }
    var oldScaleVal = 0;
    var isAutoPlay= true;
    $scope.ParallaxScroll=function(){
      var newTop = $ionicScrollDelegate.getScrollPosition().top;
      // console.log(newTop);
     // var setScaleVal = (Math.abs(newTop) / $('#ionSlidesBox').height() + 1).toFixed(4);
        var setScaleVal= ((Math.abs(newTop)+210)/210).toFixed(4);
      if(newTop>= 146){
        $("#per_navbar_div").css({
          'opacity':'0'
        })
        $("#per_navbar_bg_div").css({
          'opacity':'1'
        })
        $("#per_navbar_bg_div_icon").css({
          'opacity':'1'
        })
      }
      else if(newTop==0){
        $("#per_navbar_div").css({
          'opacity':'1'
        })
        $("#per_navbar_bg_div").css({
          'opacity':'0'
        })
        $("#per_navbar_bg_div_icon").css({
          'opacity':'0'
        })
      }
      else{
        $("#per_navbar_bg_div").css({
          'opacity':newTop/150,
          'display':'block'
        })
        $("#per_navbar_div").css({
          'opacity':150/newTop
        })
        $("#per_navbar_bg_div_icon").css({
          'opacity':'0'
        })
      }

      if (newTop < 0) {
        //var setScaleVal = (Math.abs(newTop) / $('#ionSlidesBox').height() + 1).toFixed(4);
        $("#per_navbar_div").css({
          'opacity':1
        })
        if (setScaleVal != oldScaleVal) {

          $('.fixedIonSlidesBox').css({
            '-webkit-transform': 'scale(' + setScaleVal + ',' + setScaleVal + ')',
            'display': 'block'
          });
          // debugger;
          // console.log(Math.abs(newTop).toFixed(2));
          $("#personnal_data_details_employee_other_photo_div").css({
            '-webkit-transform': 'translateY(' + Math.abs(newTop).toFixed(2) + 'px)',
            'display': 'block',
            'opacity': 1
          });
          $("#personnal_data_wrap ").css({
            'display': 'block',
            'opacity': 1
          })
          if (isAutoPlay) {
            isAutoPlay = false;

            $("#personnal_data_details_bg").css({
              'opacity': 0
            });

          }

          oldScaleVal = setScaleVal;
        }
      }
      else if (newTop >= 0) {

        if (!isAutoPlay) {
          isAutoPlay = true;

          $("#personnal_data_details_bg").css({
            'opacity': 1
          });
          $('.fixedIonSlidesBox').css({
            '-webkit-transform': 'scale(1,1)',
            'display': 'none'
          });

          $("#personnal_data_details_employee_other_photo_div").css({
            '-webkit-transform': 'translateY(' + -newTop + 'px)',
            'opacity': 0
          })

          $("#personnal_data_wrap ").css({
            'display': 'none',
            'opacity': 0
          })
        }
        else{

          $("#personnal_data_details_bg").css({
            'opacity': 1
          });
          $('.fixedIonSlidesBox').css({
            '-webkit-transform': 'scale(1,1)',
            'display': 'none'
          });

          $("#personnal_data_wrap ").css({
            'display': 'none',
            'opacity': 0
          })
        }
      }
  oldTop = newTop;



      //var setScaleVal = (Math.abs(newTop) / $('#ionSlidesBox').height() + 1).toFixed(4);
      //$('.fixedIonSlidesBox').css({
      //  '-webkit-webkitTransform': 'scale(' + setScaleVal + ',' + setScaleVal + ')',
      //  'display': 'block'
      //});

    }
  })

  .controller('EditIdDetailsCtrl', function($scope, EditIdDetailsSev, $location, $timeout, $ionicLoading, $ionicActionSheet,timeSelect,sideSelect,$ionicHistory,$ionicPopup,perDetailSev,perDataDetailSev) {
    //EditIdDetailsSev.clearData();
    //EditIdDetailsSev.loadStaffMsDetails();
    $scope.staff_master_details = perDataDetailSev.getStaffMsDetails();

    if($scope.staff_master_details.id_type_index===''){
      document.getElementById("edit_id_details_id_type").innerHTML='请选择';
    }
    else{
      document.getElementById("edit_id_details_id_type").innerHTML=$scope.staff_master_details.id_type[$scope.staff_master_details.id_type_index].value_;
    }
    if($scope.staff_master_details.education_level_index===''){
      $("#education_level").html('请选择');
    }
    else{
      $("#education_level").html($scope.staff_master_details.education_level[$scope.staff_master_details.education_level_index].value_);
    }
    //$scope.staff_master_details = perDetailSev.getStaffMsDetails();
    $scope.id_type_index=$scope.staff_master_details.id_type_index;
    if($scope.id_type_index===''){
      $scope.staff_master_details.id_type_data_key='';
    }
    else{
      $scope.staff_master_details.id_type_data_key=$scope.staff_master_details.id_type_data[$scope.id_type_index].key;
    }


    $scope.edit_id_details_id_type=function(){
      sideSelect.show({
        type : 'ios',
        data :$scope.staff_master_details.id_type_data,
        selectIndex :  $scope.id_type_index,
        selectedFunc : function (index) {
          if(typeof(index)!='undefined'){
            document.getElementById("edit_id_details_id_type").innerHTML=$scope.staff_master_details.id_type_data[index].value;
            $scope.staff_master_details.id_type_data_key=$scope.staff_master_details.id_type_data[index].key;
            $scope.id_type_index=index;


          }
        }
      });
    }
    $scope.education_level_index=$scope.staff_master_details.education_level_index;
    if($scope.education_level_index===''){
      $scope.staff_master_details.education_level_data_key='';
    }
    else{
      $scope.staff_master_details.education_level_data_key=$scope.staff_master_details.education_level_data[$scope.education_level_index].key;
    }
    $scope.education_level=function(){
      sideSelect.show({
        type : 'ios',
        data :$scope.staff_master_details.education_level_data,
        selectIndex :  $scope.education_level_index,
        selectedFunc : function (index) {
          if(typeof(index)!='undefined'){

            document.getElementById("education_level").innerHTML=$scope.staff_master_details.education_level_data[index].value;
            $scope.staff_master_details.education_level_data_key=$scope.staff_master_details.education_level_data[index].key;
            $scope.education_level_index=index;
          }
        }
      });
    }
    $scope.cancel=function() {
      var pannel_arr = [$scope.staff_master_details.id_type_data_key, $("#id_number").val(),$scope.staff_master_details.education_level_data_key];
      var loaddata_arr = [$scope.staff_master_details._id_type_key, $scope.staff_master_details.id_number,$scope.staff_master_details._education_level_key];
      var _i = 0;
      for (var i = 0; i < pannel_arr.length; i++) {
        if (pannel_arr[i] != loaddata_arr[i]) {
          _i++;
          break;
        }
      }
      if (_i == 0) {
        $ionicHistory.goBack()
      }
      else {
        $ionicPopup.confirm({
          title: '',
          template: '<div style="text-align: center;">是否放弃当前编辑</div>',
          cancelText: '放弃',
          cancelType: 'button-dark',
          okText: '继续编辑'
        }).then(function (res) {
          if (!res) {
            $ionicHistory.goBack()
          }
        });
      }
    }
    $scope.saveStaffDetails=function(){
      EditIdDetailsSev.saveStaffDetails($scope);
    }








  })


  .controller('EditContactDetailsCtrl', function($scope, EditContactDetailsSev, $location, $timeout, $ionicLoading, $ionicActionSheet,timeSelect,sideSelect,$ionicHistory,$ionicPopup,perDataDetailSev) {

    $scope.staff_master_details = perDataDetailSev.getStaffMsDetails();
    $scope.cancel=function() {
      var pannel_arr = [$("#address").val(), $("#mobile_no").val(), $("#email").val(), $("#emergency_contact_name1").val(), $("#emergency_contact_no1").val()];
      var loaddata_arr = [$scope.staff_master_details.address, $scope.staff_master_details.home_tel_no, $scope.staff_master_details.email, $scope.staff_master_details.emergency_contact_name1, $scope.staff_master_details.emergency_contact_no1]
      var _i = 0;
      for (var i = 0; i < pannel_arr.length; i++) {
        if (pannel_arr[i] != loaddata_arr[i]) {
          _i++;
          break;
        }
      }
      if (_i == 0) {
        $ionicHistory.goBack()
      }
      else {
        $ionicPopup.confirm({
          title: '',
          template: '<div style="text-align: center;">是否放弃当前编辑</div>',
          cancelText: '放弃',
          cancelType: 'button-dark',
          okText: '继续编辑'
        }).then(function (res) {
          if (!res) {
            $ionicHistory.goBack()
          }
        });
      }
    }
    $scope.saveStaffDetails=function(){
      EditContactDetailsSev.saveStaffDetails($scope);
    }
  })

  .controller('MyBusinessCtrl', function($scope, MyBusinessSev, $location, $timeout, $ionicLoading, $ionicActionSheet,timeSelect,sideSelect,$ionicHistory,$ionicPopup) {
    $scope.business_icon = local_resource + 'img/icon/business_icon.png';
    $scope.department_icon = local_resource + 'img/icon/department_icon.png';
    $scope.position_icon = local_resource + 'img/icon/position_icon.png';
    $scope.join_data_icon = local_resource + 'img/icon/join_data_icon.png';
    MyBusinessSev.clearData();
    MyBusinessSev.loadStaffMsDetails();
    $scope.staff_master_details = MyBusinessSev.getStaffMsDetails();

  })
  .controller('PerSettingCtrl', function($scope, $location, $timeout, $ionicLoading, $ionicActionSheet,timeSelect,sideSelect,$ionicHistory,$ionicPopup,$rootScope) {
    $scope.modify_password=function(){
      $location.path("home_page/modify_password");
    }
    $scope.resign_user=function(){
      $location.path("home_page/resign_user");
    }
    $scope.change_username=function(){
      $location.path("home_page/change_username");
    }


  })

  .controller('MsgSettingCtrl', function($scope,MsgSettingSev,$location, $timeout, $ionicLoading, $ionicActionSheet,timeSelect,sideSelect,$ionicHistory,$ionicPopup,$rootScope,$ionicScrollDelegate) {


    // ak 17-07-20

    $scope.$on("$ionicView.beforeEnter", function(event, data){
      //alert("进入之前");
      if(MsgSettingSev.isData()){
          $timeout(function(){
                $scope.message_setting_data = MsgSettingSev.getData();
          },0);
      }
    });

    $scope.$on("$ionicView.afterEnter", function(event, data){
      //alert("进入之后");
      if(!MsgSettingSev.isData()){

          MsgSettingSev.loadData().then(function(greeting) {

            $timeout(function(){
                $scope.message_setting_data = MsgSettingSev.getData();

            },0);
          }, function(reason) {
            //alert('失败鸟: ' + reason);
          }, function(update) {
            //alert('收到通知: ' + update);
          });
      }
    });

    $scope.$on("$ionicView.afterLeave", function(event, data){
      //alert("离开之后");
        if($location.$$url != "/home_page/setting_repeat" && $location.$$url != "/home_page/setting_repeat_msg"){
            //离开之后不是到 /home_page/setting_repeat 必须还原数据
            MsgSettingSev.restoreImage();
        }

    });

    //安卓没有设置声音功能
    $scope.isIos = ionic.Platform.isIOS();


    // ak 17-07-20 END

    $scope.msgsetting_delete_icon = local_resource + 'img/icon/msgsetting_delete_icon.png';
  	$scope.msgsetting_add_icon = local_resource + 'img/icon/msgsetting_add_icon.png';

	//$scope.times_data=[{"time":"07:30"},{"time":"17:30"}];
	$scope.times_add=function(){
		if ($scope.message_setting_data.times_data.length == 10){
			window.fufuMessageBox('不能超过10个提醒时间', fufu_message_box_duration, function() {});
			return;
		}
		$scope.message_setting_data.times_data.push({"time":"09:00"});
		$ionicScrollDelegate.resize();
	}

	$scope.select_time=function(item){

      timeSelect.show({
        type :  'time' ,
        startDate :  '1900-01-01',
        endDate : '2099-12-31',
        defaultDate: item.time,
        returnDateType : 'y-m-d',
        returnTimeType :  '24h'||'AMPM',
        selectedFunc : function (date) {
          if (typeof(date) != 'undefined'){
            item.time = date;
          }
        }
      })
	}
	$scope.sound_data=[{
      key:'0',
      value:'系统音'
    },{
      key:'1',
      value:'服服小天使语音'
    }];

  	$scope.message_sound=function(){

        sideSelect.show({
          type : 'ios',
          data :$scope.sound_data,
          selectIndex : $scope.message_setting_data.mesg_sound_index,
          selectedFunc : function (index) {
            if(typeof(index)!='undefined'){

              $timeout(function(){

                $scope.message_setting_data.mesg_sound_index = index;
                  if(index=='0'){
                    playSound.play(function(msg){},"default");
                    $scope.message_setting_data.mesg_sound='default';
                  }
                  else if(index=='1'){
                    playSound.play(function(msg){},"message_sound");
                    $scope.message_setting_data.mesg_sound='message_sound';
                  }
              },0);

            }
          }
        });
  	};

    // 打卡提醒类型 .start
    $scope.card_remird_data=[{
      key:'0',
      value:'按班次卡点'
    },{
      key:'1',
      value:'按指定时间'
    },{
      key:'2',
      value:'关闭打卡提醒'
    }];

    $scope.set_card_remird=function(){

        sideSelect.show({
          type : 'ios',
          data :$scope.card_remird_data,
          selectIndex : $scope.message_setting_data.card_remird_type_index,
          selectedFunc : function (index) {
            if(typeof(index)!='undefined'){

              $timeout(function(){

                $scope.message_setting_data.card_remird_type_index = index;
                  if(index=='0'){
                    //按班次卡点
                    $scope.message_setting_data.card_remird_type = "by_minute";
                  }
                  else if(index=='1'){
                     //按指定时间
                     $scope.message_setting_data.card_remird_type = "by_time";
                  }else if(index =='2'){
                      $scope.message_setting_data.card_remird_type = "";
                  }

                $ionicScrollDelegate.resize();
              },0);

            }
          }
        });
    };


    // 打卡提醒类型 .end


  	$scope.sound_by_minute_data=[{
        key:'0',
        value:'系统音'
      },{
        key:'1',
        value:'服服打卡语音'
      }];


  	$scope.message_sound_by_minute=function(){

        sideSelect.show({
          type : 'ios',
          data :$scope.sound_by_minute_data,
          selectIndex :  $scope.message_setting_data.sound_by_minute_index,
          selectedFunc : function (index) {
            if(typeof(index)!='undefined'){
              $timeout(function(){
                  if(index=='0'){
                  playSound.play(function(msg){},"default");
                  $scope.message_setting_data.remird_sound = 'default';
                }
                else if(index=='1'){
                  playSound.play(function(msg){},"singin_sound");
                  $scope.message_setting_data.remird_sound = 'singin_sound';
                }
                $scope.message_setting_data.sound_by_minute_index = index;

              },0);

            }
          }
        });
  	}


  	$scope.times_delete=function(item,$event){
  		$event.stopPropagation();
  		if ($scope.message_setting_data.times_data.length == 1){
  			window.fufuMessageBox('不能少于1个提醒时间', fufu_message_box_duration, function() {});
  			return;
  		}
  		var idx =  $scope.message_setting_data.times_data.indexOf(item);
  		$scope.message_setting_data.times_data.splice(idx,1);
  	}


    $scope.setting_repeat = function(){
       if($location.$$url == "/home_page/message_setting"){
          $location.path("home_page/setting_repeat");
       }else if($location.$$url == "/home_page/message_setting_msg"){
          $location.path("home_page/setting_repeat_msg");
       }

    }
  	$scope.message_setting_save=function(){

  		var card_remird_value=[];
  		for(var i=0;i<$scope.message_setting_data.times_data.length;i++){
  			card_remird_value.push($scope.message_setting_data.times_data[i].time);
  		}


  		$scope.message_setting_data.remird_time=card_remird_value.join(",");

  		MsgSettingSev.MsgSettingSave($scope);
  	}





  })
  .controller('SettingRepeatCtrl', function($scope,MsgSettingSev,$location, $timeout, $ionicLoading, $ionicActionSheet,timeSelect,sideSelect,$ionicHistory,$ionicPopup,$rootScope,$ionicScrollDelegate) {
      $scope.$on("$ionicView.afterEnter", function(event, data){
        //alert("SettingRepeatCtrl");
            if(MsgSettingSev.isData()){
                $timeout(function(){
                      $scope.message_setting_data = MsgSettingSev.getData();
                },0);
            }
      });


      $scope.setting_repeat_diy = function(index,val){
        if(index == 3){
          if($location.$$url == "/home_page/setting_repeat"){
              $location.path("home_page/setting_repeat_diy");
          }else if($location.$$url == "/home_page/setting_repeat_msg"){
              $location.path("home_page/setting_repeat_diy_msg");
          }

        }else if(index < 3 && index >= 0){
          $scope.message_setting_data.repeat_select_index = index;
          $scope.message_setting_data.repeat_select_val = val;
          $scope.message_setting_data.repeat_select_diy_list = [
            {
              value : '周一',
              key : 0,
              checked: false
            },{
              value : '周二',
              key : 1,
              checked: false
            },{
              value : '周三',
              key : 2,
              checked: false
            },{
              value : '周四',
              key : 3,
              checked: false
            },{
              value : '周五',
              key : 4,
              checked: false
            },{
              value : '周六',
              key : 5,
              checked: false
            },{
              value : '周日',
              key : 6,
              checked: false
            }
          ];
          $ionicHistory.goBack();
        }

      }

  })
  .controller('SettingRepeatDiyCtrl', function($scope,MsgSettingSev,$location, $timeout, $ionicLoading, $ionicActionSheet,timeSelect,sideSelect,$ionicHistory,$ionicPopup,$rootScope,$ionicScrollDelegate) {
      $scope.backups_select_diy = [];

      $scope.$on("$ionicView.afterEnter", function(event, data){
            $scope.backups_select_diy = [];

            if(MsgSettingSev.isData()){
                $timeout(function(){
                      $scope.message_setting_data = MsgSettingSev.getData();
                      angular.copy($scope.message_setting_data.repeat_select_diy_list,$scope.backups_select_diy);

                },0);
            }

      });

      $scope.save_select_diy = function(){
          angular.copy($scope.backups_select_diy,$scope.message_setting_data.repeat_select_diy_list);

          MsgSettingSev.buildRepeatDiyStr();

          $ionicHistory.goBack(-2);
      }


  })



  .controller('atSignInNewCtrl',function($ionicViewSwitcher,$scope,atSignInNewSev,$stateParams,$location,$ionicPopup,$ionicHistory,$rootScope,$ionicActionSheet,homemessageSev,timeSelect,$timeout){
    //$scope.css_vertical=(document.body.scrollHeight -100-350)/2+"px";
	$scope.at_sign_in_tap='1';

	try {
		getLocation.checkCanLocation(
			function(result){
			}
		);
	} catch (e){
		console.log(e.message);
	}

    $scope.wrap_height =(parseInt(document.body.scrollHeight)*0.50)+"px";
    $scope.position_top=parseInt(document.body.scrollHeight)*0.50-82+"px";
    $scope.default_ios_content_top=(parseInt(document.body.scrollHeight)*0.50 + 122) + "px";
    $scope.default_android_content_top=(parseInt(document.body.scrollHeight)*0.50 + 102) + "px";
    var current_date = new Date();

    current_date = (current_date.getFullYear() + '-' + (current_date.getMonth() + 1 < 10 ? '0' + (current_date.getMonth() + 1): (current_date.getMonth() + 1)) + '-' + (current_date.getDate() < 10 ? '0' + (current_date.getDate()): (current_date.getDate())));

    atSignInNewSev.clearLocationErrorObjData();
    atSignInNewSev.clearData();
    $scope.location_error_obj=atSignInNewSev.getLocationErrorObjData();

    //alert(document.body.scrollHeight);
   // alert(typeof(document.getElementById("signinsucessbox")));

    //$scope.css_vertical=(document.body.scrollHeight -100-350)/2+"px";
    //alert($("#at_sign_in_new_bg_2_div").css("height"));

    /*if(document.getElementById("signinsucessbox")==null || typeof(document.getElementById("signinsucessbox"))=='undefined'){
      document.body.insertAdjacentHTML('afterbegin', '<div style="display: none;" id="signinsucessbox"> <div class="loading-container visible active"> <div style="width: 100%;height: 100%;position:absolute;top: 0px;background-color: #333;left: 0px;opacity: 0.5; "></div> <div style="margin-top: 0px;background-color:white;font-size: 12px;width: 7.2rem;height:8.533333rem;border-radius: 10px;text-align: center;overflow: hidden;z-index: 14;-webkit-transition: all 0.4s ease-in;webkitTransform: scale(0.1,0.1);" id="signinsucessdiv" ><div style="height:5.466666rem;margin-top:-2px;"> <img src='+local_resource + "img/icon/sign_in_success.png"+' alt="" style="width:100%;height:5.466666rem;"/> </div><div style="height:3.066666667rem;padding-top:0.746666666666rem"> <div > <p style="text-align: center;font-size: 0.53333rem;margin-top: 4px;color: #ffba5d;font-weight: bold;"> 签卡成功</p> <p id="at_sign_in_sucess_box_text" style="margin-top: 0.4rem;font-size: 0.4rem;color: #999;"></p> </div> </div> </div> </div></div>' );
    }*/
    var i=Math.round(Math.random()*9);
    $scope.at_sign_in_sucess_box_text_arr=['心情愉快，工作才能满状态','每次发奋的背后，必有加倍的赏赐','不积跬步无以至千里','有志者事竟成','业精于勤而荒于嬉','天道酬勤，宁静致远','耕耘于分秒，收获于细微','努力造就实力，态度决定高度','发光并非太阳的专利，你也能发光','天行健，君子以自强不息'];
    document.getElementById('at_sign_in_sucess_box_text').innerHTML=$scope.at_sign_in_sucess_box_text_arr[i];



    window.to_sign_in_history = function(){
		$ionicViewSwitcher.nextDirection('back');
		window.location.href="#/home_page/at_sign_in_history";
    }
    window.to_use_help = function(){
      window.location.href="#/home_page/use_help";
    }
    window.at_sign_in_new_confirm_submit = function($location){

      window.location.href='#/home_page/remote_clock';
    }

    $scope.$on("$ionicView.enter", function(event, data){
      //alert($("#at_sign_in_new_bg_2_div").css("height"));
      //
      //$("#atSignInNewRecond").click(function(){
      //  alert("1");
      //  $location.path('home_page/about_app')
      //})

      document.getElementById("atSignInNewRecond").src=local_resource + 'img/icon/at_sign_in_new_record.png';
      document.getElementById("atSignInNewHelp").src=local_resource + 'img/icon/at_sign_in_new_help.png';
      document.getElementById('sign_in_tab_1').onclick=function(){
		  //$scope.at_sign_in_tap='1';
		document.getElementById('at_sign_in_card_content_tap1').style.display="block";
		document.getElementById('at_sign_in_card_content_tap2').style.display="none";
		document.getElementById('at_sign_in_prompt_div').style.display="block";




        document.getElementById('sign_in_tab_1').style.color='#53afff';
        document.getElementById('sign_in_tab_1').style.backgroundColor='white';
        document.getElementById('sign_in_tab_2').style.color='white';
        document.getElementById('sign_in_tab_2').style.backgroundColor='#53afff';
        document.getElementById('signoutdoor').style.display="none";
        document.getElementById('sign_indoor_content_wrap').style.display="block";
        document.getElementById('sign_outdoor_content_wrap').style.display="none";
        document.getElementById('signindoor').style.display="block";
      }
      document.getElementById('sign_in_tab_2').onclick=function(){
		//$scope.at_sign_in_tap='2';






        if($scope.atSignInData.can_fieldwork=="1"){
          document.getElementById('sign_in_tab_2').style.color='#53afff';
          document.getElementById('sign_in_tab_2').style.backgroundColor='white';
          document.getElementById('sign_in_tab_1').style.color='white';
          document.getElementById('sign_in_tab_1').style.backgroundColor='#53afff';
          document.getElementById('signoutdoor').style.display="block";
          document.getElementById('signindoor').style.display="none";
          document.getElementById('sign_indoor_content_wrap').style.display="none";
          document.getElementById('sign_outdoor_content_wrap').style.display="block";
		  document.getElementById('at_sign_in_prompt_div').style.display="none";
		  document.getElementById('at_sign_in_card_content_tap1').style.display="none";
		  document.getElementById('at_sign_in_card_content_tap2').style.display="block";
        }
        else if ($scope.atSignInData.can_fieldwork=="0"){
          window.fufuMessageBox("今天尚未申请外出", fufu_message_box_duration, function() {});
        }
        else if ($scope.atSignInData.can_fieldwork=="-1"){
          window.fufuMessageBox("尚未开通上报位置，请联系管理员", fufu_message_box_duration, function() {});
        }

      }
    });
    var shake_process_timeout;
    var current_address = '';
    var current_latitude = '';
    var current_longitude = '';
    var  address_city='';
    var temp_location_not_valid;
    var temp_location_valid;
    var temp_wifi_sign_in;
    var temp_wifi_not_valid;
    var temp_sign_in_all_valid;
    var location_loading = false;
    var wifi_loading = false;
	var validate_no_error = false;
    $scope.shake_original = local_resource + 'img/icon/shake_process1.png';
    $scope.shake_disable = local_resource + 'img/icon/shake_disable.png';
    $scope.press_img = local_resource + 'img/icon/Field_manual_punch.png';
    $scope.press_disable_img = local_resource + 'img/icon/Field_manual_punch_02.png';
    $scope.img_selected = local_resource + 'img/icon/selected.png';
    $scope.wifi_img = local_resource + 'img/icon/wifi.png';
    $scope.img_at_disable_sign_in = local_resource + 'img/icon/at_disable_sign_in.png';
    $scope.signinbgimg= local_resource + 'img/model/sign_in_div_bgimg.png';
    $scope.sign_in_success= local_resource + 'img/icon/sign_in_success.png';
//new imgsrc
    $scope.field_attendance= local_resource+'img/icon/field_attendance.png';
    $scope.Sign_photos= local_resource+'img/icon/Sign_photos.png';
    $scope.img_team_attendance_iocation = local_resource+'img/icon/team_attendance_iocation.png';
    $scope.img_team_attendance_wifi = local_resource+'img/icon/team_attendance_wifi.png';
    $scope.img_team_attendance_fingerprint = local_resource+'img/icon/team_attendance_fingerprint.png';
    $scope.img_team_attendance_examination = local_resource+'img/icon/team_attendance_examination.png';
    $scope.at_sign_in_history_circle1 = local_resource+'img/icon/at_sign_in_history_circle1.png';
    $scope.at_sign_in_history_circle2 = local_resource+'img/icon/at_sign_in_history_circle2.png';
	$scope.at_sign_in_history_circle0 = local_resource+'img/icon/at_sign_in_history_circle0.png';
    $scope.at_sign_in_history_circle3 = local_resource+'img/icon/at_sign_in_history_circle3.png';

    $scope.img_circle6 = local_resource+'img/icon/circle6.png';
    $scope.at_sign_in_history_address_icon = local_resource+'img/icon/at_sign_in_history_address_icon.png';
    $scope.at_sign_in_history_wifi_icon = local_resource+'img/icon/at_sign_in_history_wifi_icon.png';
    $scope.img_normal_sign_in = local_resource+'img/icon/sign_in_normal.png';
    $scope.img_fieldwork_sign_in = local_resource+'img/icon/sign_in_fieldwork.png';
    $scope.img_other_sign_in = local_resource+'img/icon/sign_in_other_types.png';
    $scope.at_sign_in_new_record= local_resource + 'img/icon/at_sign_in_new_record.png';
    $scope.at_sign_in_new_help= local_resource + 'img/icon/at_sign_in_new_help.png';
    $scope.at_sign_in_new_icon_2= local_resource + 'img/icon/at_sign_in_new_icon_2.png';
    $scope.at_sign_out_new_icon_2= local_resource + 'img/icon/at_sign_out_new_icon_2.png';
    $scope.at_sign_in_outdoor_icon= local_resource + 'img/icon/at_sign_in_outdoor_icon.png';
    $scope.new_wifi_img_2= local_resource + 'img/icon/new_wifi_icon_2.png';
    $scope.img_wave2_2 = local_resource + 'img/icon/wave2_2.png';
    $scope.at_sign_in_new_bg_1 = local_resource + 'img/icon/at_sign_in_new_bg_1.png';
    $scope.at_sign_in_new_bg_2 = local_resource + 'img/icon/at_sign_in_new_bg_2.png';
    $scope.at_sign_out_new_icon_2_gray = local_resource + 'img/icon/at_sign_out_new_icon_2_gray.png';
    $scope.at_sign_in_new_icon_2_gray = local_resource + 'img/icon/at_sign_in_new_icon_2_gray.png';
    $scope.at_sign_in_new_line_left = local_resource + 'img/icon/at_sign_in_new_line_left.png';
    $scope.at_sign_in_new_line_right = local_resource + 'img/icon/at_sign_in_new_line_right.png';
    $scope.at_sign_in_new_sconfirm_icon = local_resource + 'img/icon/at_sign_in_new_sconfirm_icon.png';
    $scope.getloc_icon = local_resource + 'img/icon/getloc_icon.png';
	$scope.at_sign_in_prompt_icon = local_resource + 'img/icon/at_sign_in_prompt_icon.png';

    fufuMobclickAgent('click_sign_in_view');
    $scope.outdoor_address='';
    $scope.img_exit_trial_login = local_resource + 'img/icon/exit_trial_login.png';
    if (window.localStorage["is_free_trial_login"] != null && typeof(window.localStorage["is_free_trial_login"]) != 'undefined' && window.localStorage["is_free_trial_login"] != '') {
      document.getElementById("at_sign_in_new_is_trial_login").style.display='block';
    }
    else {
      document.getElementById("at_sign_in_new_is_trial_login").style.display='none';
    }


    $scope.free_trial_log_out = function () {
      $ionicPopup.confirm({
        title: '退出登录',
        template: '<div style="text-align: center;">是否退出系统?</div>',
        cancelType:'button-dark',
        cancelText: '取消',
        okText: '确定'
      }).then(function (res) {
        if (res) {
          //$rootScope.showLoading();
          $.ajax({
            type: "GET",
            url: window.localStorage['_remote_server_addr']+'?event=ionicAction.ionicAction.doLogout',
            timeout: _var_timeout,
            success: function (data) {
              $rootScope.hideLoading();
            },
            error:function(data){
              $rootScope.hideLoading();
              /*
               $ionicPopup.alert({
               title : '提醒',
               template : '<div style="text-align: center;">'+fufu_network_error_msg+'</div>',
               okText : '确定'
               });
               */
            }
          });
          $ionicHistory.clearCache();
          $ionicHistory.clearHistory();
          window.localStorage['_pass_word']='';
          window.localStorage['_is_login']=0;
          if (window.localStorage["menu_list"] != null && typeof(window.localStorage["menu_list"]) != 'undefined' && window.localStorage["menu_list"] != ''){
            var model_list = window.localStorage["menu_list"].split(',');
            for (var i=0;i<model_list.length;i++){
              if (model_list[i] != ''){
                window.localStorage[model_list[i]] = '';
              }
            }
          }
          window.localStorage["menu_list"] = '';
          window.localStorage["menu_home"] = '';
          window.localStorage["menu_message"] = '';
          window.localStorage["menu_organization_management"] = '';
          window.localStorage["menu_time"] = '';
          window.localStorage["menu_payroll"] = '';
          window.localStorage["menu_ess"] = '';
          window.localStorage["menu_My_Team"] = '';
          window.localStorage["menu_setting"] = '';
          window.localStorage["personnal_data"] = '';
          window.localStorage['is_free_trial_login'] = '';
          login_init_flag = 0;
          $location.path('/');

        }
      });
    }


    //上报位置显示地址
    //try{
    //  getLocation.location(function(msg){
    //    current_address = msg.address;
    //    current_latitude = msg.latitude;
    //    current_longitude = msg.longitude;
    //    address_city= msg.city;
    //    if(typeof(current_address)!="undefined" && current_address!='') {
    //      try{
    //        //$("#atSignInNewCtrlSpinnerWarp").css({
    //        //  "display": "none"
    //        //});
    //        document.getElementById('wifi_sign_in_out').style.display = 'block';
    //        document.getElementById('wifi_sign_in_out_address').innerHTML=current_address;
    //      }
    //      catch(e){
    //
    //      }
    //
    //    }
    //  });
    //}catch(e){
    //  console.log(e.message);
    //}







    $scope.redirect_to_approval = function(p_i,t_id,ty,is_process){
      if(ty=='100'){
        $location.path("home_page/ess_my_apply_details_content_fieldwork_atsignin/"+p_i+"/"+"my_apply"+"/"+t_id+"/"+"未完成"+"/"+is_process+"/at_sign_in");
      }

      else if(ty=='101'){
        $location.path("home_page/ess_my_apply_details_content_offic_work_out_atsignin/"+p_i+"/"+"my_apply"+"/"+t_id+"/"+"未完成"+"/"+is_process+"/at_sign_in");
      }


    }


    $scope.processing = 0;
    var process_counter = 0;
    clearTimeout(shake_process_timeout);


    $scope.shake_outer_div_click = function (){
		if (document.getElementById('atSignInNewCtrlSpinnerWarp').style.display == "block"){
			return;
		}

		  if ($scope.atSignInData.is_can_in == '0' && $scope.atSignInData.is_can_out == '1'){
			  $scope.reddi();
			return;
		  }

		/*
      if ($scope.atSignInData.is_can_in == '0'){
        return;
      }
	  */

      location_loading = false;
      wifi_loading = false;
      //atSignInNewSev.clearLocationErrorObjData();

        $(".atSignInNewCtrlSpinnerWarp").css({
          "display": "block"
        });



      var i=Math.round(Math.random()*9);
      $scope.at_sign_in_sucess_box_text_arr=['心情愉快，工作才能满状态','每次发奋的背后，必有加倍的赏赐','不积跬步无以至千里','有志者事竟成','业精于勤而荒于嬉','天道酬勤，宁静致远','耕耘于分秒，收获于细微','努力造就实力，态度决定高度','发光并非太阳的专利，你也能发光','天行健，君子以自强不息'];
      document.getElementById('at_sign_in_sucess_box_text').innerHTML=$scope.at_sign_in_sucess_box_text_arr[i];

      //document.getElementById("at_sign_in_new_wrap").style.height='202px';
      //document.getElementById("signindooricon").style.top='120px';
      //document.getElementById("at_sign_in_new_bg_2_div").style.webkitTransform='translate(66px,53px)';


		try {
			getLocation.checkCanLocation(
			  function(result) {
				if (result == 1) {
				  sign_in_preset();
				}
			  });
		} catch (e){
			console.log(e.message);
		}

    }

	function location_valid(source){

		/*
			var temp_gps_valid_mode = '';
			for (var i=0;i<$scope.atSignInData.setting_detail.length;i++){
				if ($scope.atSignInData.setting_detail[i].valid_mode == '2'){
					if (temp_gps_valid_mode == ''){
						temp_gps_valid_mode = '2';
					}
				}
				else if ($scope.atSignInData.setting_detail[i].valid_mode == '1,2'){
					temp_gps_valid_mode = '1,2';
				}
			}
			$scope.atSignInData.temp_gps_valid_mode = temp_gps_valid_mode;
		*/

              if ($scope.atSignInData.is_can_in== '1') {
                try {
                  location_loading = true;
				  if (source == 'reload'){
					  $(".atSignInNewCtrlSpinnerWarp").css({
						"display": "block"
					  });
				  }

                  getLocation.location(function (msg) {
                    try {

                        if (wifi_loading == false) {
							if (source == 'reload'){
							  $(".atSignInNewCtrlSpinnerWarp").css({
								"display": "none"
							  });
							}

                        }

					current_address = msg.address;
					current_latitude = msg.latitude;
					current_longitude = msg.longitude;
					address_city = msg.city;
					document.getElementById('wifi_sign_in_out').style.display = 'block';
					document.getElementById('wifi_sign_in_out_address').innerHTML = current_address;

					var longitude_end;
					var latitude_end;
					var longitude_begin;
					var latitude_begin;
					var loc_deviation;

					if ($scope.atSignInData.is_can_in == '1'){
						for (var i=0;i<$scope.atSignInData.setting_detail.length;i++){
							if ($scope.atSignInData.setting_detail[i].valid_mode == '1,2' || $scope.atSignInData.setting_detail[i].valid_mode == '2'){
								longitude_end = parseFloat($scope.atSignInData.setting_detail[i].longitude);
								latitude_end = parseFloat($scope.atSignInData.setting_detail[i].latitude);
								longitude_begin = parseFloat(current_longitude);
								latitude_begin = parseFloat(current_latitude);
								loc_deviation = get_two_place_differ_meter(longitude_begin, latitude_begin, longitude_end, latitude_end);
								if (parseFloat($scope.atSignInData.setting_detail[i].location_deviation)> loc_deviation) {
									$scope.atSignInData.setting_detail[i].gps_validate = true;
								}
							}
						}
						if (!wifi_loading) {
							validate_no_error = false;
							for (var i=0;i<$scope.atSignInData.setting_detail.length;i++){
								if ($scope.atSignInData.setting_detail[i].wifi_validate && $scope.atSignInData.setting_detail[i].gps_validate){
									validate_no_error = true;
									break;
								}
							}
							if ($scope.atSignInData.setting_detail.length != 0){
								if (validate_no_error){
									$timeout(function () {
										$scope.location_error_obj.sign_in_validate_no_error = true;
										$scope.location_error_obj.sign_in_validate_error = false;

									});
								}
								else {
									$timeout(function () {
										$scope.location_error_obj.sign_in_validate_no_error = false;
										$scope.location_error_obj.sign_in_validate_error = true;

									});
								}
							}

						}




					}

					  location_loading = false;
                    } catch (e) {
                    }
                  });

                } catch (e) {
                  console.log(e.message);
                }
              }
              else {

				for (var i=0;i<$scope.atSignInData.setting_detail.length;i++){
					if ($scope.atSignInData.setting_detail[i].wifi_validate && $scope.atSignInData.setting_detail[i].gps_validate){
						$timeout(function () {
						  $scope.location_error_obj.sign_in_validate_no_error = true;
						});
						break;
					}
				}

              }

	}


	function wifi_valid(source){

			var temp_wifi_valid_mode = '';
			for (var i=0;i<$scope.atSignInData.setting_detail.length;i++){
				if ($scope.atSignInData.setting_detail[i].valid_mode == '1'){
					if (temp_wifi_valid_mode == ''){
						temp_wifi_valid_mode = '1';
					}
				}
				else if ($scope.atSignInData.setting_detail[i].valid_mode == '1,2'){
					temp_wifi_valid_mode = '1,2';
				}
			}
			$scope.atSignInData.temp_wifi_valid_mode = temp_wifi_valid_mode;

			if (($scope.atSignInData.temp_wifi_valid_mode == '1,2' || $scope.atSignInData.temp_wifi_valid_mode == '1') && $scope.atSignInData.is_can_in == '1'){

                try {
                  wifi_loading = true;
				  if (source == 'reload'){
					  $(".atSignInNewCtrlSpinnerWarp").css({
						"display": "block"
					  });
				  }

                  network.wifiInfo(function (msg) {
                    try {
                        if (location_loading == false) {
							if (source == 'reload'){
								  $(".atSignInNewCtrlSpinnerWarp").css({
									"display": "none"
								  });
							}

                        }


                      if (msg.state == '-1'&&ionic.Platform.isIOS()) {
                        $ionicPopup.alert({
                          title: '提醒',
                          template: '<div style="text-align: center;">无法获取当前WiFi,请启动WIFI重试</div>',
                          okText: '确定'
                        });
                        return;
                      }

						if (typeof(msg.mac) == 'undefined'){
							msg.mac = '';
						}

						if (typeof(msg.wifiName) == 'undefined'){
							msg.wifiName = '';
						}

                      var wifi_arr1 = msg.wifiName.replace(/(.)(?=[^$])/g, "$1,").split(",");
                      var wifi_str = "";
                      for (var v = 0; v < wifi_arr1.length; v++) {
                        if (wifi_arr1[v] != '"') {
                          wifi_str = wifi_str + wifi_arr1[v];
                        }
                      }
                      document.getElementById("sign_in_wifi_name").value = wifi_str;
                      document.getElementById("sign_in_wifi_mac").value = msg.mac;

						for (var i=0;i<$scope.atSignInData.setting_detail.length;i++){
							if ($scope.atSignInData.setting_detail[i].valid_mode == '1,2' || $scope.atSignInData.setting_detail[i].valid_mode == '1'){
								if ($scope.atSignInData.setting_detail[i].wifi_mac == msg.mac) {
									$scope.atSignInData.setting_detail[i].wifi_validate = true;
								}
							}
						}
						if (!location_loading) {
							validate_no_error = false;
							for (var i=0;i<$scope.atSignInData.setting_detail.length;i++){
								if ($scope.atSignInData.setting_detail[i].wifi_validate && $scope.atSignInData.setting_detail[i].gps_validate){
									validate_no_error = true;
									break;
								}
							}

							if ($scope.atSignInData.setting_detail.length != 0){
								if (validate_no_error){
									$timeout(function () {
										$scope.location_error_obj.sign_in_validate_no_error = true;
										$scope.location_error_obj.sign_in_validate_error = false;

									});
								}
								else {
									$timeout(function () {
										$scope.location_error_obj.sign_in_validate_no_error = false;
										$scope.location_error_obj.sign_in_validate_error = true;

									});
								}
							}

						}


					  wifi_loading = false;
                    } catch (e) {

                    }

                  });
                } catch (e) {
                  console.log(e.message);

                }

			}
	}


    function sign_in_preset(){
      if ($scope.processing == 0){
        $scope.processing = 1;
        current_address = '';
        current_latitude = '';
        current_longitude = '';
        document.getElementById("sign_in_wifi_name").value = '';
        document.getElementById("sign_in_wifi_mac").value = '';


		document.getElementById('sign_in_validate_error').style.display = "none";
		document.getElementById('sign_in_validate_no_error').style.display = "none";
		document.getElementById('fufu_spinner_div').style.display = "none";
		$(".atSignInNewCtrlSpinnerWarp").css({
			"display": "block"
		});
        $rootScope.showLoading();
        $scope.location_and_wifi_valid('sign_in');
        shake_process();
      }

    }

    $scope.location_and_wifi_valid=function(source){
		if (source == 'reload'){
			atSignInNewSev.clearLocationErrorObjData();
		}

		for (var i=0;i<$scope.atSignInData.setting_detail.length;i++){
			if ($scope.atSignInData.setting_detail[i].valid_mode == '1,2'){
				$scope.atSignInData.setting_detail[i].wifi_validate = false;
				$scope.atSignInData.setting_detail[i].gps_validate = false;
			}
			else if ($scope.atSignInData.setting_detail[i].valid_mode == ''){
				$scope.atSignInData.setting_detail[i].wifi_validate = true;
				$scope.atSignInData.setting_detail[i].gps_validate = true;
			}
			else if ($scope.atSignInData.setting_detail[i].valid_mode == '1'){
				$scope.atSignInData.setting_detail[i].wifi_validate = false;
				$scope.atSignInData.setting_detail[i].gps_validate = true;
			}
			else if ($scope.atSignInData.setting_detail[i].valid_mode == '2'){
				$scope.atSignInData.setting_detail[i].wifi_validate = true;
				$scope.atSignInData.setting_detail[i].gps_validate = false;
			}
		}

      location_valid(source);
      wifi_valid(source);

    }
    function shake_process() {
      shake_process_timeout = setTimeout(shake_process, 100);
      process_counter = process_counter + 1;

	  /*
      if (process_counter == 100 || ($scope.atSignInData.valid_mode == '1,2' && current_address != '' && document.getElementById("sign_in_wifi_mac").value != '') ||
        ($scope.atSignInData.valid_mode == '1' && document.getElementById("sign_in_wifi_mac").value != '') ||
        ($scope.atSignInData.valid_mode == '2' && current_address != '') ||
        ($scope.atSignInData.valid_mode == '')
      ) {
		  */
      if (process_counter == 100 || (!wifi_loading && !location_loading)) {

        $rootScope.hideLoading();
        clearTimeout(shake_process_timeout);


        if (process_counter == 100) {

            $rootScope.hideLoading();
			$(".atSignInNewCtrlSpinnerWarp").css({
				"display": "none"
			});
			document.getElementById('sign_in_validate_error').style.display = "block";
			document.getElementById('sign_in_validate_no_error').style.display = "block";
          if (current_address == '') {
            $ionicPopup.alert({
              title: '提醒',
              template: '<div style="text-align: center;">获取定位信息失败，请重新打卡</div>',
              okText: '确定'
            }).then(function (res) {

            });
          }
          else if (document.getElementById("sign_in_wifi_mac").value == '' && ($scope.atSignInData.temp_wifi_valid_mode == '1,2' || $scope.atSignInData.temp_wifi_valid_mode == '1')) {
            $ionicPopup.alert({
              title: '提醒',
              template: '<div style="text-align: center;">获取Wifi信息失败，请重新打卡</div>',
              okText: '确定'
            }).then(function (res) {

            });
          }
        }
        else {

          atSignInNewSev.signInAction($scope, current_address, current_latitude, current_longitude);
        }
		$scope.processing = 0;
        process_counter = 0;

      }
    }



    $scope.remote_clock_pat=function(){
		if($scope.atSignInData.is_can_out=='1'){
			$location.path('home_page/remote_clock');
		}
		else{
			window.fufuMessageBox("当前设置不允许异地签到", fufu_message_box_duration, function() {});
		}

    }
    $scope.reddi = function () {
      if($scope.atSignInData.is_can_out=="1"){
        $ionicPopup.confirm({
          title:'',
          template: '<div style="overflow:hidden;border-radius:10px;padding-left:0px !important;padding-right:0px !important;"><div style="width:7.2rem;height:4.66666666666rem;"><img src='+local_resource + "img/icon/at_sign_in_new_sconfirm_icon.png"+' alt="" style="width:100%;height:4.66666667rem;"/></div> <div style="padding:20px;color:#000;font-size:0.4266666667rem;padding-bottom:0px;line-height:150%;">请您在规定范围内签到，也可以使用<span style="color:#53afff;">异地签到</span>继续签到</div></div>',
          cancelType: 'button-dark',
          cancelText: '取消',
          cssClass:'at_sign_in_new_popup',
          okText: '异地签到'
        }).then(function (res) {
          if (res) {
            $scope.processing = 0;
            $location.path('home_page/remote_clock');
          }

        });
        //document.getElementById("signinconfirm").style.display='block';
      }
      else{
        //$ionicPopup.alert({
        //  title: '提醒',
        //  template: '<div style="text-align: center;">未抵达内勤签到位置范围！</div>',
        //  okText: '确定'
        //}).then(function (res) {
        //
        //});
        window.fufuMessageBox("未抵达内勤签到位置范围", fufu_message_box_duration, function() {});

      }

      $scope.processing = 0;
    }

    if (ionic.Platform.isIOS()) {
      atSignInNewSev.loadData(current_date,false);
      $scope.atSignInData = atSignInNewSev.getData();
      $scope.display_time = atSignInNewSev.getDisplayTime();
    } else {
      $scope.$on("$ionicView.enter", function () {
        atSignInNewSev.loadData(current_date,false);
        $scope.atSignInData = atSignInNewSev.getData();
        $scope.display_time = atSignInNewSev.getDisplayTime();
      });
    }


    $scope.load_card_record = function () {
      atSignInNewSev.loadData(current_date,true);
    }

    $scope.sign_in_outdoor = function () {
      if($scope.atSignInData.can_fieldwork=="1"){
        $location.path('home_page/at_sign_in_outdoor');
      }
      else{
        //$ionicPopup.alert({
        //  title: '提醒',
        //  template: '<div style="text-align: center;">今天尚未申请外出</div>',
        //  okText: '确定'
        //}).then(function (res) {
        //
        //});
        window.fufuMessageBox("今天尚未申请外出", fufu_message_box_duration, function() {});
      }

      //$location.path('home_page/remote_clock');
    }




/*
    if ($scope.atSignInData.valid_mode == '1,2' || $scope.atSignInData.valid_mode == '1') {
      try {
        network.wifiInfo(function (msg) {
          try{
            if(msg.state=='-1'){
              $ionicPopup.alert(
                {
                  title: '提醒',
                  template: '<div style="text-align: center;">当前ios版本无法获取当前WiFi</div>',
                  okText: '确定'
                });
              return;
            }
            var wifi_arr1 = msg.wifiName.replace(/(.)(?=[^$])/g, "$1,").split(",");
            var wifi_str = "";
            for (var v = 0; v < wifi_arr1.length; v++) {
              if (wifi_arr1[v] != '"') {
                wifi_str = wifi_str + wifi_arr1[v];
              }
            }

            document.getElementById("sign_in_wifi_name").value = wifi_str;
            document.getElementById("sign_in_wifi_mac").value = msg.mac;

            if (typeof($scope.atSignInData.wifi_mac) != 'undefined') {

              if ($scope.atSignInData.mac == document.getElementById("sign_in_wifi_mac").value && ($scope.atSignInData.valid_mode == '1,2' || $scope.atSignInData.valid_mode == '1')) {

                document.getElementById("wifi_sign_in").style.display = "block";
              }
              else {
                document.getElementById("wifi_sign_in").style.display = "none";
              }
            }
          }
          catch(e){

          }
          //  alert(msg.mac);
        });
      }
      catch (e) {
        console.log(e.message);

      }
    }
    */
  })

  .controller('UseHelpCtrl',function($scope,UseHelpSev,$ionicModal,$ionicActionSheet,$location,timeSelect,sideSelect,$stateParams,$ionicScrollDelegate) {
    UseHelpSev.clearData();
    UseHelpSev.loadData('user_help');
    $scope.UseHelpData = UseHelpSev.getData();
    $scope.use_help_click=function(help_title_id,title){
      $location.path("home_page/use_help_details/"+help_title_id+"/"+title);
    }
  })
  .controller('UseHelpDetailCtrl',function($scope,UseHelpDetailSev,$ionicModal,$ionicActionSheet,$location,timeSelect,sideSelect,$stateParams,$ionicScrollDelegate) {
    $scope.use_help_detail_title=$stateParams.title;

    $scope.good=local_resource+'img/icon/good.png';
    $scope.good_done=local_resource+'img/icon/good_done.png';
    $scope.bad=local_resource+'img/icon/bad.png';
    $scope.bad_done=local_resource+'img/icon/bad_done.png';
    $scope.done_good=false;
    $scope.done_bad=false;
    UseHelpDetailSev.clearData();
    UseHelpDetailSev.loadData($stateParams.help_title_id);
    $scope.UseHelpDetailData = UseHelpDetailSev.getData();
	$scope.reload_data=function(){
	UseHelpDetailSev.loadData($stateParams.help_title_id);
	}
    $scope.good_click=function(){
      if($scope.UseHelpDetailData.opinion_text!=''){
        return;
      }
      else{

        UseHelpDetailSev.save($stateParams.help_title_id,'1',$scope);
      }

    }
    $scope.bad_click=function(){
      if($scope.UseHelpDetailData.opinion_text!=''){
        return;
      }
      else{

        UseHelpDetailSev.save($stateParams.help_title_id,'0',$scope);
      }


    }
  })

  .controller('bannerDetailCtrl',function($scope,UseHelpDetailSev,$ionicModal,$ionicActionSheet,$location,timeSelect,sideSelect,$stateParams,$ionicScrollDelegate) {
    $scope.banner_title=$stateParams.title;

    UseHelpDetailSev.clearData();
    UseHelpDetailSev.loadData($stateParams.help_title_id);
    $scope.UseHelpDetailData = UseHelpDetailSev.getData();

  })


  .controller('atSignInHistoryCtrl',function($timeout,$scope,UseHelpDetailSev,$ionicModal,$ionicActionSheet,$location,timeSelect,sideSelect,$stateParams,$ionicScrollDelegate,$ionicViewSwitcher,$ionicHistory,atSignInHistorySev) {
    $scope.at_sign_in_history_circle1 = local_resource+'img/icon/at_sign_in_history_circle1.png';
    $scope.at_sign_in_history_circle2 = local_resource+'img/icon/at_sign_in_history_circle2.png';
	$scope.at_sign_in_history_circle0 = local_resource+'img/icon/at_sign_in_history_circle0.png';

    $scope.at_sign_in_history_circle3 = local_resource+'img/icon/at_sign_in_history_circle3.png';
    $scope.img_circle6 = local_resource+'img/icon/circle6.png';
    $scope.on_holiday = local_resource+'img/icon/on_holiday.png';
    $scope.icon_no_clockDate = local_resource+'img/icon/icon_no_clockDate.png';
    $scope.at_sign_in_history_address_icon = local_resource+'img/icon/at_sign_in_history_address_icon.png';
    $scope.at_sign_in_history_wifi_icon = local_resource+'img/icon/at_sign_in_history_wifi_icon.png';
    //$ionicViewSwitcher.nextDirection('back');
	var at_sign_in_new_data_str = '';
	var current_date = new Date();
	var temp_date = new Date();
	current_date.setDate(current_date.getDate() - 1);
	temp_date.setDate(temp_date.getDate() - 1);
    $scope.$on("$ionicView.enter", function () {
		  document.getElementById('at_sign_in_history_header').style.display = "block";
		  document.getElementById('sign_in_history_content').style.display = "block";
      //$("#at_sign_in_new_data").html((current_date.getFullYear() + '-' + (current_date.getMonth() + 1 < 10 ? '0' + (current_date.getMonth() + 1): (current_date.getMonth() + 1)) + '-' + (current_date.getDate() < 10 ? '0' + (current_date.getDate()): (current_date.getDate())))+'<i class="icon ion-ios-arrow-down" style="margin-top:-10px;  line-height:18px;vertical-align:middle;font-size:18px;color:white;line-height:14px;text-indent:10px;position:relative;top:-2px;"></i>');
	  if (current_date.getMonth() + 1 < 10){
	      $("#at_sign_in_new_data").html(current_date.getFullYear() + '年0' + (current_date.getMonth() + 1) + '月');
	  }
	  else {
	      $("#at_sign_in_new_data").html(current_date.getFullYear() + '年' + (current_date.getMonth() + 1) + '月');
	  }
      document.getElementById("at_sign_in_new_data").onclick=function(){
		  return;
        timeSelect.show({
          type :  'date' ,
          startDate :  '1900-01-01',
          endDate : '2099-12-31',
          defaultDate:     (current_date.getFullYear() + '-' + (current_date.getMonth() + 1 < 10 ? '0' + (current_date.getMonth() + 1): (current_date.getMonth() + 1)) + '-' + (current_date.getDate() < 10 ? '0' + (current_date.getDate()): (current_date.getDate()))),
          returnDateType : 'y-m-d',
          returnTimeType :  '24h'||'AMPM',
          //stepping :10,
          selectedFunc : function (date) {
            if (typeof(date) != 'undefined'){
              current_date.setFullYear(date.split('-')[0],(parseInt(date.split('-')[1],10)-1),date.split('-')[2]);
              $("#at_sign_in_new_data").html((current_date.getFullYear() + '-' + (current_date.getMonth() + 1 < 10 ? '0' + (current_date.getMonth() + 1): (current_date.getMonth() + 1)) + '-' + (current_date.getDate() < 10 ? '0' + (current_date.getDate()): (current_date.getDate())))+'<i class="icon ion-ios-arrow-down" style="margin-top:-10px;  line-height:18px;vertical-align:middle;font-size:18px;color:white;line-height:14px;text-indent:10px;position:relative;top:-2px;"></i>')
              atSignInHistorySev.loadData((current_date.getFullYear() + '-' + (current_date.getMonth() + 1 < 10 ? '0' + (current_date.getMonth() + 1): (current_date.getMonth() + 1)) + '-' + (current_date.getDate() < 10 ? '0' + (current_date.getDate()): (current_date.getDate()))));
              if (current_mode == 'minimize'){
                fill_minimize_mode_calendar ('initialize');
              }
              else {
                fill_maximize_mode_calendar ('initialize');
              }
            }
          }
        });
      }

      document.getElementById("atSignInHistoryBack").onclick= function(){
        $ionicViewSwitcher.nextDirection('forward');
        $ionicHistory.goBack();
      }

		fill_minimize_mode_calendar('initialize');
		/*
        //解决 进入明细页面back回来的时候 会再次loaddata
        if (typeof($scope.data_loaded) != 'undefined') {
          return;
        }
        else {
          $scope.data_loaded = true;
        }
		*/

        atSignInHistorySev.loadData((current_date.getFullYear() + '-' + (current_date.getMonth() + 1 < 10 ? '0' + (current_date.getMonth() + 1): (current_date.getMonth() + 1)) + '-' + (current_date.getDate() < 10 ? '0' + (current_date.getDate()): (current_date.getDate()))));
        $scope.atSignInHistoryData = atSignInHistorySev.getData();
    });
    $scope.redirect_to_approval = function(p_i,t_id,ty,is_process){
      if(ty=='100'){
        $location.path("home_page/ess_my_apply_details_content_fieldwork_atsignin/"+p_i+"/"+"my_apply"+"/"+t_id+"/"+"未完成"+"/"+is_process+"/at_sign_in");
      }
      else if(ty=='101'){
        $location.path("home_page/ess_my_apply_details_content_offic_work_out_atsignin/"+p_i+"/"+"my_apply"+"/"+t_id+"/"+"未完成"+"/"+is_process+"/at_sign_in");
      }
    }

    var paging_in_progress = false;
    var current_mode = 'minimize';
    var today_date = new Date();
    var today_date_str = (today_date.getFullYear() + '-' + (today_date.getMonth() + 1 < 10 ? '0' + (today_date.getMonth() + 1): (today_date.getMonth() + 1)) + '-' + (today_date.getDate() < 10 ? '0' + (today_date.getDate()): (today_date.getDate())));

	/*
    if (ionic.Platform.isIOS()) {
      var current_date = new Date();
      var temp_date = new Date();
      current_date.setDate(current_date.getDate() - 1);
      temp_date.setDate(temp_date.getDate() - 1);
      atSignInHistorySev.loadData((current_date.getFullYear() + '-' + (current_date.getMonth() + 1 < 10 ? '0' + (current_date.getMonth() + 1): (current_date.getMonth() + 1)) + '-' + (current_date.getDate() < 10 ? '0' + (current_date.getDate()): (current_date.getDate()))));
      $scope.atSignInHistoryData = atSignInHistorySev.getData();
    } else {
    }
	*/




    //atSignInHistorySev.loadData((current_date.getFullYear() + '-' + (current_date.getMonth() + 1 < 10 ? '0' + (current_date.getMonth() + 1): (current_date.getMonth() + 1)) + '-' + (current_date.getDate() < 10 ? '0' + (current_date.getDate()): (current_date.getDate()))));
    //$scope.atSignInHistoryData = atSignInHistorySev.getData();
    $scope.select_date = function(dom_id){
      if(document.getElementById("atSignInHistoryCtrlSpinner").style.display=='block'){
        return;
      }
      $("#atSignInHistoryContent").css({
        'opacity':'0'
      });
      $("#atSignInHistoryCtrlSpinner").css({
        'display':'block'
      })
	if (paging_in_progress){
	return;
	}
	var new_date = document.getElementById(dom_id).getAttribute('date');
	current_date.setFullYear(new_date.split('-')[0],(parseInt(new_date.split('-')[1],10)-1),new_date.split('-')[2]);
	//$("#at_sign_in_new_data").html((current_date.getFullYear() + '-' + (current_date.getMonth() + 1 < 10 ? '0' + (current_date.getMonth() + 1): (current_date.getMonth() + 1)) + '-' + (current_date.getDate() < 10 ? '0' + (current_date.getDate()): (current_date.getDate())))+'<i class="icon ion-ios-arrow-down" style="margin-top:-10px;  line-height:18px;vertical-align:middle;font-size:18px;color:white;line-height:14px;text-indent:10px;position:relative;top:-2px;"></i>');
	  if (current_date.getMonth() + 1 < 10){
	      $("#at_sign_in_new_data").html(current_date.getFullYear() + '年0' + (current_date.getMonth() + 1) + '月');
	  }
	  else {
	      $("#at_sign_in_new_data").html(current_date.getFullYear() + '年' + (current_date.getMonth() + 1) + '月');
	  }
	atSignInHistorySev.loadData((current_date.getFullYear() + '-' + (current_date.getMonth() + 1 < 10 ? '0' + (current_date.getMonth() + 1): (current_date.getMonth() + 1)) + '-' + (current_date.getDate() < 10 ? '0' + (current_date.getDate()): (current_date.getDate()))));

	if (current_mode == 'maximize'){
		$scope.calendar_week_minimize();
		//fill_maximize_mode_calendar('initialize');
	}
	else if (current_mode == 'minimize'){
		fill_minimize_mode_calendar('initialize');
		$timeout(function(){
			$ionicScrollDelegate.scrollTop();
		},50);
	}



	  /*
      for (var k=0;k<3;k++){
        for (var j=0;j<6;j++){
          for (var i=0;i<7;i++){
            document.getElementById('calendar_' + (k+1) + '_' + (j+1) + '_' + (i + 1)).style.background = "none";
            document.getElementById('calendar_' + (k+1) + '_' + (j+1) + '_' + (i + 1)).style.color = "#ffffff";

            //if (i == 6 || i == 0){
            //  document.getElementById('calendar_' + (k+1) + '_' + (j+1) + '_' + (i + 1)).style.opacity = '0.6';
            //}
            //else {
            //  document.getElementById('calendar_' + (k+1) + '_' + (j+1) + '_' + (i + 1)).style.opacity = '1';
            //}

            if (document.getElementById('calendar_' + (k+1) + '_' + (j+1) + '_' + (i + 1)).getAttribute('date') == today_date_str && new_date != today_date_str){
              document.getElementById('calendar_' + (k+1) + '_' + (j+1) + '_' + (i + 1)).style.border = '1px #fff solid';
              document.getElementById('calendar_' + (k+1) + '_' + (j+1) + '_' + (i + 1)).style.lineHeight = '18px';
            }
            else {
              document.getElementById('calendar_' + (k+1) + '_' + (j+1) + '_' + (i + 1)).style.border = 'none';
              document.getElementById('calendar_' + (k+1) + '_' + (j+1) + '_' + (i + 1)).style.lineHeight = '20px';
            }
          }
        }
      }

      document.getElementById(dom_id).style.background = "#ffffff";
      document.getElementById(dom_id).style.color = "#53afff";
      document.getElementById(dom_id).style.opacity = '1';
		*/
    }


    function clear_calendar_highlight(){
      for (var j=0;j<6;j++){
        for (var i=0;i<7;i++){
          document.getElementById('calendar_2' + '_' + (j+1) + '_' + (i + 1)).style.background = "none";
          document.getElementById('calendar_2' + '_' + (j+1) + '_' + (i + 1)).style.color = "#ffffff";
		  document.getElementById('calendar_2' + '_' + (j+1) + '_' + (i + 1)).style.border = 'none';
		  document.getElementById('calendar_2' + '_' + (j+1) + '_' + (i + 1)).style.lineHeight = '20px';
		  /*
          if (i == 6 || i == 0){
            document.getElementById('calendar_2' + '_' + (j+1) + '_' + (i + 1)).style.opacity = '0.6';
          }
		  */
		  document.getElementById('calendar_2' + '_' + (j+1) + '_' + (i + 1)).style.opacity = '1';
        }
      }

    }

    function fill_minimize_mode_calendar (mode){

		 var current_date_json;
      if (mode == 'initialize'){
        current_date_json = (current_date.getFullYear() + '-' + (current_date.getMonth() + 1 < 10 ? '0' + (current_date.getMonth() + 1): (current_date.getMonth() + 1)) + '-' + (current_date.getDate() < 10 ? '0' + (current_date.getDate()): (current_date.getDate())));
		if (parseInt(current_date_json.split('-')[1],10) < 10){
		  $("#at_sign_in_new_data").html(current_date_json.split('-')[0] + '年0' + (parseInt(current_date_json.split('-')[1],10)) + '月');
		}
		else {
		  $("#at_sign_in_new_data").html(current_date_json.split('-')[0] + '年' + (parseInt(current_date_json.split('-')[1],10)) + '月');
		}
        temp_date.setFullYear(current_date_json.split('-')[0],(parseInt(current_date_json.split('-')[1],10)-1),current_date_json.split('-')[2]);
        temp_date.setDate(temp_date.getDate() - 7);
      }
      else if (mode == 'previous'){
        current_date_json = document.getElementById('calendar_1_1_1').getAttribute('date');
		if (parseInt(current_date_json.split('-')[1],10) < 10){
		  $("#at_sign_in_new_data").html(current_date_json.split('-')[0] + '年0' + (parseInt(current_date_json.split('-')[1],10)) + '月');
		}
		else {
		  $("#at_sign_in_new_data").html(current_date_json.split('-')[0] + '年' + (parseInt(current_date_json.split('-')[1],10)) + '月');
		}
        temp_date.setFullYear(current_date_json.split('-')[0],(parseInt(current_date_json.split('-')[1],10)-1),current_date_json.split('-')[2]);
        temp_date.setDate(temp_date.getDate() - 7);
      }
      else if (mode == 'next'){
        current_date_json = document.getElementById('calendar_3_1_1').getAttribute('date');
		if (parseInt(current_date_json.split('-')[1],10) < 10){
		  $("#at_sign_in_new_data").html(current_date_json.split('-')[0] + '年0' + (parseInt(current_date_json.split('-')[1],10)) + '月');
		}
		else {
		  $("#at_sign_in_new_data").html(current_date_json.split('-')[0] + '年' + (parseInt(current_date_json.split('-')[1],10)) + '月');
		}
        temp_date.setFullYear(current_date_json.split('-')[0],(parseInt(current_date_json.split('-')[1],10)-1),current_date_json.split('-')[2]);
        temp_date.setDate(temp_date.getDate() - 7);
      }

      for (var i=0;i<7;i++){
        document.getElementById('calendar_1_1_' + (temp_date.getDay() + 1)).innerHTML = temp_date.getDate();
        document.getElementById('calendar_1_1_' + (temp_date.getDay() + 1)).setAttribute('date',(temp_date.getFullYear() + '-' + (temp_date.getMonth() + 1 < 10 ? '0' + (temp_date.getMonth() + 1): (temp_date.getMonth() + 1)) + '-' + (temp_date.getDate() < 10 ? '0' + (temp_date.getDate()): (temp_date.getDate()))));
        if (document.getElementById('calendar_1_1_' + (temp_date.getDay() + 1)).getAttribute('date') == (current_date.getFullYear() + '-' + (current_date.getMonth() + 1 < 10 ? '0' + (current_date.getMonth() + 1): (current_date.getMonth() + 1)) + '-' + (current_date.getDate() < 10 ? '0' + (current_date.getDate()): (current_date.getDate())))){
          document.getElementById('calendar_1_1_' + (temp_date.getDay() + 1)).style.background = "#ffffff";
          document.getElementById('calendar_1_1_' + (temp_date.getDay() + 1)).style.color = "#53afff";
          document.getElementById('calendar_1_1_' + (temp_date.getDay() + 1)).style.opacity = '1';
        }
        else {
          document.getElementById('calendar_1_1_' + (temp_date.getDay() + 1)).style.background = "none";
          document.getElementById('calendar_1_1_' + (temp_date.getDay() + 1)).style.color = "#ffffff";
		  /*
          if (temp_date.getDay() == 6 || temp_date.getDay() == 0){
            document.getElementById('calendar_1_1_' + (temp_date.getDay() + 1)).style.opacity = '0.6';
          }
		  */
          document.getElementById('calendar_1_1_' + (temp_date.getDay() + 1)).style.opacity = '1';
        }
        if (document.getElementById('calendar_1_1_' + (temp_date.getDay() + 1)).getAttribute('date') == today_date_str && (document.getElementById('calendar_1_1_' + (temp_date.getDay() + 1)).getAttribute('date') == (current_date.getFullYear() + '-' + (current_date.getMonth() + 1 < 10 ? '0' + (current_date.getMonth() + 1): (current_date.getMonth() + 1)) + '-' + (current_date.getDate() < 10 ? '0' + (current_date.getDate()): (current_date.getDate()))) != today_date_str)){
          document.getElementById('calendar_1_1_' + (temp_date.getDay() + 1)).style.border = '1px #fff solid';
          document.getElementById('calendar_1_1_' + (temp_date.getDay() + 1)).style.lineHeight = '18px';
        }
        else {
          document.getElementById('calendar_1_1_' + (temp_date.getDay() + 1)).style.border = 'none';
          document.getElementById('calendar_1_1_' + (temp_date.getDay() + 1)).style.lineHeight = '20px';
        }

        temp_date.setDate(temp_date.getDate() + 1);
        if (temp_date.getDay() == 0){
          temp_date.setDate(temp_date.getDate() - 7);
        }
      }
      temp_date.setDate(temp_date.getDate() + 7);
      for (var i=0;i<7;i++){
        document.getElementById('calendar_2_1_' + (temp_date.getDay() + 1)).innerHTML = temp_date.getDate();
        document.getElementById('calendar_2_1_' + (temp_date.getDay() + 1)).setAttribute('date',(temp_date.getFullYear() + '-' + (temp_date.getMonth() + 1 < 10 ? '0' + (temp_date.getMonth() + 1): (temp_date.getMonth() + 1)) + '-' + (temp_date.getDate() < 10 ? '0' + (temp_date.getDate()): (temp_date.getDate()))));
        if (document.getElementById('calendar_2_1_' + (temp_date.getDay() + 1)).getAttribute('date') == (current_date.getFullYear() + '-' + (current_date.getMonth() + 1 < 10 ? '0' + (current_date.getMonth() + 1): (current_date.getMonth() + 1)) + '-' + (current_date.getDate() < 10 ? '0' + (current_date.getDate()): (current_date.getDate())))){
          document.getElementById('calendar_2_1_' + (temp_date.getDay() + 1)).style.background = "#ffffff";
          document.getElementById('calendar_2_1_' + (temp_date.getDay() + 1)).style.color = "#53afff";
          document.getElementById('calendar_2_1_' + (temp_date.getDay() + 1)).style.opacity = '1';
        }
        else {
          document.getElementById('calendar_2_1_' + (temp_date.getDay() + 1)).style.background = "none";
          document.getElementById('calendar_2_1_' + (temp_date.getDay() + 1)).style.color = "#ffffff";
		  /*
          if (temp_date.getDay() == 6 || temp_date.getDay() == 0){
            document.getElementById('calendar_2_1_' + (temp_date.getDay() + 1)).style.opacity = '0.6';
          }
		  */
          document.getElementById('calendar_2_1_' + (temp_date.getDay() + 1)).style.opacity = '1';
        }
        if (document.getElementById('calendar_2_1_' + (temp_date.getDay() + 1)).getAttribute('date') == today_date_str && (document.getElementById('calendar_2_1_' + (temp_date.getDay() + 1)).getAttribute('date') == (current_date.getFullYear() + '-' + (current_date.getMonth() + 1 < 10 ? '0' + (current_date.getMonth() + 1): (current_date.getMonth() + 1)) + '-' + (current_date.getDate() < 10 ? '0' + (current_date.getDate()): (current_date.getDate()))) != today_date_str)){
          document.getElementById('calendar_2_1_' + (temp_date.getDay() + 1)).style.border = '1px #fff solid';
          document.getElementById('calendar_2_1_' + (temp_date.getDay() + 1)).style.lineHeight = '18px';
        }
        else {
          document.getElementById('calendar_2_1_' + (temp_date.getDay() + 1)).style.border = 'none';
          document.getElementById('calendar_2_1_' + (temp_date.getDay() + 1)).style.lineHeight = '20px';
        }
        temp_date.setDate(temp_date.getDate() + 1);
        if (temp_date.getDay() == 0){
          temp_date.setDate(temp_date.getDate() - 7);
        }
      }
      temp_date.setDate(temp_date.getDate() + 7);
      for (var i=0;i<7;i++){
        document.getElementById('calendar_3_1_' + (temp_date.getDay() + 1)).innerHTML = temp_date.getDate();
        document.getElementById('calendar_3_1_' + (temp_date.getDay() + 1)).setAttribute('date',(temp_date.getFullYear() + '-' + (temp_date.getMonth() + 1 < 10 ? '0' + (temp_date.getMonth() + 1): (temp_date.getMonth() + 1)) + '-' + (temp_date.getDate() < 10 ? '0' + (temp_date.getDate()): (temp_date.getDate()))));
        if (document.getElementById('calendar_3_1_' + (temp_date.getDay() + 1)).getAttribute('date') == (current_date.getFullYear() + '-' + (current_date.getMonth() + 1 < 10 ? '0' + (current_date.getMonth() + 1): (current_date.getMonth() + 1)) + '-' + (current_date.getDate() < 10 ? '0' + (current_date.getDate()): (current_date.getDate())))){
          document.getElementById('calendar_3_1_' + (temp_date.getDay() + 1)).style.background = "#ffffff";
          document.getElementById('calendar_3_1_' + (temp_date.getDay() + 1)).style.color = "#53afff";
          document.getElementById('calendar_3_1_' + (temp_date.getDay() + 1)).style.opacity = '1';
        }
        else {
          document.getElementById('calendar_3_1_' + (temp_date.getDay() + 1)).style.background = "none";
          document.getElementById('calendar_3_1_' + (temp_date.getDay() + 1)).style.color = "#ffffff";
		  /*
          if (temp_date.getDay() == 6 || temp_date.getDay() == 0){
            document.getElementById('calendar_3_1_' + (temp_date.getDay() + 1)).style.opacity = '0.6';
          }
		  */
          document.getElementById('calendar_3_1_' + (temp_date.getDay() + 1)).style.opacity = '1';
        }
        if (document.getElementById('calendar_3_1_' + (temp_date.getDay() + 1)).getAttribute('date') == today_date_str && (document.getElementById('calendar_3_1_' + (temp_date.getDay() + 1)).getAttribute('date') == (current_date.getFullYear() + '-' + (current_date.getMonth() + 1 < 10 ? '0' + (current_date.getMonth() + 1): (current_date.getMonth() + 1)) + '-' + (current_date.getDate() < 10 ? '0' + (current_date.getDate()): (current_date.getDate()))) != today_date_str)){
          document.getElementById('calendar_3_1_' + (temp_date.getDay() + 1)).style.border = '1px #fff solid';
          document.getElementById('calendar_3_1_' + (temp_date.getDay() + 1)).style.lineHeight = '18px';
        }
        else {
          document.getElementById('calendar_3_1_' + (temp_date.getDay() + 1)).style.border = 'none';
          document.getElementById('calendar_3_1_' + (temp_date.getDay() + 1)).style.lineHeight = '20px';
        }
        temp_date.setDate(temp_date.getDate() + 1);
        if (temp_date.getDay() == 0){
          temp_date.setDate(temp_date.getDate() - 7);
        }
      }
      temp_date.setDate(temp_date.getDate() - 7);

    }


    function fill_maximize_mode_calendar(mode){
		var current_date_json;
      if (mode == 'initialize'){
        current_date_json = (current_date.getFullYear() + '-' + (current_date.getMonth() + 1 < 10 ? '0' + (current_date.getMonth() + 1): (current_date.getMonth() + 1)) + '-' + (current_date.getDate() < 10 ? '0' + (current_date.getDate()): (current_date.getDate())));
		if (parseInt(current_date_json.split('-')[1],10) < 10){
		  $("#at_sign_in_new_data").html(current_date_json.split('-')[0] + '年0' + (parseInt(current_date_json.split('-')[1],10)) + '月');
		}
		else {
		  $("#at_sign_in_new_data").html(current_date_json.split('-')[0] + '年' + (parseInt(current_date_json.split('-')[1],10)) + '月');
		}
        temp_date.setFullYear(current_date_json.split('-')[0],(parseInt(current_date_json.split('-')[1],10)-1),1);
        temp_date.setMonth(temp_date.getMonth() - 1);
      }
      else if (mode == 'previous'){
        current_date_json = document.getElementById('calendar_1_3_3').getAttribute('date');
		if (parseInt(current_date_json.split('-')[1],10) < 10){
		  $("#at_sign_in_new_data").html(current_date_json.split('-')[0] + '年0' + (parseInt(current_date_json.split('-')[1],10)) + '月');
		}
		else {
		  $("#at_sign_in_new_data").html(current_date_json.split('-')[0] + '年' + (parseInt(current_date_json.split('-')[1],10)) + '月');
		}
        temp_date.setFullYear(current_date_json.split('-')[0],(parseInt(current_date_json.split('-')[1],10)-1),1);
        temp_date.setMonth(temp_date.getMonth() - 1);
      }
      else if (mode == 'next'){
        current_date_json = document.getElementById('calendar_3_3_3').getAttribute('date');
		if (parseInt(current_date_json.split('-')[1],10) < 10){
		  $("#at_sign_in_new_data").html(current_date_json.split('-')[0] + '年0' + (parseInt(current_date_json.split('-')[1],10)) + '月');
		}
		else {
		  $("#at_sign_in_new_data").html(current_date_json.split('-')[0] + '年' + (parseInt(current_date_json.split('-')[1],10)) + '月');
		}
        temp_date.setFullYear(current_date_json.split('-')[0],(parseInt(current_date_json.split('-')[1],10)-1),1);
        temp_date.setMonth(temp_date.getMonth() - 1);
      }

      for (var j=0;j<6;j++){
        for (var i=0;i<7;i++){
          document.getElementById('calendar_1_' + (j+1) + '_' + (temp_date.getDay() + 1)).innerHTML = temp_date.getDate();
          document.getElementById('calendar_1_' + (j+1) + '_' + (temp_date.getDay() + 1)).setAttribute('date',(temp_date.getFullYear() + '-' + (temp_date.getMonth() + 1 < 10 ? '0' + (temp_date.getMonth() + 1): (temp_date.getMonth() + 1)) + '-' + (temp_date.getDate() < 10 ? '0' + (temp_date.getDate()): (temp_date.getDate()))));
          if (document.getElementById('calendar_1_' + (j+1) + '_' + (temp_date.getDay() + 1)).getAttribute('date') == (current_date.getFullYear() + '-' + (current_date.getMonth() + 1 < 10 ? '0' + (current_date.getMonth() + 1): (current_date.getMonth() + 1)) + '-' + (current_date.getDate() < 10 ? '0' + (current_date.getDate()): (current_date.getDate())))){
            document.getElementById('calendar_1_' + (j+1) + '_' + (temp_date.getDay() + 1)).style.background = "#ffffff";
            document.getElementById('calendar_1_' + (j+1) + '_' + (temp_date.getDay() + 1)).style.color = "#53afff";
            document.getElementById('calendar_1_' + (j+1) + '_' + (temp_date.getDay() + 1)).style.opacity = '1';
          }
          else {
            document.getElementById('calendar_1_' + (j+1) + '_' + (temp_date.getDay() + 1)).style.background = "none";
            document.getElementById('calendar_1_' + (j+1) + '_' + (temp_date.getDay() + 1)).style.color = "#ffffff";
			if (j == 0 && temp_date.getDate() > 7){
				document.getElementById('calendar_1_' + (j+1) + '_' + (temp_date.getDay() + 1)).style.opacity = '0.6';
			}
			else if ((j == 4 || j == 5) && temp_date.getDate() < 15){
				document.getElementById('calendar_1_' + (j+1) + '_' + (temp_date.getDay() + 1)).style.opacity = '0.6';
			}
			else {
				document.getElementById('calendar_1_' + (j+1) + '_' + (temp_date.getDay() + 1)).style.opacity = '1';
			}
			/*
            if (temp_date.getDay() == 6 || temp_date.getDay() == 0){
              document.getElementById('calendar_1_' + (j+1) + '_' + (temp_date.getDay() + 1)).style.opacity = '0.6';
            }
			*/
          }
          if (document.getElementById('calendar_1_' + (j+1) + '_' + (temp_date.getDay() + 1)).getAttribute('date') == today_date_str && (document.getElementById('calendar_1_' + (j+1) + '_' + (temp_date.getDay() + 1)).getAttribute('date') == (current_date.getFullYear() + '-' + (current_date.getMonth() + 1 < 10 ? '0' + (current_date.getMonth() + 1): (current_date.getMonth() + 1)) + '-' + (current_date.getDate() < 10 ? '0' + (current_date.getDate()): (current_date.getDate()))) != today_date_str)){
            document.getElementById('calendar_1_' + (j+1) + '_' + (temp_date.getDay() + 1)).style.border = '1px #fff solid';
            document.getElementById('calendar_1_' + (j+1) + '_' + (temp_date.getDay() + 1)).style.lineHeight = '18px';
          }
          else {
            document.getElementById('calendar_1_' + (j+1) + '_' + (temp_date.getDay() + 1)).style.border = 'none';
            document.getElementById('calendar_1_' + (j+1) + '_' + (temp_date.getDay() + 1)).style.lineHeight = '20px';
          }
          temp_date.setDate(temp_date.getDate() + 1);
          if (temp_date.getDay() == 0){
            temp_date.setDate(temp_date.getDate() - 7);
          }
        }
        temp_date.setDate(temp_date.getDate() + 7);
      }

      temp_date.setFullYear(current_date_json.split('-')[0],(parseInt(current_date_json.split('-')[1],10)-1),1);
      temp_date.setMonth(temp_date.getMonth());

      for (var j=0;j<6;j++){
        for (var i=0;i<7;i++){
          document.getElementById('calendar_2_' + (j+1) + '_' + (temp_date.getDay() + 1)).innerHTML = temp_date.getDate();
          document.getElementById('calendar_2_' + (j+1) + '_' + (temp_date.getDay() + 1)).setAttribute('date',(temp_date.getFullYear() + '-' + (temp_date.getMonth() + 1 < 10 ? '0' + (temp_date.getMonth() + 1): (temp_date.getMonth() + 1)) + '-' + (temp_date.getDate() < 10 ? '0' + (temp_date.getDate()): (temp_date.getDate()))));

          if (document.getElementById('calendar_2_' + (j+1) + '_' + (temp_date.getDay() + 1)).getAttribute('date') == (current_date.getFullYear() + '-' + (current_date.getMonth() + 1 < 10 ? '0' + (current_date.getMonth() + 1): (current_date.getMonth() + 1)) + '-' + (current_date.getDate() < 10 ? '0' + (current_date.getDate()): (current_date.getDate())))){
            document.getElementById('calendar_2_' + (j+1) + '_' + (temp_date.getDay() + 1)).style.background = "#ffffff";
            document.getElementById('calendar_2_' + (j+1) + '_' + (temp_date.getDay() + 1)).style.color = "#53afff";
            document.getElementById('calendar_2_' + (j+1) + '_' + (temp_date.getDay() + 1)).style.opacity = '1';
          }
          else {
            document.getElementById('calendar_2_' + (j+1) + '_' + (temp_date.getDay() + 1)).style.background = "none";
            document.getElementById('calendar_2_' + (j+1) + '_' + (temp_date.getDay() + 1)).style.color = "#ffffff";
			/*
            if (temp_date.getDay() == 6 || temp_date.getDay() == 0){
              document.getElementById('calendar_2_' + (j+1) + '_' + (temp_date.getDay() + 1)).style.opacity = '0.6';
            }
			*/
			if (j == 0 && temp_date.getDate() > 7){
				document.getElementById('calendar_2_' + (j+1) + '_' + (temp_date.getDay() + 1)).style.opacity = '0.6';
			}
			else if ((j == 4 || j == 5) && temp_date.getDate() < 15){
				document.getElementById('calendar_2_' + (j+1) + '_' + (temp_date.getDay() + 1)).style.opacity = '0.6';
			}
			else {
				document.getElementById('calendar_2_' + (j+1) + '_' + (temp_date.getDay() + 1)).style.opacity = '1';
			}
          }
          if (document.getElementById('calendar_2_' + (j+1) + '_' + (temp_date.getDay() + 1)).getAttribute('date') == today_date_str && (document.getElementById('calendar_2_' + (j+1) + '_' + (temp_date.getDay() + 1)).getAttribute('date') == (current_date.getFullYear() + '-' + (current_date.getMonth() + 1 < 10 ? '0' + (current_date.getMonth() + 1): (current_date.getMonth() + 1)) + '-' + (current_date.getDate() < 10 ? '0' + (current_date.getDate()): (current_date.getDate()))) != today_date_str)){
            document.getElementById('calendar_2_' + (j+1) + '_' + (temp_date.getDay() + 1)).style.border = '1px #fff solid';
            document.getElementById('calendar_2_' + (j+1) + '_' + (temp_date.getDay() + 1)).style.lineHeight = '18px';
          }
          else {
            document.getElementById('calendar_2_' + (j+1) + '_' + (temp_date.getDay() + 1)).style.border = 'none';
            document.getElementById('calendar_2_' + (j+1) + '_' + (temp_date.getDay() + 1)).style.lineHeight = '20px';
          }
          temp_date.setDate(temp_date.getDate() + 1);
          if (temp_date.getDay() == 0){
            temp_date.setDate(temp_date.getDate() - 7);
          }
        }
        temp_date.setDate(temp_date.getDate() + 7);
      }

      temp_date.setFullYear(current_date_json.split('-')[0],(parseInt(current_date_json.split('-')[1],10)-1),1);
      temp_date.setMonth(temp_date.getMonth() + 1);

      for (var j=0;j<6;j++){
        for (var i=0;i<7;i++){
          document.getElementById('calendar_3_' + (j+1) + '_' + (temp_date.getDay() + 1)).innerHTML = temp_date.getDate();
          document.getElementById('calendar_3_' + (j+1) + '_' + (temp_date.getDay() + 1)).setAttribute('date',(temp_date.getFullYear() + '-' + (temp_date.getMonth() + 1 < 10 ? '0' + (temp_date.getMonth() + 1): (temp_date.getMonth() + 1)) + '-' + (temp_date.getDate() < 10 ? '0' + (temp_date.getDate()): (temp_date.getDate()))));

          if (document.getElementById('calendar_3_' + (j+1) + '_' + (temp_date.getDay() + 1)).getAttribute('date') == (current_date.getFullYear() + '-' + (current_date.getMonth() + 1 < 10 ? '0' + (current_date.getMonth() + 1): (current_date.getMonth() + 1)) + '-' + (current_date.getDate() < 10 ? '0' + (current_date.getDate()): (current_date.getDate())))){
            document.getElementById('calendar_3_' + (j+1) + '_' + (temp_date.getDay() + 1)).style.background = "#ffffff";
            document.getElementById('calendar_3_' + (j+1) + '_' + (temp_date.getDay() + 1)).style.color = "#53afff";
            document.getElementById('calendar_3_' + (j+1) + '_' + (temp_date.getDay() + 1)).style.opacity = '1';
          }
          else {
            document.getElementById('calendar_3_' + (j+1) + '_' + (temp_date.getDay() + 1)).style.background = "none";
            document.getElementById('calendar_3_' + (j+1) + '_' + (temp_date.getDay() + 1)).style.color = "#ffffff";
			/*
            if (temp_date.getDay() == 6 || temp_date.getDay() == 0){
              document.getElementById('calendar_3_' + (j+1) + '_' + (temp_date.getDay() + 1)).style.opacity = '0.6';
            }
			*/
			if (j == 0 && temp_date.getDate() > 7){
				document.getElementById('calendar_3_' + (j+1) + '_' + (temp_date.getDay() + 1)).style.opacity = '0.6';
			}
			else if ((j == 4 || j == 5) && temp_date.getDate() < 15){
				document.getElementById('calendar_3_' + (j+1) + '_' + (temp_date.getDay() + 1)).style.opacity = '0.6';
			}
			else {
				document.getElementById('calendar_3_' + (j+1) + '_' + (temp_date.getDay() + 1)).style.opacity = '1';
			}
          }
          if (document.getElementById('calendar_3_' + (j+1) + '_' + (temp_date.getDay() + 1)).getAttribute('date') == today_date_str && (document.getElementById('calendar_3_' + (j+1) + '_' + (temp_date.getDay() + 1)).getAttribute('date') == (current_date.getFullYear() + '-' + (current_date.getMonth() + 1 < 10 ? '0' + (current_date.getMonth() + 1): (current_date.getMonth() + 1)) + '-' + (current_date.getDate() < 10 ? '0' + (current_date.getDate()): (current_date.getDate()))) != today_date_str)){
            document.getElementById('calendar_3_' + (j+1) + '_' + (temp_date.getDay() + 1)).style.border = '1px #fff solid';
            document.getElementById('calendar_3_' + (j+1) + '_' + (temp_date.getDay() + 1)).style.lineHeight = '18px';
          }
          else {
            document.getElementById('calendar_3_' + (j+1) + '_' + (temp_date.getDay() + 1)).style.border = 'none';
            document.getElementById('calendar_3_' + (j+1) + '_' + (temp_date.getDay() + 1)).style.lineHeight = '20px';
          }
          temp_date.setDate(temp_date.getDate() + 1);
          if (temp_date.getDay() == 0){
            temp_date.setDate(temp_date.getDate() - 7);
          }
        }
        temp_date.setDate(temp_date.getDate() + 7);
      }


    }

    $scope.calendar_week_next_page = function(){
      if (paging_in_progress){
        return;
      }
      paging_in_progress = true;
      var translateX=-33.3333;
      document.getElementById('calendar_translate_div').style.transition='all 0.5s linear';
      document.getElementById('calendar_translate_div').style.webkitTransition='all 0.5s linear';
      translateX=translateX-33.3333;
      document.getElementById('calendar_translate_div').style.webkitTransform='translateX('+translateX+'%)';
      document.getElementById('calendar_translate_div').style.webkitTransform='translateX('+translateX+'%)';
      setTimeout(function(){
        translateX=translateX+33.3333;
        document.getElementById('calendar_translate_div').style.transition='';
        document.getElementById('calendar_translate_div').style.webkitTransition='';
        document.getElementById('calendar_translate_div').style.webkitTransform='translateX('+translateX+'%)';
        document.getElementById('calendar_translate_div').style.webkitTransform='translateX('+translateX+'%)';
        if (current_mode == 'minimize'){
          fill_minimize_mode_calendar('next');
        }
        else if (current_mode == 'maximize'){
          fill_maximize_mode_calendar('next');
        }
        //paging_in_progress = false;
      }, 600);

      setTimeout(function(){
        paging_in_progress = false;
      }, 700);
    }

    $scope.calendar_week_prev_page = function(){
      if (paging_in_progress){
        return;
      }
      paging_in_progress = true;
      var translateX=-33.3333;
      document.getElementById('calendar_translate_div').style.transition='all 0.5s linear';
      document.getElementById('calendar_translate_div').style.webkitTransition='all 0.5s linear';
      translateX=translateX+33.3333;
      document.getElementById('calendar_translate_div').style.webkitTransform='translateX('+translateX+'%)';
      document.getElementById('calendar_translate_div').style.webkitTransform='translateX('+translateX+'%)';
      setTimeout(function(){
        translateX=translateX-33.3333;
        document.getElementById('calendar_translate_div').style.transition='';
        document.getElementById('calendar_translate_div').style.webkitTransition='';
        document.getElementById('calendar_translate_div').style.webkitTransform='translateX('+translateX+'%)';
        document.getElementById('calendar_translate_div').style.webkitTransform='translateX('+translateX+'%)';
        if (current_mode == 'minimize'){
          fill_minimize_mode_calendar('previous');
        }
        else if (current_mode == 'maximize'){
          fill_maximize_mode_calendar('previous');
        }
        //paging_in_progress = false;
      }, 600);

	  setTimeout(function(){
        paging_in_progress = false;
      }, 700);
    }

    $scope.calendar_week_minimize = function(){

      if (paging_in_progress || current_mode == 'minimize'){
        return;
      }

      paging_in_progress = true;

      $ionicScrollDelegate.scrollTop();

      var style_top_value;
      var animate_duration = 0.2;
      if (ionic.Platform.isIOS()) {
        style_top_value = '136px';
      }
      else {
        style_top_value = '116px';
      }

      clear_calendar_highlight();
      fill_minimize_mode_calendar('initialize');

      setTimeout(function(){
        paging_in_progress = false;
        current_mode = 'minimize';
      }, animate_duration * 1000);

      TweenMax.to(document.getElementById('sign_in_history_calendar_wrapper'),animate_duration,{
        //webkitTransform:'translateY(-180px)',
        height:'74px',
        //background:'#53afff',
        //ease:Linear.easeInOut,
        autoRound:false,
        force3D:true
      });

      TweenMax.to(document.getElementById('sign_in_history_content'),animate_duration,{
        top:style_top_value,
        autoRound:false,
        force3D:true
        //ease:Linear.easeInOut
      });

    }

    $scope.calendar_week_maximize = function(){
      if (paging_in_progress || current_mode == 'maximize'){
        return;
      }
      paging_in_progress = true;

      $ionicScrollDelegate.scrollTop();

      var style_top_value;
      var animate_duration = 0.2;

      if (ionic.Platform.isIOS()) {
        style_top_value = '316px';
      }
      else {
        style_top_value = '296px';
      }

      fill_maximize_mode_calendar('initialize');

      setTimeout(function(){
        paging_in_progress = false;
        current_mode = 'maximize';
      }, animate_duration * 1000);
      TweenMax.to(document.getElementById('sign_in_history_calendar_wrapper'),animate_duration,{
        //webkitTransform:'translateY(0px)',
        height:'254px',
        //background:'-webkit-gradient(linear, left top, left bottom, color-stop(0%,#53afff), color-stop(100%,#74dafd))',
        autoRound:false,
        force3D:true
      });

      TweenMax.to(document.getElementById('sign_in_history_content'),animate_duration,{
        top:style_top_value,
        autoRound:false,
        force3D:true
      });


    }

    $scope.show_datepicker = function(){
      timeSelect.show({
        type :  'date' ,
        startDate :  '1900-01-01',
        endDate : '2099-12-31',
        defaultDate:     (current_date.getFullYear() + '-' + (current_date.getMonth() + 1 < 10 ? '0' + (current_date.getMonth() + 1): (current_date.getMonth() + 1)) + '-' + (current_date.getDate() < 10 ? '0' + (current_date.getDate()): (current_date.getDate()))),
        returnDateType : 'y-m-d',
        returnTimeType :  '24h'||'AMPM',
        //stepping :10,
        selectedFunc : function (date) {
          if (typeof(date) != 'undefined'){
            current_date.setFullYear(date.split('-')[0],(parseInt(date.split('-')[1],10)-1),date.split('-')[2]);
            if (current_mode == 'minimize'){
              fill_minimize_mode_calendar ('initialize');
            }
            else {
              fill_maximize_mode_calendar ('initialize');
            }
          }
        }
      });
    }
  })

.controller('atHomeNewCtrl',function($ionicPopup,$scope,atHomeNewSev,$stateParams,$ionicNavBarDelegate,$ionicHistory,zoomSlider,$rootScope,$ionicNavBarDelegate,atHomeSev,$ionicScrollDelegate,$timeout,timeSelect,$ionicSlideBoxDelegate,atSignInHistorySev,atHomeSev,$ionicViewSwitcher,$location){
	fufuMobclickAgent('menu_at_home');
    $scope.css_width=((document.body.scrollWidth -84)/7) +"px";
    $scope.css_half_width=((document.body.scrollWidth -10)/7-10)*0.5+"px";
	$scope.wrap_height= ((document.body.scrollWidth - 84)/7 + 35 )+ 'px';
	$scope.content_position_top_ios= ((document.body.scrollWidth - 84)/7 + 105 )+'px';
	//alert((((document.body.scrollWidth -84)/7)+6) *6);

	$scope.content_position_top_android= ((document.body.scrollWidth - 84)/7 + 85 )+'px';
	$scope.header_bar_height=((document.body.scrollWidth - 84)/7 + 12)*7+ 15 +'px';
	$scope.calendar_wrapper_height=((document.body.scrollWidth - 84)/7 + 15)*6 +'px';

    $scope.at_sign_in_history_circle1 = local_resource+'img/icon/at_sign_in_history_circle1.png';
    $scope.at_sign_in_history_circle2 = local_resource+'img/icon/at_sign_in_history_circle2.png';
    $scope.at_sign_in_history_circle3 = local_resource+'img/icon/at_sign_in_history_circle3.png';
    $scope.img_circle6 = local_resource+'img/icon/circle6.png';
    $scope.on_holiday = local_resource+'img/icon/on_holiday.png';
    $scope.home_at_wait_approv_icon = local_resource+'img/icon/home_at_wait_approv_icon.png';
	$scope.home_at_wait_approv_icon_new = local_resource+'img/icon/home_at_wait_approv_icon_new.png';
	$scope.home_at_wait_noapprov_icon_new = local_resource+'img/icon/home_at_wait_noapprov_icon_new.png';
    $scope.at_sign_in_history_address_icon = local_resource+'img/icon/at_sign_in_history_address_icon.png';
    $scope.at_sign_in_history_wifi_icon = local_resource+'img/icon/at_sign_in_history_wifi_icon.png';
    var at_sign_in_new_data_str = '';
    var maximize_tween1;
    var maximize_tween2;
    var minimize_tween1;
    var minimize_tween2;

    $scope.dot_normal = local_resource + 'img/icon/dot_normal.png';
    $scope.dot_abnormal = local_resource + 'img/icon/dot_abnormal.png';
    $scope.Legal_holiday = local_resource + 'img/icon/Legal_holiday.png';
    $scope.other_holiday = local_resource + 'img/icon/other_holiday.png';
    $scope.no_approve_bg= local_resource+'img/icon/home_at_wait_approv_bg.png';
    $scope.img_exit_trial_login = local_resource + 'img/icon/exit_trial_login.png';
	$scope.normal_time = local_resource + 'img/icon/normal_time.png';
	$scope.time_icon = local_resource + 'img/icon/time_icon.png';
	$scope.contract_management_directory1 = local_resource + 'img/icon/contract_management_directory1.png';
	$scope.at_home_times_icon = local_resource + 'img/icon/at_home_times_icon.png';
	$scope.at_home_red_line = local_resource + 'img/icon/at_home_red_line.png';
	$scope.at_home_red_line_new = local_resource + 'img/icon/at_home_red_line_new.png';
	$scope.ot_time = local_resource + 'img/icon/ot_time.png';
	$scope.at_home_wait_approv_icon = local_resource + 'img/icon/at_home_wait_approv_icon.png';
	$scope.at_home_approved_new_icon = local_resource + 'img/icon/at_home_approved_new_icon.png';
	$scope.no_policy_photo = local_resource + 'img/icon/no_policy_photo.png';
	$scope.icon_no_clockDate = local_resource+'img/icon/icon_no_clockDate.png';

   if (window.localStorage["is_free_trial_login"] != null && typeof(window.localStorage["is_free_trial_login"]) != 'undefined' && window.localStorage["is_free_trial_login"] != '') {
      document.getElementById("home_at_is_trial_login").style.display='block';
    }
    else {
      document.getElementById("home_at_is_trial_login").style.display='none';
    }

	$scope.at_month_report = function(){
		$location.path('home_page/home_menulist/at_month_report');
	}

	window.at_month_report=function(){
	//	$location.path('home_page/home_menulist/at_month_report');
	window.location.href='#/home_page/home_menulist/at_month_report';
	}
	$scope.card_record_adj_apply = function(){
		$location.path('home_page/home_menulist/card_record_adj_apply/' + (current_date.getFullYear() + '-' + (current_date.getMonth() + 1 < 10 ? '0' + (current_date.getMonth() + 1): (current_date.getMonth() + 1)) + '-' + (current_date.getDate() < 10 ? '0' + (current_date.getDate()): (current_date.getDate()))));
	}

    $scope.free_trial_log_out = function () {
      $ionicPopup.confirm({
        title: '退出登录',
        template: '<div style="text-align: center;">是否退出系统?</div>',
        cancelType: 'button-dark',
        cancelText: '取消',
        okText: '确定'
      }).then(function (res) {
        if (res) {
          //$rootScope.showLoading();
          $.ajax({
            type: "GET",
            url: window.localStorage['_remote_server_addr'] + '?event=ionicAction.ionicAction.doLogout',
            timeout: _var_timeout,
            success: function (data) {
              $rootScope.hideLoading();
            },
            error: function (data) {
              $rootScope.hideLoading();
              /*
               $ionicPopup.alert({
               title : '提醒',
               template : '<div style="text-align: center;">'+fufu_network_error_msg+'</div>',
               okText : '确定'
               });
               */
            }
          });
          $ionicHistory.clearCache();
          $ionicHistory.clearHistory();
          window.localStorage['_pass_word'] = '';
          window.localStorage['_is_login'] = 0;
          if (window.localStorage["menu_list"] != null && typeof(window.localStorage["menu_list"]) != 'undefined' && window.localStorage["menu_list"] != '') {
            var model_list = window.localStorage["menu_list"].split(',');
            for (var i = 0; i < model_list.length; i++) {
              if (model_list[i] != '') {
                window.localStorage[model_list[i]] = '';
              }
            }
          }
          window.localStorage["menu_list"] = '';
          window.localStorage["menu_home"] = '';
          window.localStorage["menu_message"] = '';
          window.localStorage["menu_organization_management"] = '';
          window.localStorage["menu_time"] = '';
          window.localStorage["menu_payroll"] = '';
          window.localStorage["menu_ess"] = '';
          window.localStorage["menu_My_Team"] = '';
          window.localStorage["menu_setting"] = '';
          window.localStorage["personnal_data"] = '';
          window.localStorage['is_free_trial_login'] = '';
          login_init_flag = 0;
          $location.path('/');

        }
      });
    }


      $scope.time_of_out=function(){
        $("#time_of_out").css({
          "color":"#53afff",
          "borderTop":"1px solid #53afff",
          "backgroundColor":"white"
        });
        $("#times_of_in").css({
          "color":"#333",
          "borderTop":"1px solid #eeeeee",
          "backgroundColor":"#f5f5f5"
        });
        $("#home_at_tab_content").css({
          "-webkit-webkitTransform":"translateX(0)"
        });


        //document.getElementById('home_at_tab_content').style.overflow="visible";
        document.getElementById('home_at_tab1_div').style.display="block";
        document.getElementById('home_at_tab2_div').style.display="none";
        //$timeout(function(){ $ionicScrollDelegate.resize();
        //  document.getElementById('home_at_tab_content').style.overflow="hidden";
       // }, 200);
      }
      $scope.times_of_in=function(){
        $("#times_of_in").css({
          "color":"#53afff",
          "borderTop":"1px solid #53afff",
          "backgroundColor":"white"
        })
        $("#time_of_out").css({
          "color":"#333",
          "borderTop":"1px solid #eeeeee",
          "backgroundColor":"#f5f5f5"
        })
        $("#home_at_tab_content").css({
          "-webkit-webkitTransform":"translateX(-50%)"
        })

        /*document.getElementById('home_at_tab_content').style.overflow="visible";
        document.getElementById('home_at_tab2_div').setAttribute("style","width:50%;float:right");
        document.getElementById('home_at_tab1_div').setAttribute("style","width: 50%;position: absolute;left:0;top:0px;");
        $timeout(function(){ $ionicScrollDelegate.resize();
          document.getElementById('home_at_tab_content').style.overflow="hidden";
        }, 200);
		*/
        document.getElementById('home_at_tab1_div').style.display="none";
        document.getElementById('home_at_tab2_div').style.display="block";
      }

	  $scope.path_wait_approve_content=function(){
		var p_inst = $scope.atHomeResultData.process_instance;
		var task_id = $scope.atHomeResultData.task_id;
		var s_t = '未完成';
		var show_type = 'my_apply';

		$location.path("home_page/ess_my_card_adj_apply_details_content_from_at/"+p_inst+"/"+show_type+"/"+task_id+"/"+s_t+"/at");
	  }
	  $scope.path_approved_content=function(){
		var p_inst = $scope.atHomeResultData.process_instance;
		var task_id = $scope.atHomeResultData.task_id;
		var s_t = '已完成';
		var show_type = 'my_apply';

		$location.path("home_page/ess_my_card_adj_apply_details_content_from_at/"+p_inst+"/"+show_type+"/"+task_id+"/"+s_t+"/at");
	  }

    $scope.$on("$ionicView.enter", function () {
		document.getElementById("at_home_navbar_right").src=local_resource + 'img/icon/at_home_navbar_right.png';
      document.getElementById("at_home_navbar_right").onclick=function(){


	  }
	  //$("#at_home_date").html((current_date.getFullYear() + '-' + (current_date.getMonth() + 1 < 10 ? '0' + (current_date.getMonth() + 1): (current_date.getMonth() + 1)) + '-' + (current_date.getDate() < 10 ? '0' + (current_date.getDate()): (current_date.getDate())))+'<i class="icon ion-ios-arrow-down" style="margin-top:-10px;  line-height:18px;vertical-align:middle;font-size:18px;color:white;line-height:14px;text-indent:10px;position:relative;top:-2px;"></i>');
      if (current_date.getMonth() + 1 < 10){
        $("#at_home_date").html(current_date.getFullYear() + '年0' + (current_date.getMonth() + 1) + '月');
      }
      else {
        $("#at_home_date").html(current_date.getFullYear() + '年' + (current_date.getMonth() + 1) + '月');
      }

      //document.getElementById('at_home_calendar_next').onclick = function (){
      //	$scope.calendar_week_next_page();
      //}
      //
      //document.getElementById('at_home_calendar_prev').onclick = function (){
      //	$scope.calendar_week_prev_page();
      //}
      //

    });

    /*
     $scope.contentOnScroll = function(){
     if ($scope.current_scroll_position < $ionicScrollDelegate.getScrollPosition().top){
     console.log ('calendar_week_minimize:' + $ionicScrollDelegate.getScrollPosition().top);
     //maximize_tween1.kill();
     //maximize_tween2.kill();
     if (typeof (maximize_tween1) != 'undefined'){
     maximize_tween1.kill();
     maximize_tween2.kill();
     current_mode = 'interrupted';
     }
     $scope.calendar_week_minimize();

     }
     else if ($scope.current_scroll_position > $ionicScrollDelegate.getScrollPosition().top){
     console.log ('calendar_week_maximize:' + $ionicScrollDelegate.getScrollPosition().top);
     //minimize_tween1.kill();
     //minimize_tween2.kill();
     if (typeof (minimize_tween1) != 'undefined'){
     minimize_tween1.kill();
     minimize_tween2.kill();
     current_mode = 'interrupted';
     }
     $scope.calendar_week_maximize();
     }

     if ($ionicScrollDelegate.getScrollPosition().top > 0) {
     $scope.current_scroll_position = $ionicScrollDelegate.getScrollPosition().top;
     }
     }
     */


    var paging_in_progress = false;
    var current_mode = 'minimize';
    var today_date = new Date();
    var today_date_str = (today_date.getFullYear() + '-' + (today_date.getMonth() + 1 < 10 ? '0' + (today_date.getMonth() + 1): (today_date.getMonth() + 1)) + '-' + (today_date.getDate() < 10 ? '0' + (today_date.getDate()): (today_date.getDate())));
	$scope.today_str= today_date_str.split("-")[0]+'年'+today_date_str.split("-")[1]+'月'+today_date_str.split("-")[2]+'日';
    var current_date = new Date();
    var temp_date = new Date();
    //current_date.setDate(current_date.getDate() - 1);
    //temp_date.setDate(temp_date.getDate() - 1);
    //alert((current_date.getFullYear() + '-' + (current_date.getMonth() + 1 < 10 ? '0' + (current_date.getMonth() + 1): (current_date.getMonth() + 1)) + '-' + (current_date.getDate() < 10 ? '0' + (current_date.getDate()): (current_date.getDate()))));
    atHomeSev.loadData((current_date.getFullYear() + '-' + (current_date.getMonth() + 1 < 10 ? '0' + (current_date.getMonth() + 1): (current_date.getMonth() + 1)) + '-' + (current_date.getDate() < 10 ? '0' + (current_date.getDate()): (current_date.getDate()))),$scope,'initialize_minimize');
    $scope.atHomeCalendarData = atHomeSev.getData();
	$scope.atHomeResultData = atHomeSev.getResultData();
    $scope.paging_in_progress = false;


    $scope.select_date = function(dom_id){

      if ($scope.paging_in_progress){
        return;
      }

      var new_date = document.getElementById(dom_id).getAttribute('date');




	  if (parseInt(new_date.split("-")[0],10) !=  parseInt($("#at_home_date").html().substr(0,4),10) || parseInt(new_date.split("-")[1],10) !=  parseInt($("#at_home_date").html().substr(5,2),10)){
		  if (current_mode == 'maximize'){
			return;
		  }
	  }

	  $scope.today_str= new_date.split("-")[0]+'年'+new_date.split("-")[1]+'月'+new_date.split("-")[2]+'日';

      current_date.setFullYear(new_date.split('-')[0],(parseInt(new_date.split('-')[1],10)-1),new_date.split('-')[2]);
      //$("#at_home_date").html((current_date.getFullYear() + '-' + (current_date.getMonth() + 1 < 10 ? '0' + (current_date.getMonth() + 1): (current_date.getMonth() + 1)) + '-' + (current_date.getDate() < 10 ? '0' + (current_date.getDate()): (current_date.getDate())))+'<i class="icon ion-ios-arrow-down" style="margin-top:-10px;  line-height:18px;vertical-align:middle;font-size:18px;color:white;line-height:14px;text-indent:10px;position:relative;top:-2px;"></i>');
      if (current_date.getMonth() + 1 < 10){
        $("#at_home_date").html(current_date.getFullYear() + '年0' + (current_date.getMonth() + 1) + '月');
      }
      else {
        $("#at_home_date").html(current_date.getFullYear() + '年' + (current_date.getMonth() + 1) + '月');
      }


      if (current_mode == 'minimize'){
        atHomeSev.loadData((current_date.getFullYear() + '-' + (current_date.getMonth() + 1 < 10 ? '0' + (current_date.getMonth() + 1): (current_date.getMonth() + 1)) + '-' + (current_date.getDate() < 10 ? '0' + (current_date.getDate()): (current_date.getDate()))),$scope,'date_select_minimize');
		atHomeSev.loadResultData((current_date.getFullYear() + '-' + (current_date.getMonth() + 1 < 10 ? '0' + (current_date.getMonth() + 1): (current_date.getMonth() + 1)) + '-' + (current_date.getDate() < 10 ? '0' + (current_date.getDate()): (current_date.getDate()))));
      }
      else {
        atHomeSev.loadData((current_date.getFullYear() + '-' + (current_date.getMonth() + 1 < 10 ? '0' + (current_date.getMonth() + 1): (current_date.getMonth() + 1)) + '-' + (current_date.getDate() < 10 ? '0' + (current_date.getDate()): (current_date.getDate()))),$scope,'date_select_maximize');
		atHomeSev.loadResultData((current_date.getFullYear() + '-' + (current_date.getMonth() + 1 < 10 ? '0' + (current_date.getMonth() + 1): (current_date.getMonth() + 1)) + '-' + (current_date.getDate() < 10 ? '0' + (current_date.getDate()): (current_date.getDate()))));

      }

    }


    function clear_calendar_highlight(){
      for (var j=0;j<6;j++){
        for (var i=0;i<7;i++){
          document.getElementById('at_calendar_2' + '_' + (j+1) + '_' + (i + 1)).parentNode.style.background = "none";
          document.getElementById('at_calendar_2' + '_' + (j+1) + '_' + (i + 1)).style.color = "#999";
          document.getElementById('at_calendar_2' + '_' + (j+1) + '_' + (i + 1)).style.border = 'none';
          //document.getElementById('at_calendar_2' + '_' + (j+1) + '_' + (i + 1)).style.lineHeight = '20px';

          document.getElementById('at_calendar_2' + '_' + (j+1) + '_' + (i + 1)).style.opacity = '1';
		   document.getElementById('at_calendar_img_icon_2' + '_' + (j+1) + '_' + (i + 1)).style.opacity = '1';
		   document.getElementById('at_calendar_img_icon2_2' + '_' + (j+1) + '_' + (i + 1)).style.opacity = '1';
		  //document.getElementById('at_calendar_dot_2' + '_' + (j+1) + '_' + (i + 1)).style.opacity = '1';
		  document.getElementById('at_calendar_text_2' + '_' + (j+1) + '_' + (i + 1)).style.opacity = '1';
        }
      }

    }

    $scope.fill_minimize_mode_calendar = function(mode){

      var current_date_json;
      if (mode == 'initialize'){
        current_date_json = (current_date.getFullYear() + '-' + (current_date.getMonth() + 1 < 10 ? '0' + (current_date.getMonth() + 1): (current_date.getMonth() + 1)) + '-' + (current_date.getDate() < 10 ? '0' + (current_date.getDate()): (current_date.getDate())));
        if (parseInt(current_date_json.split('-')[1],10) < 10){
          $("#at_home_date").html(current_date_json.split('-')[0] + '年0' + (parseInt(current_date_json.split('-')[1],10)) + '月');
        }
        else {
          $("#at_home_date").html(current_date_json.split('-')[0] + '年' + (parseInt(current_date_json.split('-')[1],10)) + '月');
        }
        temp_date.setFullYear(current_date_json.split('-')[0],(parseInt(current_date_json.split('-')[1],10)-1),current_date_json.split('-')[2]);
        temp_date.setDate(temp_date.getDate() - 7);
      }
      else if (mode == 'previous'){
        current_date_json = document.getElementById('at_calendar_1_1_1').getAttribute('date');
        if (parseInt(current_date_json.split('-')[1],10) < 10){
          $("#at_home_date").html(current_date_json.split('-')[0] + '年0' + (parseInt(current_date_json.split('-')[1],10)) + '月');
        }
        else {
          $("#at_home_date").html(current_date_json.split('-')[0] + '年' + (parseInt(current_date_json.split('-')[1],10)) + '月');
        }
        temp_date.setFullYear(current_date_json.split('-')[0],(parseInt(current_date_json.split('-')[1],10)-1),current_date_json.split('-')[2]);
        temp_date.setDate(temp_date.getDate() - 7);
      }
      else if (mode == 'next'){
        current_date_json = document.getElementById('at_calendar_3_1_1').getAttribute('date');
        if (parseInt(current_date_json.split('-')[1],10) < 10){
          $("#at_home_date").html(current_date_json.split('-')[0] + '年0' + (parseInt(current_date_json.split('-')[1],10)) + '月');
        }
        else {
          $("#at_home_date").html(current_date_json.split('-')[0] + '年' + (parseInt(current_date_json.split('-')[1],10)) + '月');
        }
        temp_date.setFullYear(current_date_json.split('-')[0],(parseInt(current_date_json.split('-')[1],10)-1),current_date_json.split('-')[2]);
        temp_date.setDate(temp_date.getDate() - 7);
      }



      for (var i=0;i<7;i++){
        document.getElementById('at_calendar_1_1_' + (temp_date.getDay() + 1)).innerHTML = temp_date.getDate();
        document.getElementById('at_calendar_1_1_' + (temp_date.getDay() + 1)).setAttribute('date',(temp_date.getFullYear() + '-' + (temp_date.getMonth() + 1 < 10 ? '0' + (temp_date.getMonth() + 1): (temp_date.getMonth() + 1)) + '-' + (temp_date.getDate() < 10 ? '0' + (temp_date.getDate()): (temp_date.getDate()))));
        if (document.getElementById('at_calendar_1_1_' + (temp_date.getDay() + 1)).getAttribute('date') == (current_date.getFullYear() + '-' + (current_date.getMonth() + 1 < 10 ? '0' + (current_date.getMonth() + 1): (current_date.getMonth() + 1)) + '-' + (current_date.getDate() < 10 ? '0' + (current_date.getDate()): (current_date.getDate())))){
          document.getElementById('at_calendar_1_1_' + (temp_date.getDay() + 1)).style.background = "#53afff";
          document.getElementById('at_calendar_1_1_' + (temp_date.getDay() + 1)).style.color = "#999";
          document.getElementById('at_calendar_1_1_' + (temp_date.getDay() + 1)).style.opacity = '1';
        }
        else {
          //document.getElementById('at_calendar_1_1_' + (temp_date.getDay() + 1)).style.background = "none";
          document.getElementById('at_calendar_1_1_' + (temp_date.getDay() + 1)).style.color = "#999";

          document.getElementById('at_calendar_1_1_' + (temp_date.getDay() + 1)).style.opacity = '1';
        }
        if (document.getElementById('at_calendar_1_1_' + (temp_date.getDay() + 1)).getAttribute('date') == today_date_str && (document.getElementById('at_calendar_1_1_' + (temp_date.getDay() + 1)).getAttribute('date') == (current_date.getFullYear() + '-' + (current_date.getMonth() + 1 < 10 ? '0' + (current_date.getMonth() + 1): (current_date.getMonth() + 1)) + '-' + (current_date.getDate() < 10 ? '0' + (current_date.getDate()): (current_date.getDate()))) != today_date_str)){
          document.getElementById('at_calendar_1_1_' + (temp_date.getDay() + 1)).style.border = '1px #fff #53afff';
          document.getElementById('at_calendar_1_1_' + (temp_date.getDay() + 1)).style.lineHeight = '18px';
        }
        else {
         // document.getElementById('at_calendar_1_1_' + (temp_date.getDay() + 1)).style.border = 'none';
          document.getElementById('at_calendar_1_1_' + (temp_date.getDay() + 1)).style.lineHeight = '20px';
        }

        temp_date.setDate(temp_date.getDate() + 1);
        if (temp_date.getDay() == 0){
          temp_date.setDate(temp_date.getDate() - 7);
        }
      }
      temp_date.setDate(temp_date.getDate() + 7);

      for (var i=0;i<7;i++){
        document.getElementById('at_calendar_2_1_' + (temp_date.getDay() + 1)).innerHTML = temp_date.getDate();
        document.getElementById('at_calendar_2_1_' + (temp_date.getDay() + 1)).setAttribute('date',(temp_date.getFullYear() + '-' + (temp_date.getMonth() + 1 < 10 ? '0' + (temp_date.getMonth() + 1): (temp_date.getMonth() + 1)) + '-' + (temp_date.getDate() < 10 ? '0' + (temp_date.getDate()): (temp_date.getDate()))));

        if (document.getElementById('at_calendar_2_1_' + (temp_date.getDay() + 1)).getAttribute('date') == (current_date.getFullYear() + '-' + (current_date.getMonth() + 1 < 10 ? '0' + (current_date.getMonth() + 1): (current_date.getMonth() + 1)) + '-' + (current_date.getDate() < 10 ? '0' + (current_date.getDate()): (current_date.getDate())))){

            document.getElementById('at_calendar_2_1_' + (temp_date.getDay() + 1)).parentNode.style.background = "#ff3b30";
			//document.getElementById('at_calendar_2_1_' + (temp_date.getDay() + 1)).style.backgroundImage = "";
			//document.getElementById('at_calendar_img_icon_2_1_' + (temp_date.getDay() + 1)).style.display = "none";
			//document.getElementById('at_calendar_dot_2_1_' + (temp_date.getDay() + 1)).style.display = "none";
			//document.getElementById('at_calendar_2_1_' + (temp_date.getDay() + 1)).style.border = 'none';
            document.getElementById('at_calendar_2_1_' + (temp_date.getDay() + 1)).style.color = "white";

			document.getElementById('at_calendar_text_2_1_' + (temp_date.getDay() + 1)).style.color = "white";
            document.getElementById('at_calendar_2_1_' + (temp_date.getDay() + 1)).style.opacity = '1';
			document.getElementById('at_calendar_text_2_1_' + (temp_date.getDay() + 1)).style.opacity = '1';
			//document.getElementById('at_calendar_img_icon_2_1' + (temp_date.getDay() + 1)).style.opacity = '1';
			//document.getElementById('at_calendar_img_icon2_2_1' + (temp_date.getDay() + 1)).style.opacity = '1';
			//document.getElementById('at_calendar_dot_2_1_' + (temp_date.getDay() + 1)).style.opacity = '1';

        }
        else {
          document.getElementById('at_calendar_2_1_' + (temp_date.getDay() + 1)).parentNode.style.background = "none";
          //document.getElementById('at_calendar_2_1_' + (temp_date.getDay() + 1)).style.color = "#333";
          document.getElementById('at_calendar_text_2_1_' + (temp_date.getDay() + 1)).style.color = "#999";
          document.getElementById('at_calendar_2_1_' + (temp_date.getDay() + 1)).style.opacity = '1';

        }
        if (document.getElementById('at_calendar_2_1_' + (temp_date.getDay() + 1)).getAttribute('date') == today_date_str && (document.getElementById('at_calendar_2_1_' + (temp_date.getDay() + 1)).getAttribute('date') != (current_date.getFullYear() + '-' + (current_date.getMonth() + 1 < 10 ? '0' + (current_date.getMonth() + 1): (current_date.getMonth() + 1)) + '-' + (current_date.getDate() < 10 ? '0' + (current_date.getDate()): (current_date.getDate()))))){

          //document.getElementById('at_calendar_2_1_' + (temp_date.getDay() + 1)).style.border = '1px #fa0100 solid';
          //document.getElementById('at_calendar_2_1_' + (temp_date.getDay() + 1)).style.lineHeight = '18px';
			document.getElementById('at_calendar_2_1_' + (temp_date.getDay() + 1)).parentNode.style.backgroundColor="#f2f2f2";
		}
        else {

          document.getElementById('at_calendar_2_1_' + (temp_date.getDay() + 1)).style.border = 'none';
          //document.getElementById('at_calendar_2_1_' + (temp_date.getDay() + 1)).style.lineHeight = '20px';
        }
        temp_date.setDate(temp_date.getDate() + 1);
        if (temp_date.getDay() == 0){
          temp_date.setDate(temp_date.getDate() - 7);
        }
      }
      temp_date.setDate(temp_date.getDate() + 7);
      for (var i=0;i<7;i++){
        document.getElementById('at_calendar_3_1_' + (temp_date.getDay() + 1)).innerHTML = temp_date.getDate();
        document.getElementById('at_calendar_3_1_' + (temp_date.getDay() + 1)).setAttribute('date',(temp_date.getFullYear() + '-' + (temp_date.getMonth() + 1 < 10 ? '0' + (temp_date.getMonth() + 1): (temp_date.getMonth() + 1)) + '-' + (temp_date.getDate() < 10 ? '0' + (temp_date.getDate()): (temp_date.getDate()))));
        if (document.getElementById('at_calendar_3_1_' + (temp_date.getDay() + 1)).getAttribute('date') == (current_date.getFullYear() + '-' + (current_date.getMonth() + 1 < 10 ? '0' + (current_date.getMonth() + 1): (current_date.getMonth() + 1)) + '-' + (current_date.getDate() < 10 ? '0' + (current_date.getDate()): (current_date.getDate())))){
          document.getElementById('at_calendar_3_1_' + (temp_date.getDay() + 1)).style.background = "#53afff";
          document.getElementById('at_calendar_3_1_' + (temp_date.getDay() + 1)).style.color = "#333";
          document.getElementById('at_calendar_3_1_' + (temp_date.getDay() + 1)).style.opacity = '1';
        }
        else {
         // document.getElementById('at_calendar_3_1_' + (temp_date.getDay() + 1)).style.background = "none";
          document.getElementById('at_calendar_3_1_' + (temp_date.getDay() + 1)).style.color = "#333";

          document.getElementById('at_calendar_3_1_' + (temp_date.getDay() + 1)).style.opacity = '1';
        }
        if (document.getElementById('at_calendar_3_1_' + (temp_date.getDay() + 1)).getAttribute('date') == today_date_str && (document.getElementById('at_calendar_3_1_' + (temp_date.getDay() + 1)).getAttribute('date') == (current_date.getFullYear() + '-' + (current_date.getMonth() + 1 < 10 ? '0' + (current_date.getMonth() + 1): (current_date.getMonth() + 1)) + '-' + (current_date.getDate() < 10 ? '0' + (current_date.getDate()): (current_date.getDate()))) != today_date_str)){
          document.getElementById('at_calendar_3_1_' + (temp_date.getDay() + 1)).style.border = '1px #fff solid';
          document.getElementById('at_calendar_3_1_' + (temp_date.getDay() + 1)).style.lineHeight = '18px';
        }
        else {
          //document.getElementById('at_calendar_3_1_' + (temp_date.getDay() + 1)).style.border = 'none';
          document.getElementById('at_calendar_3_1_' + (temp_date.getDay() + 1)).style.lineHeight = '20px';
        }
        temp_date.setDate(temp_date.getDate() + 1);
        if (temp_date.getDay() == 0){
          temp_date.setDate(temp_date.getDate() - 7);
        }
      }
      temp_date.setDate(temp_date.getDate() - 7);


    }


    $scope.fill_maximize_mode_calendar = function(mode){

      var current_date_json;
      if (mode == 'initialize'){

        current_date_json = (current_date.getFullYear() + '-' + (current_date.getMonth() + 1 < 10 ? '0' + (current_date.getMonth() + 1): (current_date.getMonth() + 1)) + '-' + (current_date.getDate() < 10 ? '0' + (current_date.getDate()): (current_date.getDate())));
        if (parseInt(current_date_json.split('-')[1],10) < 10){
          $("#at_home_date").html(current_date_json.split('-')[0] + '年0' + (parseInt(current_date_json.split('-')[1],10)) + '月');
        }
        else {
          $("#at_home_date").html(current_date_json.split('-')[0] + '年' + (parseInt(current_date_json.split('-')[1],10)) + '月');
        }
        temp_date.setFullYear(current_date_json.split('-')[0],(parseInt(current_date_json.split('-')[1],10)-1),1);
        temp_date.setMonth(temp_date.getMonth() - 1);
      }
      else if (mode == 'previous'){
        current_date_json = document.getElementById('at_calendar_1_3_3').getAttribute('date');
        if (parseInt(current_date_json.split('-')[1],10) < 10){
          $("#at_home_date").html(current_date_json.split('-')[0] + '年0' + (parseInt(current_date_json.split('-')[1],10)) + '月');
        }
        else {
          $("#at_home_date").html(current_date_json.split('-')[0] + '年' + (parseInt(current_date_json.split('-')[1],10)) + '月');
        }
        temp_date.setFullYear(current_date_json.split('-')[0],(parseInt(current_date_json.split('-')[1],10)-1),1);
        temp_date.setMonth(temp_date.getMonth() - 1);
      }
      else if (mode == 'next'){
        current_date_json = document.getElementById('at_calendar_3_3_3').getAttribute('date');
        if (parseInt(current_date_json.split('-')[1],10) < 10){
          $("#at_home_date").html(current_date_json.split('-')[0] + '年0' + (parseInt(current_date_json.split('-')[1],10)) + '月');
        }
        else {
          $("#at_home_date").html(current_date_json.split('-')[0] + '年' + (parseInt(current_date_json.split('-')[1],10)) + '月');
        }
        temp_date.setFullYear(current_date_json.split('-')[0],(parseInt(current_date_json.split('-')[1],10)-1),1);
        temp_date.setMonth(temp_date.getMonth() - 1);
      }


      for (var j=0;j<6;j++){
        for (var i=0;i<7;i++){
          document.getElementById('at_calendar_1_' + (j+1) + '_' + (temp_date.getDay() + 1)).innerHTML = temp_date.getDate();
          document.getElementById('at_calendar_1_' + (j+1) + '_' + (temp_date.getDay() + 1)).setAttribute('date',(temp_date.getFullYear() + '-' + (temp_date.getMonth() + 1 < 10 ? '0' + (temp_date.getMonth() + 1): (temp_date.getMonth() + 1)) + '-' + (temp_date.getDate() < 10 ? '0' + (temp_date.getDate()): (temp_date.getDate()))));
          if (document.getElementById('at_calendar_1_' + (j+1) + '_' + (temp_date.getDay() + 1)).getAttribute('date') == (current_date.getFullYear() + '-' + (current_date.getMonth() + 1 < 10 ? '0' + (current_date.getMonth() + 1): (current_date.getMonth() + 1)) + '-' + (current_date.getDate() < 10 ? '0' + (current_date.getDate()): (current_date.getDate())))){
            document.getElementById('at_calendar_1_' + (j+1) + '_' + (temp_date.getDay() + 1)).style.background = "#fa0100";
            document.getElementById('at_calendar_1_' + (j+1) + '_' + (temp_date.getDay() + 1)).style.color = "#333";
            document.getElementById('at_calendar_1_' + (j+1) + '_' + (temp_date.getDay() + 1)).style.opacity = '1';
          }
          else {
            document.getElementById('at_calendar_1_' + (j+1) + '_' + (temp_date.getDay() + 1)).style.background = "none";
            document.getElementById('at_calendar_1_' + (j+1) + '_' + (temp_date.getDay() + 1)).style.color = "#333";
            if (j == 0 && temp_date.getDate() > 7){
              document.getElementById('at_calendar_1_' + (j+1) + '_' + (temp_date.getDay() + 1)).style.opacity = '0.6';
            }
            else if ((j == 4 || j == 5) && temp_date.getDate() < 15){
              document.getElementById('at_calendar_1_' + (j+1) + '_' + (temp_date.getDay() + 1)).style.opacity = '0.6';
            }
            else {
              document.getElementById('at_calendar_1_' + (j+1) + '_' + (temp_date.getDay() + 1)).style.opacity = '1';
            }

          }
          if (document.getElementById('at_calendar_1_' + (j+1) + '_' + (temp_date.getDay() + 1)).getAttribute('date') == today_date_str && (document.getElementById('at_calendar_1_' + (j+1) + '_' + (temp_date.getDay() + 1)).getAttribute('date') == (current_date.getFullYear() + '-' + (current_date.getMonth() + 1 < 10 ? '0' + (current_date.getMonth() + 1): (current_date.getMonth() + 1)) + '-' + (current_date.getDate() < 10 ? '0' + (current_date.getDate()): (current_date.getDate()))))){
            document.getElementById('at_calendar_1_' + (j+1) + '_' + (temp_date.getDay() + 1)).style.border = '1px #53afff solid';
            document.getElementById('at_calendar_1_' + (j+1) + '_' + (temp_date.getDay() + 1)).style.lineHeight = '18px';
          }
          else {
            document.getElementById('at_calendar_1_' + (j+1) + '_' + (temp_date.getDay() + 1)).style.border = 'none';
            document.getElementById('at_calendar_1_' + (j+1) + '_' + (temp_date.getDay() + 1)).style.lineHeight = '20px';
          }
          temp_date.setDate(temp_date.getDate() + 1);
          if (temp_date.getDay() == 0){
            temp_date.setDate(temp_date.getDate() - 7);
          }
        }
        temp_date.setDate(temp_date.getDate() + 7);
      }



      temp_date.setFullYear(current_date_json.split('-')[0],(parseInt(current_date_json.split('-')[1],10)-1),1);
      temp_date.setMonth(temp_date.getMonth());

      for (var j=0;j<6;j++){
        for (var i=0;i<7;i++){
          document.getElementById('at_calendar_2_' + (j+1) + '_' + (temp_date.getDay() + 1)).innerHTML = temp_date.getDate();
          document.getElementById('at_calendar_2_' + (j+1) + '_' + (temp_date.getDay() + 1)).setAttribute('date',(temp_date.getFullYear() + '-' + (temp_date.getMonth() + 1 < 10 ? '0' + (temp_date.getMonth() + 1): (temp_date.getMonth() + 1)) + '-' + (temp_date.getDate() < 10 ? '0' + (temp_date.getDate()): (temp_date.getDate()))));

          if (document.getElementById('at_calendar_2_' + (j+1) + '_' + (temp_date.getDay() + 1)).getAttribute('date') == (current_date.getFullYear() + '-' + (current_date.getMonth() + 1 < 10 ? '0' + (current_date.getMonth() + 1): (current_date.getMonth() + 1)) + '-' + (current_date.getDate() < 10 ? '0' + (current_date.getDate()): (current_date.getDate())))){
            document.getElementById('at_calendar_2_' + (j+1) + '_' + (temp_date.getDay() + 1)).parentNode.style.background = "#ff3b30";
			//document.getElementById('at_calendar_2_' + (j+1) + '_' + (temp_date.getDay() + 1)).style.backgroundImage = "";

			//document.getElementById('at_calendar_img_icon_2_' + (j+1) + '_' + (temp_date.getDay() + 1)).style.display = "none";
			//document.getElementById('at_calendar_dot_2_' + (j+1) + '_' + (temp_date.getDay() + 1)).style.display = "none";
			document.getElementById('at_calendar_2_'+ (j+1) + '_' + (temp_date.getDay() + 1)).style.border = 'none';
            document.getElementById('at_calendar_2_' + (j+1) + '_' + (temp_date.getDay() + 1)).style.color = "white";
            document.getElementById('at_calendar_text_2_' + (j+1) + '_' + (temp_date.getDay() + 1)).style.color = "white";
            document.getElementById('at_calendar_2_' + (j+1) + '_' + (temp_date.getDay() + 1)).style.opacity = '1';
			document.getElementById('at_calendar_img_icon_2_' + (j+1) + '_' + (temp_date.getDay() + 1)).style.opacity = '1';
			document.getElementById('at_calendar_img_icon2_2_' + (j+1) + '_' + (temp_date.getDay() + 1)).style.opacity = '1	';
          }
          else {
            document.getElementById('at_calendar_2_' + (j+1) + '_' + (temp_date.getDay() + 1)).parentNode.style.background = "none";
            //document.getElementById('at_calendar_2_' + (j+1) + '_' + (temp_date.getDay() + 1)).style.color = "#333";
            document.getElementById('at_calendar_text_2_' + (j+1) + '_' + (temp_date.getDay() + 1)).style.color = "#999";

            if (j == 0 && temp_date.getDate() > 7){
              document.getElementById('at_calendar_2_' + (j+1) + '_' + (temp_date.getDay() + 1)).style.opacity = '0.1';
			  //document.getElementById('at_calendar_dot_2_' + (j+1) + '_' + (temp_date.getDay() + 1)).style.opacity = '0.2';
			  document.getElementById('at_calendar_text_2_' + (j+1) + '_' + (temp_date.getDay() + 1)).style.opacity = '0.2';
			  document.getElementById('at_calendar_img_icon_2_' + (j+1) + '_' + (temp_date.getDay() + 1)).style.opacity = '0.2';
			  document.getElementById('at_calendar_img_icon2_2_' + (j+1) + '_' + (temp_date.getDay() + 1)).style.opacity = '0.2';

            }
            else if ((j == 4 || j == 5) && temp_date.getDate() < 15){
              document.getElementById('at_calendar_2_' + (j+1) + '_' + (temp_date.getDay() + 1)).style.opacity = '0.1';
			  //document.getElementById('at_calendar_dot_2_' + (j+1) + '_' + (temp_date.getDay() + 1)).style.opacity = '0.2';
			  document.getElementById('at_calendar_text_2_' + (j+1) + '_' + (temp_date.getDay() + 1)).style.opacity = '0.2';
			  document.getElementById('at_calendar_img_icon_2_' + (j+1) + '_' + (temp_date.getDay() + 1)).style.opacity = '0.2';
			  document.getElementById('at_calendar_img_icon2_2_' + (j+1) + '_' + (temp_date.getDay() + 1)).style.opacity = '0.2';
            }
            else {
              document.getElementById('at_calendar_2_' + (j+1) + '_' + (temp_date.getDay() + 1)).style.opacity = '1';
			  //document.getElementById('at_calendar_dot_2_' + (j+1) + '_' + (temp_date.getDay() + 1)).style.opacity = '1';
			  document.getElementById('at_calendar_text_2_' + (j+1) + '_' + (temp_date.getDay() + 1)).style.opacity = '1';
			  document.getElementById('at_calendar_img_icon_2_' + (j+1) + '_' + (temp_date.getDay() + 1)).style.opacity = '1';
		      document.getElementById('at_calendar_img_icon2_2_' + (j+1) + '_' + (temp_date.getDay() + 1)).style.opacity = '1';
            }
          }
          if (document.getElementById('at_calendar_2_' + (j+1) + '_' + (temp_date.getDay() + 1)).getAttribute('date') == today_date_str && (document.getElementById('at_calendar_2_' + (j+1) + '_' + (temp_date.getDay() + 1)).getAttribute('date') != (current_date.getFullYear() + '-' + (current_date.getMonth() + 1 < 10 ? '0' + (current_date.getMonth() + 1): (current_date.getMonth() + 1)) + '-' + (current_date.getDate() < 10 ? '0' + (current_date.getDate()): (current_date.getDate()))))){
            //document.getElementById('at_calendar_2_' + (j+1) + '_' + (temp_date.getDay() + 1)).style.border = '1px #fa0100 solid';
			document.getElementById('at_calendar_2_' + (j+1) + '_' + (temp_date.getDay() + 1)).parentNode.style.backgroundColor="#f2f2f2"
            //document.getElementById('at_calendar_2_' + (j+1) + '_' + (temp_date.getDay() + 1)).style.lineHeight = '18px';
          }
          else {
            document.getElementById('at_calendar_2_' + (j+1) + '_' + (temp_date.getDay() + 1)).style.border = 'none';
            //document.getElementById('at_calendar_2_' + (j+1) + '_' + (temp_date.getDay() + 1)).style.lineHeight = '20px';
          }
          temp_date.setDate(temp_date.getDate() + 1);
          if (temp_date.getDay() == 0){
            temp_date.setDate(temp_date.getDate() - 7);
          }
        }
        temp_date.setDate(temp_date.getDate() + 7);
      }

      temp_date.setFullYear(current_date_json.split('-')[0],(parseInt(current_date_json.split('-')[1],10)-1),1);
      temp_date.setMonth(temp_date.getMonth() + 1);

      for (var j=0;j<6;j++){
        for (var i=0;i<7;i++){
          document.getElementById('at_calendar_3_' + (j+1) + '_' + (temp_date.getDay() + 1)).innerHTML = temp_date.getDate();
          document.getElementById('at_calendar_3_' + (j+1) + '_' + (temp_date.getDay() + 1)).setAttribute('date',(temp_date.getFullYear() + '-' + (temp_date.getMonth() + 1 < 10 ? '0' + (temp_date.getMonth() + 1): (temp_date.getMonth() + 1)) + '-' + (temp_date.getDate() < 10 ? '0' + (temp_date.getDate()): (temp_date.getDate()))));

          if (document.getElementById('at_calendar_3_' + (j+1) + '_' + (temp_date.getDay() + 1)).getAttribute('date') == (current_date.getFullYear() + '-' + (current_date.getMonth() + 1 < 10 ? '0' + (current_date.getMonth() + 1): (current_date.getMonth() + 1)) + '-' + (current_date.getDate() < 10 ? '0' + (current_date.getDate()): (current_date.getDate())))){
            document.getElementById('at_calendar_3_' + (j+1) + '_' + (temp_date.getDay() + 1)).style.background = "#53afff";
            document.getElementById('at_calendar_3_' + (j+1) + '_' + (temp_date.getDay() + 1)).style.color = "#333";
            document.getElementById('at_calendar_3_' + (j+1) + '_' + (temp_date.getDay() + 1)).style.opacity = '1';
          }
          else {
            document.getElementById('at_calendar_3_' + (j+1) + '_' + (temp_date.getDay() + 1)).style.background = "none";
            document.getElementById('at_calendar_3_' + (j+1) + '_' + (temp_date.getDay() + 1)).style.color = "#333";

            if (j == 0 && temp_date.getDate() > 7){
              document.getElementById('at_calendar_3_' + (j+1) + '_' + (temp_date.getDay() + 1)).style.opacity = '0.6';
            }
            else if ((j == 4 || j == 5) && temp_date.getDate() < 15){
              document.getElementById('at_calendar_3_' + (j+1) + '_' + (temp_date.getDay() + 1)).style.opacity = '0.6';
            }
            else {
              document.getElementById('at_calendar_3_' + (j+1) + '_' + (temp_date.getDay() + 1)).style.opacity = '1';
            }
          }
          if (document.getElementById('at_calendar_3_' + (j+1) + '_' + (temp_date.getDay() + 1)).getAttribute('date') == today_date_str && (document.getElementById('at_calendar_3_' + (j+1) + '_' + (temp_date.getDay() + 1)).getAttribute('date') == (current_date.getFullYear() + '-' + (current_date.getMonth() + 1 < 10 ? '0' + (current_date.getMonth() + 1): (current_date.getMonth() + 1)) + '-' + (current_date.getDate() < 10 ? '0' + (current_date.getDate()): (current_date.getDate()))) != today_date_str)){
            document.getElementById('at_calendar_3_' + (j+1) + '_' + (temp_date.getDay() + 1)).style.border = '1px #fff solid';
            document.getElementById('at_calendar_3_' + (j+1) + '_' + (temp_date.getDay() + 1)).style.lineHeight = '18px';
          }
          else {
            document.getElementById('at_calendar_3_' + (j+1) + '_' + (temp_date.getDay() + 1)).style.border = 'none';
            document.getElementById('at_calendar_3_' + (j+1) + '_' + (temp_date.getDay() + 1)).style.lineHeight = '20px';
          }
          temp_date.setDate(temp_date.getDate() + 1);
          if (temp_date.getDay() == 0){
            temp_date.setDate(temp_date.getDate() - 7);
          }
        }
        temp_date.setDate(temp_date.getDate() + 7);
      }


    }

    $scope.calendar_week_next_page = function(){
      if ($scope.paging_in_progress){
        return;
      }

      $scope.paging_in_progress = true;


      if (current_mode == 'maximize'){
        atHomeSev.loadData(document.getElementById('at_calendar_3_3_3').getAttribute('date'),$scope,'maximize_next_page');
      }
      else {
        var div_temp_date = document.getElementById('at_calendar_2_1_1').getAttribute('date');
        temp_date.setFullYear(div_temp_date.split('-')[0],(parseInt(div_temp_date.split('-')[1],10)-1),(parseInt(div_temp_date.split('-')[2],10)));
		temp_date.setDate(temp_date.getDate() + 7);

        atHomeSev.loadData((temp_date.getFullYear() + '-' + (temp_date.getMonth() + 1 < 10 ? '0' + (temp_date.getMonth() + 1): (temp_date.getMonth() + 1)) + '-' + (temp_date.getDate() < 10 ? '0' + (temp_date.getDate()): (temp_date.getDate()))),$scope,'minimize_next_page');
      }
      return;
    }

    $scope.calendar_week_prev_page = function(){
      if ($scope.paging_in_progress){
        return;
      }
      $scope.paging_in_progress = true;


      if (current_mode == 'maximize'){
        atHomeSev.loadData(document.getElementById('at_calendar_1_3_3').getAttribute('date'),$scope,'maximize_previous_page');
      }
      else {
        var div_temp_date = document.getElementById('at_calendar_2_1_1').getAttribute('date');
        temp_date.setFullYear(div_temp_date.split('-')[0],(parseInt(div_temp_date.split('-')[1],10)-1),(parseInt(div_temp_date.split('-')[2],10)));
		temp_date.setDate(temp_date.getDate() - 7);

        //atHomeSev.loadData(document.getElementById('at_calendar_2_1_1').getAttribute('date'),$scope,'minimize_previous_page');
		atHomeSev.loadData((temp_date.getFullYear() + '-' + (temp_date.getMonth() + 1 < 10 ? '0' + (temp_date.getMonth() + 1): (temp_date.getMonth() + 1)) + '-' + (temp_date.getDate() < 10 ? '0' + (temp_date.getDate()): (temp_date.getDate()))),$scope,'minimize_previous_page');
      }
      return;
    }



    $scope.calendar_week_minimize = function(){

      if ($scope.paging_in_progress || current_mode == 'minimize'){
        return;
      }

      $scope.paging_in_progress = true;
      clear_calendar_highlight();

      atHomeSev.loadData((current_date.getFullYear() + '-' + (current_date.getMonth() + 1 < 10 ? '0' + (current_date.getMonth() + 1): (current_date.getMonth() + 1)) + '-' + (current_date.getDate() < 10 ? '0' + (current_date.getDate()): (current_date.getDate()))),$scope,'minimize');


      //$scope.paging_in_progress = true;

      //$timeout(function(){ $ionicScrollDelegate.resize(); }, 200);
      //$ionicScrollDelegate.scrollTop();

      var style_top_value;
      var animate_duration = 0.2;
      if (ionic.Platform.isIOS()) {
        style_top_value = $scope.content_position_top_ios;
      }
      else {
        style_top_value = $scope.content_position_top_android;
      }


      /*
       setTimeout(function(){
       current_mode = 'minimize';
       atHomeSev.loadData((current_date.getFullYear() + '-' + (current_date.getMonth() + 1 < 10 ? '0' + (current_date.getMonth() + 1): (current_date.getMonth() + 1)) + '-' + (current_date.getDate() < 10 ? '0' + (current_date.getDate()): (current_date.getDate()))),$scope,'minimize');
       }, animate_duration * 1000);
       */
      minimize_tween1 = TweenMax.to(document.getElementById('at_home_calendar_wrapper'),animate_duration,{
        //webkitTransform:'translateY(-180px)',
        height:$scope.wrap_height,
        //background:'#53afff',
        //ease:Linear.easeInOut,
        autoRound:false,
        force3D:true,
        onComplete: function(){
          current_mode = 'minimize';
          //$scope.paging_in_progress = false;
          $timeout(function(){ $ionicScrollDelegate.resize(); }, 50);
        }
      });

      minimize_tween2 = TweenMax.to(document.getElementById('at_home_content'),animate_duration,{
        top:style_top_value,
        autoRound:false,
        force3D:true
        //ease:Linear.easeInOut
      });

    }

    $scope.content_calendar_week_minimize = function(){

      $scope.calendar_week_minimize();
    }

    $scope.content_calendar_week_maximize = function(){

      if ($ionicScrollDelegate.getScrollPosition().top > 0){
        return;
      }
      $scope.calendar_week_maximize();
    }

    $scope.calendar_week_maximize = function(){
      if ($scope.paging_in_progress || current_mode == 'maximize'){
        return;
      }

      $scope.paging_in_progress = true;
      atHomeSev.loadData((current_date.getFullYear() + '-' + (current_date.getMonth() + 1 < 10 ? '0' + (current_date.getMonth() + 1): (current_date.getMonth() + 1)) + '-' + (current_date.getDate() < 10 ? '0' + (current_date.getDate()): (current_date.getDate()))),$scope,'maximize');

      //$scope.paging_in_progress = true;

      //$timeout(function(){ $ionicScrollDelegate.resize(); }, 200);
      //$ionicScrollDelegate.scrollTop();

      var style_top_value;
      var animate_duration = 0.2;

      if (ionic.Platform.isIOS()) {
        style_top_value = $scope.header_bar_height;
      }
      else {
        style_top_value = ((document.body.scrollWidth - 84)/7 + 12)*7-5 +'px';
      }

      /*
       setTimeout(function(){
       current_mode = 'maximize';
       atHomeSev.loadData((current_date.getFullYear() + '-' + (current_date.getMonth() + 1 < 10 ? '0' + (current_date.getMonth() + 1): (current_date.getMonth() + 1)) + '-' + (current_date.getDate() < 10 ? '0' + (current_date.getDate()): (current_date.getDate()))),$scope,'maximize');
       }, animate_duration * 1000);
       */
      maximize_tween1 = TweenMax.to(document.getElementById('at_home_calendar_wrapper'),animate_duration,{
        //webkitTransform:'translateY(0px)',
        height:$scope.calendar_wrapper_height,
        //background:'-webkit-gradient(linear, left top, left bottom, color-stop(0%,#53afff), color-stop(100%,#74dafd))',
        autoRound:false,
        force3D:true,
        onComplete: function(){
          current_mode = 'maximize';
          //$scope.paging_in_progress = false;
          $timeout(function(){ $ionicScrollDelegate.resize(); }, 50);
        }
      });
//alert($scope.header_bar_height);
      maximize_tween2 = TweenMax.to(document.getElementById('at_home_content'),animate_duration,{
        top:style_top_value,
        autoRound:false,
        force3D:true
      });


    }



  })

.controller('cardRecordAdjApplyCtrl',function($scope,cardRecordAdjApplySev,$stateParams,$location,$ionicPopup,$ionicHistory,$rootScope,$ionicActionSheet,homemessageSev,timeSelect,$timeout,$ionicModal,$ionicScrollDelegate,sideSelect,timeSelect,$emplComponentService){
	$scope.img_sign_in_apply_img1 = local_resource + 'img/icon/sign_in_apply_img1.png';
	$scope.img_sign_in_apply_img2 = local_resource + 'img/icon/sign_in_apply_img2.png';
	$scope.img_add_approver = local_resource + 'img/model/add_approver_.png';
    $scope.dates_line2x = local_resource + 'img/model/dates-line2x.png';
    $scope.dates_line3x = local_resource + 'img/model/dates-line2x.png';
    $scope.add_approver = local_resource + 'img/model/add_approver.png';
    $scope.add_approver_ = local_resource + 'img/model/add_approver_.png';
    $scope.dates_line4x = local_resource + 'img/model/dates-line2x.png';
    $scope.img_upload_file_part1 = local_resource+'img/icon/add.png';
    $scope.img_upload_file_part2 = local_resource+'img/icon/new_2.png';
    $scope.contract_management_directory1 = local_resource + 'img/icon/contract_management_directory1.png';
    $scope.start_ot_icon=local_resource+'img/icon/start_ot_icon.png';
    $scope.end_ot_icon=local_resource+'img/icon/end_ot_icon.png';
    $scope.start_rest_icon=local_resource+'img/icon/start_rest_icon.png';
    $scope.end_rest_icon=local_resource+'img/icon/end_rest_icon.png';
    $scope.ot_hours_icon=local_resource+'img/icon/ot_hours_icon.png';

	$scope.$on("$ionicView.enter", function () {

		if (typeof($scope.data_loaded) != 'undefined') {
          return;
        }
        else {
          $scope.data_loaded = true;
        }

		document.getElementById('card_record_adj_apply_content').style.display = "block";
		cardRecordAdjApplySev.clearData();
		cardRecordAdjApplySev.loadData($stateParams.shift_date,$scope);
		$scope.cardRecordAdjApplyData = cardRecordAdjApplySev.getData();
	});

    $scope.search_control={};
    $scope.search_control.search_val = '';
    $scope.ess_empl_data = [];
    $scope.select_user_id = '';
    $scope.select_notify_id = '';
    $scope.click_flag = 0;

	$scope.change_time = function (i,type){
		//alert(i + type);
		var current_default_date;
		if (i==0 && type=='time_in'){
			current_default_date = $scope.cardRecordAdjApplyData.first_in;
		}
		else if (i==0 && type=='time_out'){
			current_default_date = $scope.cardRecordAdjApplyData.first_out;
		}
		else if (i==1 && type=='time_in'){
			current_default_date = $scope.cardRecordAdjApplyData.second_in;
		}
		else if (i==1 && type=='time_out'){
			current_default_date = $scope.cardRecordAdjApplyData.second_out;
		}
		else if (i==2 && type=='time_in'){
			current_default_date = $scope.cardRecordAdjApplyData.third_in;
		}
		else if (i==2 && type=='time_out'){
			current_default_date = $scope.cardRecordAdjApplyData.third_out;
		}
		else if (i==3 && type=='time_in'){
			current_default_date = $scope.cardRecordAdjApplyData.forth_in;
		}
		else if (i==3 && type=='time_out'){
			current_default_date = $scope.cardRecordAdjApplyData.forth_out;
		}
		else if (i==4 && type=='time_in'){
			current_default_date = $scope.cardRecordAdjApplyData.fifth_in;
		}
		else if (i==4 && type=='time_out'){
			current_default_date = $scope.cardRecordAdjApplyData.fifth_out;
		}
		if (current_default_date == ''){
			current_default_date = '00:00';
		}
      timeSelect.show({
        type :  'time',
        startDate :'1993年12月01日',
        endDate : '',
        defaultDate: current_default_date,
        returnDateType : 'hm',
        returnTimeType :  '24h'||'AMPM',

        selectedFunc : function (date) {
          if (typeof(date) != 'undefined'){
			if (i==0 && type=='time_in'){
				$scope.cardRecordAdjApplyData.first_in = date;
			}
			else if (i==0 && type=='time_out'){
				$scope.cardRecordAdjApplyData.first_out = date;
			}
			else if (i==1 && type=='time_in'){
				$scope.cardRecordAdjApplyData.second_in = date;
			}
			else if (i==1 && type=='time_out'){
				$scope.cardRecordAdjApplyData.second_out = date;
			}
			else if (i==2 && type=='time_in'){
				$scope.cardRecordAdjApplyData.third_in = date;
			}
			else if (i==2 && type=='time_out'){
				$scope.cardRecordAdjApplyData.third_out = date;
			}
			else if (i==3 && type=='time_in'){
				$scope.cardRecordAdjApplyData.forth_in = date;
			}
			else if (i==3 && type=='time_out'){
				$scope.cardRecordAdjApplyData.forth_out = date;
			}
			else if (i==4 && type=='time_in'){
				$scope.cardRecordAdjApplyData.fifth_in = date;
			}
			else if (i==4 && type=='time_out'){
				$scope.cardRecordAdjApplyData.fifth_out = date;
			}

			document.getElementById('card_adj_record_' + i + '_' + type).innerHTML = '<label style=" font-size:14px">' + date.split(':')[0] + '</label>		:		<label style=" font-size:14px">' + date.split(':')[1] + '</label>'
          }
		  else{
			if (i==0 && type=='time_in'){
				$scope.cardRecordAdjApplyData.first_in = '';
			}
			else if (i==0 && type=='time_out'){
				$scope.cardRecordAdjApplyData.first_out = '';
			}
			else if (i==1 && type=='time_in'){
				$scope.cardRecordAdjApplyData.second_in = '';
			}
			else if (i==1 && type=='time_out'){
				$scope.cardRecordAdjApplyData.second_out = '';
			}
			else if (i==2 && type=='time_in'){
				$scope.cardRecordAdjApplyData.third_in = '';
			}
			else if (i==2 && type=='time_out'){
				$scope.cardRecordAdjApplyData.third_out = '';
			}
			else if (i==3 && type=='time_in'){
				$scope.cardRecordAdjApplyData.forth_in = '';
			}
			else if (i==3 && type=='time_out'){
				$scope.cardRecordAdjApplyData.forth_out = '';
			}
			else if (i==4 && type=='time_in'){
				$scope.cardRecordAdjApplyData.fifth_in = '';
			}
			else if (i==4 && type=='time_out'){
				$scope.cardRecordAdjApplyData.fifth_out = '';
			}

			document.getElementById('card_adj_record_' + i + '_' + type).innerHTML = '<label style="border-bottom:1px solid#ccc;padding: 0 9px;"></label>		:		<label style="border-bottom:1px solid#ccc;padding: 0 9px;"></label>';
		  }
        }
      });
	}

	$scope.saveApply = function(){

		cardRecordAdjApplySev.saveApply($scope.select_user_id,$scope.select_notify_id);
    }

	$scope.chooseAdjReason=function(){
      sideSelect.show({
        type : 'ios',
        data :$scope.cardRecordAdjApplyData.adj_type,
        selectIndex :  $scope.cardRecordAdjApplyData.adj_type_index,
        selectedFunc : function (index) {
          if(typeof(index)!='undefined'){
            document.getElementById("adjReason").innerHTML=$scope.cardRecordAdjApplyData.adj_type[index].value_;
            $scope.cardRecordAdjApplyData.adj_type_id=$scope.cardRecordAdjApplyData.adj_type[index].key_;
			for (var i=0;i<$scope.cardRecordAdjApplyData.adj_type.length;i++){
				$scope.cardRecordAdjApplyData.adj_type[i].check = false;
			}
			$scope.cardRecordAdjApplyData.adj_type[index].check = true;
            $scope.cardRecordAdjApplyData.adj_type_index=index;
			if(index=='5'){
				document.getElementById("card_record_adj_apply_remark").style.display = 'block';
			}
			  else{
				document.getElementById("card_record_adj_apply_remark").style.display = 'none';
			  }
          }

        }
      });
    }

    $scope.essItemCk = function(user_id,img,en,_flag){
      if(_flag == true){
        $scope.ess_empl_data.num_checked =  $scope.ess_empl_data.num_checked + 1;
      }else{
        $scope.ess_empl_data.num_checked =  $scope.ess_empl_data.num_checked - 1;
      }
      var _d = [];
      if($scope.click_flag == 0){
        $scope.select_user_id = user_id;
        _d = $scope.cardRecordAdjApplyData.approver_list;
      }else{
        return;
      }
      var flag = 0;
      var _len = _d.length;
      for(var i=0;i<_len;i++){
        if(angular.isDefined(_d[i].flag)&&_d[i].flag==1){
          flag = 1;
          break;
        }
      }
      if(flag == 0){
        _d.push({
          img:img,
          name:en,
          user_id:user_id,
          flag:1
        })
      }else{
        _d[_len-1] = {
          img:img,
          name:en,
          user_id:user_id,
          flag:1
        }
      }
      $scope.closeModal();
   $scope.cardRecordAdjApplyData._approver_list=_d;
      $scope.search_control.search_val = '';
    }
    $scope.delete_notify=function(user_id){
      $('#cardRecordAdjApply #notify_list_div').addClass('notify_list_active');
      if($scope.select_notify_id.indexOf(',')==-1){
        $scope.select_notify_id=$scope.select_notify_id.replace(user_id,'');
      }
      else if($scope.select_notify_id.indexOf(user_id+',')==-1){
        $scope.select_notify_id=$scope.select_notify_id.replace(','+user_id,'');
      }
      else{
        $scope.select_notify_id=$scope.select_notify_id.replace(user_id+',','');
      }
      for(var i=0;i<$scope.cardRecordAdjApplyData.notify_list.length;i++){
        if($scope.cardRecordAdjApplyData.notify_list[i].user_id==user_id){
          $scope.cardRecordAdjApplyData.notify_list.splice(i,1);
        }
      }
      setTimeout(function(){
        document.getElementById('notify_list_div').style.width=($scope.cardRecordAdjApplyData.notify_list.length+1)*100+20+'px';
        $ionicScrollDelegate.$getByHandle("notify_list_scroll").resize();
      },350)


    }
    $scope.delete_approver=function(user_id){
      if(!$scope.cardRecordAdjApplyData.approver_list_flag){
        return;
      }
      $('#cardRecordAdjApply #approver_list_div').addClass('approver_list_active');
      $scope.cardRecordAdjApplyData.approver_list=[];
      $scope.select_user_id=''
    }

    $scope.selectList = function(){
      if($scope.click_flag==1){
        var _d = [];
        $scope.select_notify_id = '';
        $scope.cardRecordAdjApplyData.notify_list = [];
        for(var i=0;i<$scope.ess_empl_data.length;i++){
          if($scope.ess_empl_data[i].ck){
            $scope.select_notify_id = $scope.select_notify_id + ($scope.ess_empl_data)[i].user_id+',';
            $scope.cardRecordAdjApplyData.notify_list.push({
              img:($scope.ess_empl_data)[i].img,
              name:($scope.ess_empl_data)[i].en,
              user_id:($scope.ess_empl_data)[i].user_id,
              flag:1
            });
          }
        }
        $scope.select_notify_id = ($scope.select_notify_id).substring(0,$scope.select_notify_id.length-1);
        $scope.closeModal();
      }
      document.getElementById('notify_list_div').style.width=($scope.cardRecordAdjApplyData.notify_list.length+1)*100+20+'px';

      $scope.search_control.search_val = '';
      $ionicScrollDelegate.$getByHandle("notify_list_scroll").resize();
    }

    $ionicModal.fromTemplateUrl('ess-empl-modal.html', {
      scope: $scope,
      animation: 'slide-in-up'
    }).then(function(modal) {
      $scope.modal = modal;
    });

	$scope.openModal = function() {

		var selectEmplList = '';
		if ($scope.cardRecordAdjApplyData.approver_list.length != 0){
			selectEmplList = $scope.cardRecordAdjApplyData.approver_list[0].employee_no;
		}

		$emplComponentService.open({
			title : '选择审批人', //弹开窗口标题
			barTitle : window.localStorage["org_top_level"],//导航开头
			isSingleSelect:true,//是否单选
			isShowContact:true,//是否展示常用联系人
			isNeedSaveContact:true,//是否保存常用联系人
			extName : '员工', //多选时提示后缀名
			selectEmplList:selectEmplList, //打开窗口默认选中员工列表
			routerName:'at',
			sure : function (rd) { //返回数据，数组格式

				$('#approver_list_div').removeClass('approver_list_active');
				$scope.select_user_id = rd[0].user_id;
				$scope.cardRecordAdjApplyData.approver_list = [];
				$scope.cardRecordAdjApplyData.approver_list.push({
				  img:rd[0].img_src,
				  name:rd[0].empl_name,
				  user_id:rd[0].user_id,
				  employee_no:rd[0].empl_no,
				  flag:1
				});
				//$scope.approver_list=$scope.cardRecordAdjApplyData.approver_list;
			}
		});

    }

    $scope.openModal2 = function() {
		var selectEmplList = '';
		if ($scope.cardRecordAdjApplyData.notify_list.length != 0){
			for (var i=0;i<$scope.cardRecordAdjApplyData.notify_list.length;i++){
				selectEmplList += $scope.cardRecordAdjApplyData.notify_list[i].employee_no;
				if (i < $scope.cardRecordAdjApplyData.notify_list.length - 1){
					selectEmplList += ',';
				}
			}

		}

		$emplComponentService.open({
			title : '选择知会人', //弹开窗口标题
			barTitle : window.localStorage["org_top_level"],//导航开头
			isSingleSelect:false,//是否单选
			isShowContact:true,//是否展示常用联系人
			isNeedSaveContact:true,//是否保存常用联系人
			extName : '员工', //多选时提示后缀名
			selectEmplList:selectEmplList, //打开窗口默认选中员工列表
			routerName:'at',
			sure : function (rd) { //返回数据，数组格式
				$('#notify_list_div').removeClass('notify_list_active');
				$scope.select_notify_id = '';
				$scope.cardRecordAdjApplyData.notify_list = [];
				for(var i=0;i<rd.length;i++){

					$scope.select_notify_id = $scope.select_notify_id + rd[i].user_id;
					$scope.cardRecordAdjApplyData.notify_list.push({
					  img:rd[i].img_src,
					  name:rd[i].empl_name,
					  user_id:rd[i].user_id,
					  employee_no:rd[i].empl_no,
					  flag:1
					});
					if (i < rd.length - 1){
						$scope.select_notify_id += ',';
					}
				}

				document.getElementById('notify_list_div').style.width=($scope.cardRecordAdjApplyData.notify_list.length+1)*100+20+'px';
				$ionicScrollDelegate.$getByHandle("notify_list_scroll").resize();
			}
		});

    }

/*
    $scope.openModal = function() {
      $('#cardRecordAdjApply #approver_list_div').removeClass('approver_list_active');
      $scope.search_val = '';
      $scope.click_flag = 0;
      $scope.ess_empl_data = [];
      cardRecordAdjApplySev.loadEssEmplData($scope.select_user_id,$scope.cardRecordAdjApplyData.employee_no,'');
      $scope.ess_empl_data = cardRecordAdjApplySev.getEssEmplData();
      $scope.modal.show();
    };

    $scope.openModal2 = function() {
      $('#cardRecordAdjApply #notify_list_div').removeClass('notify_list_active');
      $scope.search_val = '';
      $scope.click_flag = 1;
      $scope.ess_empl_data = [];
      cardRecordAdjApplySev.loadEssEmplData($scope.select_notify_id,$scope.cardRecordAdjApplyData.employee_no,'');
      $scope.ess_empl_data = cardRecordAdjApplySev.getEssEmplData();
      $scope.modal.show();
    };
*/
    $scope.closeModal = function() {
      $scope.modal.hide();
      $scope.ess_empl_data = [];
      $scope.search_control.search_val = '';
    };
    $scope.$on('$destroy', function() {
      $scope.modal.remove();
    });
	//essOtApplySev
  })

  .controller('atMonthReportCtrl',function($scope,atMonthReportSev,$stateParams,$location,$ionicPopup,$ionicHistory,$rootScope,$ionicActionSheet,homemessageSev,timeSelect,$timeout){
	fufuMobclickAgent('menu_at_home_month_report');
	var today_date = new Date()
	var current_date = new Date();
	var today_date_str = (today_date.getFullYear() + '-' + (today_date.getMonth() + 1 < 10 ? '0' + (today_date.getMonth() + 1): (today_date.getMonth() + 1)) + '-' + (today_date.getDate() < 10 ? '0' + (today_date.getDate()): (today_date.getDate())));
	var current_date_str = '';
	current_date.setFullYear(today_date_str.split('-')[0],(parseInt(today_date_str.split('-')[1],10)-1),1);
    current_date_str = (current_date.getFullYear() + '-' + (current_date.getMonth() + 1 < 10 ? '0' + (current_date.getMonth() + 1): (current_date.getMonth() + 1)) + '-' + (current_date.getDate() < 10 ? '0' + (current_date.getDate()): (current_date.getDate())));
	$scope.current_date_text= current_date_str.split("-")[0]+'年'+current_date_str.split("-")[1]+'月';

	atMonthReportSev.clearData();
	atMonthReportSev.loadData(current_date_str);
	$scope.atMonthReportData = atMonthReportSev.getData();

	$scope.previous_month = function(){
		current_date.setMonth(current_date.getMonth() - 1);
		current_date_str = (current_date.getFullYear() + '-' + (current_date.getMonth() + 1 < 10 ? '0' + (current_date.getMonth() + 1): (current_date.getMonth() + 1)) + '-' + (current_date.getDate() < 10 ? '0' + (current_date.getDate()): (current_date.getDate())));
		$scope.current_date_text= current_date_str.split("-")[0]+'年'+current_date_str.split("-")[1]+'月';
		atMonthReportSev.loadData(current_date_str);
	}

	$scope.next_month = function(){
		current_date.setMonth(current_date.getMonth() + 1);
		current_date_str = (current_date.getFullYear() + '-' + (current_date.getMonth() + 1 < 10 ? '0' + (current_date.getMonth() + 1): (current_date.getMonth() + 1)) + '-' + (current_date.getDate() < 10 ? '0' + (current_date.getDate()): (current_date.getDate())));
		$scope.current_date_text= current_date_str.split("-")[0]+'年'+current_date_str.split("-")[1]+'月';
		atMonthReportSev.loadData(current_date_str);
	}

	$scope.$on("$ionicView.enter", function () {
		document.getElementById('at_month_report_content').style.display = "block";
	});

  })


.controller('essMyCardAdjApplyDCtrl',function($scope,essMyCardAdjApplyDSev,$stateParams,$ionicModal,$location,$ionicScrollDelegate,$ionicNavBarDelegate,$ionicHistory,$timeout){

    //$scope.$on("$ionicView.enter", function () {
    //  //解决 进入明细页面back回来的时候 会再次loaddata
    //  if (typeof($scope.data_loaded) != 'undefined'){
    //    return;
    //  }
    //  else {
    //    $scope.data_loaded = true;
    //  }
    //  essMyOtApplyDSev.clearData();
    //  essMyOtApplyDSev.loadData($stateParams.type,'UC');
    //  //essMyOtApplyDSev.loadOtherData($stateParams.type,'C');
    //  $scope.ess_my_applyD_data = essMyOtApplyDSev.getData();
    //
    //
    //});
    if (ionic.Platform.isIOS()) {
      essMyCardAdjApplyDSev.clearData();
      essMyCardAdjApplyDSev.loadData($stateParams.type,'UC');
      $scope.ess_my_applyD_data = essMyCardAdjApplyDSev.getData();
    } else {
      $scope.$on("$ionicView.enter", function () {
        //解决 进入明细页面back回来的时候 会再次loaddata
        if (typeof($scope.data_loaded) != 'undefined') {
          return;
        }
        else {
          $scope.data_loaded = true;
        }
        essMyCardAdjApplyDSev.clearData();
        essMyCardAdjApplyDSev.loadData($stateParams.type,'UC');
        $scope.ess_my_applyD_data = essMyCardAdjApplyDSev.getData();
      });
    }
	 // essMyOtApplyDSev.clearData();
    //essMyOtApplyDSev.loadData($stateParams.type,'UC');
    //$scope.ess_my_applyD_data = essMyOtApplyDSev.getData();

    $scope.search_control = essMyCardAdjApplyDSev.getSearchValue();

    $scope.show_search = false;
    $scope.toggle_search = function() {
      $scope.show_search = true;
      $ionicScrollDelegate.scrollTop();
    }
    $scope.cancel_search = function() {
      $scope.show_search = false;
      $scope.search_control.search_val = '';
    }

    //$scope._flag = "未完成";
    //
    $scope.noapprove_click=function(){
      //$scope._flag = "未完成";

      document.getElementById('my_apply_details_noapprove').style.color='#53afff';
      document.getElementById('my_apply_details_approved').style.color='#808080';
      document.getElementById('ess_my_apply_details_tab_animate_div').style.webkitTransform='translateX(0)';
      document.getElementById('ess_my_apply_details_wrap').style.webkitTransform='translateX(0)';

      //essMyOtApplyDSev.loadData($stateParams.type,'UC');
      document.getElementById('ess_my_apply_details_wrap').style.overflow="visible";
      document.getElementById('ess_my_apply_details_noapprove_div').setAttribute("style","width:50%;");
      document.getElementById('ess_my_apply_details_approved_div').setAttribute("style","width: 50%;position: absolute;left:50%;top:0px;");
        $timeout(function(){ $ionicScrollDelegate.resize();
          document.getElementById('ess_my_apply_details_wrap').style.overflow="hidden";
        }, 200);



    }
    $scope.approved_click=function(){
      //$scope._flag = "已完成";

      document.getElementById('my_apply_details_noapprove').style.color='#808080';
      document.getElementById('my_apply_details_approved').style.color='#53afff';
      document.getElementById('ess_my_apply_details_tab_animate_div').style.webkitTransform='translateX(100%)';
      document.getElementById('ess_my_apply_details_wrap').style.webkitTransform='translateX(-50%)';
      document.getElementById('ess_my_apply_details_wrap').style.overflow="visible";
      document.getElementById('ess_my_apply_details_noapprove_div').setAttribute("style","width:50%;position: absolute;left:0px;top:0px;");
      document.getElementById('ess_my_apply_details_approved_div').setAttribute("style","width: 50%;float: right");
        $timeout(function(){ $ionicScrollDelegate.resize();
          document.getElementById('ess_my_apply_details_wrap').style.overflow="hidden";
        }, 200);



      //essMyOtApplyDSev.loadData($stateParams.type,'C');
    }
    $scope.loadMyApplyContent=function(p_inst,show_type,task_id,s_t){

      $location.path("home_page/ess_my_card_adj_apply_details_content/"+p_inst+"/"+show_type+"/"+task_id+"/"+s_t+"/my_apply");
    }


  })

  .controller('essMyApprovalDCardAdjCtrl',function($scope,essMyApprovalDCardAdjSev,$stateParams,$ionicModal,$location,$ionicScrollDelegate,$ionicNavBarDelegate,$ionicHistory,$timeout){
    if (ionic.Platform.isIOS()) {
      essMyApprovalDCardAdjSev.clearData();
      essMyApprovalDCardAdjSev.loadData($stateParams.type,'UC');
      $scope.essMyApprovalDCardAdjData = essMyApprovalDCardAdjSev.getData();
    } else {
      $scope.$on("$ionicView.enter", function () {
        //解决 进入明细页面back回来的时候 会再次loaddata
        if (typeof($scope.data_loaded) != 'undefined') {
          return;
        }
        else {
          $scope.data_loaded = true;
        }
        essMyApprovalDCardAdjSev.clearData();
        essMyApprovalDCardAdjSev.loadData($stateParams.type,'UC');
        $scope.essMyApprovalDCardAdjData = essMyApprovalDCardAdjSev.getData();
      });
    }
    //$scope.$on("$ionicView.enter", function () {
    //  //解决 进入明细页面back回来的时候 会再次loaddata
    //  if (typeof($scope.data_loaded) != 'undefined'){
    //    return;
    //  }
    //  else {
    //    $scope.data_loaded = true;
    //  }
    //  essMyApprovalDOTSev.clearData();
    //  essMyApprovalDOTSev.loadData($stateParams.type,'UC');
    //  $scope.essMyApprovalDOTData = essMyApprovalDOTSev.getData();
    //});
    $scope.search_control = essMyApprovalDCardAdjSev.getSearchValue();
    //$scope.search_control.search_val = "";
    $scope.show_search = false;
    $scope.toggle_search = function() {
      $scope.show_search = true;
      $ionicScrollDelegate.scrollTop();
    }
    $scope.cancel_search = function() {
      $scope.show_search = false;
      $scope.search_control.search_val = '';
    }
    $scope.address_icon= local_resource + 'img/icon/address_icon.png';
    $scope.ess_my_approval_details_title=$stateParams.name +"审批";
	 // essMyApprovalDOTSev.clearData();
    //essMyApprovalDOTSev.loadData($stateParams.type,'UC');
    ////essMyApprovalDOTSev.loadOtherData($stateParams.type,'C');
    //$scope.essMyApprovalDOTData = essMyApprovalDOTSev.getData();
    //$scope.essMyApprovalDOTOtherData = essMyApprovalDOTSev.getOtherData();
    $scope._flag="待处理";
    $scope.noapprove_click=function(){
      //essMyApprovalDOTSev.loadData($stateParams.type,'UC');
      $scope._flag="待处理";
      document.getElementById('my_apply_details_noapprove').style.color='#53afff';
      document.getElementById('my_apply_details_approved').style.color='#808080';
      document.getElementById('ess_my_apply_details_tab_animate_div').style.webkitTransform='translateX(0)';
      document.getElementById('ess_my_apply_details_wrap').style.webkitTransform='translateX(0)';
      document.getElementById('ess_my_apply_details_wrap').style.overflow="visible";
      document.getElementById('ess_my_apply_details_noapprove_div').setAttribute("style","width:50%;");
      document.getElementById('ess_my_apply_details_approved_div').setAttribute("style","width: 50%;position: absolute;left:50%;top:0px;");
      $timeout(function(){ $ionicScrollDelegate.resize();
          document.getElementById('ess_my_apply_details_wrap').style.overflow="hidden";
        }, 200);





    }
    $scope.approved_click=function(){
      //essMyApprovalDOTSev.loadData($stateParams.type,'C');
      $scope._flag="已处理";
      document.getElementById('my_apply_details_noapprove').style.color='#808080';
      document.getElementById('my_apply_details_approved').style.color='#53afff';
      document.getElementById('ess_my_apply_details_tab_animate_div').style.webkitTransform='translateX(100%)';
      document.getElementById('ess_my_apply_details_wrap').style.webkitTransform='translateX(-50%)';
      document.getElementById('ess_my_apply_details_wrap').style.overflow="visible";
      document.getElementById('ess_my_apply_details_noapprove_div').setAttribute("style","width:50%;position: absolute;left:0px;top:0px;");
      document.getElementById('ess_my_apply_details_approved_div').setAttribute("style","width: 50%;float: right");
        $timeout(function(){ $ionicScrollDelegate.resize();
          document.getElementById('ess_my_apply_details_wrap').style.overflow="hidden";
        }, 200);


    }
    $scope.loadMyApplyContent=function(p_inst,show_type,task_id,app_status,is_normal_path){

      var my_app_result='';
      if(app_status=="待处理"){
        my_app_result="UC";
      }
      else{
        my_app_result="C";
      }

      $location.path("home_page/ess_my_approval_details_card_adj_content/"+p_inst+"/"+show_type+"/"+task_id+"/"+my_app_result+"/"+is_normal_path+"/my_approval");
    }

  })



    .controller('essMyCardAdjApplyDCCtrl',function($scope,essMyCardAdjApplyDCCSev,essLvApplySev,$stateParams,$ionicModal,$ionicActionSheet,$location,$ionicPopup,$timeout,zoomSlider){


	$scope.img_sign_in_apply_img1 = local_resource + 'img/icon/sign_in_apply_img1.png';
	$scope.img_sign_in_apply_img2 = local_resource + 'img/icon/sign_in_apply_img2.png';
    $scope.dates_line2x = local_resource + 'img/model/dates-line2x.png';
    $scope.icon_apply = local_resource + 'img/model/icon-apply@2x.png';
    $scope.approval_line = local_resource + 'img/model/approval-line@2x.png';
    $scope.icon_confirm = local_resource + 'img/model/icon-confirm@2x.png';
    $scope.icon_noappprove = local_resource + 'img/model/icon-noapprove.png';
    $scope.approval_line_gray = local_resource + 'img/model/approval-line-gray@2x.png';
    $scope.icon_waiting = local_resource + 'img/model/wait_approval.png';
    $scope.icon_wait = local_resource + 'img/model/icon-waiting@2x.png';
    $scope.icon_noapprove =local_resource +'img/model/icon-noapprove.png';
    $scope.approval_line_gray = local_resource + 'img/model/approval-line-gray@2x.png';
    $scope.add_approver = local_resource + 'img/model/add_approver.png';
    $scope.add_approver_ = local_resource + 'img/model/add_approver_.png';
    $scope.notify = local_resource + 'img/icon/notify.png';
    $scope.content_left_icon= local_resource + 'img/icon/content-left-icon.png';

	$scope.$on("$ionicView.enter", function () {
		document.getElementById('ess_my_card_adj_apply_details_content').style.display = "block";
		essMyCardAdjApplyDCCSev.clearData();
		essMyCardAdjApplyDCCSev.loadData($stateParams.p_inst,$stateParams.show_type,$stateParams.task_id,$scope);
		$scope.ess_my_applyDC_data = essMyCardAdjApplyDCCSev.getData();
	});

    var my_app_result='';
    if($stateParams.s_t=="未完成"){
       my_app_result='UC'
    }
    else{
       my_app_result='C'
    }
    $scope.fireEvent = function(i,arr){
      $timeout(function(){
        if(arr[i].action=='拒绝'){
          document.getElementById("approver_list_img"+i).src=$scope.icon_noapprove;
        }
        else if(arr[i].action=='批准'){
          document.getElementById("approver_list_img"+i).src=$scope.icon_confirm;
        }
        if(i==(arr.length-1)){
          document.getElementById("approver_list_img_"+i).style.display="none";
        }
       if(document.getElementById("approver_list_img_"+i)!=null){
         document.getElementById("approver_list_img_"+i).style.height=document.getElementById("approver_list_div" + i).offsetHeight+'px';
         document.getElementById("approver_list_div_"+i).style.height=(document.getElementById("approver_list_div" + i).offsetHeight-16)+'px';
       }
     //if(arr[i].flag=='1'){
     //  document.getElementById("approver_list_img_"+(i-1)).src=$scope.approval_line;
     //}
     //   else if(arr[i].flag=='2'){
     //  document.getElementById("approver_list_img_"+(i-1)).src=$scope.approval_line_gray;
     //}


      }, 0);
    }



    $('#_ess_my_apply_d1').change(function(){
      essMyApplyDetailsContentSev.changeEssLvPolicy($scope.ess_my_applyDC_data.default_lv_code_id);
    });
    $('#_ess_my_apply_d2').change(function(){
      essMyApplyDetailsContentSev.changeEssLvPolicy($scope.ess_my_applyDC_data.default_lv_code_id);
    });
    $('#_ess_my_apply_t1').change(function(){
      essMyApplyDetailsContentSev.changeEssLvPolicy($scope.ess_my_applyDC_data.default_lv_code_id);
    });
    $('#_ess_my_apply_t2').change(function(){
      essMyApplyDetailsContentSev.changeEssLvPolicy($scope.ess_my_applyDC_data.default_lv_code_id);
    });
    $scope.changeEssLvPolicy = function(){
      essMyApplyDetailsContentSev.changeEssLvPolicy($scope.ess_my_applyDC_data.default_lv_code_id);
    }

    $scope.search_val = '';
    $scope.ess_empl_data = [];
    $scope.select_user_id = '';
    $scope.select_notify_id = '';
    $scope.click_flag = 0;
    $scope.essItemCk = function(user_id,img,en){
      var _d = [];
      if($scope.click_flag == 0){
        $scope.select_user_id = user_id;
        _d = $scope.ess_my_applyDC_data.approver_list;
      }else{
        return;
      }
      var _len = _d.length;
      if(_len == 0){
        _d.push({
          img:img,
          name:en,
          user_id:user_id,
          flag:2
        })
      }else{
        _d[_len-1] = {
          img:img,
          name:en,
          user_id:user_id,
          flag:2
        }
      }
      $scope.closeModal();
    }

    $scope.selectList = function(){
      if($scope.click_flag==1){
        var _d = [];
        $scope.select_notify_id = '';
        $scope.ess_my_applyDC_data.notify_list = [];
        for(var i=0;i<$scope.ess_empl_data.length;i++){
          if($scope.ess_empl_data[i].ck){
            $scope.select_notify_id = $scope.select_notify_id + ($scope.ess_empl_data)[i].user_id+',';
            $scope.ess_my_applyDC_data.notify_list.push({
              img:($scope.ess_empl_data)[i].img,
              name:($scope.ess_empl_data)[i].en,
              user_id:($scope.ess_empl_data)[i].user_id,
              flag:1
            });
          }
        }
        $scope.select_notify_id = ($scope.select_notify_id).substring(0,$scope.select_notify_id.length-1);
        $scope.closeModal();
      }
    }

    $ionicModal.fromTemplateUrl('ess-my-apply-empl-modal.html', {
      scope: $scope,
      animation: 'slide-in-up'
    }).then(function(modal) {
      $scope.modal = modal;
    });
    $scope.openModal = function() {
      $scope.search_val = '';
      $scope.click_flag = 0;
      $scope.ess_empl_data = [];
      var _d = $scope.ess_my_applyDC_data.approver_list;
      if(_d.length>0){
        var len = _d.length;
        $scope.select_user_id = _d[len-1].user_id;
      }
      essLvApplySev.loadEssEmplData($scope.select_user_id,$scope.ess_my_applyDC_data.employee_no,$scope.ess_my_applyDC_data.process_instance);
      $scope.ess_empl_data = essLvApplySev.getEssEmplData();
      $scope.modal.show();
    };
    $scope.openModal2 = function() {
      $scope.search_val = '';
      $scope.click_flag = 1;
      $scope.ess_empl_data = [];
      var _d = $scope.ess_my_applyDC_data.notify_list;
      $scope.select_notify_id='';
      for(var i=0;i<_d.length;i++){
        $scope.select_notify_id = $scope.select_notify_id + _d[i].user_id+',';
      }
      $scope.select_notify_id = $scope.select_notify_id.substring(0,$scope.select_notify_id.length-1);
      essLvApplySev.loadEssEmplData($scope.select_notify_id,$scope.ess_my_applyDC_data.employee_no,$scope.ess_my_applyDC_data.process_instance);
      $scope.ess_empl_data = essLvApplySev.getEssEmplData();
      $scope.modal.show();
    };
    $scope.closeModal = function() {
      $scope.modal.hide();
      $scope.ess_empl_data = [];
    };
    //$scope.$on('$destroy', function() {
    //  $scope.modal.remove();
    //});

    $scope.cancel= function () {

			  $ionicPopup.confirm({
				template: '<div style="text-align: center;">确认要撤销吗</div>',
				cancelType:'button-dark',
				cancelText: '取消',
				okText: '确认'
			  }) .then(function(res) {
				if(res) {
					fufuMobclickAgent('click_card_record_adj_apply_cancel');
				  essMyCardAdjApplyDCCSev.submitAction('Cancel',my_app_result);
				}
			  });



    }

  })


    .controller('essMyApprovalDCardAdjContentCtrl',function($emplComponentService,$scope,essMyApprovalDCardAdjContentSev,essLvApplySev,$stateParams,$ionicModal,$ionicActionSheet,$location,$timeout,$ionicPopup,sideSelect,$ionicScrollDelegate,zoomSlider){

	if($stateParams.my_app_result=='C'){
      $scope.app_result=false;
    }
    else{
      $scope.app_result=true;
    }

    $scope.fireEvent = function(i,arr){
      $timeout(function(){
        if(i==arr.length-1&&$scope.ess_my_approvalDC_data.approver_list_flag==false){
          document.getElementById("approver_list_img_"+i).style.display="none";
        }
        if(document.getElementById("approver_list_img_"+i)!=null){
          document.getElementById("approver_list_img_"+i).style.height=document.getElementById("approver_list_div" + i).offsetHeight+'px';
          document.getElementById("approver_list_div_"+i).style.height=(document.getElementById("approver_list_div" + i).offsetHeight-16)+'px';
        }
      }, 0);
    }

    $scope.view_team_at_exception = function(start_date){
		fufuMobclickAgent('click_leave_clash_report');
      if($stateParams.is_normal_path=='true'){
        $location.path("home_page/home_menulist/team_at_exception/"+start_date+"/"+$stateParams.is_normal_path);
      }
      else{
        $location.path("home_page/home_menulist/team_at_exception_msg/"+start_date+"/"+$stateParams.is_normal_path);
      }

    }


	$scope.img_sign_in_apply_img1 = local_resource + 'img/icon/sign_in_apply_img1.png';
	$scope.img_sign_in_apply_img2 = local_resource + 'img/icon/sign_in_apply_img2.png';
    $scope.dates_line2x = local_resource + 'img/model/dates-line2x.png';
    $scope.dates_line4x = local_resource + 'img/model/dates-line2x.png';
    $scope.icon_apply = local_resource + 'img/model/icon-apply@2x.png';
    $scope.approval_line = local_resource + 'img/model/approval-line@2x.png';
    $scope.icon_confirm = local_resource + 'img/model/icon-confirm@2x.png';
    $scope.icon_noappprove = local_resource + 'img/model/icon-noapprove.png';
    $scope.approval_line_gray = local_resource + 'img/model/approval-line-gray@2x.png';
    $scope.icon_waiting = local_resource + 'img/model/wait_approval.png';
    $scope.icon_wait = local_resource + 'img/model/icon-waiting@2x.png';
    $scope.approval_line_gray = local_resource + 'img/model/approval-line-gray@2x.png';
    $scope.add_approver = local_resource + 'img/model/add_approver.png';
    $scope.add_approver_ = local_resource + 'img/model/add_approver_.png';
    $scope.approve_icon= local_resource + 'img/icon/approve_icon.png';
    $scope.read_leave_icon= local_resource + 'img/icon/read_leave_icon.png';
    $scope.notify= local_resource + 'img/icon/notify.png';
    $scope.content_left_icon=local_resource + 'img/icon/content-left-icon.png';
    $scope.is_expand=true;
    $scope.notify_toggle=function(){
      $scope.is_expand=!$scope.is_expand;
    }
	essMyApprovalDCardAdjContentSev.clearData();
    essMyApprovalDCardAdjContentSev.loadData($stateParams.p_inst,$stateParams.show_type,$stateParams.task_id,$stateParams.my_app_result,$scope);
    $scope.ess_my_approvalDC_data = essMyApprovalDCardAdjContentSev.getData();

    $scope.show_img=function(index){
		zoomSlider.show({data:$scope.ess_my_approvalDC_data.attachment_array, index:index})
		return;
		/*
      if (ionic.Platform.isIOS()) {
        window.open(url, '_system', 'enableViewportScale=yes');
      } else {
        window.open(url, '_system');
      }
	  	*/

    }


	$scope.month_adj_content=function(){
		var target_date = '';
		var employee_no = $scope.ess_my_approvalDC_data.employee_no;
		var employee_name = $scope.ess_my_approvalDC_data.approver_list[0].name;
		var from_source = 'approval';
		target_date = $scope.ess_my_approvalDC_data.shift_date.split('-')[0] + '-' + $scope.ess_my_approvalDC_data.shift_date.split('-')[1] + '-01';
		if($stateParams.is_normal_path=='true'){
			$location.path('home_page/card_adj_month/' + target_date + '/' + employee_no + '/' + employee_name + '/' + from_source);
		}
		else{
			$location.path('home_page/card_adj_month_msg/' + target_date + '/' + employee_no + '/' + employee_name + '/' + from_source);
		}
	}
    $scope.search_control={};
    $scope.search_control.search_val = '';
    $scope.ess_empl_data = [];
    $scope.select_user_id = '';
    $scope.select_notify_id = '';
    $scope.click_flag = 0;

    $scope.essItemCk = function(user_id,img,en,_flag){
      if(_flag == true){
        $scope.ess_empl_data.num_checked =  $scope.ess_empl_data.num_checked + 1;
      }else{
        $scope.ess_empl_data.num_checked =  $scope.ess_empl_data.num_checked - 1;
      }
      var _d = [];
      if($scope.click_flag == 0){
        $scope.select_user_id = user_id;
        _d = $scope.ess_my_approvalDC_data.approver_list;
        var flag = 0;
        var _len = _d.length;
        for(var i=0;i<_len;i++){
          if(angular.isDefined(_d[i]._flag)&&_d[i]._flag==1){
            flag = 1;
            break;
          }
        }

        if(flag == 0){
          _d.push({
            img:img,
            name:en,
            user_id:user_id,
            action:'下一层审批人',
            flag:1,
            _flag:1,
            attachment:'',
            approval_remark:'',
            color:"#999"
          })
        }else{
          _d[_len-1] = {
            img:img,
            name:en,
            action:'下一层审批人',
            flag:1,
            user_id:user_id,
            _flag:1,
            attachment:'',
            approval_remark:'',
            color:"#999"
          }
        }

        $scope.closeModal();
      }else{
        var _d = [];
        if($scope.click_flag == 0){
          $scope.select_user_id = user_id;
          _d = $scope.ess_my_approvalDC_data.approver_list;
        }else{
          return;
        }
        var flag = 0;
        var _len = _d.length;
        for(var i=0;i<_len;i++){
          if(angular.isDefined(_d[i].flag)&&_d[i].flag==1){
            flag = 1;
            break;
          }
        }
        if(flag == 0){
          _d.push({
            img:img,
            name:en,
            user_id:user_id,
            flag:1
          })
        }else{
          _d[_len-1] = {
            img:img,
            name:en,
            user_id:user_id,
            flag:1
          }
        }
        $scope.approver_list=_d;
        $scope.search_control.search_val = '';
        $scope.closeModal();
      }
    }
    $scope.delete_notify=function(user_id){

      $('#my_approval_details_card_adj #notify_list_div').addClass('notify_list_active');
      if($scope.select_notify_id.indexOf(',')==-1){
        $scope.select_notify_id=$scope.select_notify_id.replace(user_id,'');
      }
      else if($scope.select_notify_id.indexOf(user_id+',')==-1){
        $scope.select_notify_id=$scope.select_notify_id.replace(','+user_id,'');
      }
      else{
        $scope.select_notify_id=$scope.select_notify_id.replace(user_id+',','');
      }
      for(var i=0;i<$scope.ess_my_approvalDC_data.notify_list.length;i++){
        if($scope.ess_my_approvalDC_data.notify_list[i].user_id==user_id){
          $scope.ess_my_approvalDC_data.notify_list.splice(i,1);
        }
      }
      setTimeout(function(){
        document.getElementById('notify_list_div').style.width=($scope.ess_my_approvalDC_data.notify_list.length+1)*100+20+'px';
        $ionicScrollDelegate.$getByHandle("notify_list_scroll").resize();
      },350)

    }
    $scope.selectList = function(){
      if($scope.click_flag==1){
        var _d = [];
        $scope.select_notify_id = '';
        $scope.ess_my_approvalDC_data.notify_list = [];
        for(var i=0;i<$scope.ess_empl_data.length;i++){
          if($scope.ess_empl_data[i].ck){
            $scope.select_notify_id = $scope.select_notify_id + ($scope.ess_empl_data)[i].user_id+',';
            $scope.ess_my_approvalDC_data.notify_list.push({
              img:($scope.ess_empl_data)[i].img,
              name:($scope.ess_empl_data)[i].en,
              user_id:($scope.ess_empl_data)[i].user_id,
              flag:1
            });
          }
        }
        $scope.select_notify_id = ($scope.select_notify_id).substring(0,$scope.select_notify_id.length-1);
        $scope.closeModal();
      }
      document.getElementById('notify_list_div').style.width=($scope.ess_my_approvalDC_data.notify_list.length+1)*100+20+'px';
      //alert($scope.lv_app_data.notify_list.length);
      $ionicScrollDelegate.$getByHandle("notify_list_scroll").resize();
      $scope.search_control.search_val='';
    }

    $ionicModal.fromTemplateUrl('ess-empl-modal.html', {
      scope: $scope,
      animation: 'slide-in-up'
    }).then(function(modal) {
      $scope.modal = modal;
    });

	/*
    $scope.openModal = function() {
      $scope.search_val = '';
      $scope.click_flag = 0;
      $scope.ess_empl_data = [];
      essMyApprovalDCardAdjContentSev.loadEssEmplData($scope.select_user_id,$scope.ess_my_approvalDC_data.employee_no,$scope.ess_my_approvalDC_data.process_instance);
      $scope.ess_empl_data = essMyApprovalDCardAdjContentSev.getEssEmplData();
      $scope.modal.show();
    };
    $scope.openModal2 = function() {
      $('#essMyApprovalDetailsContent #notify_list_div').removeClass('notify_list_active');
      $scope.search_val = '';
      $scope.click_flag = 1;
      $scope.ess_empl_data = [];
      essMyApprovalDCardAdjContentSev.loadEssEmplData($scope.select_notify_id,$scope.ess_my_approvalDC_data.employee_no,$scope.ess_my_approvalDC_data.process_instance);
      $scope.ess_empl_data = essMyApprovalDCardAdjContentSev.getEssEmplData();

      $scope.modal.show();
    };
	*/

	var routerName = '';
	if (typeof($stateParams.from_source) != 'undefined'){
		if ($stateParams.from_source == 'at_team_record'){
			routerName = 'default';
		}
		else if ($stateParams.from_source == 'my_approval'){
			routerName = 'default';
		}
		else if ($stateParams.from_source == 'home_message'){
			routerName = 'message';
		}
		else if ($stateParams.from_source == 'at_team_record'){
			routerName = 'default';
		}
	}

	$scope.openModal = function() {

		var _d = [];
		_d = $scope.ess_my_approvalDC_data.approver_list;
		var flag = 0;
		var _len = _d.length;

		var flag = 0;
		for(var i=0;i<_len;i++){
		  if(angular.isDefined(_d[i]._flag)&&_d[i]._flag==1){
			flag = 1;
			break;
		  }
		}

		var selectEmplList = '';
		if (flag == 1){
			selectEmplList = _d[_len-1].employee_no;
		}

		$emplComponentService.open({
			title : '选择审批人', //弹开窗口标题
			barTitle : window.localStorage["org_top_level"],//导航开头
			isSingleSelect:true,//是否单选
			isShowContact:true,//是否展示常用联系人
			isNeedSaveContact:true,//是否保存常用联系人
			extName : '员工', //多选时提示后缀名
			selectEmplList:selectEmplList, //打开窗口默认选中员工列表
			routerName: routerName,
			sure : function (rd) { //返回数据，数组格式
				$scope.select_user_id = rd[0].user_id;

				if(flag == 0){
				  _d.push({
					employee_no:rd[0].empl_no,
					img:rd[0].img_src,
					name:rd[0].empl_name,
					user_id:rd[0].user_id,
					action:'下一层审批人',
					flag:1,
					_flag:1,
					attachment:'',
					approval_remark:'',
					color:"#999"
				  })
				}else{
				  _d[_len-1] = {
					employee_no:rd[0].empl_no,
					img:rd[0].img_src,
					name:rd[0].empl_name,
					action:'下一层审批人',
					flag:1,
					user_id:rd[0].user_id,
					_flag:1,
					attachment:'',
					approval_remark:'',
					color:"#999"
				  }
				}

			}
		});


    }

	$scope.openModal2 = function() {
		var selectEmplList = '';
		if ($scope.ess_my_approvalDC_data.notify_list.length != 0){
			for (var i=0;i<$scope.ess_my_approvalDC_data.notify_list.length;i++){
				selectEmplList += $scope.ess_my_approvalDC_data.notify_list[i].employee_no;
				if (i < $scope.ess_my_approvalDC_data.notify_list.length - 1){
					selectEmplList += ',';
				}
			}

		}

		$emplComponentService.open({
			title : '选择知会人', //弹开窗口标题
			barTitle : window.localStorage["org_top_level"],//导航开头
			isSingleSelect:false,//是否单选
			isShowContact:true,//是否展示常用联系人
			isNeedSaveContact:true,//是否保存常用联系人
			extName : '员工', //多选时提示后缀名
			selectEmplList:selectEmplList, //打开窗口默认选中员工列表
			routerName: routerName,
			/*
			params:{ //支持可用扩展参数
				"is_permissions":"0",
				"is_process":"0",
				"process_instance":'0',
				"ext_param":"aa"
			},
			*/
			sure : function (rd) { //返回数据，数组格式
				$('#notify_list_div').removeClass('notify_list_active');
				$scope.select_notify_id = '';
				$scope.ess_my_approvalDC_data.notify_list = [];
				for(var i=0;i<rd.length;i++){

					$scope.select_notify_id = $scope.select_notify_id + rd[i].user_id;
					$scope.ess_my_approvalDC_data.notify_list.push({
					  img:rd[i].img_src,
					  name:rd[i].empl_name,
					  user_id:rd[i].user_id,
					  employee_no:rd[i].empl_no,
					  flag:1
					});
					if (i < rd.length - 1){
						$scope.select_notify_id += ',';
					}
				}

				document.getElementById('notify_list_div').style.width=($scope.ess_my_approvalDC_data.notify_list.length+1)*100+20+'px';
				$ionicScrollDelegate.$getByHandle("notify_list_scroll").resize();
			}
		});

    }

    $scope.closeModal = function() {
      $scope.modal.hide();
      $scope.ess_empl_data = [];
      $scope.search_control.search_val='';
	  document.getElementById('notify_list_div').style.width=($scope.ess_my_approvalDC_data.notify_list.length+1)*100+20+'px';
    };
    $scope.$on('$destroy', function() {
      $scope.modal.remove();
    });


    $scope.submitAction = function(action){
      essMyApprovalDetailsContentSev.submitAction(action);
    }
    $scope.approval_date=[{
      key:'0',
      value:'批准'
    },{
      key:'1',
      value:'驳回'
    }]
    $scope.remark_flag=true;
    $scope.approval_index=0;
    $scope.approval_or_noapproval=function(){
      sideSelect.show({
        type : 'ios',
        data :$scope.approval_date,
        selectIndex :  $scope.approval_index,
        selectedFunc : function (index) {
          if(typeof(index)!='undefined'){
            document.getElementById("approval_answer").innerHTML= $scope.approval_date[index].value;
            index== '0' ? $scope.remark_flag=true : $scope.remark_flag=false;
            $scope.approval_index=index;
          }

        }
      });
    }

    $scope.save=function(){


      if($scope.remark_flag==false&&document.getElementById('leave_approval_remark_textarea').value==''){
        $ionicPopup.alert({
          title: '提醒',
          template: '<div style="text-align: center;">请填写备注</div>',
          okText: '确定'
        })
      }
      else {
        if ($scope.remark_flag) {

			//alert($stateParams.from_source);
          essMyApprovalDCardAdjContentSev.applyApprove($scope.select_user_id,$stateParams.my_app_result,$scope.select_notify_id,$stateParams.from_source);
        }
        else {
          essMyApprovalDCardAdjContentSev.applyReject($scope.select_user_id,$stateParams.my_app_result,$scope.select_notify_id,$stateParams.from_source);
        }
      }
    }

  })

  .controller('CardAdjMonthCtrl',function($scope,CardAdjMonthSev,$stateParams,$ionicModal,$location,$ionicScrollDelegate,$ionicNavBarDelegate,$ionicHistory,$timeout){
	$scope.img_sign_in_apply_img1 = local_resource + 'img/icon/sign_in_apply_img1.png';
	$scope.img_sign_in_apply_img2 = local_resource + 'img/icon/sign_in_apply_img2.png';
	$scope.arrow_up_icon=local_resource + 'img/icon/arrow_up_icon.png';
	$scope.arrow_down_icon=local_resource + 'img/icon/arrow_down_icon.png';

	$scope.toolbar_title = $stateParams.employee_name + '的月补签';
	$scope.from_source = $stateParams.from_source;


	var current_date = new Date();
	current_date.setFullYear($stateParams.target_date.split('-')[0],(parseInt($stateParams.target_date.split('-')[1],10)-1),1);
	$scope.current_date_text=$stateParams.target_date.split("-")[0]+'年'+$stateParams.target_date.split("-")[1]+'月';
	CardAdjMonthSev.clearData();
	CardAdjMonthSev.loadData($stateParams.target_date,$stateParams.employee_no);
	$scope.card_adj_month_data = CardAdjMonthSev.getData();
	$scope._flag=false;
	$scope._flag_first=true;
	$scope.expand_item=function(i){
		if(i==0){
			if($scope._flag_first){

			$("#content_img_up_"+i).css({
				'display':'none'
			});
			$("#content_img_down_"+i).css({
				'display':'block'
			});
			$("#card_adj_month_content_"+i).css({
				'display':'none'
			});
			$ionicScrollDelegate.resize();
		}
		else{
			$("#content_img_up_"+i).css({
				'display':'block'
			});
			$("#content_img_down_"+i).css({
				'display':'none'
			});
			$("#card_adj_month_content_"+i).css({
				'display':'block'
			});
			$ionicScrollDelegate.resize();
		}

		$scope._flag_first=!$scope._flag_first;
		}


		else{
			if($scope._flag){
			$("#content_img_up_"+i).css({
				'display':'none'
			});
			$("#content_img_down_"+i).css({
				'display':'block'
			});
			$("#card_adj_month_content_"+i).css({
				'display':'none'
			});
			$ionicScrollDelegate.resize();
		}
		else{
			$("#content_img_up_"+i).css({
				'display':'block'
			});
			$("#content_img_down_"+i).css({
				'display':'none'
			});
			$("#card_adj_month_content_"+i).css({
				'display':'block'
			});
			$ionicScrollDelegate.resize();
		}

		$scope._flag=!$scope._flag;
		}


	}

	$scope.previous_month = function(){
		current_date.setMonth(current_date.getMonth() - 1);
		current_date_str = (current_date.getFullYear() + '-' + (current_date.getMonth() + 1 < 10 ? '0' + (current_date.getMonth() + 1): (current_date.getMonth() + 1)) + '-' + (current_date.getDate() < 10 ? '0' + (current_date.getDate()): (current_date.getDate())));
		$scope.current_date_text= current_date_str.split("-")[0]+'年'+current_date_str.split("-")[1]+'月';
		CardAdjMonthSev.loadData(current_date_str,$stateParams.employee_no);
	}

	$scope.next_month = function(){
		current_date.setMonth(current_date.getMonth() + 1);
		current_date_str = (current_date.getFullYear() + '-' + (current_date.getMonth() + 1 < 10 ? '0' + (current_date.getMonth() + 1): (current_date.getMonth() + 1)) + '-' + (current_date.getDate() < 10 ? '0' + (current_date.getDate()): (current_date.getDate())));
		$scope.current_date_text= current_date_str.split("-")[0]+'年'+current_date_str.split("-")[1]+'月';
		CardAdjMonthSev.loadData(current_date_str,$stateParams.employee_no);
	}

  })


  .controller('cardAdjTeamRecordCtrl',function($scope,$stateParams,cardAdjTeamRecordSev,$ionicNavBarDelegate,$ionicHistory,$location,$timeout,timeSelect,$ionicScrollDelegate,$deptComponentSer){
	$scope.img_at_team_record_icon = local_resource + 'img/icon/at_team_record_icon.png';

  	if(window.localStorage['_role_name']=='ess'){
		$scope.is_show_picklist = false;
	} else {
		$scope.is_show_picklist = true;
	}
	var today_date = new Date();
	var current_date = new Date();
	var today_date_str = (today_date.getFullYear() + '-' + (today_date.getMonth() + 1 < 10 ? '0' + (today_date.getMonth() + 1): (today_date.getMonth() + 1)) + '-' + (today_date.getDate() < 10 ? '0' + (today_date.getDate()): (today_date.getDate())));
	var current_date_str = '';
	current_date.setFullYear(today_date_str.split('-')[0],(parseInt(today_date_str.split('-')[1],10)-1),1);
    current_date_str = (current_date.getFullYear() + '-' + (current_date.getMonth() + 1 < 10 ? '0' + (current_date.getMonth() + 1): (current_date.getMonth() + 1)) + '-' + (current_date.getDate() < 10 ? '0' + (current_date.getDate()): (current_date.getDate())));
	$scope.current_date_text= current_date_str.split("-")[0]+'年'+current_date_str.split("-")[1]+'月';
	$scope.today_date_text= current_date_str.split("-")[0]+'年'+current_date_str.split("-")[1]+'月';
	$scope.current_tab = '1';
	$scope.is_show_search = true;

	$scope.card_adj_team_record_dept_picklist = function(){

		$deptComponentSer.open({
			title : '选择部门', //标题
			//barTitle : '施特伟科技有限公司',//导航标题
			barTitle : '组织架构',
			isSingleSelect:false, //是否单选
			isInherit:true, //是否选父带子
			selectNodeList:$scope.card_adj_team_record_data.data1.dept_id, //默认选中部门节点
			params:{ //加载扩展参数
				"is_permissions":"1",
				"is_process":"0"
			},
			extName : '部门(含子部门)', //多选显示扩展后缀名
			sure : function (rd) { //确认返回接口，数组
				if (rd.length == 0){
					document.getElementById('card_adj_team_record_dept_picklist').innerHTML = '请选择部门';
					$scope.card_adj_team_record_data.data1.dept_id = '0';
				}
				else if (rd.length == 1){
					document.getElementById('card_adj_team_record_dept_picklist').innerHTML = rd[0].name;
					$scope.card_adj_team_record_data.data1.dept_id = rd[0].id;
				}
				else {
					document.getElementById('card_adj_team_record_dept_picklist').innerHTML = rd.length + '个部门(含子部门)';
					$scope.card_adj_team_record_data.data1.dept_id = '';
					for (var i=0;i<rd.length;i++){
						$scope.card_adj_team_record_data.data1.dept_id = $scope.card_adj_team_record_data.data1.dept_id + rd[i].id;
						if (i < rd.length - 1){
							$scope.card_adj_team_record_data.data1.dept_id = $scope.card_adj_team_record_data.data1.dept_id + ',';
						}
					}
				}
				cardAdjTeamRecordSev.loadData(current_date_str,$scope.card_adj_team_record_data.data1.dept_id);

			}
		});
	}

    $scope.card_adj_team_record_detail_by_type = function(){
		var target_date = (current_date.getFullYear() + '-' + (current_date.getMonth() + 1 < 10 ? '0' + (current_date.getMonth() + 1): (current_date.getMonth() + 1)) + '-' + (current_date.getDate() < 10 ? '0' + (current_date.getDate()): (current_date.getDate())));
		var type = 'outdoor';
		var type_name = '忘记打卡';
		var dept_id = '0';
		$location.path('home_page/card_adj_team_record_detail_by_type/' + target_date + '/' + type + '/' + type_name + '/' + dept_id);
    }

    $scope.select_date = function(){
      timeSelect.show({
        type :  'yearsMonth',
        startDate : '2000年01月01日',
        endDate : $scope.today_date_text,
        defaultDate: $scope.current_date_text,
        returnDateType : 'ymd',
        returnTimeType :  '24h'||'AMPM',
        //stepping :10,
        selectedFunc : function (date) {

          if(typeof(date)=='undefined'){
          }
          else{
				current_date.setFullYear(parseInt(date.slice(0,4),10),(parseInt(date.slice(5,7),10)-1),1);
				current_date_str = (current_date.getFullYear() + '-' + (current_date.getMonth() + 1 < 10 ? '0' + (current_date.getMonth() + 1): (current_date.getMonth() + 1)) + '-' + (current_date.getDate() < 10 ? '0' + (current_date.getDate()): (current_date.getDate())));
				$scope.current_date_text= current_date_str.split("-")[0]+'年'+current_date_str.split("-")[1]+'月';
				cardAdjTeamRecordSev.loadData(current_date_str,$scope.card_adj_team_record_data.data1.dept_id);
          }
        }
      });
    }

	function details_div_click(){
		if (document.getElementById('details_div').style.backgroundColor == 'white'){
			return;
		}

		$scope.is_show_search = true;
		$('#card_adj_team_record .card_adj_team_record_content').css({"top":"110px"});
		$('.platform-android.platform-cordova #card_adj_team_record .card_adj_team_record_content').css({"top":"90px"});
		$scope.show_search = false;
		$ionicScrollDelegate.resize();
        $timeout(function(){ $ionicScrollDelegate.resize();
          $scope.search_control.search_val = '';
        }, 1000);



        document.getElementById('details_div').style.color='#53afff';
        document.getElementById('details_div').style.backgroundColor='white';
        document.getElementById('details_div').style.border='none';
        document.getElementById('statistics_div').style.color='white';
        document.getElementById('statistics_div').style.backgroundColor='#53afff';
        document.getElementById('statistics_div').style.border='1px solid white';
        document.getElementById('statistics_div').style.borderLeft='none';
        //document.getElementById('details_content_div').style.display="block";
        //document.getElementById('statistics_content_div').style.display="none";
        document.getElementById('card_adj_team_record_wrap').style.webkitTransform='translateX(0)';
        //OtTeamRecordSev.loadData(_date,$scope);
        //$scope.ot_team_record_data = OtTeamRecordSev.getData();
        for(var i=0;i<document.getElementsByClassName('details_cls').length;i++){
          document.getElementsByClassName('details_cls')[i].style.display='block';
          document.getElementsByClassName('statistics_cls')[i].style.display='none';
        }
        document.getElementById('details_content_div').setAttribute("style","width:50%;");
        document.getElementById('statistics_content_div').setAttribute("style","width: 50%;position: absolute;left:50%;top:0px;");
        document.getElementById('card_adj_team_record_wrap').style.overflow='visible';
        $timeout(function(){ $ionicScrollDelegate.resize();
          document.getElementById('card_adj_team_record_wrap').style.overflow='hidden';
        }, 200);
	}

	function statistics_div_click(){
		if (document.getElementById('statistics_div').style.backgroundColor == 'white'){
			return;
		}

		$scope.is_show_search = false;
		$('#card_adj_team_record .card_adj_team_record_content').css({"top":"110px"});
		$('.platform-android.platform-cordova #card_adj_team_record .card_adj_team_record_content').css({"top":"90px"});
		$scope.show_search = false;
		$ionicScrollDelegate.resize();
        $timeout(function(){ $ionicScrollDelegate.resize();
          $scope.search_control.search_val = '';
        }, 1000);


        document.getElementById('statistics_div').style.color='#53afff';
        document.getElementById('statistics_div').style.backgroundColor='white';
        document.getElementById('statistics_div').style.border='none';
        document.getElementById('details_div').style.color='white';
        document.getElementById('details_div').style.backgroundColor='#53afff';
        document.getElementById('details_div').style.border='1px solid white';
        document.getElementById('details_div').style.borderRight='none';
        //document.getElementById('details_content_div').style.display="none";
        //document.getElementById('statistics_content_div').style.display="block";
        //OtTeamRecordSev.loadStatisticsData(_date,$scope);
        document.getElementById('card_adj_team_record_wrap').style.webkitTransform='translateX(-50%)';

        for(var i=0;i<document.getElementsByClassName('details_cls').length;i++){
          document.getElementsByClassName('details_cls')[i].style.display='none';
          document.getElementsByClassName('statistics_cls')[i].style.display='block';
        }
          document.getElementById('details_content_div').setAttribute("style","width:50%;position: absolute;left:0px;top:0px;");
          document.getElementById('statistics_content_div').setAttribute("style","width: 50%;float: right");
          document.getElementById('card_adj_team_record_wrap').style.overflow='visible';
          $timeout(function(){ $ionicScrollDelegate.resize();
            document.getElementById('card_adj_team_record_wrap').style.overflow='hidden';
          }, 200);
	}

    $scope.$on("$ionicView.enter", function () {

        //解决 进入明细页面back回来的时候 会再次loaddata
        if (typeof($scope.data_loaded) == 'undefined') {
			$scope.data_loaded = true;
			cardAdjTeamRecordSev.clearData();
			cardAdjTeamRecordSev.loadData(current_date_str,'0');
			$scope.card_adj_team_record_data = cardAdjTeamRecordSev.getData();
        }

		if (document.getElementById('details_div').onclick == null){
			  document.getElementById('details_div').onclick=function(){
				  details_div_click();
				  $scope.current_tab = '1';
			  }
			  document.getElementById('statistics_div').onclick=function(){
				statistics_div_click();
				$scope.current_tab = '2';
			  }

			if ($scope.current_tab == '2'){
			  statistics_div_click();
			}
		}

    });
	  $scope.cardAdjTeamRecordBack=function(){

		  $ionicHistory.goBack();
		cardAdjTeamRecordSev.clearStatusBar();
	}


    $scope.search_control = {};
    $scope.search_control.search_val = "";
    $scope.contract_management_directory1 = local_resource + 'img/icon/contract_management_directory1.png';
    $scope.is_pc_icon= local_resource + 'img/icon/is_pc_icon.png';
    $scope.show_search = false;
    $scope.toggle_search = function() {
		$('#card_adj_team_record .card_adj_team_record_content').css({"top":"154px"});
		$('.platform-android.platform-cordova #card_adj_team_record .card_adj_team_record_content').css({"top":"134px"});
		$scope.show_search = true;
		$ionicScrollDelegate.resize();
    }
    $scope.cancel_search = function() {
		$('#card_adj_team_record .card_adj_team_record_content').css({"top":"110px"});
		$('.platform-android.platform-cordova #card_adj_team_record .card_adj_team_record_content').css({"top":"90px"});
		$scope.show_search = false;
		$scope.search_control.search_val = '';
		$ionicScrollDelegate.resize();
    }






	$scope.month_adj_content=function(employee_no,employee_name){
		var target_date =(current_date.getFullYear() + '-' + (current_date.getMonth() + 1 < 10 ? '0' + (current_date.getMonth() + 1): (current_date.getMonth() + 1)) + '-' + (current_date.getDate() < 10 ? '0' + (current_date.getDate()): (current_date.getDate())));

		var from_source = 'team_record';
		//target_date = $scope.card_adj_team_record_data.shift_date.split('-')[0] + '-' + $scope.card_adj_team_record_data.shift_date.split('-')[1] + '-01';

		$location.path('home_page/card_adj_month/' + target_date + '/' + employee_no + '/' + employee_name + '/' + from_source);

	}


  })

  .controller('cardAdjTeamRecordDetailByTypeCtrl',function($scope,cardAdjTeamRecordDetailByTypeSev,$stateParams,$ionicModal,$location,$ionicScrollDelegate,$ionicNavBarDelegate,$ionicHistory,$timeout){
	$scope.target_date_text= $stateParams.target_date.split("-")[0]+'年'+$stateParams.target_date.split("-")[1]+'月';

	window.test_click=function(){

	}

    $scope.$on("$ionicView.enter", function () {
        //解决 进入明细页面back回来的时候 会再次loaddata
        if (typeof($scope.data_loaded) != 'undefined') {
          return;
        }
        else {
          $scope.data_loaded = true;
        }
        cardAdjTeamRecordDetailByTypeSev.clearData();
        cardAdjTeamRecordDetailByTypeSev.loadData($stateParams.target_date,$stateParams.dept_id,$stateParams.type_name);
        $scope.detail_by_type_data = cardAdjTeamRecordDetailByTypeSev.getData();
		document.getElementById('cardAdjTeamRecordDetailByTypeTitle').innerHTML = $stateParams.type_name + '补签明细';
    });


    $scope.card_adj_month_by_type = function(employee_no,employee_name){
		var target_date = $stateParams.target_date;
		var type = $stateParams.type;
		var type_name = $stateParams.type_name;
		$location.path('home_page/card_adj_month_by_type/' + target_date + '/' + employee_no + '/' + type + '/' + type_name + '/' + employee_name);
    }

    $scope.search_control = cardAdjTeamRecordDetailByTypeSev.getSearchValue();

    $scope.show_search = false;
    $scope.toggle_search = function() {
      $scope.show_search = true;
      $ionicScrollDelegate.scrollTop();
    }
    $scope.cancel_search = function() {
      $scope.show_search = false;
      $scope.search_control.search_val = '';
    }


  })


  .controller('CardAdjMonthByTypeCtrl',function($scope,CardAdjMonthSev,$stateParams,$ionicModal,$location,$ionicScrollDelegate,$ionicNavBarDelegate,$ionicHistory,$timeout){
	$scope.img_sign_in_apply_img1 = local_resource + 'img/icon/sign_in_apply_img1.png';
	$scope.img_sign_in_apply_img2 = local_resource + 'img/icon/sign_in_apply_img2.png';
	$scope.arrow_up_icon=local_resource + 'img/icon/arrow_up_icon.png';
	$scope.arrow_down_icon=local_resource + 'img/icon/arrow_down_icon.png';

	$scope.toolbar_title = $stateParams.employee_name + '的补签明细';
	$scope.from_source = 'card_adj_team_record_detail_by_type';

	$scope.employee_name = $stateParams.employee_name;
	$scope.type_name = $stateParams.type_name;

	var current_date = new Date();
	current_date.setFullYear($stateParams.target_date.split('-')[0],(parseInt($stateParams.target_date.split('-')[1],10)-1),1);
	$scope.current_date_text=$stateParams.target_date.split("-")[0]+'年'+$stateParams.target_date.split("-")[1]+'月';
	CardAdjMonthSev.clearData();
	CardAdjMonthSev.loadByTypeData($stateParams.target_date,$stateParams.employee_no,$stateParams.type_name);
	$scope.card_adj_month_data = CardAdjMonthSev.getData();
	$scope._flag=false;
	/*$scope.expand_item=function(i){
		if($scope._flag){
			$("#content_img_up_"+i).css({
				'display':'none'
			});
			$("#content_img_down_"+i).css({
				'display':'block'
			});
			$("#card_adj_month_content_"+i).css({
				'display':'none'
			});
			$ionicScrollDelegate.resize();
		}
		else{
			$("#content_img_up_"+i).css({
				'display':'block'
			});
			$("#content_img_down_"+i).css({
				'display':'none'
			});
			$("#card_adj_month_content_"+i).css({
				'display':'block'
			});
			$ionicScrollDelegate.resize();
		}

		$scope._flag=!$scope._flag;
	}
*/


	$scope.expand_item=function(i){
		if(i==0){
			if($scope._flag_first){

			$("#content_img_up_"+i).css({
				'display':'block'
			});
			$("#content_img_down_"+i).css({
				'display':'none'
			});
			$("#card_adj_month_content_"+i).css({
				'display':'block'
			});
			$ionicScrollDelegate.resize();
		}
		else{
			$("#content_img_up_"+i).css({
				'display':'none'
			});
			$("#content_img_down_"+i).css({
				'display':'block'
			});
			$("#card_adj_month_content_"+i).css({
				'display':'none'
			});
			$ionicScrollDelegate.resize();
		}

		$scope._flag_first=!$scope._flag_first;
		}


		else{
			if($scope._flag){
			$("#content_img_up_"+i).css({
				'display':'none'
			});
			$("#content_img_down_"+i).css({
				'display':'block'
			});
			$("#card_adj_month_content_"+i).css({
				'display':'none'
			});
			$ionicScrollDelegate.resize();
		}
		else{
			$("#content_img_up_"+i).css({
				'display':'block'
			});
			$("#content_img_down_"+i).css({
				'display':'none'
			});
			$("#card_adj_month_content_"+i).css({
				'display':'block'
			});
			$ionicScrollDelegate.resize();
		}

		$scope._flag=!$scope._flag;
		}


	}




	$scope.previous_month = function(){
		current_date.setMonth(current_date.getMonth() - 1);
		current_date_str = (current_date.getFullYear() + '-' + (current_date.getMonth() + 1 < 10 ? '0' + (current_date.getMonth() + 1): (current_date.getMonth() + 1)) + '-' + (current_date.getDate() < 10 ? '0' + (current_date.getDate()): (current_date.getDate())));
		$scope.current_date_text= current_date_str.split("-")[0]+'年'+current_date_str.split("-")[1]+'月';
		CardAdjMonthSev.loadData(current_date_str,$stateParams.employee_no);
	}

	$scope.next_month = function(){
		current_date.setMonth(current_date.getMonth() + 1);
		current_date_str = (current_date.getFullYear() + '-' + (current_date.getMonth() + 1 < 10 ? '0' + (current_date.getMonth() + 1): (current_date.getMonth() + 1)) + '-' + (current_date.getDate() < 10 ? '0' + (current_date.getDate()): (current_date.getDate())));
		$scope.current_date_text= current_date_str.split("-")[0]+'年'+current_date_str.split("-")[1]+'月';
		CardAdjMonthSev.loadData(current_date_str,$stateParams.employee_no);
	}

  })

  .controller('homeMessageCardNoticeCtrl',function($scope,homeMessageCardNoticeSev,$stateParams,$ionicModal,$location,$ionicScrollDelegate,$ionicNavBarDelegate,$ionicHistory,$timeout){
	$scope.home_message_icon_secretary = local_resource +'img/icon/secretary.png';
	$scope.no_notices=local_resource + 'img/icon/no_notices.png';
	$scope.message_left_icon=local_resource + 'img/icon/message_left_icon.png';
	$scope.timeline=local_resource +'img/icon/Timeline.png';
	//alert(window.localStorage["message_card_notice_detail_data" + window.localStorage['_user_name']]);

    if (ionic.Platform.isIOS()) {
		homeMessageCardNoticeSev.clearData();
		homeMessageCardNoticeSev.loadData();
		$scope.homeMessageCardNoticeData = homeMessageCardNoticeSev.getData();
    } else {
      $scope.$on("$ionicView.enter", function () {
        //解决 进入明细页面back回来的时候 会再次loaddata
        if (typeof($scope.data_loaded) != 'undefined') {
          return;
        }
        else {
          $scope.data_loaded = true;
        }
		homeMessageCardNoticeSev.clearData();
		homeMessageCardNoticeSev.loadData();
		$scope.homeMessageCardNoticeData = homeMessageCardNoticeSev.getData();
      });
    }

	$scope.redirect_to_sign_in = function(){
		$ionicHistory.clearHistory();
		$location.path('home_page/at_sign_in_new');
	}

	$scope.redirect_to_setting = function(){
		$location.path('home_page/message_setting_msg');
	}

  })

  .controller('homeMessageSecretaryCtrl',function($scope,homeMessageSecretarySev,$stateParams,$ionicModal,$location,$ionicScrollDelegate,$ionicNavBarDelegate,$ionicHistory,$timeout){
	$scope.home_message_icon_secretary = local_resource +'img/icon/secretary.png';
	$scope.no_notices=local_resource + 'img/icon/no_notices.png';
	$scope.message_left_icon=local_resource + 'img/icon/message_left_icon.png';
	$scope.timeline=local_resource +'img/icon/Timeline.png';
	$scope.search_control = homeMessageSecretarySev.getSearchValue();

    if (ionic.Platform.isIOS()) {
		homeMessageSecretarySev.clearData();
		homeMessageSecretarySev.loadData();
		$scope.homeMessageSecretaryDate = homeMessageSecretarySev.getData();
    } else {
      $scope.$on("$ionicView.enter", function () {
        //解决 进入明细页面back回来的时候 会再次loaddata
        if (typeof($scope.data_loaded) != 'undefined') {
          return;
        }
        else {
          $scope.data_loaded = true;
        }
		homeMessageSecretarySev.clearData();
		homeMessageSecretarySev.loadData();
		$scope.homeMessageSecretaryDate = homeMessageSecretarySev.getData();
      });
    }
	$scope.home_message_secretary_detail=function(notice_id,title){
		$location.path('home_page/home_message_secretary_detail/'+notice_id+"/"+title);
	}
  })

  .controller('homeMessageSecretaryDetailCtrl',function($scope,homeMessageSecretaryDetailSev,$stateParams,$ionicModal,$location,$ionicScrollDelegate,$ionicNavBarDelegate,$ionicHistory,$timeout){
	$scope.home_message_icon_secretary = local_resource +'img/icon/secretary.png';
	$scope.no_notices=local_resource + 'img/icon/no_notices.png';
	$scope.message_left_icon=local_resource + 'img/icon/message_left_icon.png';
	$scope.timeline=local_resource +'img/icon/Timeline.png';
	$scope.search_control = homeMessageSecretaryDetailSev.getSearchValue();
	$scope.home_message_secretary_detail_title=$stateParams.title;
    if (ionic.Platform.isIOS()) {
		homeMessageSecretaryDetailSev.clearData();
		homeMessageSecretaryDetailSev.loadData($stateParams.notice_id);
		$scope.homeMessageSecretaryDetailDate = homeMessageSecretaryDetailSev.getData();
    } else {
      $scope.$on("$ionicView.enter", function () {
        //解决 进入明细页面back回来的时候 会再次loaddata
        if (typeof($scope.data_loaded) != 'undefined') {
          return;
        }
        else {
          $scope.data_loaded = true;
        }
		homeMessageSecretaryDetailSev.clearData();
		homeMessageSecretaryDetailSev.loadData($stateParams.notice_id);
		$scope.homeMessageSecretaryDate = homeMessageSecretaryDetailSev.getData();
      });
    }

  })

  .controller('homeMessageSystemCtrl',function($scope,homeMessageSystemSev,$stateParams,$ionicModal,$location,$ionicScrollDelegate,$ionicNavBarDelegate,$ionicHistory,$timeout){
	$scope.no_notices=local_resource + 'img/icon/no_notices.png';
	$scope.message_left_icon=local_resource + 'img/icon/message_left_icon.png';
	$scope.timeline=local_resource +'img/icon/Timeline.png';
	$scope.system_icon=local_resource + 'img/icon/system.png';
	$scope.search_control = homeMessageSystemSev.getSearchValue();

    if (ionic.Platform.isIOS()) {
		homeMessageSystemSev.clearData();
		homeMessageSystemSev.loadData();
		$scope.homeMessageSystemDate = homeMessageSystemSev.getData();
    } else {
      $scope.$on("$ionicView.enter", function () {
        //解决 进入明细页面back回来的时候 会再次loaddata
        if (typeof($scope.data_loaded) != 'undefined') {
          return;
        }
        else {
          $scope.data_loaded = true;
        }
		homeMessageSystemSev.clearData();
		homeMessageSystemSev.loadData();
		$scope.homeMessageSystemDate = homeMessageSystemSev.getData();
      });
    }
  })

  .controller('homeMessageNoticeCtrl',function($scope,homeMessageNoticeSev,$stateParams,$ionicModal,$location,$ionicScrollDelegate,$ionicNavBarDelegate,$ionicHistory,$timeout){
	//$scope.notice_title="通知公告";

	if(window.localStorage['_role_name']!='ess'){
	$timeout(function(){
	document.getElementById("home_message_notice_nav_bar_div").style.display="block";
	document.getElementById("home_message_notice_nav_bar_text").style.display="none";
	document.getElementById("homeMessageNoticeCreateDiv").style.display="block";

	},100)

	}
	else{
	$timeout(function(){
	document.getElementById("home_message_notice_nav_bar_div").style.display="none";
	document.getElementById("home_message_notice_nav_bar_text").style.display="block";
	document.getElementById("homeMessageNoticeCreateDiv").style.display="none";
	},100)
	}


	if (ionic.Platform.isIOS()) {
	$scope.is_ios_height=25;
	$scope.is_ios_back_top=20;
	$scope.is_ios_text_top=27;
	}else{
	$scope.is_ios_height=5;
	$scope.is_ios_back_top=0;
	$scope.is_ios_text_top=7;
	}
	$scope.draft_icon=local_resource + 'img/icon/draft_icon.png';
	$scope.no_notices=local_resource + 'img/icon/no_notices.png';
	$scope.timeline=local_resource +'img/icon/Timeline.png';


	//$scope.notice_title=$scope.content_data.title_html;

	$scope.home_message_notice_tap='1';
	$scope.details_click=function(){
		$scope.home_message_notice_tap='1';
		document.getElementById('details_div').style.color='#53afff';
        document.getElementById('details_div').style.backgroundColor='white';
        document.getElementById('details_div').style.border='none';
        document.getElementById('statistics_div').style.color='white';
        document.getElementById('statistics_div').style.backgroundColor='#53afff';
        document.getElementById('statistics_div').style.border='1px solid white';
        document.getElementById('statistics_div').style.borderLeft='none';
		document.getElementById('home_message_notice_wrap').style.webkitTransform='translateX(0)';
		document.getElementById('home_message_notice_wrap').style.overflow="visible";
		document.getElementById('home_message_notice_receive_div').setAttribute("style","width:50%;");
		document.getElementById('home_message_notice_create_div').setAttribute("style","width: 50%;position: absolute;left:50%;top:0px;");
		$timeout(function(){ $ionicScrollDelegate.resize();
		  document.getElementById('home_message_notice_wrap').style.overflow="hidden";
		}, 200);
		$scope.end_of_list.status=false;
		$ionicScrollDelegate.scrollTop();
	}
		$scope.statistics_click=function(){
			$scope.home_message_notice_tap='2';
		document.getElementById('statistics_div').style.color='#53afff';
        document.getElementById('statistics_div').style.backgroundColor='white';
        document.getElementById('statistics_div').style.border='none';
        document.getElementById('details_div').style.color='white';
        document.getElementById('details_div').style.backgroundColor='#53afff';
        document.getElementById('details_div').style.border='1px solid white';
        document.getElementById('details_div').style.borderRight='none';

		document.getElementById('home_message_notice_wrap').style.webkitTransform='translateX(-50%)';
		document.getElementById('home_message_notice_wrap').style.overflow="visible";
		document.getElementById('home_message_notice_receive_div').setAttribute("style","width:50%;position: absolute;left:0px;top:0px;");
		document.getElementById('home_message_notice_create_div').setAttribute("style","width: 50%;float: right");
        $timeout(function(){ $ionicScrollDelegate.resize();
          document.getElementById('home_message_notice_wrap').style.overflow="hidden";
        }, 200);
		$scope.end_of_list.status=false;
		$ionicScrollDelegate.scrollTop();
	}

	$scope.loadMoreEmployeeData=function(){
		homeMessageNoticeSev.loadMoreData($scope,$scope.home_message_notice_tap);
	}
	$scope.end_of_list=homeMessageNoticeSev.getEndOfList();

    if (ionic.Platform.isIOS()) {

		homeMessageNoticeSev.clearData();
		homeMessageNoticeSev.loadData();
		$scope.content_data = homeMessageNoticeSev.getData();
    } else {

      $scope.$on("$ionicView.enter", function () {
        //解决 进入明细页面back回来的时候 会再次loaddata
        if (typeof($scope.data_loaded) != 'undefined') {
          return;
        }
        else {
          $scope.data_loaded = true;
        }
		homeMessageNoticeSev.clearData();
		homeMessageNoticeSev.loadData();
		$scope.content_data = homeMessageNoticeSev.getData();
      });
    }


	$scope.home_message_notice_detail = function(id,title,notice_date){

	if(notice_date==''){

		$ionicHistory.clearCache().then(function(){
			$location.path("home_page/home_message_notice_draft/"+id+"/" + title);
		});

	}
	else{

		$location.path("home_page/home_message_notice_detail/"+id+"/" + title);
	}
	}

	$scope.home_message_notice_create = function(){

		$ionicHistory.clearCache().then(function(){
			$location.path("home_page/home_message_notice_create");
		});

	}

  })

  .controller('homeMessageNoticeDetailCtrl',function($scope,homeMessageNoticeDetailSev,$stateParams,$ionicModal,$location,$ionicScrollDelegate,$ionicNavBarDelegate,$ionicHistory,$timeout,$ionicActionSheet,homeMessageNoticeCreateSev,$ionicPopup,zoomSlider){

	$scope.toolbar_title = $stateParams.toolbar_title;
	homeMessageNoticeDetailSev.clearData();
	homeMessageNoticeDetailSev.loadData($stateParams.notice_id);
	$scope.home_message_notice_details_data = homeMessageNoticeDetailSev.getData();


  $scope.showImage = function(url){

    zoomSlider.show({data:[url], index:0})
  }
	$scope.home_message_notice_create_submit=function(){
		  /*var hideSheet = $ionicActionSheet.show({
			buttons: [

			  {
				text: '预览'
			  }, {
				text: '发布'
			  }
			],

			//titleText: 'Modify your album',
			//titleText: '选择上传图片方式',
			cancelText: '取消',
			//destructiveText: 'Delete',
			cancel: function() {
			  // add cancel code..
			},
			buttonClicked: function(index) {

			  if (index == 0) {

				return true;
			  } else if (index == 1) {
				homeMessageNoticeCreateSev.saveNotice()
				return true;
			  }
			  return true;
			}
		  });
		  */
        $ionicPopup.confirm({
          title:'',
          template: '<div style="font-size:16px;text-align:center;">确认发布吗</div>',
          cancelType: 'button-dark',
          cancelText: '取消',
          cssClass:'at_sign_in_new_popup',
          okText: '确定'
        }).then(function (res) {
          if (res) {
			if($scope.is_require_upload){
				homeMessageNoticeCreateSev.publishNoticeWithPhoto();
			}
			else{
				homeMessageNoticeCreateSev.publishNotice();
			}

          }

        });
	}

	$scope.home_message_notice_create_cancel=function(){
		  var hideSheet = $ionicActionSheet.show({
			buttons: [

			  {
				text: '暂存草稿'
			  }
			],

			//titleText: 'Modify your album',
			//titleText: '选择上传图片方式',
			cancelText: '取消',
			destructiveText: '返回',
			cancel: function() {
			  // add cancel code..
			},
			buttonClicked: function(index) {

			  if (index == 0) {

			if($scope.is_require_upload){
				homeMessageNoticeCreateSev.saveNoticeWithPhoto();
			}
			else{
			homeMessageNoticeCreateSev.saveNotice();
			}

				return true;
			  }
			  return true;
			},
			destructiveButtonClicked: function(){
				$ionicHistory.goBack();
				return true;
			}
		  });
	}
  })


  .controller('homeMessageNoticeDraftCtrl',function($deptComponentSer,$emplComponentService,$scope,homeMessageNoticeDraftSev,$stateParams,$ionicModal,$location,$ionicScrollDelegate,$ionicNavBarDelegate,$ionicHistory,$timeout,$ionicActionSheet,homeMessageNoticeCreateSev,$ionicPopup){
	$scope.home_message_earth_icon=local_resource + 'img/icon/home_message_earth_icon.png';
	window.notice_draft_auto_grow =function (element) {

    element.style.height = "5px";
    element.style.height = (element.scrollHeight + 20)+"px";
}

	if (ionic.Platform.isIOS()) {
	$scope.sroll_height=parseInt(window.screen.height)-64;
	$scope.textarea_height=parseInt(window.screen.height)-409;
	}else{
	$scope.sroll_height=parseInt(window.screen.height)-44;
	$scope.textarea_height=parseInt(window.screen.height)-389;
	}

	$scope.toolbar_title = $stateParams.toolbar_title;
	homeMessageNoticeDraftSev.clearData();
	homeMessageNoticeDraftSev.loadData($stateParams.notice_id,$scope);
	$scope.home_message_notice_details_data = homeMessageNoticeDraftSev.getData();

	//$scope.type_status = 'public';
	//$scope.target_id_list = '';
	//$scope.receiver_type = 'dept';

	$scope.receiver_type_picklist=function(){
		  var hideSheet = $ionicActionSheet.show({
			buttons: [
			  {
				text: '全体员工'
			  },
			  {
				text: '按部门发布'
			  }, {
				text: '按员工发布'
			  }
			],

			//titleText: 'Modify your album',
			//titleText: '选择上传图片方式',
			cancelText: '取消',
			//destructiveText: 'Delete',
			cancel: function() {
			  // add cancel code..
			},
			buttonClicked: function(index) {
				if (index == 0) {
					$scope.type_status = 'public';
					$scope.target_id_list = '';
					$scope.receiver_type = 'dept';
					document.getElementById('home_message_notice_draft_target').innerHTML = '全体员工';
				}
				else if (index == 1) {
					var temp_target_id_list = $scope.target_id_list;
					if ($scope.receiver_type != 'dept'){
						temp_target_id_list = '';
					}
					$deptComponentSer.open({
						title : '选择部门', //标题
						//barTitle : '施特伟科技有限公司',//导航标题
						barTitle : '组织架构',
						isSingleSelect:false, //是否单选
						isInherit:true, //是否选父带子
						selectNodeList:temp_target_id_list, //默认选中部门节点
						routerName: 'message',
						params:{ //加载扩展参数
							"is_permissions":"1",
							"is_process":"0"
						},
						extName : '部门(含子部门)', //多选显示扩展后缀名
						sure : function (rd) { //确认返回接口，数组
							if (rd.length == 0){

							}
							else if (rd.length == 1){
								document.getElementById('home_message_notice_draft_target').innerHTML = rd[0].name;
								$scope.target_id_list = rd[0].id;
								$scope.receiver_type = 'dept';
								$scope.type_status = 'private';
							}
							else {
								document.getElementById('home_message_notice_draft_target').innerHTML = rd.length + '个部门(含子部门)';
								$scope.target_id_list = '';
								for (var i=0;i<rd.length;i++){
									$scope.target_id_list = $scope.target_id_list + rd[i].id;
									if (i < rd.length - 1){
										$scope.target_id_list = $scope.target_id_list + ',';
									}
								}
								$scope.receiver_type = 'dept';
								$scope.type_status = 'private';
							}


						}
					});
				}
				else if (index == 2) {
					var employee_bar_header = '本公司';
					if (typeof($scope.home_message_notice_details_data.dept_name) != 'undefined'){
						employee_bar_header = $scope.home_message_notice_details_data.dept_name;
					}

					var temp_target_id_list = $scope.target_id_list;
					if ($scope.receiver_type != 'staff'){
						temp_target_id_list = '';
					}
					$emplComponentService.open({
						title : '选择员工', //弹开窗口标题
						//权限过滤需要改变这地方
						barTitle : employee_bar_header,//导航开头
						isSingleSelect:false,//是否单选
						isShowContact:false,//是否展示常用联系人
						isNeedSaveContact:false,//是否保存常用联系人
						extName : '员工', //多选时提示后缀名
						selectEmplList:temp_target_id_list, //打开窗口默认选中员工列表
						routerName:'message',
						params:{ //加载扩展参数
							"is_permissions":"1",
							"is_process":"0"
						},
						sure : function (rd) { //返回数据，数组格式
							if (rd.length == 0){

							}
							else if (rd.length == 1){
								document.getElementById('home_message_notice_draft_target').innerHTML = rd[0].empl_name;
								$scope.target_id_list = rd[0].empl_no;
								$scope.receiver_type = 'staff';
								$scope.type_status = 'private';
							}
							else {
								document.getElementById('home_message_notice_draft_target').innerHTML = rd.length + '个员工';
								$scope.target_id_list = '';
								for (var i=0;i<rd.length;i++){
									$scope.target_id_list = $scope.target_id_list + rd[i].empl_no;
									if (i < rd.length - 1){
										$scope.target_id_list = $scope.target_id_list + ',';
									}
								}
								$scope.receiver_type = 'staff';
								$scope.type_status = 'private';
							}
						}
					});
				}
				return true;

			}
		  });
	}


	$scope.home_message_notice_create_submit=function(){
		  /*var hideSheet = $ionicActionSheet.show({
			buttons: [

			  {
				text: '预览'
			  }, {
				text: '发布'
			  }
			],

			//titleText: 'Modify your album',
			//titleText: '选择上传图片方式',
			cancelText: '取消',
			//destructiveText: 'Delete',
			cancel: function() {
			  // add cancel code..
			},
			buttonClicked: function(index) {

			  if (index == 0) {

				return true;
			  } else if (index == 1) {
				homeMessageNoticeCreateSev.saveNotice()
				return true;
			  }
			  return true;
			}
		  });
		  */
        $ionicPopup.confirm({
          title:'',
          template: '<div style="font-size:16px;text-align:center;">确认发布吗</div>',
          cancelType: 'button-dark',
          cancelText: '取消',
          cssClass:'at_sign_in_new_popup',
          okText: '确定'
        }).then(function (res) {
          if (res) {
			if($scope.is_require_upload){
				homeMessageNoticeDraftSev.publishNoticeWithPhoto($scope.type_status,$scope.target_id_list,$scope.receiver_type);
			}
			else{
				homeMessageNoticeDraftSev.publishNotice($scope.type_status,$scope.target_id_list,$scope.receiver_type);
			}

          }

        });
	}

	$scope.home_message_notice_create_cancel=function(){
		  var hideSheet = $ionicActionSheet.show({
			buttons: [

			  {
				text: '暂存草稿'
			  }
			],

			//titleText: 'Modify your album',
			//titleText: '选择上传图片方式',
			cancelText: '取消',
			destructiveText: '返回',
			cancel: function() {
			  // add cancel code..
			},
			buttonClicked: function(index) {

			  if (index == 0) {

			if($scope.is_require_upload){
				homeMessageNoticeDraftSev.saveNoticeWithPhoto($scope.type_status,$scope.target_id_list,$scope.receiver_type);
			}
			else{
			homeMessageNoticeDraftSev.saveNotice($scope.type_status,$scope.target_id_list,$scope.receiver_type);
			}

				return true;
			  }
			  return true;
			},
			destructiveButtonClicked: function(){
				$ionicHistory.goBack();
				return true;
			}
		  });
	}


		$scope.add_cover=function(){
            var hideSheet = $ionicActionSheet.show({
                buttons: [

                    {
                        text: '拍照'
                    }, {
                        text: '从手机相册选择'
                    }
                ],

                //titleText: 'Modify your album',
                titleText: '选择上传图片方式',
                cancelText: '取消',
                cancel: function() {
                    // add cancel code..
                },
                buttonClicked: function(index) {

                    if (index == 0) {

                        try {
                            navigator.camera.getPicture(function(uri) {
								$scope.is_require_upload = true;
								document.getElementById('have_cover_div').style.display = "block";
								document.getElementById('add_cover_div').style.display = "none";

                                $('#have_cover_div img').attr("src", uri);
								//document.getElementById('ess_leave_apply_upload_text').innerText='更改图片';
                                //$('#ess_leave_apply_upload_icon1').attr("src", local_resource+'img/icon/upload_modify.png');
								//document.getElementById('ess_leave_apply_upload_icon2').style.display = "none";
								//document.getElementById('ess_leave_apply_upload_text').style.marginTop = "1.8em";

                            }, function() {
                                //alert('cancel or failure');
                            }, {
								destinationType: Camera.DestinationType.FILE_URI,
								quality: 100,
								targetHeight: 500,
								targetWidth: 500,
								correctOrientation: true
                            });
                        } catch (e) {
                            //alert(e.message);
                        }
                        return true;
                    } else if (index == 1) {
                        try {
                            navigator.camera.getPicture(function(uri) {
								$scope.is_require_upload = true;
								document.getElementById('have_cover_div').style.display = "block";
								document.getElementById('add_cover_div').style.display = "none";

                                $('#have_cover_div img').attr("src", uri);

								/*document.getElementById('ess_leave_apply_upload_mini_photo').style.display = "block";
                                $('#ess_leave_apply_upload_mini_photo').attr("src", uri);
								document.getElementById('ess_leave_apply_upload_text').innerText='更改图片';
                                $('#ess_leave_apply_upload_icon1').attr("src", local_resource+'img/icon/upload_modify.png');
								document.getElementById('ess_leave_apply_upload_icon2').style.display = "none";
								document.getElementById('ess_leave_apply_upload_text').style.marginTop = "1.8em";
								*/
                            }, function(message) {}, {
                                quality: 100,
                                destinationType: Camera.DestinationType.FILE_URI,
                                // In this app, dynamically set the picture source, Camera or photo gallery
                                sourceType: Camera.PictureSourceType.SAVEDPHOTOALBUM,
                                encodingType: Camera.EncodingType.JPEG,
                                mediaType: Camera.MediaType.PICTURE,
                                //allowEdit: true,
                                targetHeight: 500,
                                targetWidth: 500,
                                correctOrientation: true
                            });
                        } catch (e) {
                            //alert(e.message);
                        }

                        return true;
                    }

                    return true;


                }
            });

	}
  })

  .controller('homeMessageNoticeCreateCtrl',function($emplComponentService,$deptComponentSer,$scope,homeMessageNoticeCreateSev,$stateParams,$ionicModal,$location,$ionicScrollDelegate,$ionicNavBarDelegate,$ionicHistory,$timeout,$ionicActionSheet,$ionicHistory,$ionicPopup){
	$scope.cover_add=local_resource + 'img/icon/cover_add.png';
	$scope.home_message_earth_icon=local_resource + 'img/icon/home_message_earth_icon.png';

	homeMessageNoticeCreateSev.clearData();
	homeMessageNoticeCreateSev.loadData();
	$scope.content_data = homeMessageNoticeCreateSev.getData();

	if (ionic.Platform.isIOS()) {
	$scope.sroll_height=parseInt(window.screen.height)-64;
	$scope.textarea_height=parseInt(window.screen.height)-302;
	}else{
	$scope.sroll_height=parseInt(window.screen.height)-44;
	$scope.textarea_height=parseInt(window.screen.height)-282;
	}

	$scope.type_status = 'public';
	$scope.target_id_list = '';
	$scope.receiver_type = 'dept';

	window.notice_create_auto_grow =function (element) {

    element.style.height = "5px";
    element.style.height = (element.scrollHeight + 20)+"px";
}
	$scope.receiver_type_picklist=function(){
		  var hideSheet = $ionicActionSheet.show({
			buttons: [
			  {
				text: '全体员工'
			  },
			  {
				text: '按部门发布'
			  }, {
				text: '按员工发布'
			  }
			],

			//titleText: 'Modify your album',
			//titleText: '选择上传图片方式',
			cancelText: '取消',
			//destructiveText: 'Delete',
			cancel: function() {
			  // add cancel code..
			},
			buttonClicked: function(index) {
				if (index == 0) {
					$scope.type_status = 'public';
					$scope.target_id_list = '';
					$scope.receiver_type = 'dept';
					document.getElementById('home_message_notice_create_target').innerHTML = '全体员工';
				}
				else if (index == 1) {
					var temp_target_id_list = $scope.target_id_list;
					if ($scope.receiver_type != 'dept'){
						temp_target_id_list = '';
					}
					$deptComponentSer.open({
						title : '选择部门', //标题
						//barTitle : '施特伟科技有限公司',//导航标题
						barTitle : '组织架构',
						isSingleSelect:false, //是否单选
						isInherit:true, //是否选父带子
						selectNodeList:temp_target_id_list, //默认选中部门节点
						routerName: 'message',


						params:{ //加载扩展参数
							"is_permissions":"1",
							"is_process":"0"
						},
						extName : '部门(含子部门)', //多选显示扩展后缀名
						sure : function (rd) { //确认返回接口，数组
							if (rd.length == 0){

							}
							else if (rd.length == 1){
								document.getElementById('home_message_notice_create_target').innerHTML = rd[0].name;
								$scope.target_id_list = rd[0].id;
								$scope.receiver_type = 'dept';
								$scope.type_status = 'private';
							}
							else {
								document.getElementById('home_message_notice_create_target').innerHTML = rd.length + '个部门(含子部门)';
								$scope.target_id_list = '';
								for (var i=0;i<rd.length;i++){
									$scope.target_id_list = $scope.target_id_list + rd[i].id;
									if (i < rd.length - 1){
										$scope.target_id_list = $scope.target_id_list + ',';
									}
								}
								$scope.receiver_type = 'dept';
								$scope.type_status = 'private';
							}


						}
					});
				}
				else if (index == 2) {
					var employee_bar_header = '本公司';
					if (typeof($scope.content_data.dept_name) != 'undefined'){
						employee_bar_header = $scope.content_data.dept_name;
					}



					var temp_target_id_list = $scope.target_id_list;
					if ($scope.receiver_type != 'staff'){
						temp_target_id_list = '';
					}
					$emplComponentService.open({
						title : '选择员工', //弹开窗口标题
						//权限过滤需要改变这地方
						barTitle : employee_bar_header,//导航开头
						isSingleSelect:false,//是否单选
						isShowContact:false,//是否展示常用联系人
						isNeedSaveContact:false,//是否保存常用联系人
						extName : '员工', //多选时提示后缀名
						selectEmplList:temp_target_id_list, //打开窗口默认选中员工列表
						routerName:'message',
						params:{ //加载扩展参数
							"is_permissions":"1",
							"is_process":"0"
						},
						sure : function (rd) { //返回数据，数组格式
							if (rd.length == 0){

							}
							else if (rd.length == 1){
								document.getElementById('home_message_notice_create_target').innerHTML = rd[0].empl_name;
								$scope.target_id_list = rd[0].empl_no;
								$scope.receiver_type = 'staff';
								$scope.type_status = 'private';
							}
							else {
								document.getElementById('home_message_notice_create_target').innerHTML = rd.length + '个员工';
								$scope.target_id_list = '';
								for (var i=0;i<rd.length;i++){
									$scope.target_id_list = $scope.target_id_list + rd[i].empl_no;
									if (i < rd.length - 1){
										$scope.target_id_list = $scope.target_id_list + ',';
									}
								}
								$scope.receiver_type = 'staff';
								$scope.type_status = 'private';
							}
						}
					});
				}
				return true;

			}
		  });
	}
	$scope.home_message_notice_create_submit=function(){
		  /*var hideSheet = $ionicActionSheet.show({
			buttons: [

			  {
				text: '预览'
			  }, {
				text: '发布'
			  }
			],

			//titleText: 'Modify your album',
			//titleText: '选择上传图片方式',
			cancelText: '取消',
			//destructiveText: 'Delete',
			cancel: function() {
			  // add cancel code..
			},
			buttonClicked: function(index) {

			  if (index == 0) {

				return true;
			  } else if (index == 1) {
				homeMessageNoticeCreateSev.saveNotice()
				return true;
			  }
			  return true;
			}
		  });
		  */
        $ionicPopup.confirm({
          title:'',
          template: '<div style="font-size:16px;text-align:center;">确认发布吗</div>',
          cancelType: 'button-dark',
          cancelText: '取消',
          cssClass:'at_sign_in_new_popup',
          okText: '确定'
        }).then(function (res) {
          if (res) {
			if($scope.is_require_upload){
				homeMessageNoticeCreateSev.publishNoticeWithPhoto($scope.type_status,$scope.target_id_list,$scope.receiver_type);
			}
			else{
				homeMessageNoticeCreateSev.publishNotice($scope.type_status,$scope.target_id_list,$scope.receiver_type);
			}

          }

        });
	}

	$scope.home_message_notice_create_cancel=function(){
		  var hideSheet = $ionicActionSheet.show({
			buttons: [

			  {
				text: '暂存草稿'
			  }
			],

			//titleText: 'Modify your album',
			//titleText: '选择上传图片方式',
			cancelText: '取消',
			destructiveText: '返回',
			cancel: function() {
			  // add cancel code..
			},
			buttonClicked: function(index) {

			  if (index == 0) {

			if($scope.is_require_upload){
				homeMessageNoticeCreateSev.saveNoticeWithPhoto($scope.type_status,$scope.target_id_list,$scope.receiver_type);
			}
			else{
			homeMessageNoticeCreateSev.saveNotice($scope.type_status,$scope.target_id_list,$scope.receiver_type);
			}

				return true;
			  }
			  return true;
			},
			destructiveButtonClicked: function(){
				$ionicHistory.goBack();
				return true;
			}
		  });
	}
	$scope.add_cover=function(){
            var hideSheet = $ionicActionSheet.show({
                buttons: [

                    {
                        text: '拍照'
                    }, {
                        text: '从手机相册选择'
                    }
                ],

                //titleText: 'Modify your album',
                titleText: '选择上传图片方式',
                cancelText: '取消',
                cancel: function() {
                    // add cancel code..
                },
                buttonClicked: function(index) {

                    if (index == 0) {

                        try {
                            navigator.camera.getPicture(function(uri) {
								$scope.is_require_upload = true;
								document.getElementById('have_cover_div').style.display = "block";
								document.getElementById('add_cover_div').style.display = "none";

                                $('#have_cover_div img').attr("src", uri);
								//$scope.textarea_height=parseInt(document.body.scrollHeight)-409;

								if (ionic.Platform.isIOS()) {
								$scope.sroll_height=parseInt(window.screen.height)-64;
								$scope.textarea_height=parseInt(window.screen.height)-409;
								}else{
								$scope.sroll_height=parseInt(window.screen.height)-44;
								$scope.textarea_height=parseInt(window.screen.height)-389;
								}

								$timeout(function(){
									document.getElementById("home_message_notice_create_content").style.height = (document.getElementById("home_message_notice_create_content").scrollHeight + 20)+"px";
								});
								//document.getElementById('ess_leave_apply_upload_text').innerText='更改图片';
                                //$('#ess_leave_apply_upload_icon1').attr("src", local_resource+'img/icon/upload_modify.png');
								//document.getElementById('ess_leave_apply_upload_icon2').style.display = "none";
								//document.getElementById('ess_leave_apply_upload_text').style.marginTop = "1.8em";

                            }, function() {
                                //alert('cancel or failure');
                            }, {
								destinationType: Camera.DestinationType.FILE_URI,
								quality: 100,
								targetHeight: 500,
								targetWidth: 500,
								correctOrientation: true
                            });
                        } catch (e) {
                            //alert(e.message);
                        }
                        return true;
                    } else if (index == 1) {
                        try {
                            navigator.camera.getPicture(function(uri) {
								$scope.is_require_upload = true;
								document.getElementById('have_cover_div').style.display = "block";
								document.getElementById('add_cover_div').style.display = "none";

                                $('#have_cover_div img').attr("src", uri);
								if (ionic.Platform.isIOS()) {
								$scope.sroll_height=parseInt(document.body.scrollHeight)-64;
								$scope.textarea_height=parseInt(document.body.scrollHeight)-409;

								}else{
								$scope.sroll_height=parseInt(document.body.scrollHeight)-44;
								$scope.textarea_height=parseInt(document.body.scrollHeight)-389;
								}
								$timeout(function(){
									document.getElementById("home_message_notice_create_content").style.height = (document.getElementById("home_message_notice_create_content").scrollHeight + 20)+"px";
								});

								/*document.getElementById('ess_leave_apply_upload_mini_photo').style.display = "block";
                                $('#ess_leave_apply_upload_mini_photo').attr("src", uri);
								document.getElementById('ess_leave_apply_upload_text').innerText='更改图片';
                                $('#ess_leave_apply_upload_icon1').attr("src", local_resource+'img/icon/upload_modify.png');
								document.getElementById('ess_leave_apply_upload_icon2').style.display = "none";
								document.getElementById('ess_leave_apply_upload_text').style.marginTop = "1.8em";
								*/
                            }, function(message) {}, {
                                quality: 100,
                                destinationType: Camera.DestinationType.FILE_URI,
                                // In this app, dynamically set the picture source, Camera or photo gallery
                                sourceType: Camera.PictureSourceType.SAVEDPHOTOALBUM,
                                encodingType: Camera.EncodingType.JPEG,
                                mediaType: Camera.MediaType.PICTURE,
                                //allowEdit: true,
                                targetHeight: 500,
                                targetWidth: 500,
                                correctOrientation: true
                            });
                        } catch (e) {
                            //alert(e.message);
                        }

                        return true;
                    }

                    return true;


                }
            });

	}
  })


    .controller('atTeamRecordByTypeDetailCtrl',function($scope,atTeamRecordByTypeDetailSev,$stateParams,$ionicModal,$location,$ionicScrollDelegate,$ionicNavBarDelegate,$ionicHistory,$timeout,$ionicActionSheet,homeMessageNoticeCreateSev,$ionicPopup){
	$scope.title_type=$stateParams.type;
	$scope.not_data=local_resource + "img/not_data.png";
	$scope.cry=local_resource + "img/cry.png";
	$scope.search_img = local_resource+'img/search_img.png';
	//$scope.toolbar_title = $stateParams.toolbar_title;
	if($stateParams.type=="miss"){
		$scope.title_text="漏卡";
	}
	else if($stateParams.type=="early"){
		$scope.title_text="早退";
	}
	else if($stateParams.type=="late"){
		$scope.title_text="迟到";
	}
	else if($stateParams.type=="lv"){
		$scope.title_text="请假";
	}
	else if($stateParams.type=="normal"){
		$scope.title_text="正常";
	}
	else if($stateParams.type=="ot"){
		$scope.title_text="加班";
	}
	else if($stateParams.type=="out"){
		$scope.title_text="外出";
	}
	$scope.dept_id=$stateParams.dept_id;




	/*$scope.curr_date=$stateParams.date;
	$scope.current_date_text= $scope.curr_date.split("-")[0]+'年'+$scope.curr_date.split("-")[1]+'月'+$scope.curr_date.split("-")[2]+'日';
	atTeamRecordByTypeDetailSev.clearData();
	atTeamRecordByTypeDetailSev.loadData($stateParams.type,$stateParams.date,$stateParams.dept_id);
	$scope.at_team_record_by_type_detail_data = atTeamRecordByTypeDetailSev.getData();
	*/
	$scope.end_of_list = atTeamRecordByTypeDetailSev.getEndOfList();

    $scope.search_control=atTeamRecordByTypeDetailSev.getSearchValue();
	$scope.searchState=atTeamRecordByTypeDetailSev.getSearchState();
	$scope.searchNodata= atTeamRecordByTypeDetailSev.getSearchNodata();
    $scope.curr_date=$stateParams.date;
	$scope.current_date_text= $scope.curr_date.split("-")[0]+'年'+$scope.curr_date.split("-")[1]+'月'+$scope.curr_date.split("-")[2]+'日';

	if (ionic.Platform.isIOS()) {
	atTeamRecordByTypeDetailSev.clearData();
	atTeamRecordByTypeDetailSev.loadData($stateParams.type,$stateParams.date,$stateParams.dept_id);
	$scope.at_team_record_by_type_detail_data = atTeamRecordByTypeDetailSev.getData();
	  $scope.content_top='64';
    } else {
		$scope.content_top='44';
      $scope.$on("$ionicView.enter", function () {
        //解决 进入明细页面back回来的时候 会再次loaddata
        if (typeof($scope.data_loaded) != 'undefined') {
		if($scope.search_control.search_val!=''){

			document.getElementById("atTeamRecordByTypeDSearchDiv").style.display='block';
			document.getElementById("atTeamRecordByTypeDSearchDiv").style.opacity='1';
			document.getElementById("atTeamRecordByTypeDBack").style.display='none';
			document.getElementById("atTeamRecordByTypeDSearchInput").value=$scope.search_control.search_val;

		}
          return;
        }
        else {
          $scope.data_loaded = true;
        }

	atTeamRecordByTypeDetailSev.clearData();
	atTeamRecordByTypeDetailSev.loadData($stateParams.type,$stateParams.date,$stateParams.dept_id);
	$scope.at_team_record_by_type_detail_data = atTeamRecordByTypeDetailSev.getData();
      });
    }


	$scope.search=function(){

		atTeamRecordByTypeDetailSev.loadData($stateParams.type,$stateParams.date,$stateParams.dept_id);
	}


	$scope.loadMoreEmployeeData=function(){
		atTeamRecordByTypeDetailSev.loadMoreData($stateParams.type,$stateParams.date,$stateParams.dept_id);
	}
	$scope.atTeamRecordByTypeDetailBack=function(){
		$ionicHistory.goBack();
		//atTeamRecordSev.clearStatusBar();
	}
	$scope.at_team_record_content=function(name,employee_no){
		$location.path('home_page/home_menulist/at_team_record_content/'+$stateParams.date+"/"+name+"/"+employee_no);
	}
  })

    .controller('atTeamRecordContentCtrl',function($scope,atTeamRecordContentSev,$stateParams,$ionicModal,$location,$ionicScrollDelegate,$ionicNavBarDelegate,$ionicHistory,$timeout,$ionicActionSheet,$ionicPopup){
	//alert($stateParams.name+":"+$stateParams.date);
	$scope.normal_time = local_resource + 'img/icon/normal_time.png';
    $scope.arroworange=local_resource +'img/icon/arroworange.png';
    $scope.arrowred=local_resource +'img/icon/arrowred.png';
	$scope.arrowblue=local_resource +'img/icon/arrowblue.png';
	$scope.time_icon = local_resource + 'img/icon/time_icon.png';
	$scope.contract_management_directory1 = local_resource + 'img/icon/contract_management_directory1.png';
	$scope.at_home_times_icon = local_resource + 'img/icon/at_home_times_icon.png';
	$scope.at_home_red_line = local_resource + 'img/icon/at_home_red_line.png';
	$scope.ot_time = local_resource + 'img/icon/ot_time.png';
	$scope.at_home_wait_approv_icon = local_resource + 'img/icon/at_home_wait_approv_icon.png';
	$scope.at_home_approved_icon = local_resource + 'img/icon/at_home_approved_icon.png';
	$scope.no_policy_photo = local_resource + 'img/icon/no_policy_photo.png';
	$scope.icon_no_clockDate = local_resource+'img/icon/icon_no_clockDate.png';
	$scope.title_name=$stateParams.name;
	$scope.curr_date=$stateParams.date;
	$scope.current_date_text= $scope.curr_date.split("-")[0]+'年'+$scope.curr_date.split("-")[1]+'月'+$scope.curr_date.split("-")[2]+'日';
	atTeamRecordContentSev.clearData();
	atTeamRecordContentSev.loadData($stateParams.employee_no,$stateParams.date);
	$scope.at_team_record_content_data = atTeamRecordContentSev.getData();
	$scope.at_team_record_content_leave=function(p_inst,show_type,my_app_result,task_id){
		if(p_inst=='0'){
			return;
		}
		else{
			$location.path("home_page/ess_my_approval_details_content/"+p_inst+"/"+show_type+"/"+task_id+"/"+"c"+"/"+"false"+"/at_team_record");
		}

	};
	$scope.at_team_record_content_offic_work_out=function(p_inst,show_type,my_app_result,task_id){
		if(p_inst=='0'){
			return;
		}
		else{
		$location.path("home_page/ess_my_approval_details_content_offic_work_out/"+p_inst+"/"+show_type+"/"+task_id+"/"+"C"+"/"+"false"+"/at_team_record");
		}

	};
	$scope.at_team_record_content_out=function(p_inst,show_type,my_app_result,task_id){
		if(p_inst=='0'){
			return;
		}
		else{
		$location.path("home_page/ess_my_approval_details_content_out/"+p_inst+"/"+show_type+"/"+task_id+"/"+"C"+"/"+"false"+"/at_team_record");
		}
	}

  })

  .controller('payrollCalEmployeeSelectCtrl',function($scope,payrollCalSev,$stateParams,$location,$ionicPopup,$ionicHistory,$ionicScrollDelegate){
    $scope.search_control={};
    $scope.search_control.search_val='';
	payrollCalSev.clearEmployeeData();
    payrollCalSev.loadEmployeeData();
    $scope.payrollCalEmployeeSelectData = payrollCalSev.getEmployeeData();
	$scope.img_no_notice = local_resource+'img/icon/no_notice01.png';
	$scope.img_notice = local_resource+'img/icon/notice01.png';
    $scope.ckItem = function(_flag){
      if(_flag == true){
        $scope.payrollCalEmployeeSelectData.total_checked++;
      }else{
        $scope.payrollCalEmployeeSelectData.total_checked--;
      }
        $scope.payrollCalEmployeeSelectData.show_footer_bar=true;

      if ($scope.payrollCalEmployeeSelectData.total_checked == $scope.payrollCalEmployeeSelectData.length){
        //$scope.all_selected = true;
        document.getElementById('select_all_employee').style.display = "none";
        document.getElementById('deselect_all_employee').style.display = "block";

      }
      else {
        //$scope.all_selected = false;
        document.getElementById('select_all_employee').style.display = "block";
        document.getElementById('deselect_all_employee').style.display = "none";
      }
      setTimeout(function(){ $ionicScrollDelegate.resize();}, 200);
    }

    $scope.select_all_employee = function(){
      //$scope.all_selected = true;
      $scope.payrollCalEmployeeSelectData.show_footer_bar=true;
      document.getElementById('select_all_employee').style.display = "none";
      document.getElementById('deselect_all_employee').style.display = "block";
      $scope.payrollCalEmployeeSelectData.total_checked = $scope.payrollCalEmployeeSelectData.data.length;
      $scope.payrollCalEmployeeSelectData.show_footer_bar = true;
      for (var i=0;i<$scope.payrollCalEmployeeSelectData.data.length;i++){
        $scope.payrollCalEmployeeSelectData.data[i].ck = true;
      }
    }
    $scope.select_all_employee_cancel = function(){
      //$scope.all_selected = false;
      $scope.payrollCalEmployeeSelectData.show_footer_bar=true;
      document.getElementById('select_all_employee').style.display = "block";
      document.getElementById('deselect_all_employee').style.display = "none";
      $scope.payrollCalEmployeeSelectData.total_checked = 0;

      for (var i=0;i<$scope.payrollCalEmployeeSelectData.data.length;i++){
        $scope.payrollCalEmployeeSelectData.data[i].ck = false;
      }
      setTimeout(function(){ $ionicScrollDelegate.resize();}, 200);
    }
    $scope.cancel=function(){
		var temp_total_checked = 0;
      var employee_list = $('#payroll_cal_empl_list_hidden').val();
      var SelectData_data=$scope.payrollCalEmployeeSelectData.data;
      employee_list=employee_list+",";
      for(var i=0;i<SelectData_data.length;i++){
        if(employee_list.indexOf(SelectData_data[i].emp+",")==-1){
          SelectData_data[i].ck=false;
        }
        else{
			temp_total_checked ++;
          SelectData_data[i].ck=true;
        }
      }
	  $scope.payrollCalEmployeeSelectData.total_checked = temp_total_checked;
      $scope.payrollCalEmployeeSelectData.data=SelectData_data;
      $scope.payrollCalEmployeeSelectData.show_footer_bar=false;
      setTimeout(function(){ $ionicScrollDelegate.resize();}, 200);
    }

	$scope.payroll_cal_employee_select_save = function(){
      var _empl_list='';
      var _staff_no_list='';
      for(var i=0;i<$scope.payrollCalEmployeeSelectData.data.length;i++){
        if($scope.payrollCalEmployeeSelectData.data[i].ck==true){
          _empl_list = _empl_list + $scope.payrollCalEmployeeSelectData.data[i].en+',';
          _staff_no_list = _staff_no_list + $scope.payrollCalEmployeeSelectData.data[i].emp+',';
        }
      }
      $("#payroll_cal_empl_list").val(_empl_list.substring(0,_empl_list.length-1));
      $("#payroll_cal_empl_list_hidden").val(_staff_no_list.substring(0,_staff_no_list.length-1));
      $ionicHistory.goBack();
	}

  })
